<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta (POS) - GestionCloud</title>
    
    {% load articulo_filters %}
    {% load l10n %}
    {% load humanize %}
    
    <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
        * {
        margin: 0;
        padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
            height: 100vh;
        overflow: hidden;
    }
    
    .pos-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    /* Header del POS */
    .pos-header {
            background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
            padding: 12px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .pos-header h2 {
        margin: 0;
        font-weight: 600;
            font-size: 1.3rem;
    }
    
    .pos-info {
        display: flex;
            gap: 25px;
        align-items: center;
            margin-top: 8px;
    }
    
    .pos-info-item {
        display: flex;
        align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        opacity: 0.9;
    }
    
    .pos-header-actions {
        display: flex;
        align-items: center;
            gap: 8px;
    }
    
    .pos-header-actions .btn {
            border-radius: 6px;
            padding: 6px 12px;
        font-weight: 500;
            font-size: 0.85rem;
        transition: all 0.3s ease;
    }
    
    /* Campo de código de barras */
    .pos-barcode-section {
        background: #f8f9fa;
        padding: 10px 20px;
        border-bottom: 2px solid #e3e6f0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .pos-barcode-input {
        flex: 1;
        max-width: 300px;
    }
    
    .pos-barcode-input input {
        width: 100%;
        padding: 8px 15px;
        border: 2px solid #17a2b8;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 500;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .pos-barcode-input input:focus {
        outline: none;
        border-color: #138496;
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        transform: scale(1.02);
    }
    
    .pos-barcode-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .pos-barcode-label i {
        color: #17a2b8;
        font-size: 1.1rem;
    }
    
    .pos-barcode-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .pos-barcode-status.ready {
        color: #28a745;
    }
    
    .pos-barcode-status.scanning {
        color: #ffc107;
        animation: pulse 1s infinite;
    }
    
    .pos-barcode-status.disabled {
        color: #6c757d;
        opacity: 0.6;
    }
    
    .pos-barcode-toggle {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .pos-barcode-toggle:hover {
        background: #138496;
    }
    
    .pos-barcode-toggle:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Contenido principal */
    .pos-main-content {
        flex: 1;
        display: flex;
        overflow: hidden;
    }
    
    /* Panel izquierdo - Productos */
    .pos-left-panel {
            width: 60%;
        background: white;
        border-right: 2px solid #e3e6f0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
        /* Filtros y búsqueda */
        .pos-filters {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .pos-search {
            margin-bottom: 10px;
        }
        
        .pos-search input {
            border-radius: 20px;
        border: 2px solid #e3e6f0;
            padding: 8px 15px;
            font-size: 0.9rem;
        transition: all 0.3s ease;
        }
        
        .pos-search input:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }
        
        .pos-category-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .category-btn {
            padding: 6px 14px;
            border: 1px solid #D4C4A8;
            background: #F5F0EB;
            color: #6F5B44;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .category-btn:hover {
            background: #E8DED5;
            border-color: #C8B79A;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(139, 115, 85, 0.2);
        }
        
        .category-btn.active {
            background: #D4C4A8;
            color: #2c3e50;
            border-color: #D4C4A8;
            box-shadow: 0 2px 6px rgba(139, 115, 85, 0.25);
        }
        
        /* Grid de productos compacto */
        .pos-products-container {
        flex: 1;
        overflow-y: auto;
            padding: 10px;
        }
        
        .pos-products-grid {
        display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
    }
    
    /* Vista de lista */
    .pos-products-grid.vista-lista {
        grid-template-columns: 1fr;
        gap: 2px;
    }
    
    .pos-product-card {
        background: white;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            padding: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
            min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    /* Estilo de tarjeta en vista lista */
    .vista-lista .pos-product-card {
        flex-direction: row;
        text-align: left;
        min-height: auto;
        padding: 6px 10px;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px;
    }
    
    .vista-lista .pos-product-name {
        flex: 1;
        margin-bottom: 0;
        -webkit-line-clamp: 1;
        font-size: 0.85rem;
    }
    
    .vista-lista .pos-product-price {
        margin-bottom: 0;
        margin-left: 12px;
        font-size: 0.85rem;
        min-width: 80px;
        text-align: right;
    }
    
    .vista-lista .pos-product-stock {
        margin-left: 12px;
        font-size: 0.75rem;
        min-width: 60px;
        text-align: right;
    }
    
    .pos-product-card:hover {
            border-color: #17a2b8;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            transform: translateY(-1px);
    }
    
    .pos-product-card.disabled {
            opacity: 0.5;
        cursor: not-allowed;
        background: #f8f9fa;
    }
    
    .pos-product-name {
            font-size: 0.75rem;
            font-weight: 500;
        color: #2c3e50;
            margin-bottom: 4px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
    }
    
    .pos-product-price {
            font-size: 0.8rem;
            font-weight: 600;
        color: #28a745;
            margin-bottom: 2px;
    }
    
    .pos-product-stock {
            font-size: 0.7rem;
        color: #6c757d;
    }
        
        .pos-product-stock.text-danger {
            color: #dc3545;
    }
    
    /* Panel derecho - Carrito y Totales */
    .pos-right-panel {
            width: 40%;
            background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
        /* Lista de items del carrito - COMPACTA */
        .pos-cart-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .pos-cart-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e3e6f0;
        font-weight: 600;
            font-size: 0.9rem;
        color: #2c3e50;
    }
    
    .pos-cart-items {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0;
        min-height: 0; /* Fix para flex + scroll */
        max-height: calc(100vh - 450px); /* Altura máxima para forzar scroll */
    }
    
    .pos-cart-item {
        display: flex;
        align-items: center;
            padding: 5px 8px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
            min-width: 0;
        }
        
        .pos-cart-item:hover {
            background: #f8f9fa;
        }
        
        .pos-cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-name {
            flex: 1;
            min-width: 0;
            font-weight: 500;
        color: #2c3e50;
            margin-right: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }
        
        .cart-item-price {
            min-width: 80px;
            flex-shrink: 0;
            text-align: right;
            color: #28a745;
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .cart-item-qty {
            min-width: 85px;
            flex-shrink: 0;
            text-align: center;
            margin: 0 3px;
        display: flex;
        align-items: center;
            justify-content: center;
            gap: 3px;
    }
    
        .cart-item-discount {
            min-width: 40px;
            flex-shrink: 0;
        text-align: center;
            color: #dc3545;
            font-size: 0.7rem;
        }
        
        .cart-item-total {
            min-width: 80px;
            flex-shrink: 0;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .cart-item-actions {
            min-width: 30px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .cart-item-actions .btn {
            padding: 1px 4px;
            font-size: 0.65rem;
            border-radius: 3px;
        }
        
        .cart-item-qty .btn {
            padding: 0 5px;
            font-size: 0.75rem;
            line-height: 1.1;
            min-width: 22px;
        }
        
        /* Panel de totales COMPACTO */
        .pos-totals-panel {
            background: #f8f9fa;
        border-top: 2px solid #e3e6f0;
            padding: 15px;
        }
        
        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .totals-row.total-final {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            border-top: 2px solid #e3e6f0;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .totals-label {
        color: #6c757d;
    }
    
        .totals-value {
            font-weight: 600;
        color: #2c3e50;
            white-space: nowrap;
    }
    
        .totals-value.total-final {
        color: #28a745;
            font-size: 1.2rem;
    }
    
        /* Botones de acción */
    .pos-actions {
            padding: 15px;
            background: white;
            border-top: 1px solid #e3e6f0;
        }
        
        .pos-actions .btn {
            width: 100%;
            margin-bottom: 8px;
            padding: 12px;
        font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-process {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        color: white;
    }
    
        .btn-process:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-1px);
    }
    
        .btn-clear {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
        color: white;
    }
    
        .btn-clear:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-1px);
    }
    
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .pos-left-panel {
                width: 55%;
            }
            .pos-right-panel {
                width: 45%;
            }
        }
        
    @media (max-width: 768px) {
        .pos-main-content {
            flex-direction: column;
        }
        .pos-left-panel,
        .pos-right-panel {
            width: 100%;
                height: 50%;
            }
    }
</style>
</head>
<body>
{% csrf_token %}
<div class="pos-container">
    <!-- Header del POS -->
    <div class="pos-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="d-flex align-items-center">
                    <h2 class="mb-0">
                        <i class="fas fa-cash-register me-2"></i>Punto de Venta (POS)
                    </h2>
                    <div id="clienteEnHeader" style="margin-left: 20px;"></div>
                </div>
                <div class="pos-info">
                    <div class="pos-info-item">
                        <i class="fas fa-building"></i>
                        <span style="font-weight: 600; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px;">
                            {% if request.sucursal_activa %}
                                🏢 {{ request.sucursal_activa.nombre }}
                            {% else %}
                                ⚠️ SIN SUCURSAL
                            {% endif %}
                        </span>
                    </div>
                    <div class="pos-info-item">
                        <i class="fas fa-hashtag"></i>
                            <span>Venta #<span id="proximo-numero">{{ proximo_numero }}</span></span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-desktop"></i>
                            <span id="estacion-actual">Estación: <span id="estacion-nombre">-</span></span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-user"></i>
                            <span id="vendedor-actual">Vendedor: <span id="vendedor-nombre">-</span></span>
                    </div>
                    <div class="pos-info-item">
                        <i class="fas fa-calendar"></i>
                        <span id="current-date"></span>
                    </div>
                    <div class="pos-info-item">
                        <i class="fas fa-clock"></i>
                        <span id="current-time"></span>
                    </div>
                </div>
            </div>
            <div class="pos-header-actions">
                <button class="btn btn-outline-light" onclick="mostrarHistorialTickets()" title="Ver historial de tickets del día">
                    <i class="fas fa-history me-1"></i>Historial
                </button>
                <button class="btn btn-outline-light" onclick="window.print()" title="Imprimir">
                    <i class="fas fa-print"></i>
                </button>
                <a href="{% url 'dashboard' %}" class="btn btn-outline-light" title="Volver al Sistema">
                    <i class="fas fa-arrow-left me-1"></i>Salir
                </a>
            </div>
        </div>
    </div>

    <!-- Sección de código de barras -->
    <div class="pos-barcode-section">
        <div class="pos-barcode-label">
            <i class="fas fa-barcode"></i>
            <span>Escanea código de barras:</span>
        </div>
        <div class="pos-barcode-input">
            <input type="text" 
                   id="barcode-input" 
                   placeholder="Escanea o escribe código de barras..."
                   autocomplete="off"
                   autofocus>
        </div>
        <div class="pos-barcode-status ready" id="barcode-status">
            <i class="fas fa-check-circle"></i>
            <span>Listo para escanear</span>
        </div>
        <button class="pos-barcode-toggle" id="barcode-toggle" onclick="toggleBarcodeMode()" style="background: #17a2b8;">
            <i class="fas fa-barcode"></i> Modo Escaneo
        </button>
    </div>

    <!-- Contenido principal -->
    <div class="pos-main-content">
        <!-- Panel izquierdo - Productos -->
        <div class="pos-left-panel">
                <!-- Filtros y búsqueda -->
                <div class="pos-filters">
                    <!-- Selector de Lista de Precios -->
                    <div class="mb-2">
                        <label class="form-label fw-bold" style="font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-tags me-1"></i>Lista de Precios
                        </label>
                        <select class="form-select form-select-sm" id="listaPrecioSelect" style="border: 2px solid #e9ecef;">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    
                    <div class="d-flex gap-2 align-items-center mb-2">
                        <div class="pos-search flex-grow-1">
                            <input type="text" id="pos-search" class="form-control" placeholder="Buscar productos...">
                        </div>
                        <button type="button" class="btn btn-sm" id="btnToggleCategorias" style="background: #F5F0EB; color: #6F5B44; border: 1px solid #D4C4A8; padding: 6px 12px;" title="Mostrar/Ocultar Categorías">
                            <i class="fas fa-folder me-1"></i>Categorías <i class="fas fa-chevron-down ms-1" id="iconoCategorias"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" id="btnVistaGrid" title="Vista en Cuadrícula">
                                <i class="fas fa-th"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnVistaLista" title="Vista en Lista">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pos-category-filter" id="categoriasContainer" style="display: none; margin-bottom: 10px;">
                        <button class="category-btn active" data-category="all">Todas</button>
                        <!-- Las categorías se cargarán dinámicamente -->
                    </div>
            </div>
            
            <!-- Pestañas Productos / Kits -->
            <ul class="nav nav-tabs mb-2" style="border-bottom: 2px solid #8B7355;">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-productos" data-bs-toggle="tab" data-bs-target="#panel-productos" type="button" style="color: #6F5B44; font-weight: 600;">
                        <i class="fas fa-box me-1"></i> Productos
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-kits" data-bs-toggle="tab" data-bs-target="#panel-kits" type="button" style="color: #6F5B44; font-weight: 600;">
                        <i class="fas fa-gift me-1"></i> Kits de Ofertas
                        {% if kits %}<span class="badge bg-success ms-1">{{ kits|length }}</span>{% endif %}
                    </button>
                </li>
            </ul>
            
            <!-- Contenido de pestañas -->
            <div class="tab-content">
                <!-- Panel Productos -->
                <div class="tab-pane fade show active" id="panel-productos">
                    <!-- Grid de productos -->
                    <div class="pos-products-container">
            <div class="pos-products-grid" id="pos-products-grid">
                {% for articulo in articulos %}
                <div class="pos-product-card {% if articulo.stock_actual <= 0 %}disabled{% endif %}" 
                     data-articulo-id="{{ articulo.id }}" 
                     data-precio="{{ articulo.precio_final_calculado|unlocalize }}"
                     data-precio-neto="{{ articulo.precio_venta|unlocalize }}"
                     data-stock="{{ articulo.stock_actual|default:0 }}"
                     data-categoria="{% if articulo.categoria %}{{ articulo.categoria.nombre }}{% else %}sin-categoria{% endif %}"
                     data-categoria-exenta-iva="{% if articulo.categoria.exenta_iva %}true{% else %}false{% endif %}"
                     data-impuesto-especifico="{% if articulo.categoria.impuesto_especifico %}{{ articulo.categoria.impuesto_especifico.get_porcentaje_decimal|unlocalize }}{% else %}0{% endif %}">
                    <div class="pos-product-name">{{ articulo.nombre }}</div>
                    <div class="pos-product-price">${{ articulo.precio_final_calculado|format_price }}</div>
                    <div class="pos-product-stock {% if articulo.stock_actual <= 0 %}text-danger{% endif %}">
                        Stock: {{ articulo.stock_actual|default:"0" }}
                    </div>
                </div>
                {% empty %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-box-open fa-3x mb-3"></i>
                    <p>No hay artículos disponibles</p>
                </div>
                {% endfor %}
                    </div>
                    </div>
                </div>
                
                <!-- Panel Kits -->
                <div class="tab-pane fade" id="panel-kits">
                    <div class="pos-products-container">
                        <div class="row g-1" id="pos-kits-grid">
                            {% for kit in kits %}
                            <div class="col-md-6">
                                <div class="card" style="border: 1px solid #E8DCC8; border-radius: 6px; cursor: pointer; transition: all 0.2s;" 
                                     onmouseover="this.style.boxShadow='0 2px 8px rgba(139,115,85,0.2)'" 
                                     onmouseout="this.style.boxShadow='none'">
                                    <div class="card-body" style="padding: 0.5rem;">
                                        <div class="d-flex gap-2">
                                            <!-- Icono/Imagen pequeña -->
                                            <div style="width: 50px; height: 50px; flex-shrink: 0;">
                                                {% if kit.imagen %}
                                                <img src="{{ kit.imagen.url }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" alt="{{ kit.nombre }}">
                                                {% else %}
                                                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-gift" style="color: #D4C4A8; font-size: 1.5rem;"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Info del kit -->
                                            <div class="flex-grow-1" style="min-width: 0;">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="font-weight: 600; font-size: 0.75rem; color: #6F5B44; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                            {{ kit.nombre }}
                                                            {% if kit.destacado %}<i class="fas fa-star ms-1" style="color: #D4A574; font-size: 0.65rem;"></i>{% endif %}
                                                        </div>
                                                        <div style="font-size: 0.65rem; color: #999;">{{ kit.items.count }} item{{ kit.items.count|pluralize }} • Stock: {{ kit.stock_disponible }}</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <div>
                                                        <div style="font-size: 0.95rem; font-weight: 700; color: #8B7355;">${{ kit.precio_kit|intcomma }}</div>
                                                        {% if kit.items.count > 0 %}
                                                        <div style="font-size: 0.65rem; color: #999; text-decoration: line-through;">${{ kit.precio_total_items|intcomma }}</div>
                                                        {% endif %}
                                                    </div>
                                                    {% if kit.items.count > 0 %}
                                                    <span class="badge bg-success" style="font-size: 0.65rem; padding: 2px 6px;">-{{ kit.ahorro_porcentaje|floatformat:0 }}%</span>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="d-flex gap-1">
                                                    <button type="button" class="btn btn-sm flex-fill" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; font-size: 0.65rem; padding: 3px 6px; border: none;" 
                                                            data-kit-id="{{ kit.id }}"
                                                            data-kit-nombre="{{ kit.nombre }}"
                                                            data-kit-precio="{{ kit.precio_kit|unlocalize }}"
                                                            data-kit-stock="{{ kit.stock_disponible }}"
                                                            onclick="agregarKitCompleto(this.dataset.kitId, this.dataset.kitNombre, this.dataset.kitPrecio, this.dataset.kitStock)">
                                                        <i class="fas fa-cart-plus"></i> Kit
                                                    </button>
                                                    <button type="button" class="btn btn-sm flex-fill" style="background: linear-gradient(135deg, #D4A574 0%, #C19461 100%); color: white; font-size: 0.65rem; padding: 3px 6px; border: none;" 
                                                            data-kit-id="{{ kit.id }}"
                                                            onclick="desglosarKitEnCarrito(this.dataset.kitId)">
                                                        <i class="fas fa-list"></i> Items
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-gift fa-3x mb-2" style="color: #D4C4A8;"></i>
                                <p class="text-muted" style="font-size: 0.85rem;">No hay kits disponibles</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel derecho - Carrito y Totales -->
        <div class="pos-right-panel">
                <!-- Lista de items del carrito -->
                <div class="pos-cart-container">
                <div class="pos-cart-header">
                        <i class="fas fa-shopping-cart me-2"></i>Carrito de Venta
                </div>
                <div class="pos-cart-items" id="pos-cart-items">
                        <!-- Los items se cargarán dinámicamente -->
                    </div>
                </div>
                
                <!-- Panel de totales compacto -->
                <div class="pos-totals-panel">
                    {% if max_descuento_total > 0 %}
                    <div class="totals-row">
                        <span class="totals-label">Descuento Total (%)</span>
                        <input type="number" id="descuento-total-input" class="form-control form-control-sm" style="width: 80px; text-align: right;" min="0" max="{{ max_descuento_total|unlocalize }}" step="0.01">
                    </div>
                    {% endif %}
                    <div class="totals-row">
                        <span class="totals-label">Subtotal:</span>
                        <span class="totals-value" id="subtotal">$0</span>
                        </div>
                    <div class="totals-row">
                        <span class="totals-label">Descuento:</span>
                        <span class="totals-value" id="descuento">$0</span>
                        </div>
                    <div class="totals-row">
                        <span class="totals-label">Neto:</span>
                        <span class="totals-value" id="neto">$0</span>
                        </div>
                    <div class="totals-row">
                        <span class="totals-label">IVA (19%):</span>
                        <span class="totals-value" id="iva">$0</span>
                        </div>
                    <div class="totals-row">
                        <span class="totals-label">Impuesto Específico:</span>
                        <span class="totals-value" id="impuesto_especifico">$0</span>
                        </div>
                    <div class="totals-row total-final">
                        <span class="totals-label">TOTAL:</span>
                        <span class="totals-value total-final" id="total">$0</span>
                    </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="pos-actions">
                    <button class="btn btn-process" id="btn-process">
                        <i class="fas fa-check me-2"></i>Procesar Venta
                        </button>
                    <button class="btn btn-clear" id="btn-clear">
                        <i class="fas fa-trash me-2"></i>Limpiar Carrito
                        </button>
            </div>
        </div>
    </div>
</div>

    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
console.log('=== POS SCRIPT CARGADO - VERSION 2025-10-11-19:37 ===');
// Version: 2025-10-11-19:37 - Fixed addToCart function
// Variables globales
let cart = [];
let currentSubtotal = 0;
let currentDescuento = 0;
let currentNeto = 0;
let currentIva = 0;
let currentImpuestoEspecifico = 0;
let currentTotal = 0;
let currentCategory = 'all';
let wasScanningMode = false; // Variable global para rastrear el modo de escaneo antes de procesar

// Array de artículos disponibles en el POS - se llena desde Django
let articulos = [];
window.articulos = articulos;

// ===== FUNCIONES GLOBALES (FUERA DE DOMContentLoaded) =====

// Obtener precio especial del cliente si existe
async function obtenerPrecioArticulo(articuloId, precioLista) {
    // Si hay cliente seleccionado, buscar precio especial
    if (window.clienteSeleccionado && window.clienteSeleccionado.id) {
        try {
            // Limpiar el ID del cliente (remover espacios y caracteres no numéricos excepto guiones)
            const clienteIdLimpio = String(window.clienteSeleccionado.id).trim().replace(/\s+/g, '');
            
            console.log(`Buscando precio especial para cliente ID: ${clienteIdLimpio}, artículo: ${articuloId}`);
            
            const response = await fetch(`/ventas/api/precio-cliente/${clienteIdLimpio}/${articuloId}/`);
            const data = await response.json();
            if (data.success && data.precio_especial) {
                console.log(`✓ Precio especial encontrado: $${data.precio_especial} (Lista: $${precioLista})`);
                return parseFloat(data.precio_especial);
            } else {
                console.log(`✗ Sin precio especial, usando precio de lista: $${precioLista}`);
            }
        } catch (error) {
            console.log('Error al buscar precio especial:', error);
            console.log('Usando precio de lista');
        }
    }
    return parseFloat(precioLista);
}

// Agregar al carrito - DEBE ESTAR EN SCOPE GLOBAL
async function addToCart(articuloId, nombre, precio, stock, categoriaExentaIva = false, impuestoEspecifico = 0, precioNeto = null, fromKit = false) {
    console.log('*** FUNCIÓN addToCart LLAMADA ***', { articuloId: articuloId, nombre: nombre, precio: precio, stock: stock, categoriaExentaIva: categoriaExentaIva, impuestoEspecifico: impuestoEspecifico, precioNeto: precioNeto, fromKit: fromKit });
    
    // Obtener precio correcto (especial o lista)
    precio = await obtenerPrecioArticulo(articuloId, precio);
    
    const existingItem = cart.find(item => item.articuloId === articuloId);
    
    // Obtener stock actual del DOM
    const card = document.querySelector(`[data-articulo-id="${articuloId}"]`);
    const stockActual = card ? parseInt(card.dataset.stock) : stock;
    
    if (existingItem) {
        if (existingItem.cantidad < stockActual) {
            existingItem.cantidad += 1;
            existingItem.total = parseFloat(existingItem.cantidad) * parseFloat(existingItem.precio);
            // Recalcular impuestos para la nueva cantidad
            // Los valores unitarios ya están en el item, solo multiplicamos por cantidad
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Stock Insuficiente',
                text: 'No hay suficiente stock para este producto',
                timer: 2000
            });
            return;
        }
    } else {
        // Calcular impuestos correctamente según la categoría
        let precioNetoCalculado, ivaCalculado, impuestoEspecificoCalculado;
        
        if (precioNeto && !categoriaExentaIva) {
            // Si tenemos precio neto y NO está exenta de IVA
            precioNetoCalculado = precioNeto;
            ivaCalculado = precioNeto * 0.19;
            impuestoEspecificoCalculado = precioNeto * (impuestoEspecifico / 100);
        } else if (precioNeto && categoriaExentaIva) {
            // Si tenemos precio neto y SÍ está exenta de IVA
            precioNetoCalculado = precioNeto;
            ivaCalculado = 0;
            impuestoEspecificoCalculado = precioNeto * (impuestoEspecifico / 100);
        } else {
            // Fallback: calcular desde el precio final (método anterior)
            const factorTotal = 1 + (categoriaExentaIva ? 0 : 0.19) + (impuestoEspecifico / 100);
            precioNetoCalculado = precio / factorTotal;
            ivaCalculado = categoriaExentaIva ? 0 : precioNetoCalculado * 0.19;
            impuestoEspecificoCalculado = precioNetoCalculado * (impuestoEspecifico / 100);
        }
        
        cart.push({
            articuloId: articuloId,
            nombre: nombre,
            precio: parseFloat(precio), // Precio final con impuestos
            precio_neto: precioNetoCalculado,
            iva: ivaCalculado,
            impuesto_especifico: impuestoEspecificoCalculado,
            categoriaExentaIva: categoriaExentaIva,
            impuestoEspecifico: impuestoEspecifico,
            cantidad: 1,
            descuento: 0,
            total: parseFloat(precio),
            fromKit: fromKit // Marcar si viene del kit
        });
    }
    
    updateCartDisplay();
    updateTotals();
}

// Actualizar display del carrito - DEBE ESTAR EN SCOPE GLOBAL
function updateCartDisplay() {
    const cartContainer = document.getElementById('pos-cart-items');
    cartContainer.innerHTML = '';

    if (cart.length === 0) {
        cartContainer.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-shopping-cart fa-2x mb-2"></i><p>Carrito vacío</p></div>';
        return;
    }

    cart.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'pos-cart-item';
        
        // Si el item viene del kit, bloquear cantidad
        const isFromKit = item.fromKit === true;
        const qtyButtons = isFromKit ? 
            `<button class="btn btn-sm btn-outline-secondary" disabled style="opacity: 0.3; cursor: not-allowed;">-</button>
             <span>${item.cantidad} <i class="fas fa-lock" style="font-size: 0.7rem; color: #C8A882;" title="Cantidad bloqueada (del kit)"></i></span>
             <button class="btn btn-sm btn-outline-secondary" disabled style="opacity: 0.3; cursor: not-allowed;">+</button>` :
            `<button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
             <span>${item.cantidad}</span>
             <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>`;
        
        const maxDescuentoLineal = parseFloat("{{ max_descuento_lineal|unlocalize|default:0 }}");
        let descuentoLinealInput = '';
        if (maxDescuentoLineal > 0) {
            descuentoLinealInput = `
                <input type="number" 
                       class="form-control form-control-sm descuento-lineal-input" 
                       style="width: 60px; text-align: right;" 
                       min="0" 
                       max="${maxDescuentoLineal}" 
                       step="0.01" 
                       value="${item.descuento}" 
                       onchange="aplicarDescuentoLineal(${index}, this.value)">
            `;
        } else {
            descuentoLinealInput = `${item.descuento}%`;
        }

        itemDiv.innerHTML = `
            <div class="cart-item-name">${item.nombre}${isFromKit ? ' <span style="font-size: 0.7rem; color: #C8A882;">🎁</span>' : ''}</div>
            <div class="cart-item-price">$${formatChileanNumber(item.precio)}</div>
            <div class="cart-item-qty">
                ${qtyButtons}
            </div>
            <div class="cart-item-discount">${descuentoLinealInput}</div>
            <div class="cart-item-total">$${formatChileanNumber(item.total)}</div>
            <div class="cart-item-actions">
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        cartContainer.appendChild(itemDiv);
    });
    
    // Scroll automático al último item agregado
    setTimeout(() => {
        cartContainer.scrollTop = cartContainer.scrollHeight;
    }, 50);
    
        // Actualizar totales después de mostrar items
    updateTotals();

    // Añadir listener para el descuento total si existe
    const descuentoTotalInput = document.getElementById('descuento-total-input');
    if (descuentoTotalInput) {
        descuentoTotalInput.addEventListener('change', (e) => {
            const maxDescuento = parseFloat(e.target.max) || 0;
            let valor = parseFloat(e.target.value) || 0;
            if (valor > maxDescuento) {
                valor = maxDescuento;
                e.target.value = valor;
                Swal.fire('Límite Excedido', `El descuento máximo total es ${maxDescuento}%`, 'warning');
            }
            if (valor < 0) {
                valor = 0;
                e.target.value = valor;
            }
            updateTotals();
        });
    }
}

// Aplicar descuento lineal a un item
function aplicarDescuentoLineal(index, descuento) {
    const item = cart[index];
    const maxDescuento = {{ max_descuento_lineal|unlocalize|default:0 }};
    let descuentoAplicado = parseFloat(descuento) || 0;

    if (descuentoAplicado > maxDescuento) {
        descuentoAplicado = maxDescuento;
        Swal.fire('Límite Excedido', `El descuento máximo por línea es ${maxDescuento}%`, 'warning');
    }

    if (descuentoAplicado < 0) {
        descuentoAplicado = 0;
    }

    item.descuento = descuentoAplicado;
    // Recalcular el total del item basado en el precio original y el descuento
    item.total = item.precio * item.cantidad * (1 - (descuentoAplicado / 100));

    updateCartDisplay();
    updateTotals();
}

// Actualizar cantidad - DEBE ESTAR EN SCOPE GLOBAL
function updateQuantity(index, change) {
    const item = cart[index];
    const newQuantity = item.cantidad + change;

    if (newQuantity <= 0) {
        removeFromCart(index);
        return;
    }
    
    // Verificar stock
    const card = document.querySelector(`[data-articulo-id="${item.articuloId}"]`);
    const stock = card ? parseInt(card.dataset.stock) : 999;
    if (newQuantity > stock) {
        Swal.fire({
            icon: 'warning',
            title: 'Stock Insuficiente',
            text: 'No hay suficiente stock para este producto',
            timer: 2000
        });
        return;
    }
    
    item.cantidad = newQuantity;
    item.total = parseFloat(item.cantidad) * parseFloat(item.precio);
    
    updateCartDisplay();
    updateTotals();
}

// Eliminar del carrito - DEBE ESTAR EN SCOPE GLOBAL
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
    updateTotals();
}

// Actualizar totales - DEBE ESTAR EN SCOPE GLOBAL
function updateTotals() {
    let subtotalBruto = 0; // Suma de precios originales
    let descuentoLinealTotal = 0;

    cart.forEach(item => {
        subtotalBruto += item.precio * item.cantidad;
        descuentoLinealTotal += (item.precio * item.cantidad) * (item.descuento / 100);
    });

    const subtotalPostDescuentoLineal = subtotalBruto - descuentoLinealTotal;

    const descuentoTotalInput = document.getElementById('descuento-total-input');
    const descuentoTotalPorcentaje = descuentoTotalInput ? parseFloat(descuentoTotalInput.value) || 0 : 0;
    const descuentoGlobalMonto = subtotalPostDescuentoLineal * (descuentoTotalPorcentaje / 100);

    const totalDescuentos = descuentoLinealTotal + descuentoGlobalMonto;
    const totalVentaConDescuentos = subtotalBruto - totalDescuentos;

    let netoFinal = 0;
    let ivaFinal = 0;
    let impuestoEspecificoFinal = 0;

    // Recalcular impuestos item por item con descuentos aplicados
    cart.forEach(item => {
        const precioOriginalItem = item.precio * item.cantidad;
        const descuentoLinealItem = precioOriginalItem * (item.descuento / 100);
        const precioPostDescuentoLineal = precioOriginalItem - descuentoLinealItem;
        
        // Distribuir el descuento global proporcionalmente
        const proporcionItem = subtotalPostDescuentoLineal > 0 ? precioPostDescuentoLineal / subtotalPostDescuentoLineal : 0;
        const descuentoGlobalItem = descuentoGlobalMonto * proporcionItem;
        
        const precioFinalItem = precioPostDescuentoLineal - descuentoGlobalItem;

        const factorImpuestos = 1 + (item.categoriaExentaIva ? 0 : 0.19) + (item.impuestoEspecifico / 100);
        const netoItem = precioFinalItem / factorImpuestos;

        netoFinal += netoItem;
        if (!item.categoriaExentaIva) {
            ivaFinal += netoItem * 0.19;
        }
        impuestoEspecificoFinal += netoItem * (item.impuestoEspecifico / 100);
    });

    currentSubtotal = subtotalBruto;
    currentDescuento = totalDescuentos;
    currentNeto = netoFinal;
    currentIva = ivaFinal;
    currentImpuestoEspecifico = impuestoEspecificoFinal;
    currentTotal = totalVentaConDescuentos;

    document.getElementById('subtotal').textContent = `$${formatChileanNumber(currentSubtotal)}`;
    document.getElementById('descuento').textContent = `-$${formatChileanNumber(currentDescuento)}`;
    document.getElementById('neto').textContent = `$${formatChileanNumber(currentNeto)}`;
    document.getElementById('iva').textContent = `$${formatChileanNumber(currentIva)}`;
    document.getElementById('impuesto_especifico').textContent = `$${formatChileanNumber(currentImpuestoEspecifico)}`;
    document.getElementById('total').textContent = `$${formatChileanNumber(currentTotal)}`;
}

// Formatear números - DEBE ESTAR EN SCOPE GLOBAL
function formatChileanNumber(num) {
    if (typeof num === 'string') {
        num = parseFloat(num);
    }
    const rounded = Math.round(num).toString();
    return rounded.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}
window.formatChileanNumber = formatChileanNumber;

console.log('=== FUNCIONES GLOBALES DEFINIDAS ===', {
    addToCart: typeof addToCart,
    updateCartDisplay: typeof updateCartDisplay,
    updateTotals: typeof updateTotals,
    formatChileanNumber: typeof formatChileanNumber
});

// Variable global para lista de precios
let listaPrecioActual = null;

// Cargar listas de precios
function cargarListasPrecios() {
    fetch('/articulos/api/listas-precios/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('listaPrecioSelect');
            select.innerHTML = '';
            
            // Agregar opción "Precio Base" al inicio
            const optionBase = document.createElement('option');
            optionBase.value = '';
            optionBase.textContent = '💰 Precio Base (Sin Lista)';
            select.appendChild(optionBase);
            
            if (data.listas && data.listas.length > 0) {
                data.listas.forEach(lista => {
                    const option = document.createElement('option');
                    option.value = lista.id;
                    option.textContent = lista.nombre + (lista.es_predeterminada ? ' ⭐' : '');
                    if (lista.es_predeterminada) {
                        option.selected = true;
                        listaPrecioActual = lista.id;
                    }
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error al cargar listas de precios:', error);
            document.getElementById('listaPrecioSelect').innerHTML = '<option value="">Error al cargar</option>';
        });
}

// Toggle entre vista grid y lista
function toggleVista(vista) {
    const grid = document.getElementById('pos-products-grid');
    const btnGrid = document.getElementById('btnVistaGrid');
    const btnLista = document.getElementById('btnVistaLista');
    
    if (vista === 'lista') {
        grid.classList.add('vista-lista');
        btnLista.classList.add('active');
        btnGrid.classList.remove('active');
        localStorage.setItem('posVista', 'lista');
    } else {
        grid.classList.remove('vista-lista');
        btnGrid.classList.add('active');
        btnLista.classList.remove('active');
        localStorage.setItem('posVista', 'grid');
    }
}

// ===== FUNCIONES PARA KITS DE OFERTAS =====

// Agregar kit completo al carrito
function agregarKitCompleto(kitId, kitNombre, kitPrecio, kitStock) {
    // Convertir a número (ya viene sin formato desde el template)
    const precioLimpio = parseInt(kitPrecio);
    const stockLimpio = parseInt(kitStock);
    
    console.log('*** AGREGANDO KIT COMPLETO ***', kitId, kitNombre, precioLimpio, stockLimpio);
    
    if (stockLimpio <= 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin Stock',
            text: 'Este kit no tiene stock disponible',
            confirmButtonColor: '#8B7355'
        });
        return;
    }
    
    // Buscar si el kit ya está en el carrito
    const itemExistente = cart.find(item => item.tipo === 'kit' && item.kitId == kitId);
    
    if (itemExistente) {
        if (itemExistente.cantidad >= stockLimpio) {
            Swal.fire({
                icon: 'warning',
                title: 'Stock Insuficiente',
                text: 'No hay más stock disponible de este kit',
                confirmButtonColor: '#8B7355'
            });
            return;
        }
        itemExistente.cantidad++;
        itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
        itemExistente.total = itemExistente.subtotal;
    } else {
        // Calcular neto e IVA del kit (precio incluye IVA)
        const precioNeto = Math.round(precioLimpio / 1.19);
        const iva = precioLimpio - precioNeto;
        
        // Agregar nuevo kit al carrito
        cart.push({
            tipo: 'kit',
            kitId: kitId,
            id: `kit-${kitId}`,
            nombre: `🎁 ${kitNombre}`,
            precio: precioLimpio,
            precio_neto: precioNeto,
            iva: iva,
            cantidad: 1,
            subtotal: precioLimpio,
            total: precioLimpio,
            descuento: 0,
            stock: stockLimpio,
            categoriaExentaIva: false,
            impuestoEspecifico: 0
        });
    }
    
    updateCartDisplay();
    
    // Feedback visual
    Swal.fire({
        icon: 'success',
        title: 'Kit Agregado',
        text: `${kitNombre} agregado al carrito`,
        timer: 1500,
        showConfirmButton: false
    });
}

// Desglosar kit en items individuales y agregarlos al carrito
async function desglosarKitEnCarrito(kitId) {
    console.log('*** DESGLOSANDO KIT EN CARRITO ***', kitId);
    
    try {
        // Obtener datos del kit desde el servidor
        const response = await fetch(`/articulos/kits/${kitId}/items-json/`);
        
        if (!response.ok) {
            throw new Error('No se pudo obtener los items del kit');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.items || data.items.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Kit Vacío',
                text: 'Este kit no tiene artículos configurados',
                confirmButtonColor: '#8B7355'
            });
            return;
        }
        
        // Mostrar confirmación con lista de items
        let itemsHtml = '<div style="text-align: left; max-height: 300px; overflow-y: auto;">';
        data.items.forEach(item => {
            itemsHtml += `<p style="margin: 5px 0;"><strong>${item.articulo_nombre}</strong> x${item.cantidad}</p>`;
        });
        itemsHtml += '</div>';
        
        const result = await Swal.fire({
            icon: 'question',
            title: 'Desglosar Kit',
            html: `
                <p>¿Deseas agregar estos artículos individualmente al carrito?</p>
                ${itemsHtml}
            `,
            showCancelButton: true,
            confirmButtonText: 'Sí, agregar items',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#8B7355',
            cancelButtonColor: '#6c757d'
        });
        
        if (result.isConfirmed) {
            // Calcular precio total normal de todos los items
            const precioTotalNormal = data.items.reduce((sum, item) => 
                sum + (item.precio_unitario * item.cantidad), 0
            );
            
            // Calcular factor de descuento proporcional
            const factorDescuento = data.kit_precio / precioTotalNormal;
            
            console.log('*** CÁLCULO PROPORCIONAL ***');
            console.log('Precio kit:', data.kit_precio);
            console.log('Precio total normal:', precioTotalNormal);
            console.log('Factor descuento:', factorDescuento);
            
            // Agregar cada item al carrito con precio proporcional
            let itemsAgregados = 0;
            for (const item of data.items) {
                // Buscar el artículo en el POS
                const articulo = window.articulos.find(a => a.id == item.articulo_id);
                if (articulo && articulo.stock > 0) {
                    // Calcular precio proporcional
                    const precioProporcionado = Math.round(item.precio_unitario * factorDescuento);
                    
                    console.log(`Item: ${item.articulo_nombre}`);
                    console.log(`  Precio normal: ${item.precio_unitario}`);
                    console.log(`  Precio proporcional: ${precioProporcionado}`);
                    console.log(`  Cantidad: ${item.cantidad}`);
                    
                    // Agregar con precio proporcional y cantidad correcta
                    // Marcar como item del kit para bloquear cantidad
                    for (let i = 0; i < item.cantidad; i++) {
                        await addToCartFromAnywhere(item.articulo_id, item.articulo_nombre, precioProporcionado, 1, true);
                    }
                    itemsAgregados++;
                }
            }
            
            if (itemsAgregados > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'Items Agregados',
                    html: `
                        <p>${itemsAgregados} artículo(s) agregado(s) al carrito</p>
                        <p class="text-muted" style="font-size: 0.9rem;">Precios ajustados proporcionalmente al kit</p>
                    `,
                    timer: 2500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin Stock',
                    text: 'Los artículos del kit no tienen stock disponible',
                    confirmButtonColor: '#8B7355'
                });
            }
        }
        
    } catch (error) {
        console.error('Error al desglosar kit:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo desglosar el kit. Intenta con "Kit Completo".',
            confirmButtonColor: '#8B7355'
        });
    }
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    console.log('*** DOMContentLoaded INICIADO ***');
    
    // Cargar listas de precios
    cargarListasPrecios();
    
    // Event listener para cambio de lista de precios
    document.getElementById('listaPrecioSelect').addEventListener('change', function() {
        listaPrecioActual = this.value;
        console.log('Lista de precios cambiada a:', listaPrecioActual);
        
        // Recargar productos con nueva lista
        filterProducts();
    });
    
    // Event listeners para botones de vista
    document.getElementById('btnVistaGrid').addEventListener('click', function() {
        toggleVista('grid');
    });
    
    document.getElementById('btnVistaLista').addEventListener('click', function() {
        toggleVista('lista');
    });
    
    // Event listener para toggle de categorías
    document.getElementById('btnToggleCategorias').addEventListener('click', function() {
        const container = document.getElementById('categoriasContainer');
        const icono = document.getElementById('iconoCategorias');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            icono.classList.remove('fa-chevron-down');
            icono.classList.add('fa-chevron-up');
        } else {
            container.style.display = 'none';
            icono.classList.remove('fa-chevron-up');
            icono.classList.add('fa-chevron-down');
        }
    });
    
    // Restaurar vista guardada
    const vistaGuardada = localStorage.getItem('posVista');
    if (vistaGuardada === 'lista') {
        toggleVista('lista');
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);
        
        // Cargar información de estación y vendedor
        loadSessionInfo();
    
    // Event listeners
    document.getElementById('pos-search').addEventListener('input', filterProducts);
    
    const btnProcess = document.getElementById('btn-process');
    console.log('*** Botón Procesar Venta encontrado:', btnProcess);
    if (btnProcess) {
        btnProcess.addEventListener('click', function(e) {
            console.log('*** EVENT LISTENER EJECUTADO - CLICK EN BTN-PROCESS ***');
            e.preventDefault();
            processSale();
        });
        console.log('*** Event listener agregado exitosamente ***');
    } else {
        console.error('*** ERROR: No se encontró el botón btn-process ***');
    }
    
    document.getElementById('btn-clear').addEventListener('click', clearCart);
    
    // Configurar botón "Todas" para filtro de categorías
    const btnTodas = document.querySelector('.category-btn[data-category="all"]');
    if (btnTodas) {
        btnTodas.addEventListener('click', (e) => filterByCategory('all', e.target));
        console.log('Botón "Todas" configurado');
    }
    
    // Cargar artículos desde el DOM
    loadArticulosFromDOM();
    
    // Configurar el sistema de código de barras
    setupBarcodeSystem();
    
    // Click en productos (usando event delegation)
    document.addEventListener('click', async function(e) {
        console.log('*** CLICK DETECTADO ***', e.target);
        
        if (e.target.closest('.pos-product-card')) {
            console.log('*** PRODUCTO ENCONTRADO ***');
            const card = e.target.closest('.pos-product-card');
            
            if (card.classList.contains('disabled')) {
                console.log('*** PRODUCTO DESHABILITADO ***');
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin Stock',
                    text: 'Este producto no tiene stock disponible',
                    timer: 2000
                });
                return;
            }
            
            const articuloId = card.dataset.articuloId;
            const precio = parseFloat(card.dataset.precio);
            const stock = parseInt(card.dataset.stock);
            const nombre = card.querySelector('.pos-product-name').textContent;
            
            // Obtener información de impuestos del producto
            const categoriaExentaIva = card.dataset.categoriaExentaIva === 'true';
            const impuestoEspecifico = parseFloat(card.dataset.impuestoEspecifico || '0');
            const precioNeto = parseFloat(card.dataset.precioNeto || precio);
            
            console.log('*** AGREGANDO AL CARRITO ***', { articuloId: articuloId, nombre: nombre, precio: precio, stock: stock, categoriaExentaIva: categoriaExentaIva, impuestoEspecifico: impuestoEspecifico, precioNeto: precioNeto });
            await addToCart(articuloId, nombre, precio, stock, categoriaExentaIva, impuestoEspecifico, precioNeto);
        } else {
            console.log('*** NO ES UN PRODUCTO ***');
        }
    });
    
    // Cargar categorías
    loadCategories();

    // Cargar información de la sesión
    function loadSessionInfo() {
        // Obtener información de la sesión desde el servidor
        fetch('/ventas/pos/session-info/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('estacion-nombre').textContent = data.estacion_nombre;
                    document.getElementById('vendedor-nombre').textContent = data.vendedor_nombre;
                    
                    // Guardar IDs para uso posterior
                    window.currentEstacionId = data.estacion_id;
                    window.currentVendedorId = data.vendedor_id;
                    window.currentEstacion = data.estacion;
                } else {
                    // Si no hay sesión, redirigir a selección
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sesión no encontrada',
                        text: 'Debe seleccionar una estación de trabajo y vendedor',
                        timer: 3000
                    }).then(() => {
                        window.location.href = '{% url "ventas:pos_seleccion" %}';
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar información de sesión:', error);
                window.location.href = '{% url "ventas:pos_seleccion" %}';
            });
    }

// Actualizar fecha y hora
function updateDateTime() {
    const now = new Date();
        const dateStr = now.toLocaleDateString('es-CL');
        const timeStr = now.toLocaleTimeString('es-CL');
        
        document.getElementById('current-date').textContent = dateStr;
        document.getElementById('current-time').textContent = timeStr;
    }

    // Cargar categorías
    function loadCategories() {
        const categories = new Set();
        document.querySelectorAll('.pos-product-card').forEach(card => {
            const category = card.dataset.categoria;
            if (category && category !== 'sin-categoria') {
                categories.add(category);
            }
        });
        
        const categoryContainer = document.querySelector('.pos-category-filter');
        
        // Agregar categorías dinámicamente
        Array.from(categories).sort().forEach(category => {
            const btn = document.createElement('button');
            btn.className = 'category-btn';
            btn.textContent = category;
            btn.dataset.category = category;
            btn.addEventListener('click', (e) => filterByCategory(category, e.target));
            categoryContainer.appendChild(btn);
        });
        
        console.log('Categorías cargadas:', categories.size);
    }

    // Filtrar por categoría
    function filterByCategory(category, buttonElement) {
        console.log('Filtrando por categoría:', category);
        currentCategory = category;
        
        // Actualizar botones - quitar active de todos
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Agregar active al botón clickeado
        if (buttonElement) {
            buttonElement.classList.add('active');
        } else {
            // Si no hay elemento (llamada programática), buscar el botón correcto
            const targetBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }
        
        // Limpiar búsqueda
        const searchInput = document.getElementById('pos-search');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Filtrar productos
        let visibleCount = 0;
        const grid = document.getElementById('pos-products-grid');
        const esVistaLista = grid.classList.contains('vista-lista');
        
        document.querySelectorAll('.pos-product-card').forEach(card => {
            const cardCategory = card.dataset.categoria;
            if (category === 'all' || cardCategory === category) {
                // Usar flex para mantener el estilo correcto según la vista
                card.style.display = esVistaLista ? 'flex' : 'flex';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        console.log(`Mostrando ${visibleCount} productos de categoría: ${category}`);
}

// Variable para controlar el timeout de búsqueda
let searchTimeout = null;

// Filtrar productos - ahora busca en toda la base de datos
function filterProducts() {
    const searchInput = document.getElementById('pos-search');
    if (!searchInput) {
        console.error('Input de búsqueda no encontrado');
        return;
    }
    
    const searchTerm = searchInput.value.trim();
    console.log('Buscando:', searchTerm);
    
    // Cancelar búsqueda anterior si existe
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (!searchTerm) {
        // Si no hay término de búsqueda, mostrar productos cargados según categoría
        let count = 0;
        const grid = document.getElementById('pos-products-grid');
        const esVistaLista = grid.classList.contains('vista-lista');
        
        document.querySelectorAll('.pos-product-card').forEach(card => {
            const category = card.dataset.categoria;
            const matchesCategory = currentCategory === 'all' || category === currentCategory;
            if (matchesCategory) {
                card.style.display = 'flex';
                count++;
            } else {
                card.style.display = 'none';
            }
        });
        console.log(`Mostrando ${count} productos (sin búsqueda)`);
        return;
    }
    
    // Esperar 500ms antes de buscar (debounce)
    searchTimeout = setTimeout(() => {
        buscarEnBaseDatos(searchTerm);
    }, 500);
}

// Buscar en toda la base de datos
function buscarEnBaseDatos(query) {
    console.log('Buscando en base de datos:', query);
    
    // Remover mensaje de "no resultados" si existe
    const mensajeAnterior = document.getElementById('no-results-message');
    if (mensajeAnterior) {
        mensajeAnterior.remove();
    }
    
    // Remover productos dinámicos anteriores (los que fueron agregados por búsquedas previas)
    document.querySelectorAll('.pos-product-card[data-dinamico="true"]').forEach(card => {
        card.remove();
    });
    
    // Ocultar todos los productos cargados inicialmente
    document.querySelectorAll('.pos-product-card').forEach(card => {
        card.style.display = 'none';
    });
    
    // Construir URL con lista de precios si está seleccionada
    let url = `/ventas/pos/buscar-articulo/?q=${encodeURIComponent(query)}`;
    if (listaPrecioActual) {
        url += `&lista_precio=${listaPrecioActual}`;
        console.log('Usando lista de precios:', listaPrecioActual);
    }
    
    // Buscar en el backend
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Resultados de búsqueda:', data.articulos ? data.articulos.length : 0);
            
            if (data.articulos && data.articulos.length > 0) {
                console.log('=== PROCESANDO', data.articulos.length, 'PRODUCTOS ===');
                // Mostrar todos los productos que coinciden con la búsqueda
                data.articulos.forEach((articulo, index) => {
                    console.log(`[${index + 1}] ID: ${articulo.id}, Nombre: ${articulo.nombre}`);
                    const card = document.querySelector(`.pos-product-card[data-articulo-id="${articulo.id}"]`);
                    if (card) {
                        // Si el producto ya está cargado, mostrarlo con flex
                        card.style.display = 'flex';
                        console.log(`  ✓ Mostrando producto existente en DOM`);
                    } else {
                        // Si no está cargado, agregarlo dinámicamente
                        console.log(`  + Agregando producto nuevo al DOM`);
                        agregarProductoDinamico(articulo);
                    }
                });
                console.log('=== FIN PROCESAMIENTO ===');
            } else {
                // No se encontraron resultados
                console.log('No se encontraron productos');
                mostrarMensajeNoResultados();
            }
        })
        .catch(error => {
            console.error('Error en búsqueda:', error);
        });
}

// Agregar producto dinámicamente al grid
function agregarProductoDinamico(articulo) {
    const grid = document.getElementById('pos-products-grid');
    if (!grid) return;
    
    // Verificar si ya existe
    if (document.querySelector(`.pos-product-card[data-articulo-id="${articulo.id}"]`)) {
        return;
    }
    
    const card = document.createElement('div');
    card.className = 'pos-product-card';
    card.dataset.articuloId = articulo.id;
    card.dataset.categoria = 'Búsqueda';
    card.dataset.dinamico = 'true';  // Marcar como producto dinámico
    
    // Guardar datos del artículo en el elemento para que el event listener global pueda accederlos
    card.dataset.precio = articulo.precio;
    card.dataset.stock = articulo.stock;
    card.dataset.categoriaExentaIva = articulo.categoria_exenta_iva || false;
    card.dataset.impuestoEspecificoPorcentaje = articulo.impuesto_especifico_porcentaje || 0;
    
    card.innerHTML = `
        <div class="pos-product-name">${articulo.nombre || articulo.descripcion || articulo.codigo}</div>
        <div class="pos-product-code">${articulo.codigo}</div>
        <div class="pos-product-price">$${new Intl.NumberFormat('es-CL').format(Math.round(articulo.precio))}</div>
        <div class="pos-product-stock">Stock: ${articulo.stock}</div>
    `;
    
    // NO agregar event listener aquí - el global ya lo maneja
    
    // Agregar al inicio del grid
    grid.insertBefore(card, grid.firstChild);
}

// Mostrar mensaje cuando no hay resultados
function mostrarMensajeNoResultados() {
    const grid = document.getElementById('pos-products-grid');
    if (!grid) return;
    
    // Remover mensaje anterior si existe
    const mensajeAnterior = document.getElementById('no-results-message');
    if (mensajeAnterior) {
        mensajeAnterior.remove();
    }
    
    const mensaje = document.createElement('div');
    mensaje.id = 'no-results-message';
    mensaje.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 2rem; color: #6c757d;';
    mensaje.innerHTML = '<i class="fas fa-search fa-2x mb-2"></i><br>No se encontraron productos';
    
    grid.appendChild(mensaje);
}

// NOTA: Funciones del carrito ahora están en el scope global (líneas 736-920)

// Limpiar carrito
function clearCart() {
    // Desactivar temporalmente el modo escaneo
    wasScanningMode = barcodeMode; // Guardar en variable global
    barcodeMode = false;
    
    Swal.fire({
        title: '¿Limpiar carrito?',
        text: 'Se eliminarán todos los productos del carrito',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, limpiar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            cart = [];
            updateCartDisplay();
            updateTotals();
        }
        
        // Restaurar modo escaneo si estaba activo
        if (wasScanningMode) {
            setTimeout(() => {
                barcodeMode = true;
                const barcodeInput = document.getElementById('barcode-input');
                if (barcodeInput) {
                    barcodeInput.focus();
                }
            }, 1000);
        }
    });
}

    // Procesar venta
    function processSale() {
        console.log('*** BOTON PROCESAR VENTA CLICKEADO ***');
        console.log('Cart length:', cart.length);
        console.log('window.currentEstacion:', window.currentEstacion);
        
        // Desactivar temporalmente el modo escaneo
        wasScanningMode = barcodeMode; // Guardar en variable global
        barcodeMode = false;
        
        if (cart.length === 0) {
            console.log('*** ERROR: Carrito vacío ***');
            Swal.fire({
                icon: 'warning',
                title: 'Carrito Vacío',
                text: 'Agrega productos al carrito antes de procesar la venta',
                timer: 2000
            }).then(() => {
                // Restaurar modo escaneo si estaba activo
                if (wasScanningMode) {
                    setTimeout(() => {
                        barcodeMode = true;
                        const barcodeInput = document.getElementById('barcode-input');
                        if (barcodeInput) {
                            barcodeInput.focus();
                        }
                    }, 1000);
                }
            });
            return;
        }
    
        if (!window.currentEstacion) {
            console.log('*** ERROR: No hay estación cargada ***');
            Swal.fire({
                icon: 'error',
                title: 'Error de Sesión',
                text: 'No se encontró información de la estación de trabajo. Por favor, recarga la página.',
                timer: 3000,
                showConfirmButton: true
            });
            return;
        }
        
        console.log('*** Llamando a showDocumentTypeSelector() ***');
        // Mostrar selector de tipo de documento
        showDocumentTypeSelector();
    }
    
    // Alias para compatibilidad
    const procesarPreventa = processSale;
    
    // Mostrar selector de tipo de documento para preventa
    function showDocumentTypeSelector() {
        console.log('*** INICIO showDocumentTypeSelector() ***');
        console.log('window.currentEstacion:', window.currentEstacion);
        console.log('SweetAlert2 disponible:', typeof Swal !== 'undefined');
        
        // Inicializar variable global para tipo de documento
        window.tipoDocumentoSeleccionado = null;
        
        let tiposPermitidos = window.currentEstacion.tipos_documentos;
        console.log('Tipos permitidos:', tiposPermitidos);
        
        // Si está en modo "con_cliente", filtrar boletas y vales
        const modoPOS = '{{ modo_pos }}';
        if (modoPOS === 'con_cliente') {
            tiposPermitidos = tiposPermitidos.filter(tipo => tipo !== 'boleta' && tipo !== 'vale');
        }
        
        if (tiposPermitidos.length === 0) {
            console.log('*** ERROR: No hay tipos de documentos permitidos ***');
            Swal.fire({
                icon: 'warning',
                title: 'Sin Documentos Permitidos',
                text: 'Esta estación no puede emitir ningún tipo de documento',
                timer: 3000
            });
            return;
        }
    
        // Crear botones de documentos con badges destacados
        const opciones = tiposPermitidos.map(tipo => {
            const config = {
                'factura': { nombre: 'Factura', icono: 'fa-file-invoice', color: '#28a745', disponibles: window.currentEstacion.folios_factura || 0 },
                'boleta': { nombre: 'Boleta', icono: 'fa-receipt', color: '#007bff', disponibles: window.currentEstacion.folios_boleta || 0 },
                'guia': { nombre: 'Guía de Despacho', icono: 'fa-truck', color: '#ffc107', disponibles: window.currentEstacion.folios_guia || 999 },
                'cotizacion': { nombre: 'Cotización', icono: 'fa-file-alt', color: '#6f42c1', disponibles: 999 },
                'vale': { nombre: 'Vale Facturable', icono: 'fa-ticket-alt', color: '#6c757d', disponibles: 999 }
            };
            
            const info = config[tipo];
            const iconoEstado = info.disponibles > 10 ? '✓' : (info.disponibles > 0 ? '⚠️' : '✗');
            const colorBadge = info.disponibles > 10 ? '#28a745' : (info.disponibles > 0 ? '#ffc107' : '#dc3545');
            
            return `
                <button type="button" class="btn-tipo-documento" data-tipo="${tipo}" style="
                    width: 100%;
                    padding: 16px;
                    margin-bottom: 12px;
                    background: white;
                    border: 3px solid ${info.color};
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas ${info.icono}" style="font-size: 2rem; color: ${info.color};"></i>
                        <div style="text-align: left;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50;">${info.nombre}</div>
                            <div style="font-size: 0.75rem; color: #6c757d;">Documento tributario</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5rem;">${iconoEstado}</span>
                        <span style="
                            padding: 6px 12px;
                            border: 2px solid ${colorBadge};
                            border-radius: 8px;
                            font-size: 0.9rem;
                            font-weight: 600;
                            color: ${colorBadge};
                            background: white;
                        ">${info.disponibles}</span>
                    </div>
                </button>
            `;
        }).join('');
        
        // Verificar si ya hay un cliente seleccionado
        const clienteYaSeleccionado = window.clienteSeleccionado;
        console.log('=== MODAL PROCESAR VENTA ===');
        console.log('Cliente completo:', clienteYaSeleccionado);
        console.log('Cliente.id:', clienteYaSeleccionado ? clienteYaSeleccionado.id : 'No hay cliente');
        console.log('Cliente.nombre:', clienteYaSeleccionado ? clienteYaSeleccionado.nombre : 'No hay cliente');
        console.log('Cliente.rut:', clienteYaSeleccionado ? clienteYaSeleccionado.rut : 'No hay cliente');
        console.log('Cliente.rut_formatted:', clienteYaSeleccionado ? clienteYaSeleccionado.rut_formatted : 'No hay cliente');
        console.log('Cliente.direccion:', clienteYaSeleccionado ? clienteYaSeleccionado.direccion : 'No hay cliente');
        console.log('===========================');
        
        const html = `
            <div class="mb-3">
                <label class="form-label" style="font-weight: 700; color: #2c3e50; font-size: 1.1rem; text-align: left; display: block; margin-bottom: 16px;">
                    <i class="fas fa-file-invoice me-2"></i>Seleccione el Tipo de Documento a Emitir *
                </label>
                <input type="hidden" id="tipo-documento" required>
                <div id="botones-tipo-documento">
                    ${opciones}
                </div>
                <small style="color: #6c757d; font-size: 0.8rem; display: block; margin-top: 8px; text-align: center;">
                    <i class="fas fa-info-circle me-1"></i>Este documento se emitirá posteriormente en el módulo de caja
                </small>
            </div>
            
            <!-- Tipo de Despacho (solo para Guías) -->
            <div class="mb-3" id="tipo-despacho-container" style="display: none;">
                <label class="form-label" style="font-weight: 700; color: #495057; text-align: left; display: block;">Motivo de Traslado *</label>
                <select id="tipo-despacho" class="form-control">
                    <option value="">Seleccionar motivo...</option>
                    <option value="1">1 - Venta</option>
                    <option value="2">2 - Venta por efectuar (anticipada)</option>
                    <option value="3">3 - Consignación</option>
                    <option value="4">4 - Devolución</option>
                    <option value="5">5 - Traslado interno</option>
                    <option value="6">6 - Transformación de productos</option>
                    <option value="7">7 - Entrega gratuita</option>
                    <option value="8">8 - Otros</option>
                </select>
                <small style="color: #adb5bd; font-size: 0.7rem;">Según SII - Motivo de traslado de la guía de despacho</small>
            </div>
            
            <!-- Referencias (solo para Facturas y Guías) -->
            <div class="mb-3" id="referencias-container" style="display: none;">
                <label class="form-label" style="font-weight: 700; color: #495057; text-align: left; display: block;">Referencias del Documento</label>
                
                <!-- Botón para mostrar/ocultar formulario de referencias -->
                <button type="button" id="btn-toggle-referencias" class="btn btn-sm w-100 mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px; border-radius: 8px; font-weight: 500; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                    <i class="fas fa-plus-circle me-2"></i>Agregar Referencias (Opcional)
                </button>
                
                <!-- Tarjeta con formulario y lista de referencias (inicialmente oculta) -->
                <div id="card-referencias" class="card" style="display: none; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="card-body" style="padding: 12px;">
                        <!-- Formulario inline para agregar referencias -->
                        <div id="form-referencia-inline" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <h6 style="color: #495057; font-size: 0.85rem; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-file-alt me-2"></i>Nueva Referencia
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Tipo *</label>
                                    <select id="tipo-referencia-inline" class="form-control form-control-sm">
                                        <option value="">Seleccionar...</option>
                                        <option value="801">Orden de Compra (801)</option>
                                        <option value="802">Nota de Pedido (802)</option>
                                        <option value="803">Contrato (803)</option>
                                        <option value="52">Guía de Despacho (52)</option>
                                        <option value="HES">HES</option>
                                        <option value="HEM">HEM</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Folio *</label>
                                    <input type="text" id="folio-referencia-inline" class="form-control form-control-sm" placeholder="Ej: OC-12345">
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Fecha *</label>
                                    <input type="date" id="fecha-referencia-inline" class="form-control form-control-sm">
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Comentario</label>
                                    <input type="text" id="razon-referencia-inline" class="form-control form-control-sm" placeholder="Opcional">
                                </div>
                            </div>
                            <button type="button" id="btn-agregar-ref-inline" class="btn btn-success btn-sm w-100 mt-2" style="font-size: 0.8rem; padding: 6px;">
                                <i class="fas fa-plus me-1"></i>Agregar a la Lista
                            </button>
                        </div>
                        
                        <!-- Lista de referencias agregadas -->
                        <div id="referencias-lista">
                            <div style="font-size: 0.8rem; color: #495057; margin-bottom: 8px; padding: 8px; background: #e7f3ff; border-radius: 6px;">
                                <i class="fas fa-list me-2"></i><strong>Referencias Agregadas: <span id="contador-refs-inline">0</span></strong>
                            </div>
                            <table class="table table-sm table-bordered" id="tabla-referencias" style="display: none; font-size: 0.75rem; margin-bottom: 0;">
                                <thead style="background: #e9ecef;">
                                    <tr>
                                        <th style="width: 30%; padding: 4px 6px;">Tipo</th>
                                        <th style="width: 20%; padding: 4px 6px;">Folio</th>
                                        <th style="width: 18%; padding: 4px 6px;">Fecha</th>
                                        <th style="width: 22%; padding: 4px 6px;">Comentario</th>
                                        <th style="width: 10%; text-align: center; padding: 4px 6px;"><i class="fas fa-trash"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-referencias">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label" style="font-weight: 700; color: #495057; text-align: left; display: block;">Cliente *</label>
                
                ${clienteYaSeleccionado && '{{ modo_pos }}' === 'con_cliente' ? `
                    <!-- Cliente ya seleccionado en modo con_cliente - NO EDITABLE -->
                    <div class="alert alert-info mb-0" style="background: #E8F4F8; border: 1px solid #B8E0F0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user-check me-2" style="color: #0c5460;"></i>
                                <strong style="color: #0c5460;">${clienteYaSeleccionado.nombre}</strong><br>
                                <small style="color: #0c5460;">RUT: ${clienteYaSeleccionado.rut || clienteYaSeleccionado.rut_formatted || 'Sin RUT'}</small>
                            </div>
                        </div>
                        <small class="d-block mt-2" style="color: #0c5460;">
                            <i class="fas fa-info-circle me-1"></i>
                            Cliente seleccionado para esta venta.
                        </small>
                    </div>
                    <input type="hidden" id="busqueda-cliente" value="${clienteYaSeleccionado.rut || clienteYaSeleccionado.rut_formatted || ''}">
                ` : `
                    <!-- Modo normal - Búsqueda habilitada -->
                    <div class="input-group mb-2">
                        <input type="text" id="busqueda-cliente" class="form-control" placeholder="RUT o nombre del cliente" required ${clienteYaSeleccionado ? 'value="' + clienteYaSeleccionado.rut + '"' : ''}>
                        <button type="button" class="btn btn-outline-secondary" onclick="buscarCliente()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    {% if modo_pos != 'con_cliente' %}
                    <button type="button" id="btn-venta-boleta" class="btn btn-sm w-100 mb-2" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; border: none; display: none;">
                        <i class="fas fa-receipt me-2"></i>Venta Boleta (RUT Genérico 66666666-6)
                    </button>
                    {% endif %}
                    <div id="resultados-busqueda" class="mt-2" style="display: none;">
                        <div class="list-group" id="lista-clientes">
                            <!-- Resultados de búsqueda aparecerán aquí -->
                        </div>
                    </div>
                    <div id="cliente-info" class="mt-2" style="display: ${clienteYaSeleccionado ? 'block' : 'none'};">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong id="cliente-nombre">${clienteYaSeleccionado ? clienteYaSeleccionado.nombre : '-'}</strong><br>
                            <small id="cliente-direccion">${clienteYaSeleccionado ? (clienteYaSeleccionado.direccion || 'Sin dirección') : '-'}</small>
                        </div>
                    </div>
                    <div id="cliente-no-encontrado" class="mt-2" style="display: none;">
                        <div class="alert alert-warning">
                            <strong>Cliente no encontrado</strong><br>
                            <button type="button" class="btn btn-sm btn-primary" id="btn-crear-cliente">
                                <i class="fas fa-plus me-1"></i>Crear Cliente
                            </button>
                        </div>
                    </div>
                `}
            </div>
        `;
        
        console.log('*** Preparando para abrir modal Swal.fire ***');
        console.log('HTML generado para modal, longitud:', html.length);
        
        Swal.fire({
            title: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;"><i class="fas fa-cash-register me-2"></i>Procesar Preventa</div>',
            html: html,
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-check me-2"></i>Procesar Preventa',
            cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            width: '650px',
            didOpen: () => {
                // Agregar búsqueda en tiempo real
                const busquedaClienteInput = document.getElementById('busqueda-cliente');
                if (busquedaClienteInput) {
                    busquedaClienteInput.addEventListener('input', function() {
                        const busqueda = this.value.trim();
                        if (busqueda.length >= 2) {
                            buscarCliente();
                        } else {
                            document.getElementById('resultados-busqueda').style.display = 'none';
                            document.getElementById('cliente-info').style.display = 'none';
                            document.getElementById('cliente-no-encontrado').style.display = 'none';
                            window.clienteSeleccionado = null;
                        }
                    });
                }
                
                // Mostrar/ocultar botón de venta boleta según tipo de documento
                const tipoDocSelect = document.getElementById('tipo-documento');
                const btnVentaBoleta = document.getElementById('btn-venta-boleta');
                const tipoDespachoContainer = document.getElementById('tipo-despacho-container');
                const referenciasContainer = document.getElementById('referencias-container');
                
                // Array para almacenar referencias
                window.referencias = [];
                
                function toggleCamposSegunTipoDoc() {
                    const tipoDoc = tipoDocSelect.value;
                    
                    // Mostrar/ocultar botón boleta
                    if (btnVentaBoleta) {
                        btnVentaBoleta.style.display = (tipoDoc === 'boleta') ? 'block' : 'none';
                    }
                    
                    // Mostrar/ocultar tipo de despacho (solo para guías)
                    if (tipoDoc === 'guia') {
                        tipoDespachoContainer.style.display = 'block';
                        document.getElementById('tipo-despacho').required = true;
                    } else {
                        tipoDespachoContainer.style.display = 'none';
                        document.getElementById('tipo-despacho').required = false;
                    }
                    
                    // Mostrar/ocultar referencias (para facturas y guías)
                    if (tipoDoc === 'factura' || tipoDoc === 'guia') {
                        referenciasContainer.style.display = 'block';
                    } else {
                        referenciasContainer.style.display = 'none';
                    }
                }
                
                // Manejar clics en botones de tipo de documento
                document.querySelectorAll('.btn-tipo-documento').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Remover selección de todos los botones
                        document.querySelectorAll('.btn-tipo-documento').forEach(b => {
                            b.style.background = 'white';
                            b.style.transform = 'scale(1)';
                            b.style.boxShadow = 'none';
                            b.style.fontWeight = 'normal';
                        });
                        
                        // Marcar este botón como seleccionado con estilo DESTACADO
                        const borderColor = this.style.borderColor;
                        this.style.background = 'linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%)';
                        this.style.transform = 'scale(1.05)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2), 0 0 0 3px #ffc107';
                        this.style.fontWeight = 'bold';
                        
                        // Actualizar campo oculto y variable global
                        const tipo = this.getAttribute('data-tipo');
                        tipoDocSelect.value = tipo;
                        window.tipoDocumentoSeleccionado = tipo; // Guardar en variable global
                        console.log('[TIPO DOC] Tipo seleccionado:', tipo);
                        console.log('[TIPO DOC] Campo hidden value:', tipoDocSelect.value);
                        
                        // Trigger del evento change para mostrar/ocultar campos
                        toggleCamposSegunTipoDoc();
                    });
                });
                
                tipoDocSelect.addEventListener('change', toggleCamposSegunTipoDoc);
                toggleCamposSegunTipoDoc(); // Verificar estado inicial
                
                // Agregar evento click al botón de venta boleta
                if (btnVentaBoleta) {
                    btnVentaBoleta.addEventListener('click', function() {
                        const busquedaInput = document.getElementById('busqueda-cliente');
                        busquedaInput.value = '66666666-6';
                        buscarCliente();
                    });
                }
                
                // Botón toggle para mostrar/ocultar formulario de referencias
                const btnToggleRefs = document.getElementById('btn-toggle-referencias');
                if (btnToggleRefs) {
                    btnToggleRefs.addEventListener('click', function() {
                        const card = document.getElementById('card-referencias');
                        const btn = document.getElementById('btn-toggle-referencias');
                        
                        if (card.style.display === 'none') {
                            card.style.display = 'block';
                            btn.innerHTML = '<i class="fas fa-minus-circle me-2"></i>Ocultar Referencias';
                            btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                        } else {
                            card.style.display = 'none';
                            btn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Agregar Referencias (Opcional)';
                            btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        }
                    });
                }
                
                // Botón agregar referencia inline
                const btnAgregarRefInline = document.getElementById('btn-agregar-ref-inline');
                if (btnAgregarRefInline) {
                    btnAgregarRefInline.addEventListener('click', function() {
                        const tipo = document.getElementById('tipo-referencia-inline').value;
                        const folio = document.getElementById('folio-referencia-inline').value;
                        const fecha = document.getElementById('fecha-referencia-inline').value;
                        const razon = document.getElementById('razon-referencia-inline').value;
                        
                        if (!tipo || !folio || !fecha) {
                            Swal.showValidationMessage('Complete los campos obligatorios (Tipo, Folio, Fecha)');
                            return;
                        }
                        
                        // Obtener texto del tipo
                        const selectElement = document.getElementById('tipo-referencia-inline');
                        const tipoTexto = selectElement.selectedOptions[0].text;
                        
                        // Agregar referencia
                        window.referencias.push({
                            tipo: tipo,
                            tipo_texto: tipoTexto,
                            folio: folio,
                            fecha: fecha,
                            razon: razon || '-'
                        });
                        
                        // Actualizar lista visual
                        actualizarListaReferencias();
                        
                        // Limpiar formulario
                        document.getElementById('tipo-referencia-inline').value = '';
                        document.getElementById('folio-referencia-inline').value = '';
                        document.getElementById('fecha-referencia-inline').value = '';
                        document.getElementById('razon-referencia-inline').value = '';
                        
                        // Actualizar contador
                        document.getElementById('contador-refs-inline').textContent = window.referencias.length;
                    });
                }
            },
            preConfirm: () => {
                // Usar variable global como respaldo si el campo se pierde
                let tipoDocumento = document.getElementById('tipo-documento').value;
                if (!tipoDocumento && window.tipoDocumentoSeleccionado) {
                    tipoDocumento = window.tipoDocumentoSeleccionado;
                    console.log('[VALIDACION] Usando tipo documento de variable global:', tipoDocumento);
                }
                
                const rutCliente = document.getElementById('busqueda-cliente').value;
                const tipoDespacho = document.getElementById('tipo-despacho').value;
                
                console.log('[VALIDACION] Tipo documento:', tipoDocumento);
                console.log('[VALIDACION] RUT cliente:', rutCliente);
                console.log('[VALIDACION] Cliente seleccionado:', window.clienteSeleccionado);
                
                // Validación específica para cada campo
                if (!tipoDocumento) {
                    console.error('[VALIDACION] Tipo documento vacio!');
                    Swal.showValidationMessage('Debe seleccionar un tipo de documento');
                    return false;
                }
                
                if (!rutCliente) {
                    Swal.showValidationMessage('Debe buscar un cliente');
                    return false;
                }
                
                if (!window.clienteSeleccionado) {
                    Swal.showValidationMessage('Debe seleccionar un cliente de la lista');
                    return false;
                }
                
                // Validar tipo de despacho si es guía
                if (tipoDocumento === 'guia' && !tipoDespacho) {
                    Swal.showValidationMessage('Debe seleccionar el motivo de traslado para guías de despacho');
                    return false;
                }
                
                return {
                    tipo_documento: tipoDocumento,
                    rut_cliente: rutCliente,
                    cliente_id: window.clienteSeleccionado.id,
                    tipo_despacho: tipoDespacho || null,
                    referencias: window.referencias || []
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Procesar con vendedor actual del POS
                // El vendedor se puede cambiar luego en la pantalla de pago si es necesario
                const datosCompletos = {
                    ...result.value,
                    vendedor_id: window.currentVendedorId || null,
                    vehiculo_id: null,
                    chofer_id: null
                };
                processPreventaWithData(datosCompletos);
            }
        });
    }
    
    // Validar RUT chileno
    function validarRUT(rut) {
        // Limpiar RUT
        rut = rut.replace(/[^0-9kK]/g, '');
        
        if (rut.length < 8) return false;
        
        const dv = rut.slice(-1).toUpperCase();
        const numero = rut.slice(0, -1);
        
        let suma = 0;
        let multiplicador = 2;
        
        for (let i = numero.length - 1; i >= 0; i--) {
            suma += parseInt(numero.charAt(i)) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }
        
        const resto = suma % 11;
        const dvCalculado = resto < 2 ? resto : 11 - resto;
        const dvEsperado = dv === 'K' ? 10 : parseInt(dv);
        
        return dvCalculado === dvEsperado;
    }
    
    // Formatear RUT
    function formatearRUT(rut) {
        rut = rut.replace(/[^0-9kK]/g, '');
        if (rut.length < 8) return rut;
        
        const numero = rut.slice(0, -1);
        const dv = rut.slice(-1).toUpperCase();
        
        return numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
    }
    
    // Buscar cliente por RUT o nombre
    function buscarCliente() {
        const busqueda = document.getElementById('busqueda-cliente').value.trim();
        
        if (!busqueda) {
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('cliente-info').style.display = 'none';
            document.getElementById('cliente-no-encontrado').style.display = 'none';
            return;
        }
        
        // Limpiar resultados anteriores
        document.getElementById('lista-clientes').innerHTML = '';
        document.getElementById('resultados-busqueda').style.display = 'block';
        document.getElementById('cliente-info').style.display = 'none';
        document.getElementById('cliente-no-encontrado').style.display = 'none';
    
    // Mostrar loading
        document.getElementById('lista-clientes').innerHTML = '<div class="list-group-item text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
        
        fetch(`/ventas/pos/buscar-cliente/?q=${encodeURIComponent(busqueda)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.clientes && data.clientes.length > 0) {
                    // Mostrar lista de clientes encontrados
                    let html = '';
                    data.clientes.forEach(cliente => {
                        const rutDisplay = cliente.rut || cliente.rut_formatted || 'Sin RUT';
                        html += `
                            <div class="list-group-item list-group-item-action" onclick="seleccionarCliente('${cliente.id}', '${cliente.nombre.replace(/'/g, "\\'")}', '${rutDisplay.replace(/'/g, "\\'")}', '${(cliente.direccion || '').replace(/'/g, "\\'")}')">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${cliente.nombre}</h6>
                                    <small>${rutDisplay}</small>
                                </div>
                                <p class="mb-1">${cliente.direccion || 'Sin dirección'}</p>
                            </div>
                        `;
                    });
                    document.getElementById('lista-clientes').innerHTML = html;
                } else {
                    // No se encontraron clientes
                    document.getElementById('resultados-busqueda').style.display = 'none';
                    document.getElementById('cliente-no-encontrado').style.display = 'block';
                    window.clienteSeleccionado = null;
                }
            })
            .catch(error => {
                console.error('Error al buscar cliente:', error);
                document.getElementById('resultados-busqueda').style.display = 'none';
                document.getElementById('cliente-no-encontrado').style.display = 'block';
                window.clienteSeleccionado = null;
            });
    }
    
    
    // Crear cliente
    function crearCliente() {
        // Verificar que Swal existe
        if (typeof Swal === 'undefined') {
            console.error('ERROR: SweetAlert2 no está cargado');
            return;
        }
        
        const rut = document.getElementById('busqueda-cliente').value;
        const tipoDocumento = document.getElementById('tipo-documento').value;
        
        // Si es boleta, usar cliente automático
        if (tipoDocumento === 'boleta') {
            crearClienteBoleta();
            return;
        }
        // Para otros tipos, mostrar formulario de creación
    Swal.fire({
            title: '<i class="fas fa-user-plus me-2"></i>Crear Nuevo Cliente',
            html: `
                <style>
                    .swal2-popup {
                        border-radius: 15px;
                        font-family: 'Poppins', sans-serif;
                    }
                    .swal2-title {
                        color: #6F5B44;
                        font-weight: 600;
                        font-size: 1.5rem;
                        padding: 1rem 0 0.5rem 0;
                    }
                    .swal2-html-container {
                        padding: 0 2rem 1rem 2rem;
                    }
                    .form-label-terroso {
                        font-weight: 600;
                        color: #6F5B44;
                        font-size: 0.9rem;
                        margin-bottom: 0.3rem;
                        display: block;
                        text-align: left;
                    }
                    .form-control-terroso {
                        border: 2px solid #D4C4A8;
                        border-radius: 8px;
                        padding: 0.5rem 0.75rem;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                    }
                    .form-control-terroso:focus {
                        border-color: #8B7355;
                        box-shadow: 0 0 0 0.2rem rgba(139, 115, 85, 0.25);
                        outline: none;
                    }
                    .campo-requerido::after {
                        content: " *";
                        color: #dc3545;
                    }
                    .info-box {
                        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
                        border-left: 4px solid #8B7355;
                        padding: 0.75rem;
                        border-radius: 8px;
                        margin-bottom: 1rem;
                        text-align: left;
                    }
                    .info-box i {
                        color: #8B7355;
                        margin-right: 0.5rem;
                    }
                    .info-box p {
                        margin: 0;
                        color: #6F5B44;
                        font-size: 0.85rem;
                    }
                </style>
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong style="color: #6F5B44;">Importante:</strong>
                    <p>Complete los datos del cliente. Los campos marcados con (*) son obligatorios.</p>
                </div>
                <div class="mb-3">
                    <label class="form-label-terroso campo-requerido">RUT</label>
                    <input type="text" id="nuevo-rut" class="form-control form-control-terroso" value="${rut}" placeholder="12.345.678-9">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso campo-requerido">Nombre</label>
                        <input type="text" id="nuevo-nombre" class="form-control form-control-terroso" placeholder="Nombre del cliente" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso campo-requerido">Giro</label>
                        <input type="text" id="nuevo-giro" class="form-control form-control-terroso" placeholder="Giro comercial" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label-terroso">Dirección</label>
                    <input type="text" id="nueva-direccion" class="form-control form-control-terroso" placeholder="Calle y número">
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso campo-requerido">Comuna</label>
                        <input type="text" id="nueva-comuna" class="form-control form-control-terroso" placeholder="Comuna" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso campo-requerido">Ciudad</label>
                        <input type="text" id="nueva-ciudad" class="form-control form-control-terroso" placeholder="Ciudad" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso">Región</label>
                        <input type="text" id="nueva-region" class="form-control form-control-terroso" placeholder="Región">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso">Teléfono</label>
                        <input type="text" id="nuevo-telefono" class="form-control form-control-terroso" placeholder="+56 9 1234 5678">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso">Email</label>
                        <input type="email" id="nuevo-email" class="form-control form-control-terroso" placeholder="correo@ejemplo.com">
                    </div>
                </div>
            `,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-save me-2"></i>Crear Cliente',
            cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
            confirmButtonColor: '#8B7355',
            cancelButtonColor: '#6c757d',
            customClass: {
                confirmButton: 'btn btn-lg',
                cancelButton: 'btn btn-lg'
            },
            buttonsStyling: true,
            preConfirm: () => {
                const rutInput = document.getElementById('nuevo-rut').value.trim();
                const nombre = document.getElementById('nuevo-nombre').value.trim();
                const giro = document.getElementById('nuevo-giro').value.trim();
                const direccion = document.getElementById('nueva-direccion').value.trim();
                const comuna = document.getElementById('nueva-comuna').value.trim();
                const ciudad = document.getElementById('nueva-ciudad').value.trim();
                const region = document.getElementById('nueva-region').value.trim();
                const telefono = document.getElementById('nuevo-telefono').value.trim();
                const email = document.getElementById('nuevo-email').value.trim();
                
                if (!rutInput) {
                    Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El RUT es requerido');
                    return false;
                }
                if (!nombre) {
                    Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El nombre es requerido');
                    return false;
                }
                if (!giro) {
                    Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El giro es requerido');
                    return false;
                }
                if (!comuna) {
                    Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>La comuna es requerida');
                    return false;
                }
                if (!ciudad) {
                    Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>La ciudad es requerida');
                    return false;
                }
                
                return {
                    rut: rutInput,
                    nombre: nombre,
                    giro: giro,
                    direccion: direccion,
                    comuna: comuna,
                    ciudad: ciudad,
                    region: region,
                    telefono: telefono,
                    email: email
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                crearClienteNuevo(result.value);
            }
        });
    }
    
    // Crear cliente automático para boletas
    function crearClienteBoleta() {
        const data = {
            items: cart.map(item => ({
                articuloId: item.articuloId,
                cantidad: item.cantidad,
                precio: item.precio,
                descuento: item.descuento
            })),
            descuento_total_pct: document.getElementById('descuento-total-input') ? document.getElementById('descuento-total-input').value : 0
        };
        
        fetch('/ventas/pos/crear-cliente-boleta/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('No tienes permisos para crear clientes. Contacta al administrador.');
                }
                throw new Error('Error en el servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar información del cliente creado
                document.getElementById('cliente-nombre').textContent = data.cliente.nombre;
                document.getElementById('cliente-direccion').textContent = data.cliente.direccion;
                document.getElementById('cliente-info').style.display = 'block';
                document.getElementById('cliente-no-encontrado').style.display = 'none';
                window.clienteSeleccionado = data.cliente;
                
                // Mostrar cliente en header
                const clienteHeader = document.getElementById('clienteEnHeader');
                if (clienteHeader) {
                    clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${data.cliente.nombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                }
                
                Swal.fire({
                    icon: 'success',
                    title: 'Cliente Creado',
                    text: 'Cliente automático para boletas creado exitosamente',
                    timer: 2000
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al crear cliente',
                    timer: 3000
                });
            }
        })
        .catch(error => {
            console.error('Error al crear cliente boleta:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Error al crear cliente de boleta. Intenta nuevamente.',
                timer: 3000
            });
        });
    }
    
    // Crear cliente nuevo
    function crearClienteNuevo(datos) {
        console.log('=== CREAR CLIENTE NUEVO ===');
        console.log('Datos enviados:', datos);
        
        fetch('/ventas/pos/crear-cliente/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(datos)
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('PERMISO DENEGADO: No tienes permisos para crear clientes. Contacta al administrador del sistema.');
                }
                return response.text().then(text => {
                    console.error('Error response text:', text);
                    throw new Error(`ERROR DEL SERVIDOR (${response.status}): ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('=== RESPUESTA DEL SERVIDOR ===');
            console.log('Data completa:', data);
            console.log('Success:', data.success);
            console.log('Cliente:', data.cliente);
            console.log('Message:', data.message);
            
            if (data.success) {
                console.log('✓ Cliente creado exitosamente');
                
                // Guardar cliente seleccionado globalmente
                window.clienteSeleccionado = data.cliente;
                console.log('✓ Cliente guardado en window.clienteSeleccionado:', window.clienteSeleccionado);
                
                // Mostrar cliente en header
                const clienteHeader = document.getElementById('clienteEnHeader');
                if (clienteHeader) {
                    clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${data.cliente.nombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                }
                
                // Mostrar mensaje de éxito y luego reabrir el modal de procesar preventa
                Swal.fire({
                    icon: 'success',
                    title: '✓ Cliente Creado Exitosamente',
                    html: `
                        <div style="text-align: left; padding: 1rem;">
                            <p><strong>RUT:</strong> ${data.cliente.rut}</p>
                            <p><strong>Nombre:</strong> ${data.cliente.nombre}</p>
                            <p><strong>Dirección:</strong> ${data.cliente.direccion || 'Sin dirección'}</p>
                        </div>
                        <hr>
                        <p style="text-align: center; color: #666; font-size: 0.9rem;">
                            El cliente ha sido seleccionado automáticamente.<br>
                            Ahora puedes procesar la preventa.
                        </p>
                    `,
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: true,
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#8B7355'
                }).then(() => {
                    // Reabrir el modal de procesar preventa con el cliente ya seleccionado
                    console.log('✓ Reabriendo modal de procesar preventa');
                    procesarPreventa();
                });
            } else {
                console.error('✗ ERROR: data.success = false');
                console.error('Mensaje de error:', data.message);
                
                Swal.fire({
                    icon: 'error',
                    title: '✗ Error al Crear Cliente',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Mensaje:</strong> ${data.message || 'Error desconocido'}</p>
                            <p style="font-size: 0.85rem; color: #666;">
                                Revisa la consola del navegador (F12) para más detalles.
                            </p>
                        </div>
                    `,
                    timer: 5000,
                    timerProgressBar: true
                });
            }
        })
        .catch(error => {
            console.error('=== ERROR CAPTURADO ===');
            console.error('Error completo:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            Swal.fire({
                icon: 'error',
                title: '✗ Error de Conexión',
                html: `
                    <div style="text-align: left;">
                        <p><strong>Error:</strong> ${error.message}</p>
                        <hr>
                        <p style="font-size: 0.85rem; color: #666;">
                            <strong>Detalles técnicos:</strong><br>
                            Abre la consola del navegador (F12 → Consola) para ver información detallada del error.
                        </p>
                    </div>
                `,
                timer: 8000,
                timerProgressBar: true,
                showConfirmButton: true,
                confirmButtonText: 'Entendido'
            });
        });
    }
    
    // Procesar preventa con datos
    function processPreventaWithData(data) {
        if (!window.clienteSeleccionado) {
            Swal.fire({
                icon: 'error',
                title: 'Cliente Requerido',
                text: 'Debe seleccionar o crear un cliente',
                timer: 3000
            });
            return;
        }
        
        // Calcular totales actuales
        let subtotal = 0;
        let descuento = 0;
        let neto = 0;
        let iva = 0;
        let impuestoEspecifico = 0;
        
        cart.forEach(item => {
            const precioFinal = parseFloat(item.precio);
            const precioNeto = parseFloat(item.precio_neto || 0);
            const ivaItem = parseFloat(item.iva || 0);
            const impEspItem = parseFloat(item.impuesto_especifico || 0);
            
            subtotal += precioFinal * parseFloat(item.cantidad);
            neto += precioNeto * parseFloat(item.cantidad);
            iva += ivaItem * parseFloat(item.cantidad);
            impuestoEspecifico += impEspItem * parseFloat(item.cantidad);
        });
        
        const total = subtotal;
        
        const preventaData = {
            estacion_id: window.currentEstacionId,
            vendedor_id: window.currentVendedorId,
            tipo_documento: data.tipo_documento,
            tipo_documento_planeado: data.tipo_documento, // ← GUARDAR TIPO PLANEADO
            cliente_id: window.clienteSeleccionado.id,
            items: cart,
            totales: {
                subtotal: subtotal,
                descuento: descuento,
                neto: neto,
                iva: iva,
                impuesto_especifico: impuestoEspecifico,
                total: total
            }
        };
        
        console.log('=== DATOS QUE SE ENVÍAN AL SERVIDOR ===');
        console.log('Items del carrito:', cart);
        console.log('Totales:', preventaData.totales);
        console.log('========================================');
    
    // Mostrar loading
    Swal.fire({
            title: 'Procesando Preventa...',
            text: 'Generando preventa',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
        // Enviar datos
        fetch('/ventas/pos/procesar-preventa/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(preventaData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Si es cotización, abrir ventana de impresión
                if (data.tipo_documento === 'cotizacion') {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Cotización Generada!',
                        text: `Cotización #${data.numero_preventa} generada exitosamente`,
                        timer: 2000
                    }).then(() => {
                        // Abrir ventana de impresión de la cotización
                        window.open(`/ventas/cotizaciones/${data.preventa_id}/html/`, '_blank');
                        
                        // Limpiar carrito y recargar
                        cart = [];
                        updateCartDisplay();
                        updateTotals();
                        limpiarClientePOS();
                        
                        // Actualizar stock después de la venta
                        updateStockFromServer();
                        
                        // Restaurar modo escaneo si estaba activo
                        if (wasScanningMode) {
                            setTimeout(() => {
                                barcodeMode = true;
                                const barcodeInput = document.getElementById('barcode-input');
                                if (barcodeInput) {
                                    barcodeInput.focus();
                                }
                            }, 2000);
                        }
                    });
                } else if (data.tipo_documento === 'vale') {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Vale Generado!',
                        text: `Vale #${data.numero_preventa} generado exitosamente`,
                        timer: 2000
                    }).then(() => {
                        // Abrir ventana de impresión del vale
                        window.open(`/ventas/vales/${data.preventa_id}/html/`, '_blank');
                        
                        // Limpiar carrito y recargar
                        cart = [];
                        updateCartDisplay();
                        updateTotals();
                        limpiarClientePOS();
                        
                        // Actualizar stock después de la venta
                        updateStockFromServer();
                        
                        // Restaurar modo escaneo si estaba activo
                        if (wasScanningMode) {
                            setTimeout(() => {
                                barcodeMode = true;
                                const barcodeInput = document.getElementById('barcode-input');
                                if (barcodeInput) {
                                    barcodeInput.focus();
                                }
                            }, 2000);
                        }
                    });
                } else if (data.tipo_documento === 'factura' || data.tipo_documento === 'boleta' || data.tipo_documento === 'guia') {
                    // Para factura, boleta o guía
                    const nombreDocumento = data.tipo_documento === 'factura' ? 'Factura' : 
                                          data.tipo_documento === 'boleta' ? 'Boleta' : 'Guía de Despacho';
                    
                    // CIERRE DIRECTO: Si se procesó automáticamente, abrir documento directamente
                    if (data.cierre_directo) {
                        console.log('[CIERRE DIRECTO] Abriendo documento automaticamente');
                        
                        Swal.fire({
                            icon: 'success',
                            title: '¡Documento Procesado!',
                            html: `<strong>${nombreDocumento} #${data.numero_venta}</strong><br>procesada automáticamente con cierre directo`,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            // Abrir documento para impresión
                            window.open(data.doc_url + '?auto=1', '_blank');
                            
                            // Limpiar carrito
                            cart = [];
                            updateCartDisplay();
                            updateTotals();
                            limpiarClientePOS();
                            
                            // Actualizar stock
                            updateStockFromServer();
                            
                            // Restaurar modo escaneo si estaba activo
                            if (wasScanningMode) {
                                setTimeout(() => {
                                    barcodeMode = true;
                                    const barcodeInput = document.getElementById('barcode-input');
                                    if (barcodeInput) {
                                        barcodeInput.focus();
                                    }
                                }, 2000);
                            }
                        });
                        return;
                    }
                    
                    // Sin cierre directo: redirigir a procesar venta normal
                    if (data.ticket_vale_id) {
                        // Redirigir a Caja para procesar el ticket facturable
                        window.location.href = `/caja/procesar-venta/${data.ticket_vale_id}/`;
                        return;
                    } else {
                        // Si por algún motivo no hay ticket, mostrar alerta informativa
                        Swal.fire({
                            icon: 'warning',
                            title: `Preventa ${nombreDocumento} #${data.numero_preventa} generada`,
                            text: 'No se recibió el identificador del ticket facturable. Por favor procese desde Caja > Procesar Venta.',
                            timer: 3000
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Preventa Procesada!',
                        text: `Preventa ${data.tipo_documento} #${data.numero_preventa} generada exitosamente`,
                        timer: 3000
                    }).then(() => {
                        // Limpiar carrito y recargar
                        cart = [];
                        updateCartDisplay();
                        updateTotals();
                        limpiarClientePOS();
                        
                        // Actualizar stock después de la venta
                        updateStockFromServer();
                        
                        // Restaurar modo escaneo si estaba activo
                        if (wasScanningMode) {
                            setTimeout(() => {
                                barcodeMode = true;
                                const barcodeInput = document.getElementById('barcode-input');
                                if (barcodeInput) {
                                    barcodeInput.focus();
                                }
                            }, 2000);
                        }
                    });
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al procesar la preventa',
                    timer: 3000
                });
            }
        })
        .catch(error => {
            console.error('Error al procesar preventa:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Error al procesar la preventa: ${error.message}`,
                timer: 3000
            });
        });
}

// Event listener para el botón de crear cliente
document.addEventListener('click', function(e) {
    // Verificar si el click fue en el botón o en algún elemento hijo (como el ícono)
    const btnCrearCliente = e.target.closest('#btn-crear-cliente');
    if (btnCrearCliente) {
        e.preventDefault();
        e.stopPropagation();
        crearCliente();
    }
});

// Cerrar función DOMContentLoaded
console.log('*** DOMContentLoaded FINALIZADO ***');
});

// ===== FUNCIONES AUXILIARES =====

function limpiarClientePOS() {
    try {
        const rutInput = document.getElementById('busqueda-cliente');
        if (rutInput) { rutInput.value = ''; }
        window.clienteSeleccionado = null;
        const resultados = document.getElementById('resultados-busqueda');
        if (resultados) { resultados.style.display = 'none'; }
        const info = document.getElementById('cliente-info');
        if (info) { info.style.display = 'none'; }
        const noEncontrado = document.getElementById('cliente-no-encontrado');
        if (noEncontrado) { noEncontrado.style.display = 'none'; }
        const header = document.getElementById('clienteEnHeader');
        if (header) { header.innerHTML = ''; }
    } catch (e) { console.error(e); }
}

// Cargar artículos desde el DOM
function loadArticulosFromDOM() {
    console.log('*** CARGANDO ARTÍCULOS DESDE DOM ***');
    
    const productCards = document.querySelectorAll('.pos-product-card');
    articulos = [];
    
    productCards.forEach(card => {
        const articulo = {
            id: parseInt(card.dataset.articuloId),
            nombre: card.querySelector('.pos-product-name').textContent.trim(),
            precio: parseFloat(card.dataset.precio),
            stock: parseInt(card.dataset.stock),
            categoria: card.dataset.categoria
        };
        articulos.push(articulo);
    });
    
    window.articulos = articulos;
    console.log('*** ARTÍCULOS CARGADOS: ', articulos.length, ' ***');
    
    // Actualizar stock en tiempo real
    updateStockFromServer();
}

// Función para actualizar stock desde servidor
function updateStockFromServer() {
    console.log('*** ACTUALIZANDO STOCK DESDE SERVIDOR ***');
    
    // Obtener IDs de artículos
    const articuloIds = articulos.map(a => a.id);
    
    if (articuloIds.length === 0) return;
    
    // Hacer petición AJAX para obtener stock actual
    fetch('/articulos/stock-actual/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            articulo_ids: articuloIds
        })
    })
    .then(response => {
        console.log('*** RESPUESTA STOCK: ', response.status, ' ***');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('*** DATOS STOCK RECIBIDOS: ', data, ' ***');
        
        if (data.success && data.stocks) {
            console.log('*** STOCK ACTUALIZADO: ', data.stocks, ' ***');
            
            // Actualizar cada tarjeta de producto
            document.querySelectorAll('.pos-product-card').forEach(card => {
                const articuloId = parseInt(card.dataset.articuloId);
                const stockActual = data.stocks[articuloId] || 0;
                
                console.log(`*** ACTUALIZANDO ARTÍCULO ${articuloId}: stock ${stockActual} ***`);
                
                // Actualizar data-stock
                card.dataset.stock = stockActual;
                
                // Actualizar display de stock
                const stockElement = card.querySelector('.pos-product-stock');
                if (stockElement) {
                    stockElement.textContent = `Stock: ${stockActual}`;
                    stockElement.className = `pos-product-stock ${stockActual <= 0 ? 'text-danger' : ''}`;
                }
                
                // Actualizar clase disabled
                if (stockActual <= 0) {
                    card.classList.add('disabled');
                    console.log(`*** ARTÍCULO ${articuloId} DESHABILITADO (sin stock) ***`);
                } else {
                    card.classList.remove('disabled');
                    console.log(`*** ARTÍCULO ${articuloId} HABILITADO (con stock: ${stockActual}) ***`);
                }
                
                // Actualizar array de artículos
                const articulo = articulos.find(a => a.id === articuloId);
                if (articulo) {
                    articulo.stock = stockActual;
                }
            });
            
            console.log('*** STOCK VISUALIZACIÓN ACTUALIZADA ***');
        } else {
            console.log('*** ERROR AL ACTUALIZAR STOCK: ', data.message || data.error, ' ***');
        }
    })
    .catch(error => {
        console.error('*** ERROR AL ACTUALIZAR STOCK: ', error.message || error, ' ***');
    });
}

// ===== SISTEMA DE CÓDIGOS DE BARRAS =====

// Variables globales para códigos de barras
let barcodeTimeout;
let isScanning = false;
let barcodeMode = true; // Por defecto activado para escaneo continuo
let lastProcessedCode = ''; // Para evitar procesar el mismo código repetidamente
let lastProcessedTime = 0; // Timestamp del último procesamiento

// Configurar el sistema de códigos de barras
function setupBarcodeSystem() {
    console.log('*** CONFIGURANDO SISTEMA DE CÓDIGOS DE BARRAS ***');
    
    const barcodeInput = document.getElementById('barcode-input');
    const barcodeStatus = document.getElementById('barcode-status');
    
    // Mantener el foco siempre en el campo de código de barras
    function focusBarcodeInput() {
        barcodeInput.focus();
        console.log('*** FOCO EN CÓDIGO DE BARRAS ***');
    }
    
    // Event listener para detección de escaneo
    barcodeInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        
        // Limpiar timeout anterior
        if (barcodeTimeout) {
            clearTimeout(barcodeTimeout);
            console.log('*** TIMEOUT ANTERIOR LIMPIADO ***');
        }
        
        // Solo procesar si el valor tiene al menos 8 caracteres (código de barras mínimo)
        if (value.length >= 8) {
            console.log('*** ENTRADA DETECTADA: ' + value + ' ***');
            
            // Cambiar estado a "escaneando"
            setBarcodeStatus('scanning', 'Escaneando...', 'fas fa-spinner fa-spin');
            
            // Esperar un poco más para capturar todo el código
            barcodeTimeout = setTimeout(() => {
                console.log('*** EJECUTANDO TIMEOUT PARA: ' + value + ' ***');
                processBarcode(value);
            }, 300); // Aumentar tiempo para evitar duplicados
        }
    });
    
    // Event listener para Enter (manualmente escrito)
    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value.length >= 4) { // Mínimo 4 caracteres para procesar manualmente
                processBarcode(value);
            }
        }
    });
    
    // Establecer foco inicial para escaneo
    focusBarcodeInput();
    
    // Mantener foco después de buscar productos
    // Mantener foco siempre en el campo de código de barras
    barcodeInput.addEventListener('blur', function() {
        // Solo restaurar foco si no se está interactuando con otros elementos
        setTimeout(() => {
            const activeElement = document.activeElement;
            const isInteractingWithForm = activeElement && (
                activeElement.tagName === 'SELECT' ||
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.closest('.swal2-container') ||
                activeElement.closest('#tipo-documento') ||
                activeElement.closest('#estacion-trabajo') ||
                activeElement.closest('#busqueda-cliente')
            );
            
            if (!isInteractingWithForm && barcodeMode) {
                focusBarcodeInput();
                console.log('*** FOCO RESTAURADO DESPUÉS DE BLUR ***');
            }
        }, 500); // Aumentar delay para permitir interacción completa
    });
    
    // No modificar processSale si no existe aún
    // Se manejará después de que se defina
    
    console.log('*** SISTEMA DE CÓDIGOS DE BARRAS CONFIGURADO ***');
    
    // Configurar funciones después de que estén definidas
    setTimeout(() => {
        setupBarcodeSystemLate();
    }, 1000);
    
    // Event listener global para restaurar foco después de cualquier interacción
    document.addEventListener('click', function(e) {
        // Excluir botones de cerrar documento y otros botones críticos
        const isExcludedElement = e.target.closest('#btn-cerrar-documento') || 
                                  e.target.closest('.btn-cerrar') ||
                                  e.target.closest('#btn-clear') ||
                                  e.target.closest('#btn-process') ||
                                  e.target.closest('#tipo-documento') ||
                                  e.target.closest('#estacion-trabajo') ||
                                  e.target.closest('#busqueda-cliente') ||
                                  e.target.closest('.form-control') ||
                                  e.target.closest('.form-select') ||
                                  e.target.closest('select') ||
                                  e.target.closest('input[type="text"]') ||
                                  e.target.closest('input[type="number"]') ||
                                  e.target.closest('input[type="email"]') ||
                                  e.target.closest('textarea') ||
                                  e.target.closest('.swal2-container') ||
                                  e.target.closest('.swal2-popup') ||
                                  e.target.closest('button[onclick*="cerrar"]') ||
                                  e.target.closest('button[onclick*="limpiar"]') ||
                                  e.target.closest('button[onclick*="clearCart"]') ||
                                  e.target.closest('button[onclick*="processSale"]') ||
                                  e.target.closest('.btn-danger') ||
                                  e.target.closest('.btn-warning');
        
        // Solo restaurar foco para productos específicamente
        if (!isExcludedElement && e.target.closest('.pos-product-card')) {
            setTimeout(() => {
                const barcodeInput = document.getElementById('barcode-input');
                if (barcodeInput && !barcodeInput.disabled && barcodeMode) {
                    barcodeInput.focus();
                    console.log('*** FOCO RESTAURADO DESPUÉS DE CLICK EN PRODUCTO ***');
                }
            }, 300);
        }
    });
}

// Configurar funciones tardías del sistema de códigos de barras
function setupBarcodeSystemLate() {
    console.log('*** CONFIGURANDO FUNCIONES TARDÍAS ***');
    
    // Modificar processSale si existe
    if (typeof processSale === 'function') {
        const originalProcessSale = processSale;
        window.processSale = function() {
            const result = originalProcessSale();
            // Solo restaurar foco después de una venta exitosa si el modo está activado
            if (barcodeMode) {
                setTimeout(() => {
                    if (document.activeElement === document.body) {
                        document.getElementById('barcode-input').focus();
                    }
                }, 500);
            }
            return result;
        };
        console.log('*** PROCESSSALE CONFIGURADO ***');
    }
    
    // Modificar updateCartDisplay si existe
    if (typeof updateCartDisplay === 'function') {
        const originalUpdateCartDisplay = updateCartDisplay;
        window.updateCartDisplay = function() {
            originalUpdateCartDisplay();
            // Restaurar foco si el modo está activado
            if (barcodeMode) {
                setTimeout(() => {
                    if (document.activeElement === document.body) {
                        document.getElementById('barcode-input').focus();
                    }
                }, 100);
            }
        };
        console.log('*** UPDATECARTDISPLAY CONFIGURADO ***');
    }
}

// Procesar el código de barras escaneado
async function processBarcode(codigo) {
    console.log('*** PROCESANDO CÓDIGO: ' + codigo + ' ***');
    console.log('*** isScanning actual: ' + isScanning + ' ***');
    
    // Verificar si ya se procesó este código recientemente (dentro de 2 segundos)
    const currentTime = Date.now();
    if (codigo === lastProcessedCode && (currentTime - lastProcessedTime) < 2000) {
        console.log('*** CÓDIGO YA PROCESADO RECIENTEMENTE - IGNORANDO ***');
        return;
    }
    
    if (isScanning) {
        console.log('*** YA SE ESTÁ PROCESANDO UN CÓDIGO - IGNORANDO ***');
        return;
    }
    
    isScanning = true;
    lastProcessedCode = codigo;
    lastProcessedTime = currentTime;
    console.log('*** MARCANDO COMO ESCANEANDO ***');
    setBarcodeStatus('scanning', 'Buscando producto...', 'fas fa-search');
    
    // Buscar artículo por código de barras
    fetch(`/articulos/buscar-por-codigo-barras/?codigo=${encodeURIComponent(codigo)}`)
        .then(response => response.json())
        .then(async data => {
            console.log('*** RESPUESTA BÚSQUEDA: ', data, ' ***');
            
            if (data.success && data.articulo) {
                console.log('*** PRODUCTO ENCONTRADO: ', data.articulo, ' ***');
                
                // Buscar el producto en la lista de productos del POS
                const productos = window.articulos || [];
                const producto = productos.find(p => p.id == data.articulo.id);
                
                // Si el producto está en la lista del POS, usar sus datos
                // Si no está, usar los datos del backend directamente
                const precio = producto ? producto.precio : parseFloat(data.articulo.precio_final || data.articulo.precio_venta || 0);
                const stock = producto ? producto.stock : 100; // Asumir stock disponible si no está en la lista
                const categoriaExentaIva = producto ? producto.categoria_exenta_iva : (data.articulo.categoria_exenta_iva || false);
                const impuestoEspecifico = producto ? producto.impuesto_especifico_porcentaje : (data.articulo.impuesto_especifico_porcentaje || 0);
                
                // Agregar al carrito con todos los parámetros necesarios
                console.log('*** LLAMANDO addToCart con parámetros:', {
                    id: data.articulo.id,
                    nombre: data.articulo.nombre,
                    precio: precio,
                    stock: stock,
                    categoriaExentaIva: categoriaExentaIva,
                    impuestoEspecifico: impuestoEspecifico
                });
                
                await addToCart(
                    data.articulo.id,
                    data.articulo.nombre,
                    precio,
                    stock,
                    categoriaExentaIva,
                    impuestoEspecifico
                );
                
                console.log('*** CARRITO DESPUÉS DE AGREGAR:', cart);
                
                setBarcodeStatus('ready', 'Producto agregado', 'fas fa-check-circle');
                
                // Limpiar el campo después de un breve delay
                setTimeout(() => {
                    clearBarcodeInput();
                    setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                }, 1000);
            } else {
                console.log('*** PRODUCTO NO ENCONTRADO ***');
                setBarcodeStatus('error', 'Producto no encontrado', 'fas fa-exclamation-triangle');
                setTimeout(() => {
                    clearBarcodeInput();
                    setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                    // Restaurar foco solo si no hay otra interacción
                    setTimeout(() => {
                        if (document.activeElement === document.body || 
                            document.activeElement === document.getElementById('barcode-input')) {
                            document.getElementById('barcode-input').focus();
                        }
                    }, 100);
                }, 2000);
            }
        })
        .catch(error => {
            console.error('*** ERROR AL BUSCAR: ', error, ' ***');
            setBarcodeStatus('error', 'Error de conexión', 'fas fa-exclamation-triangle');
            setTimeout(() => {
                clearBarcodeInput();
                setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                // Restaurar foco solo si no hay otra interacción
                setTimeout(() => {
                    if (document.activeElement === document.body || 
                        document.activeElement === document.getElementById('barcode-input')) {
                        document.getElementById('barcode-input').focus();
                    }
                }, 100);
            }, 2000);
        })
        .finally(() => {
            console.log('*** FINALIZANDO ESCANEO - RESETEANDO isScanning ***');
            isScanning = false;
        });
}

// Cambiar el estado visual del código de barras
function setBarcodeStatus(type, message, icon) {
    const status = document.getElementById('barcode-status');
    status.className = `pos-barcode-status ${type}`;
    status.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
}

// Limpiar el campo de código de barras
function clearBarcodeInput() {
    const input = document.getElementById('barcode-input');
    input.value = '';
    console.log('*** CAMPO DE CÓDIGO DE BARRAS LIMPIADO ***');
    
    // Solo hacer foco si el modo está activado
    if (barcodeMode) {
        setTimeout(() => {
            if (document.activeElement === document.body) {
                input.focus();
            }
        }, 100);
    }
}

// Alternar modo de escaneo
function toggleBarcodeMode() {
    barcodeMode = !barcodeMode;
    const barcodeInput = document.getElementById('barcode-input');
    const barcodeStatus = document.getElementById('barcode-status');
    const barcodeToggle = document.getElementById('barcode-toggle');
    
    if (barcodeMode) {
        // Activar modo escaneo
        barcodeInput.disabled = false;
        setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
        barcodeToggle.innerHTML = '<i class="fas fa-barcode"></i> Modo Escaneo';
        barcodeToggle.style.background = '#17a2b8';
        console.log('*** MODO ESCANEO ACTIVADO ***');
        // Solo hacer foco si no hay otra interacción
        setTimeout(() => {
            if (document.activeElement === document.body) {
                barcodeInput.focus();
            }
        }, 100);
    } else {
        // Desactivar modo escaneo
        barcodeInput.disabled = true;
        barcodeInput.blur();
        setBarcodeStatus('disabled', 'Modo escaneo desactivado', 'fas fa-ban');
        barcodeToggle.innerHTML = '<i class="fas fa-mouse-pointer"></i> Modo Manual';
        barcodeToggle.style.background = '#28a745';
        console.log('*** MODO ESCANEO DESACTIVADO ***');
    }
}

// Función global para agregar producto al carrito desde cualquier lugar
async function addToCartFromAnywhere(articuloId, nombre, precio, cantidad = 1, fromKit = false) {
    console.log('*** AGREGANDO AL CARRITO DESDE CUALQUIER LUGAR ***');
    if (fromKit) {
        console.log('*** ITEM MARCADO COMO DEL KIT (cantidad bloqueada) ***');
    }
    
    // Buscar el producto en la lista de productos para obtener información de categoría
    const productos = window.articulos || [];
    const producto = productos.find(p => p.id == articuloId);
    
    let categoriaExentaIva = false;
    let impuestoEspecifico = 0;
    let precioNeto = null;
    
    if (producto) {
        categoriaExentaIva = producto.categoria && producto.categoria.exenta_iva;
        impuestoEspecifico = producto.categoria && producto.categoria.impuesto_especifico ? 
                            parseFloat(producto.categoria.impuesto_especifico.get_porcentaje_decimal) : 0;
        
        // Calcular precio neto desde el precio proporcionado (que incluye IVA)
        // Si el precio fue ajustado proporcionalmente, calcular el neto correcto
        precioNeto = Math.round(precio / 1.19);
    }
    
    // Usar la función addToCart con toda la información
    await addToCart(articuloId, nombre, precio, 1000, categoriaExentaIva, impuestoEspecifico, precioNeto, fromKit);
    
    // Actualizar visualización
    if (typeof updateCartDisplay === 'function') {
        updateCartDisplay();
    } else {
        updateCartDisplayManual();
    }
    
    if (typeof updateTotals === 'function') {
        updateTotals();
    } else {
        updateTotalsManual();
    }
    
    // Restaurar foco en código de barras después de un breve delay
    setTimeout(() => {
        const barcodeInput = document.getElementById('barcode-input');
        if (barcodeInput) {
            barcodeInput.focus();
            console.log('*** FOCO RESTAURADO EN CÓDIGO DE BARRAS ***');
        }
    }, 100);
}

// FUNCIÓN DUPLICADA ELIMINADA - Se usa la función addToCart principal (línea 1057)
// que tiene la firma completa: addToCart(articuloId, nombre, precio, stock, categoriaExentaIva, impuestoEspecifico, precioNeto)

// Función manual para actualizar la visualización del carrito
function updateCartDisplayManual() {
    console.log('*** ACTUALIZANDO CARRITO MANUALMENTE ***');
    
    const cartContainer = document.getElementById('pos-cart-items');
    if (!cartContainer) {
        console.log('*** ERROR: No se encontró el contenedor del carrito ***');
        return;
    }
    
    // Limpiar el contenedor
    cartContainer.innerHTML = '';
    
    if (cart.length === 0) {
        cartContainer.innerHTML = '<div class="pos-cart-empty">No hay productos en el carrito</div>';
        return;
    }
    
    // Agregar cada item del carrito
    cart.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'pos-cart-item';
        itemDiv.innerHTML = `
            <div class="cart-item-name">${item.nombre}</div>
            <div class="cart-item-price">$${window.formatChileanNumber ? window.formatChileanNumber(item.precio) : Math.round(item.precio).toLocaleString('es-CL')}</div>
            <div class="cart-item-qty">
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                <span>${item.cantidad}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <div class="cart-item-discount">${item.descuento}%</div>
            <div class="cart-item-total">$${window.formatChileanNumber ? window.formatChileanNumber(item.total) : Math.round(item.total).toLocaleString('es-CL')}</div>
            <div class="cart-item-actions">
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        cartContainer.appendChild(itemDiv);
    });
    
    // Scroll automático al último item agregado
    setTimeout(() => {
        cartContainer.scrollTop = cartContainer.scrollHeight;
    }, 50);
    
    console.log('*** CARRITO VISUALIZADO MANUALMENTE ***');
}

// Función manual para actualizar los totales
function updateTotalsManual() {
    console.log('*** ACTUALIZANDO TOTALES MANUALMENTE ***');
    
    // Calcular totales
    let subtotal = 0;
    let descuento = 0;
    let neto = 0;
    let iva = 0;
    let impuestoEspecifico = 0;
    
    cart.forEach(item => {
        const precioFinal = parseFloat(item.precio);
        const precioNeto = parseFloat(item.precio_neto || 0);
        const ivaItem = parseFloat(item.iva || 0);
        const impEspItem = parseFloat(item.impuesto_especifico || 0);
        
        subtotal += precioFinal * parseFloat(item.cantidad);
        neto += precioNeto * parseFloat(item.cantidad);
        iva += ivaItem * parseFloat(item.cantidad);
        impuestoEspecifico += impEspItem * parseFloat(item.cantidad);
    });
    
    const total = subtotal;
    
    // Actualizar elementos en el DOM
    const updateElement = (id, value) => {
        const element = document.getElementById(id);
        if (element) {
            const formattedValue = window.formatChileanNumber ? window.formatChileanNumber(value) : Math.round(value).toLocaleString('es-CL');
            element.textContent = `$${formattedValue}`;
        } else {
            console.log(`*** ERROR: Elemento ${id} no encontrado ***`);
        }
    };
    
    updateElement('subtotal', subtotal);
    updateElement('descuento', descuento);
    updateElement('neto', neto);
    updateElement('iva', iva);
    updateElement('impuesto_especifico', impuestoEspecifico);
    updateElement('total', total);
    
    console.log('*** TOTALES ACTUALIZADOS MANUALMENTE ***');
    console.log('Subtotal:', subtotal);
    console.log('Total:', total);
}

// Función para actualizar cantidad de un item en el carrito
function updateQuantity(index, change) {
    if (cart[index]) {
        cart[index].cantidad += change;
        if (cart[index].cantidad <= 0) {
            cart.splice(index, 1);
        } else {
            cart[index].total = cart[index].precio * cart[index].cantidad;
            // Recalcular impuestos según la cantidad
            cart[index].precio_neto_total = cart[index].precio_neto * cart[index].cantidad;
            cart[index].iva_total = cart[index].iva * cart[index].cantidad;
            cart[index].impuesto_especifico_total = cart[index].impuesto_especifico * cart[index].cantidad;
        }
        
        // Actualizar visualización
        if (typeof updateCartDisplay === 'function') {
            updateCartDisplay();
        } else {
            updateCartDisplayManual();
        }
        
        if (typeof updateTotals === 'function') {
            updateTotals();
        } else {
            updateTotalsManual();
        }
    }
}

// Función para remover un item del carrito
function removeFromCart(index) {
    if (cart[index]) {
        cart.splice(index, 1);
        
        // Actualizar visualización
        if (typeof updateCartDisplay === 'function') {
            updateCartDisplay();
        } else {
            updateCartDisplayManual();
        }
        
        if (typeof updateTotals === 'function') {
            updateTotals();
        } else {
            updateTotalsManual();
        }
    }
}

// Función global para seleccionar cliente
function seleccionarCliente(id, nombre, rut, direccion) {
    // Limpiar datos
    id = String(id).trim().replace(/\s+/g, '');
    nombre = String(nombre).trim();
    rut = String(rut).trim();
    direccion = String(direccion).trim();
    
    console.log('=== SELECCIONANDO CLIENTE (BÚSQUEDA) ===');
    console.log('ID (limpio):', id, 'Tipo:', typeof id);
    console.log('Nombre:', nombre);
    console.log('RUT:', rut, 'Tipo:', typeof rut);
    console.log('Dirección:', direccion);
    
    // Ocultar resultados de búsqueda
    document.getElementById('resultados-busqueda').style.display = 'none';
    
    // Mostrar información del cliente seleccionado
    document.getElementById('cliente-nombre').textContent = nombre;
    document.getElementById('cliente-direccion').textContent = direccion || 'Sin dirección';
    document.getElementById('cliente-info').style.display = 'block';
    
    // Guardar cliente seleccionado
    window.clienteSeleccionado = {
        id: id,
        nombre: nombre,
        rut: rut,
        rut_formatted: rut,
        direccion: direccion
    };
    
    console.log('Cliente guardado en window.clienteSeleccionado:', window.clienteSeleccionado);
    
    // Mostrar cliente en header
    const clienteHeader = document.getElementById('clienteEnHeader');
    if (clienteHeader) {
        clienteHeader.innerHTML = `
            <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                <strong style="color: white; font-size: 0.95rem;">${nombre}</strong>
                <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-exchange-alt me-1"></i>Cambiar
                </button>
            </div>
        `;
    }
    
    // Actualizar el campo de búsqueda con el RUT
    document.getElementById('busqueda-cliente').value = rut;
}

// Función para mostrar historial de tickets del día
function mostrarHistorialTickets() {
    fetch('/ventas/pos/tickets-hoy/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.tickets.length > 0) {
            // Construir tabla HTML compacta y elegante
            let tablaHTML = `
                <style>
                    .historial-table {
                        width: 100%;
                        font-size: 0.75rem;
                        border-collapse: collapse;
                    }
                    .historial-table thead {
                        position: sticky;
                        top: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        z-index: 10;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .historial-table th {
                        padding: 0.35rem 0.5rem;
                        font-weight: 600;
                        font-size: 0.7rem;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        border: none;
                    }
                    .historial-table tbody tr {
                        border-bottom: 1px solid #f0f0f0;
                        transition: background 0.15s ease;
                    }
                    .historial-table tbody tr:hover {
                        background: #f8f9fa;
                    }
                    .historial-table td {
                        padding: 0.25rem 0.5rem;
                        vertical-align: middle;
                        border: none;
                        line-height: 1.3;
                    }
                    .ticket-hora {
                        color: #6c757d;
                        font-size: 0.7rem;
                        font-weight: 500;
                    }
                    .ticket-numero {
                        font-weight: 700;
                        color: #667eea;
                        font-size: 0.75rem;
                    }
                    .ticket-cliente {
                        color: #495057;
                        font-size: 0.72rem;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 200px;
                    }
                    .ticket-total {
                        font-weight: 700;
                        color: #28a745;
                        font-size: 0.8rem;
                    }
                    .btn-print-compact {
                        padding: 0.15rem 0.4rem;
                        font-size: 0.65rem;
                        border-radius: 3px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        color: white;
                        transition: all 0.15s ease;
                        text-decoration: none;
                        display: inline-block;
                    }
                    .btn-print-compact:hover {
                        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
                        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                        color: white;
                    }
                    .historial-container {
                        max-height: 550px;
                        overflow-y: auto;
                        border-radius: 6px;
                        box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
                    }
                    .historial-container::-webkit-scrollbar {
                        width: 8px;
                    }
                    .historial-container::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 4px;
                    }
                    .historial-container::-webkit-scrollbar-thumb {
                        background: #667eea;
                        border-radius: 4px;
                    }
                    .historial-container::-webkit-scrollbar-thumb:hover {
                        background: #764ba2;
                    }
                    .historial-footer {
                        margin-top: 0.75rem;
                        padding: 0.5rem;
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        border-radius: 4px;
                        font-weight: 600;
                        color: #495057;
                        font-size: 0.8rem;
                    }
                </style>
                <div class="historial-container">
                    <table class="historial-table">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Hora</th>
                                <th style="width: 11%;">Ticket</th>
                                <th style="width: 9%;">Doc.</th>
                                <th style="width: 32%;">Cliente</th>
                                <th style="width: 18%;">Total</th>
                                <th style="width: 20%; text-align: center;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.tickets.forEach(ticket => {
                const total = new Intl.NumberFormat('es-CL').format(Math.round(ticket.total));
                
                // Color del badge según tipo de documento
                const badgeColor = {
                    'BOL': '#17a2b8',
                    'FACT': '#28a745',
                    'GUÍA': '#ffc107',
                    'N/C': '#dc3545',
                    'N/D': '#fd7e14',
                    'COT': '#6f42c1',
                    'VALE': '#6c757d'
                };
                const color = badgeColor[ticket.tipo_documento] || '#6c757d';
                
                tablaHTML += `
                    <tr>
                        <td class="ticket-hora">${ticket.fecha}</td>
                        <td class="ticket-numero">#${ticket.numero}</td>
                        <td><span style="display: inline-block; padding: 0.15rem 0.35rem; background: ${color}; color: white; border-radius: 3px; font-size: 0.65rem; font-weight: 600;">${ticket.tipo_documento}</span></td>
                        <td class="ticket-cliente">${ticket.cliente}</td>
                        <td class="ticket-total">$${total}</td>
                        <td style="text-align: center;">
                            <a href="/ventas/vales/${ticket.id}/html/" target="_blank" class="btn btn-print-compact">
                                <i class="fas fa-print me-1"></i>Imprimir
                            </a>
                        </td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="historial-footer text-center">
                    <i class="fas fa-receipt me-2"></i>Total de tickets hoy: <span style="color: #667eea;">${data.total_count}</span>
                </div>
            `;
            
            Swal.fire({
                title: '<i class="fas fa-history me-2"></i>Historial de Tickets del Día',
                html: tablaHTML,
                width: '900px',
                showCancelButton: true,
                showConfirmButton: false,
                cancelButtonText: 'Cerrar',
                cancelButtonColor: '#6c757d',
                customClass: {
                    popup: 'swal-historial-popup'
                }
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Sin tickets',
                text: 'No hay tickets generados hoy',
                timer: 2000
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo cargar el historial de tickets',
            timer: 2000
        });
    });
}
</script>

<!-- Modal de Selección de Cliente (Modo Con Cliente) -->
{% if modo_pos == 'con_cliente' %}
<div class="modal fade" id="modalSeleccionCliente" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none;">
                <div>
                    <h5 class="modal-title text-white mb-1" style="font-weight: 600;">
                        <i class="fas fa-user-check me-2"></i>Seleccionar Cliente
                    </h5>
                    <small class="text-white-50">Seleccione el cliente para iniciar la venta</small>
                </div>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Buscador de Cliente y Botón Crear -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold mb-0" style="color: #6F5B44;">Buscar Cliente</label>
                        <a href="{% url 'clientes:cliente_create' %}" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 5px 12px; font-size: 0.8rem; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);">
                            <i class="fas fa-user-plus me-1"></i>Crear Cliente
                        </a>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text" style="background: #F5F1E8; border-color: #E8DCC8;">
                            <i class="fas fa-search" style="color: #8B7355;"></i>
                        </span>
                        <input type="text" id="buscarClienteInicio" class="form-control" placeholder="Buscar por RUT o Nombre..." style="border-color: #E8DCC8;">
                    </div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                        <i class="fas fa-info-circle me-1"></i>Después de crear el cliente, recargue esta página para verlo en la lista
                    </small>
                </div>
                
                <!-- Lista de Clientes (estilo tabla compacta) -->
                <div id="listaClientesInicio" style="max-height: 400px; overflow-y: auto; border: 1px solid #E8DCC8; border-radius: 8px;">
                    <table class="table table-hover mb-0" style="font-size: 0.85rem;">
                        <thead style="background: #F5F1E8; position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="padding: 8px 12px; font-weight: 600; color: #6F5B44; border-bottom: 2px solid #E8DCC8;">RUT</th>
                                <th style="padding: 8px 12px; font-weight: 600; color: #6F5B44; border-bottom: 2px solid #E8DCC8;">Cliente</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes %}
                            <tr class="cliente-item" data-cliente-id="{{ cliente.id }}" data-cliente-nombre="{{ cliente.nombre }}" data-cliente-rut="{{ cliente.rut|default:'' }}" data-cliente-direccion="{{ cliente.direccion|default:'' }}" style="cursor: pointer; transition: background 0.2s;">
                                <td style="padding: 10px 12px; color: #8B7355; font-weight: 500;">{{ cliente.rut|default:"Sin RUT" }}</td>
                                <td style="padding: 10px 12px; color: #6F5B44; font-weight: 600;">{{ cliente.nombre }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <style>
                .cliente-item:hover {
                    background: #F5F1E8 !important;
                }
                </style>
            </div>
        </div>
    </div>
</div>

<script>
// Script para modal de selección de cliente
document.addEventListener('DOMContentLoaded', function() {
    const modoPOS = '{{ modo_pos }}';
    
    if (modoPOS === 'con_cliente') {
        // Mostrar modal automáticamente
        const modalCliente = new bootstrap.Modal(document.getElementById('modalSeleccionCliente'));
        modalCliente.show();
        
        // Buscador de clientes
        document.getElementById('buscarClienteInicio').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const items = document.querySelectorAll('.cliente-item');
            
            items.forEach(item => {
                const nombre = item.dataset.clienteNombre.toLowerCase();
                const rut = item.dataset.clienteRut.toLowerCase();
                
                if (nombre.includes(query) || rut.includes(query)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Seleccionar cliente
        document.querySelectorAll('.cliente-item').forEach(item => {
            item.addEventListener('click', function() {
                const clienteId = this.dataset.clienteId.trim().replace(/\s+/g, ''); // Limpiar ID
                const clienteNombre = this.dataset.clienteNombre.trim();
                const clienteRut = this.dataset.clienteRut.trim();
                const clienteDireccion = this.dataset.clienteDireccion.trim();
                
                console.log('=== CLIENTE SELECCIONADO DESDE MODAL INICIO ===');
                console.log('ID (limpio):', clienteId);
                console.log('Nombre:', clienteNombre);
                console.log('RUT:', clienteRut);
                console.log('Dirección:', clienteDireccion);
                
                // Guardar cliente en sesión/variable global
                window.clienteSeleccionado = {
                    id: clienteId,
                    nombre: clienteNombre,
                    rut: clienteRut,
                    rut_formatted: clienteRut,
                    direccion: clienteDireccion
                };
                
                // Mostrar cliente en header del POS
                const clienteHeader = document.getElementById('clienteEnHeader');
                if (clienteHeader) {
                    clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${clienteNombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                }
                
                // Cerrar modal
                const modalElement = document.getElementById('modalSeleccionCliente');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                } else {
                    // Si no existe instancia, crear una y cerrarla
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }
                
                Swal.fire({
                    icon: 'success',
                    title: 'Cliente Seleccionado',
                    text: `Venta para: ${clienteNombre}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        });
    }
});

// Función para cambiar cliente
function cambiarCliente() {
    // Limpiar el campo de búsqueda del modal
    const busquedaInput = document.getElementById('buscarClienteInicio');
    if (busquedaInput) {
        busquedaInput.value = '';
    }
    
    // Limpiar resultados de búsqueda si existen
    const listaClientes = document.getElementById('listaClientesInicio');
    if (listaClientes) {
        // Restaurar la lista completa de clientes
        const todosLosClientes = listaClientes.querySelectorAll('.cliente-item');
        todosLosClientes.forEach(item => {
            item.style.display = '';
        });
    }
    
    const modalCliente = new bootstrap.Modal(document.getElementById('modalSeleccionCliente'));
    modalCliente.show();
}
</script>
{% endif %}

<!-- Modal de Apertura de Caja -->
{% if mostrar_modal_apertura %}
<div class="modal fade" id="modalAperturaCaja" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 1.5rem 2rem;">
                <h4 class="modal-title mb-0">
                    <i class="fas fa-lock-open me-2"></i>Abrir Caja
                </h4>
            </div>
            <div class="modal-body p-4">
                <!-- Alerta Informativa -->
                <div class="alert alert-info mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-left: 4px solid #2196F3;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-3 mt-1" style="font-size: 1.5rem; color: #1976D2;"></i>
                        <div>
                            <h6 class="mb-2" style="color: #1565C0; font-weight: 600;">Importante:</h6>
                            <p class="mb-0" style="color: #424242; line-height: 1.6;">
                                Al abrir la caja, se iniciará un nuevo turno. Asegúrate de contar el efectivo inicial correctamente. 
                                Este monto será la base para el cierre de caja al finalizar el turno.
                            </p>
                        </div>
                    </div>
                </div>
                
                <form method="post" action="{% url 'caja:apertura_create' %}" id="formAperturaCaja">
                    {% csrf_token %}
                    
                    <!-- Caja -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.caja.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-cash-register me-2" style="color: #28a745;"></i>Caja
                        </label>
                        {{ form_apertura.caja }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-check-circle me-1" style="color: #28a745;"></i>
                            Solo se muestran cajas activas sin apertura
                        </small>
                    </div>

                    <!-- Monto Inicial -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.monto_inicial.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-money-bill-wave me-2" style="color: #28a745;"></i>Monto Inicial
                        </label>
                        {{ form_apertura.monto_inicial }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-wallet me-1" style="color: #17a2b8;"></i>
                            Efectivo físico disponible al iniciar el turno
                        </small>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.observaciones_apertura.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-comment me-2" style="color: #28a745;"></i>Observaciones
                        </label>
                        {{ form_apertura.observaciones_apertura }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-pencil-alt me-1" style="color: #6c757d;"></i>
                            Opcional: Notas sobre el turno o condiciones especiales
                        </small>
                    </div>

                    <!-- Nota Final -->
                    <div class="alert alert-light mb-4" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-lightbulb me-3 mt-1" style="font-size: 1.3rem; color: #ffc107;"></i>
                            <div>
                                <strong style="color: #495057;">Recuerda:</strong>
                                <p class="mb-0 mt-1" style="color: #6c757d; font-size: 0.9rem; line-height: 1.5;">
                                    Una vez abierta la caja, podrás registrar movimientos, procesar ventas y cerrar al finalizar el turno.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" style="padding: 0.75rem; font-size: 1.1rem; font-weight: 600;">
                            <i class="fas fa-unlock me-2"></i>Abrir Caja y Comenzar Turno
                        </button>
                        <a href="{% url 'caja:apertura_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Mostrar modal automáticamente si no hay caja abierta
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalAperturaCaja'));
    modal.show();
});
</script>
{% endif %}

<script>
// Función para mostrar modal de referencias
function mostrarModalReferencias() {
    Swal.fire({
        title: '<i class="fas fa-file-alt me-2"></i>Gestionar Referencias',
        html: `
            <div style="text-align: left;">
                <!-- Formulario para agregar referencia -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h6 style="color: #495057; margin-bottom: 15px; font-size: 0.9rem;">
                        <i class="fas fa-plus-circle me-2"></i>Nueva Referencia
                    </h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Tipo *</label>
                            <select id="tipo-referencia" class="form-control form-control-sm">
                                <option value="">Seleccionar...</option>
                                <option value="801">Orden de Compra (801)</option>
                                <option value="802">Nota de Pedido (802)</option>
                                <option value="803">Contrato (803)</option>
                                <option value="52">Guía de Despacho (52)</option>
                                <option value="HES">HES</option>
                                <option value="HEM">HEM</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Folio *</label>
                            <input type="text" id="folio-referencia" class="form-control form-control-sm" placeholder="Ej: OC-12345">
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Fecha *</label>
                            <input type="date" id="fecha-referencia" class="form-control form-control-sm">
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Comentario</label>
                            <input type="text" id="razon-referencia" class="form-control form-control-sm" placeholder="Opcional">
                        </div>
                    </div>
                    <button type="button" id="btn-agregar-ref-modal" class="btn btn-success btn-sm w-100 mt-3" style="font-size: 0.85rem;">
                        <i class="fas fa-plus me-2"></i>Agregar a la Lista
                    </button>
                </div>
                
                <!-- Lista de referencias agregadas -->
                <div id="lista-referencias-modal">
                    <h6 style="color: #495057; margin-bottom: 10px; font-size: 0.9rem;">
                        <i class="fas fa-list me-2"></i>Referencias Agregadas (<span id="contador-refs">0</span>)
                    </h6>
                    <div id="tabla-refs-modal" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-bordered" style="font-size: 0.75rem; margin-bottom: 0;">
                            <thead style="background: #e9ecef; position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 30%;">Tipo</th>
                                    <th style="width: 20%;">Folio</th>
                                    <th style="width: 20%;">Fecha</th>
                                    <th style="width: 20%;">Comentario</th>
                                    <th style="width: 10%; text-align: center;">
                                        <i class="fas fa-trash"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tbody-refs-modal">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #adb5bd; padding: 20px;">
                                        <i class="fas fa-inbox fa-2x mb-2" style="display: block;"></i>
                                        No hay referencias agregadas
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `,
        width: '700px',
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-check me-2"></i>Guardar Referencias',
        cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
        didOpen: () => {
            // Referencias temporales para el modal
            window.referenciasTemp = [];
            
            // Botón agregar referencia en el modal
            document.getElementById('btn-agregar-ref-modal').addEventListener('click', function() {
                const tipo = document.getElementById('tipo-referencia').value;
                const folio = document.getElementById('folio-referencia').value;
                const fecha = document.getElementById('fecha-referencia').value;
                const razon = document.getElementById('razon-referencia').value;
                
                if (!tipo || !folio || !fecha) {
                    Swal.showValidationMessage('Complete los campos obligatorios (Tipo, Folio, Fecha)');
                    return;
                }
                
                // Obtener texto del tipo
                const selectElement = document.getElementById('tipo-referencia');
                const tipoTexto = selectElement.selectedOptions[0].text;
                
                // Agregar a referencias temporales
                window.referenciasTemp.push({
                    tipo: tipo,
                    tipo_texto: tipoTexto,
                    folio: folio,
                    fecha: fecha,
                    razon: razon || '-'
                });
                
                // Actualizar tabla del modal
                actualizarTablaReferenciasModal();
                
                // Limpiar formulario
                document.getElementById('tipo-referencia').value = '';
                document.getElementById('folio-referencia').value = '';
                document.getElementById('fecha-referencia').value = '';
                document.getElementById('razon-referencia').value = '';
            });
        },
        preConfirm: () => {
            return window.referenciasTemp;
        }
    }).then((result) => {
        if (result.isConfirmed && result.value.length > 0) {
            // Agregar todas las referencias al array principal
            window.referencias.push(...result.value);
            
            // Actualizar lista visual en el modal principal
            actualizarListaReferencias();
            
            // Mostrar toast de éxito (no modal que interrumpa)
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
            
            Toast.fire({
                icon: 'success',
                title: `${result.value.length} referencia(s) agregada(s)`
            });
        }
    });
}

// Función para actualizar tabla de referencias en el modal
function actualizarTablaReferenciasModal() {
    const tbody = document.getElementById('tbody-refs-modal');
    const contador = document.getElementById('contador-refs');
    
    if (!tbody) return;
    
    contador.textContent = window.referenciasTemp.length;
    
    if (window.referenciasTemp.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #adb5bd; padding: 20px;">
                    <i class="fas fa-inbox fa-2x mb-2" style="display: block;"></i>
                    No hay referencias agregadas
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    window.referenciasTemp.forEach((ref, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding: 4px 6px;">${ref.tipo_texto}</td>
            <td style="padding: 4px 6px;">${ref.folio}</td>
            <td style="padding: 4px 6px;">${ref.fecha}</td>
            <td style="padding: 4px 6px;">${ref.razon}</td>
            <td style="padding: 4px 6px; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger" style="padding: 1px 5px; font-size: 0.7rem;" onclick="eliminarReferenciaTemp(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Función para eliminar referencia temporal del modal
function eliminarReferenciaTemp(index) {
    window.referenciasTemp.splice(index, 1);
    actualizarTablaReferenciasModal();
}

// Actualizar lista visual de referencias
function actualizarListaReferencias() {
    const tabla = document.getElementById('tabla-referencias');
    const tbody = document.getElementById('tbody-referencias');
    const contador = document.getElementById('contador-refs-inline');
    
    if (!tbody) return;
    
    // Actualizar contador
    if (contador) {
        contador.textContent = window.referencias.length;
    }
    
    if (window.referencias.length === 0) {
        tabla.style.display = 'none';
        tbody.innerHTML = '';
        return;
    }
    
    tabla.style.display = 'table';
    tbody.innerHTML = '';
    
    window.referencias.forEach((ref, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding: 4px 6px;">${ref.tipo_texto}</td>
            <td style="padding: 4px 6px;">${ref.folio}</td>
            <td style="padding: 4px 6px;">${ref.fecha}</td>
            <td style="padding: 4px 6px;">${ref.razon || '-'}</td>
            <td style="padding: 4px 6px; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger" style="padding: 2px 6px; font-size: 0.7rem;" onclick="eliminarReferencia(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Eliminar referencia
function eliminarReferencia(index) {
    window.referencias.splice(index, 1);
    actualizarListaReferencias();
}
</script>

<!-- Modal de Confirmación de Despacho -->
{% include 'facturacion_electronica/modal_confirmacion_despacho.html' %}

</body>
</html>