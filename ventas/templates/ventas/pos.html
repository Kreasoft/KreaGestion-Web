<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta (POS) - GestionCloud</title>

    {% load static %}
    {% load articulo_filters %}
    {% load l10n %}
    {% load humanize %}

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
            height: 100vh;
            overflow: hidden;
        }

        .pos-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header del POS */
        .pos-header {
            background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .pos-header h2 {
            margin: 0;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .pos-info {
            display: flex;
            gap: 25px;
            align-items: center;
            margin-top: 8px;
        }

        .pos-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .pos-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pos-header-actions .btn {
            border-radius: 6px;
            padding: 6px 12px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        /* Campo de c√≥digo de barras */
        .pos-barcode-section {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 2px solid #e3e6f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pos-barcode-input {
            flex: 1;
            max-width: 300px;
        }

        .pos-barcode-input input {
            width: 100%;
            padding: 8px 15px;
            border: 2px solid #17a2b8;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .pos-barcode-input input:focus {
            outline: none;
            border-color: #138496;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
            transform: scale(1.02);
        }

        .pos-barcode-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .pos-barcode-label i {
            color: #17a2b8;
            font-size: 1.1rem;
        }

        .pos-barcode-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .pos-barcode-status.ready {
            color: #28a745;
        }

        .pos-barcode-status.scanning {
            color: #ffc107;
            animation: pulse 1s infinite;
        }

        .pos-barcode-status.disabled {
            color: #6c757d;
            opacity: 0.6;
        }

        .pos-barcode-toggle {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pos-barcode-toggle:hover {
            background: #138496;
        }

        .pos-barcode-toggle:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Contenido principal */
        .pos-main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Panel izquierdo - Productos */
        .pos-left-panel {
            width: 60%;
            background: white;
            border-right: 2px solid #e3e6f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Filtros y b√∫squeda */
        .pos-filters {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e3e6f0;
        }

        .pos-search {
            margin-bottom: 10px;
        }

        .pos-search input {
            border-radius: 20px;
            border: 2px solid #e3e6f0;
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .pos-search input:focus {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }

        .pos-category-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .category-btn {
            padding: 6px 14px;
            border: 1px solid #D4C4A8;
            background: #F5F0EB;
            color: #6F5B44;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .category-btn:hover {
            background: #E8DED5;
            border-color: #C8B79A;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(139, 115, 85, 0.2);
        }

        .category-btn.active {
            background: #D4C4A8;
            color: #2c3e50;
            border-color: #D4C4A8;
            box-shadow: 0 2px 6px rgba(139, 115, 85, 0.25);
        }

        /* Grid de productos compacto */
        .pos-products-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .pos-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        /* Vista de lista */
        .pos-products-grid.vista-lista {
            grid-template-columns: 1fr;
            gap: 2px;
        }

        .pos-product-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Estilo de tarjeta en vista lista */
        .vista-lista .pos-product-card {
            flex-direction: row;
            text-align: left;
            min-height: auto;
            padding: 6px 10px;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        .vista-lista .pos-product-name {
            flex: 1;
            margin-bottom: 0;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            font-size: 0.85rem;
        }

        .vista-lista .pos-product-price {
            margin-bottom: 0;
            margin-left: 12px;
            font-size: 0.85rem;
            min-width: 80px;
            text-align: right;
        }

        /* Estilos para productos en oferta */
        .pos-product-card.en-oferta {
            border: 2px solid #ff6b6b;
            background: linear-gradient(135deg, #fff 0%, #ffebeb 100%);
            position: relative;
        }

        .pos-product-badge-oferta {
            position: absolute;
            top: 4px;
            right: 4px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
            z-index: 1;
        }

        .pos-product-badge-oferta i {
            margin-right: 2px;
        }

        .pos-product-price-oferta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            margin-bottom: 5px;
        }

        .precio-normal-tachado {
            font-size: 0.75rem;
            color: #999;
            text-decoration: line-through;
            font-weight: 400;
        }

        .precio-oferta {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ff6b6b;
        }

        /* Vista lista - ofertas */
        .vista-lista .pos-product-badge-oferta {
            position: static;
            padding: 1px 4px;
            font-size: 0.55rem;
            margin-right: 6px;
        }

        .vista-lista .pos-product-price-oferta {
            flex-direction: row;
            gap: 8px;
            margin-bottom: 0;
            min-width: 120px;
            justify-content: flex-end;
        }

        .vista-lista .precio-normal-tachado {
            font-size: 0.7rem;
        }

        .vista-lista .precio-oferta {
            font-size: 0.9rem;
        }

        .vista-lista .pos-product-stock {
            margin-left: 12px;
            font-size: 0.75rem;
            min-width: 60px;
            text-align: right;
        }

        .pos-product-card:hover {
            border-color: #17a2b8;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            transform: translateY(-1px);
        }

        .pos-product-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .pos-product-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .pos-product-price {
            font-size: 0.8rem;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 2px;
        }

        .pos-product-stock {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .pos-product-stock.text-danger {
            color: #dc3545;
        }

        /* Panel derecho - Carrito y Totales */
        .pos-right-panel {
            width: 40%;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Lista de items del carrito - COMPACTA */
        .pos-cart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .pos-cart-header {
            background: #f8f9fa;
            padding: 8px 15px;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
            flex-shrink: 0;
        }

        .pos-cart-items {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            /* Removed fixed max-height to allow flexbox to handle sizing */
        }

        .pos-cart-item {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
            min-width: 0;
        }

        .pos-cart-item:hover {
            background: #f8f9fa;
        }

        .pos-cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-name {
            flex: 1;
            min-width: 0;
            font-weight: 500;
            color: #2c3e50;
            margin-right: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }

        .cart-item-price {
            min-width: 70px;
            flex-shrink: 0;
            text-align: right;
            color: #28a745;
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .cart-item-qty {
            min-width: 80px;
            flex-shrink: 0;
            text-align: center;
            margin: 0 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .cart-item-discount {
            min-width: 40px;
            flex-shrink: 0;
            text-align: center;
            color: #dc3545;
            font-size: 0.7rem;
        }

        .cart-item-total {
            min-width: 75px;
            flex-shrink: 0;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .cart-item-actions {
            min-width: 25px;
            flex-shrink: 0;
            text-align: center;
        }

        .cart-item-actions .btn {
            padding: 0px 4px;
            font-size: 0.65rem;
            border-radius: 3px;
        }

        .cart-item-qty .btn {
            padding: 0 4px;
            font-size: 0.75rem;
            line-height: 1.1;
            min-width: 20px;
        }

        /* Panel de totales COMPACTO */
        .pos-totals-panel {
            background: #f8f9fa;
            border-top: 1px solid #e3e6f0;
            padding: 8px 12px;
            flex-shrink: 0;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .totals-row.total-final {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            border-top: 1px solid #e3e6f0;
            padding-top: 6px;
            margin-top: 6px;
        }

        .totals-label {
            color: #6c757d;
        }

        .totals-value {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }

        .totals-value.total-final {
            color: #28a745;
            font-size: 1.1rem;
        }

        /* Botones de acci√≥n */
        .pos-actions {
            padding: 10px;
            background: white;
            border-top: 1px solid #e3e6f0;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .pos-actions .btn {
            flex: 1;
            margin-bottom: 0;
            padding: 10px;
            font-weight: 600;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-process {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }

        .btn-process:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-1px);
        }

        .btn-clear {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            color: white;
        }

        .btn-clear:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-1px);
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .pos-left-panel {
                width: 55%;
            }

            .pos-right-panel {
                width: 45%;
            }
        }

        @media (max-width: 768px) {
            .pos-main-content {
                flex-direction: column;
            }

            .pos-left-panel,
            .pos-right-panel {
                width: 100%;
                height: 50%;
            }
        }

        /* ===== PANEL DE AYUDA ===== */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .help-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .help-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .help-header {
            background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .help-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .help-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .help-header .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .help-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .help-content {
            padding: 0;
            max-height: calc(85vh - 100px);
            overflow-y: auto;
        }

        .help-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            padding: 0;
            margin: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-tab {
            flex: 1;
            padding: 18px 20px;
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .help-tab:hover {
            background: rgba(139, 115, 85, 0.05);
            color: #8B7355;
        }

        .help-tab.active {
            background: white;
            color: #8B7355;
            border-bottom-color: #8B7355;
        }

        .help-tab i {
            font-size: 1.2rem;
        }

        .help-tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .help-tab-content.active {
            display: block;
        }

        .help-section {
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 15px;
            border-left: 5px solid #8B7355;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .help-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .help-section h3 {
            color: #8B7355;
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-section h3 i {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .help-section p {
            color: #495057;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .help-steps {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .help-steps li {
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #8B7355;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-left: 55px;
        }

        .help-steps li::before {
            content: attr(data-step);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .help-example {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #856404;
        }

        .help-warning {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            color: #721c24;
        }

        .help-warning i {
            margin-right: 8px;
        }

        .help-tip {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            color: #0c5460;
        }

        .help-tip i {
            margin-right: 8px;
        }

        .help-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            color: #155724;
        }

        .help-success i {
            margin-right: 8px;
        }
    </style>
</head>

<body>
    {% csrf_token %}
    <div class="pos-container">
        <!-- Header del POS -->
        <div class="pos-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0">
                            <i class="fas fa-cash-register me-2"></i>Punto de Venta (POS)
                        </h2>
                        <div id="clienteEnHeader" style="margin-left: 20px;"></div>
                    </div>
                    <div class="pos-info">
                        <div class="pos-info-item">
                            <i class="fas fa-building"></i>
                            <span
                                style="font-weight: 600; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px;">
                                {% if request.sucursal_activa %}
                                üè¢ {{ request.sucursal_activa.nombre }}
                                {% else %}
                                ‚ö†Ô∏è SIN SUCURSAL
                                {% endif %}
                            </span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-hashtag"></i>
                            <span>Venta #<span id="proximo-numero">{{ proximo_numero }}</span></span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-desktop"></i>
                            <span id="estacion-actual">Estaci√≥n: <span id="estacion-nombre">-</span></span>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="mostrarCambiarEstacion()"
                                title="Cambiar estaci√≥n de trabajo" style="padding: 2px 6px; font-size: 0.7rem;">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-user"></i>
                            <span id="vendedor-actual">Vendedor: <span id="vendedor-nombre">-</span></span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-calendar"></i>
                            <span id="current-date"></span>
                        </div>
                        <div class="pos-info-item">
                            <i class="fas fa-clock"></i>
                            <span id="current-time"></span>
                        </div>
                    </div>
                </div>
                <div class="pos-header-actions">
                    <button class="btn btn-outline-light" onclick="mostrarAyudaPOS()" title="Ayuda del POS">
                        <i class="fas fa-question-circle me-1"></i>Ayuda
                    </button>
                    <button class="btn btn-outline-light" onclick="mostrarHistorialTickets()"
                        title="Ver historial de tickets del d√≠a">
                        <i class="fas fa-history me-1"></i>Historial
                    </button>
                    <button class="btn btn-outline-light" id="btn-printer-config" onclick="configurarImpresora()"
                        title="Configurar Impresora T√©rmica">
                        <i class="fas fa-print me-1"></i>Impresora
                    </button>
                    <button class="btn btn-outline-light" onclick="window.print()" title="Imprimir (Navegador)">
                        <i class="fas fa-print"></i>
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-light" title="Volver al Sistema">
                        <i class="fas fa-arrow-left me-1"></i>Salir
                    </a>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de c√≥digo de barras -->
        <div class="pos-barcode-section">
            <div class="pos-barcode-label">
                <i class="fas fa-barcode"></i>
                <span>Escanea c√≥digo de barras:</span>
            </div>
            <div class="pos-barcode-input">
                <input type="text" id="barcode-input" placeholder="Escanea o escribe c√≥digo de barras..."
                    autocomplete="off" autofocus>
            </div>
            <div class="pos-barcode-status ready" id="barcode-status">
                <i class="fas fa-check-circle"></i>
                <span>Listo para escanear</span>
            </div>
            <button class="pos-barcode-toggle" id="barcode-toggle" onclick="toggleBarcodeMode()"
                style="background: #17a2b8;">
                <i class="fas fa-barcode"></i> Modo Escaneo
            </button>
        </div>

        <!-- Contenido principal -->
        <div class="pos-main-content">
            <!-- Panel izquierdo - Productos -->
            <div class="pos-left-panel">
                <!-- Filtros y b√∫squeda -->
                <div class="pos-filters">
                    <!-- Selector de Lista de Precios -->
                    <div class="mb-2">
                        <label class="form-label fw-bold" style="font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-tags me-1"></i>Lista de Precios
                        </label>
                        <select class="form-select form-select-sm" id="listaPrecioSelect"
                            style="border: 2px solid #e9ecef;">
                            <option value="">Cargando...</option>
                        </select>
                    </div>

                    <div class="d-flex gap-2 align-items-center mb-2">
                        <div class="pos-search flex-grow-1">
                            <input type="text" id="pos-search" class="form-control" placeholder="Buscar productos...">
                        </div>
                        <button type="button" class="btn btn-sm" id="btnToggleCategorias"
                            style="background: #F5F0EB; color: #6F5B44; border: 1px solid #D4C4A8; padding: 6px 12px;"
                            title="Mostrar/Ocultar Categor√≠as">
                            <i class="fas fa-folder me-1"></i>Categor√≠as <i class="fas fa-chevron-down ms-1"
                                id="iconoCategorias"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" id="btnVistaGrid"
                                title="Vista en Cuadr√≠cula">
                                <i class="fas fa-th"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnVistaLista"
                                title="Vista en Lista">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pos-category-filter" id="categoriasContainer"
                        style="display: none; margin-bottom: 10px;">
                        <button class="category-btn active" data-category="all">Todas</button>
                        <!-- Las categor√≠as se cargar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Pesta√±as Productos / Kits -->
                <ul class="nav nav-tabs mb-2" style="border-bottom: 2px solid #8B7355;">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-productos" data-bs-toggle="tab"
                            data-bs-target="#panel-productos" type="button" style="color: #6F5B44; font-weight: 600;">
                            <i class="fas fa-box me-1"></i> Productos
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-ofertas" data-bs-toggle="tab" data-bs-target="#panel-ofertas"
                            type="button" style="color: #6F5B44; font-weight: 600;">
                            <i class="fas fa-tag me-1"></i> Ofertas
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-kits" data-bs-toggle="tab" data-bs-target="#panel-kits"
                            type="button" style="color: #6F5B44; font-weight: 600;">
                            <i class="fas fa-gift me-1"></i> Kits de Ofertas
                            {% if kits %}<span class="badge bg-success ms-1">{{ kits|length }}</span>{% endif %}
                        </button>
                    </li>
                </ul>

                <!-- Contenido de pesta√±as -->
                <div class="tab-content">
                    <!-- Panel Productos -->
                    <div class="tab-pane fade show active" id="panel-productos">
                        <!-- Grid de productos -->
                        <div class="pos-products-container">
                            <div class="pos-products-grid" id="pos-products-grid">
                                {% for articulo in articulos %}
                                <div class="pos-product-card {% if articulo.stock_actual <= 0 %}disabled{% endif %} {% if articulo.oferta_activa or articulo.en_oferta %}en-oferta{% endif %}"
                                    title="{{ articulo.nombre }}" data-articulo-id="{{ articulo.id }}"
                                    data-precio="{{ articulo.precio_final_calculado|unlocalize }}"
                                    data-precio-neto="{{ articulo.precio_venta|unlocalize }}"
                                    data-stock="{{ articulo.stock_actual|default:0 }}"
                                    data-categoria="{% if articulo.categoria %}{{ articulo.categoria.nombre }}{% else %}sin-categoria{% endif %}"
                                    data-categoria-exenta-iva="{% if articulo.categoria.exenta_iva %}true{% else %}false{% endif %}"
                                    data-impuesto-especifico="{% if articulo.categoria.impuesto_especifico %}{{ articulo.categoria.impuesto_especifico.get_porcentaje_decimal|unlocalize }}{% else %}0{% endif %}"
                                    data-en-oferta="{% if articulo.oferta_activa or articulo.en_oferta %}true{% else %}false{% endif %}"
                                    data-precio-oferta="{% if articulo.oferta_activa or articulo.en_oferta %}{{ articulo.get_precio_oferta_decimal|unlocalize }}{% else %}0{% endif %}"
                                    data-porcentaje-ahorro="{% if articulo.oferta_activa or articulo.en_oferta %}{{ articulo.get_porcentaje_ahorro|unlocalize }}{% else %}0{% endif %}">
                                    {% if articulo.oferta_activa or articulo.en_oferta %}
                                    <div class="pos-product-badge-oferta">
                                        <i class="fas fa-tag"></i> OFERTA{% if articulo.get_porcentaje_ahorro %} -{{
                                        articulo.get_porcentaje_ahorro|floatformat:0 }}%{% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="pos-product-name">{{ articulo.nombre }}</div>
                                    {% if articulo.oferta_activa or articulo.en_oferta %}
                                    <div class="pos-product-price-oferta">
                                        <span class="precio-normal-tachado">${{
                                            articulo.precio_final_calculado|format_price }}</span>
                                        <span class="precio-oferta">${{ articulo.get_precio_oferta_decimal|format_price
                                            }}</span>
                                    </div>
                                    {% else %}
                                    <div class="pos-product-price">${{ articulo.precio_final_calculado|format_price }}
                                    </div>
                                    {% endif %}
                                    <div
                                        class="pos-product-stock {% if articulo.stock_actual <= 0 %}text-danger{% endif %}">
                                        Stock: {{ articulo.stock_actual|default:"0" }}
                                    </div>
                                </div>
                                {% empty %}
                                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                                    <i class="fas fa-box-open fa-3x mb-3"></i>
                                    <p>No hay art√≠culos disponibles</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Panel Ofertas -->
                    <div class="tab-pane fade" id="panel-ofertas">
                        <div class="mb-2">
                            <input type="text" id="search-offers" class="form-control form-control-sm"
                                placeholder="Buscar ofertas...">
                        </div>
                        <div class="pos-products-container">
                            <div class="pos-products-grid" id="pos-offers-grid">
                                {% for articulo in articulos %}
                                {% if articulo.oferta_activa or articulo.en_oferta %}
                                <div class="pos-product-card{% if articulo.stock_actual <= 0 %} disabled{% endif %} en-oferta"
                                    title="{{ articulo.nombre }}" data-articulo-id="{{ articulo.id }}"
                                    data-precio="{{ articulo.get_precio_oferta_decimal|unlocalize }}"
                                    data-precio-neto="{{ articulo.precio_venta|unlocalize }}"
                                    data-stock="{{ articulo.stock_actual|default:0 }}">
                                    <div class="pos-product-badge-oferta">
                                        <i class="fas fa-tag"></i> OFERTA{% if articulo.get_porcentaje_ahorro %} -{{
                                        articulo.get_porcentaje_ahorro|floatformat:0 }}%{% endif %}
                                    </div>
                                    <div class="pos-product-name">{{ articulo.nombre }}</div>
                                    <div class="pos-product-price-oferta">
                                        <span class="precio-normal-tachado">${{
                                            articulo.precio_final_calculado|format_price }}</span>
                                        <span class="precio-oferta">${{ articulo.get_precio_oferta_decimal|format_price
                                            }}</span>
                                    </div>
                                    <div
                                        class="pos-product-stock{% if articulo.stock_actual <= 0 %} text-danger{% endif %}">
                                        Stock: {{ articulo.stock_actual|default:"0" }}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Panel Kits -->
                    <div class="tab-pane fade" id="panel-kits">
                        <div class="pos-products-container">
                            <div class="row g-1" id="pos-kits-grid">
                                {% for kit in kits %}
                                <div class="col-md-6">
                                    <div class="card"
                                        style="border: 1px solid #E8DCC8; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.boxShadow='0 2px 8px rgba(139,115,85,0.2)'"
                                        onmouseout="this.style.boxShadow='none'">
                                        <div class="card-body" style="padding: 0.5rem;">
                                            <div class="d-flex gap-2">
                                                <!-- Icono/Imagen peque√±a -->
                                                <div style="width: 50px; height: 50px; flex-shrink: 0;">
                                                    {% if kit.imagen %}
                                                    <img src="{{ kit.imagen.url }}"
                                                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;"
                                                        alt="{{ kit.nombre }}">
                                                    {% else %}
                                                    <div
                                                        style="width: 100%; height: 100%; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fas fa-gift"
                                                            style="color: #D4C4A8; font-size: 1.5rem;"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <!-- Info del kit -->
                                                <div class="flex-grow-1" style="min-width: 0;">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div
                                                                style="font-weight: 600; font-size: 0.75rem; color: #6F5B44; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                                {{ kit.nombre }}
                                                                {% if kit.destacado %}
                                                                <i class="fas fa-star ms-1"
                                                                    style="color: #D4A574; font-size: 0.65rem;"></i>
                                                                {% endif %}
                                                            </div>
                                                            <div style="font-size: 0.65rem; color: #999;">{{
                                                                kit.items.count }} item{{ kit.items.count|pluralize }} ‚Ä¢
                                                                Stock: {{ kit.stock_disponible }}</div>
                                                        </div>
                                                    </div>

                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <div>
                                                            <div
                                                                style="font-size: 0.95rem; font-weight: 700; color: #8B7355;">
                                                                ${{ kit.precio_kit|intcomma }}</div>
                                                            {% if kit.items.count > 0 %}
                                                            <div
                                                                style="font-size: 0.65rem; color: #999; text-decoration: line-through;">
                                                                ${{ kit.precio_total_items|intcomma }}</div>
                                                            {% endif %}
                                                        </div>
                                                        {% if kit.items.count > 0 %}
                                                        <span class="badge bg-success"
                                                            style="font-size: 0.65rem; padding: 2px 6px;">-{{
                                                            kit.ahorro_porcentaje|floatformat:0 }}%</span>
                                                        {% endif %}
                                                    </div>

                                                    <div class="d-flex gap-1">
                                                        <button type="button" class="btn btn-sm flex-fill"
                                                            style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; font-size: 0.65rem; padding: 3px 6px; border: none;"
                                                            data-kit-id="{{ kit.id }}"
                                                            data-kit-nombre="{{ kit.nombre }}"
                                                            data-kit-precio="{{ kit.precio_kit|unlocalize }}"
                                                            data-kit-stock="{{ kit.stock_disponible }}"
                                                            onclick="agregarKitCompleto(this.dataset.kitId, this.dataset.kitNombre, this.dataset.kitPrecio, this.dataset.kitStock)">
                                                            <i class="fas fa-cart-plus"></i> Kit
                                                        </button>
                                                        <button type="button" class="btn btn-sm flex-fill"
                                                            style="background: linear-gradient(135deg, #D4A574 0%, #C19461 100%); color: white; font-size: 0.65rem; padding: 3px 6px; border: none;"
                                                            data-kit-id="{{ kit.id }}"
                                                            onclick="desglosarKitEnCarrito(this.dataset.kitId)">
                                                            <i class="fas fa-list"></i> Items
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center py-4">
                                    <i class="fas fa-gift fa-3x mb-2" style="color: #D4C4A8;"></i>
                                    <p class="text-muted" style="font-size: 0.85rem;">No hay kits disponibles</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel derecho - Carrito y Totales -->
            <div class="pos-right-panel">
                <!-- Lista de items del carrito -->
                <div class="pos-cart-container">
                    <div class="pos-cart-header">
                        <i class="fas fa-shopping-cart me-2"></i>Carrito de Venta
                    </div>
                    <div class="pos-cart-items" id="pos-cart-items">
                        <!-- Los items se cargar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Panel de totales compacto -->
                <div class="pos-totals-panel">
                    {% if max_descuento_total > 0 %}
                    <div class="totals-row">
                        <span class="totals-label">Descuento Total (%)</span>
                        <input type="number" id="descuento-total-input" class="form-control form-control-sm"
                            style="width: 80px; text-align: right;" min="0" max="{{ max_descuento_total|unlocalize }}"
                            step="0.01">
                    </div>
                    {% endif %}
                    <div class="totals-row">
                        <span class="totals-label">Subtotal:</span>
                        <span class="totals-value" id="subtotal">$0</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label">Descuento:</span>
                        <span class="totals-value" id="descuento">$0</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label">Neto:</span>
                        <span class="totals-value" id="neto">$0</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label">IVA (19%):</span>
                        <span class="totals-value" id="iva">$0</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label">Impuesto Espec√≠fico:</span>
                        <span class="totals-value" id="impuesto_especifico">$0</span>
                    </div>
                    <div class="totals-row total-final">
                        <span class="totals-label">TOTAL:</span>
                        <span class="totals-value total-final" id="total">$0</span>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="pos-actions">
                    <button class="btn btn-process" id="btn-process">
                        <i class="fas fa-check me-2"></i>Procesar Venta
                    </button>
                    <button class="btn btn-clear" id="btn-clear">
                        <i class="fas fa-trash me-2"></i>Limpiar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Interceptor de redirect_url -->
    <script>
        // Interceptar fetch para manejar redirect_url en respuestas JSON
        (function () {
            const originalFetch = window.fetch;

            window.fetch = function (...args) {
                return originalFetch.apply(this, args)
                    .then(async response => {
                        // Solo interceptar si es una respuesta OK
                        if (!response.ok) return response;

                        // Clonar para no consumir el stream
                        const clonedResponse = response.clone();

                        // Intentar parsear JSON
                        try {
                            const data = await clonedResponse.json();

                            // Si la respuesta tiene redirect_url, redirigir autom√°ticamente
                            if (data && data.redirect_url) {
                                console.log('[INTERCEPT] Redirigiendo a:', data.redirect_url);
                                setTimeout(() => {
                                    window.location.href = data.redirect_url;
                                }, 100);
                            }
                        } catch (e) {
                            // No es JSON, devolver la respuesta original
                        }

                        return response;
                    });
            };

            console.log('[POS] Interceptor de redirect_url instalado');
        })();
    </script>

    <script>
        console.log('=== POS SCRIPT CARGADO - VERSION 2025-10-11-19:37 ===');
        // Version: 2025-10-11-19:37 - Fixed addToCart function
        // Variables globales
        let cart = [];
        let currentSubtotal = 0;
        let currentDescuento = 0;
        let currentNeto = 0;
        let currentIva = 0;
        let currentImpuestoEspecifico = 0;
        let currentTotal = 0;
        let currentCategory = 'all';
        let wasScanningMode = false; // Variable global para rastrear el modo de escaneo antes de procesar

        // Array de art√≠culos disponibles en el POS - se llena desde Django
        let articulos = [];
        window.articulos = articulos;

        // ===== FUNCIONES GLOBALES (FUERA DE DOMContentLoaded) =====

        // Obtener precio especial del cliente si existe
        async function obtenerPrecioArticulo(articuloId, precioLista) {
            // Si hay cliente seleccionado, buscar precio especial
            if (window.clienteSeleccionado && window.clienteSeleccionado.id) {
                try {
                    // Limpiar el ID del cliente (remover espacios y caracteres no num√©ricos excepto guiones)
                    const clienteIdLimpio = String(window.clienteSeleccionado.id).trim().replace(/\s+/g, '');

                    console.log(`Buscando precio especial para cliente ID: ${clienteIdLimpio}, art√≠culo: ${articuloId}`);

                    const response = await fetch(`/ventas/api/precio-cliente/${clienteIdLimpio}/${articuloId}/`);
                    const data = await response.json();
                    if (data.success && data.precio_especial) {
                        console.log(`‚úì Precio especial encontrado: $${data.precio_especial} (Lista: $${precioLista})`);
                        return parseFloat(data.precio_especial);
                    } else {
                        console.log(`‚úó Sin precio especial, usando precio de lista: $${precioLista}`);
                    }
                } catch (error) {
                    console.log('Error al buscar precio especial:', error);
                    console.log('Usando precio de lista');
                }
            }
            return parseFloat(precioLista);
        }

        // Agregar al carrito - DEBE ESTAR EN SCOPE GLOBAL
        async function addToCart(articuloId, nombre, precio, stock, categoriaExentaIva = false, impuestoEspecifico = 0, precioNeto = null, fromKit = false) {
            console.log('*** FUNCI√ìN addToCart LLAMADA ***', { articuloId: articuloId, nombre: nombre, precio: precio, stock: stock, categoriaExentaIva: categoriaExentaIva, impuestoEspecifico: impuestoEspecifico, precioNeto: precioNeto, fromKit: fromKit });

            // Normalizar ID a string para consistencia (evita errores entre string/number)
            const articuloIdStr = String(articuloId);

            // Obtener precio correcto (especial o lista)
            try {
                precio = await obtenerPrecioArticulo(articuloIdStr, precio);
            } catch (e) {
                console.error("Error al obtener precio, usando precio base:", e);
            }

            const existingItem = cart.find(item => String(item.articuloId) === articuloIdStr);

            // Obtener stock actual del DOM si es posible, sino usar el pasado por par√°metro
            const card = document.querySelector(`[data-articulo-id="${articuloIdStr}"]`);
            const stockActual = card ? parseInt(card.dataset.stock) : stock;

            if (existingItem) {
                if (existingItem.cantidad < stockActual) {
                    existingItem.cantidad += 1;
                    existingItem.total = parseFloat(existingItem.cantidad) * parseFloat(existingItem.precio);
                    // Recalcular impuestos para la nueva cantidad si fuera necesario
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Stock Insuficiente',
                        text: 'No hay suficiente stock para este producto',
                        timer: 2000
                    });
                    return;
                }
            } else {
                // Calcular impuestos correctamente seg√∫n la categor√≠a
                let precioNetoCalculado, ivaCalculado, impuestoEspecificoCalculado;

                // Asegurar que valores num√©ricos sean v√°lidos
                precio = parseFloat(precio) || 0;
                precioNeto = parseFloat(precioNeto) || 0;
                impuestoEspecifico = parseFloat(impuestoEspecifico) || 0;

                if (precioNeto > 0 && !categoriaExentaIva) {
                    // Si tenemos precio neto y NO est√° exenta de IVA
                    precioNetoCalculado = precioNeto;
                    ivaCalculado = precioNeto * 0.19;
                    impuestoEspecificoCalculado = precioNeto * (impuestoEspecifico / 100);
                } else if (precioNeto > 0 && categoriaExentaIva) {
                    // Si tenemos precio neto y S√ç est√° exenta de IVA
                    precioNetoCalculado = precioNeto;
                    ivaCalculado = 0;
                    impuestoEspecificoCalculado = precioNeto * (impuestoEspecifico / 100);
                } else {
                    // Fallback: calcular desde el precio final
                    const factorTotal = 1 + (categoriaExentaIva ? 0 : 0.19) + (impuestoEspecifico / 100);
                    precioNetoCalculado = precio / factorTotal;
                    ivaCalculado = categoriaExentaIva ? 0 : precioNetoCalculado * 0.19;
                    impuestoEspecificoCalculado = precioNetoCalculado * (impuestoEspecifico / 100);
                }

                cart.push({
                    articuloId: articuloIdStr,
                    nombre: nombre,
                    precio: parseFloat(precio), // Precio final con impuestos
                    precio_neto: precioNetoCalculado,
                    iva: ivaCalculado,
                    impuesto_especifico: impuestoEspecificoCalculado,
                    categoriaExentaIva: categoriaExentaIva,
                    impuestoEspecifico: impuestoEspecifico,
                    cantidad: 1,
                    descuento: 0,
                    total: parseFloat(precio),
                    fromKit: fromKit // Marcar si viene del kit
                });
            }

            updateCartDisplay();
            updateTotals();
        }

        // Actualizar display del carrito - DEBE ESTAR EN SCOPE GLOBAL
        function updateCartDisplay() {
            const cartContainer = document.getElementById('pos-cart-items');
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                cartContainer.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-shopping-cart fa-2x mb-2"></i><p>Carrito vac√≠o</p></div>';
                return;
            }

            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'pos-cart-item';

                // Si el item viene del kit, bloquear cantidad
                const isFromKit = item.fromKit === true;
                const qtyButtons = isFromKit ?
                    `<button class="btn btn-sm btn-outline-secondary" disabled style="opacity: 0.3; cursor: not-allowed;">-</button>
             <span>${item.cantidad} <i class="fas fa-lock" style="font-size: 0.7rem; color: #C8A882;" title="Cantidad bloqueada (del kit)"></i></span>
             <button class="btn btn-sm btn-outline-secondary" disabled style="opacity: 0.3; cursor: not-allowed;">+</button>` :
                    `<button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
             <span>${item.cantidad}</span>
             <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>`;

                const maxDescuentoLineal = parseFloat("{{ max_descuento_lineal|unlocalize|default:0 }}");
                let descuentoLinealInput = '';
                if (maxDescuentoLineal > 0) {
                    descuentoLinealInput = `
                <input type="number" 
                       class="form-control form-control-sm descuento-lineal-input" 
                       style="width: 60px; text-align: right;" 
                       min="0" 
                       max="${maxDescuentoLineal}" 
                       step="0.01" 
                       value="${item.descuento}" 
                       onchange="aplicarDescuentoLineal(${index}, this.value)">
            `;
                } else {
                    descuentoLinealInput = `${item.descuento}%`;
                }

                // Indicador de producto comod√≠n
                const esComodin = item.esComodin === true;
                const indicadorComodin = esComodin ? ' <span style="font-size: 0.7rem; color: #8B7355;" title="Producto Comod√≠n"><i class="fas fa-magic"></i></span>' : '';

                itemDiv.innerHTML = `
            <div class="cart-item-name">${item.nombre}${isFromKit ? ' <span style="font-size: 0.7rem; color: #C8A882;">üéÅ</span>' : ''}${indicadorComodin}</div>
            <div class="cart-item-price">$${formatChileanNumber(item.precio)}</div>
            <div class="cart-item-qty">
                ${qtyButtons}
            </div>
            <div class="cart-item-discount">${descuentoLinealInput}</div>
            <div class="cart-item-total">$${formatChileanNumber(item.total)}</div>
            <div class="cart-item-actions">
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
                cartContainer.appendChild(itemDiv);
            });

            // Scroll autom√°tico al √∫ltimo item agregado
            setTimeout(() => {
                cartContainer.scrollTop = cartContainer.scrollHeight;
            }, 50);

            // Actualizar totales despu√©s de mostrar items
            updateTotals();

            // A√±adir listener para el descuento total si existe
            const descuentoTotalInput = document.getElementById('descuento-total-input');
            if (descuentoTotalInput) {
                descuentoTotalInput.addEventListener('change', (e) => {
                    const maxDescuento = parseFloat(e.target.max) || 0;
                    let valor = parseFloat(e.target.value) || 0;
                    if (valor > maxDescuento) {
                        valor = maxDescuento;
                        e.target.value = valor;
                        Swal.fire('L√≠mite Excedido', `El descuento m√°ximo total es ${maxDescuento}%`, 'warning');
                    }
                    if (valor < 0) {
                        valor = 0;
                        e.target.value = valor;
                    }
                    updateTotals();
                });
            }
        }

        // Aplicar descuento lineal a un item
        function aplicarDescuentoLineal(index, descuento) {
            const item = cart[index];
            const maxDescuento = parseFloat("{{ max_descuento_lineal|unlocalize|default:0 }}");
            let descuentoAplicado = parseFloat(descuento) || 0;

            if (descuentoAplicado > maxDescuento) {
                descuentoAplicado = maxDescuento;
                Swal.fire('L√≠mite Excedido', `El descuento m√°ximo por l√≠nea es ${maxDescuento}%`, 'warning');
            }

            if (descuentoAplicado < 0) {
                descuentoAplicado = 0;
            }

            item.descuento = descuentoAplicado;
            // Recalcular el total del item basado en el precio original y el descuento
            item.total = item.precio * item.cantidad * (1 - (descuentoAplicado / 100));

            updateCartDisplay();
            updateTotals();
        }



        // Actualizar cantidad - DEBE ESTAR EN SCOPE GLOBAL
        function updateQuantity(index, change) {
            const item = cart[index];
            const newQuantity = item.cantidad + change;

            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }

            // Verificar stock (solo si no es producto comod√≠n)
            if (!item.esComodin && item.articuloId) {
                const card = document.querySelector(`[data-articulo-id="${item.articuloId}"]`);
                const stock = card ? parseInt(card.dataset.stock) : 999;
                if (newQuantity > stock) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Stock Insuficiente',
                        text: 'No hay suficiente stock para este producto',
                        timer: 2000
                    });
                    return;
                }
            }

            item.cantidad = newQuantity;
            item.total = parseFloat(item.cantidad) * parseFloat(item.precio);

            updateCartDisplay();
            updateTotals();
        }

        // Eliminar del carrito - DEBE ESTAR EN SCOPE GLOBAL
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            updateTotals();
        }

        // Actualizar totales - DEBE ESTAR EN SCOPE GLOBAL
        function updateTotals() {
            let subtotalBruto = 0; // Suma de precios originales
            let descuentoLinealTotal = 0;

            cart.forEach(item => {
                subtotalBruto += item.precio * item.cantidad;
                descuentoLinealTotal += (item.precio * item.cantidad) * (item.descuento / 100);
            });

            const subtotalPostDescuentoLineal = subtotalBruto - descuentoLinealTotal;

            const descuentoTotalInput = document.getElementById('descuento-total-input');
            const descuentoTotalPorcentaje = descuentoTotalInput ? parseFloat(descuentoTotalInput.value) || 0 : 0;
            const descuentoGlobalMonto = subtotalPostDescuentoLineal * (descuentoTotalPorcentaje / 100);

            const totalDescuentos = descuentoLinealTotal + descuentoGlobalMonto;
            const totalVentaConDescuentos = subtotalBruto - totalDescuentos;

            let netoFinal = 0;
            let ivaFinal = 0;
            let impuestoEspecificoFinal = 0;

            // Recalcular impuestos item por item con descuentos aplicados
            cart.forEach(item => {
                const precioOriginalItem = item.precio * item.cantidad;
                const descuentoLinealItem = precioOriginalItem * (item.descuento / 100);
                const precioPostDescuentoLineal = precioOriginalItem - descuentoLinealItem;

                // Distribuir el descuento global proporcionalmente
                const proporcionItem = subtotalPostDescuentoLineal > 0 ? precioPostDescuentoLineal / subtotalPostDescuentoLineal : 0;
                const descuentoGlobalItem = descuentoGlobalMonto * proporcionItem;

                const precioFinalItem = precioPostDescuentoLineal - descuentoGlobalItem;

                const factorImpuestos = 1 + (item.categoriaExentaIva ? 0 : 0.19) + (item.impuestoEspecifico / 100);
                const netoItem = precioFinalItem / factorImpuestos;

                netoFinal += netoItem;
                if (!item.categoriaExentaIva) {
                    ivaFinal += netoItem * 0.19;
                }
                impuestoEspecificoFinal += netoItem * (item.impuestoEspecifico / 100);
            });

            currentSubtotal = subtotalBruto;
            currentDescuento = totalDescuentos;
            currentNeto = netoFinal;
            currentIva = ivaFinal;
            currentImpuestoEspecifico = impuestoEspecificoFinal;
            currentTotal = totalVentaConDescuentos;

            document.getElementById('subtotal').textContent = `$${formatChileanNumber(currentSubtotal)}`;
            document.getElementById('descuento').textContent = `-$${formatChileanNumber(currentDescuento)}`;
            document.getElementById('neto').textContent = `$${formatChileanNumber(currentNeto)}`;
            document.getElementById('iva').textContent = `$${formatChileanNumber(currentIva)}`;
            document.getElementById('impuesto_especifico').textContent = `$${formatChileanNumber(currentImpuestoEspecifico)}`;
            document.getElementById('total').textContent = `$${formatChileanNumber(currentTotal)}`;
        }

        // Formatear n√∫meros - DEBE ESTAR EN SCOPE GLOBAL
        function formatChileanNumber(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            const rounded = Math.round(num).toString();
            return rounded.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        window.formatChileanNumber = formatChileanNumber;

        console.log('=== FUNCIONES GLOBALES DEFINIDAS ===', {
            addToCart: typeof addToCart,
            updateCartDisplay: typeof updateCartDisplay,
            updateTotals: typeof updateTotals,
            formatChileanNumber: typeof formatChileanNumber
        });

        // Variable global para lista de precios
        let listaPrecioActual = null;

        // Cargar listas de precios
        function cargarListasPrecios() {
            fetch('/articulos/api/listas-precios/')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('listaPrecioSelect');
                    select.innerHTML = '';

                    // Agregar opci√≥n "Precio Base" al inicio
                    const optionBase = document.createElement('option');
                    optionBase.value = '';
                    optionBase.textContent = 'üí∞ Precio Base (Sin Lista)';
                    select.appendChild(optionBase);

                    if (data.listas && data.listas.length > 0) {
                        data.listas.forEach(lista => {
                            const option = document.createElement('option');
                            option.value = lista.id;
                            option.textContent = lista.nombre + (lista.es_predeterminada ? ' ‚≠ê' : '');
                            if (lista.es_predeterminada) {
                                option.selected = true;
                                listaPrecioActual = lista.id;
                            }
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al cargar listas de precios:', error);
                    document.getElementById('listaPrecioSelect').innerHTML = '<option value="">Error al cargar</option>';
                });
        }

        // Toggle entre vista grid y lista
        function toggleVista(vista) {
            const grid = document.getElementById('pos-products-grid');
            const btnGrid = document.getElementById('btnVistaGrid');
            const btnLista = document.getElementById('btnVistaLista');

            if (vista === 'lista') {
                grid.classList.add('vista-lista');
                btnLista.classList.add('active');
                btnGrid.classList.remove('active');
                localStorage.setItem('posVista', 'lista');
            } else {
                grid.classList.remove('vista-lista');
                btnGrid.classList.add('active');
                btnLista.classList.remove('active');
                localStorage.setItem('posVista', 'grid');
            }
        }

        // ===== FUNCIONES PARA KITS DE OFERTAS =====

        // Agregar kit completo al carrito
        function agregarKitCompleto(kitId, kitNombre, kitPrecio, kitStock) {
            // Convertir a n√∫mero (ya viene sin formato desde el template)
            const precioLimpio = parseInt(kitPrecio);
            const stockLimpio = parseInt(kitStock);

            console.log('*** AGREGANDO KIT COMPLETO ***', kitId, kitNombre, precioLimpio, stockLimpio);

            if (stockLimpio <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin Stock',
                    text: 'Este kit no tiene stock disponible',
                    confirmButtonColor: '#8B7355'
                });
                return;
            }

            // Buscar si el kit ya est√° en el carrito
            const itemExistente = cart.find(item => item.tipo === 'kit' && item.kitId == kitId);

            if (itemExistente) {
                if (itemExistente.cantidad >= stockLimpio) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Stock Insuficiente',
                        text: 'No hay m√°s stock disponible de este kit',
                        confirmButtonColor: '#8B7355'
                    });
                    return;
                }
                itemExistente.cantidad++;
                itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
                itemExistente.total = itemExistente.subtotal;
            } else {
                // Calcular neto e IVA del kit (precio incluye IVA)
                const precioNeto = Math.round(precioLimpio / 1.19);
                const iva = precioLimpio - precioNeto;

                // Agregar nuevo kit al carrito
                cart.push({
                    tipo: 'kit',
                    kitId: kitId,
                    id: `kit-${kitId}`,
                    nombre: `üéÅ ${kitNombre}`,
                    precio: precioLimpio,
                    precio_neto: precioNeto,
                    iva: iva,
                    cantidad: 1,
                    subtotal: precioLimpio,
                    total: precioLimpio,
                    descuento: 0,
                    stock: stockLimpio,
                    categoriaExentaIva: false,
                    impuestoEspecifico: 0
                });
            }

            updateCartDisplay();

            // Feedback visual
            Swal.fire({
                icon: 'success',
                title: 'Kit Agregado',
                text: `${kitNombre} agregado al carrito`,
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Desglosar kit en items individuales y agregarlos al carrito
        async function desglosarKitEnCarrito(kitId) {
            console.log('*** DESGLOSANDO KIT EN CARRITO ***', kitId);

            try {
                // Obtener datos del kit desde el servidor
                const response = await fetch(`/articulos/kits/${kitId}/items-json/`);

                if (!response.ok) {
                    throw new Error('No se pudo obtener los items del kit');
                }

                const data = await response.json();

                if (!data.success || !data.items || data.items.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kit Vac√≠o',
                        text: 'Este kit no tiene art√≠culos configurados',
                        confirmButtonColor: '#8B7355'
                    });
                    return;
                }

                // Mostrar confirmaci√≥n con lista de items
                let itemsHtml = '<div style="text-align: left; max-height: 300px; overflow-y: auto;">';
                data.items.forEach(item => {
                    itemsHtml += `<p style="margin: 5px 0;"><strong>${item.articulo_nombre}</strong> x${item.cantidad}</p>`;
                });
                itemsHtml += '</div>';

                const result = await Swal.fire({
                    icon: 'question',
                    title: 'Desglosar Kit',
                    html: `
                <p>¬øDeseas agregar estos art√≠culos individualmente al carrito?</p>
                ${itemsHtml}
            `,
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, agregar items',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#8B7355',
                    cancelButtonColor: '#6c757d'
                });

                if (result.isConfirmed) {
                    // Calcular precio total normal de todos los items
                    const precioTotalNormal = data.items.reduce((sum, item) =>
                        sum + (item.precio_unitario * item.cantidad), 0
                    );

                    // Calcular factor de descuento proporcional
                    const factorDescuento = data.kit_precio / precioTotalNormal;

                    console.log('*** C√ÅLCULO PROPORCIONAL ***');
                    console.log('Precio kit:', data.kit_precio);
                    console.log('Precio total normal:', precioTotalNormal);
                    console.log('Factor descuento:', factorDescuento);

                    // Agregar cada item al carrito con precio proporcional
                    let itemsAgregados = 0;
                    for (const item of data.items) {
                        // Buscar el art√≠culo en el POS
                        const articulo = window.articulos.find(a => a.id == item.articulo_id);
                        if (articulo && articulo.stock > 0) {
                            // Calcular precio proporcional
                            const precioProporcionado = Math.round(item.precio_unitario * factorDescuento);

                            console.log(`Item: ${item.articulo_nombre}`);
                            console.log(`  Precio normal: ${item.precio_unitario}`);
                            console.log(`  Precio proporcional: ${precioProporcionado}`);
                            console.log(`  Cantidad: ${item.cantidad}`);

                            // Agregar con precio proporcional y cantidad correcta
                            // Marcar como item del kit para bloquear cantidad
                            for (let i = 0; i < item.cantidad; i++) {
                                await addToCartFromAnywhere(item.articulo_id, item.articulo_nombre, precioProporcionado, 1, true);
                            }
                            itemsAgregados++;
                        }
                    }

                    if (itemsAgregados > 0) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Items Agregados',
                            html: `
                        <p>${itemsAgregados} art√≠culo(s) agregado(s) al carrito</p>
                        <p class="text-muted" style="font-size: 0.9rem;">Precios ajustados proporcionalmente al kit</p>
                    `,
                            timer: 2500,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Sin Stock',
                            text: 'Los art√≠culos del kit no tienen stock disponible',
                            confirmButtonColor: '#8B7355'
                        });
                    }
                }

            } catch (error) {
                console.error('Error al desglosar kit:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo desglosar el kit. Intenta con "Kit Completo".',
                    confirmButtonColor: '#8B7355'
                });
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            console.log('*** DOMContentLoaded INICIADO ***');

            // Verificar si hay un vale pendiente de imprimir
            const urlParams = new URLSearchParams(window.location.search);
            const valeIdParaImprimir = urlParams.get('imprimir_vale');
            if (valeIdParaImprimir) {
                console.log('[IMPRESION] Vale pendiente de imprimir:', valeIdParaImprimir);
                // Construir URL del vale usando la URL base del template
                const valeUrlBase = "{% url 'ventas:vale_html' 999999 %}";
                const valeUrl = valeUrlBase.replace('999999', valeIdParaImprimir) + "?auto=1";
                console.log('[IMPRESION] Abriendo ventana de impresi√≥n:', valeUrl);
                // Abrir ventana de impresi√≥n
                setTimeout(function () {
                    window.open(valeUrl, '_blank');
                    // Limpiar par√°metro de la URL sin recargar la p√°gina
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 500);
            }

            // Cargar listas de precios
            cargarListasPrecios();

            // Event listener para cambio de lista de precios
            document.getElementById('listaPrecioSelect').addEventListener('change', function () {
                listaPrecioActual = this.value;
                console.log('Lista de precios cambiada a:', listaPrecioActual);

                // Recargar productos con nueva lista
                filterProducts();
            });

            // Event listeners para botones de vista
            document.getElementById('btnVistaGrid').addEventListener('click', function () {
                toggleVista('grid');
            });

            document.getElementById('btnVistaLista').addEventListener('click', function () {
                toggleVista('lista');
            });

            // Event listener para toggle de categor√≠as
            document.getElementById('btnToggleCategorias').addEventListener('click', function () {
                const container = document.getElementById('categoriasContainer');
                const icono = document.getElementById('iconoCategorias');

                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    icono.classList.remove('fa-chevron-down');
                    icono.classList.add('fa-chevron-up');
                } else {
                    container.style.display = 'none';
                    icono.classList.remove('fa-chevron-up');
                    icono.classList.add('fa-chevron-down');
                }
            });

            // Restaurar vista guardada
            const vistaGuardada = localStorage.getItem('posVista');
            if (vistaGuardada === 'lista') {
                toggleVista('lista');
            }

            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Cargar informaci√≥n de estaci√≥n y vendedor
            loadSessionInfo();

            // Event listeners
            document.getElementById('pos-search').addEventListener('input', filterProducts);

            const btnProcess = document.getElementById('btn-process');
            console.log('*** Bot√≥n Procesar Venta encontrado:', btnProcess);
            if (btnProcess) {
                btnProcess.addEventListener('click', function (e) {
                    console.log('*** EVENT LISTENER EJECUTADO - CLICK EN BTN-PROCESS ***');
                    e.preventDefault();
                    processSale();
                });
                console.log('*** Event listener agregado exitosamente ***');
            } else {
                console.error('*** ERROR: No se encontr√≥ el bot√≥n btn-process ***');
            }

            document.getElementById('btn-clear').addEventListener('click', clearCart);

            // Configurar bot√≥n "Todas" para filtro de categor√≠as
            const btnTodas = document.querySelector('.category-btn[data-category="all"]');
            if (btnTodas) {
                btnTodas.addEventListener('click', (e) => filterByCategory('all', e.target));
                console.log('Bot√≥n "Todas" configurado');
            }

            // Cargar art√≠culos desde el DOM
            loadArticulosFromDOM();

            // Configurar el sistema de c√≥digo de barras
            setupBarcodeSystem();

            // Click en productos (usando event delegation)
            document.addEventListener('click', async function (e) {
                console.log('*** CLICK DETECTADO ***', e.target);

                if (e.target.closest('.pos-product-card')) {
                    console.log('*** PRODUCTO ENCONTRADO ***');
                    const card = e.target.closest('.pos-product-card');

                    if (card.classList.contains('disabled')) {
                        console.log('*** PRODUCTO DESHABILITADO ***');
                        Swal.fire({
                            icon: 'warning',
                            title: 'Sin Stock',
                            text: 'Este producto no tiene stock disponible',
                            timer: 2000
                        });
                        return;
                    }

                    const articuloId = card.dataset.articuloId;
                    const precio = parseFloat(card.dataset.precio);
                    const stock = parseInt(card.dataset.stock);
                    const nombre = card.querySelector('.pos-product-name').textContent;

                    // Obtener informaci√≥n de impuestos del producto
                    const categoriaExentaIva = card.dataset.categoriaExentaIva === 'true';
                    const impuestoEspecifico = parseFloat(card.dataset.impuestoEspecifico || '0');
                    const precioNeto = parseFloat(card.dataset.precioNeto || precio);

                    console.log('*** AGREGANDO AL CARRITO ***', { articuloId: articuloId, nombre: nombre, precio: precio, stock: stock, categoriaExentaIva: categoriaExentaIva, impuestoEspecifico: impuestoEspecifico, precioNeto: precioNeto });
                    await addToCart(articuloId, nombre, precio, stock, categoriaExentaIva, impuestoEspecifico, precioNeto);
                } else {
                    console.log('*** NO ES UN PRODUCTO ***');
                }
            });

            // Cargar categor√≠as
            loadCategories();

            // Cargar informaci√≥n de la sesi√≥n
            function loadSessionInfo() {
                console.log('[DEBUG] Cargando sesion POS...');

                // ESPERAR 500ms para que la sesi√≥n se propague (fix para loop)
                setTimeout(() => {
                    // Obtener informaci√≥n de la sesi√≥n desde el servidor
                    fetch('/ventas/pos/session-info/')
                        .then(response => response.json())
                        .then(data => {
                            console.log('[DEBUG] Respuesta session-info:', data);

                            if (data.success) {
                                console.log('[OK] Sesion POS cargada exitosamente');
                                document.getElementById('estacion-nombre').textContent = data.estacion_nombre;
                                document.getElementById('vendedor-nombre').textContent = data.vendedor_nombre;

                                // Guardar IDs para uso posterior
                                window.currentEstacionId = data.estacion_id;
                                window.currentVendedorId = data.vendedor_id;
                                window.currentEstacion = data.estacion;
                            } else {
                                console.error('[ERROR] Session-info devolvio success=false:', data);

                                // REINTENTO: Esperar 1 segundo m√°s e intentar de nuevo
                                console.log('[RETRY] Reintentando en 1 segundo...');
                                setTimeout(() => {
                                    fetch('/ventas/pos/session-info/')
                                        .then(response => response.json())
                                        .then(data2 => {
                                            if (data2.success) {
                                                console.log('[OK] Sesion POS cargada en segundo intento');
                                                document.getElementById('estacion-nombre').textContent = data2.estacion_nombre;
                                                document.getElementById('vendedor-nombre').textContent = data2.vendedor_nombre;
                                                window.currentEstacionId = data2.estacion_id;
                                                window.currentVendedorId = data2.vendedor_id;
                                                window.currentEstacion = data2.estacion;
                                            } else {
                                                // Si falla el reintento, SI redirigir
                                                console.error('[ERROR] Session-info fallo en reintento');
                                                Swal.fire({
                                                    icon: 'warning',
                                                    title: 'Sesi√≥n no encontrada',
                                                    text: 'Debe seleccionar una estaci√≥n de trabajo y vendedor',
                                                    timer: 3000
                                                }).then(() => {
                                                    window.location.href = '{% url "ventas:pos_seleccion" %}';
                                                });
                                            }
                                        });
                                }, 1000);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Error en fetch session-info:', error);
                            // NO redirigir inmediatamente en caso de error de red
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de conexi√≥n',
                                text: 'No se pudo verificar la sesi√≥n. Intente recargar la p√°gina.',
                                confirmButtonText: 'Recargar'
                            }).then(() => {
                                location.reload();
                            });
                        });
                }, 500);  // Delay inicial de 500ms
            }

            // Actualizar fecha y hora
            function updateDateTime() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('es-CL');
                const timeStr = now.toLocaleTimeString('es-CL');

                document.getElementById('current-date').textContent = dateStr;
                document.getElementById('current-time').textContent = timeStr;
            }

            // Cargar categor√≠as
            function loadCategories() {
                const categories = new Set();
                document.querySelectorAll('.pos-product-card').forEach(card => {
                    const category = card.dataset.categoria;
                    if (category && category !== 'sin-categoria') {
                        categories.add(category);
                    }
                });

                const categoryContainer = document.querySelector('.pos-category-filter');

                // Agregar categor√≠as din√°micamente
                Array.from(categories).sort().forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = 'category-btn';
                    btn.textContent = category;
                    btn.dataset.category = category;
                    btn.addEventListener('click', (e) => filterByCategory(category, e.target));
                    categoryContainer.appendChild(btn);
                });

                console.log('Categor√≠as cargadas:', categories.size);
            }

            // Filtrar por categor√≠a
            function filterByCategory(category, buttonElement) {
                console.log('Filtrando por categor√≠a:', category);
                currentCategory = category;

                // Actualizar botones - quitar active de todos
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Agregar active al bot√≥n clickeado
                if (buttonElement) {
                    buttonElement.classList.add('active');
                } else {
                    // Si no hay elemento (llamada program√°tica), buscar el bot√≥n correcto
                    const targetBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
                    if (targetBtn) {
                        targetBtn.classList.add('active');
                    }
                }

                // Limpiar b√∫squeda
                const searchInput = document.getElementById('pos-search');
                if (searchInput) {
                    searchInput.value = '';
                }

                // Filtrar productos
                let visibleCount = 0;
                const grid = document.getElementById('pos-products-grid');
                const esVistaLista = grid.classList.contains('vista-lista');

                document.querySelectorAll('.pos-product-card').forEach(card => {
                    const cardCategory = card.dataset.categoria;
                    if (category === 'all' || cardCategory === category) {
                        // Usar flex para mantener el estilo correcto seg√∫n la vista
                        card.style.display = esVistaLista ? 'flex' : 'flex';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                console.log(`Mostrando ${visibleCount} productos de categor√≠a: ${category}`);
            }

            // Variable para controlar el timeout de b√∫squeda
            let searchTimeout = null;

            // Filtrar productos - ahora busca en toda la base de datos
            function filterProducts() {
                const searchInput = document.getElementById('pos-search');
                if (!searchInput) {
                    console.error('Input de b√∫squeda no encontrado');
                    return;
                }

                const searchTerm = searchInput.value.trim();
                console.log('Buscando:', searchTerm);

                // Cancelar b√∫squeda anterior si existe
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (!searchTerm) {
                    // Si no hay t√©rmino de b√∫squeda, mostrar productos cargados seg√∫n categor√≠a
                    let count = 0;
                    const grid = document.getElementById('pos-products-grid');
                    const esVistaLista = grid.classList.contains('vista-lista');

                    document.querySelectorAll('.pos-product-card').forEach(card => {
                        const category = card.dataset.categoria;
                        const matchesCategory = currentCategory === 'all' || category === currentCategory;
                        if (matchesCategory) {
                            card.style.display = 'flex';
                            count++;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    console.log(`Mostrando ${count} productos (sin b√∫squeda)`);
                    return;
                }

                // Esperar 500ms antes de buscar (debounce)
                searchTimeout = setTimeout(() => {
                    buscarEnBaseDatos(searchTerm);
                }, 500);
            }

            // Buscar en toda la base de datos
            function buscarEnBaseDatos(query) {
                console.log('Buscando en base de datos:', query);

                // Remover mensaje de "no resultados" si existe
                const mensajeAnterior = document.getElementById('no-results-message');
                if (mensajeAnterior) {
                    mensajeAnterior.remove();
                }

                // Remover productos din√°micos anteriores (los que fueron agregados por b√∫squedas previas)
                document.querySelectorAll('.pos-product-card[data-dinamico="true"]').forEach(card => {
                    card.remove();
                });

                // Ocultar todos los productos cargados inicialmente
                document.querySelectorAll('.pos-product-card').forEach(card => {
                    card.style.display = 'none';
                });

                // Construir URL con lista de precios si est√° seleccionada
                let url = `/ventas/pos/buscar-articulo/?q=${encodeURIComponent(query)}`;
                if (listaPrecioActual) {
                    url += `&lista_precio=${listaPrecioActual}`;
                    console.log('Usando lista de precios:', listaPrecioActual);
                }

                // Buscar en el backend
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Resultados de b√∫squeda:', data.articulos ? data.articulos.length : 0);

                        if (data.articulos && data.articulos.length > 0) {
                            console.log('=== PROCESANDO', data.articulos.length, 'PRODUCTOS ===');
                            // Mostrar todos los productos que coinciden con la b√∫squeda
                            data.articulos.forEach((articulo, index) => {
                                console.log(`[${index + 1}] ID: ${articulo.id}, Nombre: ${articulo.nombre}`);
                                const card = document.querySelector(`.pos-product-card[data-articulo-id="${articulo.id}"]`);
                                if (card) {
                                    // Si el producto ya est√° cargado, mostrarlo con flex
                                    card.style.display = 'flex';
                                    console.log(`  ‚úì Mostrando producto existente en DOM`);
                                } else {
                                    // Si no est√° cargado, agregarlo din√°micamente
                                    console.log(`  + Agregando producto nuevo al DOM`);
                                    agregarProductoDinamico(articulo);
                                }
                            });
                            console.log('=== FIN PROCESAMIENTO ===');
                        } else {
                            // No se encontraron resultados
                            console.log('No se encontraron productos');
                            mostrarMensajeNoResultados();
                        }
                    })
                    .catch(error => {
                        console.error('Error en b√∫squeda:', error);
                    });
            }

            // Agregar producto din√°micamente al grid
            function agregarProductoDinamico(articulo) {
                const grid = document.getElementById('pos-products-grid');
                if (!grid) return;

                // Verificar si ya existe
                if (document.querySelector(`.pos-product-card[data-articulo-id="${articulo.id}"]`)) {
                    return;
                }

                const card = document.createElement('div');
                card.className = 'pos-product-card';
                card.dataset.articuloId = articulo.id;
                card.dataset.categoria = 'B√∫squeda';
                card.dataset.dinamico = 'true';  // Marcar como producto din√°mico

                // Guardar datos del art√≠culo en el elemento para que el event listener global pueda accederlos
                card.dataset.precio = articulo.precio;
                card.dataset.stock = articulo.stock;
                card.dataset.categoriaExentaIva = articulo.categoria_exenta_iva || false;
                card.dataset.impuestoEspecificoPorcentaje = articulo.impuesto_especifico_porcentaje || 0;

                card.innerHTML = `
        <div class="pos-product-name">${articulo.nombre || articulo.descripcion || articulo.codigo}</div>
        <div class="pos-product-code">${articulo.codigo}</div>
        <div class="pos-product-price">$${new Intl.NumberFormat('es-CL').format(Math.round(articulo.precio))}</div>
        <div class="pos-product-stock">Stock: ${articulo.stock}</div>
    `;

                // NO agregar event listener aqu√≠ - el global ya lo maneja

                // Agregar al inicio del grid
                grid.insertBefore(card, grid.firstChild);
            }

            // Mostrar mensaje cuando no hay resultados
            function mostrarMensajeNoResultados() {
                const grid = document.getElementById('pos-products-grid');
                if (!grid) return;

                // Remover mensaje anterior si existe
                const mensajeAnterior = document.getElementById('no-results-message');
                if (mensajeAnterior) {
                    mensajeAnterior.remove();
                }

                const mensaje = document.createElement('div');
                mensaje.id = 'no-results-message';
                mensaje.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 2rem; color: #6c757d;';
                mensaje.innerHTML = '<i class="fas fa-search fa-2x mb-2"></i><br>No se encontraron productos';

                grid.appendChild(mensaje);
            }

            // NOTA: Funciones del carrito ahora est√°n en el scope global (l√≠neas 736-920)

            // Limpiar carrito
            function clearCart() {
                // Desactivar temporalmente el modo escaneo
                wasScanningMode = barcodeMode; // Guardar en variable global
                barcodeMode = false;

                Swal.fire({
                    title: '¬øLimpiar carrito?',
                    text: 'Se eliminar√°n todos los productos del carrito',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'S√≠, limpiar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        cart = [];
                        updateCartDisplay();
                        updateTotals();

                        // Limpiar variables de tipo de documento/ticket
                        window.tipoDocumentoPlaneadoTicket = null;
                        window.tipoTicketSeleccionado = null;
                        window.tipoDespachoTicket = null;
                    }

                    // Restaurar modo escaneo si estaba activo
                    if (wasScanningMode) {
                        setTimeout(() => {
                            barcodeMode = true;
                            const barcodeInput = document.getElementById('barcode-input');
                            if (barcodeInput) {
                                barcodeInput.focus();
                            }
                        }, 1000);
                    }
                });
            }

            // Procesar venta
            function processSale() {
                console.log('*** BOTON PROCESAR VENTA CLICKEADO ***');
                console.log('Cart length:', cart.length);
                console.log('window.currentEstacion:', window.currentEstacion);

                // Desactivar temporalmente el modo escaneo
                wasScanningMode = barcodeMode; // Guardar en variable global
                barcodeMode = false;

                if (cart.length === 0) {
                    console.log('*** ERROR: Carrito vac√≠o ***');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Carrito Vac√≠o',
                        text: 'Agrega productos al carrito antes de procesar la venta',
                        timer: 2000
                    }).then(() => {
                        // Restaurar modo escaneo si estaba activo
                        if (wasScanningMode) {
                            setTimeout(() => {
                                barcodeMode = true;
                                const barcodeInput = document.getElementById('barcode-input');
                                if (barcodeInput) {
                                    barcodeInput.focus();
                                }
                            }, 1000);
                        }
                    });
                    return;
                }

                if (!window.currentEstacion) {
                    console.log('*** ERROR: No hay estaci√≥n cargada ***');
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Sesi√≥n',
                        text: 'No se encontr√≥ informaci√≥n de la estaci√≥n de trabajo. Por favor, recarga la p√°gina.',
                        timer: 3000,
                        showConfirmButton: true
                    });
                    return;
                }

                console.log('*** Llamando a showDocumentTypeSelector() ***');
                // Mostrar selector de tipo de documento
                showDocumentTypeSelector();
            }

            // Alias para compatibilidad
            const procesarPreventa = processSale;

            // Mostrar selector de tipo de documento para preventa
            function showDocumentTypeSelector() {
                console.log('*** INICIO showDocumentTypeSelector() ***');
                console.log('window.currentEstacion:', window.currentEstacion);
                console.log('SweetAlert2 disponible:', typeof Swal !== 'undefined');

                // Inicializar variable global para tipo de documento
                window.tipoDocumentoSeleccionado = null;

                let tiposPermitidos = window.currentEstacion.tipos_documentos;
                // Filtrar "Ticket Facturable" (ticket) para que no aparezca en el POS
                tiposPermitidos = tiposPermitidos.filter(t => t !== 'ticket');
                console.log('Tipos permitidos:', tiposPermitidos);

                // Si est√° en modo "con_cliente", filtrar boletas y vales
                // (Las boletas son solo para consumidor final, no para clientes con RUT)
                const modoPOS = '{{ modo_pos }}';
                if (modoPOS === 'con_cliente') {
                    tiposPermitidos = tiposPermitidos.filter(tipo => tipo !== 'boleta' && tipo !== 'vale');
                }

                if (tiposPermitidos.length === 0) {
                    console.log('*** ERROR: No hay tipos de documentos permitidos ***');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin Documentos Permitidos',
                        text: 'Esta estaci√≥n no puede emitir ning√∫n tipo de documento',
                        timer: 3000
                    });
                    return;
                }

                // Crear botones de documentos con badges destacados
                const opciones = tiposPermitidos.map(tipo => {
                    // Obtener folios disponibles, asegur√°ndose de que sean n√∫meros
                    const getFolios = (tipoDoc) => {
                        if (!window.currentEstacion) return 0;
                        const folios = window.currentEstacion[`folios_${tipoDoc}`];
                        // Convertir a n√∫mero y manejar undefined/null
                        const numFolios = parseInt(folios) || 0;
                        return numFolios;
                    };

                    const config = {
                        'factura': { nombre: 'Factura', icono: 'fa-file-invoice', color: '#28a745', disponibles: getFolios('factura') },
                        'boleta': { nombre: 'Boleta', icono: 'fa-receipt', color: '#007bff', disponibles: getFolios('boleta') },
                        'guia': { nombre: 'Gu√≠a de Despacho', icono: 'fa-truck', color: '#ffc107', disponibles: getFolios('guia') },
                        'cotizacion': { nombre: 'Cotizaci√≥n', icono: 'fa-file-alt', color: '#6f42c1', disponibles: 999 },
                        'ticket': { nombre: 'Ticket Facturable', icono: 'fa-ticket-alt', color: '#8B7355', disponibles: 999 },
                        'vale': { nombre: 'Vale Interno', icono: 'fa-file-contract', color: '#6c757d', disponibles: 999 }
                    };

                    const info = config[tipo];
                    // Asegurarse de que disponibles sea un n√∫mero y comparar correctamente
                    const disponiblesNum = parseInt(info.disponibles) || 0;
                    // Mostrar "Sin Folios" solo para facturas, boletas y gu√≠as cuando no tienen folios
                    const sinFolios = disponiblesNum === 0 && ['factura', 'boleta', 'guia'].includes(tipo);

                    // Debug: mostrar en consola para verificar
                    if (tipo === 'boleta') {
                        console.log(`[DEBUG BOLETA] Folios disponibles: ${disponiblesNum}, sinFolios: ${sinFolios}, window.currentEstacion:`, window.currentEstacion);
                    }
                    const iconoEstado = disponiblesNum > 10 ? '‚úì' : (disponiblesNum > 0 ? '‚ö†Ô∏è' : '‚úó');
                    const colorBadge = disponiblesNum > 10 ? '#28a745' : (disponiblesNum > 0 ? '#ffc107' : '#dc3545');

                    // Estilos diferentes si no hay folios (deshabilitado)
                    const estiloDeshabilitado = sinFolios ? `
                opacity: 0.5;
                cursor: not-allowed;
                background: #f5f5f5 !important;
                position: relative;
            ` : '';

                    const bannerSinFolios = sinFolios ? `
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-15deg);
                    background: #dc3545;
                    color: white;
                    padding: 8px 24px;
                    font-weight: bold;
                    font-size: 1.1rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
                    z-index: 10;
                    pointer-events: none;
                ">
                    SIN FOLIOS
                </div>
            ` : '';

                    return `
                <button type="button" 
                        class="btn-tipo-documento ${sinFolios ? 'btn-sin-folios' : ''}" 
                        data-tipo="${tipo}" 
                        data-disponibles="${disponiblesNum}"
                        ${sinFolios ? 'disabled' : ''}
                        style="
                    width: 100%;
                    padding: 16px;
                    margin-bottom: 12px;
                    background: white;
                    border: 3px solid ${info.color};
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    cursor: ${sinFolios ? 'not-allowed' : 'pointer'};
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    ${estiloDeshabilitado}
                " onmouseover="if(!this.disabled) { this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'; }" 
                   onmouseout="if(!this.disabled) { this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; }">
                    ${bannerSinFolios}
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas ${info.icono}" style="font-size: 2rem; color: ${info.color};"></i>
                        <div style="text-align: left;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50;">${info.nombre}</div>
                            <div style="font-size: 0.75rem; color: #6c757d;">Documento tributario</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.5rem;">${iconoEstado}</span>
                        <span style="
                            padding: 6px 12px;
                            border: 2px solid ${colorBadge};
                            border-radius: 8px;
                            font-size: 0.9rem;
                            font-weight: 600;
                            color: ${colorBadge};
                            background: white;
                        ">${disponiblesNum}</span>
                    </div>
                </button>
            `;
                }).join('');

                // Verificar si ya hay un cliente seleccionado
                const clienteYaSeleccionado = window.clienteSeleccionado;
                console.log('=== MODAL PROCESAR VENTA ===');
                console.log('Cliente completo:', clienteYaSeleccionado);
                console.log('Cliente.id:', clienteYaSeleccionado ? clienteYaSeleccionado.id : 'No hay cliente');
                console.log('Cliente.nombre:', clienteYaSeleccionado ? clienteYaSeleccionado.nombre : 'No hay cliente');
                console.log('Cliente.rut:', clienteYaSeleccionado ? clienteYaSeleccionado.rut : 'No hay cliente');
                console.log('Cliente.rut_formatted:', clienteYaSeleccionado ? clienteYaSeleccionado.rut_formatted : 'No hay cliente');
                console.log('Cliente.direccion:', clienteYaSeleccionado ? clienteYaSeleccionado.direccion : 'No hay cliente');
                console.log('===========================');

                const html = `
            <div class="mb-3">
                <label class="form-label" style="font-weight: 700; color: #2c3e50; font-size: 1.1rem; text-align: left; display: block; margin-bottom: 16px;">
                    <i class="fas fa-file-invoice me-2"></i>Seleccione el Tipo de Documento a Emitir *
                </label>
                <input type="hidden" id="tipo-documento" required>
                <div id="botones-tipo-documento">
                    ${opciones}
                </div>
                <small style="color: #6c757d; font-size: 0.8rem; display: block; margin-top: 8px; text-align: center;">
                    <i class="fas fa-info-circle me-1"></i>Este documento se emitir√° posteriormente en el m√≥dulo de caja
                </small>
            </div>
            
            <!-- Tipo de Despacho (solo para Gu√≠as) -->
            <div class="mb-3" id="tipo-despacho-container" style="display: none;">
                <label class="form-label" style="font-weight: 700; color: #dc3545; text-align: left; display: block;">
                    <i class="fas fa-exclamation-triangle me-1"></i>Motivo de Traslado * (OBLIGATORIO)
                </label>
                <select id="tipo-despacho" class="form-control" required style="border: 2px solid #dc3545; background-color: #fff3cd;">
                    <option value="">‚ö†Ô∏è DEBE SELECCIONAR UN MOTIVO...</option>
                    <option value="1">1 - Venta (genera obligaci√≥n tributaria)</option>
                    <option value="2">2 - Venta por efectuar (anticipada)</option>
                    <option value="3">3 - Consignaci√≥n</option>
                    <option value="4">4 - Devoluci√≥n</option>
                    <option value="5">5 - Traslado interno (SIN obligaci√≥n tributaria)</option>
                    <option value="6">6 - Transformaci√≥n de productos</option>
                    <option value="7">7 - Entrega gratuita</option>
                    <option value="8">8 - Otros</option>
                </select>
                <small style="color: #dc3545; font-size: 0.75rem; font-weight: 600;">
                    <i class="fas fa-info-circle me-1"></i>Este campo afecta las obligaciones tributarias. Seleccione con cuidado.
                </small>
            </div>
            
            <!-- Referencias (solo para Facturas y Gu√≠as) -->
            <div class="mb-3" id="referencias-container" style="display: none;">
                <label class="form-label" style="font-weight: 700; color: #495057; text-align: left; display: block;">Referencias del Documento</label>
                
                <!-- Bot√≥n para mostrar/ocultar formulario de referencias -->
                <button type="button" id="btn-toggle-referencias" class="btn btn-sm w-100 mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px; border-radius: 8px; font-weight: 500; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                    <i class="fas fa-plus-circle me-2"></i>Agregar Referencias (Opcional)
                </button>
                
                <!-- Tarjeta con formulario y lista de referencias (inicialmente oculta) -->
                <div id="card-referencias" class="card" style="display: none; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="card-body" style="padding: 12px;">
                        <!-- Formulario inline para agregar referencias -->
                        <div id="form-referencia-inline" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <h6 style="color: #495057; font-size: 0.85rem; margin-bottom: 10px; text-align: left;">
                                <i class="fas fa-file-alt me-2"></i>Nueva Referencia
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Tipo *</label>
                                    <select id="tipo-referencia-inline" class="form-control form-control-sm">
                                        <option value="">Seleccionar...</option>
                                        <option value="801">Orden de Compra (801)</option>
                                        <option value="802">Nota de Pedido (802)</option>
                                        <option value="803">Contrato (803)</option>
                                        <option value="52">Gu√≠a de Despacho (52)</option>
                                        <option value="HES">HES</option>
                                        <option value="HEM">HEM</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Folio *</label>
                                    <input type="text" id="folio-referencia-inline" class="form-control form-control-sm" placeholder="Ej: OC-12345">
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Fecha *</label>
                                    <input type="date" id="fecha-referencia-inline" class="form-control form-control-sm">
                                </div>
                                <div class="col-6">
                                    <label style="font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; text-align: left;">Comentario</label>
                                    <input type="text" id="razon-referencia-inline" class="form-control form-control-sm" placeholder="Opcional">
                                </div>
                            </div>
                            <button type="button" id="btn-agregar-ref-inline" class="btn btn-success btn-sm w-100 mt-2" style="font-size: 0.8rem; padding: 6px;">
                                <i class="fas fa-plus me-1"></i>Agregar a la Lista
                            </button>
                        </div>
                        
                        <!-- Lista de referencias agregadas -->
                        <div id="referencias-lista">
                            <div style="font-size: 0.8rem; color: #495057; margin-bottom: 8px; padding: 8px; background: #e7f3ff; border-radius: 6px;">
                                <i class="fas fa-list me-2"></i><strong>Referencias Agregadas: <span id="contador-refs-inline">0</span></strong>
                            </div>
                            <table class="table table-sm table-bordered" id="tabla-referencias" style="display: none; font-size: 0.75rem; margin-bottom: 0;">
                                <thead style="background: #e9ecef;">
                                    <tr>
                                        <th style="width: 30%; padding: 4px 6px;">Tipo</th>
                                        <th style="width: 20%; padding: 4px 6px;">Folio</th>
                                        <th style="width: 18%; padding: 4px 6px;">Fecha</th>
                                        <th style="width: 22%; padding: 4px 6px;">Comentario</th>
                                        <th style="width: 10%; text-align: center; padding: 4px 6px;"><i class="fas fa-trash"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-referencias">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label" style="font-weight: 700; color: #495057; text-align: left; display: block;">Cliente *</label>
                
                ${clienteYaSeleccionado && '{{ modo_pos }}' === 'con_cliente' ? `
                    <!-- Cliente ya seleccionado en modo con_cliente - NO EDITABLE -->
                    <div class="alert alert-info mb-0" style="background: #E8F4F8; border: 1px solid #B8E0F0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user-check me-2" style="color: #0c5460;"></i>
                                <strong style="color: #0c5460;">${clienteYaSeleccionado.nombre}</strong><br>
                                <small style="color: #0c5460;">RUT: ${clienteYaSeleccionado.rut || clienteYaSeleccionado.rut_formatted || 'Sin RUT'}</small>
                            </div>
                        </div>
                        <small class="d-block mt-2" style="color: #0c5460;">
                            <i class="fas fa-info-circle me-1"></i>
                            Cliente seleccionado para esta venta.
                        </small>
                    </div>
                    <input type="hidden" id="busqueda-cliente" value="${clienteYaSeleccionado.rut || clienteYaSeleccionado.rut_formatted || ''}">
                ` : `
                    <!-- Modo normal - B√∫squeda habilitada -->
                    <div class="input-group mb-2">
                        <input type="text" id="busqueda-cliente" class="form-control" placeholder="RUT o nombre del cliente" required ${clienteYaSeleccionado ? 'value="' + clienteYaSeleccionado.rut + '"' : ''}>
                        <button type="button" class="btn btn-outline-secondary" onclick="buscarCliente()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    {% if modo_pos != 'con_cliente' %}
                    <button type="button" id="btn-venta-boleta" class="btn btn-sm w-100 mb-2" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; border: none; display: none;">
                        <i class="fas fa-receipt me-2"></i>Venta Boleta (RUT Gen√©rico 66666666-6)
                    </button>
                    {% endif %}
                    <div id="resultados-busqueda" class="mt-2" style="display: none;">
                        <div class="list-group" id="lista-clientes">
                            <!-- Resultados de b√∫squeda aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                    <div id="cliente-info" class="mt-2" style="display: ${clienteYaSeleccionado ? 'block' : 'none'};">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong id="cliente-nombre">${clienteYaSeleccionado ? clienteYaSeleccionado.nombre : '-'}</strong><br>
                            <small id="cliente-direccion">${clienteYaSeleccionado ? (clienteYaSeleccionado.direccion || 'Sin direcci√≥n') : '-'}</small>
                        </div>
                    </div>
                    <div id="cliente-no-encontrado" class="mt-2" style="display: none;">
                        <div class="alert alert-warning">
                            <strong>Cliente no encontrado</strong><br>
                            <button type="button" class="btn btn-sm btn-primary" id="btn-crear-cliente">
                                <i class="fas fa-plus me-1"></i>Crear Cliente
                            </button>
                        </div>
                    </div>
                `}
            </div>
        `;

                console.log('*** Preparando para abrir modal Swal.fire ***');
                console.log('HTML generado para modal, longitud:', html.length);

                Swal.fire({
                    title: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;"><i class="fas fa-cash-register me-2"></i>Procesar Preventa</div>',
                    html: html,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-check me-2"></i>Procesar Preventa',
                    cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    width: '650px',
                    didOpen: () => {
                        // Agregar b√∫squeda en tiempo real
                        const busquedaClienteInput = document.getElementById('busqueda-cliente');
                        if (busquedaClienteInput) {
                            busquedaClienteInput.addEventListener('input', function () {
                                const busqueda = this.value.trim();
                                if (busqueda.length >= 2) {
                                    buscarCliente();
                                } else {
                                    document.getElementById('resultados-busqueda').style.display = 'none';
                                    document.getElementById('cliente-info').style.display = 'none';
                                    document.getElementById('cliente-no-encontrado').style.display = 'none';
                                    window.clienteSeleccionado = null;
                                }
                            });
                        }

                        // Mostrar/ocultar bot√≥n de venta boleta seg√∫n tipo de documento
                        const tipoDocSelect = document.getElementById('tipo-documento');
                        const btnVentaBoleta = document.getElementById('btn-venta-boleta');
                        const tipoDespachoContainer = document.getElementById('tipo-despacho-container');
                        const referenciasContainer = document.getElementById('referencias-container');

                        // Array para almacenar referencias
                        window.referencias = [];

                        function toggleCamposSegunTipoDoc() {
                            const tipoDoc = tipoDocSelect.value;

                            // Mostrar/ocultar bot√≥n boleta
                            if (btnVentaBoleta) {
                                btnVentaBoleta.style.display = (tipoDoc === 'boleta') ? 'block' : 'none';
                            }

                            // Mostrar/ocultar tipo de despacho (solo para gu√≠as)
                            if (tipoDoc === 'guia') {
                                tipoDespachoContainer.style.display = 'block';
                                document.getElementById('tipo-despacho').required = true;
                            } else {
                                tipoDespachoContainer.style.display = 'none';
                                document.getElementById('tipo-despacho').required = false;
                            }

                            // Mostrar/ocultar referencias (para facturas y gu√≠as)
                            if (tipoDoc === 'factura' || tipoDoc === 'guia') {
                                referenciasContainer.style.display = 'block';
                            } else {
                                referenciasContainer.style.display = 'none';
                            }
                        }

                        // Manejar clics en botones de tipo de documento
                        document.querySelectorAll('.btn-tipo-documento').forEach(btn => {
                            btn.addEventListener('click', function (e) {
                                // Validar si tiene folios disponibles
                                const disponibles = parseInt(this.getAttribute('data-disponibles') || '0');
                                const tipo = this.getAttribute('data-tipo');

                                // Si es "ticket" y a√∫n no se ha seleccionado el tipo de documento planeado
                                if (tipo === 'ticket' && !window.tipoDocumentoPlaneadoTicket) {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    // Cerrar el modal actual y mostrar selector de tipo de documento para el ticket
                                    Swal.close();
                                    setTimeout(() => {
                                        mostrarSelectorTipoTicket();
                                    }, 100);
                                    return;
                                }

                                // Si es "ticket" y ya se seleccion√≥ el tipo, continuar normalmente
                                if (tipo === 'ticket' && window.tipoDocumentoPlaneadoTicket) {
                                    // El tipo ya est√° guardado, continuar con el flujo normal
                                    console.log('[TICKET] Continuando con tipo_documento_planeado:', window.tipoDocumentoPlaneadoTicket);
                                }
                                
                                // Si es "vale" (Interno), no requiere selector extra
                                if (tipo === 'vale') {
                                    console.log('[VALE INTERNO] Seleccionado');
                                }

                                // Bloquear si no hay folios (para facturas, boletas, gu√≠as)
                                if (disponibles === 0 && ['factura', 'boleta', 'guia'].includes(tipo)) {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    const nombresTipo = {
                                        'factura': 'Facturas',
                                        'boleta': 'Boletas',
                                        'guia': 'Gu√≠as de Despacho'
                                    };

                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Sin Folios Disponibles',
                                        html: `
                                    <div style="text-align: left; padding: 0 20px;">
                                        <p style="font-size: 1.1rem; margin-bottom: 15px;">
                                            <strong>No hay folios disponibles para emitir ${nombresTipo[tipo]}.</strong>
                                        </p>
                                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                                            <p style="margin: 0; color: #856404;">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                Los folios de este tipo de documento est√°n <strong>AGOTADOS</strong>.
                                            </p>
                                        </div>
                                        <p style="margin-bottom: 10px;"><strong>Para continuar:</strong></p>
                                        <ol style="margin-left: 20px; line-height: 1.8;">
                                            <li>Ve a <strong>Facturaci√≥n Electr√≥nica ‚Üí Gesti√≥n de CAF</strong></li>
                                            <li>Carga un nuevo archivo CAF para ${nombresTipo[tipo]}</li>
                                            <li>Verifica que el CAF est√© <span style="color: #28a745; font-weight: bold;">ACTIVO</span></li>
                                        </ol>
                                        <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 12px; margin-top: 15px; border-radius: 4px;">
                                            <p style="margin: 0; color: #004085; font-size: 0.9rem;">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Alternativa:</strong> Puedes usar otro tipo de documento que tenga folios disponibles.
                                            </p>
                                        </div>
                                    </div>
                                `,
                                        confirmButtonText: 'Entendido',
                                        confirmButtonColor: '#dc3545',
                                        width: '600px'
                                    });
                                    return false;
                                }

                                // Remover selecci√≥n de todos los botones
                                document.querySelectorAll('.btn-tipo-documento').forEach(b => {
                                    if (!b.disabled) {
                                        b.style.background = 'white';
                                        b.style.transform = 'scale(1)';
                                        b.style.boxShadow = 'none';
                                        b.style.fontWeight = 'normal';
                                    }
                                });

                                // Marcar este bot√≥n como seleccionado con estilo DESTACADO
                                const borderColor = this.style.borderColor;
                                this.style.background = 'linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%)';
                                this.style.transform = 'scale(1.05)';
                                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2), 0 0 0 3px #ffc107';
                                this.style.fontWeight = 'bold';

                                // Actualizar campo oculto y variable global
                                tipoDocSelect.value = tipo;
                                window.tipoDocumentoSeleccionado = tipo; // Guardar en variable global
                                console.log('[TIPO DOC] Tipo seleccionado:', tipo);
                                console.log('[TIPO DOC] Campo hidden value:', tipoDocSelect.value);

                                // Si es boleta, buscar autom√°ticamente cliente gen√©rico
                                if (tipo === 'boleta') {
                                    const busquedaInput = document.getElementById('busqueda-cliente');
                                    if (busquedaInput) {
                                        busquedaInput.value = '66666666-6';
                                        // Peque√±o delay para asegurar que la UI se actualice
                                        setTimeout(() => {
                                            if (typeof buscarCliente === 'function') {
                                                buscarCliente();
                                            }
                                        }, 100);
                                    }
                                }

                                // Trigger del evento change para mostrar/ocultar campos
                                toggleCamposSegunTipoDoc();
                            });
                        });

                        tipoDocSelect.addEventListener('change', toggleCamposSegunTipoDoc);
                        toggleCamposSegunTipoDoc(); // Verificar estado inicial

                        // Agregar evento click al bot√≥n de venta boleta
                        if (btnVentaBoleta) {
                            btnVentaBoleta.addEventListener('click', function () {
                                const busquedaInput = document.getElementById('busqueda-cliente');
                                busquedaInput.value = '66666666-6';
                                buscarCliente();
                            });
                        }

                        // Bot√≥n toggle para mostrar/ocultar formulario de referencias
                        const btnToggleRefs = document.getElementById('btn-toggle-referencias');
                        if (btnToggleRefs) {
                            btnToggleRefs.addEventListener('click', function () {
                                const card = document.getElementById('card-referencias');
                                const btn = document.getElementById('btn-toggle-referencias');

                                if (card.style.display === 'none') {
                                    card.style.display = 'block';
                                    btn.innerHTML = '<i class="fas fa-minus-circle me-2"></i>Ocultar Referencias';
                                    btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                                } else {
                                    card.style.display = 'none';
                                    btn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Agregar Referencias (Opcional)';
                                    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                }
                            });
                        }

                        // Bot√≥n agregar referencia inline
                        const btnAgregarRefInline = document.getElementById('btn-agregar-ref-inline');
                        if (btnAgregarRefInline) {
                            btnAgregarRefInline.addEventListener('click', function () {
                                const tipo = document.getElementById('tipo-referencia-inline').value;
                                const folio = document.getElementById('folio-referencia-inline').value;
                                const fecha = document.getElementById('fecha-referencia-inline').value;
                                const razon = document.getElementById('razon-referencia-inline').value;

                                if (!tipo || !folio || !fecha) {
                                    Swal.showValidationMessage('Complete los campos obligatorios (Tipo, Folio, Fecha)');
                                    return;
                                }

                                // Obtener texto del tipo
                                const selectElement = document.getElementById('tipo-referencia-inline');
                                const tipoTexto = selectElement.selectedOptions[0].text;

                                // Agregar referencia
                                window.referencias.push({
                                    tipo: tipo,
                                    tipo_texto: tipoTexto,
                                    folio: folio,
                                    fecha: fecha,
                                    razon: razon || '-'
                                });

                                // Actualizar lista visual
                                actualizarListaReferencias();

                                // Limpiar formulario
                                document.getElementById('tipo-referencia-inline').value = '';
                                document.getElementById('folio-referencia-inline').value = '';
                                document.getElementById('fecha-referencia-inline').value = '';
                                document.getElementById('razon-referencia-inline').value = '';

                                // Actualizar contador
                                document.getElementById('contador-refs-inline').textContent = window.referencias.length;
                            });
                        }
                    },
                    preConfirm: () => {
                        // Usar variable global como respaldo si el campo se pierde
                        let tipoDocumento = document.getElementById('tipo-documento').value;
                        if (!tipoDocumento && window.tipoDocumentoSeleccionado) {
                            tipoDocumento = window.tipoDocumentoSeleccionado;
                            console.log('[VALIDACION] Usando tipo documento de variable global:', tipoDocumento);
                        }

                        const rutCliente = document.getElementById('busqueda-cliente').value;
                        const tipoDespacho = document.getElementById('tipo-despacho').value;

                        console.log('[VALIDACION] Tipo documento:', tipoDocumento);
                        console.log('[VALIDACION] RUT cliente:', rutCliente);
                        console.log('[VALIDACION] Cliente seleccionado:', window.clienteSeleccionado);

                        // Validaci√≥n espec√≠fica para cada campo
                        if (!tipoDocumento) {
                            console.error('[VALIDACION] Tipo documento vacio!');
                            Swal.showValidationMessage('Debe seleccionar un tipo de documento');
                            return false;
                        }

                        if (!rutCliente) {
                            Swal.showValidationMessage('Debe buscar un cliente');
                            return false;
                        }

                        if (!window.clienteSeleccionado) {
                            Swal.showValidationMessage('Debe seleccionar un cliente de la lista');
                            return false;
                        }

                        // Validar tipo de despacho si es gu√≠a
                        if (tipoDocumento === 'guia' && !tipoDespacho) {
                            Swal.showValidationMessage('Debe seleccionar el motivo de traslado para gu√≠as de despacho');
                            return false;
                        }

                        // DEBUG CR√çTICO: Verificar valor de tipo_despacho
                        console.log('[CRITICAL DEBUG] tipo_despacho antes de enviar:', tipoDespacho);
                        console.log('[CRITICAL DEBUG] tipoDocumento:', tipoDocumento);
                        console.log('[CRITICAL DEBUG] ¬øEs gu√≠a?:', tipoDocumento === 'guia');

                        // CR√çTICO: El tipo_documento enviado al servidor determina el flujo de procesamiento
                        // cotizacion -> se queda como borrador
                        // vale -> se procesa en caja y descuenta stock inmediatamente
                        // factura/boleta/guia/ticket -> se crea un ticket (preventa) para la caja
                        const datosRetorno = {
                            tipo_documento: (tipoDocumento === 'cotizacion' || tipoDocumento === 'vale') ? tipoDocumento : 'ticket',
                            tipo_documento_original: tipoDocumento, // Mantener por referencia
                            rut_cliente: rutCliente,
                            cliente_id: window.clienteSeleccionado.id,
                            tipo_despacho: (tipoDespacho && tipoDespacho !== '') ? tipoDespacho : null,
                            referencias: window.referencias || []
                        };

                        // Determinar el documento planeado (el destino final)
                        if (tipoDocumento === 'cotizacion') {
                            datosRetorno.tipo_documento_planeado = 'cotizacion';
                        } else if (tipoDocumento === 'ticket') {
                            // Si el usuario eligi√≥ "Ticket Facturable" gen√©rico, usamos lo que eligi√≥ en el sub-selector
                            datosRetorno.tipo_documento_planeado = window.tipoDocumentoPlaneadoTicket || 'boleta';
                        } else {
                            // Para factura, boleta, guia o vale directo, el planeado es ese mismo tipo
                            datosRetorno.tipo_documento_planeado = tipoDocumento;
                        }

                        // DEBUG: Mostrar datos que se enviar√°n
                        console.log('[CRITICAL DEBUG] datosRetorno completo:', JSON.stringify(datosRetorno, null, 2));

                        return datosRetorno;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Procesar con vendedor actual del POS
                        // El vendedor se puede cambiar luego en la pantalla de pago si es necesario
                        const datosCompletos = {
                            ...result.value,
                            vendedor_id: window.currentVendedorId || null,
                            vehiculo_id: null,
                            chofer_id: null
                        };
                        processPreventaWithData(datosCompletos);
                    }
                });
            }

            // Funci√≥n para mostrar selector de tipo de documento cuando se selecciona "Ticket Facturable"
            function mostrarSelectorTipoTicket() {
                const tiposFacturables = ['factura', 'boleta', 'guia'];
                const tiposPermitidos = window.currentEstacion.tipos_documentos.filter(t => tiposFacturables.includes(t));

                if (tiposPermitidos.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin Tipos Disponibles',
                        text: 'No hay tipos de documentos facturables disponibles para este ticket',
                        timer: 3000
                    }).then(() => {
                        // Volver al selector principal
                        showDocumentTypeSelector();
                    });
                    return;
                }

                const configTipos = {
                    'factura': { nombre: 'Factura', icono: 'fa-file-invoice', color: '#28a745' },
                    'boleta': { nombre: 'Boleta', icono: 'fa-receipt', color: '#007bff' },
                    'guia': { nombre: 'Gu√≠a de Despacho', icono: 'fa-truck', color: '#ffc107' }
                };

                const opcionesTipos = tiposPermitidos.map(tipo => {
                    const info = configTipos[tipo];
                    return `
                <button type="button" class="btn-tipo-ticket btn btn-lg" 
                        data-tipo="${tipo}"
                        style="
                            width: 100%;
                            margin-bottom: 10px;
                            padding: 20px;
                            border: 3px solid ${info.color};
                            border-radius: 12px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                    <i class="fas ${info.icono}" style="font-size: 2rem; color: ${info.color};"></i>
                    <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50; margin-top: 10px;">${info.nombre}</div>
                </button>
            `;
                }).join('');

                Swal.fire({
                    title: '<i class="fas fa-ticket-alt me-2"></i>Seleccione Tipo de Documento',
                    html: `
                <div class="mb-3">
                    <p style="color: #6c757d; margin-bottom: 20px;">
                        El ticket facturable se convertir√° en el tipo de documento seleccionado cuando se procese en caja.
                    </p>
                    <div id="botones-tipo-ticket">
                        ${opcionesTipos}
                    </div>
                </div>
            `,
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#8B7355',
                    didOpen: () => {
                        // Manejar clics en botones de tipo para ticket
                        document.querySelectorAll('.btn-tipo-ticket').forEach(btn => {
                            btn.addEventListener('click', function () {
                                // Remover selecci√≥n anterior
                                document.querySelectorAll('.btn-tipo-ticket').forEach(b => {
                                    b.style.background = 'white';
                                    b.style.border = `3px solid ${b.getAttribute('data-tipo') === 'factura' ? '#28a745' : b.getAttribute('data-tipo') === 'boleta' ? '#007bff' : '#ffc107'}`;
                                });

                                // Marcar como seleccionado
                                this.style.background = this.getAttribute('data-tipo') === 'factura' ? '#e8f5e9' :
                                    this.getAttribute('data-tipo') === 'boleta' ? '#e3f2fd' : '#fff8e1';
                                this.style.border = `3px solid ${this.getAttribute('data-tipo') === 'factura' ? '#28a745' : this.getAttribute('data-tipo') === 'boleta' ? '#007bff' : '#ffc107'}`;

                                // Guardar tipo seleccionado
                                window.tipoTicketSeleccionado = this.getAttribute('data-tipo');
                            });
                        });
                    },
                    preConfirm: () => {
                        if (!window.tipoTicketSeleccionado) {
                            Swal.showValidationMessage('Debe seleccionar un tipo de documento para el ticket');
                            return false;
                        }
                        return window.tipoTicketSeleccionado;
                    }
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        // Guardar el tipo de documento planeado para el ticket
                        window.tipoDocumentoPlaneadoTicket = result.value;
                        window.tipoDocumentoSeleccionado = 'ticket';

                        console.log('[TICKET] Tipo de documento planeado seleccionado:', window.tipoDocumentoPlaneadoTicket);

                        // SI ES GU√çA, PEDIR TIPO DE DESPACHO
                        if (result.value === 'guia') {
                            Swal.fire({
                                title: 'Tipo de Traslado',
                                html: `
                                    <p class="mb-3">Seleccione el motivo del traslado:</p>
                                    <select id="tipo-despacho-modal" class="form-select" style="font-size: 1.1rem;">
                                        <option value="">-- Seleccione --</option>
                                        <option value="1">1 - Operaci√≥n constituye venta</option>
                                        <option value="2">2 - Ventas por efectuar</option>
                                        <option value="3">3 - Consignaciones</option>
                                        <option value="4">4 - Entrega gratuita</option>
                                        <option value="5">5 - Traslados internos</option>
                                        <option value="6">6 - Otros traslados (sin venta)</option>
                                        <option value="7">7 - Gu√≠a de devoluci√≥n</option>
                                        <option value="8">8 - Traslado para exportaci√≥n (no DUS)</option>
                                        <option value="9">9 - Venta para exportaci√≥n</option>
                                    </select>
                                `,
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: 'Continuar',
                                cancelButtonText: 'Cancelar',
                                preConfirm: () => {
                                    const tipoDespacho = document.getElementById('tipo-despacho-modal').value;
                                    if (!tipoDespacho) {
                                        Swal.showValidationMessage('Debe seleccionar el tipo de traslado');
                                        return false;
                                    }
                                    return tipoDespacho;
                                }
                            }).then((tipoDespachoResult) => {
                                if (tipoDespachoResult.isConfirmed && tipoDespachoResult.value) {
                                    // Guardar el tipo de despacho seleccionado
                                    window.tipoDespachoTicket = tipoDespachoResult.value;
                                    console.log('[TICKET-GUIA] Tipo de despacho seleccionado:', window.tipoDespachoTicket);
                                    console.log('[TICKET-GUIA] tipoDocumentoPlaneadoTicket:', window.tipoDocumentoPlaneadoTicket);

                                    // IMPORTANTE: En lugar de volver al selector, ir directamente al formulario de cliente
                                    // El tipo de documento es 'ticket' y el tipo planeado es 'guia'
                                    mostrarFormularioClienteTicket();
                                } else {
                                    // Si cancela, limpiar y volver
                                    window.tipoDocumentoPlaneadoTicket = null;
                                    window.tipoTicketSeleccionado = null;
                                    window.tipoDespachoTicket = null;
                                    showDocumentTypeSelector();
                                }
                            });
                        } else {
                            // Continuar con el flujo normal llamando a showDocumentTypeSelector nuevamente
                            // pero esta vez con el tipo 'ticket' ya seleccionado
                            showDocumentTypeSelector();
                        }
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        // Si cancela, volver al selector principal
                        showDocumentTypeSelector();
                    }
                });
            }

            // Funci√≥n para mostrar formulario de cliente cuando ya se seleccion√≥ Ticket con tipo de despacho
            function mostrarFormularioClienteTicket() {
                console.log('========================================');
                console.log('[TICKET-GUIA] *** NUEVO FLUJO ACTIVO ***');
                console.log('[TICKET-GUIA] Mostrando formulario de cliente directamente');
                console.log('[TICKET-GUIA] window.tipoDocumentoPlaneadoTicket:', window.tipoDocumentoPlaneadoTicket);
                console.log('[TICKET-GUIA] window.tipoDespachoTicket:', window.tipoDespachoTicket);
                console.log('========================================');

                // Alerta visual para confirmar que estamos en el nuevo flujo
                // alert('NUEVO FLUJO: tipo_despacho = ' + window.tipoDespachoTicket);

                // El cliente ya seleccionado (si hay)
                const clienteYaSeleccionado = window.clienteSeleccionado || null;

                Swal.fire({
                    title: '<i class="fas fa-user me-2"></i>Seleccionar Cliente',
                    html: `
                        <div style="text-align: left;">
                            <div class="alert alert-info mb-3">
                                <strong><i class="fas fa-truck me-2"></i>Ticket - Gu√≠a de Despacho</strong><br>
                                <small>Tipo de traslado: ${window.tipoDespachoTicket}</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 700; color: #495057;">Cliente *</label>
                                    <div class="input-group">
                                        <input type="text" id="busqueda-cliente-ticket" class="form-control" placeholder="RUT o Nombre..." autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="btn-buscar-cliente-ticket">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div id="resultados-busqueda-ticket" class="list-group shadow-sm mt-1" style="display: none; position: absolute; width: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                                </div>

                                <div id="cliente-info-ticket" class="mt-3 p-3 bg-light rounded" style="display: none; border-left: 4px solid #8B7355;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1" id="cliente-nombre-ticket" style="color: #6F5B44; font-weight: bold;"></h6>
                                            <p class="mb-0 small text-muted" id="cliente-direccion-ticket"></p>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('cliente-info-ticket').style.display='none'; document.getElementById('busqueda-cliente-ticket').value='';">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    width: '450px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-check me-2"></i>Procesar Ticket',
                    cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                    confirmButtonColor: '#28a745',
                    didOpen: () => {
                        const input = document.getElementById('busqueda-cliente-ticket');
                        const results = document.getElementById('resultados-busqueda-ticket');
                        const btnBuscar = document.getElementById('btn-buscar-cliente-ticket');

                        let typingTimer;
                        input.addEventListener('input', () => {
                            clearTimeout(typingTimer);
                            typingTimer = setTimeout(() => buscarClientesTicket(input.value), 300);
                        });

                        btnBuscar.addEventListener('click', () => buscarClientesTicket(input.value));
                    },
                    preConfirm: () => {
                        if (!window.clienteSeleccionado) {
                            Swal.showValidationMessage('Debe seleccionar un cliente');
                            return false;
                        }

                        return {
                            tipo_documento: 'ticket',
                            tipo_documento_planeado: window.tipoDocumentoPlaneadoTicket,
                            tipo_despacho: window.tipoDespachoTicket,
                            rut_cliente: document.getElementById('busqueda-cliente-ticket').value,
                            cliente_id: window.clienteSeleccionado.id,
                            referencias: window.referencias || []
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const datosCompletos = {
                            ...result.value,
                            vendedor_id: window.currentVendedorId || null,
                            vehiculo_id: null,
                            chofer_id: null
                        };
                        console.log('[TICKET-GUIA] Procesando con datos:', datosCompletos);
                        processPreventaWithData(datosCompletos);
                    } else {
                        // Si cancela, volver al selector principal
                        window.tipoDocumentoPlaneadoTicket = null;
                        window.tipoTicketSeleccionado = null;
                        window.tipoDespachoTicket = null;
                        showDocumentTypeSelector();
                    }
                });
            }

            // Funci√≥n para buscar clientes espec√≠ficamente para el modal de Ticket
            function buscarClientesTicket(q) {
                const lista = document.getElementById('resultados-busqueda-ticket'); // This should be the container for the list items
                const resultados = document.getElementById('resultados-busqueda-ticket'); // This is the overall results container

                if (!q || q.length < 3) {
                    resultados.style.display = 'none';
                    return;
                }

                lista.innerHTML = '<div class="text-center p-2"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
                resultados.style.display = 'block';

                fetch(`/ventas/pos/buscar-cliente/?q=${encodeURIComponent(q)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.clientes && data.clientes.length > 0) {
                            lista.innerHTML = data.clientes.map(cliente => `
                                <button type="button" class="list-group-item list-group-item-action" 
                                        onclick="seleccionarClienteTicket('${cliente.id}', '${cliente.nombre.replace(/'/g, "\\'")}', '${(cliente.rut || '').replace(/'/g, "\\'")}', '${(cliente.direccion || '').replace(/'/g, "\\'")}')">
                                    <div class="d-flex flex-column">
                                        <strong>${cliente.nombre}</strong>
                                        <small class="text-muted">${cliente.rut || 'Sin RUT'}</small>
                                    </div>
                                </button>
                            `).join('');
                            resultados.style.display = 'block';
                        } else {
                            lista.innerHTML = '<div class="alert alert-warning">No se encontraron clientes</div>';
                            resultados.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error buscando clientes:', error);
                        Swal.showValidationMessage('Error al buscar clientes');
                    });
            }

            // Funci√≥n para seleccionar cliente en modal Ticket-Gu√≠a
            function seleccionarClienteTicket(id, nombre, rut, direccion) {
                window.clienteSeleccionado = { id, nombre, rut, direccion };
                document.getElementById('busqueda-cliente-ticket').value = rut;
                document.getElementById('resultados-busqueda-ticket').style.display = 'none';
                document.getElementById('cliente-info-ticket').style.display = 'block';
                document.getElementById('cliente-nombre-ticket').textContent = nombre;
                document.getElementById('cliente-direccion-ticket').textContent = direccion || 'Sin direcci√≥n';
            }

            // Validar RUT chileno
            function validarRUT(rut) {
                // Limpiar RUT
                rut = rut.replace(/[^0-9kK]/g, '');

                if (rut.length < 8) return false;

                const dv = rut.slice(-1).toUpperCase();
                const numero = rut.slice(0, -1);

                let suma = 0;
                let multiplicador = 2;

                for (let i = numero.length - 1; i >= 0; i--) {
                    suma += parseInt(numero.charAt(i)) * multiplicador;
                    multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
                }

                const resto = suma % 11;
                const dvCalculado = resto < 2 ? resto : 11 - resto;
                const dvEsperado = dv === 'K' ? 10 : parseInt(dv);

                return dvCalculado === dvEsperado;
            }

            // Formatear RUT
            function formatearRUT(rut) {
                rut = rut.replace(/[^0-9kK]/g, '');
                if (rut.length < 8) return rut;

                const numero = rut.slice(0, -1);
                const dv = rut.slice(-1).toUpperCase();

                return numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
            }

            // Buscar cliente por RUT o nombre
            function buscarCliente() {
                const busqueda = document.getElementById('busqueda-cliente').value.trim();

                if (!busqueda) {
                    document.getElementById('resultados-busqueda').style.display = 'none';
                    document.getElementById('cliente-info').style.display = 'none';
                    document.getElementById('cliente-no-encontrado').style.display = 'none';
                    return;
                }

                // Limpiar resultados anteriores
                document.getElementById('lista-clientes').innerHTML = '';
                document.getElementById('resultados-busqueda').style.display = 'block';
                document.getElementById('cliente-info').style.display = 'none';
                document.getElementById('cliente-no-encontrado').style.display = 'none';

                // Mostrar loading
                document.getElementById('lista-clientes').innerHTML = '<div class="list-group-item text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';

                fetch(`/ventas/pos/buscar-cliente/?q=${encodeURIComponent(busqueda)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.clientes && data.clientes.length > 0) {
                            // Mostrar lista de clientes encontrados
                            let html = '';
                            data.clientes.forEach(cliente => {
                                const rutDisplay = cliente.rut || cliente.rut_formatted || 'Sin RUT';
                                html += `
                            <div class="list-group-item list-group-item-action" onclick="seleccionarCliente('${cliente.id}', '${cliente.nombre.replace(/'/g, "\\'")}', '${rutDisplay.replace(/'/g, "\\'")}', '${(cliente.direccion || '').replace(/'/g, "\\'")}')">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${cliente.nombre}</h6>
                                    <small>${rutDisplay}</small>
                                </div>
                                <p class="mb-1">${cliente.direccion || 'Sin direcci√≥n'}</p>
                            </div>
                        `;
                            });
                            document.getElementById('lista-clientes').innerHTML = html;
                        } else {
                            // No se encontraron clientes
                            document.getElementById('resultados-busqueda').style.display = 'none';
                            document.getElementById('cliente-no-encontrado').style.display = 'block';
                            window.clienteSeleccionado = null;
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar cliente:', error);
                        document.getElementById('resultados-busqueda').style.display = 'none';
                        document.getElementById('cliente-no-encontrado').style.display = 'block';
                        window.clienteSeleccionado = null;
                    });
            }


            // Crear cliente
            function crearCliente() {
                // Verificar que Swal existe
                if (typeof Swal === 'undefined') {
                    console.error('ERROR: SweetAlert2 no est√° cargado');
                    return;
                }

                const rut = document.getElementById('busqueda-cliente').value;
                const tipoDocumento = document.getElementById('tipo-documento').value;

                // Si es boleta, usar cliente autom√°tico
                if (tipoDocumento === 'boleta') {
                    crearClienteBoleta();
                    return;
                }
                // Para otros tipos, mostrar formulario de creaci√≥n
                Swal.fire({
                    title: '<i class="fas fa-user-plus me-2"></i>Crear Nuevo Cliente',
                    html: `
                <style>
                    .swal2-popup {
                        border-radius: 15px;
                        font-family: 'Poppins', sans-serif;
                    }
                    .swal2-title {
                        color: #6F5B44;
                        font-weight: 600;
                        font-size: 1.5rem;
                        padding: 1rem 0 0.5rem 0;
                    }
                    .swal2-html-container {
                        padding: 0 2rem 1rem 2rem;
                    }
                    .form-label-terroso {
                        font-weight: 600;
                        color: #6F5B44;
                        font-size: 0.9rem;
                        margin-bottom: 0.3rem;
                        display: block;
                        text-align: left;
                    }
                    .form-control-terroso {
                        border: 2px solid #D4C4A8;
                        border-radius: 8px;
                        padding: 0.5rem 0.75rem;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                    }
                    .form-control-terroso:focus {
                        border-color: #8B7355;
                        box-shadow: 0 0 0 0.2rem rgba(139, 115, 85, 0.25);
                        outline: none;
                    }
                    .campo-requerido::after {
                        content: " *";
                        color: #dc3545;
                    }
                    .info-box {
                        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
                        border-left: 4px solid #8B7355;
                        padding: 0.75rem;
                        border-radius: 8px;
                        margin-bottom: 1rem;
                        text-align: left;
                    }
                    .info-box i {
                        color: #8B7355;
                        margin-right: 0.5rem;
                    }
                    .info-box p {
                        margin: 0;
                        color: #6F5B44;
                        font-size: 0.85rem;
                    }
                </style>
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong style="color: #6F5B44;">Importante:</strong>
                    <p>Complete los datos del cliente. Los campos marcados con (*) son obligatorios.</p>
                </div>
                <div class="mb-3">
                    <label class="form-label-terroso campo-requerido">RUT</label>
                    <input type="text" id="nuevo-rut" class="form-control form-control-terroso" value="${rut}" placeholder="12.345.678-9">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso campo-requerido">Nombre</label>
                        <input type="text" id="nuevo-nombre" class="form-control form-control-terroso" placeholder="Nombre del cliente" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso campo-requerido">Giro</label>
                        <input type="text" id="nuevo-giro" class="form-control form-control-terroso" placeholder="Giro comercial" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label-terroso">Direcci√≥n</label>
                    <input type="text" id="nueva-direccion" class="form-control form-control-terroso" placeholder="Calle y n√∫mero">
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso campo-requerido">Comuna</label>
                        <input type="text" id="nueva-comuna" class="form-control form-control-terroso" placeholder="Comuna" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso campo-requerido">Ciudad</label>
                        <input type="text" id="nueva-ciudad" class="form-control form-control-terroso" placeholder="Ciudad" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label-terroso">Regi√≥n</label>
                        <input type="text" id="nueva-region" class="form-control form-control-terroso" placeholder="Regi√≥n">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso">Tel√©fono</label>
                        <input type="text" id="nuevo-telefono" class="form-control form-control-terroso" placeholder="+56 9 1234 5678">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label-terroso">Email</label>
                        <input type="email" id="nuevo-email" class="form-control form-control-terroso" placeholder="correo@ejemplo.com">
                    </div>
                </div>
            `,
                    width: '700px',
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-save me-2"></i>Crear Cliente',
                    cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                    confirmButtonColor: '#8B7355',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        confirmButton: 'btn btn-lg',
                        cancelButton: 'btn btn-lg'
                    },
                    buttonsStyling: true,
                    preConfirm: () => {
                        const rutInput = document.getElementById('nuevo-rut').value.trim();
                        const nombre = document.getElementById('nuevo-nombre').value.trim();
                        const giro = document.getElementById('nuevo-giro').value.trim();
                        const direccion = document.getElementById('nueva-direccion').value.trim();
                        const comuna = document.getElementById('nueva-comuna').value.trim();
                        const ciudad = document.getElementById('nueva-ciudad').value.trim();
                        const region = document.getElementById('nueva-region').value.trim();
                        const telefono = document.getElementById('nuevo-telefono').value.trim();
                        const email = document.getElementById('nuevo-email').value.trim();

                        if (!rutInput) {
                            Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El RUT es requerido');
                            return false;
                        }
                        if (!nombre) {
                            Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El nombre es requerido');
                            return false;
                        }
                        if (!giro) {
                            Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>El giro es requerido');
                            return false;
                        }
                        if (!comuna) {
                            Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>La comuna es requerida');
                            return false;
                        }
                        if (!ciudad) {
                            Swal.showValidationMessage('<i class="fas fa-exclamation-circle me-2"></i>La ciudad es requerida');
                            return false;
                        }

                        return {
                            rut: rutInput,
                            nombre: nombre,
                            giro: giro,
                            direccion: direccion,
                            comuna: comuna,
                            ciudad: ciudad,
                            region: region,
                            telefono: telefono,
                            email: email
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        crearClienteNuevo(result.value);
                    }
                });
            }

            // Crear cliente autom√°tico para boletas
            function crearClienteBoleta() {
                const data = {
                    items: cart.map(item => ({
                        articuloId: item.articuloId,
                        cantidad: item.cantidad,
                        precio: item.precio,
                        descuento: item.descuento
                    })),
                    descuento_total_pct: document.getElementById('descuento-total-input') ? document.getElementById('descuento-total-input').value : 0
                };

                fetch('/ventas/pos/crear-cliente-boleta/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 403) {
                                throw new Error('No tienes permisos para crear clientes. Contacta al administrador.');
                            }
                            throw new Error('Error en el servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Mostrar informaci√≥n del cliente creado
                            document.getElementById('cliente-nombre').textContent = data.cliente.nombre;
                            document.getElementById('cliente-direccion').textContent = data.cliente.direccion;
                            document.getElementById('cliente-info').style.display = 'block';
                            document.getElementById('cliente-no-encontrado').style.display = 'none';
                            window.clienteSeleccionado = data.cliente;

                            // Mostrar cliente en header
                            const clienteHeader = document.getElementById('clienteEnHeader');
                            if (clienteHeader) {
                                clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${data.cliente.nombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Cliente Creado',
                                text: 'Cliente autom√°tico para boletas creado exitosamente',
                                timer: 2000
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message || 'Error al crear cliente',
                                timer: 3000
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al crear cliente boleta:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message || 'Error al crear cliente de boleta. Intenta nuevamente.',
                            timer: 3000
                        });
                    });
            }

            // Crear cliente nuevo
            function crearClienteNuevo(datos) {
                console.log('=== CREAR CLIENTE NUEVO ===');
                console.log('Datos enviados:', datos);

                fetch('/ventas/pos/crear-cliente/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify(datos)
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Response ok:', response.ok);

                        if (!response.ok) {
                            if (response.status === 403) {
                                throw new Error('PERMISO DENEGADO: No tienes permisos para crear clientes. Contacta al administrador del sistema.');
                            }
                            return response.text().then(text => {
                                console.error('Error response text:', text);
                                throw new Error(`ERROR DEL SERVIDOR (${response.status}): ${text.substring(0, 100)}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('=== RESPUESTA DEL SERVIDOR ===');
                        console.log('Data completa:', data);
                        console.log('Success:', data.success);
                        console.log('Cliente:', data.cliente);
                        console.log('Message:', data.message);

                        if (data.success) {
                            console.log('‚úì Cliente creado exitosamente');

                            // Guardar cliente seleccionado globalmente
                            window.clienteSeleccionado = data.cliente;
                            console.log('‚úì Cliente guardado en window.clienteSeleccionado:', window.clienteSeleccionado);

                            // Mostrar cliente en header
                            const clienteHeader = document.getElementById('clienteEnHeader');
                            if (clienteHeader) {
                                clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${data.cliente.nombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                            }

                            // Mostrar mensaje de √©xito y luego reabrir el modal de procesar preventa
                            Swal.fire({
                                icon: 'success',
                                title: '‚úì Cliente Creado Exitosamente',
                                html: `
                        <div style="text-align: left; padding: 1rem;">
                            <p><strong>RUT:</strong> ${data.cliente.rut}</p>
                            <p><strong>Nombre:</strong> ${data.cliente.nombre}</p>
                            <p><strong>Direcci√≥n:</strong> ${data.cliente.direccion || 'Sin direcci√≥n'}</p>
                        </div>
                        <hr>
                        <p style="text-align: center; color: #666; font-size: 0.9rem;">
                            El cliente ha sido seleccionado autom√°ticamente.<br>
                            Ahora puedes procesar la preventa.
                        </p>
                    `,
                                timer: 3000,
                                timerProgressBar: true,
                                showConfirmButton: true,
                                confirmButtonText: 'Continuar',
                                confirmButtonColor: '#8B7355'
                            }).then(() => {
                                // Reabrir el modal de procesar preventa con el cliente ya seleccionado
                                console.log('‚úì Reabriendo modal de procesar preventa');
                                procesarPreventa();
                            });
                        } else {
                            console.error('‚úó ERROR: data.success = false');
                            console.error('Mensaje de error:', data.message);

                            Swal.fire({
                                icon: 'error',
                                title: '‚úó Error al Crear Cliente',
                                html: `
                        <div style="text-align: left;">
                            <p><strong>Mensaje:</strong> ${data.message || 'Error desconocido'}</p>
                            <p style="font-size: 0.85rem; color: #666;">
                                Revisa la consola del navegador (F12) para m√°s detalles.
                            </p>
                        </div>
                    `,
                                timer: 5000,
                                timerProgressBar: true
                            });
                        }
                    })
                    .catch(error => {
                        console.error('=== ERROR CAPTURADO ===');
                        console.error('Error completo:', error);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);

                        Swal.fire({
                            icon: 'error',
                            title: '‚úó Error de Conexi√≥n',
                            html: `
                    <div style="text-align: left;">
                        <p><strong>Error:</strong> ${error.message}</p>
                        <hr>
                        <p style="font-size: 0.85rem; color: #666;">
                            <strong>Detalles t√©cnicos:</strong><br>
                            Abre la consola del navegador (F12 ‚Üí Consola) para ver informaci√≥n detallada del error.
                        </p>
                    </div>
                `,
                            timer: 8000,
                            timerProgressBar: true,
                            showConfirmButton: true,
                            confirmButtonText: 'Entendido'
                        });
                    });
            }

            // Procesar preventa con datos
            function processPreventaWithData(data) {
                if (!window.clienteSeleccionado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Cliente Requerido',
                        text: 'Debe seleccionar o crear un cliente',
                        timer: 3000
                    });
                    return;
                }

                // Calcular totales actuales
                let subtotal = 0;
                let descuento = 0;
                let neto = 0;
                let iva = 0;
                let impuestoEspecifico = 0;

                cart.forEach(item => {
                    const precioFinal = parseFloat(item.precio);
                    const precioNeto = parseFloat(item.precio_neto || 0);
                    const ivaItem = parseFloat(item.iva || 0);
                    const impEspItem = parseFloat(item.impuesto_especifico || 0);

                    subtotal += precioFinal * parseFloat(item.cantidad);
                    neto += precioNeto * parseFloat(item.cantidad);
                    iva += ivaItem * parseFloat(item.cantidad);
                    impuestoEspecifico += impEspItem * parseFloat(item.cantidad);
                });

                const total = subtotal;

                // CR√çTICO: El tipo planeado indica el destino final (boleta, factura, guia o vale)
                // Usamos lo que viene de data, o lo que est√° en variables globales como fallback
                const tipoDocPlaneado = data.tipo_documento_planeado || 
                                       (data.tipo_documento === 'ticket' ? window.tipoDocumentoPlaneadoTicket : null) || 
                                       data.tipo_documento;

    // CR√çTICO: Si es un ticket con tipo planeado gu√≠a, usar el tipo_despacho del modal
    const tipoDespachoFinal = (data.tipo_documento === 'ticket' && tipoDocPlaneado === 'guia' && window.tipoDespachoTicket)
        ? window.tipoDespachoTicket
        : data.tipo_despacho || null;

                const preventaData = {
                    estacion_id: window.currentEstacionId,
                    vendedor_id: window.currentVendedorId,
                    tipo_documento: data.tipo_documento,
                    tipo_documento_planeado: tipoDocPlaneado, // ‚Üê GUARDAR TIPO PLANEADO (para vales, el seleccionado; para otros, su propio tipo)
                    tipo_documento_original: data.tipo_documento_original, // ‚Üê AGREGAR TIPO ORIGINAL (CR√çTICO PARA FALLBACK DE VALES)
                    tipo_despacho: tipoDespachoFinal, // ‚Üê USAR TIPO DE DESPACHO DEL MODAL O DEL FORM
                    referencias: data.referencias || [], // ‚Üê AGREGAR REFERENCIAS
                    cliente_id: window.clienteSeleccionado.id,
                    items: cart,
                    totales: {
                        subtotal: subtotal,
                        descuento: descuento,
                        neto: neto,
                        iva: iva,
                        impuesto_especifico: impuestoEspecifico,
                        total: total
                    }
                };

                console.log('[DEBUG] Preventa Data - tipo_documento:', data.tipo_documento, 'tipo_documento_planeado:', tipoDocPlaneado);
                console.log('[DEBUG] data.tipo_despacho (del form):', data.tipo_despacho);
                console.log('[DEBUG] window.tipoDespachoTicket:', window.tipoDespachoTicket);
                console.log('[DEBUG] tipoDespachoFinal calculado:', tipoDespachoFinal);
                console.log('[DEBUG] tipo_despacho enviado:', preventaData.tipo_despacho);
                console.log('[DEBUG] referencias enviadas:', preventaData.referencias);

                console.log('=== DATOS QUE SE ENV√çAN AL SERVIDOR ===');
                console.log('Items del carrito:', cart);
                console.log('Totales:', preventaData.totales);
                console.log('preventaData completo:', JSON.stringify(preventaData, null, 2));
                console.log('========================================');

                // Mostrar loading
                Swal.fire({
                    title: 'Procesando Preventa...',
                    text: 'Generando preventa',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviar datos
                fetch('/ventas/pos/procesar-preventa/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify(preventaData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('='.repeat(80));
                        console.log('[DEBUG] Respuesta del servidor:', data);
                        console.log('[DEBUG] data.cierre_directo:', data.cierre_directo, 'tipo:', typeof data.cierre_directo);
                        console.log('[DEBUG] data.ticket_vale_id:', data.ticket_vale_id);
                        console.log('[DEBUG] ¬øProcesar√° autom√°ticamente?:', data.cierre_directo === true);
                        console.log('='.repeat(80));

                        if (data.success) {
                            // Si es cotizaci√≥n, abrir ventana de impresi√≥n
                            if (data.tipo_documento === 'cotizacion') {
                                Swal.fire({
                                    icon: 'success',
                                    title: '¬°Cotizaci√≥n Generada!',
                                    text: `Cotizaci√≥n #${data.numero_preventa} generada exitosamente`,
                                    timer: 2000
                                }).then(() => {
                                    // Abrir ventana de impresi√≥n de la cotizaci√≥n
                                    window.open(`/ventas/cotizaciones/${data.preventa_id}/html/`, '_blank');

                                    // Limpiar carrito y recargar
                                    cart = [];
                                    updateCartDisplay();
                                    updateTotals();
                                    limpiarClientePOS();

                                    // Limpiar variables de tipo de documento/vale
                                    window.tipoDocumentoPlaneadoVale = null;
                                    window.tipoValeSeleccionado = null;
                                    window.tipoDespachoVale = null;

                                    // Actualizar stock despu√©s de la venta
                                    updateStockFromServer();

                                    // Restaurar modo escaneo si estaba activo
                                    if (wasScanningMode) {
                                        setTimeout(() => {
                                            barcodeMode = true;
                                            const barcodeInput = document.getElementById('barcode-input');
                                            if (barcodeInput) {
                                                barcodeInput.focus();
                                            }
                                        }, 2000);
                                    }
                                });
                            } else if (data.tipo_documento === 'vale') {
                                // VERIFICAR SI HUBO CIERRE DIRECTO (Vale con DTE generado)
                                const esCierreDirectoVale = (
                                    (data.cierre_directo === true || data.cierre_directo === 'true' || data.cierre_directo === 1) &&
                                    data.doc_url
                                );

                                console.log('[VALE] Verificando cierre directo para vale:', {
                                    cierre_directo: data.cierre_directo,
                                    doc_url: data.doc_url,
                                    esCierreDirectoVale: esCierreDirectoVale
                                });

                                if (esCierreDirectoVale) {
                                    // CIERRE DIRECTO: Se gener√≥ DTE, abrir URL del DTE
                                    const nombreDoc = data.tipo_documento_planeado === 'factura' ? 'Factura' :
                                        data.tipo_documento_planeado === 'boleta' ? 'Boleta' :
                                            data.tipo_documento_planeado === 'guia' ? 'Gu√≠a de Despacho' : 'Documento';

                                    Swal.fire({
                                        icon: 'success',
                                        title: '¬°Documento Procesado!',
                                        html: `<strong>${nombreDoc} #${data.numero_venta || data.numero_preventa}</strong><br>procesada autom√°ticamente con cierre directo`,
                                        timer: 2000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        // Abrir documento DTE para impresi√≥n
                                        // El doc_url ya viene con todos los par√°metros necesarios del backend
                                        window.open(data.doc_url, '_blank');

                                        // Limpiar carrito inmediatamente
                                        cart = [];
                                        updateCartDisplay();
                                        updateTotals();
                                        limpiarClientePOS();

                                        // Limpiar variables de tipo de documento/vale
                                        window.tipoDocumentoPlaneadoVale = null;
                                        window.tipoValeSeleccionado = null;
                                        window.tipoDespachoVale = null;

                                        // Actualizar stock
                                        updateStockFromServer();

                                        // Restaurar modo escaneo si estaba activo
                                        if (wasScanningMode) {
                                            setTimeout(() => {
                                                barcodeMode = true;
                                                const barcodeInput = document.getElementById('barcode-input');
                                                if (barcodeInput) {
                                                    barcodeInput.focus();
                                                }
                                            }, 2000);
                                        }
                                    });
                                } else {
                                    // SIN CIERRE DIRECTO: Solo vale, imprimir el vale normalmente
                                    Swal.fire({
                                        icon: 'success',
                                        title: '¬°Vale Generado!',
                                        text: `Vale #${data.numero_preventa} generado exitosamente`,
                                        timer: 2000
                                    }).then(() => {
                                        // IMPRESION DIRECTA CON QZ TRAY
                                        if (typeof QZ_Printers !== 'undefined' && localStorage.getItem('qz_selected_printer')) {
                                            const ticketUrl = `/ventas/vales/${data.preventa_id}/termica/`;
                                            // No bloquear UI, hacerlo en background
                                            QZ_Printers.printTicketFromUrl(ticketUrl).catch(err => {
                                                console.error("Error QZ, fallback to window.open", err);
                                                window.open(`/ventas/vales/${data.preventa_id}/html/`, '_blank');
                                            });
                                        } else {
                                            window.open(`/ventas/vales/${data.preventa_id}/html/`, '_blank');
                                        }

                                        // Limpiar carrito y recargar
                                        cart = [];
                                        updateCartDisplay();
                                        updateTotals();
                                        limpiarClientePOS();

                                        // Limpiar variables de tipo de documento/vale
                                        window.tipoDocumentoPlaneadoVale = null;
                                        window.tipoValeSeleccionado = null;
                                        window.tipoDespachoVale = null;

                                        // Actualizar stock despu√©s de la venta
                                        updateStockFromServer();

                                        // Restaurar modo escaneo si estaba activo
                                        if (wasScanningMode) {
                                            setTimeout(() => {
                                                barcodeMode = true;
                                                const barcodeInput = document.getElementById('barcode-input');
                                                if (barcodeInput) {
                                                    barcodeInput.focus();
                                                }
                                            }, 2000);
                                        }
                                    });
                                }
                            } else if (data.tipo_documento === 'factura' || data.tipo_documento === 'boleta' || data.tipo_documento === 'guia') {
                                // Para factura, boleta o gu√≠a
                                const nombreDocumento = data.tipo_documento === 'factura' ? 'Factura' :
                                    data.tipo_documento === 'boleta' ? 'Boleta' : 'Gu√≠a de Despacho';

                                // CIERRE DIRECTO: Si se proces√≥ autom√°ticamente, abrir documento directamente
                                console.log('='.repeat(80));
                                console.log('[DEBUG] Verificando cierre directo...');
                                console.log('[DEBUG] data.cierre_directo:', data.cierre_directo);
                                console.log('[DEBUG] typeof data.cierre_directo:', typeof data.cierre_directo);
                                console.log('[DEBUG] data.cierre_directo === true:', data.cierre_directo === true);
                                console.log('[DEBUG] data.cierre_directo == true:', data.cierre_directo == true);
                                console.log('[DEBUG] Boolean(data.cierre_directo):', Boolean(data.cierre_directo));
                                console.log('[DEBUG] data.cierre_directo === false:', data.cierre_directo === false);
                                console.log('[DEBUG] data.cierre_directo == false:', data.cierre_directo == false);
                                console.log('[DEBUG] !data.cierre_directo:', !data.cierre_directo);
                                console.log('='.repeat(80));

                                // VERIFICACI√ìN ESTRICTA: Solo procesar autom√°ticamente si cierre_directo es expl√≠citamente true
                                // IMPORTANTE: Verificar expl√≠citamente que NO sea false, undefined, null, 0, o string vac√≠o
                                const esCierreDirecto = (
                                    data.cierre_directo === true ||
                                    data.cierre_directo === 'true' ||
                                    data.cierre_directo === 1
                                ) && (
                                        data.cierre_directo !== false &&
                                        data.cierre_directo !== 'false' &&
                                        data.cierre_directo !== 0 &&
                                        data.cierre_directo !== null &&
                                        data.cierre_directo !== undefined
                                    );

                                console.log('[DEBUG] esCierreDirecto calculado:', esCierreDirecto);
                                console.log('[DEBUG] ¬øProcesar√° autom√°ticamente?:', esCierreDirecto);

                                if (esCierreDirecto === true) {
                                    console.log('[‚úì] CIERRE DIRECTO ACTIVO - Procesando autom√°ticamente');
                                    console.log('[CIERRE DIRECTO] Abriendo documento automaticamente');

                                    Swal.fire({
                                        icon: 'success',
                                        title: '¬°Documento Procesado!',
                                        html: `<strong>${nombreDocumento} #${data.numero_venta}</strong><br>procesada autom√°ticamente con cierre directo`,
                                        timer: 2000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        // Abrir documento para impresi√≥n con autoclose (cierra autom√°ticamente despu√©s de imprimir)
                                        const posUrl = "{% url 'ventas:pos_view' %}";
                                        const separator = data.doc_url.includes('?') ? '&' : '?';
                                        // auto=1: imprime autom√°ticamente
                                        // autoclose=1: cierra la ventana despu√©s de imprimir
                                        // autoclose_delay=2000: espera 2 segundos antes de cerrar
                                        window.open(data.doc_url + separator + 'auto=1&autoclose=1&autoclose_delay=2000&return_url=' + encodeURIComponent(posUrl), '_blank');

                                        // Limpiar carrito inmediatamente (el POS queda listo para siguiente venta)
                                        cart = [];
                                        updateCartDisplay();
                                        updateTotals();
                                        limpiarClientePOS();

                                        // Limpiar variables de tipo de documento/vale
                                        window.tipoDocumentoPlaneadoVale = null;
                                        window.tipoValeSeleccionado = null;
                                        window.tipoDespachoVale = null;

                                        // Actualizar stock
                                        updateStockFromServer();

                                        // Restaurar modo escaneo si estaba activo
                                        if (wasScanningMode) {
                                            setTimeout(() => {
                                                barcodeMode = true;
                                                const barcodeInput = document.getElementById('barcode-input');
                                                if (barcodeInput) {
                                                    barcodeInput.focus();
                                                }
                                            }, 2000);
                                        }
                                    });
                                    return; // IMPORTANTE: Salir aqu√≠ para no continuar
                                }

                                // Sin cierre directo: redirigir a procesar venta normal
                                console.log('='.repeat(80));
                                console.log('[‚úó] CIERRE DIRECTO DESACTIVADO - Redirigiendo a formulario de pago');
                                console.log('[DEBUG] Sin cierre directo - Verificando ticket_vale_id:', data.ticket_vale_id);
                                console.log('='.repeat(80));

                                if (data.ticket_vale_id) {
                                    console.log('[DEBUG] Redirigiendo a procesar venta:', `/caja/procesar-venta/${data.ticket_vale_id}/`);
                                    // Redirigir a Caja para procesar el ticket facturable (el usuario debe completar el formulario)
                                    window.location.href = `/caja/procesar-venta/${data.ticket_vale_id}/`;
                                    return; // IMPORTANTE: Salir aqu√≠
                                } else {
                                    console.log('[DEBUG] No hay ticket_vale_id, mostrando alerta');
                                    // Si por alg√∫n motivo no hay ticket, mostrar alerta informativa
                                    Swal.fire({
                                        icon: 'warning',
                                        title: `Preventa ${nombreDocumento} #${data.numero_preventa} generada`,
                                        text: 'No se recibi√≥ el identificador del ticket facturable. Por favor procese desde Caja > Procesar Venta.',
                                        timer: 3000
                                    });
                                }
                            } else {
                                // CASO: TICKET / TICKET FACTURABLE / PREVENTA
                                // Si hubo cierre directo (se gener√≥ DTE), el backend devuelve doc_url
                                const esCierreDirectoTicket = (
                                    (data.cierre_directo === true || data.cierre_directo === 'true' || data.cierre_directo === 1) &&
                                    data.doc_url
                                );

                                if (esCierreDirectoTicket) {
                                    // CIERRE DIRECTO: Abrir DTE directamente
                                    const nombreDoc = data.tipo_documento_planeado === 'factura' ? 'Factura' :
                                                      data.tipo_documento_planeado === 'boleta' ? 'Boleta' :
                                                      data.tipo_documento_planeado === 'guia' ? 'Gu√≠a de Despacho' : 'Documento';

                                    Swal.fire({
                                        icon: 'success',
                                        title: '¬°Documento Procesado!',
                                        html: `<strong>${nombreDoc} #${data.numero_venta}</strong><br>procesada autom√°ticamente con cierre directo`,
                                        timer: 2000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        window.open(data.doc_url, '_blank');
                                        
                                        // Limpiar carrito y recargar
                                        cart = [];
                                        updateCartDisplay();
                                        updateTotals();
                                        limpiarClientePOS();
                                        window.tipoDocumentoPlaneadoVale = null;
                                        window.tipoValeSeleccionado = null;
                                        window.tipoDespachoVale = null;
                                        updateStockFromServer();
                                        if (wasScanningMode) {
                                            setTimeout(() => {
                                                barcodeMode = true;
                                                const barcodeInput = document.getElementById('barcode-input');
                                                if (barcodeInput) barcodeInput.focus();
                                            }, 2000);
                                        }
                                    });
                                } else {
                                    // NO CIERRE DIRECTO: Imprimir ticket (vale) para validaci√≥n en caja
                                    Swal.fire({
                                        icon: 'success',
                                        title: '¬°Vale Generado!',
                                        text: `Ticket #${data.numero_preventa} generado para validaci√≥n en caja`,
                                        timer: 2000
                                    }).then(() => {
                                        // IMPRESION DEL TICKET (Vale facturable)
                                        const ticketId = data.preventa_id || data.id;
                                        if (ticketId) {
                                            if (typeof QZ_Printers !== 'undefined' && localStorage.getItem('qz_selected_printer')) {
                                                const ticketUrl = `/ventas/vales/${ticketId}/termica/`;
                                                QZ_Printers.printTicketFromUrl(ticketUrl).catch(err => {
                                                    console.error("Error QZ, fallback to window.open", err);
                                                    window.open(`/ventas/vales/${ticketId}/html/`, '_blank');
                                                });
                                            } else {
                                                window.open(`/ventas/vales/${ticketId}/html/`, '_blank');
                                            }
                                        }

                                        // Limpiar carrito y recargar
                                        cart = [];
                                        updateCartDisplay();
                                        updateTotals();
                                        limpiarClientePOS();
                                        window.tipoDocumentoPlaneadoVale = null;
                                        window.tipoValeSeleccionado = null;
                                        window.tipoDespachoVale = null;
                                        updateStockFromServer();
                                        if (wasScanningMode) {
                                            setTimeout(() => {
                                                barcodeMode = true;
                                                const barcodeInput = document.getElementById('barcode-input');
                                                if (barcodeInput) barcodeInput.focus();
                                            }, 2000);
                                        }
                                    });
                                }
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message || 'Error al procesar la preventa',
                                timer: 3000
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al procesar preventa:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: `Error al procesar la preventa: ${error.message}`,
                            timer: 3000
                        });
                    });
            }

            // Event listener para el bot√≥n de crear cliente
            document.addEventListener('click', function (e) {
                // Verificar si el click fue en el bot√≥n o en alg√∫n elemento hijo (como el √≠cono)
                const btnCrearCliente = e.target.closest('#btn-crear-cliente');
                if (btnCrearCliente) {
                    e.preventDefault();
                    e.stopPropagation();
                    crearCliente();
                }
            });

            // Cerrar funci√≥n DOMContentLoaded
            console.log('*** DOMContentLoaded FINALIZADO ***');
        });

        // ===== FUNCIONES AUXILIARES =====

        function limpiarClientePOS() {
            try {
                const rutInput = document.getElementById('busqueda-cliente');
                if (rutInput) { rutInput.value = ''; }
                window.clienteSeleccionado = null;
                const resultados = document.getElementById('resultados-busqueda');
                if (resultados) { resultados.style.display = 'none'; }
                const info = document.getElementById('cliente-info');
                if (info) { info.style.display = 'none'; }
                const noEncontrado = document.getElementById('cliente-no-encontrado');
                if (noEncontrado) { noEncontrado.style.display = 'none'; }
                const header = document.getElementById('clienteEnHeader');
                if (header) { header.innerHTML = ''; }
            } catch (e) { console.error(e); }
        }

        // Cargar art√≠culos desde el DOM
        function loadArticulosFromDOM() {
            console.log('*** CARGANDO ART√çCULOS DESDE DOM ***');

            const productCards = document.querySelectorAll('.pos-product-card');
            articulos = [];

            productCards.forEach(card => {
                const articulo = {
                    id: parseInt(card.dataset.articuloId),
                    nombre: card.querySelector('.pos-product-name').textContent.trim(),
                    precio: parseFloat(card.dataset.precio),
                    stock: parseInt(card.dataset.stock),
                    categoria: card.dataset.categoria
                };
                articulos.push(articulo);
            });

            window.articulos = articulos;
            console.log('*** ART√çCULOS CARGADOS: ', articulos.length, ' ***');

            // Actualizar stock en tiempo real
            updateStockFromServer();
        }

        // Funci√≥n para actualizar stock desde servidor
        function updateStockFromServer() {
            console.log('*** ACTUALIZANDO STOCK DESDE SERVIDOR ***');

            // Obtener IDs de art√≠culos
            const articuloIds = articulos.map(a => a.id);

            if (articuloIds.length === 0) return;

            // Hacer petici√≥n AJAX para obtener stock actual
            fetch('/articulos/stock-actual/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    articulo_ids: articuloIds
                })
            })
                .then(response => {
                    console.log('*** RESPUESTA STOCK: ', response.status, ' ***');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('*** DATOS STOCK RECIBIDOS: ', data, ' ***');

                    if (data.success && data.stocks) {
                        console.log('*** STOCK ACTUALIZADO: ', data.stocks, ' ***');

                        // Actualizar cada tarjeta de producto
                        document.querySelectorAll('.pos-product-card').forEach(card => {
                            const articuloId = parseInt(card.dataset.articuloId);
                            const stockActual = data.stocks[articuloId] || 0;

                            console.log(`*** ACTUALIZANDO ART√çCULO ${articuloId}: stock ${stockActual} ***`);

                            // Actualizar data-stock
                            card.dataset.stock = stockActual;

                            // Actualizar display de stock
                            const stockElement = card.querySelector('.pos-product-stock');
                            if (stockElement) {
                                stockElement.textContent = `Stock: ${stockActual}`;
                                stockElement.className = `pos-product-stock ${stockActual <= 0 ? 'text-danger' : ''}`;
                            }

                            // Actualizar clase disabled
                            if (stockActual <= 0) {
                                card.classList.add('disabled');
                                console.log(`*** ART√çCULO ${articuloId} DESHABILITADO (sin stock) ***`);
                            } else {
                                card.classList.remove('disabled');
                                console.log(`*** ART√çCULO ${articuloId} HABILITADO (con stock: ${stockActual}) ***`);
                            }

                            // Actualizar array de art√≠culos
                            const articulo = articulos.find(a => a.id === articuloId);
                            if (articulo) {
                                articulo.stock = stockActual;
                            }
                        });

                        console.log('*** STOCK VISUALIZACI√ìN ACTUALIZADA ***');
                    } else {
                        console.log('*** ERROR AL ACTUALIZAR STOCK: ', data.message || data.error, ' ***');
                    }
                })
                .catch(error => {
                    console.error('*** ERROR AL ACTUALIZAR STOCK: ', error.message || error, ' ***');
                });
        }

        // ===== SISTEMA DE C√ìDIGOS DE BARRAS =====

        // Variables globales para c√≥digos de barras
        let barcodeTimeout;
        let isScanning = false;
        let barcodeMode = true; // Por defecto activado para escaneo continuo
        let lastProcessedCode = ''; // Para evitar procesar el mismo c√≥digo repetidamente
        let lastProcessedTime = 0; // Timestamp del √∫ltimo procesamiento

        // Configurar el sistema de c√≥digos de barras
        function setupBarcodeSystem() {
            console.log('*** CONFIGURANDO SISTEMA DE C√ìDIGOS DE BARRAS ***');

            const barcodeInput = document.getElementById('barcode-input');
            const barcodeStatus = document.getElementById('barcode-status');

            // Mantener el foco siempre en el campo de c√≥digo de barras
            function focusBarcodeInput() {
                barcodeInput.focus();
                console.log('*** FOCO EN C√ìDIGO DE BARRAS ***');
            }

            // Event listener para detecci√≥n de escaneo
            barcodeInput.addEventListener('input', function (e) {
                const value = e.target.value.trim();

                // Limpiar timeout anterior
                if (barcodeTimeout) {
                    clearTimeout(barcodeTimeout);
                    console.log('*** TIMEOUT ANTERIOR LIMPIADO ***');
                }

                // Procesar c√≥digos de barras largos autom√°ticamente (8+ caracteres)
                // O c√≥digos cortos despu√©s de un delay (para c√≥digos comod√≠n como "001")
                if (value.length >= 8) {
                    console.log('*** ENTRADA DETECTADA (c√≥digo largo): ' + value + ' ***');

                    // Cambiar estado a "escaneando"
                    setBarcodeStatus('scanning', 'Escaneando...', 'fas fa-spinner fa-spin');

                    // Esperar un poco m√°s para capturar todo el c√≥digo
                    barcodeTimeout = setTimeout(() => {
                        console.log('*** EJECUTANDO TIMEOUT PARA: ' + value + ' ***');
                        processBarcode(value);
                    }, 300); // Aumentar tiempo para evitar duplicados
                } else if (value.length >= 1) {
                    // Para c√≥digos cortos (como c√≥digos comod√≠n), esperar un poco m√°s antes de procesar
                    console.log('*** ENTRADA DETECTADA (c√≥digo corto): ' + value + ' ***');
                    barcodeTimeout = setTimeout(() => {
                        console.log('*** EJECUTANDO TIMEOUT PARA C√ìDIGO CORTO: ' + value + ' ***');
                        processBarcode(value);
                    }, 800); // Delay m√°s largo para c√≥digos cortos
                }
            });

            // Event listener para Enter (manualmente escrito)
            barcodeInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value.length >= 1) { // Permitir cualquier c√≥digo cuando se presiona Enter
                        processBarcode(value);
                    }
                }
            });

            // Establecer foco inicial para escaneo
            focusBarcodeInput();

            // Mantener foco despu√©s de buscar productos
            // Mantener foco siempre en el campo de c√≥digo de barras
            barcodeInput.addEventListener('blur', function () {
                // Solo restaurar foco si no se est√° interactuando con otros elementos
                setTimeout(() => {
                    const activeElement = document.activeElement;
                    const isInteractingWithForm = activeElement && (
                        activeElement.tagName === 'SELECT' ||
                        activeElement.tagName === 'INPUT' ||
                        activeElement.tagName === 'TEXTAREA' ||
                        activeElement.closest('.swal2-container') ||
                        activeElement.closest('#tipo-documento') ||
                        activeElement.closest('#estacion-trabajo') ||
                        activeElement.closest('#busqueda-cliente')
                    );

                    if (!isInteractingWithForm && barcodeMode) {
                        focusBarcodeInput();
                        console.log('*** FOCO RESTAURADO DESPU√âS DE BLUR ***');
                    }
                }, 500); // Aumentar delay para permitir interacci√≥n completa
            });

            // No modificar processSale si no existe a√∫n
            // Se manejar√° despu√©s de que se defina

            console.log('*** SISTEMA DE C√ìDIGOS DE BARRAS CONFIGURADO ***');

            // Configurar funciones despu√©s de que est√©n definidas
            setTimeout(() => {
                setupBarcodeSystemLate();
            }, 1000);

            // Event listener global para restaurar foco despu√©s de cualquier interacci√≥n
            document.addEventListener('click', function (e) {
                // Excluir botones de cerrar documento y otros botones cr√≠ticos
                const isExcludedElement = e.target.closest('#btn-cerrar-documento') ||
                    e.target.closest('.btn-cerrar') ||
                    e.target.closest('#btn-clear') ||
                    e.target.closest('#btn-process') ||
                    e.target.closest('#tipo-documento') ||
                    e.target.closest('#estacion-trabajo') ||
                    e.target.closest('#busqueda-cliente') ||
                    e.target.closest('.form-control') ||
                    e.target.closest('.form-select') ||
                    e.target.closest('select') ||
                    e.target.closest('input[type="text"]') ||
                    e.target.closest('input[type="number"]') ||
                    e.target.closest('input[type="email"]') ||
                    e.target.closest('textarea') ||
                    e.target.closest('.swal2-container') ||
                    e.target.closest('.swal2-popup') ||
                    e.target.closest('button[onclick*="cerrar"]') ||
                    e.target.closest('button[onclick*="limpiar"]') ||
                    e.target.closest('button[onclick*="clearCart"]') ||
                    e.target.closest('button[onclick*="processSale"]') ||
                    e.target.closest('.btn-danger') ||
                    e.target.closest('.btn-warning');

                // Solo restaurar foco para productos espec√≠ficamente
                if (!isExcludedElement && e.target.closest('.pos-product-card')) {
                    setTimeout(() => {
                        const barcodeInput = document.getElementById('barcode-input');
                        if (barcodeInput && !barcodeInput.disabled && barcodeMode) {
                            barcodeInput.focus();
                            console.log('*** FOCO RESTAURADO DESPU√âS DE CLICK EN PRODUCTO ***');
                        }
                    }, 300);
                }
            });
        }

        // Configurar funciones tard√≠as del sistema de c√≥digos de barras
        function setupBarcodeSystemLate() {
            console.log('*** CONFIGURANDO FUNCIONES TARD√çAS ***');

            // Modificar processSale si existe
            if (typeof processSale === 'function') {
                const originalProcessSale = processSale;
                window.processSale = function () {
                    const result = originalProcessSale();
                    // Solo restaurar foco despu√©s de una venta exitosa si el modo est√° activado
                    if (barcodeMode) {
                        setTimeout(() => {
                            if (document.activeElement === document.body) {
                                document.getElementById('barcode-input').focus();
                            }
                        }, 500);
                    }
                    return result;
                };
                console.log('*** PROCESSSALE CONFIGURADO ***');
            }

            // Modificar updateCartDisplay si existe
            if (typeof updateCartDisplay === 'function') {
                const originalUpdateCartDisplay = updateCartDisplay;
                window.updateCartDisplay = function () {
                    originalUpdateCartDisplay();
                    // Restaurar foco si el modo est√° activado
                    if (barcodeMode) {
                        setTimeout(() => {
                            if (document.activeElement === document.body) {
                                document.getElementById('barcode-input').focus();
                            }
                        }, 100);
                    }
                };
                console.log('*** UPDATECARTDISPLAY CONFIGURADO ***');
            }
        }

        // Procesar el c√≥digo de barras escaneado
        async function processBarcode(codigo) {
            console.log('*** PROCESANDO C√ìDIGO: ' + codigo + ' ***');
            console.log('*** isScanning actual: ' + isScanning + ' ***');

            // Verificar si ya se proces√≥ este c√≥digo recientemente (dentro de 2 segundos)
            const currentTime = Date.now();
            if (codigo === lastProcessedCode && (currentTime - lastProcessedTime) < 2000) {
                console.log('*** C√ìDIGO YA PROCESADO RECIENTEMENTE - IGNORANDO ***');
                return;
            }

            if (isScanning) {
                console.log('*** YA SE EST√Å PROCESANDO UN C√ìDIGO - IGNORANDO ***');
                return;
            }

            isScanning = true;
            lastProcessedCode = codigo;
            lastProcessedTime = currentTime;
            console.log('*** MARCANDO COMO ESCANEANDO ***');
            setBarcodeStatus('scanning', 'Buscando producto...', 'fas fa-search');

            // PRIMERO: Verificar si es c√≥digo comod√≠n usando la API del POS
            const listaPrecioActual = window.listaPrecioActual || '';
            let urlComodin = `/ventas/pos/buscar-articulo/?q=${encodeURIComponent(codigo)}`;
            if (listaPrecioActual) {
                urlComodin += `&lista_precio=${listaPrecioActual}`;
            }

            try {
                const responseComodin = await fetch(urlComodin);
                const dataComodin = await responseComodin.json();
                console.log('*** RESPUESTA B√öSQUEDA POS: ', dataComodin, ' ***');
                console.log('*** VERIFICANDO es_comodin: ', dataComodin.es_comodin, ' (tipo: ', typeof dataComodin.es_comodin, ') ***');

                // Si es c√≥digo comod√≠n, mostrar modal
                if (dataComodin.es_comodin === true || dataComodin.es_comodin === 'true') {
                    console.log('*** ‚úì‚úì‚úì C√ìDIGO COMOD√çN DETECTADO ‚úì‚úì‚úì ***');
                    console.log('*** VERIFICANDO FUNCI√ìN mostrarModalProductoComodin: ', typeof mostrarModalProductoComodin, ' ***');

                    isScanning = false;
                    clearBarcodeInput();
                    setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');

                    // Verificar que la funci√≥n exista antes de llamarla
                    if (typeof window.mostrarModalProductoComodin === 'function') {
                        console.log('*** LLAMANDO mostrarModalProductoComodin() ***');
                        window.mostrarModalProductoComodin();
                    } else if (typeof mostrarModalProductoComodin === 'function') {
                        console.log('*** LLAMANDO mostrarModalProductoComodin() (sin window) ***');
                        mostrarModalProductoComodin();
                    } else {
                        console.error('*** ERROR: mostrarModalProductoComodin no est√° definida ***');
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Funci√≥n de modal no disponible. Recarga la p√°gina.',
                            timer: 3000
                        });
                    }
                    return;
                }

                // Si hay art√≠culos encontrados, usar el primero
                if (dataComodin.articulos && dataComodin.articulos.length > 0) {
                    const articulo = dataComodin.articulos[0];
                    console.log('*** PRODUCTO ENCONTRADO EN POS: ', articulo, ' ***');

                    await addToCart(
                        articulo.id,
                        articulo.nombre || articulo.descripcion,
                        articulo.precio,
                        articulo.stock || 0,
                        articulo.categoria_exenta_iva || false,
                        articulo.impuesto_especifico_porcentaje || 0
                    );

                    console.log('*** CARRITO DESPU√âS DE AGREGAR:', cart);

                    setBarcodeStatus('ready', 'Producto agregado', 'fas fa-check-circle');

                    setTimeout(() => {
                        clearBarcodeInput();
                        setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                    }, 1000);

                    isScanning = false;
                    return;
                }
            } catch (error) {
                console.error('Error en b√∫squeda POS:', error);
            }

            // Si no se encontr√≥ en POS, buscar por c√≥digo de barras tradicional
            fetch(`/articulos/buscar-por-codigo-barras/?codigo=${encodeURIComponent(codigo)}`)
                .then(response => response.json())
                .then(async data => {
                    console.log('*** RESPUESTA B√öSQUEDA: ', data, ' ***');

                    if (data.success && data.articulo) {
                        console.log('*** PRODUCTO ENCONTRADO: ', data.articulo, ' ***');

                        // Buscar el producto en la lista de productos del POS
                        const productos = window.articulos || [];
                        const producto = productos.find(p => p.id == data.articulo.id);

                        // Si el producto est√° en la lista del POS, usar sus datos
                        // Si no est√°, usar los datos del backend directamente
                        const precio = producto ? producto.precio : parseFloat(data.articulo.precio_final || data.articulo.precio_venta || 0);
                        const stock = producto ? producto.stock : 100; // Asumir stock disponible si no est√° en la lista
                        const categoriaExentaIva = producto ? producto.categoria_exenta_iva : (data.articulo.categoria_exenta_iva || false);
                        const impuestoEspecifico = producto ? producto.impuesto_especifico_porcentaje : (data.articulo.impuesto_especifico_porcentaje || 0);

                        // Agregar al carrito con todos los par√°metros necesarios
                        console.log('*** LLAMANDO addToCart con par√°metros:', {
                            id: data.articulo.id,
                            nombre: data.articulo.nombre,
                            precio: precio,
                            stock: stock,
                            categoriaExentaIva: categoriaExentaIva,
                            impuestoEspecifico: impuestoEspecifico
                        });

                        await addToCart(
                            data.articulo.id,
                            data.articulo.nombre,
                            precio,
                            stock,
                            categoriaExentaIva,
                            impuestoEspecifico
                        );

                        console.log('*** CARRITO DESPU√âS DE AGREGAR:', cart);

                        setBarcodeStatus('ready', 'Producto agregado', 'fas fa-check-circle');

                        // Limpiar el campo despu√©s de un breve delay
                        setTimeout(() => {
                            clearBarcodeInput();
                            setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                        }, 1000);
                    } else {
                        console.log('*** PRODUCTO NO ENCONTRADO ***');
                        setBarcodeStatus('error', 'Producto no encontrado', 'fas fa-exclamation-triangle');
                        setTimeout(() => {
                            clearBarcodeInput();
                            setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                            // Restaurar foco solo si no hay otra interacci√≥n
                            setTimeout(() => {
                                if (document.activeElement === document.body ||
                                    document.activeElement === document.getElementById('barcode-input')) {
                                    document.getElementById('barcode-input').focus();
                                }
                            }, 100);
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('*** ERROR AL BUSCAR: ', error, ' ***');
                    setBarcodeStatus('error', 'Error de conexi√≥n', 'fas fa-exclamation-triangle');
                    setTimeout(() => {
                        clearBarcodeInput();
                        setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                        // Restaurar foco solo si no hay otra interacci√≥n
                        setTimeout(() => {
                            if (document.activeElement === document.body ||
                                document.activeElement === document.getElementById('barcode-input')) {
                                document.getElementById('barcode-input').focus();
                            }
                        }, 100);
                    }, 2000);
                })
                .finally(() => {
                    console.log('*** FINALIZANDO ESCANEO - RESETEANDO isScanning ***');
                    isScanning = false;
                });
        }

        // Funci√≥n para mostrar modal de producto comod√≠n (GLOBAL)
        window.mostrarModalProductoComodin = function () {
            Swal.fire({
                title: '<i class="fas fa-magic me-2"></i>Producto Comod√≠n',
                html: `
            <div class="text-start">
                <div class="mb-3">
                    <label class="form-label fw-bold">Nombre/Descripci√≥n del Producto *</label>
                    <input type="text" id="comodin-nombre" class="form-control" placeholder="Ej: Servicio de instalaci√≥n, Producto especial, etc." autofocus>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Precio Unitario *</label>
                    <input type="number" id="comodin-precio" class="form-control" placeholder="0" min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label class="form-label">Cantidad</label>
                    <input type="number" id="comodin-cantidad" class="form-control" value="1" min="1" step="1">
                </div>
                <small class="text-muted d-block">
                    <i class="fas fa-info-circle me-1"></i>
                    Este producto se agregar√° al carrito con el nombre y precio que ingreses.
                </small>
            </div>
        `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-plus me-2"></i>Agregar al Carrito',
                cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                confirmButtonColor: '#8B7355',
                cancelButtonColor: '#6c757d',
                width: '500px',
                didOpen: () => {
                    document.getElementById('comodin-nombre').focus();
                },
                preConfirm: () => {
                    const nombre = document.getElementById('comodin-nombre').value.trim();
                    const precio = parseFloat(document.getElementById('comodin-precio').value);
                    const cantidad = parseFloat(document.getElementById('comodin-cantidad').value) || 1;

                    if (!nombre) {
                        Swal.showValidationMessage('Debe ingresar un nombre/descripci√≥n para el producto');
                        return false;
                    }

                    if (!precio || precio <= 0) {
                        Swal.showValidationMessage('Debe ingresar un precio v√°lido mayor a 0');
                        return false;
                    }

                    if (cantidad <= 0) {
                        Swal.showValidationMessage('La cantidad debe ser mayor a 0');
                        return false;
                    }

                    return { nombre, precio, cantidad };
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    agregarProductoComodinAlCarrito(result.value.nombre, result.value.precio, result.value.cantidad);
                }
            });
        };

        // Tambi√©n definir como funci√≥n normal para compatibilidad
        function mostrarModalProductoComodin() {
            window.mostrarModalProductoComodin();
        }

        // Funci√≥n para agregar producto comod√≠n al carrito
        function agregarProductoComodinAlCarrito(nombre, precio, cantidad) {
            // Calcular impuestos (asumir que tiene IVA por defecto)
            const precioNeto = precio / 1.19;
            const iva = precioNeto * 0.19;
            const impuestoEspecifico = 0;

            // Crear un objeto de producto comod√≠n
            const productoComodin = {
                articuloId: null, // Sin ID porque no existe en la BD
                nombre: nombre,
                precio: precio, // Precio final con IVA incluido
                precio_neto: precioNeto,
                iva: iva,
                impuesto_especifico: impuestoEspecifico,
                categoriaExentaIva: false,
                impuestoEspecifico: 0,
                cantidad: cantidad,
                stock: 999, // Stock ilimitado para productos comod√≠n
                esComodin: true, // Marcar como producto comod√≠n
                total: precio * cantidad,
                descuento: 0
            };

            // Agregar al carrito
            cart.push(productoComodin);

            // Actualizar visualizaci√≥n
            updateCartDisplay();
            updateTotals();

            // Limpiar input de c√≥digo de barras
            clearBarcodeInput();

            // Mostrar confirmaci√≥n
            Swal.fire({
                icon: 'success',
                title: '¬°Producto Agregado!',
                text: `${nombre} agregado al carrito`,
                timer: 1500,
                showConfirmButton: false
            });

            // Restaurar foco al input de c√≥digo de barras
            setTimeout(() => {
                const barcodeInput = document.getElementById('barcode-input');
                if (barcodeInput) {
                    barcodeInput.focus();
                }
            }, 500);
        }

        // Cambiar el estado visual del c√≥digo de barras
        function setBarcodeStatus(type, message, icon) {
            const status = document.getElementById('barcode-status');
            status.className = `pos-barcode-status ${type}`;
            status.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
        }

        // Limpiar el campo de c√≥digo de barras
        function clearBarcodeInput() {
            const input = document.getElementById('barcode-input');
            input.value = '';
            console.log('*** CAMPO DE C√ìDIGO DE BARRAS LIMPIADO ***');

            // Solo hacer foco si el modo est√° activado
            if (barcodeMode) {
                setTimeout(() => {
                    if (document.activeElement === document.body) {
                        input.focus();
                    }
                }, 100);
            }
        }

        // Alternar modo de escaneo
        function toggleBarcodeMode() {
            barcodeMode = !barcodeMode;
            const barcodeInput = document.getElementById('barcode-input');
            const barcodeStatus = document.getElementById('barcode-status');
            const barcodeToggle = document.getElementById('barcode-toggle');

            if (barcodeMode) {
                // Activar modo escaneo
                barcodeInput.disabled = false;
                setBarcodeStatus('ready', 'Listo para escanear', 'fas fa-check-circle');
                barcodeToggle.innerHTML = '<i class="fas fa-barcode"></i> Modo Escaneo';
                barcodeToggle.style.background = '#17a2b8';
                console.log('*** MODO ESCANEO ACTIVADO ***');
                // Solo hacer foco si no hay otra interacci√≥n
                setTimeout(() => {
                    if (document.activeElement === document.body) {
                        barcodeInput.focus();
                    }
                }, 100);
            } else {
                // Desactivar modo escaneo
                barcodeInput.disabled = true;
                barcodeInput.blur();
                setBarcodeStatus('disabled', 'Modo escaneo desactivado', 'fas fa-ban');
                barcodeToggle.innerHTML = '<i class="fas fa-mouse-pointer"></i> Modo Manual';
                barcodeToggle.style.background = '#28a745';
                console.log('*** MODO ESCANEO DESACTIVADO ***');
            }
        }

        // Funci√≥n global para agregar producto al carrito desde cualquier lugar
        async function addToCartFromAnywhere(articuloId, nombre, precio, cantidad = 1, fromKit = false) {
            console.log('*** AGREGANDO AL CARRITO DESDE CUALQUIER LUGAR ***');
            if (fromKit) {
                console.log('*** ITEM MARCADO COMO DEL KIT (cantidad bloqueada) ***');
            }

            // Buscar el producto en la lista de productos para obtener informaci√≥n de categor√≠a
            const productos = window.articulos || [];
            const producto = productos.find(p => p.id == articuloId);

            let categoriaExentaIva = false;
            let impuestoEspecifico = 0;
            let precioNeto = null;

            if (producto) {
                categoriaExentaIva = producto.categoria && producto.categoria.exenta_iva;
                impuestoEspecifico = producto.categoria && producto.categoria.impuesto_especifico ?
                    parseFloat(producto.categoria.impuesto_especifico.get_porcentaje_decimal) : 0;

                // Calcular precio neto desde el precio proporcionado (que incluye IVA)
                // Si el precio fue ajustado proporcionalmente, calcular el neto correcto
                precioNeto = Math.round(precio / 1.19);
            }

            // Usar la funci√≥n addToCart con toda la informaci√≥n
            await addToCart(articuloId, nombre, precio, 1000, categoriaExentaIva, impuestoEspecifico, precioNeto, fromKit);

            // Actualizar visualizaci√≥n
            if (typeof updateCartDisplay === 'function') {
                updateCartDisplay();
            } else {
                updateCartDisplayManual();
            }

            if (typeof updateTotals === 'function') {
                updateTotals();
            } else {
                updateTotalsManual();
            }

            // Restaurar foco en c√≥digo de barras despu√©s de un breve delay
            setTimeout(() => {
                const barcodeInput = document.getElementById('barcode-input');
                if (barcodeInput) {
                    barcodeInput.focus();
                    console.log('*** FOCO RESTAURADO EN C√ìDIGO DE BARRAS ***');
                }
            }, 100);
        }

        // FUNCI√ìN DUPLICADA ELIMINADA - Se usa la funci√≥n addToCart principal (l√≠nea 1057)
        // que tiene la firma completa: addToCart(articuloId, nombre, precio, stock, categoriaExentaIva, impuestoEspecifico, precioNeto)

        // Funci√≥n manual para actualizar la visualizaci√≥n del carrito
        function updateCartDisplayManual() {
            console.log('*** ACTUALIZANDO CARRITO MANUALMENTE ***');

            const cartContainer = document.getElementById('pos-cart-items');
            if (!cartContainer) {
                console.log('*** ERROR: No se encontr√≥ el contenedor del carrito ***');
                return;
            }

            // Limpiar el contenedor
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                cartContainer.innerHTML = '<div class="pos-cart-empty">No hay productos en el carrito</div>';
                return;
            }

            // Agregar cada item del carrito
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'pos-cart-item';
                itemDiv.innerHTML = `
            <div class="cart-item-name">${item.nombre}</div>
            <div class="cart-item-price">$${window.formatChileanNumber ? window.formatChileanNumber(item.precio) : Math.round(item.precio).toLocaleString('es-CL')}</div>
            <div class="cart-item-qty">
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                <span>${item.cantidad}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <div class="cart-item-discount">${item.descuento}%</div>
            <div class="cart-item-total">$${window.formatChileanNumber ? window.formatChileanNumber(item.total) : Math.round(item.total).toLocaleString('es-CL')}</div>
            <div class="cart-item-actions">
                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
                cartContainer.appendChild(itemDiv);
            });

            // Scroll autom√°tico al √∫ltimo item agregado
            setTimeout(() => {
                cartContainer.scrollTop = cartContainer.scrollHeight;
            }, 50);

            console.log('*** CARRITO VISUALIZADO MANUALMENTE ***');
        }

        // Funci√≥n manual para actualizar los totales
        function updateTotalsManual() {
            console.log('*** ACTUALIZANDO TOTALES MANUALMENTE ***');

            // Calcular totales
            let subtotal = 0;
            let descuento = 0;
            let neto = 0;
            let iva = 0;
            let impuestoEspecifico = 0;

            cart.forEach(item => {
                const precioFinal = parseFloat(item.precio);
                const precioNeto = parseFloat(item.precio_neto || 0);
                const ivaItem = parseFloat(item.iva || 0);
                const impEspItem = parseFloat(item.impuesto_especifico || 0);

                subtotal += precioFinal * parseFloat(item.cantidad);
                neto += precioNeto * parseFloat(item.cantidad);
                iva += ivaItem * parseFloat(item.cantidad);
                impuestoEspecifico += impEspItem * parseFloat(item.cantidad);
            });

            const total = subtotal;

            // Actualizar elementos en el DOM
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    const formattedValue = window.formatChileanNumber ? window.formatChileanNumber(value) : Math.round(value).toLocaleString('es-CL');
                    element.textContent = `$${formattedValue}`;
                } else {
                    console.log(`*** ERROR: Elemento ${id} no encontrado ***`);
                }
            };

            updateElement('subtotal', subtotal);
            updateElement('descuento', descuento);
            updateElement('neto', neto);
            updateElement('iva', iva);
            updateElement('impuesto_especifico', impuestoEspecifico);
            updateElement('total', total);

            console.log('*** TOTALES ACTUALIZADOS MANUALMENTE ***');
            console.log('Subtotal:', subtotal);
            console.log('Total:', total);
        }

        // Funci√≥n para actualizar cantidad de un item en el carrito
        function updateQuantity(index, change) {
            if (cart[index]) {
                cart[index].cantidad += change;
                if (cart[index].cantidad <= 0) {
                    cart.splice(index, 1);
                } else {
                    cart[index].total = cart[index].precio * cart[index].cantidad;
                    // Recalcular impuestos seg√∫n la cantidad
                    cart[index].precio_neto_total = cart[index].precio_neto * cart[index].cantidad;
                    cart[index].iva_total = cart[index].iva * cart[index].cantidad;
                    cart[index].impuesto_especifico_total = cart[index].impuesto_especifico * cart[index].cantidad;
                }

                // Actualizar visualizaci√≥n
                if (typeof updateCartDisplay === 'function') {
                    updateCartDisplay();
                } else {
                    updateCartDisplayManual();
                }

                if (typeof updateTotals === 'function') {
                    updateTotals();
                } else {
                    updateTotalsManual();
                }
            }
        }

        // Funci√≥n para remover un item del carrito
        function removeFromCart(index) {
            if (cart[index]) {
                cart.splice(index, 1);

                // Actualizar visualizaci√≥n
                if (typeof updateCartDisplay === 'function') {
                    updateCartDisplay();
                } else {
                    updateCartDisplayManual();
                }

                if (typeof updateTotals === 'function') {
                    updateTotals();
                } else {
                    updateTotalsManual();
                }
            }
        }

        // Funci√≥n global para seleccionar cliente
        function seleccionarCliente(id, nombre, rut, direccion) {
            // Limpiar datos
            id = String(id).trim().replace(/\s+/g, '');
            nombre = String(nombre).trim();
            rut = String(rut).trim();
            direccion = String(direccion).trim();

            console.log('=== SELECCIONANDO CLIENTE (B√öSQUEDA) ===');
            console.log('ID (limpio):', id, 'Tipo:', typeof id);
            console.log('Nombre:', nombre);
            console.log('RUT:', rut, 'Tipo:', typeof rut);
            console.log('Direcci√≥n:', direccion);

            // Ocultar resultados de b√∫squeda
            document.getElementById('resultados-busqueda').style.display = 'none';

            // Mostrar informaci√≥n del cliente seleccionado
            document.getElementById('cliente-nombre').textContent = nombre;
            document.getElementById('cliente-direccion').textContent = direccion || 'Sin direcci√≥n';
            document.getElementById('cliente-info').style.display = 'block';

            // Guardar cliente seleccionado
            window.clienteSeleccionado = {
                id: id,
                nombre: nombre,
                rut: rut,
                rut_formatted: rut,
                direccion: direccion
            };

            console.log('Cliente guardado en window.clienteSeleccionado:', window.clienteSeleccionado);

            // Mostrar cliente en header
            const clienteHeader = document.getElementById('clienteEnHeader');
            if (clienteHeader) {
                clienteHeader.innerHTML = `
            <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                <strong style="color: white; font-size: 0.95rem;">${nombre}</strong>
                <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-exchange-alt me-1"></i>Cambiar
                </button>
            </div>
        `;
            }

            // Actualizar el campo de b√∫squeda con el RUT
            document.getElementById('busqueda-cliente').value = rut;
        }

        // Funci√≥n para mostrar historial de tickets del d√≠a
        function mostrarHistorialTickets() {
            fetch('/ventas/pos/tickets-hoy/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.tickets.length > 0) {
                        // Construir tabla HTML compacta y elegante
                        let tablaHTML = `
                <style>
                    .historial-table {
                        width: 100%;
                        font-size: 0.75rem;
                        border-collapse: collapse;
                    }
                    .historial-table thead {
                        position: sticky;
                        top: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        z-index: 10;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .historial-table th {
                        padding: 0.35rem 0.5rem;
                        font-weight: 600;
                        font-size: 0.7rem;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        border: none;
                    }
                    .historial-table tbody tr {
                        border-bottom: 1px solid #f0f0f0;
                        transition: background 0.15s ease;
                    }
                    .historial-table tbody tr:hover {
                        background: #f8f9fa;
                    }
                    .historial-table td {
                        padding: 0.25rem 0.5rem;
                        vertical-align: middle;
                        border: none;
                        line-height: 1.3;
                    }
                    .ticket-hora {
                        color: #6c757d;
                        font-size: 0.7rem;
                        font-weight: 500;
                    }
                    .ticket-numero {
                        font-weight: 700;
                        color: #667eea;
                        font-size: 0.75rem;
                    }
                    .ticket-cliente {
                        color: #495057;
                        font-size: 0.72rem;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 200px;
                    }
                    .ticket-total {
                        font-weight: 700;
                        color: #28a745;
                        font-size: 0.8rem;
                    }
                    .btn-print-compact {
                        padding: 0.15rem 0.4rem;
                        font-size: 0.65rem;
                        border-radius: 3px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        color: white;
                        transition: all 0.15s ease;
                        text-decoration: none;
                        display: inline-block;
                    }
                    .btn-print-compact:hover {
                        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
                        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                        color: white;
                    }
                    .historial-container {
                        max-height: 550px;
                        overflow-y: auto;
                        border-radius: 6px;
                        box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
                    }
                    .historial-container::-webkit-scrollbar {
                        width: 8px;
                    }
                    .historial-container::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 4px;
                    }
                    .historial-container::-webkit-scrollbar-thumb {
                        background: #667eea;
                        border-radius: 4px;
                    }
                    .historial-container::-webkit-scrollbar-thumb:hover {
                        background: #764ba2;
                    }
                    .historial-footer {
                        margin-top: 0.75rem;
                        padding: 0.5rem;
                        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                        border-radius: 4px;
                        font-weight: 600;
                        color: #495057;
                        font-size: 0.8rem;
                    }
                </style>
                <div class="historial-container">
                    <table class="historial-table">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Hora</th>
                                <th style="width: 11%;">Ticket</th>
                                <th style="width: 9%;">Doc.</th>
                                <th style="width: 32%;">Cliente</th>
                                <th style="width: 18%;">Total</th>
                                <th style="width: 20%; text-align: center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                        data.tickets.forEach(ticket => {
                            const total = new Intl.NumberFormat('es-CL').format(Math.round(ticket.total));

                            // Color del badge seg√∫n tipo de documento
                            const badgeColor = {
                                'BOL': '#17a2b8',
                                'FACT': '#28a745',
                                'GU√çA': '#ffc107',
                                'N/C': '#dc3545',
                                'N/D': '#fd7e14',
                                'COT': '#6f42c1',
                                'VALE': '#6c757d'
                            };
                            const color = badgeColor[ticket.tipo_documento] || '#6c757d';

                            tablaHTML += `
                    <tr>
                        <td class="ticket-hora">${ticket.fecha}</td>
                        <td class="ticket-numero">#${ticket.numero}</td>
                        <td><span style="display: inline-block; padding: 0.15rem 0.35rem; background: ${color}; color: white; border-radius: 3px; font-size: 0.65rem; font-weight: 600;">${ticket.tipo_documento}</span></td>
                        <td class="ticket-cliente">${ticket.cliente}</td>
                        <td class="ticket-total">$${total}</td>
                        <td style="text-align: center;">
                            <button onclick="imprimirTicketHistorial(${ticket.id})" class="btn btn-print-compact">
                                <i class="fas fa-print me-1"></i>Imprimir
                            </button>
                        </td>
                    </tr>
                `;
                        });

                        tablaHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="historial-footer text-center">
                    <i class="fas fa-receipt me-2"></i>Total de tickets hoy: <span style="color: #667eea;">${data.total_count}</span>
                </div>
            `;

                        Swal.fire({
                            title: '<i class="fas fa-history me-2"></i>Historial de Tickets del D√≠a',
                            html: tablaHTML,
                            width: '900px',
                            showCancelButton: true,
                            showConfirmButton: false,
                            cancelButtonText: 'Cerrar',
                            cancelButtonColor: '#6c757d',
                            customClass: {
                                popup: 'swal-historial-popup'
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'Sin tickets',
                            text: 'No hay tickets generados hoy',
                            timer: 2000
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar el historial de tickets',
                        timer: 2000
                    });
                });
        }
    </script>

    <!-- Modal de Selecci√≥n de Cliente (Modo Con Cliente) -->
    {% if modo_pos == 'con_cliente' %}
    <div class="modal fade" id="modalSeleccionCliente" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none;">
                    <div>
                        <h5 class="modal-title text-white mb-1" style="font-weight: 600;">
                            <i class="fas fa-user-check me-2"></i>Seleccionar Cliente
                        </h5>
                        <small class="text-white-50">Seleccione el cliente para iniciar la venta</small>
                    </div>
                </div>
                <div class="modal-body" style="padding: 25px;">
                    <!-- Buscador de Cliente y Bot√≥n Crear -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0" style="color: #6F5B44;">Buscar Cliente</label>
                            <a href="{% url 'clientes:cliente_create' %}?next={{ request.path|urlencode }}"
                                target="_blank" class="btn btn-sm"
                                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 5px 12px; font-size: 0.8rem; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);">
                                <i class="fas fa-user-plus me-1"></i>Crear Cliente
                            </a>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text" style="background: #F5F1E8; border-color: #E8DCC8;">
                                <i class="fas fa-search" style="color: #8B7355;"></i>
                            </span>
                            <input type="text" id="buscarClienteInicio" class="form-control"
                                placeholder="Buscar por RUT o Nombre..." style="border-color: #E8DCC8;">
                        </div>
                        <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i>Despu√©s de crear el cliente, recargue esta p√°gina
                            para verlo en la lista
                        </small>
                    </div>

                    <!-- Lista de Clientes (estilo tabla compacta) -->
                    <div id="listaClientesInicio"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid #E8DCC8; border-radius: 8px;">
                        <table class="table table-hover mb-0" style="font-size: 0.85rem;">
                            <thead style="background: #F5F1E8; position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th
                                        style="padding: 8px 12px; font-weight: 600; color: #6F5B44; border-bottom: 2px solid #E8DCC8;">
                                        RUT</th>
                                    <th
                                        style="padding: 8px 12px; font-weight: 600; color: #6F5B44; border-bottom: 2px solid #E8DCC8;">
                                        Cliente</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in clientes %}
                                <tr class="cliente-item" data-cliente-id="{{ cliente.id }}"
                                    data-cliente-nombre="{{ cliente.nombre }}"
                                    data-cliente-rut="{{ cliente.rut|default:'Sin RUT' }}"
                                    data-cliente-direccion="{{ cliente.direccion|default:'Sin direcci√≥n' }}"
                                    style="cursor: pointer; transition: background 0.2s;">
                                    <td style="padding: 10px 12px; color: #8B7355; font-weight: 500;">
                                        {{ cliente.rut|default:"Sin RUT" }}
                                    </td>
                                    <td style="padding: 10px 12px; color: #6F5B44; font-weight: 600;">
                                        {{ cliente.nombre }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted" style="padding: 20px;">
                                        No hay clientes disponibles
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <style>
                        .cliente-item:hover {
                            background: #F5F1E8 !important;
                        }
                    </style>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Script para modal de selecci√≥n de cliente
        document.addEventListener('DOMContentLoaded', function () {
            const modoPOS = '{{ modo_pos }}';

            if (modoPOS === 'con_cliente') {
                // Mostrar modal autom√°ticamente
                const modalCliente = new bootstrap.Modal(document.getElementById('modalSeleccionCliente'));
                modalCliente.show();

                // Buscador de clientes
                document.getElementById('buscarClienteInicio').addEventListener('input', function () {
                    const query = this.value.toLowerCase();
                    const items = document.querySelectorAll('.cliente-item');

                    items.forEach(item => {
                        const nombre = item.dataset.clienteNombre.toLowerCase();
                        const rut = item.dataset.clienteRut.toLowerCase();

                        if (nombre.includes(query) || rut.includes(query)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });

                // Seleccionar cliente
                document.querySelectorAll('.cliente-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const clienteId = this.dataset.clienteId.trim().replace(/\s+/g, ''); // Limpiar ID
                        const clienteNombre = this.dataset.clienteNombre.trim();
                        const clienteRut = this.dataset.clienteRut.trim();
                        const clienteDireccion = this.dataset.clienteDireccion.trim();

                        console.log('=== CLIENTE SELECCIONADO DESDE MODAL INICIO ===');
                        console.log('ID (limpio):', clienteId);
                        console.log('Nombre:', clienteNombre);
                        console.log('RUT:', clienteRut);
                        console.log('Direcci√≥n:', clienteDireccion);

                        // Guardar cliente en sesi√≥n/variable global
                        window.clienteSeleccionado = {
                            id: clienteId,
                            nombre: clienteNombre,
                            rut: clienteRut,
                            rut_formatted: clienteRut,
                            direccion: clienteDireccion
                        };

                        // Mostrar cliente en header del POS
                        const clienteHeader = document.getElementById('clienteEnHeader');
                        if (clienteHeader) {
                            clienteHeader.innerHTML = `
                        <div style="background: linear-gradient(135deg, #C8A882 0%, #B8956A 100%); padding: 8px 18px; border-radius: 25px; display: inline-block; box-shadow: 0 2px 8px rgba(200, 168, 130, 0.3);">
                            <i class="fas fa-user-circle me-2" style="color: white; font-size: 1.1rem;"></i>
                            <strong style="color: white; font-size: 0.95rem;">${clienteNombre}</strong>
                            <button onclick="cambiarCliente()" class="btn btn-sm ms-3" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 3px 10px; font-size: 0.75rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="fas fa-exchange-alt me-1"></i>Cambiar
                            </button>
                        </div>
                    `;
                        }

                        // Cerrar modal
                        const modalElement = document.getElementById('modalSeleccionCliente');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        } else {
                            // Si no existe instancia, crear una y cerrarla
                            const newModal = new bootstrap.Modal(modalElement);
                            newModal.hide();
                        }

                        Swal.fire({
                            icon: 'success',
                            title: 'Cliente Seleccionado',
                            text: `Venta para: ${clienteNombre}`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    });
                });
            }
        });

        // Funci√≥n para cambiar cliente
        function cambiarCliente() {
            // Limpiar el campo de b√∫squeda del modal
            const busquedaInput = document.getElementById('buscarClienteInicio');
            if (busquedaInput) {
                busquedaInput.value = '';
            }

            // Limpiar resultados de b√∫squeda si existen
            const listaClientes = document.getElementById('listaClientesInicio');
            if (listaClientes) {
                // Restaurar la lista completa de clientes
                const todosLosClientes = listaClientes.querySelectorAll('.cliente-item');
                todosLosClientes.forEach(item => {
                    item.style.display = '';
                });
            }

            const modalCliente = new bootstrap.Modal(document.getElementById('modalSeleccionCliente'));
            modalCliente.show();
        }
    </script>
    {% endif %}

    <!-- Modal de Apertura de Caja -->
    {% if mostrar_modal_apertura %}
    <div class="modal fade" id="modalAperturaCaja" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"
                style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 1.5rem 2rem;">
                    <h4 class="modal-title mb-0">
                        <i class="fas fa-lock-open me-2"></i>Abrir Caja
                    </h4>
                </div>
                <div class="modal-body p-4">
                    <!-- Alerta Informativa -->
                    <div class="alert alert-info mb-4"
                        style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-left: 4px solid #2196F3;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle me-3 mt-1" style="font-size: 1.5rem; color: #1976D2;"></i>
                            <div>
                                <h6 class="mb-2" style="color: #1565C0; font-weight: 600;">Importante:</h6>
                                <p class="mb-0" style="color: #424242; line-height: 1.6;">
                                    Al abrir la caja, se iniciar√° un nuevo turno. Aseg√∫rate de contar el efectivo
                                    inicial correctamente.
                                    Este monto ser√° la base para el cierre de caja al finalizar el turno.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form method="post" action="{% url 'caja:apertura_create' %}" id="formAperturaCaja">
                        {% csrf_token %}

                        <!-- Caja -->
                        <div class="mb-4">
                            <label for="{{ form_apertura.caja.id_for_label }}" class="form-label fw-bold"
                                style="font-size: 1rem; color: #2c3e50;">
                                <i class="fas fa-cash-register me-2" style="color: #28a745;"></i>Caja
                            </label>
                            {{ form_apertura.caja }}
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-check-circle me-1" style="color: #28a745;"></i>
                                Solo se muestran cajas activas sin apertura
                            </small>
                        </div>

                        <!-- Monto Inicial -->
                        <div class="mb-4">
                            <label for="{{ form_apertura.monto_inicial.id_for_label }}" class="form-label fw-bold"
                                style="font-size: 1rem; color: #2c3e50;">
                                <i class="fas fa-money-bill-wave me-2" style="color: #28a745;"></i>Monto Inicial
                            </label>
                            {{ form_apertura.monto_inicial }}
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-wallet me-1" style="color: #17a2b8;"></i>
                                Efectivo f√≠sico disponible al iniciar el turno
                            </small>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-4">
                            <label for="{{ form_apertura.observaciones_apertura.id_for_label }}"
                                class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                                <i class="fas fa-comment me-2" style="color: #28a745;"></i>Observaciones
                            </label>
                            {{ form_apertura.observaciones_apertura }}
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-pencil-alt me-1" style="color: #6c757d;"></i>
                                Opcional: Notas sobre el turno o condiciones especiales
                            </small>
                        </div>

                        <!-- Nota Final -->
                        <div class="alert alert-light mb-4"
                            style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-lightbulb me-3 mt-1" style="font-size: 1.3rem; color: #ffc107;"></i>
                                <div>
                                    <strong style="color: #495057;">Recuerda:</strong>
                                    <p class="mb-0 mt-1" style="color: #6c757d; font-size: 0.9rem; line-height: 1.5;">
                                        Una vez abierta la caja, podr√°s registrar movimientos, procesar ventas y cerrar
                                        al finalizar el turno.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg"
                                style="padding: 0.75rem; font-size: 1.1rem; font-weight: 600;">
                                <i class="fas fa-unlock me-2"></i>Abrir Caja y Comenzar Turno
                            </button>
                            <a href="{% url 'caja:apertura_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mostrar modal autom√°ticamente si no hay caja abierta
        document.addEventListener('DOMContentLoaded', function () {
            const modal = new bootstrap.Modal(document.getElementById('modalAperturaCaja'));
            modal.show();
        });
    </script>
    {% endif %}

    <script>
        // Funci√≥n para mostrar modal de referencias
        function mostrarModalReferencias() {
            Swal.fire({
                title: '<i class="fas fa-file-alt me-2"></i>Gestionar Referencias',
                html: `
            <div style="text-align: left;">
                <!-- Formulario para agregar referencia -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h6 style="color: #495057; margin-bottom: 15px; font-size: 0.9rem;">
                        <i class="fas fa-plus-circle me-2"></i>Nueva Referencia
                    </h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Tipo *</label>
                            <select id="tipo-referencia" class="form-control form-control-sm">
                                <option value="">Seleccionar...</option>
                                <option value="801">Orden de Compra (801)</option>
                                <option value="802">Nota de Pedido (802)</option>
                                <option value="803">Contrato (803)</option>
                                <option value="52">Gu√≠a de Despacho (52)</option>
                                <option value="HES">HES</option>
                                <option value="HEM">HEM</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Folio *</label>
                            <input type="text" id="folio-referencia" class="form-control form-control-sm" placeholder="Ej: OC-12345">
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Fecha *</label>
                            <input type="date" id="fecha-referencia" class="form-control form-control-sm">
                        </div>
                        <div class="col-6">
                            <label style="font-size: 0.8rem; font-weight: 600; color: #6c757d;">Comentario</label>
                            <input type="text" id="razon-referencia" class="form-control form-control-sm" placeholder="Opcional">
                        </div>
                    </div>
                    <button type="button" id="btn-agregar-ref-modal" class="btn btn-success btn-sm w-100 mt-3" style="font-size: 0.85rem;">
                        <i class="fas fa-plus me-2"></i>Agregar a la Lista
                    </button>
                </div>
                
                <!-- Lista de referencias agregadas -->
                <div id="lista-referencias-modal">
                    <h6 style="color: #495057; margin-bottom: 10px; font-size: 0.9rem;">
                        <i class="fas fa-list me-2"></i>Referencias Agregadas (<span id="contador-refs">0</span>)
                    </h6>
                    <div id="tabla-refs-modal" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-bordered" style="font-size: 0.75rem; margin-bottom: 0;">
                            <thead style="background: #e9ecef; position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 30%;">Tipo</th>
                                    <th style="width: 20%;">Folio</th>
                                    <th style="width: 20%;">Fecha</th>
                                    <th style="width: 20%;">Comentario</th>
                                    <th style="width: 10%; text-align: center;">
                                        <i class="fas fa-trash"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tbody-refs-modal">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #adb5bd; padding: 20px;">
                                        <i class="fas fa-inbox fa-2x mb-2" style="display: block;"></i>
                                        No hay referencias agregadas
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `,
                width: '700px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check me-2"></i>Guardar Referencias',
                cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                didOpen: () => {
                    // Referencias temporales para el modal
                    window.referenciasTemp = [];

                    // Bot√≥n agregar referencia en el modal
                    document.getElementById('btn-agregar-ref-modal').addEventListener('click', function () {
                        const tipo = document.getElementById('tipo-referencia').value;
                        const folio = document.getElementById('folio-referencia').value;
                        const fecha = document.getElementById('fecha-referencia').value;
                        const razon = document.getElementById('razon-referencia').value;

                        if (!tipo || !folio || !fecha) {
                            Swal.showValidationMessage('Complete los campos obligatorios (Tipo, Folio, Fecha)');
                            return;
                        }

                        // Obtener texto del tipo
                        const selectElement = document.getElementById('tipo-referencia');
                        const tipoTexto = selectElement.selectedOptions[0].text;

                        // Agregar a referencias temporales
                        window.referenciasTemp.push({
                            tipo: tipo,
                            tipo_texto: tipoTexto,
                            folio: folio,
                            fecha: fecha,
                            razon: razon || '-'
                        });

                        // Actualizar tabla del modal
                        actualizarTablaReferenciasModal();

                        // Limpiar formulario
                        document.getElementById('tipo-referencia').value = '';
                        document.getElementById('folio-referencia').value = '';
                        document.getElementById('fecha-referencia').value = '';
                        document.getElementById('razon-referencia').value = '';
                    });
                },
                preConfirm: () => {
                    return window.referenciasTemp;
                }
            }).then((result) => {
                if (result.isConfirmed && result.value.length > 0) {
                    // Agregar todas las referencias al array principal
                    window.referencias.push(...result.value);

                    // Actualizar lista visual en el modal principal
                    actualizarListaReferencias();

                    // Mostrar toast de √©xito (no modal que interrumpa)
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'success',
                        title: `${result.value.length} referencia(s) agregada(s)`
                    });
                }
            });
        }

        // Funci√≥n para actualizar tabla de referencias en el modal
        function actualizarTablaReferenciasModal() {
            const tbody = document.getElementById('tbody-refs-modal');
            const contador = document.getElementById('contador-refs');

            if (!tbody) return;

            contador.textContent = window.referenciasTemp.length;

            if (window.referenciasTemp.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #adb5bd; padding: 20px;">
                    <i class="fas fa-inbox fa-2x mb-2" style="display: block;"></i>
                    No hay referencias agregadas
                </td>
            </tr>
        `;
                return;
            }

            tbody.innerHTML = '';
            window.referenciasTemp.forEach((ref, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td style="padding: 4px 6px;">${ref.tipo_texto}</td>
            <td style="padding: 4px 6px;">${ref.folio}</td>
            <td style="padding: 4px 6px;">${ref.fecha}</td>
            <td style="padding: 4px 6px;">${ref.razon}</td>
            <td style="padding: 4px 6px; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger" style="padding: 1px 5px; font-size: 0.7rem;" onclick="eliminarReferenciaTemp(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Funci√≥n para eliminar referencia temporal del modal
        function eliminarReferenciaTemp(index) {
            window.referenciasTemp.splice(index, 1);
            actualizarTablaReferenciasModal();
        }

        // Actualizar lista visual de referencias
        function actualizarListaReferencias() {
            const tabla = document.getElementById('tabla-referencias');
            const tbody = document.getElementById('tbody-referencias');
            const contador = document.getElementById('contador-refs-inline');

            if (!tbody) return;

            // Actualizar contador
            if (contador) {
                contador.textContent = window.referencias.length;
            }

            if (window.referencias.length === 0) {
                tabla.style.display = 'none';
                tbody.innerHTML = '';
                return;
            }

            tabla.style.display = 'table';
            tbody.innerHTML = '';

            window.referencias.forEach((ref, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td style="padding: 4px 6px;">${ref.tipo_texto}</td>
            <td style="padding: 4px 6px;">${ref.folio}</td>
            <td style="padding: 4px 6px;">${ref.fecha}</td>
            <td style="padding: 4px 6px;">${ref.razon || '-'}</td>
            <td style="padding: 4px 6px; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger" style="padding: 2px 6px; font-size: 0.7rem;" onclick="eliminarReferencia(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Eliminar referencia
        function eliminarReferencia(index) {
            window.referencias.splice(index, 1);
            actualizarListaReferencias();
        }
    </script>

    <!-- Modal de Confirmaci√≥n de Despacho -->
    {% include 'facturacion_electronica/modal_confirmacion_despacho.html' %}

    <script>
        // Funci√≥n para mostrar modal de cambio de estaci√≥n
        function mostrarCambiarEstacion() {
            // Cargar lista de estaciones disponibles
            fetch('{% url "ventas:pos_cambiar_estacion" %}')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'Error al cargar las estaciones'
                        });
                        return;
                    }

                    // Crear opciones del select
                    let optionsHtml = '';
                    data.estaciones.forEach(estacion => {
                        const selected = estacion.id == data.estacion_actual_id ? 'selected' : '';
                        optionsHtml += `<option value="${estacion.id}" ${selected}>${estacion.numero} - ${estacion.nombre} (${estacion.modo_pos})</option>`;
                    });

                    Swal.fire({
                        title: 'Cambiar Estaci√≥n de Trabajo',
                        html: `
                    <div class="mb-3">
                        <label class="form-label">Seleccione la nueva estaci√≥n:</label>
                        <select id="select-estacion" class="form-select">
                            ${optionsHtml}
                        </select>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> Al cambiar la estaci√≥n, se actualizar√° el modo de operaci√≥n del POS.
                        </small>
                    </div>
                `,
                        showCancelButton: true,
                        confirmButtonText: '<i class="fas fa-check me-2"></i>Cambiar',
                        cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
                        confirmButtonColor: '#8B7355',
                        didOpen: () => {
                            document.getElementById('select-estacion').focus();
                        },
                        preConfirm: () => {
                            const estacionId = document.getElementById('select-estacion').value;
                            if (!estacionId) {
                                Swal.showValidationMessage('Debe seleccionar una estaci√≥n');
                                return false;
                            }
                            return estacionId;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            cambiarEstacion(result.value);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al cargar las estaciones disponibles'
                    });
                });
        }

        // Funci√≥n para cambiar la estaci√≥n
        function cambiarEstacion(estacionId) {
            const formData = new FormData();
            formData.append('estacion_id', estacionId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');

            fetch('{% url "ventas:pos_cambiar_estacion" %}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Actualizar informaci√≥n en el header
                        document.getElementById('estacion-nombre').textContent = data.estacion_nombre;

                        // Actualizar variables globales
                        window.currentEstacionId = data.estacion.id;
                        window.currentEstacion = data.estacion;

                        Swal.fire({
                            icon: 'success',
                            title: '¬°Estaci√≥n Cambiada!',
                            text: data.message,
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // Recargar informaci√≥n de sesi√≥n para asegurar sincronizaci√≥n
                        // Usar fetch directo en lugar de loadSessionInfo que puede no estar disponible
                        setTimeout(() => {
                            fetch('/ventas/pos/session-info/')
                                .then(response => response.json())
                                .then(sessionData => {
                                    if (sessionData.success) {
                                        document.getElementById('estacion-nombre').textContent = sessionData.estacion_nombre;
                                        document.getElementById('vendedor-nombre').textContent = sessionData.vendedor_nombre;
                                        window.currentEstacionId = sessionData.estacion_id;
                                        window.currentVendedorId = sessionData.vendedor_id;
                                        window.currentEstacion = sessionData.estacion;
                                    }
                                })
                                .catch(err => console.error('Error al recargar sesi√≥n:', err));
                        }, 500);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'Error al cambiar la estaci√≥n'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al cambiar la estaci√≥n'
                    });
                });
        }
    </script>

    <!-- QZ Tray Integration -->
    <!-- QZ Tray desactivado temporalmente -->
    <!-- <script src="{% static 'vendor/qz/qz-tray.js' %}"></script> -->
    <script src="{% static 'js/qz_interface.js' %}"></script>

    <script>
        // Configuraci√≥n de Impresora
        function configurarImpresora() {
            if (typeof qz === 'undefined') {
                Swal.fire('Error', 'QZ Tray no est√° cargado.', 'error');
                updateQZStatus('disconnected');
                return;
            }

            updateQZStatus('connecting');
            QZ_Printers.connect()
                .then(() => {
                    updateQZStatus('connected');
                    return QZ_Printers.getPrinters();
                })
                .then(printers => {
                    let optionsHtml = '<option value="">-- Seleccionar Impresora --</option>';
                    const savedPrinter = localStorage.getItem('qz_selected_printer');

                    printers.forEach(p => {
                        const selected = p === savedPrinter ? 'selected' : '';
                        optionsHtml += `<option value="${p}" ${selected}>${p}</option>`;
                    });

                    Swal.fire({
                        title: 'Configurar Impresora T√©rmica',
                        html: `
                        <div class="mb-3">
                            <label class="form-label">Seleccione la impresora para tickets:</label>
                            <select id="select-impresora" class="form-select">
                                ${optionsHtml}
                            </select>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i> Esta configuraci√≥n se guarda en este navegador.
                            </small>
                        </div>
                    `,
                        showCancelButton: true,
                        confirmButtonText: '<i class="fas fa-save me-2"></i>Guardar',
                        cancelButtonText: 'Cancelar',
                        preConfirm: () => {
                            const printer = document.getElementById('select-impresora').value;
                            if (!printer) Swal.showValidationMessage('Debe seleccionar una impresora');
                            return printer;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            QZ_Printers.setPrinter(result.value);
                            Swal.fire('Guardado', 'Impresora configurada correctamente', 'success');
                            updateQZStatus('connected');
                        }
                    });
                })
                .catch(err => {
                    console.error(err);
                    updateQZStatus('disconnected');
                    const errorStr = err.toString();
                    if (errorStr.includes("blocked by client")) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Conexi√≥n Bloqueada',
                            html: `
                                <p>QZ Tray ha bloqueado la conexi√≥n.</p>
                                <ol class="text-start">
                                    <li>Busque el icono verde de <b>QZ Tray</b> en la barra de tareas (cerca del reloj).</li>
                                    <li>Haga clic derecho y vaya a <b>"Allowed / Blocked"</b> (Permitidos/Bloqueados).</li>
                                    <li>Busque <b>localhost</b> en la lista de Bloqueados y elim√≠nelo (bot√≥n menos).</li>
                                    <li>Recargue esta p√°gina e intente nuevamente.</li>
                                </ol>
                            `
                        });
                    } else {
                        Swal.fire('Error', 'No se pudo conectar con QZ Tray: ' + err, 'error');
                    }
                });
        }

        // Funci√≥n para imprimir desde historial
        function imprimirTicketHistorial(id) {
            if (typeof QZ_Printers !== 'undefined' && localStorage.getItem('qz_selected_printer')) {
                const ticketUrl = `/ventas/vales/${id}/termica/`;
                Swal.fire({
                    title: 'Imprimiendo...',
                    timer: 1000,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                QZ_Printers.printTicketFromUrl(ticketUrl).then(() => {
                    // Success
                }).catch(err => {
                    console.error("Error QZ, fallback to window.open", err);
                    window.open(`/ventas/vales/${id}/html/`, '_blank');
                });
            } else {
                window.open(`/ventas/vales/${id}/html/`, '_blank');
            }
        }

        // Auto-connect and Status Update
        document.addEventListener("DOMContentLoaded", function () {
            updateQZStatus('connecting');

            if (typeof QZ_Printers !== 'undefined') {
                QZ_Printers.connect()
                    .then(() => {
                        console.log("QZ Conectado al iniciar POS");
                        updateQZStatus('connected');
                    })
                    .catch(err => {
                        console.warn("QZ No conectado al iniciar POS:", err);
                        updateQZStatus('disconnected');
                        // No mostrar alerta intrusiva al inicio, solo visual en el bot√≥n
                    });
            } else {
                console.error("QZ_Printers no est√° definido");
                updateQZStatus('disconnected');
            }
        });

        function updateQZStatus(status) {
            const btn = document.getElementById('btn-printer-config');
            if (!btn) return;

            // Reset classes
            btn.classList.remove('btn-outline-light', 'btn-success', 'btn-danger', 'btn-warning');

            if (status === 'connected') {
                btn.classList.add('btn-success'); // Verde
                const printer = localStorage.getItem('qz_selected_printer') || 'Sin seleccionar';
                btn.title = `Impresora Conectada: ${printer}`;
                btn.innerHTML = '<i class="fas fa-print me-1"></i>Impresora ON';
            } else if (status === 'disconnected') {
                btn.classList.add('btn-danger'); // Rojo
                btn.title = "QZ Tray Desconectado (Click para configurar)";
                btn.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Impresora OFF';
            } else if (status === 'connecting') {
                btn.classList.add('btn-warning'); // Amarillo
                btn.title = "Conectando...";
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Conectando...';
            } else {
                btn.classList.add('btn-outline-light');
            }
        }

        /* ===== FUNCIONES DEL PANEL DE AYUDA ===== */
        function mostrarAyudaPOS() {
            const overlay = document.getElementById('help-overlay');
            overlay.classList.add('show');
            // Mostrar primera pesta√±a por defecto
            mostrarTab('tab-ofertas');
        }

        function cerrarAyudaPOS() {
            const overlay = document.getElementById('help-overlay');
            overlay.classList.remove('show');
        }

        function mostrarTab(tabId) {
            // Ocultar todos los tabs DEL PANEL DE AYUDA SOLAMENTE
            document.querySelectorAll('.help-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.help-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar el tab seleccionado
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        // Cerrar al hacer click fuera del panel
        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.getElementById('help-overlay');
            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) {
                        cerrarAyudaPOS();
                    }
                });
            }
        });
    </script>

    <!-- PANEL DE AYUDA DEL POS -->
    <div id="help-overlay" class="help-overlay">
        <div class="help-panel">
            <div class="help-header">
                <h2><i class="fas fa-graduation-cap me-2"></i>Gu√≠a de Uso del POS</h2>
                <button class="close-btn" onclick="cerrarAyudaPOS()">√ó</button>
            </div>

            <div class="help-tabs">
                <button id="btn-tab-ofertas" class="help-tab active" onclick="mostrarTab('tab-ofertas')">
                    <i class="fas fa-tag"></i>
                    Ofertas
                </button>
                <button id="btn-tab-kits" class="help-tab" onclick="mostrarTab('tab-kits')">
                    <i class="fas fa-box-open"></i>
                    Kits
                </button>
                <button id="btn-tab-comodin" class="help-tab" onclick="mostrarTab('tab-comodin')">
                    <i class="fas fa-star"></i>
                    C√≥digo 001
                </button>
            </div>

            <div class="help-content">
                <!-- TAB: OFERTAS -->
                <div id="tab-ofertas" class="help-tab-content active">
                    <div class="help-section">
                        <h3><i class="fas fa-percent"></i>¬øQu√© son las Ofertas?</h3>
                        <p>
                            Las ofertas te permiten aplicar <strong>descuentos especiales autom√°ticamente</strong>
                            cuando agregas un producto al carrito.
                            Son ideales para promociones, liquidaciones o clientes VIP.
                        </p>

                        <div class="help-tip">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> Las ofertas se configuran desde el m√≥dulo de Art√≠culos en el sistema
                            principal.
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-list-ol"></i>¬øC√≥mo usar las Ofertas?</h3>
                        <ul class="help-steps">
                            <li data-step="1">
                                Configura la oferta en el m√≥dulo de <strong>Art√≠culos</strong> (definir % de descuento,
                                fecha de inicio/fin, etc.)
                            </li>
                            <li data-step="2">
                                En el POS, <strong>escanea o busca el producto</strong> que tiene oferta activa
                            </li>
                            <li data-step="3">
                                El sistema aplicar√° <strong>autom√°ticamente el descuento</strong> y lo mostrar√° en el
                                carrito
                            </li>
                            <li data-step="4">
                                Ver√°s el precio original <span style="text-decoration: line-through;">tachado</span> y
                                el precio con descuento resaltado
                            </li>
                        </ul>

                        <div class="help-example">
                            <i class="fas fa-shopping-cart"></i> Ejemplo:
                            Producto $10.000 con oferta 20% ‚Üí Precio final: $8.000
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-exclamation-triangle"></i>Consideraciones Importantes</h3>
                        <div class="help-warning">
                            <i class="fas fa-info-circle"></i>
                            Las ofertas <strong>solo se aplican si est√°n vigentes</strong> (dentro del rango de fechas
                            configurado)
                        </div>
                        <div class="help-success">
                            <i class="fas fa-check-circle"></i>
                            Puedes combinar ofertas con otros descuentos manuales si tu rol lo permite
                        </div>
                    </div>
                </div>

                <!-- TAB: KITS -->
                <div id="tab-kits" class="help-tab-content">
                    <div class="help-section">
                        <h3><i class="fas fa-box"></i>¬øQu√© son los Kits?</h3>
                        <p>
                            Los kits son <strong>conjuntos de productos agrupados</strong> que se venden como una
                            unidad.
                            Al escanear o buscar un kit, el sistema agrega autom√°ticamente <strong>todos los productos
                                incluidos</strong> al carrito.
                        </p>

                        <div class="help-tip">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> Los kits son perfectos para promociones "pack" o combos de productos
                            relacionados.
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-list-ol"></i>¬øC√≥mo usar los Kits?</h3>
                        <ul class="help-steps">
                            <li data-step="1">
                                Configura el kit en el m√≥dulo de <strong>Art√≠culos ‚Üí Kits</strong> (agregar productos
                                componentes y sus cantidades)
                            </li>
                            <li data-step="2">
                                Asigna un <strong>c√≥digo √∫nico</strong> al kit (como cualquier producto normal)
                            </li>
                            <li data-step="3">
                                En el POS, <strong>escanea o busca el c√≥digo del kit</strong>
                            </li>
                            <li data-step="4">
                                El sistema agregar√° <strong>todos los productos del kit autom√°ticamente</strong> al
                                carrito con sus cantidades
                            </li>
                            <li data-step="5">
                                Cada producto se muestra individualmente en el ticket (con precio de kit o individual
                                seg√∫n configuraci√≥n)
                            </li>
                        </ul>

                        <div class="help-example">
                            <i class="fas fa-box-open"></i> Ejemplo:
                            Kit "Combo Desayuno" ‚Üí Agrega: 1 Caf√© + 2 Croissants + 1 Jugo
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-cogs"></i>Tipos de Kits</h3>
                        <p><strong>Kit con precio fijo:</strong> Todos los productos se venden por un precio total
                            determinado</p>
                        <p><strong>Kit suma de precios:</strong> El precio es la suma de los precios individuales de
                            cada componente</p>

                        <div class="help-success">
                            <i class="fas fa-check-circle"></i>
                            Los kits pueden tener sus propias <strong>ofertas adicionales</strong> aplicadas sobre el
                            precio total
                        </div>
                    </div>
                </div>

                <!-- TAB: C√ìDIGO COMOD√çN 001 -->
                <div id="tab-comodin" class="help-tab-content">
                    <div class="help-section">
                        <h3><i class="fas fa-magic"></i>¬øQu√© es el C√≥digo Comod√≠n 001?</h3>
                        <p>
                            El c√≥digo <strong>"001"</strong> es un c√≥digo especial que te permite agregar un
                            <strong>producto gen√©rico al carrito</strong>
                            cuando no tienes el c√≥digo de barras real o necesitas vender algo que no est√° en el sistema.
                        </p>

                        <div class="help-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Importante:</strong> Este c√≥digo debe estar configurado previamente en el sistema
                            con el nombre
                            "Producto Gen√©rico" o similar.
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-list-ol"></i>¬øC√≥mo usar el C√≥digo 001?</h3>
                        <ul class="help-steps">
                            <li data-step="1">
                                En el campo de b√∫squeda o c√≥digo de barras, <strong>escribe: 001</strong>
                            </li>
                            <li data-step="2">
                                Presiona <strong>Enter</strong> o haz click en buscar
                            </li>
                            <li data-step="3">
                                El sistema agregar√° el producto gen√©rico al carrito
                            </li>
                            <li data-step="4">
                                <strong>Modifica el nombre y precio</strong> del producto en el carrito seg√∫n lo que
                                est√©s vendiendo
                            </li>
                            <li data-step="5">
                                Contin√∫a con la venta normalmente
                            </li>
                        </ul>

                        <div class="help-example">
                            <i class="fas fa-keyboard"></i> Escribe: 001 ‚Üí Enter ‚Üí Editar nombre/precio
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-question-circle"></i>¬øCu√°ndo usar el C√≥digo 001?</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px;">
                                <i class="fas fa-check text-success me-2"></i>
                                Ventas de productos sin c√≥digo de barras
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px;">
                                <i class="fas fa-check text-success me-2"></i>
                                Servicios o productos √∫nicos
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px;">
                                <i class="fas fa-check text-success me-2"></i>
                                Emergencias cuando el c√≥digo real no funciona
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px;">
                                <i class="fas fa-check text-success me-2"></i>
                                Productos especiales o personalizados
                            </li>
                        </ul>

                        <div class="help-tip">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> Aunque puedes modificar nombre y precio, es mejor tener todos los
                            productos
                            en el sistema para un mejor control de inventario y reportes.
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-shield-alt"></i>Permisos y Restricciones</h3>
                        <div class="help-warning">
                            <i class="fas fa-lock"></i>
                            La capacidad de modificar precios puede estar <strong>restringida seg√∫n tu rol de
                                usuario</strong>.
                            Consulta con el administrador si no puedes cambiar precios.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>