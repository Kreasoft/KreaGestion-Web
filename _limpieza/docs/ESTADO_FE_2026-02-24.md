# Estado y Contexto FE (Certificación) - 2026-02-24

## Resumen
- Flujo de Guías (52) funcionando en certificación con DTEBox.
- Boleta (39) prueba enviada correctamente.
- Factura (33) generada; envío con 500 del box en folio antiguo, pendiente reintento.

## Cambios Clave
- Envío DTEBox:
  - Environment=T forzado.
  - Envío primario JSON con Content en Base64.
  - Guías priorizan Content=solo Documento (nodo Documento).
  - Sanitización antes de enviar: TipoDespacho ∈ {1,2}, IndTraslado ∈ {1,2,3,4}.
- Generación XML (Guías 52):
  - FmaPago=1 en IdDoc.
  - GiroRecep obligatorio; usa “SIN GIRO” si falta.
  - Normalización de TipoDespacho/IndTraslado al generar.
- Servicio de envío:
  - Prevalidación para UI: completa GiroRecep y regenera XML si falta.
  - Fallback directo al SII (SetDTE) en certificación cuando DTEBox falla.
- Background sender:
  - Backoff progresivo: 5s, 30s, 2m, 5m, 15m, 30m.
- Script de apoyo:
  - _limpieza/scripts/enviar_guia_por_folio.py para disparo puntual por folio.

## Pruebas Realizadas
- Guías:
  - Folio 99 → DTEBOX-99
  - Folio 100 → DTEBOX-100
  - Folio 101 → DTEBOX-101
  - Folio 102 → DTEBOX-102
- Boleta:
  - Folio 263 → DTEBOX-263
- Factura:
  - Folio 73 → 500 del box (InternalServiceFault) en certificación; lista para reintento.
- Observación: Folios antiguos de guías (95/96/98) devuelven 500 persistente; nuevas guías pasan OK.

## Pendientes/Seguimiento
- Reintentar Factura 73 cuando el box esté estable.
- Si se requiere la 98 estricta, clonar contenido en nuevo folio con Venta asociada y enviar.

## Comandos Útiles
```bash
# Generar guías/boletas/facturas de prueba
python manage.py generar_factura_prueba --empresa-id 1 --tipo guia
python manage.py generar_factura_prueba --empresa-id 1 --tipo boleta
python manage.py generar_factura_prueba --empresa-id 1 --tipo factura

# Enviar un DTE por ID
python manage.py enviar_dte_sii --dte-id <ID>

# Enviar guía por folio directamente
python _limpieza/scripts/enviar_guia_por_folio.py <folio>
```

## Notas
- El SII (certificación) puede devolver 500 al obtener token; es incidencia del servicio, no del payload.
- El DTEBox puede devolver 500 para ciertos folios; el pipeline aplica reintentos y fallbacks.

## Próximos Pasos
- Revisar mañana boletas y facturas:
  - Boleta: validar estructura sin TasaIVA, IndServicio=3.
  - Factura: FmaPago y TasaIVA correctos; reintentar folio 73 y/o generar uno nuevo.

