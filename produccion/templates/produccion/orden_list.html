{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Órdenes de Producción{% endblock %}

{% block extra_css %}
<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
    }

    body {
        background-color: var(--stone-bg) !important;
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(139, 115, 85, 0.08);
        overflow: hidden;
        margin-top: 1.5rem;
        margin-bottom: 2rem;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-icon-box {
        width: 48px; height: 48px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.25rem;
    }

    .header-text h1 {
        color: var(--stone-text); font-size: 1.35rem; margin: 0; letter-spacing: -0.5px; line-height: 1.1;
    }
    .header-text p {
        color: #795548; font-size: 0.85rem; margin: 0; font-weight: 500; opacity: 0.9;
    }

    /* BOTONES */
    .header-btn {
        padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; text-decoration: none; display: inline-flex; align-items: center; transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
    }
    .btn-action-primary { background: var(--stone-primary); color: white; border: none; }
    .btn-action-primary:hover { background: var(--stone-secondary); color: white; }

    /* STATS CARDS - SOFT UI PASTEL */
    .stat-card {
        border: none; border-radius: 12px; transition: all 0.3s ease; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        height: 100%; position: relative; overflow: hidden;
        display: flex; align-items: stretch; justify-content: space-between;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); }
    
    /* Azul Pastel (Total) */
    .stat-card-1 { 
        background: linear-gradient(135deg, #a5c0d1 0%, #c6d8e5 100%);
        border: 2px solid #9ab8cd;
    }
    /* Verde Pastel (Terminadas) */
    .stat-card-2 { 
        background: linear-gradient(135deg, #a8d5ba 0%, #ccead7 100%);
        border: 2px solid #8fc2a3;
    }
    /* Amarillo/Naraja Pastel (En Proceso) */
    .stat-card-3 { 
        background: linear-gradient(135deg, #f7dca5 0%, #fbe8c3 100%);
        border: 2px solid #e8cd96;
    }
    /* Rosa/Rojo Pastel (Canceladas/Pendientes) */
    .stat-card-4 { 
        background: linear-gradient(135deg, #f7d9d9 0%, #fef5e7 100%);
        border: 2px solid #f4d1d1;
    }
    
    .stat-content {
        padding: 1.25rem;
        display: flex; flex-direction: column; justify-content: center;
        z-index: 2;
    }
    .stat-value { 
        font-size: 1.5rem; 
        font-weight: 700; 
        margin-bottom: 0.25rem; 
        line-height: 1; 
        color: #2D3748; 
    }
    .stat-label { 
        font-size: 0.75rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        font-weight: 600;
        color: #4A5568; 
    }
    
    .stat-icon-full {
        width: auto;
        display: flex; align-items: center; justify-content: center;
        font-size: 4.5rem; 
        color: rgba(255, 255, 255, 0.4); 
        position: absolute; 
        right: -10px;
        bottom: -10px; 
        height: 100%;
        overflow: hidden;
        z-index: 1;
        transform: rotate(-10deg);
    }

    /* FILTROS */
    .stone-filter-box {
        background: #FAFAF8; border: 1px solid #E8DCC8; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;
    }
    .form-control-stone, .form-select-stone {
        border-radius: 8px; border: 1px solid #D4C4A8; padding: 0.4rem 0.75rem; font-size: 0.85rem; background-color: white; width: 100%; color: var(--stone-text);
    }
    .form-control-stone:focus, .form-select-stone:focus {
        border-color: var(--stone-primary); box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1); outline: none;
    }

    /* TABLA PIEDRA COMPACTA */
    .table-piedra { width: 100%; border-collapse: collapse; }
    .table-piedra thead th {
        background: #FDFCFB; border-bottom: 2px solid #E8DCC8; color: #8B7355; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 10px 15px;
    }
    .table-piedra tbody tr { 
        height: 32px !important; 
        transition: all 0.2s ease; border-bottom: 1px solid #F5F1E8; 
    }
    .table-piedra tbody tr:hover { background-color: #F5F1E8; }
    .table-piedra tbody td { 
        padding: 2px 15px; 
        vertical-align: middle; font-size: 0.85rem; color: #4A5568; 
    }

    /* BADGES */
    .badge-stone { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; display: inline-block; }

    /* Ocultar top-bar original si es necesario */
    .top-bar { display: none !important; }
    .main-content { margin-top: 0 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="single-card-container">
        <!-- HEADER -->
        <div class="stone-header-premium">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-box">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="header-text">
                    <h1>Órdenes de <span class="fw-bold">Producción</span></h1>
                    <p>Planificación y control de fabricación</p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="header-btn" onclick="window.print()">
                    <i class="fas fa-print me-2"></i> Reportes
                </button>
                <button type="button" class="header-btn btn-action-primary" onclick="openOrdenModal('{% url 'produccion:orden_create' %}')">
                    <i class="fas fa-plus me-2"></i> Nueva Orden
                </button>
            </div>
        </div>
        
        <div class="card-body p-4">
            
            <!-- STATS CARDS -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stat-card stat-card-1">
                        <div class="stat-content">
                            <div class="stat-value">{{ ordenes.count|default:"-" }}</div>
                            <div class="stat-label">Total Órdenes</div>
                        </div>
                        <div class="stat-icon-full">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-card-3">
                        <div class="stat-content">
                            <!-- Placeholder metric -->
                            <div class="stat-value">{{ en_proceso_count|default:"-" }}</div>
                            <div class="stat-label">En Proceso</div>
                        </div>
                        <div class="stat-icon-full">
                            <i class="fas fa-cog fa-spin" style="animation-duration: 10s;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-card-2">
                        <div class="stat-content">
                            <div class="stat-value">{{ terminadas_count|default:"-" }}</div>
                            <div class="stat-label">Terminadas</div>
                        </div>
                        <div class="stat-icon-full">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-card-4">
                        <div class="stat-content">
                            <div class="stat-value">{{ pendientes_count|default:"-" }}</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                        <div class="stat-icon-full">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTROS -->
                <div class="stone-filter-box">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Buscar</label>
                        <input type="text" name="search" class="form-control-stone" 
                                placeholder="Orden, Receta, Responsable..." value="{{ search|default:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted mb-1">Estado</label>
                        <select name="estado" class="form-select-stone">
                            <option value="">Todos</option>
                            <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="en_proceso" {% if estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
                            <option value="terminada" {% if estado == 'terminada' %}selected{% endif %}>Terminada</option>
                            <option value="cancelada" {% if estado == 'cancelada' %}selected{% endif %}>Cancelada</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted mb-1">Desde</label>
                        <input type="date" name="fecha_desde" class="form-control-stone" value="{{ fecha_desde|default:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted mb-1">Hasta</label>
                        <input type="date" name="fecha_hasta" class="form-control-stone" value="{{ fecha_hasta|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="header-btn btn-action-primary w-100 justify-content-center">
                            <i class="fas fa-filter me-2"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- TABLA -->
            <div class="table-responsive">
                <table class="table-piedra">
                    <thead>
                        <tr>
                            <th>N° Orden</th>
                            <th>Receta</th>
                            <th>Bodega</th>
                            <th class="text-center">Planificado</th>
                            <th class="text-center">Prod.</th>
                            <th class="text-center">Avance</th>
                            <th class="text-center">Estado</th>
                            <th>Fecha</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orden in ordenes %}
                        <tr>
                            <td>
                                <span class="fw-bold" style="color: #5D4037;">{{ orden.numero_orden }}</span>
                            </td>
                            <td>{{ orden.receta.nombre }}</td>
                            <td>{{ orden.sucursal.nombre|default:"-" }}</td>
                            <td class="text-center">{{ orden.cantidad_planificada|floatformat:0 }}</td>
                            <td class="text-center">{{ orden.cantidad_producida|floatformat:0 }}</td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border">{{ orden.porcentaje_completado|floatformat:0 }}%</span>
                            </td>
                            <td class="text-center">
                                {% if orden.estado == 'pendiente' %}
                                    <span class="badge bg-secondary">Pendiente</span>
                                {% elif orden.estado == 'en_proceso' %}
                                    <span class="badge bg-primary">En Proc.</span>
                                {% elif orden.estado == 'terminada' %}
                                    <span class="badge bg-success">Terminada</span>
                                {% elif orden.estado == 'cancelada' %}
                                    <span class="badge bg-danger">Cancelada</span>
                                {% endif %}
                            </td>
                            <td>{{ orden.fecha_planificada|date:"d/m/Y" }}</td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    <button type="button" class="btn btn-sm text-secondary p-0 border-0" style="width: 24px; height: 24px;" title="Ver Detalle" onclick="openOrdenModal('{% url 'produccion:orden_detail' orden.pk %}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    {% if orden.estado == 'pendiente' %}
                                    <button type="button" class="btn btn-sm text-success p-0 border-0" style="width: 24px; height: 24px;" title="Iniciar Producción" onclick="openOrdenModal('{% url 'produccion:orden_iniciar' orden.pk %}')">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm text-secondary p-0 border-0" style="width: 24px; height: 24px;" title="Editar" onclick="openOrdenModal('{% url 'produccion:orden_update' orden.pk %}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm text-danger p-0 border-0" style="width: 24px; height: 24px;" title="Cancelar" onclick="confirmarCancelarOrden('{% url 'produccion:orden_delete' orden.pk %}', '{{ orden.numero_orden }}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    {% endif %}

                                    {% if orden.estado == 'en_proceso' %}
                                     <button type="button" class="btn btn-sm text-success p-0 border-0" style="width: 24px; height: 24px;" title="Finalizar" onclick="openOrdenModal('{% url 'produccion:orden_finalizar' orden.pk %}')">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                     <button type="button" class="btn btn-sm text-danger p-0 border-0" style="width: 24px; height: 24px;" title="Cancelar" onclick="confirmarCancelarOrden('{% url 'produccion:orden_delete' orden.pk %}', '{{ orden.numero_orden }}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center opacity-25">
                                    <i class="fas fa-industry fa-3x mb-3 text-muted"></i>
                                    <h6 class="fw-bold text-muted">No hay órdenes registradas</h6>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación placeholder si existe logic -->
        </div>
    </div>
</div>

<!-- Modal Container -->
<div class="modal fade" id="ordenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="ordenModalContent" style="border-radius: 16px; overflow: hidden; border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.2);">
            <!-- Content loaded via AJAX -->
        </div>
    </div>
</div>

<!-- Formulario oculto para eliminar/cancelar con CSRF Token -->
<form id="deleteForm" method="post" style="display:none;">
    {% csrf_token %}
</form>

<script>
// Ocultar top menu
document.addEventListener('DOMContentLoaded', function() {
    const topMenu = document.querySelector('.top-menu');
    if (topMenu) {
        topMenu.style.display = 'none';
    }
});

// Modal Logic
function openOrdenModal(url) {
    const modalContent = document.getElementById('ordenModalContent');
    const modalEl = document.getElementById('ordenModal');
    const modal = new bootstrap.Modal(modalEl);
    
    modalContent.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-secondary" role="status"></div></div>';
    modal.show();

    fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.text())
    .then(html => {
        modalContent.innerHTML = html;
        executeScripts(modalContent);
        bindModalForm();
    })
    .catch(err => {
        console.error(err);
        modalContent.innerHTML = '<div class="p-4 text-center text-danger">Error al cargar datos. <br>Intente nuevamente.</div>';
    });
}

function bindModalForm() {
    // Try to find either the create/edit form, start form, or finalize form
    const form = document.querySelector('#ordenModalContent form');
    
    if (!form) return;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const url = form.action;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
        
        if(submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
        }

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    if (data.success) {
                        const modalEl = document.getElementById('ordenModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();
                        
                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: data.message,
                            confirmButtonColor: '#8B7355'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'Ocurrió un error inesperado',
                            confirmButtonColor: '#8B7355'
                        });
                        if(submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    }
                });
            } else {
                return response.text().then(html => {
                    const modalContent = document.getElementById('ordenModalContent');
                    modalContent.innerHTML = html;
                    executeScripts(modalContent);
                    bindModalForm();
                });
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error de conexión',
                confirmButtonColor: '#8B7355'
            });
            if(submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    });
}

function confirmarCancelarOrden(url, numeroOrden) {
    Swal.fire({
        title: '¿Cancelar/Eliminar Orden?',
        text: `¿Estás seguro de cancelar/eliminar la orden "${numeroOrden}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, continuar',
        cancelButtonText: 'No, volver'
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.getElementById('deleteForm');
            form.action = url;
            form.submit();
        }
    });
}

function executeScripts(element) {
    const scripts = element.querySelectorAll('script');
    scripts.forEach(script => {
        const newScript = document.createElement('script');
        Array.from(script.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
        newScript.appendChild(document.createTextNode(script.innerHTML));
        script.parentNode.replaceChild(newScript, script);
    });
}
</script>
{% endblock %}
