{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Orden de Producción{% endblock %}

{% block extra_css %}
<style>
    /* Ocultar top-bar */
    .top-bar {
        display: none !important;
    }
    .main-content {
        margin-top: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="single-card-container">
        <!-- HEADER -->
        <div class="stone-header-premium">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-box">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div class="header-text">
                    <h1>Orden {{ orden.numero_orden }}</h1>
                    <div class="d-flex align-items-center gap-2 mt-1">
                        {% if orden.estado == 'pendiente' %}
                            <span class="badge bg-secondary">Pendiente</span>
                        {% elif orden.estado == 'en_proceso' %}
                            <span class="badge bg-primary">En Proceso</span>
                        {% elif orden.estado == 'terminada' %}
                            <span class="badge bg-success">Terminada</span>
                        {% elif orden.estado == 'cancelada' %}
                            <span class="badge bg-danger">Cancelada</span>
                        {% endif %}
                        <small class="text-muted" style="font-size: 0.8rem;">Sucursal: {{ orden.sucursal.nombre|default:"-" }}</small>
                    </div>
                </div>
            </div>
            <a href="{% url 'produccion:orden_list' %}" class="header-btn btn-light border" style="color: var(--stone-text);">
                <i class="fas fa-arrow-left me-2"></i> Volver al Listado
            </a>
        </div>

        <div class="card-body p-4">
            <div class="row g-5">
                <!-- COLUMNA IZQUIERDA: INFORMACIÓN PRINCIPAL -->
                <div class="col-md-5">
                    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 2px solid #E8DCC8; padding-bottom: 0.5rem;">Información General</h6>
                    
                    <div class="p-3 bg-light rounded-3 border mb-4">
                        <table class="table table-borderless table-sm mb-0">
                            <tbody>
                                <tr>
                                    <td class="text-muted small py-1">Receta:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.receta.nombre }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted small py-1">Producto Final:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.receta.producto_final.nombre }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted small py-1">Responsable:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.responsable|default:"-" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 2px solid #E8DCC8; padding-bottom: 0.5rem;">Tiempos</h6>
                    <div class="p-3 bg-light rounded-3 border">
                        <table class="table table-borderless table-sm mb-0">
                            <tbody>
                                <tr>
                                    <td class="text-muted small py-1">Planificada:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.fecha_planificada|date:"d/m/Y" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted small py-1">Inicio Real:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.fecha_inicio|date:"d/m/Y H:i"|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted small py-1">Fin Real:</td>
                                    <td class="fw-bold text-dark py-1 text-end">{{ orden.fecha_fin|date:"d/m/Y H:i"|default:"-" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: CANTIDADES Y COSTOS -->
                <div class="col-md-7">
                    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 2px solid #E8DCC8; padding-bottom: 0.5rem;">Cantidades y Costos</h6>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="p-3 border rounded-3 text-center" style="background-color: #fff;">
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Cantidad Planificada</small>
                                <span class="d-block fs-4 fw-bold text-dark mt-1">{{ orden.cantidad_planificada|floatformat:0 }} <small class="fs-6 text-muted">{{ orden.receta.producto_final.unidad_medida.simbolo }}</small></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded-3 text-center" style="background-color: #fff;">
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Cantidad Producida</small>
                                <span class="d-block fs-4 fw-bold text-success mt-1">{{ orden.cantidad_producida|floatformat:0|default:"-" }}</span>
                            </div>
                        </div>
                         <div class="col-md-6">
                            <div class="p-3 border rounded-3 text-center" style="background-color: #fff;">
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Merma Real</small>
                                <span class="d-block fs-4 fw-bold text-danger mt-1">{{ orden.merma_real|floatformat:2|default:"0" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded-3 text-center" style="background-color: #fff;">
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Costo Total Estimado</small>
                                <span class="d-block fs-4 fw-bold text-dark mt-1">${{ orden.costo_total|floatformat:0|intcomma|default:"0" }}</span>
                            </div>
                        </div>
                    </div>

                    {% if orden.estado == 'terminada' %}
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <i class="fas fa-check-circle me-2 fa-lg"></i>
                        <div>
                            <strong>Orden Finalizada Exitosamente</strong>
                            <div class="small">El stock ha sido actualizado.</div>
                        </div>
                    </div>
                    {% endif %}

                     {% if orden.observaciones %}
                    <div class="mt-4">
                        <label class="form-label-stone text-muted small fw-bold">Observaciones</label>
                        <div class="p-3 bg-light rounded border text-muted fst-italic">
                            {{ orden.observaciones }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-5 pt-3 border-top border-light">
                 {% if orden.estado == 'pendiente' %}
                    <button type="button" class="btn btn-danger text-white" onclick="confirmarCancelarOrden('{% url 'produccion:orden_delete' orden.pk %}', '{{ orden.numero_orden }}')">
                        <i class="fas fa-trash-alt me-2"></i> Eliminar
                    </button>
                    <a href="{% url 'produccion:orden_iniciar' orden.pk %}" class="btn btn-stone-primary text-white" style="background: linear-gradient(135deg, #198754 0%, #157347 100%);">
                        <i class="fas fa-play me-2"></i> Iniciar Producción
                    </a>
                {% elif orden.estado == 'en_proceso' %}
                     <a href="{% url 'produccion:orden_finalizar' orden.pk %}" class="btn btn-stone-primary text-white">
                        <i class="fas fa-check-circle me-2"></i> Finalizar Orden
                    </a>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const topMenu = document.querySelector('.top-menu');
    if (topMenu) topMenu.style.display = 'none';
});
</script>
{% endblock %}
