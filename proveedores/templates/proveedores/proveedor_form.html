{% extends "base.html" %}
{% load static %}
{% load format_filters %}

{% block title %}
    {% if proveedor %}Editar Proveedor - GestionCloud{% else %}Nuevo Proveedor - GestionCloud{% endif %}
{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
    }

    body {
        background-color: var(--stone-bg);
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(139, 115, 85, 0.08);
        overflow: hidden;
        max-width: 1200px;
        margin: 1.5rem auto;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .header-icon-box {
        width: 48px;
        height: 48px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 12px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.25rem;
    }

    .header-text h1 {
        color: var(--stone-text);
        font-size: 1.35rem;
        margin: 0;
        letter-spacing: -0.5px;
        line-height: 1.1;
    }
    
    .header-text p {
        color: #795548;
        font-size: 0.85rem;
        margin: 0;
        font-weight: 500;
        opacity: 0.9;
    }

    .header-btn {
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: rgba(255,255,255,0.6);
        color: var(--stone-text);
        border-color: rgba(255,255,255,0.8);
    }
    .header-btn:hover {
        background: white;
        transform: translateY(-2px);
    }

    /* Formulario */
    .form-container-body {
        padding: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--stone-secondary);
        font-size: 0.75rem;
        margin-bottom: 0.4rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control, .form-select {
        border: 1px solid #D7CCC8;
        border-radius: 8px;
        font-size: 0.9rem;
        background-color: #fff;
        padding: 0.5rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--stone-primary);
        box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        outline: none;
    }
    
    .form-text {
        font-size: 0.75rem;
        color: #9e9e9e;
        margin-top: 0.25rem;
    }

    /* Tabs Stone Style */
    .nav-tabs-stone {
        border-bottom: 2px solid var(--stone-light);
        margin-bottom: 2rem;
        gap: 0.5rem;
    }
    
    .nav-tabs-stone .nav-item .nav-link {
        border: none;
        color: var(--stone-secondary);
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px 8px 0 0;
        opacity: 0.7;
        transition: all 0.2s;
    }
    
    .nav-tabs-stone .nav-item .nav-link:hover {
        background: rgba(232, 220, 200, 0.3);
        opacity: 1;
    }
    
    .nav-tabs-stone .nav-item .nav-link.active {
        background: var(--stone-light);
        color: var(--stone-text);
        opacity: 1;
        border-bottom: 3px solid var(--stone-primary);
    }
    
    .nav-tabs-stone .nav-item .nav-link i {
        margin-right: 0.5rem;
    }

    /* Contactos Card Style */
    .contacto-card {
        background: #fdfbf7;
        border: 1px solid var(--stone-light);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    .contacto-card .form-label {
        font-size: 0.7rem; /* Aún más pequeño para contactos */
    }

    .btn-stone-primary { 
        background-color: var(--stone-primary); 
        color: white; 
        border: none;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.2);
        transition: all 0.2s;
    }
    .btn-stone-primary:hover {
        background-color: var(--stone-secondary);
        transform: translateY(-1px);
        color: white;
    }
    
    .btn-stone-danger {
        color: #d32f2f;
        background: #ffebee;
        border: 1px solid #ffcdd2;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    .btn-stone-danger:hover {
        background: #ef9a9a;
        color: white;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    
    <!-- CARD PRINCIPAL -->
    <div class="single-card-container">
        
        <!-- HEADER PREMIUM -->
        <div class="stone-header-premium">
            <div class="header-content">
                <div class="header-icon-box">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="header-text">
                    <h1>
                        {% if proveedor %}
                            <span class="fw-light">Editar</span> <span class="fw-bold">Proveedor</span>
                        {% else %}
                            <span class="fw-light">Nuevo</span> <span class="fw-bold">Proveedor</span>
                        {% endif %}
                    </h1>
                    <p>{% if proveedor %}Actualice los datos del proveedor.{% else %}Registre un nuevo socio comercial.{% endif %}</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{% url 'proveedores:proveedor_list' %}" class="header-btn">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>
            </div>
        </div>

        <div class="form-container-body">
            <form method="post" id="proveedorForm">
                {% csrf_token %}

                <!-- TABS STONE -->
                <ul class="nav nav-tabs nav-tabs-stone" id="proveedorTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="datos-basicos-tab" data-bs-toggle="tab" data-bs-target="#datos-basicos" type="button" role="tab">
                            <i class="fas fa-info-circle"></i> Datos Básicos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="datos-comerciales-tab" data-bs-toggle="tab" data-bs-target="#datos-comerciales" type="button" role="tab">
                            <i class="fas fa-handshake"></i> Comerciales
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contactos-tab" data-bs-toggle="tab" data-bs-target="#contactos" type="button" role="tab">
                            <i class="fas fa-users"></i> Contactos
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="proveedorTabsContent">
                    
                    <!-- TAB 1: DATOS BÁSICOS -->
                    <div class="tab-pane fade show active" id="datos-basicos" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.rut.id_for_label }}">RUT <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0" style="border-color: #D7CCC8;"><i class="fas fa-id-card text-muted"></i></span>
                                    <input type="text" name="{{ form.rut.name }}" id="rut-input" class="form-control border-start-0 ps-0" value="{{ form.rut.value|default:'' }}" placeholder="12.345.678-9">
                                    <span class="input-group-text bg-white border-start-0" style="border-color: #D7CCC8;"><i id="rut-icon" class="fas fa-question-circle text-muted"></i></span>
                                </div>
                                <div id="rut-error" class="text-danger small mt-1" style="display:none;"></div>
                                {% if form.rut.errors %}<div class="text-danger small">{{ form.rut.errors.0 }}</div>{% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" for="{{ form.nombre.id_for_label }}">Nombre Fantasía <span class="text-danger">*</span></label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}<div class="text-danger small">{{ form.nombre.errors.0 }}</div>{% endif %}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.razon_social.id_for_label }}">Razón Social</label>
                                {{ form.razon_social }}
                                {% if form.razon_social.errors %}<div class="text-danger small">{{ form.razon_social.errors.0 }}</div>{% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label" for="{{ form.giro.id_for_label }}">Giro Comercial <span class="text-danger">*</span></label>
                                {{ form.giro }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.tipo_proveedor.id_for_label }}">Tipo</label>
                                {{ form.tipo_proveedor }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.estado.id_for_label }}">Estado</label>
                                {{ form.estado }}
                            </div>
                            
                            <div class="col-12"><hr class="my-2 opacity-25"></div>

                            <div class="col-md-6">
                                <label class="form-label" for="{{ form.direccion.id_for_label }}">Dirección <span class="text-danger">*</span></label>
                                {{ form.direccion }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.comuna.id_for_label }}">Comuna <span class="text-danger">*</span></label>
                                {{ form.comuna }}
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="{{ form.ciudad.id_for_label }}">Ciudad</label>
                                {{ form.ciudad }}
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="{{ form.region.id_for_label }}">Región</label>
                                {{ form.region }}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label" for="{{ form.telefono.id_for_label }}">Teléfono <span class="text-danger">*</span></label>
                                {{ form.telefono }}
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" for="{{ form.email.id_for_label }}">Email</label>
                                {{ form.email }}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label" for="{{ form.sitio_web.id_for_label }}">Sitio Web</label>
                                {{ form.sitio_web }}
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: COMERCIALES -->
                    <div class="tab-pane fade" id="datos-comerciales" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="form-label">Plazo de Entrega (Días)</label>
                                {{ form.plazo_entrega }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Condiciones de Pago</label>
                                {{ form.condiciones_pago }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Descuento Base (%)</label>
                                {{ form.descuento_porcentaje }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Calificación (1-5)</label>
                                {{ form.calificacion }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Categoría Principal</label>
                                {{ form.categoria_principal }}
                            </div>
                             <div class="col-12">
                                <label class="form-label">Observaciones Calidad</label>
                                {{ form.observaciones_calidad }}
                            </div>
                             <div class="col-12">
                                <label class="form-label">Observaciones Generales</label>
                                {{ form.observaciones }}
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: CONTACTOS -->
                    <div class="tab-pane fade" id="contactos" role="tabpanel">
                        <div class="alert alert-light border border-stone-light text-muted d-flex align-items-center" role="alert">
                            <i class="fas fa-info-circle me-2 text-stone-secondary"></i>
                            <div>Gestione múltiples contactos para este proveedor. Marque uno como principal.</div>
                        </div>

                        {{ formset.management_form }}
                        
                        <div id="contactos-container">
                            {% for form_contacto in formset %}
                                <div class="contacto-card">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Nombre Contacto <span class="text-danger">*</span></label>
                                            {{ form_contacto.nombre }}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Cargo</label>
                                            {{ form_contacto.cargo }}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Tipo</label>
                                            {{ form_contacto.tipo_contacto }}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Teléfono</label>
                                            {{ form_contacto.telefono }}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Celular</label>
                                            {{ form_contacto.celular }}
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Email</label>
                                            {{ form_contacto.email }}
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end mb-1">
                                            <div class="form-check">
                                                {{ form_contacto.es_contacto_principal }}
                                                <label class="form-check-label small" for="{{ form_contacto.es_contacto_principal.id_for_label }}">Princ.</label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 d-flex justify-content-between align-items-center">
                                            <div class="w-75">
                                                <label class="form-label">Notas</label>
                                                {{ form_contacto.observaciones }}
                                            </div>
                                            <div class="ps-3 pt-4">
                                                {% if form_contacto.instance.pk %}
                                                    <div class="form-check">
                                                        {{ form_contacto.DELETE }}
                                                        <label class="form-check-label text-danger small fw-bold" for="{{ form_contacto.DELETE.id_for_label }}"><i class="fas fa-trash me-1"></i> Eliminar</label>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form_contacto.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-contacto">
                            <i class="fas fa-plus me-1"></i> Agregar Otro Contacto
                        </button>
                    </div>

                </div> <!-- End Tab Content -->

                <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                    <a href="{% url 'proveedores:proveedor_list' %}" class="btn btn-light border">Cancelar</a>
                    <button type="submit" class="btn-stone-primary">
                        <i class="fas fa-save me-2"></i> Guardar Proveedor
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Template Oculto de Contacto (Para JS) -->
<div id="contacto-template" style="display:none;">
    <div class="contacto-card">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Nombre Contacto <span class="text-danger">*</span></label>
                <input type="text" name="contactos-__prefix__-nombre" class="form-control" maxlength="100">
            </div>
            <div class="col-md-4">
                <label class="form-label">Cargo</label>
                <input type="text" name="contactos-__prefix__-cargo" class="form-control" maxlength="100">
            </div>
            <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select name="contactos-__prefix__-tipo_contacto" class="form-select">
                    <option value="ventas">Ventas</option>
                    <option value="cobranza">Cobranza</option>
                    <option value="tecnico">Servicio Técnico</option>
                    <option value="gerencia">Gerencia</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input type="text" name="contactos-__prefix__-telefono" class="form-control" maxlength="20">
            </div>
            <div class="col-md-3">
                <label class="form-label">Celular</label>
                <input type="text" name="contactos-__prefix__-celular" class="form-control" maxlength="20">
            </div>
            <div class="col-md-4">
                <label class="form-label">Email</label>
                <input type="email" name="contactos-__prefix__-email" class="form-control" maxlength="254">
            </div>
            <div class="col-md-2 d-flex align-items-end mb-1">
                <div class="form-check">
                    <input type="checkbox" name="contactos-__prefix__-es_contacto_principal" class="form-check-input">
                    <label class="form-check-label small">Princ.</label>
                </div>
            </div>
            <div class="col-12 d-flex justify-content-between align-items-center">
                 <div class="w-75">
                    <label class="form-label">Notas</label>
                    <input type="text" name="contactos-__prefix__-observaciones" class="form-control">
                </div>
                <div class="ps-3 pt-4">
                    <button type="button" class="btn-stone-danger" onclick="eliminarContactoRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Init Select2
        $('select').select2({
            theme: 'default',
            width: '100%'
        });

        // Add Contacto
        $('#add-contacto').click(function() {
            var formIdx = $('#id_contactos-TOTAL_FORMS').val();
            var tmpl = $('#contacto-template').html().replace(/__prefix__/g, formIdx);
            $('#contactos-container').append(tmpl);
            $('#id_contactos-TOTAL_FORMS').val(parseInt(formIdx) + 1);
            
            // Re-init select2 en nuevos elementos si los hubiera
            // $('#contactos-container .contacto-card:last select').select2();
        });

        window.eliminarContactoRow = function(btn) {
            $(btn).closest('.contacto-card').remove();
            // Nota: no actualizamos TOTAL_FORMS al borrar dinámicamente en cliente simple 
            // a menos que reordenemos indices, pero django maneja esto si es inlineformset con delete checkbox
            // Aquí es un agregado visual simple.
        };

        // RUT Validation Logic (Misma lógica anterior)
        const rutInput = document.getElementById('rut-input');
        if(rutInput) {
            rutInput.addEventListener('input', function() {
                let rut = this.value.replace(/[.-]/g, '');
                if (rut.length > 1) {
                     // Formateo simple
                      if (rut.length <= 9) {
                        // Lógica de formateo...
                      }
                }
                // Validar visualmente
                // ...
            });
        }
    });
</script>
{% endblock %}
