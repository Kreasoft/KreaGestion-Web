{% extends "base.html" %}
{% load static %}
{% load format_filters %}

{% block title %}{{ title }}{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    /* Paleta terrosa para proveedores */
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-card-1 {
        background: linear-gradient(135deg, #D4A574 0%, #C19461 100%);
    }

    .stat-card-2 {
        background: linear-gradient(135deg, #B8956A 0%, #A67C52 100%);
    }

    .stat-card-3 {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
    }

    .filter-section {
        background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .compact-form .row {
        margin-bottom: 8px;
    }

    .compact-form .mb-4 {
        margin-bottom: 12px !important;
    }

    .compact-form .form-label {
        margin-bottom: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .nav-tabs-compact {
        border-bottom: 2px solid #D4C4A8;
        margin-bottom: 15px;
    }

    .nav-tabs-compact .nav-link {
        border: none;
        border-radius: 0;
        padding: 8px 16px;
        font-weight: 500;
        font-size: 0.85rem;
        color: #6F5B44;
        background: transparent;
    }

    .nav-tabs-compact .nav-link.active {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
    }

    .btn-compact {
        padding: 6px 16px;
        font-size: 0.8rem;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden;">

                <!-- HEADER PRINCIPAL -->
                <div class="card-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border: none; border-bottom: 2px solid #D4C4A8; padding: 10px 15px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-truck fa-lg me-2" style="color: #6F5B44;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 1.1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #6F5B44;">
                                    {{ title }}
                                </h5>
                                <small style="font-size: 0.75rem; font-family: 'Poppins', sans-serif; color: #8B7355;">
                                    Gestiona la información completa del proveedor
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm me-2" style="background: rgba(111, 91, 68, 0.15); border: 1px solid rgba(111, 91, 68, 0.25); color: #6F5B44; padding: 4px 8px; font-size: 0.7rem;" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                            </button>
                            <a href="{% url 'proveedores:proveedor_list' %}" class="btn btn-sm me-2" style="background: rgba(139, 115, 85, 0.15); border: 1px solid rgba(139, 115, 85, 0.25); color: #8B7355; padding: 4px 8px; font-size: 0.7rem;">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-sm" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 4px 8px; font-size: 0.7rem;">
                                <i class="fas fa-save me-1"></i> {{ submit_text }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body" style="padding: 15px; background: #FAFAF8;">
                    <form method="post" id="proveedorForm" class="compact-form">
                        {% csrf_token %}

                        <!-- Pestañas compactas -->
                        <ul class="nav nav-tabs nav-tabs-compact" id="proveedorTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="datos-basicos-tab" data-bs-toggle="tab" data-bs-target="#datos-basicos" type="button" role="tab">
                                    <i class="fas fa-truck me-1"></i>Datos Básicos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="datos-comerciales-tab" data-bs-toggle="tab" data-bs-target="#datos-comerciales" type="button" role="tab">
                                    <i class="fas fa-chart-line me-1"></i>Comerciales
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contactos-tab" data-bs-toggle="tab" data-bs-target="#contactos" type="button" role="tab">
                                    <i class="fas fa-address-book me-1"></i>Contactos
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las pestañas -->
                        <div class="tab-content" id="proveedorTabsContent" style="font-family: 'Poppins', sans-serif;">
                            <!-- Pestaña 1: Datos Básicos -->
                            <div class="tab-pane fade show active" id="datos-basicos" role="tabpanel">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.rut.id_for_label }}" class="form-label">
                                            RUT *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-id-card"></i>
                                            </div>
                                            {{ form.rut }}
                                        </div>
                                        <div class="form-text">Ingrese RUT con o sin puntos: 12.345.678-9 o 12345678-9</div>
                                        {% if form.rut.errors %}
                                            <div class="text-danger small">{{ form.rut.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                            Nombre del Proveedor *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-truck"></i>
                                            </div>
                                            {{ form.nombre }}
                                        </div>
                                        {% if form.nombre.errors %}
                                            <div class="text-danger small">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.razon_social.id_for_label }}" class="form-label">
                                            Razón Social
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-building"></i>
                                            </div>
                                            {{ form.razon_social }}
                                        </div>
                                        {% if form.razon_social.errors %}
                                            <div class="text-danger small">{{ form.razon_social.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.giro.id_for_label }}" class="form-label">
                                            Giro Comercial *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-industry"></i>
                                            </div>
                                            {{ form.giro }}
                                        </div>
                                        {% if form.giro.errors %}
                                            <div class="text-danger small">{{ form.giro.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.tipo_proveedor.id_for_label }}" class="form-label">
                                            Tipo de Proveedor
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-tags"></i>
                                            </div>
                                            {{ form.tipo_proveedor }}
                                        </div>
                                        {% if form.tipo_proveedor.errors %}
                                            <div class="text-danger small">{{ form.tipo_proveedor.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.categoria_principal.id_for_label }}" class="form-label">
                                            Categoría Principal
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-folder"></i>
                                            </div>
                                            {{ form.categoria_principal }}
                                        </div>
                                        {% if form.categoria_principal.errors %}
                                            <div class="text-danger small">{{ form.categoria_principal.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.estado.id_for_label }}" class="form-label">
                                            Estado
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-circle"></i>
                                            </div>
                                            {{ form.estado }}
                                        </div>
                                        {% if form.estado.errors %}
                                            <div class="text-danger small">{{ form.estado.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="{{ form.direccion.id_for_label }}" class="form-label">
                                            Dirección *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            {{ form.direccion }}
                                        </div>
                                        {% if form.direccion.errors %}
                                            <div class="text-danger small">{{ form.direccion.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.comuna.id_for_label }}" class="form-label">
                                            Comuna *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-map"></i>
                                            </div>
                                            {{ form.comuna }}
                                        </div>
                                        {% if form.comuna.errors %}
                                            <div class="text-danger small">{{ form.comuna.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.ciudad.id_for_label }}" class="form-label">
                                            Ciudad *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-city"></i>
                                            </div>
                                            {{ form.ciudad }}
                                        </div>
                                        {% if form.ciudad.errors %}
                                            <div class="text-danger small">{{ form.ciudad.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.region.id_for_label }}" class="form-label">
                                            Región *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-globe"></i>
                                            </div>
                                            {{ form.region }}
                                        </div>
                                        {% if form.region.errors %}
                                            <div class="text-danger small">{{ form.region.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.telefono.id_for_label }}" class="form-label">
                                            Teléfono *
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-phone"></i>
                                            </div>
                                            {{ form.telefono }}
                                        </div>
                                        {% if form.telefono.errors %}
                                            <div class="text-danger small">{{ form.telefono.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.email.id_for_label }}" class="form-label">
                                            Email
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-envelope"></i>
                                            </div>
                                            {{ form.email }}
                                        </div>
                                        {% if form.email.errors %}
                                            <div class="text-danger small">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form.sitio_web.id_for_label }}" class="form-label">
                                            Sitio Web
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-globe"></i>
                                            </div>
                                            {{ form.sitio_web }}
                                        </div>
                                        {% if form.sitio_web.errors %}
                                            <div class="text-danger small">{{ form.sitio_web.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pestaña 2: Datos Comerciales -->
                            <div class="tab-pane fade" id="datos-comerciales" role="tabpanel">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.plazo_entrega.id_for_label }}" class="form-label">
                                            Plazo de Entrega
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            {{ form.plazo_entrega }}
                                        </div>
                                        {% if form.plazo_entrega.errors %}
                                            <div class="text-danger small">{{ form.plazo_entrega.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.condiciones_pago.id_for_label }}" class="form-label">
                                            Condiciones de Pago
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-credit-card"></i>
                                            </div>
                                            {{ form.condiciones_pago }}
                                        </div>
                                        {% if form.condiciones_pago.errors %}
                                            <div class="text-danger small">{{ form.condiciones_pago.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.descuento_porcentaje.id_for_label }}" class="form-label">
                                            Descuento por Defecto (%)
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            {{ form.descuento_porcentaje }}
                                        </div>
                                        {% if form.descuento_porcentaje.errors %}
                                            <div class="text-danger small">{{ form.descuento_porcentaje.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label for="{{ form.calificacion.id_for_label }}" class="form-label">
                                            Calificación (1-5)
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-star"></i>
                                            </div>
                                            {{ form.calificacion }}
                                        </div>
                                        {% if form.calificacion.errors %}
                                            <div class="text-danger small">{{ form.calificacion.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12">
                                        <label for="{{ form.observaciones_calidad.id_for_label }}" class="form-label">
                                            Observaciones de Calidad
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-clipboard-check"></i>
                                            </div>
                                            {{ form.observaciones_calidad }}
                                        </div>
                                        {% if form.observaciones_calidad.errors %}
                                            <div class="text-danger small">{{ form.observaciones_calidad.errors.0 }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12">
                                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                            Observaciones Generales
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-text">
                                                <i class="fas fa-sticky-note"></i>
                                            </div>
                                            {{ form.observaciones }}
                                        </div>
                                        {% if form.observaciones.errors %}
                                            <div class="text-danger small">{{ form.observaciones.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pestaña 3: Contactos -->
                            <div class="tab-pane fade" id="contactos" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 style="color: #2c3e50; font-weight: 600; margin-bottom: 8px;">
                                            <i class="fas fa-address-book me-2" style="color: #8B4513;"></i>Contactos del Proveedor
                                        </h6>
                                        <p class="text-muted small">Agrega los contactos principales del proveedor.</p>
                                    </div>
                                </div>
                                
                                {{ formset.management_form }}
                                
                                <div id="contactos-container">
                                    {% for form_contacto in formset %}
                                        <div class="contacto-form" style="border: 1px solid #D4C4A8; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #FAFAF8;">
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <label class="form-label small">Nombre del Contacto *</label>
                                                    {{ form_contacto.nombre }}
                                                    {% if form_contacto.nombre.errors %}
                                                        <div class="text-danger small">{{ form_contacto.nombre.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label small">Cargo</label>
                                                    {{ form_contacto.cargo }}
                                                    {% if form_contacto.cargo.errors %}
                                                        <div class="text-danger small">{{ form_contacto.cargo.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label small">Tipo de Contacto</label>
                                                    {{ form_contacto.tipo_contacto }}
                                                    {% if form_contacto.tipo_contacto.errors %}
                                                        <div class="text-danger small">{{ form_contacto.tipo_contacto.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label small">Teléfono</label>
                                                    {{ form_contacto.telefono }}
                                                    {% if form_contacto.telefono.errors %}
                                                        <div class="text-danger small">{{ form_contacto.telefono.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label small">Celular</label>
                                                    {{ form_contacto.celular }}
                                                    {% if form_contacto.celular.errors %}
                                                        <div class="text-danger small">{{ form_contacto.celular.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label small">Email</label>
                                                    {{ form_contacto.email }}
                                                    {% if form_contacto.email.errors %}
                                                        <div class="text-danger small">{{ form_contacto.email.errors.0 }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        {{ form_contacto.es_contacto_principal }}
                                                        <label class="form-check-label small" for="{{ form_contacto.es_contacto_principal.id_for_label }}">
                                                            Es Contacto Principal
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="col-md-6">
                                                    {% if form_contacto.DELETE %}
                                                        <div class="form-check">
                                                            {{ form_contacto.DELETE }}
                                                            <label class="form-check-label small text-danger" for="{{ form_contacto.DELETE.id_for_label }}">
                                                                Eliminar Contacto
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-12">
                                                    <label class="form-label small">Observaciones</label>
                                                    {{ form_contacto.observaciones }}
                                                    {% if form_contacto.observaciones.errors %}
                                                        <div class="text-danger small">{{ form_contacto.observaciones.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                
                                <button type="button" class="btn btn-sm btn-outline-primary" id="add-contacto">
                                    <i class="fas fa-plus me-1"></i>Agregar Contacto
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validación de RUT en tiempo real
    const rutInput = document.getElementById('rut-input');
    const rutIcon = document.getElementById('rut-icon');
    const rutStatus = document.getElementById('rut-status');
    const rutError = document.getElementById('rut-error');
    const rutHelp = document.getElementById('rut-help');

    if (rutInput) {
        // Validación en tiempo real mientras escribe
        rutInput.addEventListener('input', function() {
            const rut = this.value.trim();
            validarRUTEnTiempoReal(rut);
        });

        // Formateo automático del RUT
        rutInput.addEventListener('keyup', function() {
            let rut = this.value.replace(/[.-]/g, '');
            
            if (rut.length > 1) {
                // Formatear con puntos mientras escribe
                if (rut.length <= 7) {
                    rut = rut.slice(0, 1) + '.' + rut.slice(1, 4) + '.' + rut.slice(4);
                } else if (rut.length <= 8) {
                    rut = rut.slice(0, 2) + '.' + rut.slice(2, 5) + '.' + rut.slice(5);
                } else if (rut.length <= 9) {
                    rut = rut.slice(0, 2) + '.' + rut.slice(2, 5) + '.' + rut.slice(5, 8) + '-' + rut.slice(8);
                }
                
                if (this.value !== rut) {
                    this.value = rut;
                }
            }
            
            validarRUTEnTiempoReal(rut);
        });

        // Validación al perder el foco
        rutInput.addEventListener('blur', function() {
            const rut = this.value.trim();
            validarRUTEnTiempoReal(rut);
        });
    }

    function validarRUTEnTiempoReal(rut) {
        if (rut.length === 0) {
            rutIcon.className = 'fas fa-question-circle';
            rutIcon.style.color = '#6c757d';
            rutStatus.style.backgroundColor = '#f8f9fa';
            rutError.style.display = 'none';
            rutHelp.style.color = '#6c757d';
            return;
        }

        // Limpiar RUT para validación
        const rutLimpio = rut.replace(/[.-]/g, '');
        
        if (rutLimpio.length < 8) {
            rutIcon.className = 'fas fa-exclamation-circle';
            rutIcon.style.color = '#ffc107';
            rutStatus.style.backgroundColor = '#fff3cd';
            rutError.style.display = 'block';
            rutError.textContent = 'RUT muy corto';
            rutHelp.style.color = '#ffc107';
            return;
        }

        if (validarRUT(rut)) {
            rutIcon.className = 'fas fa-check-circle';
            rutIcon.style.color = '#28a745';
            rutStatus.style.backgroundColor = '#d4edda';
            rutError.style.display = 'none';
            rutHelp.style.color = '#28a745';
        } else {
            rutIcon.className = 'fas fa-times-circle';
            rutIcon.style.color = '#dc3545';
            rutStatus.style.backgroundColor = '#f8d7da';
            rutError.style.display = 'block';
            rutError.textContent = 'RUT inválido';
            rutHelp.style.color = '#dc3545';
        }
    }

    function validarRUT(rut) {
        // Limpiar RUT
        const rutLimpio = rut.replace(/[.-]/g, '');
        
        if (rutLimpio.length < 8 || rutLimpio.length > 9) return false;
        
        const numero = rutLimpio.slice(0, -1);
        const dv = rutLimpio.slice(-1).toUpperCase();
        
        // Validar que el número solo contenga dígitos
        if (!/^\d+$/.test(numero)) return false;
        
        // Validar dígito verificador
        if (!/^[0-9K]$/.test(dv)) return false;
        
        let suma = 0;
        let multiplicador = 2;
        
        for (let i = numero.length - 1; i >= 0; i--) {
            suma += parseInt(numero[i]) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }
        
        const resto = suma % 11;
        const dvCalculado = 11 - resto;
        
        if (dvCalculado === 11) return dv === '0';
        if (dvCalculado === 10) return dv === 'K';
        return dv === dvCalculado.toString();
    }

    // Manejo de contactos dinámicos
    const addContactoBtn = document.getElementById('add-contacto');
    const contactosContainer = document.getElementById('contactos-container');
    const totalForms = document.getElementById('id_contactos-TOTAL_FORMS');

    if (addContactoBtn && contactosContainer) {
        addContactoBtn.addEventListener('click', function() {
            const formCount = parseInt(totalForms.value);
            const newForm = contactosContainer.children[0].cloneNode(true);
            
            // Actualizar IDs y nombres de los campos
            const inputs = newForm.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name) {
                    input.name = input.name.replace(/\d+/, formCount);
                    input.id = input.id.replace(/\d+/, formCount);
                    input.value = '';
                }
            });
            
            // Actualizar labels
            const labels = newForm.querySelectorAll('label');
            labels.forEach(label => {
                if (label.htmlFor) {
                    label.htmlFor = label.htmlFor.replace(/\d+/, formCount);
                }
            });
            
            contactosContainer.appendChild(newForm);
            totalForms.value = formCount + 1;
        });
    }
});
</script>
{% endblock %}
