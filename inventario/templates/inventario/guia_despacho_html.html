<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a de Despacho Electr√≥nica - {{ guia.folio }}</title>

    {% load format_filters %}

    <style>
        @page {
            size: A4;
            margin: 1cm;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 8pt;
            line-height: 1.1;
            color: #000;
            margin: 0;
            padding: 8px;
        }

        .guia-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 8px;
        }

        /* Cabecera */
        .header-section {
            display: table;
            width: 100%;
            margin-bottom: 8px;
        }

        .header-left {
            display: table-cell;
            width: 55%;
            vertical-align: top;
            padding-right: 8px;
        }

        .header-right {
            display: table-cell;
            width: 45%;
            vertical-align: top;
        }

        .document-box {
            border: 3px solid #c00;
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
            background: #fff;
        }

        .document-rut {
            font-size: 10pt;
            font-weight: bold;
            color: #c00;
            margin-bottom: 4px;
        }

        .document-type {
            font-size: 11pt;
            font-weight: bold;
            color: #c00;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .document-folio {
            font-size: 12pt;
            font-weight: bold;
            color: #c00;
            margin-bottom: 4px;
        }

        .document-sii {
            font-size: 8pt;
            font-weight: bold;
            color: #c00;
        }

        .company-logo {
            max-width: 180px;
            max-height: 100px;
            margin-bottom: 8px;
            object-fit: contain;
        }

        .company-info {
            font-size: 7pt;
            line-height: 1.2;
            color: #333;
        }

        .company-name {
            font-size: 9pt;
            font-weight: bold;
            margin-bottom: 3px;
            color: #000;
        }

        /* Receptor */
        .receptor-section {
            border: 1px solid #ccc;
            padding: 6px;
            margin-bottom: 8px;
            background: #f9f9f9;
        }

        .receptor-title {
            font-size: 8pt;
            font-weight: bold;
            margin-bottom: 4px;
            color: #000;
        }

        .receptor-info {
            font-size: 7pt;
            line-height: 1.3;
        }

        .receptor-row {
            margin-bottom: 2px;
        }

        .receptor-label {
            font-weight: bold;
            display: inline-block;
            width: 80px;
        }

        /* Tabla de detalle */
        .detalle-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
            font-size: 7pt;
        }

        .detalle-table thead {
            background: #333;
            color: white;
        }

        .detalle-table th {
            padding: 4px 3px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #333;
            font-size: 7pt;
        }

        .detalle-table td {
            padding: 3px;
            border: 1px solid #ddd;
            font-size: 7pt;
        }

        .detalle-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        /* Totales */
        .totales-section {
            float: right;
            width: 250px;
            margin-top: 8px;
        }

        .totales-table {
            width: 100%;
            font-size: 8pt;
        }

        .totales-table td {
            padding: 3px 6px;
            border-bottom: 1px solid #ddd;
        }

        .totales-label {
            font-weight: bold;
            text-align: right;
        }

        .totales-value {
            text-align: right;
            font-weight: bold;
        }

        .total-final {
            background: #333;
            color: white;
            font-size: 9pt;
        }

        /* Pie de p√°gina */
        .footer-section {
            clear: both;
            margin-top: 15px;
            padding-top: 8px;
            border-top: 2px solid #333;
            font-size: 7pt;
            text-align: center;
        }

        .timbre-section {
            margin-top: 10px;
            text-align: center;
        }

        .observaciones {
            margin-top: 10px;
            padding: 6px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            font-size: 7pt;
        }

        @media print {
            body {
                padding: 0;
            }

            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="guia-container">
        <!-- CABECERA -->
        <div class="header-section">
            <div class="header-left">
                {% if empresa.logo %}
                <img src="{{ empresa.logo.url }}" alt="{{ empresa.nombre }}" class="company-logo">
                {% elif guia.empresa.logo %}
                <img src="{{ guia.empresa.logo.url }}" alt="{{ empresa.nombre }}" class="company-logo">
                {% endif %}
                <div class="company-name">{{ empresa.nombre|upper }}</div>
                <div class="company-info">
                    <strong>Giro:</strong> {{ empresa.giro|default:"Comercial" }}<br>
                    <strong>Direcci√≥n:</strong> {{ empresa.direccion|default:"-" }}<br>
                    <strong>Comuna:</strong> {{ empresa.comuna|default:"-" }}<br>
                    <strong>Tel√©fono:</strong> {{ empresa.telefono|default:"-" }}<br>
                    <strong>Email:</strong> {{ empresa.email|default:"-" }}
                </div>
            </div>
            <div class="header-right">
                <div class="document-box">
                    <div class="document-rut">R.U.T.: {{ empresa.rut }}</div>
                    <div class="document-type">
                        GU√çA DE DESPACHO<br>
                        ELECTR√ìNICA
                    </div>
                    <div class="document-folio">N¬∞ {{ guia.folio }}</div>
                    <div class="document-sii">S.I.I. - {{ empresa.oficina_sii|default:"SANTIAGO" }}</div>
                </div>
            </div>
        </div>

        <!-- RECEPTOR -->
        <div class="receptor-section">
            <div class="receptor-title">SE√ëOR(ES):</div>
            <div class="receptor-info">
                <div class="receptor-row">
                    <span class="receptor-label">Raz√≥n Social:</span>
                    <span>{{ guia.razon_social_receptor }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">RUT:</span>
                    <span>{{ guia.rut_receptor }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">Giro:</span>
                    <span>{{ guia.giro_receptor|default:"-" }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">Direcci√≥n:</span>
                    <span>{{ guia.direccion_receptor }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">Comuna:</span>
                    <span>{{ guia.comuna_receptor }} - {{ guia.ciudad_receptor }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">Fecha Emisi√≥n:</span>
                    <span>{{ guia.fecha_emision|date:"d-m-Y" }}</span>
                </div>
                <div class="receptor-row">
                    <span class="receptor-label">Tipo Traslado:</span>
                    <span>{{ guia.get_tipo_traslado_display }}</span>
                </div>
            </div>
        </div>

        <!-- DETALLE -->
        <table class="detalle-table">
            <thead>
                <tr>
                    <th style="width: 8%;">C√≥digo</th>
                    <th style="width: 42%;">Descripci√≥n</th>
                    <th style="width: 10%;" class="text-center">Cantidad</th>
                    <th style="width: 13%;" class="text-right">Precio Unit.</th>
                    <th style="width: 13%;" class="text-right">Descuento</th>
                    <th style="width: 14%;" class="text-right">Total</th>
                </tr>
            </thead>
            <tbody>
                {% if transferencia %}
                {% for detalle in transferencia.detalles.all %}
                <tr>
                    <td>{{ detalle.articulo.codigo }}</td>
                    <td>{{ detalle.articulo.nombre }}</td>
                    <td class="text-center">{{ detalle.cantidad }}</td>
                    <td class="text-right">${{ detalle.articulo.precio_venta|format_miles }}</td>
                    <td class="text-right">$0</td>
                    <td class="text-right">${{ detalle.total|format_miles }}</td>
                </tr>
                {% endfor %}
                {% elif detalles %}
                {% for detalle in detalles %}
                <tr>
                    <td>{{ detalle.articulo.codigo }}</td>
                    <td>{{ detalle.articulo.nombre }}</td>
                    <td class="text-center">{{ detalle.cantidad }}</td>
                    <td class="text-right">${{ detalle.precio_unitario|format_miles }}</td>
                    <td class="text-right">$0</td>
                    <td class="text-right">${{ detalle.precio_total|format_miles }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>

        <!-- SECCI√ìN INFERIOR: TIMBRE Y TOTALES -->
        <div style="display: table; width: 100%; margin-top: 10px;">
            <!-- TIMBRE (izquierda) -->
            <div style="display: table-cell; width: 45%; vertical-align: top; padding-right: 10px;">
                {% if guia.timbre_pdf417 %}
                <div class="timbre-section" style="text-align: center; margin-top: 0;">
                    <img src="{{ guia.timbre_pdf417.url }}" alt="Timbre Electr√≥nico"
                        style="max-width: 100%; height: auto;">
                    <div style="font-size: 7pt; margin-top: 5px;">
                        <strong>TIMBRE ELECTR√ìNICO SII</strong><br>
                        Folio: {{ guia.folio }}<br>
                        Verifique en www.sii.cl
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; padding: 20px; background: #f0f0f0; border: 2px dashed #ccc;">
                    <strong>DOCUMENTO TRIBUTARIO ELECTR√ìNICO</strong><br>
                    <small>Timbre Electr√≥nico SII</small><br>
                    <small>Verifique documento en www.sii.cl</small>
                </div>
                {% endif %}
            </div>

            <!-- TOTALES (derecha) -->
            <div style="display: table-cell; width: 55%; vertical-align: top;">
                <div class="totales-section">
                    <table class="totales-table">
                        <tr>
                            <td class="totales-label">NETO:</td>
                            <td class="totales-value">${{ guia.monto_neto|format_miles }}</td>
                        </tr>
                        <tr>
                            <td class="totales-label">IVA (19%):</td>
                            <td class="totales-value">${{ guia.monto_iva|format_miles }}</td>
                        </tr>
                        <tr class="total-final">
                            <td class="totales-label">TOTAL:</td>
                            <td class="totales-value">${{ guia.monto_total|format_miles }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div style="clear: both;"></div>

        <!-- OBSERVACIONES -->
        {% if guia.glosa_sii %}
        <div class="observaciones">
            <strong>OBSERVACIONES:</strong><br>
            {{ guia.glosa_sii }}
        </div>
        {% endif %}

        <!-- PIE DE P√ÅGINA -->
        <div class="footer-section">
            {% if transferencia %}
            <div style="margin-top: 8px;">
                <strong>Transferencia:</strong> {{ transferencia.numero_folio }} |
                <strong>Origen:</strong> {{ transferencia.bodega_origen.nombre }} ‚Üí
                <strong>Destino:</strong> {{ transferencia.bodega_destino.nombre }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Botones de acci√≥n (no se imprimen) -->
    <div class="no-print"
        style="text-align: center; margin-top: 20px; padding: 15px; background-color: #f2f2f2; border-top: 1px solid #ddd;">
        <button onclick="window.print()"
            style="padding: 12px 25px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; margin-right: 10px;">
            üñ®Ô∏è Imprimir
        </button>
        <button onclick="safeCloseWindow()"
            style="padding: 12px 25px; font-size: 16px; cursor: pointer; background-color: #f44336; color: white; border: none; border-radius: 5px;">
            ‚ùå Cerrar
        </button>
    </div>
    <script>
        function safeCloseWindow() {
            // Intentar cerrar la ventana de varias formas
            try {
                // Si la ventana fue abierta por un script, intentar cerrarla
                if (window.opener && window.opener !== window) {
                    window.close();
                    return;
                }
            } catch (e) {
                console.log('No se pudo cerrar con window.close()');
            }

            // Si no se puede cerrar, intentar volver atr√°s
            try {
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Si no hay historial, redirigir al libro de ventas
                    window.location.href = "{% url 'facturacion_electronica:dte_list' %}";
                }
            } catch (e) {
                console.log('No se pudo volver atr√°s');
                // √öltimo recurso: intentar cerrar de todas formas
                try {
                    window.close();
                } catch (e2) {
                    // Si nada funciona, mostrar mensaje
                    alert('No se puede cerrar esta ventana. Por favor, ci√©rrela manualmente.');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('auto') && urlParams.get('auto') === '1') {
                // Asignar el evento onafterprint para cerrar la ventana
                window.addEventListener('afterprint', function () {
                    setTimeout(function () {
                        safeCloseWindow();
                    }, 500);
                });

                // Disparar la impresi√≥n
                // Usar un peque√±o timeout para asegurar que el DOM est√° listo
                setTimeout(function () {
                    window.print();
                }, 100);
            }
        });
    </script>
</body>

</html>