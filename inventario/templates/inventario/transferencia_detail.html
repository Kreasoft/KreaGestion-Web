{% extends 'base.html' %}
{% load static %}

{% block body_class %}hide-top-bar{% endblock %}

{% block page_title %}{{ titulo }} - GestionCloud{% endblock %}

{% block extra_head %}
<style>
    body {
        background: #FAFAF8 !important;
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 15px; background: #FAFAF8; min-height: 100vh;">
    <div class="row">
        <div class="col-12">
            <div class="card" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);">
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border-bottom: 3px solid #D4C4A8; padding: 15px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exchange-alt me-3" style="font-size: 1.8rem; color: #F5F1E8;"></i>
                            <div>
                                <h5 class="mb-1" style="font-size: 1.3rem; font-weight: 600; color: white;">
                                    Transferencia {{ transferencia.numero_folio }}
                                </h5>
                                <small style="font-size: 0.75rem; color: #F5F1E8;">
                                    Detalle de la transferencia de inventario
                                </small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'inventario:transferencia_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.2); border: 1px solid rgba(245, 241, 232, 0.3); color: white; font-size: 0.75rem;">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                            {% if transferencia.estado != 'cancelado' %}
                            {% if not transferencia.guia_despacho %}
                            <button type="button" id="btnGenerarGuia" class="btn btn-sm" style="background: rgba(107, 142, 35, 0.9); border: 1px solid #6B8E23; color: white; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-file-invoice me-1"></i> Generar Guía
                            </button>
                            {% else %}
                            <a href="{% url 'inventario:transferencia_imprimir_guia' transferencia.pk %}" target="_blank" class="btn btn-sm" style="background: rgba(107, 142, 35, 0.9); border: 1px solid #6B8E23; color: white; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-print me-1"></i> Imprimir Guía N° {{ transferencia.guia_despacho.folio }}
                            </a>
                            {% endif %}
                            <a href="{% url 'inventario:transferencia_create' %}?edit={{ transferencia.pk }}" class="btn btn-sm" style="background: rgba(212, 165, 116, 0.9); border: 1px solid #D4A574; color: white; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-edit me-1"></i> Editar
                            </a>
                            <a href="{% url 'inventario:transferencia_cancelar' transferencia.pk %}" class="btn btn-sm" style="background: rgba(193, 148, 97, 0.9); border: 1px solid #C19461; color: white; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body" style="background: #FAFAF8; padding: 15px;">
                    <div class="row g-2">
                        <!-- Información General -->
                        <div class="col-md-4">
                            <div class="card" style="border: 1px solid #E8DCC8; border-radius: 8px; background: #FFFFFF;">
                                <div class="card-header text-white py-2" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);">
                                    <h6 class="mb-0" style="font-size: 0.85rem;"><i class="fas fa-info-circle me-2"></i>Información General</h6>
                                </div>
                                <div class="card-body p-2" style="font-size: 0.8rem;">
                                    <div class="mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Número de Folio</div>
                                        <div class="fw-bold" style="font-size: 1.1rem; color: #8B7355;">{{ transferencia.numero_folio }}</div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Estado</div>
                                        <div>
                                            {% if transferencia.estado == 'pendiente' %}
                                            <span class="badge" style="background: #D4A574; font-size: 0.7rem;">Pendiente</span>
                                            {% elif transferencia.estado == 'confirmado' %}
                                            <span class="badge" style="background: #6B8E23; font-size: 0.7rem;">Confirmado</span>
                                            {% elif transferencia.estado == 'cancelado' %}
                                            <span class="badge" style="background: #C19461; font-size: 0.7rem;">Cancelado</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Fecha</div>
                                        <div class="fw-bold" style="color: #6F5B44;">{{ transferencia.fecha_transferencia|date:"d/m/Y H:i" }}</div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Creado Por</div>
                                        <div class="fw-bold" style="color: #6F5B44;">
                                            <i class="fas fa-user me-1" style="font-size: 0.7rem;"></i>
                                            {{ transferencia.creado_por.get_full_name|default:transferencia.creado_por.username }}
                                        </div>
                                    </div>
                                    
                                    {% if transferencia.observaciones %}
                                    <div class="mb-0">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Observaciones</div>
                                        <div class="alert alert-info mb-0 py-1 px-2" style="font-size: 0.75rem; background: rgba(139, 115, 85, 0.1); border-color: #E8DCC8;">
                                            {{ transferencia.observaciones }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Bodegas -->
                            <div class="card mt-2" style="border: 1px solid #E8DCC8; border-radius: 8px; background: #FFFFFF;">
                                <div class="card-header text-white py-2" style="background: linear-gradient(135deg, #6B8E23 0%, #8B9F4A 100%);">
                                    <h6 class="mb-0" style="font-size: 0.85rem;"><i class="fas fa-warehouse me-2"></i>Bodegas</h6>
                                </div>
                                <div class="card-body p-2" style="font-size: 0.8rem;">
                                    <div class="mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Origen</div>
                                        <div class="fw-bold" style="color: #C19461;">
                                            <i class="fas fa-arrow-up me-1" style="font-size: 0.7rem;"></i>
                                            {{ transferencia.bodega_origen.nombre }}
                                        </div>
                                        <small style="font-size: 0.65rem; color: #999;">{{ transferencia.bodega_origen.codigo }}</small>
                                    </div>
                                    
                                    <div class="text-center my-2">
                                        <i class="fas fa-arrow-down" style="font-size: 1.2rem; color: #8B7355;"></i>
                                    </div>
                                    
                                    <div class="mb-0">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Destino</div>
                                        <div class="fw-bold" style="color: #6B8E23;">
                                            <i class="fas fa-arrow-down me-1" style="font-size: 0.7rem;"></i>
                                            {{ transferencia.bodega_destino.nombre }}
                                        </div>
                                        <small style="font-size: 0.65rem; color: #999;">{{ transferencia.bodega_destino.codigo }}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="card mt-2" style="border: 1px solid #E8DCC8; border-radius: 8px; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%);">
                                <div class="card-body p-2">
                                    <div class="text-center mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Total Artículos</div>
                                        <div class="fw-bold" style="font-size: 1.3rem; color: #8B7355;">{{ total_articulos }}</div>
                                    </div>
                                    <div class="text-center mb-2">
                                        <div style="font-size: 0.65rem; color: #6F5B44; font-weight: 600;">Total Unidades</div>
                                        <div class="fw-bold" style="font-size: 1.1rem; color: #6B8E23;">{{ total_cantidad }}</div>
                                    </div>
                                    <hr class="my-2" style="border-color: #D4C4A8;">
                                    <div class="d-flex justify-content-between px-2 mb-1">
                                        <span style="font-size: 0.7rem; color: #6F5B44;">Subtotal:</span>
                                        <span class="fw-bold" style="font-size: 0.8rem; color: #6F5B44;">${{ subtotal|floatformat:0 }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between px-2 mb-1">
                                        <span style="font-size: 0.7rem; color: #6F5B44;">IVA (19%):</span>
                                        <span class="fw-bold" style="font-size: 0.8rem; color: #6F5B44;">${{ iva|floatformat:0 }}</span>
                                    </div>
                                    <hr class="my-2" style="border-color: #D4C4A8;">
                                    <div class="text-center">
                                        <div style="font-size: 0.7rem; color: #6F5B44; font-weight: 600;">TOTAL</div>
                                        <div class="fw-bold" style="font-size: 1.5rem; color: #8B7355;">${{ total_con_iva|floatformat:0 }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detalle de Artículos -->
                        <div class="col-md-8">
                            <div class="card" style="border: 1px solid #E8DCC8; border-radius: 8px; background: #FFFFFF;">
                                <div class="card-header text-white py-2" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);">
                                    <h6 class="mb-0" style="font-size: 0.85rem;"><i class="fas fa-boxes me-2"></i>Artículos Transferidos</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle table-sm mb-0" style="font-size: 0.8rem;">
                                            <thead style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); color: #6F5B44;">
                                                <tr>
                                                    <th class="py-2" style="font-size: 0.75rem;">Código</th>
                                                    <th class="py-2" style="font-size: 0.75rem;">Artículo</th>
                                                    <th class="text-center py-2" style="font-size: 0.75rem;">Cantidad</th>
                                                    <th class="text-end py-2" style="font-size: 0.75rem;">Precio Unit.</th>
                                                    <th class="text-end py-2" style="font-size: 0.75rem;">Total</th>
                                                    <th class="text-center py-2" style="font-size: 0.75rem;">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for detalle in detalles %}
                                                <tr style="border-bottom: 1px solid #E8DCC8;">
                                                    <td class="py-2">
                                                        <code style="color: #8B7355; font-size: 0.75rem;">{{ detalle.articulo.codigo }}</code>
                                                    </td>
                                                    <td class="py-2">
                                                        <strong style="color: #6F5B44;">{{ detalle.articulo.nombre }}</strong>
                                                        {% if detalle.articulo.unidad_medida %}
                                                        <br><small style="font-size: 0.65rem; color: #999;">{{ detalle.articulo.unidad_medida.nombre }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center py-2">
                                                        <span class="badge" style="background: #A0826D; font-size: 0.7rem;">{{ detalle.cantidad }}</span>
                                                    </td>
                                                    <td class="text-end py-2" style="color: #6F5B44;">
                                                        ${{ detalle.precio_unitario|floatformat:0 }}
                                                    </td>
                                                    <td class="text-end py-2 fw-bold" style="color: #8B7355;">
                                                        ${{ detalle.total|floatformat:0 }}
                                                    </td>
                                                    <td class="text-center py-2">
                                                        {% if detalle.estado == 'confirmado' %}
                                                        <span class="badge" style="background: #6B8E23; font-size: 0.7rem;">Confirmado</span>
                                                        {% elif detalle.estado == 'cancelado' %}
                                                        <span class="badge" style="background: #C19461; font-size: 0.7rem;">Cancelado</span>
                                                        {% else %}
                                                        <span class="badge" style="background: #D4A574; font-size: 0.7rem;">{{ detalle.get_estado_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center py-4">
                                                        <i class="fas fa-inbox fa-2x" style="color: #D4C4A8;"></i>
                                                        <p class="text-muted mt-2 mb-0" style="font-size: 0.8rem;">No hay artículos en esta transferencia</p>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Generar guía electrónica
document.addEventListener('DOMContentLoaded', function() {
    const btnGenerarGuia = document.getElementById('btnGenerarGuia');
    if (btnGenerarGuia) {
        btnGenerarGuia.addEventListener('click', function() {
            Swal.fire({
                title: '¿Generar Guía de Despacho Electrónica?',
                html: `
                    <div class="text-start">
                        <p class="mb-2">Se generará una Guía de Despacho Electrónica (Tipo 52) para esta transferencia.</p>
                        <p class="mb-2"><strong>Datos de la transferencia:</strong></p>
                        <ul class="small">
                            <li>Folio: {{ transferencia.numero_folio }}</li>
                            <li>Origen: {{ transferencia.bodega_origen.nombre }}</li>
                            <li>Destino: {{ transferencia.bodega_destino.nombre }}</li>
                            <li>Total: ${{ total_con_iva|floatformat:0 }}</li>
                        </ul>
                        <p class="mb-0 small text-muted">Se utilizará un folio del CAF disponible para Guías de Despacho.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6B8E23',
                cancelButtonColor: '#C19461',
                confirmButtonText: '<i class="fas fa-check me-2"></i>Sí, Generar Guía',
                cancelButtonText: 'Cancelar',
                customClass: {
                    popup: 'swal-wide'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Generando Guía...',
                        html: 'Por favor espere mientras se genera la guía electrónica.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Enviar solicitud para generar guía
                    fetch('{% url "inventario:transferencia_generar_guia" transferencia.pk %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Guía Generada!',
                                html: `Guía de Despacho N° <strong>${data.folio}</strong> generada exitosamente.`,
                                confirmButtonColor: '#6B8E23',
                                confirmButtonText: 'Aceptar'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'No se pudo generar la guía electrónica',
                                confirmButtonColor: '#C19461',
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error al generar la guía',
                            confirmButtonColor: '#C19461',
                            confirmButtonText: 'Aceptar'
                        });
                    });
                }
            });
        });
    }
});
</script>

{% if messages %}
<script>
    {% for message in messages %}
        Swal.fire({
            icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" %}error{% elif message.tags == "warning" %}warning{% else %}info{% endif %}',
            title: '{% if message.tags == "success" %}¡Éxito!{% elif message.tags == "error" %}Error{% elif message.tags == "warning" %}Advertencia{% else %}Información{% endif %}',
            text: '{{ message|escapejs }}',
            confirmButtonColor: '#8B7355',
            confirmButtonText: 'Aceptar'
        });
    {% endfor %}
</script>
{% endif %}
{% endblock %}
