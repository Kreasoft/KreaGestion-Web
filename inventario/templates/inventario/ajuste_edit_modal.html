<div class="modal-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none;">
    <div class="d-flex align-items-center">
        <i class="fas fa-edit fa-2x text-white me-3"></i>
        <div>
            <h5 class="mb-0 text-white">Editar Ajuste de Stock</h5>
            <small class="text-white-50">Modifique los datos del ajuste</small>
        </div>
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <form method="post" id="ajusteForm">
        {% csrf_token %}
        <input type="hidden" name="detalles_data" id="detalles_data">
        
        <!-- Datos del Ajuste -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Tipo de Ajuste <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <div class="input-group-text" style="background-color: #f8f9fa;">
                            <i class="fas fa-exchange-alt" style="color: #6c757d;"></i>
                        </div>
                        <select name="tipo_ajuste" id="tipo_ajuste" class="form-select" required style="border-left: none;">
                            <option value="ENTRADA" {% if ajuste.cantidad > 0 %}selected{% endif %}>Entrada</option>
                            <option value="SALIDA" {% if ajuste.cantidad < 0 %}selected{% endif %}>Salida</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Fecha del Ajuste <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <div class="input-group-text" style="background-color: #f8f9fa;">
                            <i class="fas fa-calendar" style="color: #6c757d;"></i>
                        </div>
                        <input type="date" name="fecha_ajuste" class="form-control" required value="{{ ajuste.fecha_movimiento|date:'Y-m-d' }}" style="border-left: none;">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Bodega <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <div class="input-group-text" style="background-color: #f8f9fa;">
                            <i class="fas fa-warehouse" style="color: #6c757d;"></i>
                        </div>
                        <select name="bodega" id="bodega" class="form-select" required style="border-left: none;">
                            {% for bodega in bodegas %}
                                <option value="{{ bodega.id }}" {% if bodega.id == ajuste.bodega_destino.id %}selected{% endif %}>{{ bodega.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Descripción <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <div class="input-group-text" style="background-color: #f8f9fa;">
                            <i class="fas fa-comment" style="color: #6c757d;"></i>
                        </div>
                        <input type="text" name="descripcion" class="form-control" required value="{{ ajuste.descripcion }}" style="border-left: none;">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- UNA SOLA TARJETA para todos los artículos -->
        <div class="card mt-3" style="border: 1px solid #E8DCC8;">
            <div class="card-header" style="background: #F5F1E8; padding: 10px;">
                <div class="d-flex justify-content-between align-items-center">
                    <span style="font-weight: 600; color: #6F5B44; font-size: 0.85rem;">
                        <i class="fas fa-list me-2"></i>Artículos del Ajuste
                        <span class="badge ms-2" id="contadorArticulos" style="background: #8B7355; font-size: 0.65rem;">1</span>
                    </span>
                    <button type="button" class="btn btn-sm btn-agregar" style="background: #8B7355; color: white; font-size: 0.7rem; padding: 4px 10px;">
                        <i class="fas fa-plus me-1"></i>Agregar
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 10px;">
                <!-- Header de columnas -->
                <div class="row mb-1" style="font-size: 0.7rem; font-weight: 600; color: #6F5B44;">
                    <div class="col-5">Artículo</div>
                    <div class="col-3">Cantidad</div>
                    <div class="col-3">Comentario</div>
                    <div class="col-1"></div>
                </div>
                
                <div id="detallesContainer">
                    <!-- Item existente -->
                    <div class="row mb-2 align-items-center detalle-item" id="detalle-1">
                        <div class="col-5">
                            <select class="form-select form-select-sm articulo-select" name="detalles-1-articulo" required style="font-size: 0.75rem;">
                                <option value="{{ ajuste.articulo.id }}" selected>{{ ajuste.articulo.codigo }} - {{ ajuste.articulo.nombre }}</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text cantidad-sign" style="font-weight: bold; {% if ajuste.cantidad > 0 %}color: #28a745;{% else %}color: #dc3545;{% endif %} font-size: 0.75rem;">{% if ajuste.cantidad > 0 %}+{% else %}-{% endif %}</span>
                                <input type="number" class="form-control" name="detalles-1-cantidad" id="cantidad-input-1"
                                       value="{% if cantidad_absoluta_str %}{{ cantidad_absoluta_str }}{% elif cantidad_absoluta %}{{ cantidad_absoluta|floatformat:2 }}{% else %}0.00{% endif %}"
                                       step="0.01" min="0.01" required style="font-size: 0.75rem;">
                            </div>
                        </div>
                        <div class="col-3">
                            <input type="text" class="form-control form-control-sm" name="detalles-1-comentario" placeholder="Opcional" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-1">
                            <button type="button" class="btn btn-danger btn-sm w-100 btn-eliminar" data-id="1" style="padding: 4px; font-size: 0.7rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-2"></i>Cancelar
    </button>
    <button type="button" class="btn btn-guardar" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white;">
        <i class="fas fa-save me-2"></i>Guardar Cambios
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function() {
    let detalleCount = 1;
    let articulos = [];
    
    // Asegurar que la cantidad se cargue correctamente
    setTimeout(function() {
        const cantidadInput = document.getElementById('cantidad-input-1');
        if (cantidadInput) {
            console.log('Valor inicial del input cantidad:', cantidadInput.value);
            console.log('Cantidad absoluta desde template:', '{{ cantidad_absoluta_str|default:cantidad_absoluta|default:"0.00" }}');
            
            // Si el input está vacío o es 0, intentar cargar el valor
            if (!cantidadInput.value || cantidadInput.value === '0' || cantidadInput.value === '0.00') {
                const cantidadDesdeTemplate = parseFloat('{{ cantidad_absoluta|default:0 }}');
                if (cantidadDesdeTemplate > 0) {
                    cantidadInput.value = cantidadDesdeTemplate.toFixed(2);
                    console.log('Cantidad cargada desde template:', cantidadDesdeTemplate);
                }
            }
        }
    }, 100);
    
    // Cargar artículos
    setTimeout(function() {
        const bodegaId = document.getElementById('bodega').value;
        if (bodegaId) {
            fetch('/inventario/api/articulos-ajuste/?bodega_id=' + bodegaId)
                .then(r => r.json())
                .then(data => {
                    articulos = data.articulos || [];
                    console.log('Artículos cargados:', articulos.length);
                    actualizarSelects();
                });
        }
    }, 200);
    
    function actualizarSelects() {
        document.querySelectorAll('.articulo-select').forEach(select => {
            const valorActual = select.value;
            const primeraOpcion = select.querySelector('option');
            select.innerHTML = '';
            if (primeraOpcion) select.appendChild(primeraOpcion);
            
            articulos.forEach(art => {
                const opt = document.createElement('option');
                opt.value = art.id;
                opt.textContent = art.codigo + ' - ' + art.nombre;
                select.appendChild(opt);
            });
            
            if (valorActual) select.value = valorActual;
        });
    }
    
    // Event delegation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-agregar')) {
            detalleCount++;
            const html = `
                <div class="row mb-2 align-items-center detalle-item" id="detalle-${detalleCount}">
                    <div class="col-5">
                        <select class="form-select form-select-sm articulo-select" name="detalles-${detalleCount}-articulo" required style="font-size: 0.75rem;">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text" style="font-weight: bold; color: #28a745; font-size: 0.75rem;">+</span>
                            <input type="number" class="form-control" name="detalles-${detalleCount}-cantidad" step="0.01" min="0.01" required style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="col-3">
                        <input type="text" class="form-control form-control-sm" name="detalles-${detalleCount}-comentario" placeholder="Opcional" style="font-size: 0.75rem;">
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-danger btn-sm w-100 btn-eliminar" data-id="${detalleCount}" style="padding: 4px; font-size: 0.7rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('detallesContainer').insertAdjacentHTML('beforeend', html);
            actualizarSelects();
            document.getElementById('contadorArticulos').textContent = document.querySelectorAll('.detalle-item').length;
        }
        
        if (e.target.closest('.btn-eliminar')) {
            const id = e.target.closest('.btn-eliminar').dataset.id;
            document.getElementById('detalle-' + id).remove();
            document.getElementById('contadorArticulos').textContent = document.querySelectorAll('.detalle-item').length;
        }
        
        if (e.target.closest('.btn-guardar')) {
            const tipoAjuste = document.getElementById('tipo_ajuste').value;
            const detalles = [];
            document.querySelectorAll('.detalle-item').forEach(item => {
                const art = item.querySelector('.articulo-select').value;
                const cantInput = item.querySelector('input[name*="cantidad"]');
                const cant = cantInput ? parseFloat(cantInput.value) : 0;
                const com = item.querySelector('input[name*="comentario"]') ? item.querySelector('input[name*="comentario"]').value : '';
                
                if (art && cant > 0) {
                    // Aplicar signo según el tipo de ajuste
                    const cantidadFinal = tipoAjuste === 'ENTRADA' ? cant : -cant;
                    detalles.push({ articulo_id: art, cantidad: cantidadFinal, comentario: com });
                }
            });
            
            if (detalles.length === 0) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Debe agregar al menos un artículo' });
                return;
            }
            
            document.getElementById('detalles_data').value = JSON.stringify(detalles);
            
            Swal.fire({ title: 'Guardando...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => { Swal.showLoading(); } });
            
            fetch(window.location.href, {
                method: 'POST',
                body: new FormData(document.getElementById('ajusteForm'))
            })
            .then(r => {
                if (!r.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return r.json();
            })
            .then(data => {
                Swal.close();
                if (data.success) {
                    Swal.fire({ icon: 'success', title: '¡Éxito!', text: data.message }).then(() => {
                        const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
                        if (modal) {
                            modal.hide();
                        }
                        window.location.reload();
                    });
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Error desconocido' });
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'Error al guardar el ajuste: ' + error.message });
            });
        }
    });
    
    document.getElementById('bodega').addEventListener('change', function() {
        fetch('/inventario/api/articulos-ajuste/?bodega_id=' + this.value)
            .then(r => r.json())
            .then(data => {
                articulos = data.articulos || [];
                actualizarSelects();
            });
    });
    
    // Actualizar signos cuando cambia el tipo de ajuste
    document.getElementById('tipo_ajuste').addEventListener('change', function() {
        const tipoAjuste = this.value;
        const signos = document.querySelectorAll('.cantidad-sign');
        
        signos.forEach(signo => {
            if (tipoAjuste === 'ENTRADA') {
                signo.textContent = '+';
                signo.style.color = '#28a745';
            } else {
                signo.textContent = '-';
                signo.style.color = '#dc3545';
            }
        });
    });
    
    // Asegurar que al guardar se aplique el signo correcto según el tipo de ajuste
    const originalGuardar = document.querySelector('.btn-guardar');
    if (originalGuardar) {
        originalGuardar.addEventListener('click', function() {
            const tipoAjuste = document.getElementById('tipo_ajuste').value;
            const cantidadInput = document.querySelector('input[name*="cantidad"]');
            
            if (cantidadInput && tipoAjuste === 'SALIDA') {
                // Asegurar que la cantidad sea positiva antes de guardar
                const cantidad = parseFloat(cantidadInput.value);
                if (cantidad < 0) {
                    cantidadInput.value = Math.abs(cantidad).toFixed(2);
                }
            }
        });
    }
})();
</script>
