{% extends "base.html" %}
{% load static %}

{% block title %}Carga Inicial de Inventario - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_head %}
<style>
    /* Fondo terroso suave como en libro de ventas */
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid" style="margin-top: 20px;">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden;">

                <!-- HEADER PRINCIPAL -->
                <div class="card-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border: none; border-bottom: 2px solid #D4C4A8; padding: 10px 15px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-upload fa-lg me-2" style="color: #6F5B44;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 1.1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #6F5B44;">
                                    Carga Inicial de Inventario
                                </h5>
                                <small style="font-size: 0.75rem; font-family: 'Poppins', sans-serif; color: #8B7355;">
                                    Importa tu inventario desde Excel o edita manualmente
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <a href="{% url 'inventario:inventario_list' %}" class="btn btn-sm me-2" style="background: rgba(139, 115, 85, 0.15); border: 1px solid rgba(139, 115, 85, 0.25); color: #8B7355; padding: 4px 8px; font-size: 0.7rem;">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 20px; background: #FAFAF8;">

                    <!-- OPCIONES DE CARGA -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card-option card h-100 text-center p-4" onclick="selectOption('excel')" id="option-excel" style="border: 2px solid #E8DCC8; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                <div class="option-icon" style="font-size: 3rem; color: #8B7355;">
                                    <i class="fas fa-file-excel"></i>
                                </div>
                                <h4 class="option-title" style="font-size: 1.3rem; font-weight: 600; color: #6F5B44;">Importar desde Excel</h4>
                                <p class="option-description" style="color: #8B7355; font-size: 0.9rem;">
                                    Descarga la plantilla, complétala con tus datos y súbela para cargar el inventario de forma masiva
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card-option card h-100 text-center p-4" onclick="selectOption('manual')" id="option-manual" style="border: 2px solid #E8DCC8; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                <div class="option-icon" style="font-size: 3rem; color: #8B7355;">
                                    <i class="fas fa-keyboard"></i>
                                </div>
                                <h4 class="option-title" style="font-size: 1.3rem; font-weight: 600; color: #6F5B44;">Edición Manual</h4>
                                <p class="option-description" style="color: #8B7355; font-size: 0.9rem;">
                                    Ingresa el stock inicial de cada artículo de forma manual mediante un formulario interactivo
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN EXCEL -->
                    <div id="section-excel" style="display: none;">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="stats-card" style="background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%); border-radius: 12px; padding: 1.5rem; border-left: 4px solid #8B7355;">
                                    <h5 style="color: #6F5B44; font-weight: 600; margin-bottom: 1rem;">
                                        <i class="fas fa-info-circle me-2"></i>Instrucciones
                                    </h5>
                                    <ol style="color: #8B7355; margin-bottom: 0;">
                                        <li>Descarga la plantilla de Excel haciendo clic en el botón de abajo</li>
                                        <li>Completa la plantilla con los datos de tu inventario (Código, Nombre, Stock, etc.)</li>
                                        <li>Guarda el archivo y súbelo usando el área de carga</li>
                                        <li>Revisa los datos importados y confirma la carga</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <a href="{% url 'inventario:exportar_plantilla' %}" class="btn btn-option w-100" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 0.75rem; font-weight: 500; border-radius: 8px;">
                                    <i class="fas fa-download me-2"></i>Descargar Plantilla Excel
                                </a>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <form method="post" enctype="multipart/form-data" action="{% url 'inventario:importar_excel' %}" id="uploadForm">
                                    {% csrf_token %}

                                    <div class="row justify-content-center mb-4">
                                        <div class="col-md-8">
                                            <label for="bodega" class="form-label" style="color: #6F5B44; font-weight: 600;">Bodega de Destino *</label>
                                            <select name="bodega" id="bodega" class="form-select" required>
                                                <option value="">Seleccione una bodega...</option>
                                                {% for bodega in bodegas %}
                                                <option value="{{ bodega.id }}">{{ bodega.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">El stock se cargará en la bodega que selecciones aquí.</small>
                                        </div>
                                    </div>

                                    <div class="upload-area" id="uploadArea" style="border: 2px dashed #D4C4A8; border-radius: 12px; padding: 3rem; text-align: center; background: white; transition: all 0.3s ease;">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #8B7355; margin-bottom: 1rem;"></i>
                                        <h5 style="color: #6F5B44; font-weight: 600; margin-bottom: 0.5rem;">Arrastra tu archivo aquí</h5>
                                        <p style="color: #8B7355; margin-bottom: 1.5rem;">o haz clic para seleccionar</p>
                                        <input type="file" name="archivo" id="fileInput" accept=".xlsx,.xls" style="display: none;" required>
                                        <button type="button" class="btn btn-option" onclick="document.getElementById('fileInput').click()" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 0.5rem 1.5rem; font-weight: 500; border-radius: 8px;">
                                            <i class="fas fa-folder-open me-2"></i>Seleccionar Archivo
                                        </button>
                                        <div id="fileName" class="mt-3" style="color: #6F5B44; font-weight: 500;"></div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-option" id="btnUpload" style="display: none; background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 0.75rem 2rem; font-weight: 500; border-radius: 8px;">
                                            <i class="fas fa-upload me-2"></i>Cargar Inventario
                                        </button>
                                        
                                        <!-- Barra de progreso -->
                                        <div id="progressContainer" style="display: none; margin-top: 2rem; z-index: 1000; position: relative;">
                                            <div class="card shadow-lg" style="background: white; border: 2px solid #8B7355; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(139, 115, 85, 0.3);">
                                                <h5 style="color: #6F5B44; font-weight: 700; margin-bottom: 1.5rem; text-align: center;">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Procesando planilla de stock
                                                </h5>
                                                <div class="progress" style="height: 35px; border-radius: 10px; background-color: #F5F1E8; overflow: hidden; border: 2px solid #E8DCC8;">
                                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" 
                                                         style="width: 0%; background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%) !important; transition: width 0.4s ease; display: flex; align-items: center; justify-content: center;"
                                                         aria-valuenow="0" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        <span id="progressText" style="color: white; font-weight: 700; font-size: 1rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">0%</span>
                                                    </div>
                                                </div>
                                                <div id="progressStatus" style="margin-top: 1rem; color: #8B7355; font-size: 1rem; font-weight: 500; text-align: center;">
                                                    <i class="fas fa-hourglass-half me-2"></i>Iniciando procesamiento...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN MANUAL -->
                    <div id="section-manual" style="display: none;">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="stats-card" style="background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%); border-radius: 12px; padding: 1.5rem; border-left: 4px solid #8B7355;">
                                    <h5 style="color: #6F5B44; font-weight: 600; margin-bottom: 1rem;">
                                        <i class="fas fa-info-circle me-2"></i>Edición Manual
                                    </h5>
                                    <p style="color: #8B7355; margin-bottom: 0;">
                                        Ingresa el stock inicial de cada artículo de forma manual. Puedes buscar artículos y actualizar sus cantidades directamente.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <a href="{% url 'inventario:edicion_manual' %}" class="btn btn-option btn-lg w-100" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 1rem; font-weight: 500; border-radius: 8px; font-size: 1.1rem;">
                                    <i class="fas fa-edit me-2"></i>Ir a Edición Manual
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-option:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border-color: #8B7355 !important;
    }

    .card-option.selected {
        border-color: #8B7355 !important;
        background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%);
    }

    .upload-area:hover {
        border-color: #8B7355;
        background: #FAF8F3 !important;
    }

    .upload-area.dragover {
        border-color: #8B7355;
        background: #FAF8F3 !important;
    }

    .btn-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.3);
        color: white;
    }
</style>

<script>
function selectOption(option) {
    // Ocultar todas las secciones
    document.getElementById('section-excel').style.display = 'none';
    document.getElementById('section-manual').style.display = 'none';
    
    // Remover clase selected de todas las opciones
    document.getElementById('option-excel').classList.remove('selected');
    document.getElementById('option-manual').classList.remove('selected');
    
    // Mostrar sección seleccionada
    if (option === 'excel') {
        document.getElementById('section-excel').style.display = 'block';
        document.getElementById('option-excel').classList.add('selected');
    } else if (option === 'manual') {
        document.getElementById('section-manual').style.display = 'block';
        document.getElementById('option-manual').classList.add('selected');
    }
}

document.addEventListener('DOMContentLoaded', function() {

    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const fileName = document.getElementById('fileName');
    const btnUpload = document.getElementById('btnUpload');
    const bodegaSelect = document.getElementById('bodega');

    function handleFileSelection() {
        if (fileInput.files.length > 0) {
            fileName.innerHTML = `<i class="fas fa-file-excel me-2"></i>${fileInput.files[0].name}`;
            btnUpload.style.display = 'inline-block';
        } else {
            fileName.innerHTML = '';
            btnUpload.style.display = 'none';
        }
    }

    fileInput.addEventListener('change', handleFileSelection);

    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelection();
        }
    });
    uploadArea.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
            fileInput.click();
        }
    });

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        if (!bodegaSelect.value) {
            Swal.fire('Error', 'Debe seleccionar una bodega de destino.', 'error');
            return;
        }

        if (fileInput.files.length === 0) {
            Swal.fire('Error', 'Debe seleccionar un archivo Excel.', 'error');
            return;
        }

        // Ocultar botón y mostrar barra de progreso
        btnUpload.style.display = 'none';
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressStatus = document.getElementById('progressStatus');
        
        // Resetear barra de progreso
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
        }
        if (progressText) {
            progressText.textContent = '0%';
        }
        if (progressStatus) {
            progressStatus.innerHTML = '<i class="fas fa-hourglass-half me-2"></i>Iniciando procesamiento...';
        }
        
        // Mostrar barra de progreso con forzar visibilidad
        if (progressContainer) {
            progressContainer.style.display = 'block';
            progressContainer.style.visibility = 'visible';
            progressContainer.style.opacity = '1';
            
            // Scroll suave hacia la barra de progreso
            setTimeout(() => {
                progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        
        // Simular progreso mientras se procesa
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 85) {
                progress += Math.random() * 12 + 3; // Incremento variable entre 3-15%
                if (progress > 85) progress = 85;
                
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', Math.round(progress));
                }
                if (progressText) {
                    progressText.textContent = Math.round(progress) + '%';
                }
                
                // Actualizar mensaje según progreso
                if (progressStatus) {
                    if (progress < 25) {
                        progressStatus.innerHTML = '<i class="fas fa-file-excel me-2"></i>Leyendo archivo Excel...';
                    } else if (progress < 50) {
                        progressStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>Validando datos y códigos...';
                    } else if (progress < 75) {
                        progressStatus.innerHTML = '<i class="fas fa-boxes me-2"></i>Procesando artículos y actualizando stock...';
                    } else {
                        progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Finalizando procesamiento...';
                    }
                }
            }
        }, 200);

        const formData = new FormData(uploadForm);

        fetch(uploadForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            
            // Completar barra de progreso
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
            }
            if (progressText) {
                progressText.textContent = '100%';
            }
            if (progressStatus) {
                progressStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>Procesamiento completado';
            }
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                btnUpload.style.display = 'inline-block';
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Importación Completada',
                        text: data.message,
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        // Limpiar el formulario
                        fileInput.value = '';
                        fileName.innerHTML = '';
                        btnUpload.style.display = 'none';
                    });
                } else {
                    let errorHtml = data.message;
                    if (data.detalle_errores && data.detalle_errores.length > 0) {
                        errorHtml += '<ul class="text-start mt-2">';
                        data.detalle_errores.forEach(err => {
                            errorHtml += `<li>${err}</li>`;
                        });
                        errorHtml += '</ul>';
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en la Importación',
                        html: errorHtml,
                    });
                }
            }, 800);
        })
        .catch(error => {
            clearInterval(progressInterval);
            progressContainer.style.display = 'none';
            btnUpload.style.display = 'inline-block';
            
            Swal.fire('Error', 'Ocurrió un error inesperado al contactar al servidor.', 'error');
            console.error('Error:', error);
        });
    });
});
</script>

{% endblock %}
