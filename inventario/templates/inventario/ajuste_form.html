{% extends "base.html" %}
{% load widget_tweaks %}
{% load format_filters %}

{% block body_class %}hide-top-bar{% endblock %}

{% block title %}Nuevo Ajuste de Stock - GestionCloud{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
    }

    body {
        background-color: var(--stone-bg) !important;
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(139, 115, 85, 0.08);
        overflow: hidden;
        margin-top: 1.5rem;
        margin-bottom: 2rem;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-icon-box {
        width: 48px; height: 48px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.25rem;
    }

    .header-text h1 {
        color: var(--stone-text); font-size: 1.35rem; margin: 0; letter-spacing: -0.5px; line-height: 1.1;
    }
    .header-text p {
        color: #795548; font-size: 0.85rem; margin: 0; font-weight: 500; opacity: 0.9;
    }

    /* FORMS STONE */
    .form-label-stone {
        font-weight: 600; color: #6F5B44; font-size: 0.85rem; margin-bottom: 0.4rem;
    }
    .form-control-stone, .form-select-stone {
        border-radius: 8px; border: 1px solid #D4C4A8; padding: 0.6rem 1rem; font-size: 0.9rem; background-color: white; color: var(--stone-text); width: 100%; transition: all 0.2s;
    }
    .form-control-stone:focus, .form-select-stone:focus {
        border-color: var(--stone-primary); box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1); outline: none;
    }

    /* BOTONES */
    .header-btn {
        padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; text-decoration: none; display: inline-flex; align-items: center; transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
    }
    .btn-action-primary { background: var(--stone-primary); color: white; border: none; }
    .btn-action-primary:hover { background: var(--stone-secondary); color: white; }
    .btn-action-secondary { background: #F5F1E8; color: var(--stone-primary); border: 1px solid #D4C4A8; }
    .btn-action-secondary:hover { background: #E8DCC8; }

    /* DETALLES DINÁMICOS */
    .detalles-container {
        background: #FAFAF8; border: 1px solid #E8DCC8; border-radius: 12px; padding: 1.5rem; margin-top: 2rem;
    }
    .detalle-item {
        background: white; border: 1px solid #F5F1E8; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative;
    }
    .detalle-item:hover { border-color: #D4C4A8; }
    
    .btn-add-detail {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 500;
    }
    .btn-remove-detail {
        width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; transition: all 0.2s;
    }
    .btn-remove-detail:hover { background: #FFCDD2; }

    .articulo-info {
        background: #FFF8E1; border-left: 3px solid #FFC107; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.8rem; color: #5D4037;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="single-card-container">
            
            <!-- HEADER -->
            <div class="stone-header-premium">
                <div class="d-flex align-items-center gap-3">
                    <div class="header-icon-box">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="header-text">
                        <h1>{% if object %}Editar{% else %}Nuevo{% endif %} <span class="fw-bold">Ajuste</span></h1>
                        <p>Registre entradas o salidas manuales de stock.</p>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="header-btn btn-action-secondary" onclick="window.history.back()">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </button>
                    <button type="submit" form="ajusteForm" class="header-btn btn-action-primary">
                        <i class="fas fa-save me-2"></i> Guardar Ajuste
                    </button>
                </div>
            </div>

            <!-- BODY -->
            <div class="card-body p-4">
                <form method="post" id="ajusteForm">
                    {% csrf_token %}
                    <input type="hidden" name="detalles_data" id="detalles_data">
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mb-4 border-0 shadow-sm">
                            <i class="fas fa-exclamation-circle me-2"></i> {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}

                    <!-- CAMPOS PRINCIPALES -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label-stone">Tipo de Ajuste <span class="text-danger">*</span></label>
                            {% render_field form.tipo_ajuste class="form-select-stone" %}
                            {% if form.tipo_ajuste.errors %}
                                <div class="text-danger small mt-1">{{ form.tipo_ajuste.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-stone">Fecha <span class="text-danger">*</span></label>
                            {% render_field form.fecha_ajuste class="form-control-stone" type="datetime-local" %}
                            {% if form.fecha_ajuste.errors %}
                                <div class="text-danger small mt-1">{{ form.fecha_ajuste.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-stone">Bodega <span class="text-danger">*</span></label>
                            {% render_field form.bodega class="form-select-stone" %}
                            {% if form.bodega.errors %}
                                <div class="text-danger small mt-1">{{ form.bodega.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-stone">Descripción / Motivo <span class="text-danger">*</span></label>
                            {% render_field form.descripcion class="form-control-stone" placeholder="Ej: Ajuste por inventario físico..." %}
                            {% if form.descripcion.errors %}
                                <div class="text-danger small mt-1">{{ form.descripcion.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- DETALLES -->
                    <div class="detalles-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="fw-bold mb-0" style="color: #6F5B44;"><i class="fas fa-list me-2"></i>Artículos del Ajuste</h6>
                                <small class="text-muted">Agregue los productos a ajustar</small>
                            </div>
                            <button type="button" class="btn-add-detail" onclick="agregarDetalle()">
                                <i class="fas fa-plus me-1"></i> Agregar Ítem
                            </button>
                        </div>
                        
                        <div id="detallesContainer">
                            <!-- JS inserta aquí -->
                        </div>

                         <div class="mt-3 text-center" id="emptyState" style="display: none;">
                            <p class="text-muted small fst-italic">No hay artículos agregados.</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let detalleCount = 0;
let articulos = [];

document.addEventListener('DOMContentLoaded', function() {
    const bodegaSelect = document.querySelector('select[name="bodega"]');
    if (bodegaSelect) {
        bodegaSelect.addEventListener('change', cargarArticulos);
        // Cargar artículos iniciales si ya hay bodega seleccionada
        if(bodegaSelect.value) cargarArticulos();
    }
    
    // Agregar primer detalle por defecto
    agregarDetalle();
});

function cargarArticulos() {
    const bodegaId = document.querySelector('select[name="bodega"]').value;
    if (!bodegaId) {
        articulos = [];
        return;
    }
    
    // Mostrar feedback de carga si fuera necesario
    const url = "{% url 'inventario:api_articulos_ajuste' %}?bodega_id=" + bodegaId;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            articulos = data.articulos || [];
            console.log('Artículos cargados:', articulos.length);
            // Actualizar selects existentes
            document.querySelectorAll('.articulo-select').forEach(select => {
                const valorActual = select.value;
                actualizarOpcionesSelect(select, valorActual);
            });
        })
        .catch(error => {
            console.error('Error cargando artículos:', error);
        });
}

function actualizarOpcionesSelect(selectElement, valorPreservado) {
    // Limpiar opciones excepto la primera
    selectElement.innerHTML = '<option value="">Seleccionar artículo...</option>';
    
    articulos.forEach(art => {
        const option = document.createElement('option');
        option.value = art.id;
        option.textContent = `${art.codigo} - ${art.nombre}`;
        option.dataset.codigo = art.codigo;
        option.dataset.nombre = art.nombre;
        option.dataset.unidad = art.unidad_medida;
        option.dataset.stock = art.stock_actual;
        
        if (String(art.id) === String(valorPreservado)) {
            option.selected = true;
        }
        selectElement.appendChild(option);
    });
}

function agregarDetalle() {
    detalleCount++;
    const container = document.getElementById('detallesContainer');
    document.getElementById('emptyState').style.display = 'none';
    
    const div = document.createElement('div');
    div.className = 'detalle-item';
    div.id = `detalle-${detalleCount}`;
    
    // Construir HTML con estilos Stone
    div.innerHTML = `
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label-stone small text-muted">Artículo</label>
                <select class="form-select-stone articulo-select" name="detalles-${detalleCount}-articulo" 
                        onchange="cargarInfoArticulo(this, ${detalleCount})">
                    <option value="">Seleccionar artículo...</option>
                    ${generarOpcionesArticulos()}
                </select>
                <div class="articulo-info" id="info-${detalleCount}" style="display: none;">
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-box me-1"></i>Stock: <strong id="stock-${detalleCount}">0</strong></span>
                        <span><i class="fas fa-ruler me-1"></i>Unidad: <strong id="unidad-${detalleCount}">-</strong></span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label-stone small text-muted">Cantidad</label>
                <div class="input-group">
                    <span class="input-group-text border-end-0 bg-white" id="sign-${detalleCount}" style="border-color: #D4C4A8; color: #6F5B44;">+</span>
                    <input type="number" class="form-control-stone border-start-0 ps-0" name="detalles-${detalleCount}-cantidad" 
                           step="0.01" min="0.01" placeholder="0.00" required>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label-stone small text-muted">Comentario</label>
                <input type="text" class="form-control-stone" name="detalles-${detalleCount}-comentario" 
                       placeholder="Opcional">
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn-remove-detail ms-auto" 
                        onclick="eliminarDetalle(${detalleCount})" title="Quitar">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(div);
    actualizarSignosCantidad();
    
    // Inicializar select2 si jquery está cargado
     if (window.jQuery && $.fn.select2) {
        $(div).find('.articulo-select').select2({
            theme: 'default',
            width: '100%',
            placeholder: 'Seleccionar artículo...'
        });
     }
}

function generarOpcionesArticulos() {
    return articulos.map(art => `
        <option value="${art.id}" data-codigo="${art.codigo}" data-nombre="${art.nombre}" 
                data-unidad="${art.unidad_medida}" data-stock="${art.stock_actual}">
            ${art.codigo} - ${art.nombre}
        </option>
    `).join('');
}

function eliminarDetalle(id) {
    const detalle = document.getElementById(`detalle-${id}`);
    if (detalle) {
        detalle.remove();
        if (document.getElementById('detallesContainer').children.length === 0) {
             document.getElementById('emptyState').style.display = 'block';
        }
    }
}

function cargarInfoArticulo(select, detalleId) {
    const option = select.options[select.selectedIndex];
    if (!option || !option.value) {
        document.getElementById(`info-${detalleId}`).style.display = 'none';
        return;
    }
    
    const stock = option.dataset.stock || '0';
    const unidad = option.dataset.unidad || '-';
    
    document.getElementById(`stock-${detalleId}`).textContent = stock;
    document.getElementById(`unidad-${detalleId}`).textContent = unidad;
    document.getElementById(`info-${detalleId}`).style.display = 'block';
}

function actualizarSignosCantidad() {
    const tipoAjuste = document.querySelector('select[name="tipo_ajuste"]').value;
    const signos = document.querySelectorAll('[id^="sign-"]');
    
    signos.forEach(signo => {
        if (tipoAjuste === 'ENTRADA') {
            signo.textContent = '+';
            signo.style.color = '#2E7D32'; // Verde stone
            signo.style.backgroundColor = '#E8F5E9';
        } else {
            signo.textContent = '-';
            signo.style.color = '#C62828'; // Rojo stone
            signo.style.backgroundColor = '#FFEBEE';
        }
    });
}

document.querySelector('select[name="tipo_ajuste"]').addEventListener('change', actualizarSignosCantidad);

document.getElementById('ajusteForm').addEventListener('submit', function(e) {
    const detallesItems = document.querySelectorAll('.detalle-item');
    if (detallesItems.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un artículo.');
        return;
    }
    
    let detallesData = [];
    let validos = 0;
    
    detallesItems.forEach(item => {
        const articuloSelect = item.querySelector('.articulo-select');
        const cantidadInput = item.querySelector('input[type="number"]');
        const comentarioInput = item.querySelector('input[type="text"]');
        
        if (articuloSelect.value && cantidadInput.value > 0) {
            validos++;
            detallesData.push({
                articulo_id: articuloSelect.value,
                cantidad: parseFloat(cantidadInput.value),
                comentario: comentarioInput.value
            });
        }
    });

    if (validos === 0) {
        e.preventDefault();
        alert('Complete la información de al menos un artículo.');
        return;
    }
    
    document.getElementById('detalles_data').value = JSON.stringify(detallesData);
});
</script>
{% endblock %}
