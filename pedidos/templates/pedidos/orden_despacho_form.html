{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ titulo }} - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Altura para campos de cabecera */
    .header-field, .select2-container--default .select2-selection--single {
        height: 35px !important;
    }
    .form-control-sm.header-field {
        font-size: 0.8rem;
    }

    /* Altura para campos de items */
    .item-field {
        height: 32px !important;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row mb-3">
        <div class="col-12">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <form method="post" id="despachoForm">
        {% csrf_token %}
        {{ formset.management_form }}
        <div class="card shadow-sm" style="border: none; border-radius: 10px; font-size: 0.8rem;">
            <!-- Header -->
            <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; border: none; padding: 0.5rem 1rem;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="fas fa-truck-loading me-2"></i>{{ titulo }}</h5>
                        <small class="text-white-50">Crea y gestiona una nueva orden de despacho para un pedido existente.</small>
                    </div>
                    <div>
                        <a href="{% url 'pedidos:orden_despacho_list' %}" class="btn btn-sm btn-outline-light py-0 px-2" style="font-size: 0.7rem;"><i class="fas fa-arrow-left"></i> Volver</a>
                    </div>
                </div>
            </div>

            <!-- Body -->
            <div class="card-body" style="padding: 0.5rem;">
                <!-- Info Pedido y Cliente -->
                <div class="row gx-2 mb-2 pb-2 border-bottom align-items-center">
                    <div class="col-md-3"><strong>Pedido:</strong> {{ form.orden_pedido }}</div>
                    <div class="col-md-2"><strong>Fecha Despacho:</strong> {{ form.fecha_despacho }}</div>
                    <div class="col-md-2"><strong>Fecha Entrega:</strong> {{ form.fecha_entrega_estimada }}</div>
                    {% if not orden %}
                    <div class="col-md-3">
                        <strong>Documento a Generar:</strong>
                        <div class="d-flex gap-3 mt-1">
                            {% for radio in form.tipo_documento %}
                                <div class="form-check">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-6" id="cliente-info">
                        <div class="row gx-2">
                            <div class="col-6"><strong>Cliente:</strong> <span id="cliente_nombre">-</span></div>
                            <div class="col-6"><strong>RUT:</strong> <span id="cliente_rut">-</span></div>
                            <div class="col-12 mt-1"><strong>Dirección:</strong> <span id="cliente_direccion">-</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Información de Transporte -->
                <div class="row gx-2 mb-2 pb-2 border-bottom">
                    <div class="col-md-3">
                        <label class="form-label mb-1"><strong>Chofer:</strong></label>
                        {{ form.chofer }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-1"><strong>Vehículo:</strong></label>
                        {{ form.vehiculo }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-1"><strong>Transportista Externo:</strong></label>
                        {{ form.transportista_externo }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-1"><strong>Dirección de Entrega:</strong></label>
                        {{ form.direccion_entrega }}
                    </div>
                </div>
                
                <!-- Observaciones -->
                {% if form.observaciones %}
                <div class="row gx-2 mb-2 pb-2 border-bottom">
                    <div class="col-12">
                        <label class="form-label mb-1"><strong>Observaciones:</strong></label>
                        {{ form.observaciones }}
                    </div>
                </div>
                {% endif %}
                
                {{ form.estado }}
                <div class="d-flex justify-content-between align-items-center text-muted px-2" style="font-size: 0.7rem;">
                    <div style="width: 30%;"><strong>Producto</strong></div>
                    <div class="d-flex align-items-center text-end" style="width: 25%;">
                        <div class="px-2 w-100"><strong>Neto</strong></div>
                        <div class="px-2 w-100"><strong>IVA</strong></div>
                        <div class="px-2 w-100"><strong>Imp.Esp.</strong></div>
                        <div class="ps-2 w-100"><strong>Total</strong></div>
                    </div>
                    <div></div>
                </div>

                <!-- Items del Despacho -->
                <div class="card mt-2" style="background: #F5F1E8; border: 1px solid #E8DCC8;">
                    <div class="card-body" style="padding: 0.5rem;" id="items-container">
                        <!-- Los items se cargarán aquí dinámicamente -->
                        <div class="text-center p-3 text-muted">Seleccione un pedido para ver sus artículos.</div>
                    </div>
                </div>

                <!-- Totales y Botones -->
                <div class="row mt-2 align-items-center">
                    <div class="col-md-8 text-end" id="totales-container" style="font-size: 0.9rem;">
                        <span class="me-3"><strong>Neto:</strong> $<span id="total-neto">0</span></span>
                        <span class="me-3"><strong>IVA:</strong> $<span id="total-iva">0</span></span>
                        <span class="me-3"><strong>Imp.Esp.:</strong> $<span id="total-imp-esp">0</span></span>
                        <strong class="h5" style="color: #8B7355;">TOTAL: $<span id="total-final">0</span></strong>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'pedidos:orden_despacho_list' %}" class="btn btn-secondary btn-sm">Cancelar</a>
                        <button type="submit" id="submit-despacho-btn" class="btn btn-sm" style="background: #8B7355; color: white;"><i class="fas fa-save me-1"></i>{{ accion }}</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    Swal.close(); // Forzar cierre de cualquier modal al cargar

    // Inicializar Select2
    $('#id_orden_pedido').select2({
        theme: 'default',
        width: '100%',
        placeholder: 'Seleccione un pedido',
        allowClear: true
    });
    
    $('#id_chofer').select2({
        theme: 'default',
        width: '100%',
        placeholder: 'Seleccione un chofer (opcional)',
        allowClear: true
    });
    
    $('#id_vehiculo').select2({
        theme: 'default',
        width: '100%',
        placeholder: 'Seleccione un vehículo (opcional)',
        allowClear: true
    });

    // Función para cargar datos del pedido vía API
    function loadPedidoData(pedidoId) {
        if (!pedidoId) {
            $('#cliente_nombre, #cliente_rut, #cliente_direccion').text('-');
            $('#items-container').html('<div class="text-center p-3 text-muted">Seleccione un pedido para ver sus artículos.</div>');
            $('#id_items-TOTAL_FORMS').val(0);
            calcularTotales();
            return;
        }

        fetch(`/pedidos/ajax/items-pedido/?pedido_id=${pedidoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    $('#cliente_nombre').text(data.cliente.nombre || '-');
                    $('#cliente_rut').text(data.cliente.rut || '-');
                    $('#cliente_direccion').text(`${data.cliente.direccion || ''}, ${data.cliente.comuna || ''}, ${data.cliente.region || ''}`);

                    const itemsContainer = $('#items-container');
                    itemsContainer.empty();
                    let formIdx = 0;

                    if (data.items.length === 0) {
                        itemsContainer.html('<div class="text-center p-3 text-muted">No hay artículos pendientes de despacho para este pedido.</div>');
                        Swal.fire({
                            icon: 'info',
                            title: 'Pedido Completo',
                            text: 'Este pedido ya ha sido despachado en su totalidad.',
                            confirmButtonColor: '#8B7355'
                        });
                        $('#submit-despacho-btn').prop('disabled', true);
                    } else {
                        $('#submit-despacho-btn').prop('disabled', false);
                    }

                    data.items.forEach(item => {
                        const itemHtml = `
                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom item-row" data-precio-neto="${item.precio_neto}" data-iva="${item.iva}" data-imp-esp="${item.impuesto_especifico}">
                                <input type="hidden" name="items-${formIdx}-item_pedido" value="${item.item_pedido_id}">
                                <div style="width: 30%;">
                                    <small class="text-muted">${item.codigo}</small> <strong>${item.articulo}</strong>
                                </div>
                                <div class="d-flex align-items-center text-end" style="font-size: 0.75rem; width: 25%;">
                                    <div class="px-2 w-100">$${Math.round(item.precio_neto).toLocaleString('es-CL')}</div>
                                    <div class="px-2 w-100">$${Math.round(item.iva).toLocaleString('es-CL')}</div>
                                    <div class="px-2 w-100">$${Math.round(item.impuesto_especifico).toLocaleString('es-CL')}</div>
                                    <div class="ps-2 w-100 fw-bold">$${Math.round(item.total).toLocaleString('es-CL')}</div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="px-2 text-center">
                                        <small class="d-block" style="font-size:0.6rem;">Pendiente</small>
                                        <input type="text" class="form-control form-control-sm item-field text-center" value="${item.cantidad_pendiente}" readonly>
                                    </div>
                                    <div class="px-2">
                                        <small class="d-block" style="font-size:0.6rem;">A Despachar *</small>
                                        <input type="number" name="items-${formIdx}-cantidad" class="form-control form-control-sm item-field cantidad-despachar" value="${item.cantidad_pendiente}" step="0.01" min="0" max="${item.cantidad_pendiente}" required>
                                    </div>
                                    <div class="px-2">
                                        <small class="d-block" style="font-size:0.6rem;">Observaciones</small>
                                        <input type="text" name="items-${formIdx}-observaciones" class="form-control form-control-sm item-field">
                                    </div>
                                </div>
                            </div>
                        `;
                        itemsContainer.append(itemHtml);
                        formIdx++;
                    });

                    $('#id_items-TOTAL_FORMS').val(formIdx);
                    calcularTotales();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error al cargar el pedido', text: data.error || 'Respuesta no válida del servidor', confirmButtonColor: '#8B7355' });
                }
            })
            .catch(error => {
                Swal.fire({ icon: 'error', title: 'Error de conexión', text: 'No se pudo conectar con el servidor.', confirmButtonColor: '#8B7355' });
            });
    }

    // Función para calcular totales
    function calcularTotales() {
        let totalNeto = 0, totalIva = 0, totalImpEsp = 0;
        $('.item-row').each(function() {
            const cantidad = parseFloat($(this).find('.cantidad-despachar').val()) || 0;
            const precioNeto = parseFloat($(this).data('precio-neto')) || 0;
            const ivaUnitario = parseFloat($(this).data('iva')) || 0;
            const impEspUnitario = parseFloat($(this).data('imp-esp')) || 0;
            totalNeto += cantidad * precioNeto;
            totalIva += cantidad * ivaUnitario;
            totalImpEsp += cantidad * impEspUnitario;
        });
        const totalFinal = totalNeto + totalIva + totalImpEsp;
        $('#total-neto').text(Math.round(totalNeto).toLocaleString('es-CL'));
        $('#total-iva').text(Math.round(totalIva).toLocaleString('es-CL'));
        $('#total-imp-esp').text(Math.round(totalImpEsp).toLocaleString('es-CL'));
        $('#total-final').text(Math.round(totalFinal).toLocaleString('es-CL'));
    }

    // --- Event Listeners ---

    // Cargar pedido al cambiar el select
    $('#id_orden_pedido').on('change', function() {
        loadPedidoData($(this).val());
    });

    // Recalcular totales al cambiar cantidad
    $(document).on('input', '.cantidad-despachar', function() {
        calcularTotales();
    });

    // --- Carga Inicial ---

    // Si hay un pedido seleccionado al cargar (por error de validación o al editar), cargar sus datos
    const initialPedidoId = $('#id_orden_pedido').val();
    if (initialPedidoId) {
        {% if orden %}
        // Si estamos editando, cargar solo la info del cliente, no los items
        fetch(`/pedidos/ajax/items-pedido/?pedido_id=${initialPedidoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.cliente) {
                    $('#cliente_nombre').text(data.cliente.nombre || '-');
                    $('#cliente_rut').text(data.cliente.rut || '-');
                    $('#cliente_direccion').text(`${data.cliente.direccion || ''}, ${data.cliente.comuna || ''}, ${data.cliente.region || ''}`);
                }
            });
        {% else %}
        // Si estamos creando, cargar todo normalmente
        loadPedidoData(initialPedidoId);
        {% endif %}
    }
});
</script>
{% endblock %}

