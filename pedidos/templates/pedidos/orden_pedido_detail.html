{% extends "base.html" %}
{% load static %}
{% load currency_filters %}
{% load l10n %}

{% block title %}Pedido #{{ pedido.numero_pedido }} - Detalle{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
    }

    body {
        background-color: var(--stone-bg) !important;
        font-family: 'Poppins', sans-serif;
        color: var(--stone-text);
    }

    /* Header Piedra */
    .stone-header-card {
        background: var(--stone-gradient);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(139, 115, 85, 0.15);
        border-bottom: 3px solid var(--stone-light);
        color: var(--stone-text);
    }

    .stone-title {
        font-weight: 700;
        font-size: 1.5rem;
        margin: 0;
        color: var(--stone-secondary);
    }

    /* Card Principal */
    .main-card {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-top: 1.5rem;
    }

    /* Columna Info */
    .info-column {
        background-color: #fdfbf7;
        border-right: 1px solid var(--stone-light);
        padding: 2rem;
    }

    .section-title {
        color: var(--stone-primary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--stone-light);
        padding-bottom: 0.5rem;
    }

    .info-label {
        font-size: 0.8rem;
        color: #8d8d8d;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.2rem;
    }

    .info-value {
        font-size: 1rem;
        color: var(--stone-text);
        font-weight: 500;
        margin-bottom: 1rem;
    }

    /* Badges */
    .badge-stone {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .badge-borrador { background: #ECEFF1; color: #546E7A; border: 1px solid #CFD8DC; }
    .badge-confirmada { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; }
    .badge-en_proceso { background: #FFF8E1; color: #FF8F00; border: 1px solid #FFE0B2; }
    .badge-completada { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    .badge-cancelada { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }

    /* Tabla Detalle */
    .table-stone {
        width: 100%;
        border-collapse: collapse;
    }

    .table-stone th {
        background: #fafafa;
        color: var(--stone-secondary);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
        padding: 1rem;
        border-bottom: 2px solid var(--stone-light);
    }

    .table-stone td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        color: #495057;
        vertical-align: middle;
    }

    /* Totales */
    .totals-box {
        background: #fafafa;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--stone-light);
        margin-top: 1.5rem;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        color: #6c757d;
    }

    .total-final {
        border-top: 2px solid var(--stone-light);
        margin-top: 1rem;
        padding-top: 1rem;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--stone-text);
    }

    /* Botones */
    .btn-stone-outline {
        border: 1px solid var(--stone-light);
        background: white;
        color: var(--stone-secondary);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    .btn-stone-outline:hover {
        background: #fafafa;
        border-color: var(--stone-primary);
        color: var(--stone-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="stone-header-card p-4 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="me-3 p-3 rounded-circle bg-white shadow-sm" style="color: var(--stone-primary);">
                <i class="fas fa-file-invoice fa-2x"></i>
            </div>
            <div>
                <h1 class="stone-title">Pedido #{{ pedido.numero_pedido }}</h1>
                <div class="mt-1 text-muted small fw-bold text-uppercase" style="letter-spacing: 1px;">
                    {{ pedido.fecha_pedido|date:"d M Y" }} • {{ pedido.cliente.nombre }}
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'pedidos:orden_pedido_list' %}" class="btn-stone-outline">
                <i class="fas fa-arrow-left me-2"></i> Volver
            </a>
            {% if pedido.estado != 'completada' and pedido.estado != 'cancelada' %}
            <a href="{% url 'pedidos:orden_pedido_update' pedido.pk %}" class="btn btn-primary" style="background: var(--stone-primary); border-color: var(--stone-primary);">
                <i class="fas fa-pen me-2"></i> Editar
            </a>
            {% endif %}
            <a href="{% url 'pedidos:orden_pedido_delete' pedido.pk %}" class="btn btn-outline-danger" style="border-color: #ffcdd2;">
                <i class="fas fa-trash-alt"></i>
            </a>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-card">
        <div class="row g-0">
            
            <!-- Columna Izquierda: Información -->
            <div class="col-lg-4 info-column">
                
                <div class="mb-5">
                    <h5 class="section-title"><i class="fas fa-info-circle me-2"></i> Estado</h5>
                    <span class="badge badge-stone w-100 text-center
                        {% if pedido.estado == 'borrador' %}badge-borrador
                        {% elif pedido.estado == 'confirmada' %}badge-confirmada
                        {% elif pedido.estado == 'en_proceso' %}badge-en_proceso
                        {% elif pedido.estado == 'completada' %}badge-completada
                        {% elif pedido.estado == 'cancelada' %}badge-cancelada{% endif %}">
                        {{ pedido.get_estado_display|upper }}
                    </span>
                </div>

                <div class="mb-5">
                    <h5 class="section-title"><i class="fas fa-user me-2"></i> Cliente</h5>
                    <div class="info-value mb-1 fw-bold text-primary">{{ pedido.cliente.nombre }}</div>
                    <div class="text-muted small">{{ pedido.cliente.rut }}</div>
                </div>

                <div class="mb-4">
                    <h5 class="section-title"><i class="fas fa-calendar-alt me-2"></i> Fechas</h5>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="info-label">Pedido</div>
                            <div class="info-value">{{ pedido.fecha_pedido|date:"d/m/Y" }}</div>
                        </div>
                        {% if pedido.fecha_entrega_estimada %}
                        <div class="col-6">
                            <div class="info-label">Entrega Est.</div>
                            <div class="info-value">{{ pedido.fecha_entrega_estimada|date:"d/m/Y" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="section-title"><i class="fas fa-warehouse me-2"></i> Logística</h5>
                    <div class="info-label">Bodega Origen</div>
                    <div class="info-value">{{ pedido.bodega.nombre }}</div>
                </div>

                {% if pedido.numero_oc_cliente %}
                <div class="mb-4">
                    <div class="info-label">OC Cliente</div>
                    <div class="info-value text-info font-monospace">#{{ pedido.numero_oc_cliente }}</div>
                </div>
                {% endif %}

                {% if pedido.observaciones %}
                <div class="mt-4 p-3 bg-light rounded border border-light fst-italic text-muted small">
                    <i class="fas fa-comment-alt me-2"></i> {{ pedido.observaciones }}
                </div>
                {% endif %}
            </div>

            <!-- Columna Derecha: Items -->
            <div class="col-lg-8 p-4">
                <h5 class="section-title mb-4"><i class="fas fa-boxes me-2"></i> Detalle de Items</h5>
                
                <div class="table-responsive rounded border border-light mb-4">
                    <table class="table-stone">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio U.</th>
                                <th class="text-center">Desc.</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pedido.items.all %}
                            <tr>
                                <td>
                                    <div class="fw-bold text-dark">{{ item.articulo.codigo }}</div>
                                    <div class="text-muted small">{{ item.articulo.nombre|truncatechars:45 }}</div>
                                </td>
                                <td class="text-center fw-bold fs-5">{{ item.cantidad }}</td>
                                <td class="text-end text-muted">{{ item.precio_unitario|currency_format_with_symbol }}</td>
                                <td class="text-center text-muted">{{ item.descuento_porcentaje }}%</td>
                                <td class="text-end fw-bold text-dark">{{ item.get_total|currency_format_with_symbol }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row justify-content-end">
                    <div class="col-md-7">
                        <div class="totals-box">
                            <div class="total-row">
                                <span>Subtotal Neto</span>
                                <span class="fw-bold text-dark">{{ pedido.subtotal|currency_format_with_symbol }}</span>
                            </div>
                            <div class="total-row">
                                <span>Descuentos</span>
                                <span class="text-danger">{{ pedido.descuentos_totales|currency_format_with_symbol }}</span>
                            </div>
                            <div class="total-row">
                                <span>IVA (19%)</span>
                                <span>{{ pedido.impuestos_totales|currency_format_with_symbol }}</span>
                            </div>
                            <div class="total-final d-flex justify-content-between">
                                <span>TOTAL PEDIDO</span>
                                <span style="color: #2e7d32;">{{ pedido.total_pedido|currency_format_with_symbol }}</span>
                            </div>
                        </div>

                         {% if perms.pedidos.add_ordendespacho and pedido.estado != 'completada' and pedido.estado != 'cancelada' %}
                        <div class="d-grid mt-4">
                            <a href="{% url 'pedidos:orden_despacho_create' %}?pedido={{ pedido.pk }}" class="btn btn-outline-primary btn-lg shadow-sm" style="border-width: 2px;">
                                <i class="fas fa-shipping-fast me-2"></i> Generar Despacho
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="text-end mt-3 text-muted small">
        Actualizado: {{ pedido.fecha_actualizacion|date:"d/m/Y H:i" }}
    </div>
</div>
{% endblock %}
