{% extends "base.html" %}
{% load static %}

{% block title %}Órdenes de Despacho - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: none; border-radius: 15px; overflow: hidden;">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; padding: 10px 15px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-truck fa-2x text-white me-3"></i>
                            <div>
                                <h5 class="mb-0 text-white" style="font-size: 1.2rem; font-family: 'Poppins', sans-serif; font-weight: 600;">
                                    Gestión de Órdenes de Despacho
                                </h5>
                                <small class="text-white-50" style="font-size: 0.8rem; font-family: 'Poppins', sans-serif;">Control y trazabilidad de despachos</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'pedidos:orden_pedido_list' %}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left me-1"></i> Ver Pedidos
                            </a>
                            <a href="{% url 'pedidos:orden_despacho_create' %}" class="btn" style="background: white; color: #8B7355; font-weight: 600;">
                                <i class="fas fa-plus me-2"></i> Nuevo Despacho
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Estadísticas -->
                <div class="card-body" style="padding: 10px 15px;">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none;">
                                <div class="card-body" style="padding: 10px 15px;">
                                    <h6 class="card-title" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500;">TOTAL DESPACHOS</h6>
                                    <h3 class="mb-0" style="color: white; font-weight: 700;">{{ total_despachos }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border: none;">
                                <div class="card-body" style="padding: 10px 15px;">
                                    <h6 class="card-title" style="color: rgba(255, 255, 255, 0.9); font-size: 0.75rem; font-weight: 500;">PENDIENTES</h6>
                                    <h3 class="mb-0" style="color: white; font-weight: 700;">{{ pendientes }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); border: none;">
                                <div class="card-body" style="padding: 10px 15px;">
                                    <h6 class="card-title" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500;">EN PROCESO</h6>
                                    <h3 class="mb-0" style="color: white; font-weight: 700;">{{ en_proceso }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); border: none;">
                                <div class="card-body" style="padding: 10px 15px;">
                                    <h6 class="card-title" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500;">ENTREGADOS</h6>
                                    <h3 class="mb-0" style="color: white; font-weight: 700;">{{ entregados }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros de búsqueda -->
                    <div class="card mb-3" style="background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%); border: 1px solid #e3e6f0; border-radius: 10px;">
                        <div class="card-body" style="padding: 12px 15px;">
                            <form method="get" class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-size: 0.85rem;">Buscar</label>
                                    <input type="text" name="search" class="form-control form-control-sm" 
                                           placeholder="N° Despacho, Pedido, Cliente..." value="{{ search }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-size: 0.85rem;">Estado</label>
                                    <select name="estado" class="form-select form-select-sm">
                                        <option value="">Todos los estados</option>
                                        <option value="pendiente" {% if estado_filter == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="en_preparacion" {% if estado_filter == 'en_preparacion' %}selected{% endif %}>En Preparación</option>
                                        <option value="despachado" {% if estado_filter == 'despachado' %}selected{% endif %}>Despachado</option>
                                        <option value="en_transito" {% if estado_filter == 'en_transito' %}selected{% endif %}>En Tránsito</option>
                                        <option value="entregado" {% if estado_filter == 'entregado' %}selected{% endif %}>Entregado</option>
                                        <option value="cancelado" {% if estado_filter == 'cancelado' %}selected{% endif %}>Cancelado</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end gap-2">
                                    <button type="submit" class="btn btn-sm" style="background: #8B7355; color: white;">
                                        <i class="fas fa-search me-1"></i> Buscar
                                    </button>
                                    <a href="{% url 'pedidos:orden_despacho_list' %}" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-times me-1"></i> Limpiar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Tabla de despachos -->
                    <div class="table-responsive">
                        <table class="table table-hover" style="font-size: 0.85rem;">
                            <thead style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white;">
                                <tr>
                                    <th style="padding: 8px 10px;">N° Despacho</th>
                                    <th style="padding: 8px 10px;">Pedido</th>
                                    <th style="padding: 8px 10px;">Cliente</th>
                                    <th style="padding: 8px 10px;">Fecha Despacho</th>
                                    <th style="padding: 8px 10px;">Estado</th>
                                    <th style="padding: 8px 10px;">Chofer / Vehículo</th>
                                    <th style="padding: 8px 10px;">Items</th>
                                    <th style="padding: 8px 10px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for orden in ordenes %}
                                <tr style="border-bottom: 1px solid #e3e6f0;">
                                    <td style="padding: 8px 10px; font-weight: 600; color: #8B7355;">
                                        {{ orden.numero_despacho }}
                                    </td>
                                    <td style="padding: 8px 10px;">
                                        <a href="{% url 'pedidos:orden_pedido_detail' orden.orden_pedido.pk %}" 
                                           class="text-decoration-none" style="color: #6F5B44;">
                                            {{ orden.orden_pedido.numero_pedido }}
                                        </a>
                                    </td>
                                    <td style="padding: 8px 10px;">{{ orden.orden_pedido.cliente.nombre }}</td>
                                    <td style="padding: 8px 10px;">{{ orden.fecha_despacho|date:"d/m/Y" }}</td>
                                    <td style="padding: 8px 10px;">
                                        {% if orden.estado == 'pendiente' %}
                                        <span class="badge" style="background: #6c757d; font-size: 0.75rem;">PENDIENTE</span>
                                        {% elif orden.estado == 'en_preparacion' %}
                                        <span class="badge" style="background: #ffc107; font-size: 0.75rem;">EN PREPARACIÓN</span>
                                        {% elif orden.estado == 'despachado' %}
                                        <span class="badge" style="background: #17a2b8; font-size: 0.75rem;">DESPACHADO</span>
                                        {% elif orden.estado == 'en_transito' %}
                                        <span class="badge" style="background: #007bff; font-size: 0.75rem;">EN TRÁNSITO</span>
                                        {% elif orden.estado == 'entregado' %}
                                        <span class="badge" style="background: #28a745; font-size: 0.75rem;">ENTREGADO</span>
                                        {% elif orden.estado == 'cancelado' %}
                                        <span class="badge" style="background: #dc3545; font-size: 0.75rem;">CANCELADO</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px 10px;">
                                        {% if orden.chofer %}
                                            <div style="font-size: 0.8rem;"><i class="fas fa-user me-1"></i>{{ orden.chofer.nombre|truncatechars:20 }}</div>
                                        {% endif %}
                                        {% if orden.vehiculo %}
                                            <div style="font-size: 0.75rem; color: #6c757d;"><i class="fas fa-truck me-1"></i>{{ orden.vehiculo.patente }}</div>
                                        {% endif %}
                                        {% if orden.transportista_externo %}
                                            <div style="font-size: 0.75rem; color: #6c757d;"><i class="fas fa-building me-1"></i>{{ orden.transportista_externo|truncatechars:20 }}</div>
                                        {% endif %}
                                        {% if not orden.chofer and not orden.vehiculo and not orden.transportista_externo %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px 10px; text-align: center;">
                                        <span class="badge bg-secondary">{{ orden.items.count }}</span>
                                    </td>
                                    <td style="padding: 8px 10px; text-align: center;">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'pedidos:orden_despacho_detail' orden.pk %}" 
                                               class="btn btn-sm" style="background: #8B7355; color: white;" 
                                               title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if orden.estado not in 'entregado,cancelado' %}
                                            <a href="{% url 'pedidos:orden_despacho_edit' orden.pk %}" 
                                               class="btn btn-sm btn-warning" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center" style="padding: 30px;">
                                        <i class="fas fa-inbox fa-3x mb-3" style="color: #8B7355; opacity: 0.3;"></i>
                                        <p style="color: #6c757d; font-size: 1rem;">No hay órdenes de despacho registradas</p>
                                        <a href="{% url 'pedidos:orden_despacho_create' %}" class="btn btn-sm" style="background: #8B7355; color: white;">
                                            <i class="fas fa-plus me-1"></i> Crear Primer Despacho
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

