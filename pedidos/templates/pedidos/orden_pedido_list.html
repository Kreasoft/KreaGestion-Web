{% extends "base.html" %}
{% load static %}
{% load currency_filters %}

{% block title %}Órdenes de Pedido - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<!-- V7: SOFT UI PASTEL COLORS -->
<style>
    /* Estilos tabla Piedra (Compacta) */
    .table-piedra {
        width: 100% !important;
        border-collapse: collapse !important;
        font-family: 'Poppins', sans-serif !important;
    }

    .table-piedra thead th {
        background: #FDFCFB !important;
        border-bottom: 2px solid #E8DCC8 !important;
        color: #8B7355 !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        font-size: 0.7rem !important;
        letter-spacing: 1px !important;
        padding: 12px 15px !important;
    }

    .table-piedra tbody tr {
        height: 32px !important;
        transition: all 0.2s ease !important;
    }

    .table-piedra tbody tr:nth-of-type(odd) {
        background-color: rgba(245, 241, 232, 0.3) !important;
    }
    
    .table-piedra tbody tr:nth-of-type(even) {
        background-color: white !important;
    }

    .table-piedra tbody tr:hover {
        background-color: #F5F1E8 !important;
    }

    .table-piedra tbody td {
        padding: 4px 15px !important; /* Compacto */
        border-bottom: 1px solid #F5F1E8 !important;
        vertical-align: middle !important;
        font-size: 0.85rem !important;
        color: #4A5568 !important;
    }

    /* Botones de acción EXACTOS a articulo_list */
    .btn-action-piedra {
        width: 28px !important;
        height: 28px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: white !important;
        border: 1px solid #D4C4A8 !important;
        border-radius: 6px !important;
        color: #8B7355 !important;
        font-size: 0.75rem !important;
        transition: all 0.2s ease !important;
        text-decoration: none !important;
        cursor: pointer !important;
    }
    
    .btn-action-piedra:hover {
        background: #8B7355 !important;
        color: white !important;
        transform: scale(1.1) !important;
    }
    
    .btn-action-piedra i {
        font-size: 0.8rem !important;
    }

    /* --- SOFT UI PASTEL CARDS --- */
    /* Base */
    .card-stats-pastel-base {
        border-radius: 12px !important;
        position: relative !important;
        overflow: hidden !important;
        min-height: 100px !important;
        color: #4A5568 !important;
        transition: transform 0.3s ease, box-shadow 0.3s ease !important;
    }
    .card-stats-pastel-base:hover {
        transform: translateY(-5px) !important;
    }

    /* Gris Pastel (Soft UI) */
    .card-stats-pastel-gris {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
        border: 2px solid #bdbdbd !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05) !important;
    }

    /* Verde Pastel (Soft UI) */
    .card-stats-pastel-verde {
        background: linear-gradient(135deg, #c8e6c9 0%, #e8f5e9 100%) !important;
        border: 2px solid #81c784 !important;
        box-shadow: 0 10px 25px rgba(129, 199, 132, 0.2) !important;
    }

    /* Amarillo Pastel (Soft UI) */
    .card-stats-pastel-amarillo {
        background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
        border: 2px solid #fff59d !important;
        box-shadow: 0 10px 25px rgba(253, 216, 53, 0.15) !important;
    }

    /* Teal Pastel (Soft UI) */
    .card-stats-pastel-teal {
        background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%) !important;
        border: 2px solid #80cbc4 !important;
        box-shadow: 0 10px 25px rgba(0, 150, 136, 0.15) !important;
    }

    /* Textos dentro de cards */
    .card-title-pastel {
        font-size: 0.65rem !important;
        letter-spacing: 1px !important;
        font-weight: 700 !important;
        opacity: 0.8 !important;
        color: #4A5568 !important;
        text-transform: uppercase !important;
        margin-bottom: 0.25rem !important;
    }
    .card-value-pastel {
        color: #2D3748 !important;
        font-weight: 700 !important;
        font-size: 1.8rem !important;
    }
    .card-icon-bg {
        position: absolute !important;
        right: -5px !important;
        top: 0 !important;
        bottom: 0 !important;
        display: flex !important;
        align-items: center !important;
        font-size: 110px !important;
        opacity: 0.1 !important;
        pointer-events: none !important;
        z-index: 1 !important;
    }

    /* Badges */
    .badge-subtle {font-size: 0.65rem !important; padding: 4px 8px !important; border-radius: 6px !important; font-weight: 500 !important; border: 1px solid transparent !important;}
    .badge-borrador { background: #ECEFF1 !important; color: #546E7A !important; border-color: #CFD8DC !important; }
    .badge-confirmada { background: #E3F2FD !important; color: #1565C0 !important; border-color: #BBDEFB !important; }
    .badge-proceso { background: #FFF8E1 !important; color: #FF8F00 !important; border-color: #FFE0B2 !important; }
    .badge-completada { background: #E8F5E9 !important; color: #2E7D32 !important; border-color: #C8E6C9 !important; }
    .badge-cancelada { background: #FFEBEE !important; color: #C62828 !important; border-color: #FFCDD2 !important; }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 15px; background: #FAFAF8; min-height: 100vh;">
    <!-- Mensajes del sistema -->
    {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-custom alert-dismissible fade show shadow-sm" role="alert" style="border-left: 4px solid {% if message.tags == 'success' %}#28a745{% elif message.tags == 'error' %}#dc3545{% else %}#8B7355{% endif %};">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <!-- TARJETA PRINCIPAL CONTENEDORA -->
            <div class="card" style="border: 2px solid #E8DCC8 !important; border-radius: 15px !important; overflow: hidden !important; box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15) !important;">
                
                <!-- HEADER -->
                <div class="card-header" style="background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%) !important; border-bottom: 3px solid #D4C4A8 !important; padding: 15px 20px !important;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clipboard-list me-3" style="font-size: 2.2rem; color: #5D4037; opacity: 0.8;"></i>
                            <div>
                                <h2 class="mb-0 fw-light" style="font-family: 'Poppins', sans-serif; color: #5D4037; letter-spacing: -1px; font-size: 1.8rem;">
                                    Gestión de <span class="fw-bold">Pedidos</span>
                                </h2>
                                <div style="font-size: 0.85rem; font-family: 'Poppins', sans-serif; color: #5D4037; opacity: 0.8; margin-top: 2px;">
                                    Administra pedidos de clientes
                                </div>
                            </div>
                        </div>
                        <a href="{% url 'pedidos:orden_pedido_create' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.9); border: 1px solid #D4C4A8; color: #6F5B44; font-weight: 600; font-size: 0.75rem;">
                            <i class="fas fa-plus me-1"></i> Nuevo Pedido
                        </a>
                    </div>
                </div>
                
                <div class="card-body" style="background: #FAFAF8; padding: 15px;">
                    <!-- ESTADISTICAS SOFT UI -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-2 col-6">
                            <!-- Terracota (custom-colors.css) -->
                            <div class="card card-stats-pastel-terracota card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">Total</div>
                                    <h3 class="card-value-pastel">{{ stats.total_pedidos }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #e39d7e;">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                            <!-- Gris (Soft UI Local) -->
                            <div class="card card-stats-pastel-gris card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">Borrador</div>
                                    <h3 class="card-value-pastel">{{ stats.pedidos_borrador }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #616161;">
                                    <i class="fas fa-pencil-alt"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                            <!-- Azul (custom-colors.css) -->
                            <div class="card card-stats-pastel-azul card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">Confirmados</div>
                                    <h3 class="card-value-pastel">{{ stats.pedidos_confirmados }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #1e3c72;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                            <!-- Amarillo (Soft UI Local) -->
                            <div class="card card-stats-pastel-amarillo card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">En Proceso</div>
                                    <h3 class="card-value-pastel">{{ stats.pedidos_en_proceso }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #FF8F00;">
                                    <i class="fas fa-cog"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                            <!-- Verde (Soft UI Local) -->
                            <div class="card card-stats-pastel-verde card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">Completados</div>
                                    <h3 class="card-value-pastel">{{ stats.pedidos_completados }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #2E7D32;">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-6">
                           <!-- Teal (Soft UI Local) -->
                            <div class="card card-stats-pastel-teal card-stats-pastel-base">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title-pastel">Monto Total</div>
                                    <h3 class="card-value-pastel">${{ stats.monto_total|floatformat:0 }}</h3>
                                </div>
                                <div class="card-icon-bg" style="color: #00695C;">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FILTROS -->
                    <div style="padding: 15px; background: #FAFAF8; border-bottom: 1px solid #E8DCC8; margin-bottom: 15px; border-radius: 8px;">
                         <form method="get" id="filterForm">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="background: white; border-right: none; color: #8B7355; border-color: #D4C4A8;"><i class="fas fa-search"></i></span>
                                        {{ search_form.search }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    {{ search_form.estado }}
                                </div>
                                <div class="col-md-2">
                                    {{ search_form.cliente }}
                                </div>
                                <div class="col-md-2">
                                    {{ search_form.fecha_desde }}
                                </div>
                                <div class="col-md-2">
                                    {{ search_form.fecha_hasta }}
                                </div>
                                <div class="col-md-1">
                                    <button type="submit" class="btn btn-sm w-100" style="background: #8B7355; color: white; font-size: 0.75rem; border: none; padding: 4px 10px;">
                                        <i class="fas fa-filter"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- TABLA -->
                    <div class="table-responsive">
                        <table class="table-piedra mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">N° Pedido</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 15%;">Fecha</th>
                                    <th style="width: 15%;">N° OC Cliente</th>
                                    <th style="width: 10%; text-align: right;">Total</th>
                                    <th style="width: 10%; text-align: center;">Estado</th>
                                    <th style="width: 10%; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in page_obj %}
                                <tr>
                                    <td>
                                        <strong style="color: #6F5B44; font-size: 0.9rem;">{{ pedido.numero_pedido }}</strong>
                                        <div style="font-size: 0.7rem; color: #9E9E9E;">{{ pedido.bodega.nombre }}</div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; background: #E8DCC8; color: #6F5B44; font-size: 0.7rem;">
                                                {{ pedido.cliente.nombre|slice:":1" }}
                                            </div>
                                            <div>
                                                <div class="fw-bold" style="color: #5D4037; font-size: 0.8rem;">{{ pedido.cliente.nombre|truncatechars:40 }}</div>
                                                <small class="text-muted" style="font-size: 0.7rem;">{{ pedido.cliente.rut }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size: 0.8rem; color: #4A5568;">{{ pedido.fecha_pedido|date:"d/m/Y" }}</div>
                                        {% if pedido.fecha_entrega_estimada %}
                                        <small class="d-block text-muted" style="font-size: 0.7rem;">Entrega: {{ pedido.fecha_entrega_estimada|date:"d/m/Y" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pedido.numero_oc_cliente %}
                                            <span style="font-family: 'Courier New', monospace; font-weight: bold; color: #6F5B44; font-size: 0.85rem;">{{ pedido.numero_oc_cliente }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold" style="color: #6F5B44;">
                                        {{ pedido.total_pedido|currency_format_with_symbol }}
                                    </td>
                                    <td class="text-center">
                                        {% if pedido.estado == 'borrador' %}
                                            <span class="badge-subtle badge-borrador">Borrador</span>
                                        {% elif pedido.estado == 'confirmada' %}
                                            <span class="badge-subtle badge-confirmada">Confirmada</span>
                                        {% elif pedido.estado == 'en_proceso' %}
                                            <span class="badge-subtle badge-proceso">En Proceso</span>
                                        {% elif pedido.estado == 'completada' %}
                                            <span class="badge-subtle badge-completada">Completada</span>
                                        {% elif pedido.estado == 'cancelada' %}
                                            <span class="badge-subtle badge-cancelada">Cancelada</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-1">
                                            <a href="{% url 'pedidos:orden_pedido_detail' pedido.pk %}" class="btn-action-piedra" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'pedidos:orden_pedido_update' pedido.pk %}" class="btn-action-piedra" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fas fa-clipboard-list fa-3x mb-3 opacity-25" style="color: #8B7355;"></i>
                                            <h6 class="fw-bold" style="color: #8B7355;">No hay órdenes de pedido registradas</h6>
                                            <a href="{% url 'pedidos:orden_pedido_create' %}" class="btn btn-sm btn-outline-secondary mt-2" style="border-color: #D4C4A8; color: #8B7355;">
                                                <i class="fas fa-plus me-1"></i> Crear Pedido
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                
                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    <div class="card-footer bg-white border-top-0 py-3 mt-3">
                        <nav aria-label="Paginación">
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" style="color: #8B7355; border-color: #E8DCC8;"><i class="fas fa-chevron-left"></i></a>
                                    </li>
                                {% endif %}
                                
                                <li class="page-item active">
                                    <span class="page-link" style="background-color: #8B7355; border-color: #8B7355;">{{ page_obj.number }}</span>
                                </li>
                                
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}" style="color: #8B7355; border-color: #E8DCC8;"><i class="fas fa-chevron-right"></i></a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('#filterForm input, #filterForm select');
        inputs.forEach(input => {
            input.classList.add('form-control', 'form-control-sm');
            input.style.borderColor = '#D4C4A8';
            input.style.fontSize = '0.75rem';
        });
    });
</script>
{% endblock %}
