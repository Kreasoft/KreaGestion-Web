{% extends "base.html" %}
{% load static %}
{% load currency_filters %}

{% block title %}Despacho {{ despacho.pedido.numero_pedido }} - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-pendiente { background: #ffc107; color: #212529; }
    .status-preparando { background: #17a2b8; color: white; }
    .status-despachado { background: #28a745; color: white; }
    .status-entregado { background: #20c997; color: white; }
    .status-cancelado { background: #dc3545; color: white; }

    .info-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 1px solid #e3e6f0;
        margin-bottom: 1rem;
    }

    .document-badge {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        margin: 0.25rem;
        display: inline-block;
    }

    .items-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        border: 1px solid #e9ecef;
    }

    .item-row {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: 3px solid white;
        box-shadow: 0 0 0 2px #8B7355;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <!-- Header -->
            <div class="card shadow-sm mb-4" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; padding: 15px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-truck fa-2x text-white me-3"></i>
                            <div>
                                <h4 class="mb-0 text-white" style="font-family: 'Poppins', sans-serif; font-weight: 600;">
                                    Despacho {{ despacho.pedido.numero_pedido }}
                                </h4>
                                <small class="text-white-50" style="font-family: 'Poppins', sans-serif;">
                                    {{ despacho.get_tipo_despacho_display }} - {{ despacho.get_estado_display }}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="status-badge status-{{ despacho.estado }}">
                                {{ despacho.get_estado_display }}
                            </span>
                            <a href="{% url 'pedidos:despacho_list' %}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-2"></i> Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Información Principal -->
                <div class="col-md-8">
                    <!-- Información del Pedido -->
                    <div class="info-card">
                        <h5><i class="fas fa-clipboard-list me-2"></i>Información del Pedido</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Pedido:</strong> {{ despacho.pedido.numero_pedido }}</p>
                                <p class="mb-1"><strong>Cliente:</strong> {{ despacho.pedido.cliente.nombre }}</p>
                                <p class="mb-1"><strong>RUT:</strong> {{ despacho.pedido.cliente.rut }}</p>
                                <p class="mb-1"><strong>Bodega:</strong> {{ despacho.pedido.bodega.nombre }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Fecha Pedido:</strong> {{ despacho.pedido.fecha_pedido|date:"d/m/Y" }}</p>
                                {% if despacho.pedido.fecha_entrega_requerida %}
                                <p class="mb-1"><strong>Entrega Requerida:</strong> {{ despacho.pedido.fecha_entrega_requerida|date:"d/m/Y" }}</p>
                                {% endif %}
                                <p class="mb-1"><strong>Estado Pedido:</strong>
                                    <span class="badge" style="background: #17a2b8; color: white;">{{ despacho.pedido.get_estado_display }}</span>
                                </p>
                                <p class="mb-1"><strong>Total Pedido:</strong> <strong style="color: #8B7355;">${{ despacho.pedido.total_pedido|floatformat:0 }}</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Items del Pedido -->
                    <div class="info-card">
                        <h5><i class="fas fa-box me-2"></i>Items del Pedido</h5>
                        <div class="items-container">
                            {% for item in items_pedido %}
                            <div class="item-row">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <strong>{{ item.articulo.codigo }}</strong><br>
                                        <small class="text-muted">{{ item.articulo.nombre }}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <span class="badge" style="background: #6c757d; color: white; font-size: 0.8rem;">
                                            {{ item.cantidad }} {{ item.articulo.unidad_medida.nombre }}
                                        </span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <strong>${{ item.precio_unitario|floatformat:0 }}</strong><br>
                                        <small class="text-muted">Precio unitario</small>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        {% if item.descuento_porcentaje > 0 %}
                                        <span class="text-success" style="font-size: 0.8rem;">{{ item.descuento_porcentaje }}% OFF</span><br>
                                        {% endif %}
                                        <small class="text-muted">Descuento</small>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <strong style="color: #8B7355;">${{ item.get_total|floatformat:0 }}</strong><br>
                                        <small class="text-muted">Total item</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Items Despachados -->
                    {% if items_despachados %}
                    <div class="info-card">
                        <h5><i class="fas fa-truck me-2"></i>Items Despachados</h5>
                        <div class="items-container">
                            {% for item_despacho in items_despachados %}
                            <div class="item-row">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <strong>{{ item_despacho.item_pedido.articulo.codigo }}</strong><br>
                                        <small class="text-muted">{{ item_despacho.item_pedido.articulo.nombre }}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <span class="badge" style="background: #28a745; color: white;">
                                            {{ item_despacho.cantidad_despachar }} {{ item_despacho.item_pedido.articulo.unidad_medida.nombre }}
                                        </span>
                                        <br><small class="text-muted">de {{ item_despacho.item_pedido.cantidad }}</small>
                                        {% if item_despacho.cantidad_despachar == item_despacho.item_pedido.cantidad %}
                                        <br><small class="text-success">✓ Completo</small>
                                        {% else %}
                                        <br><small class="text-warning">⚠ Parcial</small>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <strong>${{ item_despacho.precio_unitario|floatformat:0 }}</strong><br>
                                        <small class="text-muted">Precio unitario</small>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        {% if item_despacho.descuento_porcentaje > 0 %}
                                        <span class="text-success">{{ item_despacho.descuento_porcentaje }}% OFF</span><br>
                                        {% endif %}
                                        <small class="text-muted">Descuento</small>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <strong style="color: #8B7355;">${{ item_despacho.get_total|floatformat:0 }}</strong><br>
                                        <small class="text-muted">Total item</small>
                                    </div>
                                </div>
                                {% if item_despacho.observaciones %}
                                <div class="mt-1">
                                    <small class="text-muted">Obs: {{ item_despacho.observaciones }}</small>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            <!-- Totales del despacho -->
                            {% if totales_despacho %}
                            <div class="mt-3 p-3" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border-radius: 8px; color: white;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Resumen del Despacho:</strong>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div><strong>Total: ${{ totales_despacho.total_despacho|floatformat:0 }}</strong></div>
                                        <small>{{ totales_despacho.cantidad_items }} item{{ totales_despacho.cantidad_items|pluralize }} despachado{{ totales_despacho.cantidad_items|pluralize }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Items Pendientes por Despachar -->
                    {% if items_pendientes %}
                    <div class="info-card">
                        <h5><i class="fas fa-clock me-2"></i>Items Pendientes</h5>
                        <div class="items-container">
                            {% for item_pendiente in items_pendientes %}
                            <div class="item-row">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <strong>{{ item_pendiente.item_pedido.articulo.codigo }}</strong><br>
                                        <small class="text-muted">{{ item_pendiente.item_pedido.articulo.nombre }}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <span class="badge" style="background: #ffc107; color: white;">
                                            {{ item_pendiente.cantidad_pendiente }} {{ item_pendiente.item_pedido.articulo.unidad_medida.nombre }}
                                        </span>
                                        <br><small class="text-muted">pendiente</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <small class="text-muted">Despachado: {{ item_pendiente.cantidad_despachada }}</small>
                                    </div>
                                    <div class="col-md-5 text-end">
                                        <button type="button" class="btn btn-sm" style="background: #17a2b8; color: white;" onclick="despacharItemPendiente({{ item_pendiente.item_pedido.id }})">
                                            <i class="fas fa-plus me-1"></i> Despachar Pendiente
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Documentos Generados -->
                    {% if despacho.get_documento_asociado %}
                    <div class="info-card">
                        <h5><i class="fas fa-file-invoice me-2"></i>Documentos Generados</h5>
                        <div class="document-badge">
                            <i class="fas fa-file-alt me-2"></i>
                            {{ despacho.get_tipo_documento }} N° {{ despacho.get_numero_documento }}
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Generado el {{ despacho.get_documento_asociado.fecha_emision|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'pedidos:despacho_imprimir_guia' despacho.pk %}"
                               class="btn btn-primary btn-sm w-100"
                               target="_blank"
                               title="Imprimir guía con timbre electrónico">
                                <i class="fas fa-print me-2"></i>
                                🖨️ Imprimir Guía de Despacho
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Panel Lateral -->
                <div class="col-md-4">
                    <!-- Estado y Acciones -->
                    <div class="info-card">
                        <h5><i class="fas fa-cog me-2"></i>Estado y Acciones</h5>

                        {% if despacho.estado == 'pendiente' %}
                        <div class="mb-3">
                            <a href="{% url 'pedidos:despacho_update' despacho.pk %}" class="btn btn-warning w-100 mb-2">
                                <i class="fas fa-edit me-2"></i> Editar Despacho
                            </a>
                            <a href="{% url 'pedidos:despacho_cambiar_estado' despacho.pk %}" class="btn" style="background: #28a745; color: white; width: 100%;">
                                <i class="fas fa-play me-2"></i> Iniciar Preparación
                            </a>
                        </div>
                        {% elif despacho.estado == 'preparando' %}
                        <div class="mb-3">
                            {% if despacho.get_documento_asociado %}
                            <a href="{% url 'pedidos:despacho_imprimir_guia' despacho.pk %}" class="btn btn-primary w-100 mb-2" target="_blank">
                                <i class="fas fa-print me-2"></i> 🖨️ Imprimir Guía
                            </a>
                            {% endif %}
                            <a href="{% url 'pedidos:despacho_cambiar_estado' despacho.pk %}" class="btn" style="background: #28a745; color: white; width: 100%; mb-2;">
                                <i class="fas fa-truck me-2"></i> Confirmar Despacho
                            </a>
                            <a href="{% url 'pedidos:despacho_update' despacho.pk %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-edit me-2"></i> Modificar
                            </a>
                        </div>
                        {% elif despacho.estado == 'despachado' %}
                        <div class="mb-3">
                            <a href="{% url 'pedidos:despacho_imprimir_guia' despacho.pk %}" class="btn btn-primary w-100 mb-2" target="_blank">
                                <i class="fas fa-print me-2"></i> 🖨️ Imprimir Guía
                            </a>
                            <a href="{% url 'pedidos:despacho_cambiar_estado' despacho.pk %}" class="btn" style="background: #20c997; color: white; width: 100%;">
                                <i class="fas fa-check me-2"></i> Marcar como Entregado
                            </a>
                        </div>
                        {% endif %}

                        {% if despacho.estado != 'cancelado' %}
                        <button class="btn btn-danger w-100" onclick="cancelarDespacho()">
                            <i class="fas fa-times me-2"></i> Cancelar Despacho
                        </button>
                        {% endif %}
                    </div>

                    <!-- Información de Entrega -->
                    <div class="info-card">
                        <h5><i class="fas fa-map-marker-alt me-2"></i>Información de Entrega</h5>
                        {% if despacho.direccion_entrega %}
                        <p class="mb-2"><strong>Dirección:</strong><br>{{ despacho.direccion_entrega }}</p>
                        {% endif %}
                        {% if despacho.contacto_entrega %}
                        <p class="mb-2"><strong>Contacto:</strong><br>{{ despacho.contacto_entrega }}</p>
                        {% endif %}
                        {% if despacho.telefono_entrega %}
                        <p class="mb-2"><strong>Teléfono:</strong><br>{{ despacho.telefono_entrega }}</p>
                        {% endif %}
                        {% if despacho.fecha_entrega_estimada %}
                        <p class="mb-2"><strong>Entrega Estimada:</strong><br>{{ despacho.fecha_entrega_estimada|date:"d/m/Y" }}</p>
                        {% endif %}
                        {% if despacho.fecha_entrega_real %}
                        <p class="mb-2"><strong>Entrega Real:</strong><br>{{ despacho.fecha_entrega_real|date:"d/m/Y" }}</p>
                        {% endif %}
                    </div>

                    <!-- Información de Transporte -->
                    {% if despacho.transportista or despacho.patente_vehiculo %}
                    <div class="info-card">
                        <h5><i class="fas fa-truck me-2"></i>Transporte</h5>
                        {% if despacho.transportista %}
                        <p class="mb-2"><strong>Transportista:</strong><br>{{ despacho.transportista }}</p>
                        {% endif %}
                        {% if despacho.patente_vehiculo %}
                        <p class="mb-2"><strong>Patente:</strong><br>{{ despacho.patente_vehiculo }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Observaciones -->
                    {% if despacho.observaciones %}
                    <div class="info-card">
                        <h5><i class="fas fa-sticky-note me-2"></i>Observaciones</h5>
                        <p class="mb-0">{{ despacho.observaciones }}</p>
                    </div>
                    {% endif %}

                    <!-- Timeline -->
                    <div class="info-card">
                        <h5><i class="fas fa-history me-2"></i>Historial</h5>
                        <div class="timeline">
                            <div class="timeline-item">
                                <div><strong>Despacho Creado</strong></div>
                                <small class="text-muted">{{ despacho.fecha_creacion|date:"d/m/Y H:i" }}</small>
                            </div>
                            {% if despacho.estado != 'pendiente' %}
                            <div class="timeline-item">
                                <div><strong>Inicio de Preparación</strong></div>
                                <small class="text-muted">Fecha por determinar</small>
                            </div>
                            {% endif %}
                            {% if despacho.estado == 'despachado' or despacho.estado == 'entregado' %}
                            <div class="timeline-item">
                                <div><strong>Despacho Confirmado</strong></div>
                                <small class="text-muted">{{ despacho.fecha_modificacion|date:"d/m/Y H:i" }}</small>
                            </div>
                            {% endif %}
                            {% if despacho.estado == 'entregado' and despacho.fecha_entrega_real %}
                            <div class="timeline-item">
                                <div><strong>Entrega Confirmada</strong></div>
                                <small class="text-muted">{{ despacho.fecha_entrega_real|date:"d/m/Y" }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transferencia de Inventario -->
            {% if despacho.transferencia_inventario %}
            <div class="info-card">
                <h5><i class="fas fa-exchange-alt me-2"></i>Transferencia de Inventario</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Folio:</strong> {{ despacho.transferencia_inventario.numero_folio }}</p>
                        <p class="mb-1"><strong>Origen:</strong> {{ despacho.transferencia_inventario.bodega_origen.nombre }}</p>
                        {% if despacho.transferencia_inventario.bodega_destino %}
                        <p class="mb-1"><strong>Destino:</strong> {{ despacho.transferencia_inventario.bodega_destino.nombre }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Fecha:</strong> {{ despacho.transferencia_inventario.fecha_transferencia|date:"d/m/Y H:i" }}</p>
                        <p class="mb-1"><strong>Estado:</strong>
                            {% if despacho.transferencia_inventario.estado == 'pendiente' %}
                                <span class="badge" style="background: #ffc107; color: #212529;">Pendiente</span>
                            {% elif despacho.transferencia_inventario.estado == 'confirmado' %}
                                <span class="badge" style="background: #28a745; color: white;">Confirmado</span>
                            {% elif despacho.transferencia_inventario.estado == 'cancelado' %}
                                <span class="badge" style="background: #dc3545; color: white;">Cancelado</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% if despacho.transferencia_inventario.observaciones %}
                <p class="mb-0 mt-2"><strong>Observaciones:</strong> {{ despacho.transferencia_inventario.observaciones }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    function cancelarDespacho() {
        if (confirm('¿Está seguro de que desea cancelar este despacho? Esta acción no se puede deshacer.')) {
            // Aquí se podría implementar la lógica para cancelar
            alert('Funcionalidad de cancelación en desarrollo');
        }
    }

    // Auto-refresh si el estado es dinámico
    {% if despacho.estado in 'pendiente,preparando' %}
    setInterval(function() {
        // Verificar si hay cambios en el estado
        location.reload();
    }, 30000); // Cada 30 segundos
    {% endif %}
</script>
{% endblock %}
{% endblock %}
