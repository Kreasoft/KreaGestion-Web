{% extends "base.html" %}
{% load static %}
{% load currency_filters %}
{% load l10n %}

{% block title %}
    {% if pedido %}Editar Orden de Pedido{% else %}Crear Orden de Pedido{% endif %}
{% endblock %}

{% block body_class %}hide-top-bar{% if pedido %} edit-mode{% endif %}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;       /* Marrón Piedra Principal */
        --stone-secondary: #6F5B44;     /* Marrón Oscuro */
        --stone-light: #E8DCC8;         /* Beige Piedra Claro (Bordes) */
        --stone-bg: #FAFAF8;            /* Fondo Crema Muy Claro */
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;          /* Texto Marrón Oscuro */
    }

    /* Fondo general */
    body {
        background-color: var(--stone-bg);
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* Contenedor Principal Estilo Piedra */
    .single-card-container {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(139, 115, 85, 0.08); /* Sombra cálida suave */
        padding: 1.5rem;
        max-width: 1400px;
        margin: 1rem auto;
    }

    /* Header de la Tarjeta */
    .stone-header {
        border-bottom: 2px solid var(--stone-light);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .stone-title {
        color: var(--stone-text);
        font-weight: 700;
        font-size: 1.25rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Inputs y Labels */
    .form-label {
        font-weight: 600;
        color: var(--stone-secondary);
        font-size: 0.8rem;
        margin-bottom: 0.3rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control, .form-select {
        border: 1px solid var(--stone-light);
        border-radius: 6px;
        font-size: 0.9rem;
        color: #495057;
        padding: 0.4rem 0.6rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--stone-primary);
        box-shadow: 0 0 0 0.2rem rgba(139, 115, 85, 0.15);
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid var(--stone-light);
        color: var(--stone-secondary);
    }

    /* Tabla / Lista de Items */
    .items-list-compact {
        border: 1px solid var(--stone-light);
        border-radius: 8px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .items-list-header {
        background: var(--stone-gradient); /* Gradiente Piedra para header de tabla */
        padding: 0.6rem 0.8rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--stone-text);
        border-bottom: 1px solid var(--stone-light);
    }

    .item-line {
        background: white;
        padding: 0.5rem 0.8rem;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }

    .item-line:hover {
        background-color: #fafafa;
    }

    .item-line:last-child {
        border-bottom: none;
    }
    
    /* Botones Estilo Piedra */
    .btn-stone-primary {
        background-color: var(--stone-primary);
        border: 1px solid var(--stone-primary);
        color: white;
        font-weight: 600;
        padding: 0.4rem 1rem;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .btn-stone-primary:hover {
        background-color: var(--stone-secondary);
        border-color: var(--stone-secondary);
        color: white;
        transform: translateY(-1px);
    }

    .btn-stone-secondary {
        background-color: white;
        border: 1px solid var(--stone-light);
        color: var(--stone-secondary);
        font-weight: 600;
        padding: 0.4rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

    .btn-stone-secondary:hover {
        background-color: #fafafa;
        color: var(--stone-primary);
        border-color: var(--stone-primary);
    }
    
    .btn-stone-danger {
        color: #d32f2f;
        background: white;
        border: 1px solid #ffcdd2;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    .btn-stone-danger:hover {
        background: #ffebee;
    }

    /* Subtotales y Totales */
    .totals-panel {
        background-color: #fafafa; /* Fondo muy suave */
        border: 1px solid var(--stone-light);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--stone-secondary);
        margin-bottom: 0.3rem;
    }

    .total-row.final {
        border-top: 2px solid var(--stone-light);
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--stone-text);
    }

    /* Select2 Personalizado Piedra */
    .select2-container--default .select2-selection--single {
        border-color: var(--stone-light) !important;
        height: 36px !important;
        padding-top: 3px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 34px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    
    <!-- Contenedor Único -->
    <div class="single-card-container">
        
        <!-- Header -->
        <div class="stone-header">
            <h1 class="stone-title">
                <i class="fas fa-file-invoice" style="color: var(--stone-primary);"></i>
                {% if pedido %}Editar Pedido #{{ pedido.numero_pedido }}{% else %}Nueva Orden de Pedido{% endif %}
            </h1>
            <div>
                 <a href="{% url 'pedidos:orden_pedido_list' %}" class="btn-stone-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>
            </div>
        </div>

        <form method="post" id="pedidoForm">
            {% csrf_token %}
            {% if form.errors or formset.errors %}
                <div class="alert alert-danger px-3 py-2 fs-6 mb-3 rounded-3 border-danger bg-white text-danger">
                     <i class="fas fa-exclamation-triangle me-2"></i> Hay errores en el formulario.
                </div>
            {% endif %}

            <!-- Datos Generales - Grid -->
            <div class="row g-3 mb-4">
                <div class="col-md-5">
                    <label class="form-label">Cliente *</label>
                    <div class="input-group">
                        {{ form.cliente }}
                        <button class="btn btn-outline-secondary" type="button"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha *</label>
                    {{ form.fecha_pedido }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Bodega *</label>
                    {{ form.bodega }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Estado</label>
                    {{ form.estado }}
                </div>
                 <div class="col-md-3">
                    <label class="form-label">Entrega Estimada</label>
                    {{ form.fecha_entrega_estimada }}
                </div>
                  <div class="col-md-9">
                    <label class="form-label">Observaciones</label>
                    {{ form.observaciones }}
                </div>
            </div>

            <!-- Sección Items -->
            <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
                <h5 class="m-0 text-muted text-uppercase fs-6 fw-bold" style="color: var(--stone-primary) !important;">
                    <i class="fas fa-boxes me-2"></i> Detalle Items
                </h5>
                <button type="button" class="btn-stone-primary btn-sm" id="addItemBtn">
                    <i class="fas fa-plus me-1"></i> Agregar Item
                </button>
            </div>

            {{ formset.management_form }}
            
            <div class="items-list-compact">
                <!-- Header Tabla -->
                <div class="items-list-header row g-0">
                    <div class="col-4 ps-2">Producto / Servicio</div>
                    <div class="col-2 text-center">Cant</div>
                    <div class="col-2 text-end pe-2">Precio</div>
                    <div class="col-2 text-center">Desc %</div>
                    <div class="col-2 text-end pe-3">Total</div>
                </div>
                
                <!-- Body Tabla -->
                <div id="items-container-body">
                    {% for item_form in formset %}
                        <div class="item-line row g-0 align-items-center" data-form-index="{{ forloop.counter0 }}">
                            <div class="col-4 ps-2 pe-2">
                                {{ item_form.id }}
                                {% if item_form.DELETE %}<div style="display:none;">{{ item_form.DELETE }}</div>{% endif %}
                                {{ item_form.impuesto_porcentaje.as_hidden }}
                                
                                <select name="{{ item_form.articulo.html_name }}" class="form-select articulo-select form-control-sm" data-index="{{ forloop.counter0 }}">
                                    <option value="">Buscar...</option>
                                    {% for articulo in articulos_empresa %}
                                        <option value="{{ articulo.id|unlocalize }}"
                                                data-precio="{{ articulo.precio_venta|unlocalize }}"
                                                {% if item_form.articulo.value|stringformat:'s' == articulo.id|stringformat:'s' %}selected{% endif %}>
                                            {{ articulo.codigo }} - {{ articulo.nombre|truncatechars:35 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-2 px-1">
                                <input type="number" name="{{ item_form.cantidad.html_name }}" class="form-control form-control-sm text-center" 
                                       value="{{ item_form.cantidad.value|default:1 }}" step="any">
                            </div>
                            <div class="col-2 px-1">
                                <input type="number" name="{{ item_form.precio_unitario.html_name }}" class="form-control form-control-sm text-end"
                                       value="{{ item_form.precio_unitario.value|default:0 }}">
                            </div>
                             <div class="col-2 px-1">
                                <input type="number" name="{{ item_form.descuento_porcentaje.html_name }}" class="form-control form-control-sm text-center"
                                       value="{{ item_form.descuento_porcentaje.value|default:0 }}" step="0.01">
                            </div>
                            <div class="col-2 ps-1 pe-2 d-flex align-items-center">
                                <input type="text" class="form-control form-control-sm text-end item-total bg-transparent border-0 fw-bold" readonly placeholder="$0">
                                <button type="button" class="btn-stone-danger ms-2" onclick="eliminarItem(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Footer con Totales -->
            <div class="row justify-content-end">
                <div class="col-md-4">
                    <div class="totals-panel">
                        <div class="total-row"><span>Subtotal Neto:</span> <span id="subtotal-total" class="fw-bold">0</span></div>
                        <div class="total-row"><span>Descuentos:</span> <span id="descuentos-total" class="text-danger">0</span></div>
                        <div class="total-row"><span>IVA (19%):</span> <span id="iva-total">0</span></div>
                        <div class="total-row final"><span>TOTAL:</span> <span id="total-total" style="color: #2e7d32;">0</span></div>
                    </div>

                    
                    <!-- Opcionales (Colapsados o Visibles) -->
                    <div class="mt-3 p-2 border rounded bg-white small">
                        <div class="fw-bold text-muted mb-2 text-uppercase" style="font-size: 0.7rem;">Opcionales</div>
                        <div class="row g-2">
                             <div class="col-6">
                                <label class="form-label" style="font-size: 0.7rem;">N° OC Cliente</label>
                                {{ form.numero_oc_cliente }}
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="font-size: 0.7rem;">Fecha OC</label>
                                {{ form.fecha_oc_cliente }}
                            </div>
                             <div class="col-12">
                                <label class="form-label" style="font-size: 0.7rem;">Condiciones Pago</label>
                                {{ form.condiciones_pago }}
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-stone-primary w-100 mt-3 py-2 fs-6">
                        <i class="fas fa-save me-2"></i> Guardar Pedido
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<!-- Template Oculto JS -->
<div id="empty-form-template" style="display:none;">
    <div class="item-line row g-0 align-items-center" data-form-index="__prefix__">
        <div class="col-4 ps-2 pe-2">
             <select name="items-__prefix__-articulo" class="form-select articulo-select form-control-sm">
                <option value="">Buscar...</option>
                {% for articulo in articulos_empresa %}
                    <option value="{{ articulo.id|unlocalize }}" data-precio="{{ articulo.precio_venta|unlocalize }}">{{ articulo.codigo }} - {{ articulo.nombre|truncatechars:35 }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-2 px-1"><input type="number" name="items-__prefix__-cantidad" class="form-control form-control-sm text-center" value="1" step="any"></div>
        <div class="col-2 px-1"><input type="number" name="items-__prefix__-precio_unitario" class="form-control form-control-sm text-end" value="0"></div>
        <div class="col-2 px-1"><input type="number" name="items-__prefix__-descuento_porcentaje" class="form-control form-control-sm text-center" value="0" step="0.01"></div>
        <div class="col-2 ps-1 pe-2 d-flex align-items-center">
            <input type="text" class="form-control form-control-sm text-end item-total bg-transparent border-0 fw-bold" readonly placeholder="$0">
            <button type="button" class="btn-stone-danger ms-2" onclick="eliminarItem(this)"><i class="fas fa-times"></i></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    $.fn.select2.defaults.set("theme", "default");
    
    function precioChilenoANumero(precio) {
        if (!precio) return 0;
        let precioStr = String(precio).trim();
        if (typeof precio === 'number') return Math.round(precio);
        if (/^\d+$/.test(precioStr)) return parseInt(precioStr);
        const puntos = (precioStr.match(/\./g) || []).length;
        const comas = (precioStr.match(/,/g) || []).length;
        if (comas > 0) precioStr = precioStr.replace(/\./g, '').replace(',', '.');
        else if (puntos > 1) precioStr = precioStr.replace(/\./g, '');
        else if (puntos === 1) { const partes = precioStr.split('.'); if (partes[1] && partes[1].length === 3) precioStr = precioStr.replace(/\./g, ''); }
        return Math.round(parseFloat(precioStr) || 0);
    }
    
    function initSelect2(element) { $(element).select2({ placeholder: 'Buscar...', allowClear: true, width: '100%' }); }
    
    initSelect2($('#{{ form.cliente.id_for_label }}'));
    $('.articulo-select').each(function() { initSelect2(this); });

    function calculateTotal() {
        let subtotal = 0, descuentos = 0, iva = 0;
        
        // Iterar sobre las filas visibles (excluyendo template __prefix__)
        $('#items-container-body .item-line:visible').each(function() {
            const row = $(this);
            if(row.attr('data-form-index') === '__prefix__') return;

            const cantidad = parseFloat(row.find('input[name$="-cantidad"]').val()) || 0;
            const precio = parseFloat(row.find('input[name$="-precio_unitario"]').val()) || 0;
            const descPorc = parseFloat(row.find('input[name$="-descuento_porcentaje"]').val()) || 0;
            
            const totalBruto = cantidad * precio;
            const montoDesc = totalBruto * (descPorc / 100);
            const totalNeto = totalBruto - montoDesc;
            const montoIva = totalNeto * 0.19; 
            const totalFinal = totalNeto + montoIva;
            
            row.find('.item-total').val('$' + Math.round(totalFinal).toLocaleString('es-CL'));
            
            subtotal += totalNeto;
            descuentos += montoDesc;
            iva += montoIva;
        });
        
        const total = subtotal + iva;
        
        $('#subtotal-total').text('$' + Math.round(subtotal).toLocaleString('es-CL'));
        $('#descuentos-total').text('$' + Math.round(descuentos).toLocaleString('es-CL'));
        $('#iva-total').text('$' + Math.round(iva).toLocaleString('es-CL'));
        $('#total-total').text('$' + Math.round(total).toLocaleString('es-CL'));
    }
    
    
    // Listeners
    $(document).on('input change', 'input', calculateTotal);

    // Auto-precio
    $(document).on('change', '.articulo-select', function() {
        const option = $(this).find(':selected');
        const precio = option.data('precio');
        if (precio) {
            const row = $(this).closest('.item-line');
            row.find('input[name$="-precio_unitario"]').val(precioChilenoANumero(precio));
            calculateTotal();
        }
    });

    // Agregar Item
    $('#addItemBtn').click(function() {
        const totalForms = $('#id_items-TOTAL_FORMS');
        const count = parseInt(totalForms.val());
        const tmpl = $('#empty-form-template').html();
        const compiledTmpl = tmpl.replace(/__prefix__/g, count);
        
        $('#items-container-body').append(compiledTmpl);
        totalForms.val(count + 1);
        
        initSelect2($('#items-container-body .item-line:last-child .articulo-select'));
    });
    
    // Eliminar Item
    window.eliminarItem = function(btn) {
        const row = $(btn).closest('.item-line');
        const delInput = row.find('input[name$="-DELETE"]');
        if (delInput.length) {
            delInput.prop('checked', true); 
            delInput.val('on'); 
            row.hide();
        } else {
            row.remove(); 
        }
        calculateTotal();
    };
    
    calculateTotal();
});
</script>
{% endblock %}
