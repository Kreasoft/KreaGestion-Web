{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if pedido %}
        Editar Orden de Pedido - GestionCloud
    {% else %}
        Crear Orden de Pedido - GestionCloud
    {% endif %}
{% endblock %}

{% block body_class %}hide-top-bar{% if pedido %} edit-mode{% endif %}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .form-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 1px solid #e3e6f0;
        margin-bottom: 1rem;
    }
    
    .form-section h5 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    
    .items-container {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .item-form-compact {
        padding: 0.05rem 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .item-form-compact .form-control-sm,
    .item-form-compact .form-select-sm {
        padding: 0.1rem 0.25rem;
        font-size: 0.7rem;
        line-height: 1;
        height: 24px;
    }
    
    .item-form-compact input[name*="cantidad"],
    .item-form-compact input[name*="precio_unitario"],
    .item-form-compact input[name*="descuento_porcentaje"] {
        height: 32px !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.75rem !important;
    }
    
    /* Todos los controles del formulario a 32px */
    .form-control, .form-select, .form-control-sm, .form-select-sm {
        height: 32px !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.8rem !important;
        line-height: 1.5 !important;
    }
    
    input[type="date"], input[type="text"], select, textarea {
        height: 32px !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.8rem !important;
    }
    
    textarea {
        height: auto !important;
        min-height: 60px !important;
    }
    
    .select2-container--default .select2-selection--single {
        border: 1px solid #e3e6f0 !important;
        border-radius: 4px !important;
        height: 32px !important;
        padding: 0 !important;
        background-color: #fff !important;
        min-height: 32px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 30px !important;
        font-size: 0.8rem !important;
        color: #495057 !important;
        padding-left: 8px !important;
        padding-right: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 30px !important;
    }
    
    /* Estilos para dropdown de Select2 - MÁS COMPACTO */
    .select2-dropdown {
        border: 1px solid #e3e6f0 !important;
        border-radius: 6px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        border: 1px solid #e3e6f0 !important;
        border-radius: 4px !important;
        padding: 4px 8px !important;
        font-size: 0.75rem !important;
        height: 28px !important;
    }
    
    .select2-results__option {
        font-size: 0.75rem !important;
        padding: 4px 8px !important;
        line-height: 1.2 !important;
        border-bottom: 1px solid #f8f9fc !important;
    }
    
    .select2-results__option--highlighted {
        background-color: #8B7355 !important;
        color: white !important;
    }
    
    .select2-results__option--selected {
        background-color: #e9ecef !important;
        color: #495057 !important;
    }
    
    /* Aumentar altura del dropdown para mostrar más resultados */
    .select2-results {
        max-height: 400px !important;
    }
    
    .select2-container {
        width: 100% !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: none; border-radius: 15px; overflow: hidden;">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; padding: 12px 16px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clipboard-list text-white me-2" style="font-size: 1.2rem;"></i>
                            <div>
                                <h5 class="mb-0 text-white" style="font-size: 1.1rem; font-weight: 600;">
                                    {% if pedido %}
                                        Editar Orden de Pedido
                                    {% else %}
                                        Crear Orden de Pedido
                                    {% endif %}
                                </h5>
                                {% if pedido %}
                                <small class="text-white-50" style="font-size: 0.8rem;">{{ pedido.numero_pedido }}</small>
                                {% else %}
                                <small class="text-white-50" style="font-size: 0.8rem;">
                                    <i class="fas fa-info-circle me-1"></i>Registra pedidos de clientes con múltiples artículos. Busca clientes por RUT/nombre y productos por código/nombre.
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        <a href="{% url 'pedidos:orden_pedido_list' %}" class="btn btn-sm btn-light">
                            <i class="fas fa-arrow-left me-1"></i> Volver
                        </a>
                    </div>
                </div>

                <!-- Formulario -->
                <div class="card-body" style="padding: 1rem;">
                    <!-- Mensajes de error -->
                    {% if form.errors or formset.errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Error al guardar:</strong>
                        <ul class="mb-0 mt-2">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for form_errors in formset.errors %}
                                {% for field, errors in form_errors.items %}
                                    {% for error in errors %}
                                        <li>Item: {{ field }} - {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    <form method="post" id="pedidoForm">
                        {% csrf_token %}
                        
                        <!-- Información del Pedido - COMPACTA -->
                        <div class="card" style="background: #F5F1E8; border: 1px solid #E0D5C7; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="row g-2">
                                <!-- Fila 1: Cliente con búsqueda RUT + Botón Cotización -->
                                <div class="col-md-5">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-user me-1"></i>Cliente * <span class="text-muted" style="font-size: 0.65rem; font-weight: 400;">(Buscar por RUT o Nombre)</span>
                                    </label>
                                    {{ form.cliente }}
                                </div>
                                
                                <!-- Botón Cargar Cotización (aparece si hay cotizaciones) -->
                                <div class="col-md-2" id="cotizacion-container" style="display: none;">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-file-invoice me-1"></i>Cotización
                                    </label>
                                    <button type="button" class="btn btn-sm w-100" id="btnCargarCotizacion" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; height: 32px; font-size: 0.75rem; font-weight: 600;">
                                        <i class="fas fa-download me-1"></i>Cargar Cotización
                                    </button>
                                </div>
                                
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-warehouse me-1"></i>Bodega *
                                    </label>
                                    {{ form.bodega }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-calendar me-1"></i>Fecha Pedido *
                                    </label>
                                    {{ form.fecha_pedido }}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-flag me-1"></i>Estado
                                    </label>
                                    {{ form.estado }}
                                </div>
                            </div>
                            
                            <!-- Fila 2: Datos adicionales compactos -->
                            <div class="row g-2 mt-1">
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        Fecha Entrega
                                    </label>
                                    {{ form.fecha_entrega_estimada }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        N° OC Cliente
                                    </label>
                                    {{ form.numero_oc_cliente }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        Fecha OC
                                    </label>
                                    {{ form.fecha_oc_cliente }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.2rem; color: #6F5B44;">
                                        <i class="fas fa-credit-card me-1"></i>Condiciones de Pago
                                    </label>
                                    {{ form.condiciones_pago }}
                                </div>
                            </div>
                        </div>

                        <!-- Items del Pedido -->
                        <h5 style="font-weight: 700; color: #495057; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-list me-1"></i>Items del Pedido 
                            <small class="text-muted" style="font-size: 0.7rem; font-weight: 400;">
                                (Busca productos por código o nombre en el selector)
                            </small>
                            <button type="button" class="btn btn-success btn-sm float-end" id="addItemBtn" style="padding: 0.3rem 0.8rem; font-size: 0.75rem;">
                                <i class="fas fa-plus me-1"></i>Agregar Item
                            </button>
                        </h5>
                        <div class="items-container">
                            {{ formset.management_form }}
                            
                            <!-- Headers -->
                            <div class="row mb-1 align-items-center" style="font-weight: 600; color: #6F5B44; font-size: 0.7rem; background: #F5F1E8; padding: 0.2rem 0.5rem; border-radius: 4px; border-bottom: 1px solid #E0D5C7;">
                                <div class="col-md-5">
                                    <i class="fas fa-box me-1"></i>Artículo (Escribe para buscar)
                                </div>
                                <div class="col-md-1">Cant.</div>
                                <div class="col-md-2">Precio Unit.</div>
                                <div class="col-md-1">Desc. %</div>
                                <div class="col-md-2">Total</div>
                                <div class="col-md-1 text-center">Acciones</div>
                            </div>
                            
                            <!-- Items -->
                            {% for item_form in formset %}
                                <div class="item-form-compact" data-form-index="{{ forloop.counter0 }}" style="margin-bottom: 0; padding: 0.05rem 0.5rem; border-bottom: 1px solid #e9ecef; {% cycle 'background: #ffffff;' 'background: #f8f9fc;' %}">
                                    <div class="row align-items-center" style="padding: 0.2rem 0;">
                                        {{ item_form.id }}
                                        <input type="hidden" name="{{ item_form.DELETE.html_name }}" id="{{ item_form.DELETE.id_for_label }}">
                                        
                                        <div class="col-md-5">
                                            <select name="{{ item_form.articulo.html_name }}" class="form-select form-select-sm articulo-select" data-index="{{ forloop.counter0 }}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; height: 32px;">
                                                <option value="">Buscar por código o nombre...</option>
                                                {% for articulo in articulos_empresa %}
                                                    <option value="{{ articulo.id }}"
                                                            data-codigo="{{ articulo.codigo }}"
                                                            data-nombre="{{ articulo.nombre }}"
                                                            data-precio="{{ articulo.precio_venta }}"
                                                            {% if item_form.articulo.value == articulo.id %}selected{% endif %}>
                                                        {{ articulo.codigo }} - {{ articulo.nombre|truncatechars:50 }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-1">
                                            {{ item_form.cantidad }}
                                        </div>
                                        <div class="col-md-2">
                                            {{ item_form.precio_unitario }}
                                        </div>
                                        <div class="col-md-1">
                                            {{ item_form.descuento_porcentaje }}
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control form-control-sm item-total" readonly placeholder="0" style="font-weight: 600; background-color: #f8f9fc; font-size: 0.75rem; padding: 0.25rem 0.5rem; height: 32px;">
                                        </div>
                                        <div class="col-md-1 text-center">
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-item-btn"
                                                    data-form-index="{{ forloop.counter0 }}"
                                                    title="Eliminar item"
                                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; height: 32px;"
                                                    onclick="eliminarItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Observaciones y Totales -->
                        <div class="row mt-2">
                            <!-- Observaciones -->
                            <div class="col-md-8">
                                <div class="card" style="background: #F5F1E8; border: 1px solid #E0D5C7; border-radius: 8px; padding: 0.75rem; height: 100%;">
                                    <label class="form-label" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.3rem; color: #6F5B44;">
                                        <i class="fas fa-comment-alt me-1"></i>Observaciones
                                    </label>
                                    {{ form.observaciones }}
                                </div>
                            </div>
                            
                            <!-- Totales -->
                            <div class="col-md-4">
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; height: 100%;">
                                    <div style="background: #6c757d; color: white; padding: 6px; margin: -10px -10px 8px -10px; border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 0.8rem;">
                                        <i class="fas fa-calculator"></i> RESUMEN
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dee2e6; font-size: 0.75rem;">
                                        <span style="font-weight: 600;">Subtotal:</span>
                                        <span id="subtotal-total" style="font-weight: 700;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dee2e6; font-size: 0.75rem;">
                                        <span style="font-weight: 600;">Descuentos:</span>
                                        <span id="descuentos-total" style="font-weight: 700; color: #dc3545;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dee2e6; font-size: 0.75rem;">
                                        <span style="font-weight: 600;">IVA (19%):</span>
                                        <span id="iva-total" style="font-weight: 700;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.85rem;">
                                        <span style="font-weight: 700; color: #2c3e50;">TOTAL:</span>
                                        <span id="total-total" style="font-weight: 700; font-size: 1rem; color: #28a745;">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row mt-3">
                            <div class="col-12 text-end">
                                <a href="{% url 'pedidos:orden_pedido_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Guardar Pedido
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    console.log('🔧 Inicializando Select2 para Pedidos...');
    
    // Inicializar Select2 para el selector de cliente
    $('#{{ form.cliente.id_for_label }}').select2({
        placeholder: 'Buscar cliente por RUT, razón social o nombre...',
        allowClear: true,
        language: {
            noResults: function() {
                return "No se encontraron clientes";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        width: '100%',
        dropdownAutoWidth: true,
        minimumResultsForSearch: 0
    });
    
    // Inicializar Select2 para bodega y estado
    $('#{{ form.bodega.id_for_label }}').select2({
        placeholder: 'Seleccionar bodega...',
        allowClear: true,
        width: '100%',
        minimumResultsForSearch: -1
    });
    
    $('#{{ form.estado.id_for_label }}').select2({
        placeholder: 'Seleccionar estado...',
        allowClear: true,
        width: '100%',
        minimumResultsForSearch: -1
    });
    
    // Inicializar Select2 para todos los selectores de artículos
    $('.articulo-select').select2({
        placeholder: 'Buscar artículo por código o nombre...',
        allowClear: true,
        language: {
            noResults: function() {
                return "No se encontraron artículos";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        width: '100%',
        dropdownAutoWidth: true,
        minimumResultsForSearch: 0
    });
    
    console.log('✅ Select2 inicializado correctamente');
    
    // Detectar cambio de cliente para verificar cotizaciones
    $('#{{ form.cliente.id_for_label }}').on('change', function() {
        const clienteId = $(this).val();
        if (clienteId) {
            verificarCotizaciones(clienteId);
        } else {
            $('#cotizacion-container').hide();
        }
    });
    
    // Verificar cotizaciones del cliente
    function verificarCotizaciones(clienteId) {
        if (!clienteId) {
            $('#cotizacion-container').hide();
            return;
        }
        
        // TODO: Implementar cuando exista el módulo de cotizaciones
        // Por ahora, simular que no hay cotizaciones
        $('#cotizacion-container').hide();
        
        /* CÓDIGO PARA CUANDO SE IMPLEMENTE COTIZACIONES:
        $.ajax({
            url: '/ventas/cotizaciones/pendientes/' + clienteId + '/',
            method: 'GET',
            success: function(data) {
                if (data.cotizaciones && data.cotizaciones.length > 0) {
                    $('#cotizacion-container').show();
                    $('#btnCargarCotizacion').data('cotizaciones', data.cotizaciones);
                } else {
                    $('#cotizacion-container').hide();
                }
            },
            error: function() {
                $('#cotizacion-container').hide();
            }
        });
        */
    }
    
    // Cargar cotización
    $('#btnCargarCotizacion').click(function() {
        const cotizaciones = $(this).data('cotizaciones');
        
        if (!cotizaciones || cotizaciones.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Sin cotizaciones',
                text: 'No hay cotizaciones pendientes para este cliente',
                confirmButtonColor: '#8B7355'
            });
            return;
        }
        
        // Mostrar lista de cotizaciones para seleccionar
        const options = {};
        cotizaciones.forEach(function(cot) {
            options[cot.id] = cot.numero + ' - ' + cot.fecha + ' - $' + cot.total;
        });
        
        Swal.fire({
            title: 'Seleccionar Cotización',
            input: 'select',
            inputOptions: options,
            inputPlaceholder: 'Seleccione una cotización',
            showCancelButton: true,
            confirmButtonText: 'Cargar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#8B7355',
            inputValidator: (value) => {
                if (!value) {
                    return 'Debe seleccionar una cotización';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                cargarDatosCotizacion(result.value);
            }
        });
    });
    
    // Cargar datos de la cotización seleccionada
    function cargarDatosCotizacion(cotizacionId) {
        // TODO: Implementar cuando exista el módulo de cotizaciones
        Swal.fire({
            icon: 'info',
            title: 'Función pendiente',
            text: 'La carga de cotizaciones se implementará cuando esté disponible el módulo de cotizaciones',
            confirmButtonColor: '#8B7355'
        });
        
        /* CÓDIGO PARA CUANDO SE IMPLEMENTE COTIZACIONES:
        $.ajax({
            url: '/ventas/cotizaciones/' + cotizacionId + '/detalle/',
            method: 'GET',
            success: function(data) {
                // Limpiar items actuales
                $('.item-form-compact').not(':first').remove();
                
                // Cargar items de la cotización
                data.items.forEach(function(item, index) {
                    if (index > 0) {
                        $('#addItemBtn').click();
                    }
                    
                    const $row = $('.item-form-compact').eq(index);
                    $row.find('.articulo-select').val(item.articulo_id).trigger('change');
                    $row.find('input[name*="cantidad"]').val(item.cantidad);
                    $row.find('input[name*="precio_unitario"]').val(item.precio_unitario);
                    $row.find('input[name*="descuento_porcentaje"]').val(item.descuento_porcentaje);
                });
                
                // Cargar observaciones si existen
                if (data.observaciones) {
                    $('textarea[name="observaciones"]').val(data.observaciones);
                }
                
                calculateTotals();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Cotización cargada',
                    text: 'Los datos de la cotización se han cargado correctamente',
                    confirmButtonColor: '#8B7355',
                    timer: 2000
                });
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar la cotización',
                    confirmButtonColor: '#8B7355'
                });
            }
        });
        */
    }
    
    // Calcular totales
    function calculateTotals() {
        let subtotal = 0;
        let descuentos = 0;
        let iva = 0;
        
        $('.item-form-compact:visible').each(function() {
            const cantidad = parseFloat($(this).find('input[name*="cantidad"]').val()) || 0;
            const precio = parseFloat($(this).find('input[name*="precio_unitario"]').val()) || 0;
            const descuento = parseFloat($(this).find('input[name*="descuento_porcentaje"]').val()) || 0;
            
            const itemSubtotal = cantidad * precio;
            const itemDescuento = itemSubtotal * (descuento / 100);
            const itemBase = itemSubtotal - itemDescuento;
            const itemIva = itemBase * 0.19;
            const itemTotal = itemBase + itemIva;
            
            $(this).find('.item-total').val(Math.round(itemTotal).toLocaleString('es-CL'));
            
            subtotal += itemSubtotal;
            descuentos += itemDescuento;
            iva += itemIva;
        });
        
        const total = subtotal - descuentos + iva;
        
        $('#subtotal-total').text('$' + Math.round(subtotal).toLocaleString('es-CL'));
        $('#descuentos-total').text('$' + Math.round(descuentos).toLocaleString('es-CL'));
        $('#iva-total').text('$' + Math.round(iva).toLocaleString('es-CL'));
        $('#total-total').text('$' + Math.round(total).toLocaleString('es-CL'));
    }
    
    // Actualizar precio cuando se selecciona artículo
    $(document).on('change', '.articulo-select', function() {
        const selected = $(this).find(':selected');
        const precio = selected.data('precio') || 0;
        const row = $(this).closest('.item-form-compact');
        row.find('input[name*="precio_unitario"]').val(precio);
        calculateTotals();
    });
    
    // Recalcular al cambiar valores
    $(document).on('input', 'input[name*="cantidad"], input[name*="precio_unitario"], input[name*="descuento_porcentaje"]', function() {
        calculateTotals();
    });
    
    // Agregar item
    let formIdx = $('.item-form-compact').length;
    $('#addItemBtn').click(function() {
        const newForm = $('.item-form-compact:first').clone();
        
        // Destruir Select2 del elemento clonado si existe
        const clonedSelect = newForm.find('.articulo-select');
        if (clonedSelect.length && clonedSelect.data('select2')) {
            clonedSelect.select2('destroy');
        }
        
        newForm.find('input, select').each(function() {
            const name = $(this).attr('name');
            if (name) {
                $(this).attr('name', name.replace('-0-', '-' + formIdx + '-'));
                $(this).attr('id', 'id_' + name.replace('-0-', '-' + formIdx + '-'));
            }
            if ($(this).is('select')) {
                $(this).val('');
            } else if ($(this).attr('type') !== 'hidden') {
                $(this).val('');
            }
        });
        newForm.attr('data-form-index', formIdx);
        newForm.find('.delete-item-btn').attr('data-form-index', formIdx);
        $('.items-container').append(newForm);
        
        // Reinicializar Select2 en el nuevo formulario
        newForm.find('.articulo-select').select2({
            placeholder: 'Buscar artículo por código o nombre...',
            allowClear: true,
            language: {
                noResults: function() {
                    return "No se encontraron artículos";
                },
                searching: function() {
                    return "Buscando...";
                }
            },
            width: '100%',
            dropdownAutoWidth: true,
            minimumResultsForSearch: 0
        });
        
        $('#id_items-TOTAL_FORMS').val(formIdx + 1);
        formIdx++;
        calculateTotals();
    });
    
    // Calcular totales iniciales
    calculateTotals();
    
    // Validar formulario antes de enviar
    $('#pedidoForm').on('submit', function(e) {
        let errores = [];
        
        // Validar cliente
        if (!$('#{{ form.cliente.id_for_label }}').val()) {
            errores.push('Debe seleccionar un cliente');
        }
        
        // Validar bodega
        if (!$('#{{ form.bodega.id_for_label }}').val()) {
            errores.push('Debe seleccionar una bodega');
        }
        
        // Validar fecha
        if (!$('input[name="fecha_pedido"]').val()) {
            errores.push('Debe ingresar la fecha del pedido');
        }
        
        // Validar que haya al menos un item
        let itemsValidos = 0;
        $('.item-form-compact:visible').each(function() {
            const articulo = $(this).find('.articulo-select').val();
            const cantidad = $(this).find('input[name*="cantidad"]').val();
            const precio = $(this).find('input[name*="precio_unitario"]').val();
            
            if (articulo && cantidad && precio) {
                itemsValidos++;
            }
        });
        
        if (itemsValidos === 0) {
            errores.push('Debe agregar al menos un artículo con cantidad y precio');
        }
        
        // Mostrar errores si hay
        if (errores.length > 0) {
            e.preventDefault();
            let mensajeError = '<strong>Por favor corrija los siguientes errores:</strong><ul class="mt-2 mb-0">';
            errores.forEach(function(error) {
                mensajeError += '<li>' + error + '</li>';
            });
            mensajeError += '</ul>';
            
            Swal.fire({
                icon: 'error',
                title: 'Errores en el formulario',
                html: mensajeError,
                confirmButtonColor: '#8B7355'
            });
            
            return false;
        }
        
        // Mostrar loading
        Swal.fire({
            title: 'Guardando pedido...',
            html: 'Por favor espere',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    });
});

// Eliminar item
function eliminarItem(button) {
    const row = $(button).closest('.item-form-compact');
    const deleteInput = row.find('input[name*="DELETE"]');
    
    if (deleteInput.length) {
        deleteInput.val('on');
        row.hide();
    } else {
        row.remove();
    }
    
    $(document).ready(function() {
        calculateTotals();
    });
}
</script>
{% endblock %}
