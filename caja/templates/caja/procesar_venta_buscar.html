{% extends "base.html" %}
{% load static %}
{% load articulo_filters %}

{% block title %}Procesar Venta - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
        min-height: 100vh;
    }

    .card-header-terroso {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        padding: 20px;
        border: none;
        font-family: 'Poppins', sans-serif;
    }

    .btn-terroso {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        color: white;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    .btn-terroso:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.3);
        color: white;
    }

    .btn-terroso-outline {
        background: transparent;
        border: 2px solid #8B7355;
        color: #8B7355;
        font-weight: 500;
    }

    .btn-terroso-outline:hover {
        background: #8B7355;
        color: white;
    }

    .alert-info-terroso {
        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
        border: 1px solid #D4C4A8;
        border-left: 4px solid #8B7355;
        color: #6F5B44;
    }

    .table thead {
        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
        color: #6F5B44;
    }

    .text-terroso {
        color: #8B7355;
    }

    .badge-terroso {
        background: linear-gradient(135deg, #D4A574 0%, #C19A6B 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Banner superior -->
<div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #F5F1E8 0%, #E8DED5 100%); color: #6F5B44; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: 500; font-family: 'Poppins', sans-serif; z-index: 9999; border-bottom: 1px solid #D4C4A8;">
    Procesar Venta - Buscar Ticket
</div>
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="card-header-terroso">
                    <h5 class="mb-0" style="font-size: 1.1rem; font-weight: 600;">
                        <i class="fas fa-search me-2"></i>Procesar Venta - Buscar Ticket
                    </h5>
                    <small style="opacity: 0.9;">
                        {% if apertura_activa %}
                            Caja: {{ apertura_activa.caja.nombre }}
                        {% else %}
                            No hay caja abierta
                        {% endif %}
                    </small>
                </div>

                <div class="card-body p-4">
                    <!-- Alerta de Caja Cerrada -->
                    {% if not apertura_activa %}
                    <div class="alert alert-danger" style="border-left: 4px solid #dc3545;">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>⚠️ No hay caja abierta
                        </h5>
                        <p class="mb-2">
                            <strong>No puedes procesar ventas sin una caja abierta.</strong>
                        </p>
                        <p class="mb-3">
                            Para procesar tickets, primero debes abrir una caja en "Gestión de Cajas".
                        </p>
                        <hr>
                        <a href="{% url 'caja:apertura_list' %}" class="btn btn-danger">
                            <i class="fas fa-cash-register me-2"></i>Ir a Gestión de Cajas
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Buscador de Ticket -->
                    <div class="alert alert-info-terroso mb-4"{% if not apertura_activa %} style="opacity: 0.5; pointer-events: none;"{% endif %}>
                        <h6><i class="fas fa-info-circle me-2"></i>Buscar Ticket por Número</h6>
                        <form method="post" class="mt-3">
                            {% csrf_token %}
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">
                                    <i class="fas fa-hashtag"></i>
                                </span>
                                <input type="text" name="numero_ticket" class="form-control" placeholder="Ingrese número de ticket (Ej: 000001)" autofocus required>
                                <button type="submit" class="btn btn-terroso" style="min-width: 150px;">
                                    <i class="fas fa-search me-2"></i>Buscar
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-lightbulb me-1"></i>
                                El sistema esperará el ingreso del número de ticket para procesarlo
                            </small>
                        </form>
                    </div>

                    <hr>

                    <!-- Tickets Pendientes del Día -->
                    <h6 class="mb-3">
                        <i class="fas fa-list me-2"></i>Tickets Pendientes del Día
                        <span class="badge badge-terroso ms-2">{{ tickets_pendientes.count }}</span>
                    </h6>

                    {% if tickets_pendientes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>N° Ticket</th>
                                    <th>Hora</th>
                                    <th>Tipo Doc.</th>
                                    <th>Cliente</th>
                                    <th>Vendedor</th>
                                    <th style="text-align: right;">Total</th>
                                    <th style="text-align: center;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in tickets_pendientes %}
                                <tr>
                                    <td>
                                        <span class="fw-bold text-terroso" style="font-size: 1.1rem;">
                                            #{{ ticket.numero_venta }}
                                        </span>
                                    </td>
                                    <td>{{ ticket.fecha_creacion|time:"H:i" }}</td>
                                    <td>
                                        {% if ticket.tipo_documento_planeado == 'factura' %}
                                            <span class="badge" style="background: #007bff; color: white; font-size: 0.75rem;">
                                                <i class="fas fa-file-invoice me-1"></i>Factura
                                            </span>
                                        {% elif ticket.tipo_documento_planeado == 'boleta' %}
                                            <span class="badge" style="background: #28a745; color: white; font-size: 0.75rem;">
                                                <i class="fas fa-receipt me-1"></i>Boleta
                                            </span>
                                        {% elif ticket.tipo_documento_planeado == 'guia' %}
                                            <span class="badge" style="background: #ffc107; color: #333; font-size: 0.75rem;">
                                                <i class="fas fa-truck me-1"></i>Guía
                                            </span>
                                        {% elif ticket.tipo_documento_planeado == 'cotizacion' %}
                                            <span class="badge" style="background: #17a2b8; color: white; font-size: 0.75rem;">
                                                <i class="fas fa-file-alt me-1"></i>Cotización
                                            </span>
                                        {% elif ticket.tipo_documento_planeado == 'vale' %}
                                            <span class="badge" style="background: #6c757d; color: white; font-size: 0.75rem;">
                                                <i class="fas fa-ticket-alt me-1"></i>Vale
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.75rem;">
                                                <i class="fas fa-question me-1"></i>{{ ticket.tipo_documento_planeado|default:"N/A" }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ ticket.cliente.nombre|default:"Sin cliente" }}</td>
                                    <td>{{ ticket.vendedor.nombre|default:"-" }}</td>
                                    <td style="text-align: right;">
                                        <span class="fw-bold text-terroso" style="font-size: 1.1rem;">
                                            ${{ ticket.total|format_price }}
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        {% if apertura_activa %}
                                            <a href="{% url 'caja:procesar_venta' ticket.pk %}" class="btn btn-terroso">
                                                <i class="fas fa-cash-register me-1"></i>Procesar
                                            </a>
                                        {% else %}
                                            <button class="btn btn-secondary" disabled title="Debes abrir una caja primero">
                                                <i class="fas fa-lock me-1"></i>Bloqueado
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay tickets pendientes del día</p>
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer" style="background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%); padding: 15px; border-top: 1px solid #D4C4A8;">
                    {% if apertura_activa %}
                        <a href="{% url 'caja:apertura_detail' apertura_activa.pk %}" class="btn btn-terroso-outline">
                            <i class="fas fa-arrow-left me-2"></i>Volver a Caja
                        </a>
                    {% else %}
                        <a href="{% url 'caja:apertura_list' %}" class="btn btn-terroso-outline">
                            <i class="fas fa-arrow-left me-2"></i>Volver a Lista de Cajas
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-focus en el campo de búsqueda al cargar
document.addEventListener('DOMContentLoaded', function() {
    const inputTicket = document.querySelector('[name="numero_ticket"]');
    if (inputTicket) {
        inputTicket.focus();
        inputTicket.select();
    }
});

// Permitir escaneo de código de barras
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const inputTicket = document.querySelector('[name="numero_ticket"]');
        if (inputTicket && inputTicket.value.length > 0) {
            inputTicket.closest('form').submit();
        }
    }
});
</script>
{% endblock %}

<!-- Modal de Apertura de Caja -->
{% if mostrar_modal_apertura %}
<div class="modal fade" id="modalAperturaCaja" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 1.5rem 2rem;">
                <h4 class="modal-title mb-0">
                    <i class="fas fa-lock-open me-2"></i>Abrir Caja
                </h4>
            </div>
            <div class="modal-body p-4">
                <!-- Alerta Informativa -->
                <div class="alert alert-info mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-left: 4px solid #2196F3;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-3 mt-1" style="font-size: 1.5rem; color: #1976D2;"></i>
                        <div>
                            <h6 class="mb-2" style="color: #1565C0; font-weight: 600;">Importante:</h6>
                            <p class="mb-0" style="color: #424242; line-height: 1.6;">
                                Al abrir la caja, se iniciará un nuevo turno. Asegúrate de contar el efectivo inicial correctamente. 
                                Este monto será la base para el cierre de caja al finalizar el turno.
                            </p>
                        </div>
                    </div>
                </div>
                
                <form method="post" action="{% url 'caja:apertura_create' %}" id="formAperturaCaja">
                    {% csrf_token %}
                    
                    <!-- Caja -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.caja.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-cash-register me-2" style="color: #28a745;"></i>Caja
                        </label>
                        {{ form_apertura.caja }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-check-circle me-1" style="color: #28a745;"></i>
                            Solo se muestran cajas activas sin apertura
                        </small>
                    </div>

                    <!-- Monto Inicial -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.monto_inicial.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-money-bill-wave me-2" style="color: #28a745;"></i>Monto Inicial
                        </label>
                        {{ form_apertura.monto_inicial }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-wallet me-1" style="color: #17a2b8;"></i>
                            Efectivo físico disponible al iniciar el turno
                        </small>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.observaciones_apertura.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-comment me-2" style="color: #28a745;"></i>Observaciones
                        </label>
                        {{ form_apertura.observaciones_apertura }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-pencil-alt me-1" style="color: #6c757d;"></i>
                            Opcional: Notas sobre el turno o condiciones especiales
                        </small>
                    </div>

                    <!-- Nota Final -->
                    <div class="alert alert-light mb-4" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-lightbulb me-3 mt-1" style="font-size: 1.3rem; color: #ffc107;"></i>
                            <div>
                                <strong style="color: #495057;">Recuerda:</strong>
                                <p class="mb-0 mt-1" style="color: #6c757d; font-size: 0.9rem; line-height: 1.5;">
                                    Una vez abierta la caja, podrás registrar movimientos, procesar ventas y cerrar al finalizar el turno.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" style="padding: 0.75rem; font-size: 1.1rem; font-weight: 600;">
                            <i class="fas fa-unlock me-2"></i>Abrir Caja y Comenzar Turno
                        </button>
                        <a href="{% url 'caja:apertura_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Mostrar modal automáticamente si no hay caja abierta
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalAperturaCaja'));
    modal.show();
});
</script>
{% endif %}







