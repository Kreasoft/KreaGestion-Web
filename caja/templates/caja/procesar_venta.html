{% extends "base.html" %}
{% load static %}
{% load articulo_filters %}
{% load l10n %}

{% block title %}Procesar Ticket - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
        min-height: 100vh;
    }

    .card-header-terroso {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        padding: 20px;
        border: none;
        font-family: 'Poppins', sans-serif;
    }

    .card-header-terroso-info {
        background: linear-gradient(135deg, #A0826D 0%, #8B7355 100%);
        color: white;
        padding: 20px;
        border: none;
        font-family: 'Poppins', sans-serif;
    }

    .btn-terroso {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        color: white;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    .btn-terroso:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.3);
        color: white;
    }

    .btn-terroso-outline {
        background: transparent;
        border: 2px solid #8B7355;
        color: #8B7355;
        font-weight: 500;
    }

    .btn-terroso-outline:hover {
        background: #8B7355;
        color: white;
    }

    .forma-pago-item {
        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
        border-left: 4px solid #8B7355 !important;
    }

    .alert-info-terroso {
        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
        border: 1px solid #D4C4A8;
        border-left: 4px solid #8B7355;
        color: #6F5B44;
    }

    .form-check-input:checked {
        background-color: #8B7355;
        border-color: #8B7355;
    }

    .text-terroso {
        color: #8B7355;
    }

    .text-terroso-dark {
        color: #6F5B44;
    }
</style>
{% endblock %}

{% block content %}
<!-- Banner superior -->
<div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #F5F1E8 0%, #E8DED5 100%); color: #6F5B44; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: 500; font-family: 'Poppins', sans-serif; z-index: 9999; border-bottom: 1px solid #D4C4A8;">
    Procesar Venta - Ticket #{{ ticket.numero_venta }}
</div>
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <!-- Informaci√≥n del Ticket -->
        <div class="col-md-6">
            <div class="card shadow-lg mb-4" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="card-header-terroso-info">
                    <h5 class="mb-0" style="font-size: 1.1rem; font-weight: 600;">
                        <i class="fas fa-receipt me-2"></i>Ticket #{{ ticket.numero_venta }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Cliente</small>
                            <p class="mb-0 fw-bold">{{ ticket.cliente.nombre|default:"Sin cliente" }}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Vendedor</small>
                            <p class="mb-0 fw-bold">{{ ticket.vendedor.nombre|default:"Sin vendedor" }}</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Fecha</small>
                            <p class="mb-0">{{ ticket.fecha_creacion|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Estaci√≥n</small>
                            <p class="mb-0">{{ ticket.estacion_trabajo.nombre|default:"-" }}</p>
                        </div>
                    </div>

                    <hr>

                    <h6 class="mb-3">Detalle de Art√≠culos</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Art√≠culo</th>
                                    <th style="text-align: center;">Cant.</th>
                                    <th style="text-align: right;">P. Unit.</th>
                                    <th style="text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles %}
                                <tr>
                                    <td>{{ detalle.articulo.nombre }}</td>
                                    <td style="text-align: center;">{{ detalle.cantidad }}</td>
                                    <td style="text-align: right;">${{ detalle.precio_unitario|format_price }}</td>
                                    <td style="text-align: right;">${{ detalle.precio_total|format_price }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">Neto (Base Imponible)</small>
                            <p class="mb-1 fw-bold">${{ ticket.neto|format_price }}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">IVA (19%)</small>
                            <p class="mb-1">${{ ticket.iva|format_price }}</p>
                        </div>
                        {% if ticket.impuesto_especifico and ticket.impuesto_especifico > 0 %}
                        <div class="col-6">
                            <small class="text-muted">Impuesto Espec√≠fico</small>
                            <p class="mb-1">${{ ticket.impuesto_especifico|format_price }}</p>
                        </div>
                        {% else %}
                        <!-- Debug: Impuesto espec√≠fico = {{ ticket.impuesto_especifico|default:"None" }} -->
                        {% endif %}
                        {% if ticket.descuento > 0 %}
                        <div class="col-6">
                            <small class="text-muted">Descuento</small>
                            <p class="mb-1 text-danger">-${{ ticket.descuento|format_price }}</p>
                        </div>
                        {% endif %}
                        <div class="col-12 mt-2">
                            <hr class="my-2">
                            <small class="text-muted">TOTAL A PAGAR</small>
                            <h3 class="text-terroso mb-0" style="font-weight: 700;">${{ ticket.total|format_price }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Procesamiento -->
        <div class="col-md-6">
            <div class="card shadow-lg" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="card-header-terroso">
                    <h5 class="mb-0" style="font-size: 1.1rem; font-weight: 600;">
                        <i class="fas fa-cash-register me-2"></i>Procesar Pago
                    </h5>
                    <small style="opacity: 0.9;">Caja: {{ apertura_activa.caja.nombre }}</small>
                </div>
                <div class="card-body">
                    <form method="post" id="formProcesar">
                        {% csrf_token %}
                        {{ form.ticket_id }}

                        <!-- Tipo de Documento -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-file-invoice me-2"></i>Tipo de Documento
                            </label>

                            <!-- Informaci√≥n de Facturaci√≥n Electr√≥nica -->
                            {% if empresa.facturacion_electronica %}
                                <div class="alert alert-info-terroso py-2 mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Facturaci√≥n Electr√≥nica Activa</strong>
                                            {% if disponibilidad_folios %}
                                                <br>
                                                {% for tipo, datos in disponibilidad_folios.items %}
                                                    {% if tipo in 'boleta,factura' %}
                                                        {% if datos.disponible %}
                                                            <span class="badge bg-success me-1">{{ tipo|title }}: {{ datos.folios_disponibles }} folios disponibles</span>
                                                        {% else %}
                                                            <span class="badge bg-danger me-1">{{ tipo|title }}: Sin folios disponibles</span>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                        <a href="{% url 'facturacion_electronica:caf_list' %}" class="btn btn-sm btn-outline-info" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> Ver CAF
                                        </a>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning py-2 mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Facturaci√≥n Electr√≥nica No Configurada</strong><br>
                                            <small>Configure la facturaci√≥n electr√≥nica en la empresa para generar documentos tributarios autom√°ticamente.</small>
                                        </div>
                                        <a href="{% url 'empresas:editar_empresa_activa' %}" class="btn btn-sm btn-outline-warning" target="_blank">
                                            <i class="fas fa-cog"></i> Configurar
                                        </a>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_documento" id="tipo_boleta" value="boleta" {% if tipo_documento_planeado == 'boleta' or tipo_documento_planeado == None %}checked{% endif %}>
                                        <label class="form-check-label" for="tipo_boleta">
                                            Boleta
                                            {% if empresa.facturacion_electronica and disponibilidad_folios.boleta.disponible %}
                                                {% if disponibilidad_folios.boleta.folios_disponibles <= 10 %}
                                                    <span class="badge bg-warning text-dark ms-1" title="Quedan pocos folios">‚ö†Ô∏è {{ disponibilidad_folios.boleta.folios_disponibles }}</span>
                                                {% else %}
                                                    <span class="badge bg-success ms-1" title="{{ disponibilidad_folios.boleta.folios_disponibles }} folios disponibles">‚úì</span>
                                                {% endif %}
                                            {% elif empresa.facturacion_electronica %}
                                                <span class="badge bg-danger ms-1" title="Sin folios disponibles">‚úó</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_documento" id="tipo_factura" value="factura" {% if tipo_documento_planeado == 'factura' %}checked{% endif %}>
                                        <label class="form-check-label" for="tipo_factura">
                                            Factura
                                            {% if empresa.facturacion_electronica and disponibilidad_folios.factura.disponible %}
                                                {% if disponibilidad_folios.factura.folios_disponibles <= 10 %}
                                                    <span class="badge bg-warning text-dark ms-1" title="Quedan pocos folios">‚ö†Ô∏è {{ disponibilidad_folios.factura.folios_disponibles }}</span>
                                                {% else %}
                                                    <span class="badge bg-success ms-1" title="{{ disponibilidad_folios.factura.folios_disponibles }} folios disponibles">‚úì</span>
                                                {% endif %}
                                            {% elif empresa.facturacion_electronica %}
                                                <span class="badge bg-danger ms-1" title="Sin folios disponibles">‚úó</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_documento" id="tipo_guia" value="guia" {% if ticket.tipo_documento_planeado == 'guia' %}checked{% endif %}>
                                        <label class="form-check-label" for="tipo_guia">
                                            Gu√≠a
                                            <span class="badge bg-secondary ms-1">Manual</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n adicional sobre documentos -->
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <strong>Boleta:</strong> Para ventas a personas naturales (consumidores finales)<br>
                                        <strong>Factura:</strong> Para empresas y ventas a cr√©dito<br>
                                        <strong>Gu√≠a:</strong> Para despachos de mercader√≠a
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Formas de Pago M√∫ltiples (ocultar si es gu√≠a) -->
                        <div class="mb-4" id="formas-pago-section">
                            <label class="form-label fw-bold">
                                <i class="fas fa-credit-card me-2"></i>Formas de Pago
                            </label>
                            
                            <div id="formas-pago-container">
                                <!-- Primera forma de pago (por defecto) -->
                                <div class="forma-pago-item mb-3 p-3" style="border-radius: 8px;">
                                    <div class="row align-items-end">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold" style="color: #8B7355; font-size: 1rem;">
                                                <i class="fas fa-hand-holding-usd me-2"></i>Forma de Pago *
                                            </label>
                                            <select class="form-select forma-pago-select" name="forma_pago_1" required 
                                                    style="border: 3px solid #8B7355; font-size: 1.1rem; font-weight: 600; padding: 12px; background: linear-gradient(135deg, #FFFFFF 0%, #F5F1E8 100%);">
                                                <option value="">Seleccione...</option>
                                                {% for fp in form.forma_pago.field.queryset %}
                                                <option value="{{ fp.id }}" data-requiere-cheque="{{ fp.requiere_cheque }}">{{ fp.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label fw-bold" style="color: #8B7355; font-size: 1rem;">
                                                <i class="fas fa-dollar-sign me-2"></i>Monto a Pagar *
                                            </label>
                                            <span class="d-block small text-muted mb-1">(Total: ${{ ticket.total|unlocalize }})</span>
                                            <input type="number" class="form-control monto-pago" name="monto_pago_1" step="1" min="0" placeholder="{{ ticket.total|unlocalize }}" value="{{ ticket.total|unlocalize }}" required
                                                   style="border: 3px solid #8B7355; font-size: 1.3rem; font-weight: 700; padding: 12px; text-align: right; background: linear-gradient(135deg, #FFFFFF 0%, #F5F1E8 100%);">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-sm btn-danger remove-pago" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Campos para cheque (ocultos inicialmente) -->
                                    <div class="campos-cheque mt-3" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label small">N√∫mero de Cheque</label>
                                                <input type="text" class="form-control" name="numero_cheque_1" placeholder="N√∫mero">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Banco</label>
                                                <input type="text" class="form-control" name="banco_1" placeholder="Banco">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Fecha</label>
                                                <input type="date" class="form-control" name="fecha_cheque_1">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Contenedor para formas de pago adicionales -->
                                    <div id="formas-adicionales-container"></div>
                                </div>
                            </div>

                            <!-- Bot√≥n para agregar otra forma de pago -->
                            <button type="button" class="btn btn-terroso-outline btn-sm" id="btn-agregar-pago">
                                <i class="fas fa-plus me-1"></i>Agregar Otra Forma de Pago
                            </button>

                            <!-- Resumen de pagos -->
                            <div class="mt-3 p-3" style="background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%); border-radius: 8px; border: 1px solid #D4C4A8;">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Total a Pagar:</small>
                                        <div class="fw-bold text-terroso" style="font-size: 1.2rem;">
                                            $<span id="total-venta">{{ ticket.total|format_price }}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Total Pagado:</small>
                                        <div class="fw-bold" style="font-size: 1.2rem;" id="total-pagado-display">
                                            $<span id="total-pagado">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2" id="diferencia-pago" style="display: none;">
                                    <small class="text-muted">Diferencia:</small>
                                    <div class="fw-bold" style="font-size: 1.1rem;" id="diferencia-display"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                <i class="fas fa-comment me-2"></i>Observaciones
                            </label>
                            {{ form.observaciones }}
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-terroso btn-lg" id="btn-procesar">
                                <i class="fas fa-check me-2"></i>Procesar Pago
                            </button>
                            <a href="{% url 'caja:procesar_venta_buscar' %}" class="btn btn-terroso-outline">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üîµ Script de procesar venta cargado');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üü¢ DOM Content Loaded - Inicializando...');
    
    const totalVenta = {{ ticket.total|unlocalize }};
    const tipoDocumentoPlaneado = '{{ tipo_documento_planeado|default:"" }}';
    const disponibilidadFolios = {{ disponibilidad_folios_json|safe }};
    console.log('üí∞ Total Venta:', totalVenta);
    console.log('üìã Tipo documento planeado RAW:', '{{ tipo_documento_planeado }}');
    console.log('üìã Tipo documento planeado VAR:', tipoDocumentoPlaneado);
    console.log('üìã Ticket tipo_documento:', '{{ ticket.tipo_documento }}');
    console.log('üìã Ticket tipo_documento_planeado:', '{{ ticket.tipo_documento_planeado }}');
    let contadorPagos = 1;
    let bloqueoFolios = false;
    
    // Verificar que el formulario existe
    const formulario = document.getElementById('formProcesar');
    console.log('üìã Formulario encontrado:', formulario ? 'S√ç' : 'NO');
    
    if (!formulario) {
        console.error('‚ùå ERROR: No se encontr√≥ el formulario con ID "formProcesar"');
        return;
    }
    
    // Funci√≥n para mostrar/ocultar formas de pago seg√∫n tipo de documento
    function mostrarAlertaFolios(tipoDoc, btnProcesar) {
        const nombres = {
            'boleta': 'Boleta Electr√≥nica',
            'factura': 'Factura Electr√≥nica',
            'guia': 'Gu√≠a de Despacho'
        };
        const nombreDoc = nombres[tipoDoc] || 'documento seleccionado';

        Swal.fire({
            icon: 'error',
            title: 'Sin folios disponibles',
            html: `No quedan folios CAF activos para <strong>${nombreDoc}</strong>.` +
                  '<br>Debe cargar nuevos folios antes de continuar.',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#dc3545'
        });

        if (btnProcesar) {
            btnProcesar.disabled = true;
            btnProcesar.classList.add('disabled');
        }
    }

    function verificarFoliosDisponibles(tipoDoc, btnProcesar) {
        bloqueoFolios = false;
        if (!tipoDoc) {
            if (btnProcesar) {
                btnProcesar.disabled = false;
                btnProcesar.classList.remove('disabled');
            }
            return;
        }

        const datos = disponibilidadFolios[tipoDoc];
        if (!datos || !datos.disponible || datos.folios_disponibles <= 0) {
            console.log('‚ùå Sin folios disponibles para', tipoDoc);
            bloqueoFolios = true;
            mostrarAlertaFolios(tipoDoc, btnProcesar);
        } else {
            console.log(`‚úÖ Folios disponibles para ${tipoDoc}:`, datos.folios_disponibles);
            if (btnProcesar) {
                btnProcesar.disabled = false;
                btnProcesar.classList.remove('disabled');
            }
        }
    }

    function toggleFormasPago() {
        // Usar el valor del ticket directamente
        const tipoDocTicket = '{{ ticket.tipo_documento_planeado|default:"" }}';
        const radioMarcado = document.querySelector('input[name="tipo_documento"]:checked');
        const tipoDoc = tipoDocTicket || (radioMarcado ? radioMarcado.value : null);
        const formasPagoSection = document.getElementById('formas-pago-section');
        const btnProcesar = document.getElementById('btn-procesar');

        console.log('üîç toggleFormasPago - Tipo ticket:', tipoDocTicket);
        console.log('üîç toggleFormasPago - Radio marcado:', radioMarcado ? radioMarcado.id : 'ninguno');
        console.log('üîç toggleFormasPago - Tipo documento FINAL:', tipoDoc);

        verificarFoliosDisponibles(tipoDoc, btnProcesar);

        if (tipoDoc === 'guia') {
            // Ocultar formas de pago para gu√≠as
            formasPagoSection.style.display = 'none';
            btnProcesar.innerHTML = '<i class="fas fa-truck me-2"></i>Generar Gu√≠a de Despacho';
            
            // Remover required de campos de pago
            formasPagoSection.querySelectorAll('select, input').forEach(field => {
                field.removeAttribute('required');
            });
            
            console.log('üì¶ Gu√≠a seleccionada - Formas de pago ocultas y campos no requeridos');
        } else {
            // Mostrar formas de pago para otros documentos
            formasPagoSection.style.display = 'block';
            btnProcesar.innerHTML = '<i class="fas fa-check me-2"></i>Procesar Pago';
            
            // Restaurar required en campos de pago
            formasPagoSection.querySelectorAll('.forma-pago-select').forEach(field => {
                field.setAttribute('required', 'required');
            });
            formasPagoSection.querySelectorAll('.monto-pago').forEach(field => {
                field.setAttribute('required', 'required');
            });
            
            console.log('üí≥ Documento con pago - Formas de pago visibles y campos requeridos');
        }
    }
    
    // Ejecutar cuando cambie el tipo de documento
    document.querySelectorAll('input[name="tipo_documento"]').forEach(radio => {
        radio.addEventListener('change', toggleFormasPago);
    });
    
    // FORZAR ejecuci√≥n m√∫ltiple para garantizar detecci√≥n
    toggleFormasPago();
    requestAnimationFrame(toggleFormasPago);
    setTimeout(toggleFormasPago, 0);
    setTimeout(toggleFormasPago, 50);
    setTimeout(toggleFormasPago, 100);
    setTimeout(toggleFormasPago, 200);
    setTimeout(toggleFormasPago, 300);
    
    // Configurar bot√≥n para gu√≠a DESPU√âS de todos los toggleFormasPago
    setTimeout(function() {
        const tipoDocTicket = '{{ ticket.tipo_documento_planeado|default:"" }}';
        console.log('üîç Valor de tipoDocTicket:', tipoDocTicket);
        console.log('üîç Es gu√≠a?', tipoDocTicket === 'guia');
        
        if (tipoDocTicket === 'guia') {
            console.log('üéØ CONFIGURANDO BOT√ìN PARA GU√çA');
            const btnProcesar = document.getElementById('btn-procesar');
            
            // Cambiar el bot√≥n a type="button" para evitar validaciones HTML5
            btnProcesar.type = 'button';
            
            // Agregar listener con capture para interceptar antes que otros
            btnProcesar.addEventListener('click', function(e) {
                console.log('üöÄ CLICK EN BOT√ìN GU√çA DETECTADO');
                e.preventDefault();
                e.stopPropagation();
                
                // Remover todos los required
                document.querySelectorAll('[required]').forEach(field => {
                    field.removeAttribute('required');
                });
                
                console.log('üöÄ Enviando formulario...');
                formulario.submit();
            }, true); // capture: true
            
            console.log('‚úÖ Listener agregado al bot√≥n');
        }
    }, 500); // Esperar 500ms para que terminen todos los toggleFormasPago
    
    // Preparar opciones de formas de pago
    const formasPagoOptions = [
        {% for fp in form.forma_pago.field.queryset %}
        {
            id: '{{ fp.id }}',
            nombre: '{{ fp.nombre|escapejs }}',
            requiereCheque: {% if fp.requiere_cheque %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Formatear n√∫meros con separador de miles
    function formatearNumero(numero) {
        return Math.round(numero).toLocaleString('es-CL');
    }
    
    // Calcular total pagado
    function calcularTotalPagado() {
        let total = 0;
        document.querySelectorAll('.monto-pago').forEach(input => {
            const valor = parseFloat(input.value) || 0;
            total += valor;
        });
        return total;
    }
    
    // Actualizar resumen de pagos
    function actualizarResumen() {
        const totalPagado = calcularTotalPagado();
        const diferencia = totalPagado - totalVenta;
        
        // Actualizar total pagado
        document.getElementById('total-pagado').textContent = formatearNumero(totalPagado);
        
        // Cambiar color seg√∫n si alcanza o no
        const displayPagado = document.getElementById('total-pagado-display');
        if (totalPagado >= totalVenta) {
            displayPagado.style.color = '#28a745'; // Verde
        } else {
            displayPagado.style.color = '#dc3545'; // Rojo
        }
        
        // Mostrar diferencia
        const divDiferencia = document.getElementById('diferencia-pago');
        const displayDiferencia = document.getElementById('diferencia-display');
        
        if (diferencia !== 0) {
            divDiferencia.style.display = 'block';
            if (diferencia > 0) {
                displayDiferencia.textContent = '+ $' + formatearNumero(diferencia);
                displayDiferencia.style.color = '#28a745';
                displayDiferencia.title = 'Cambio a entregar';
            } else {
                displayDiferencia.textContent = '- $' + formatearNumero(Math.abs(diferencia));
                displayDiferencia.style.color = '#dc3545';
                displayDiferencia.title = 'Falta por pagar';
            }
        } else {
            divDiferencia.style.display = 'none';
        }
    }
    
    // Manejar cambio en forma de pago (mostrar/ocultar campos de cheque)
    function setupFormaPagoChange(item) {
        const select = item.querySelector('.forma-pago-select');
        const camposCheque = item.querySelector('.campos-cheque');
        
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const requiereCheque = selectedOption.getAttribute('data-requiere-cheque') === 'True';
            
            if (requiereCheque) {
                camposCheque.style.display = 'block';
            } else {
                camposCheque.style.display = 'none';
            }
        });
    }
    
    // Manejar cambio en monto
    function setupMontoChange(input) {
        input.addEventListener('input', actualizarResumen);
    }
    
    // Configurar primera forma de pago
    const primerItem = document.querySelector('.forma-pago-item');
    setupFormaPagoChange(primerItem);
    setupMontoChange(primerItem.querySelector('.monto-pago'));
    
    // Agregar otra forma de pago
    document.getElementById('btn-agregar-pago').addEventListener('click', function() {
        console.log('Bot√≥n agregar forma de pago clickeado');
        contadorPagos++;
        const container = document.getElementById('formas-adicionales-container');
        
        if (!container) {
            console.error('No se encontr√≥ el contenedor formas-adicionales-container');
            return;
        }
        
        console.log('Contenedor encontrado:', container);
        
        // Generar opciones de formas de pago
        let optionsHTML = '<option value="">Seleccione...</option>';
        formasPagoOptions.forEach(fp => {
            optionsHTML += `<option value="${fp.id}" data-requiere-cheque="${fp.requiereCheque}">${fp.nombre}</option>`;
        });
        
        // Calcular monto restante
        const totalPagado = calcularTotalPagado();
        const montoRestante = totalVenta - totalPagado;
        const montoSugerido = montoRestante > 0 ? montoRestante.toFixed(0) : '0';
        
        const nuevoItem = document.createElement('div');
        nuevoItem.className = 'forma-pago-adicional mt-2 pt-2';
        nuevoItem.style.cssText = 'border-top: 1px dashed #D4C4A8;';
        nuevoItem.innerHTML = `
            <div class="row align-items-end">
                <div class="col-md-6">
                    <select class="form-select forma-pago-select" name="forma_pago_${contadorPagos}" required 
                            style="border: 3px solid #8B7355; font-size: 1.1rem; font-weight: 600; padding: 12px; background: linear-gradient(135deg, #FFFFFF 0%, #F5F1E8 100%);">
                        ${optionsHTML}
                    </select>
                </div>
                <div class="col-md-5">
                    <input type="number" class="form-control monto-pago" name="monto_pago_${contadorPagos}" step="1" min="0" 
                           placeholder="${montoSugerido}" value="${montoSugerido}" required
                           style="border: 3px solid #8B7355; font-size: 1.3rem; font-weight: 700; padding: 12px; background: linear-gradient(135deg, #FFFEF8 0%, #F5F1E8 100%); color: #6F5B44;">
                    <small class="text-muted">Saldo restante: $${formatearNumero(montoRestante)}</small>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-danger remove-pago" style="padding: 8px 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="campos-cheque mt-3" style="display: none;">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label small">N√∫mero de Cheque</label>
                        <input type="text" class="form-control" name="numero_cheque_${contadorPagos}" placeholder="N√∫mero">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Banco</label>
                        <input type="text" class="form-control" name="banco_${contadorPagos}" placeholder="Banco">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Fecha</label>
                        <input type="date" class="form-control" name="fecha_cheque_${contadorPagos}">
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(nuevoItem);
        
        // Configurar eventos del nuevo item
        setupFormaPagoChange(nuevoItem);
        setupMontoChange(nuevoItem.querySelector('.monto-pago'));
        
        // Configurar bot√≥n de eliminar
        nuevoItem.querySelector('.remove-pago').addEventListener('click', function() {
            nuevoItem.remove();
            actualizarResumen();
        });
        
        // Actualizar resumen con el nuevo monto
        actualizarResumen();
    });
    
    // Validar antes de enviar
    document.getElementById('formProcesar').addEventListener('submit', function(e) {
        console.log('=== SUBMIT DEL FORMULARIO ===');
        
        // Obtener tipo de documento del ticket
        const tipoDocTicket = '{{ ticket.tipo_documento_planeado|default:"" }}';
        console.log('‚úÖ Tipo documento del ticket:', tipoDocTicket);
        
        // Si el ticket tiene tipo_documento_planeado='guia', FORZAR que sea gu√≠a
        if (tipoDocTicket === 'guia') {
            if (bloqueoFolios) {
                e.preventDefault();
                mostrarAlertaFolios('guia', document.getElementById('btn-procesar'));
                return false;
            }

            console.log('‚úÖ GU√çA DETECTADA - Permitiendo env√≠o sin validaciones');
            // Asegurar que el radio de gu√≠a est√© marcado
            const radioGuia = document.getElementById('tipo_guia');
            if (radioGuia) {
                radioGuia.checked = true;
            }
            return true; // Permitir env√≠o inmediatamente
        }

        // Para otros tipos, validar normalmente
        const radioMarcado = document.querySelector('input[name="tipo_documento"]:checked');
        const tipoDocumento = radioMarcado ? radioMarcado.value : null;
        console.log('‚úÖ Tipo documento radio:', tipoDocumento);

        if (bloqueoFolios) {
            e.preventDefault();
            mostrarAlertaFolios(tipoDocumento, document.getElementById('btn-procesar'));
            return false;
        }
        
        const totalPagado = calcularTotalPagado();
        console.log('Total Venta:', totalVenta);
        console.log('Total Pagado:', totalPagado);

        // 1. Validaci√≥n de disponibilidad de folios para documentos electr√≥nicos
        {% if empresa.facturacion_electronica and disponibilidad_folios %}
        if (tipoDocumento && (tipoDocumento === 'boleta' || tipoDocumento === 'factura')) {
            const disponibilidad = disponibilidadFolios;
            const datosTipo = disponibilidad[tipoDocumento];

            if (!datosTipo || !datosTipo.disponible || datosTipo.folios_disponibles <= 0) {
                console.log('‚ùå Folios no disponibles para', tipoDocumento);
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Folios No Disponibles',
                    html: `No hay folios CAF disponibles para generar <strong>${tipoDocumento === 'boleta' ? 'Boletas' : 'Facturas'}</strong> electr√≥nicas.<br><br>
                           <small>Verifique que tenga CAF activos cargados en el sistema.</small>`,
                    confirmButtonColor: '#dc3545',
                    footer: '<a href="{% url "facturacion_electronica:caf_list" %}" target="_blank">Ver gesti√≥n de CAF</a>'
                });
                return false;
            } else {
                console.log(`‚úÖ Folios disponibles para ${tipoDocumento}: ${datosTipo.folios_disponibles}`);
            }
        }
        {% endif %}

        // 2. Validaci√≥n de monto pagado (solo para documentos con pago)
        // Permitir diferencia de hasta 1 peso por redondeo
        const diferencia = totalVenta - totalPagado;
        console.log('Diferencia:', diferencia);

        if (diferencia > 1) {
            console.log('‚ùå Monto insuficiente, previniendo submit');
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Monto Insuficiente',
                text: `El total pagado ($${formatearNumero(totalPagado)}) es menor al total de la venta ($${formatearNumero(totalVenta)})`,
                confirmButtonColor: '#dc3545'
            });
            return false;
        }

        console.log('‚úÖ Todas las validaciones OK, enviando formulario...');
        
        // Deshabilitar bot√≥n para evitar doble env√≠o
        const btnProcesar = document.getElementById('btn-procesar');
        btnProcesar.disabled = true;
        btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
        
        // Log de datos del formulario
        const formData = new FormData(e.target);
        console.log('Datos del formulario:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
    });

    // Auto-refresco del estado de CAF cada 30 segundos
    {% if empresa.facturacion_electronica %}
    function actualizarEstadoCAF() {
        fetch('{% url "caja:estado_caf_pos" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar badges de disponibilidad
                const badges = document.querySelectorAll('.badge');
                badges.forEach(badge => {
                    if (badge.textContent.includes('folios')) {
                        // Badge contiene n√∫mero de folios, actualizar si cambi√≥
                        const tipo = badge.closest('.form-check').querySelector('input').value;
                        const nuevosDatos = data.disponibilidad[tipo];
                        if (nuevosDatos) {
                            const nuevosFolios = nuevosDatos.folios_disponibles;
                            const textoActual = badge.textContent;
                            const nuevoTexto = textoActual.replace(/\d+/, nuevosFolios);
                            if (nuevoTexto !== textoActual) {
                                badge.textContent = nuevoTexto;
                                // Cambiar color si es necesario
                                if (nuevosFolios <= 10 && nuevosFolios > 0) {
                                    badge.className = 'badge bg-warning text-dark ms-1';
                                } else if (nuevosFolios > 10) {
                                    badge.className = 'badge bg-success ms-1';
                                } else {
                                    badge.className = 'badge bg-danger ms-1';
                                }
                            }
                        }
                    }
                });

                // Actualizar informaci√≥n de CAF en el alert
                const alertInfo = document.querySelector('.alert-info');
                if (alertInfo) {
                    const badgesEnAlert = alertInfo.querySelectorAll('.badge');
                    badgesEnAlert.forEach(badge => {
                        const tipo = badge.textContent.split(':')[0].toLowerCase().trim();
                        const nuevosDatos = data.disponibilidad[tipo];
                        if (nuevosDatos) {
                            const nuevosFolios = nuevosDatos.folios_disponibles;
                            badge.textContent = `${tipo}: ${nuevosFolios} folios`;
                            if (nuevosFolios <= 10 && nuevosFolios > 0) {
                                badge.className = 'badge bg-warning text-dark me-1';
                            } else if (nuevosFolios > 10) {
                                badge.className = 'badge bg-success me-1';
                            } else {
                                badge.className = 'badge bg-danger me-1';
                            }
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error actualizando estado CAF:', error);
        });
    }

    // Actualizar cada 30 segundos
    setInterval(actualizarEstadoCAF, 30000);

    // Actualizar inmediatamente al cargar
    setTimeout(actualizarEstadoCAF, 1000);
    {% endif %}
});
</script>
{% endblock %}

<!-- Modal de Apertura de Caja -->
{% if mostrar_modal_apertura %}
<div class="modal fade" id="modalAperturaCaja" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 1.5rem 2rem;">
                <h4 class="modal-title mb-0">
                    <i class="fas fa-lock-open me-2"></i>Abrir Caja
                </h4>
            </div>
            <div class="modal-body p-4">
                <!-- Alerta Informativa -->
                <div class="alert alert-info mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-left: 4px solid #2196F3;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-3 mt-1" style="font-size: 1.5rem; color: #1976D2;"></i>
                        <div>
                            <h6 class="mb-2" style="color: #1565C0; font-weight: 600;">Importante:</h6>
                            <p class="mb-0" style="color: #424242; line-height: 1.6;">
                                Al abrir la caja, se iniciar√° un nuevo turno. Aseg√∫rate de contar el efectivo inicial correctamente. 
                                Este monto ser√° la base para el cierre de caja al finalizar el turno.
                            </p>
                        </div>
                    </div>
                </div>
                
                <form method="post" action="{% url 'caja:apertura_create' %}" id="formAperturaCaja">
                    {% csrf_token %}
                    
                    <!-- Caja -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.caja.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-cash-register me-2" style="color: #28a745;"></i>Caja
                        </label>
                        {{ form_apertura.caja }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-check-circle me-1" style="color: #28a745;"></i>
                            Solo se muestran cajas activas sin apertura
                        </small>
                    </div>

                    <!-- Monto Inicial -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.monto_inicial.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-money-bill-wave me-2" style="color: #28a745;"></i>Monto Inicial
                        </label>
                        {{ form_apertura.monto_inicial }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-wallet me-1" style="color: #17a2b8;"></i>
                            Efectivo f√≠sico disponible al iniciar el turno
                        </small>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-4">
                        <label for="{{ form_apertura.observaciones_apertura.id_for_label }}" class="form-label fw-bold" style="font-size: 1rem; color: #2c3e50;">
                            <i class="fas fa-comment me-2" style="color: #28a745;"></i>Observaciones
                        </label>
                        {{ form_apertura.observaciones_apertura }}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-pencil-alt me-1" style="color: #6c757d;"></i>
                            Opcional: Notas sobre el turno o condiciones especiales
                        </small>
                    </div>

                    <!-- Nota Final -->
                    <div class="alert alert-light mb-4" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-lightbulb me-3 mt-1" style="font-size: 1.3rem; color: #ffc107;"></i>
                            <div>
                                <strong style="color: #495057;">Recuerda:</strong>
                                <p class="mb-0 mt-1" style="color: #6c757d; font-size: 0.9rem; line-height: 1.5;">
                                    Una vez abierta la caja, podr√°s registrar movimientos, procesar ventas y cerrar al finalizar el turno.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" style="padding: 0.75rem; font-size: 1.1rem; font-weight: 600;">
                            <i class="fas fa-unlock me-2"></i>Abrir Caja y Comenzar Turno
                        </button>
                        <a href="{% url 'caja:apertura_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Mostrar modal autom√°ticamente si no hay caja abierta
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalAperturaCaja'));
    modal.show();
});
</script>
{% endif %}

