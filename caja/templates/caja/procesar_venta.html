{% extends 'base.html' %}
{% load static %}
{% load format_filters %}
{% load l10n %}

{% block title %}Procesar Venta - {{ ticket.numero_venta }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --terroso-primary: #8B7355;
    --terroso-dark: #6F5B44;
    --terroso-light: #A0826D;
    --terroso-bg: #F5F1ED;
}

.procesar-container {
    max-width: 1400px;
    margin: 20px auto;
}

.card-terroso {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
}

.card-header-terroso {
    background: linear-gradient(135deg, var(--terroso-primary) 0%, var(--terroso-dark) 100%);
    color: white;
    border-radius: 12px 12px 0 0 !important;
    padding: 15px 20px;
}

.btn-terroso {
    background: linear-gradient(135deg, var(--terroso-primary) 0%, var(--terroso-dark) 100%);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-terroso:hover {
    background: linear-gradient(135deg, var(--terroso-dark) 0%, var(--terroso-primary) 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
    color: white;
}

.form-control, .form-select {
    border: 1px solid #D4A574;
    border-radius: 6px;
}

.form-control:focus, .form-select:focus {
    border-color: var(--terroso-primary);
    box-shadow: 0 0 0 0.2rem rgba(139, 115, 85, 0.25);
}

.badge-terroso {
    background: var(--terroso-primary);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 500;
}

.tipo-doc-option {
    border: 2px solid #D4A574;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.tipo-doc-option:hover {
    border-color: var(--terroso-primary);
    background: var(--terroso-bg);
}

.tipo-doc-option input[type="radio"] {
    display: none;
}

.tipo-doc-option input[type="radio"]:checked + label {
    color: var(--terroso-primary);
    font-weight: 600;
}

/* Destacar el contenedor cuando está seleccionado */
.tipo-doc-option.selected {
    border: 3px solid var(--terroso-primary);
    background: linear-gradient(135deg, #FFF8E7 0%, #FFE8C5 100%);
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
    transform: scale(1.05);
}

.tipo-doc-option.selected label {
    color: var(--terroso-primary);
    font-weight: 700;
}

.tipo-doc-option.selected i {
    color: var(--terroso-primary);
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.forma-pago-item {
    background: var(--terroso-bg);
    border: 1px solid #D4A574;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.resumen-box {
    background: linear-gradient(135deg, #F5F1ED 0%, #E8E0D5 100%);
    border-radius: 8px;
    padding: 20px;
    border: 2px solid var(--terroso-light);
}

.total-row {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--terroso-dark);
    padding: 10px 0;
    border-top: 2px solid var(--terroso-primary);
}

.compact-form-group {
    margin-bottom: 12px;
}

.compact-form-group label {
    font-weight: 500;
    color: var(--terroso-dark);
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<div class="procesar-container">
    {% if messages %}
    <div class="row mb-3">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{% if message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <div class="row">
        <!-- Columna Izquierda: Información del Ticket -->
        <div class="col-md-4">
            <div class="card card-terroso">
                <div class="card-header-terroso">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Ticket #{{ ticket.numero_venta }}</h5>
                </div>
                <div class="card-body">
                    <!-- Cliente -->
                    <div class="mb-3">
                        <small class="text-muted d-block">CLIENTE</small>
                        <strong>{{ ticket.cliente.nombre|default:"PÚBLICO GENERAL" }}</strong>
                        {% if ticket.cliente.rut %}
                        <br><small class="text-muted">RUT: {{ ticket.cliente.rut }}</small>
                        {% endif %}
                    </div>

                    <!-- Vendedor -->
                    {% if ticket.vendedor %}
                    <div class="mb-3">
                        <small class="text-muted d-block">VENDEDOR</small>
                        <strong>{{ ticket.vendedor.nombre }}</strong>
                    </div>
                    {% endif %}

                    <!-- Items del Ticket -->
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">ITEMS</small>
                        <div style="max-height: 350px; overflow-y: auto;">
                            {% for detalle in ticket.ventadetalle_set.all %}
                            <div class="d-flex justify-content-between align-items-center mb-1 pb-1" style="border-bottom: 1px solid #E8E0D5; font-size: 0.75rem;">
                                <div class="flex-grow-1" style="line-height: 1.2;">
                                    <div style="font-size: 0.75rem;">{{ detalle.articulo.nombre }}</div>
                                    <div class="text-muted" style="font-size: 0.65rem;">{{ detalle.cantidad }} x ${{ detalle.precio_unitario|floatformat:0 }}</div>
                                </div>
                                <strong class="text-end" style="font-size: 0.8rem;">${{ detalle.precio_total|floatformat:0 }}</strong>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="resumen-box">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong>${{ ticket.subtotal|floatformat:0 }}</strong>
                        </div>
                        {% if ticket.descuento > 0 %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Descuento:</span>
                            <strong class="text-danger">-${{ ticket.descuento|floatformat:0 }}</strong>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Neto:</span>
                            <strong>${{ ticket.neto|floatformat:0 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IVA (19%):</span>
                            <strong>${{ ticket.iva|floatformat:0 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between total-row">
                            <span>TOTAL:</span>
                            <span>${{ ticket.total|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Formulario de Procesamiento -->
        <div class="col-md-8">
            <form method="post" id="formProcesar" action="{% url 'caja:procesar_venta' ticket.id %}" novalidate>
                {% csrf_token %}
                <input type="hidden" name="ticket_id" value="{{ ticket.id }}">

                <div class="card card-terroso mb-3">
                    <div class="card-header-terroso">
                        <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Tipo de Documento</h5>
                    </div>
                    <div class="card-body">
                        {# CAJA SOLO MUESTRA EL TIPO DE DOCUMENTO - NO PERMITE CAMBIARLO #}
                        {# CRÍTICO: Campo oculto con el tipo de documento del vale #}
                        <input type="hidden" name="tipo_documento" id="tipo_documento_hidden" value="{{ ticket.tipo_documento_planeado|default:'boleta' }}">
                        <script>
                            // Asegurar que el campo oculto siempre tenga un valor válido
                            const tipoDocHidden = document.getElementById('tipo_documento_hidden');
                            if (tipoDocHidden && (!tipoDocHidden.value || tipoDocHidden.value === '')) {
                                tipoDocHidden.value = '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
                            }
                            console.log('[DEBUG] Campo oculto tipo_documento:', tipoDocHidden ? tipoDocHidden.value : 'NO ENCONTRADO');
                        </script>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="alert alert-info mb-0" style="background: #e7f3ff; border-left: 4px solid #007bff;">
                                    <div class="d-flex align-items-center">
                                        {% if ticket.tipo_documento_planeado == 'factura' %}
                                            <i class="fas fa-file-invoice fa-3x me-3" style="color: #28a745;"></i>
                                            <div>
                                                <h5 class="mb-1"><strong>Factura</strong></h5>
                                                <small class="text-muted">Tipo de documento definido desde el POS</small>
                                            </div>
                                        {% elif ticket.tipo_documento_planeado == 'guia' %}
                                            <i class="fas fa-truck fa-3x me-3" style="color: #ffc107;"></i>
                                            <div>
                                                <h5 class="mb-1"><strong>Guía de Despacho</strong></h5>
                                                <small class="text-muted">Tipo de documento definido desde el POS</small>
                                            </div>
                                        {% else %}
                                            <i class="fas fa-receipt fa-3x me-3" style="color: #007bff;"></i>
                                            <div>
                                                <h5 class="mb-1"><strong>Boleta</strong></h5>
                                                <small class="text-muted">Tipo de documento definido desde el POS</small>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% if disponibilidad_folios %}
                                        {% if ticket.tipo_documento_planeado == 'factura' and disponibilidad_folios.factura %}
                                            <div class="mt-2">
                                                <small><strong>Folios disponibles:</strong> {{ disponibilidad_folios.factura.folios_disponibles }}</small>
                                            </div>
                                        {% elif ticket.tipo_documento_planeado == 'guia' and disponibilidad_folios.guia %}
                                            <div class="mt-2">
                                                <small><strong>Folios disponibles:</strong> {{ disponibilidad_folios.guia.folios_disponibles }}</small>
                                            </div>
                                        {% elif disponibilidad_folios.boleta %}
                                            <div class="mt-2">
                                                <small><strong>Folios disponibles:</strong> {{ disponibilidad_folios.boleta.folios_disponibles }}</small>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendedor y Datos de Despacho -->
                <div class="card card-terroso mb-3">
                    <div class="card-header-terroso">
                        <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Vendedor{% if empresa.usa_sistema_despacho %} y Despacho{% endif %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Vendedor -->
                            <div class="col-md-{% if empresa.usa_sistema_despacho %}4{% else %}12{% endif %}">
                                <div class="compact-form-group">
                                    <label for="vendedor_id" class="form-label">Vendedor{% if not ticket.vendedor %} *{% endif %}</label>
                                    <select name="vendedor_id" id="vendedor_id" class="form-select" {% if not ticket.vendedor %}required{% endif %}>
                                        {% if ticket.vendedor %}
                                        <option value="{{ ticket.vendedor.id }}" selected>{{ ticket.vendedor.nombre }} - {{ ticket.vendedor.codigo }}</option>
                                        {% else %}
                                        <option value="">-- Seleccione un vendedor --</option>
                                        {% endif %}
                                        {% for vendedor in vendedores %}
                                        {% if not ticket.vendedor or vendedor.id != ticket.vendedor.id %}
                                        <option value="{{ vendedor.id }}">
                                            {{ vendedor.nombre }} - {{ vendedor.codigo }}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">{% if ticket.vendedor %}Vendedor del ticket (puede cambiar si es necesario){% else %}El vendedor responsable de esta venta{% endif %}</small>
                                </div>
                            </div>
                            
                            <!-- Datos de Despacho (si está activo el sistema de despacho) -->
                            {% if empresa.usa_sistema_despacho %}
                            <div class="col-md-4">
                                <div class="compact-form-group">
                                    <label for="vehiculo_id" class="form-label">Móvil/Vehículo <span id="vehiculo-required">*</span></label>
                                    <select name="vehiculo_id" id="vehiculo_id" class="form-select">
                                        <option value="">-- Seleccione un móvil --</option>
                                        {% for vehiculo in vehiculos %}
                                        <option value="{{ vehiculo.id }}" {% if ticket.vehiculo and ticket.vehiculo.id == vehiculo.id %}selected{% endif %}>
                                            [{{ vehiculo.patente }}]{% if vehiculo.descripcion and vehiculo.descripcion != 'Sin descripción' %} {{ vehiculo.descripcion }}{% endif %}{% if vehiculo.capacidad %} - {{ vehiculo.capacidad|floatformat:0 }}kg{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Vehículo asignado para el despacho (opcional para guías)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="compact-form-group">
                                    <label for="chofer_id" class="form-label">Chofer <span id="chofer-required">*</span></label>
                                    <select name="chofer_id" id="chofer_id" class="form-select">
                                        <option value="">-- Seleccione un chofer --</option>
                                        {% for chofer in choferes %}
                                        <option value="{{ chofer.id }}" {% if ticket.chofer and ticket.chofer.id == chofer.id %}selected{% endif %}>
                                            {{ chofer.nombre }} - {{ chofer.rut }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Chofer responsable del despacho (opcional para guías)</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% if empresa.usa_sistema_despacho %}
                        <div class="alert alert-info mt-2 mb-0" style="font-size: 0.85rem;">
                            <i class="fas fa-info-circle me-1"></i>
                            Estos datos se usarán para generar hojas de ruta y control de entregas
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if mostrar_formas_pago %}
                <div class="card card-terroso mb-3" id="formasPagoCard">
                    <div class="card-header-terroso">
                        <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Formas de Pago</h5>
                    </div>
                    <div class="card-body">
                        <div id="formas-pago-container">
                            <!-- Primera forma de pago por defecto -->
                            <div class="forma-pago-item">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-6">
                                        <label class="form-label mb-1">Forma de Pago</label>
                                        <select name="forma_pago_1" class="form-select form-select-sm">
                                            {% for fp in form.fields.forma_pago.queryset %}
                                            <option value="{{ fp.id }}" {% if fp.codigo == 'EF' or fp.nombre|upper == 'EFECTIVO' %}selected{% endif %}>{{ fp.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label mb-1">Monto</label>
                                        <input type="number" name="monto_pago_1" class="form-control form-control-sm monto-pago" 
                                               step="1" min="0" value="{{ ticket.total|unlocalize }}">
                                    </div>
                                    <div class="col-md-1 text-end">
                                        <button type="button" class="btn btn-sm btn-danger remove-pago" style="visibility: hidden;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btnAgregarPago">
                            <i class="fas fa-plus me-1"></i>Agregar Forma de Pago
                        </button>

                        <div class="resumen-box mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total a Pagar:</span>
                                <strong id="totalAPagar">${{ ticket.total|floatformat:0 }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Pagado:</span>
                                <strong id="totalPagado" class="text-success">$0</strong>
                            </div>
                            <div class="d-flex justify-content-between total-row">
                                <span>Diferencia:</span>
                                <span id="diferencia">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Modo Ticket/Vale Facturable:</strong> El pago se procesará en la caja cuando se emita el documento final.
                </div>
                {% endif %}

                <div class="card card-terroso mb-3">
                    <div class="card-body">
                        <div class="compact-form-group">
                            <label for="observaciones">Observaciones (Opcional)</label>
                            <textarea name="observaciones" id="observaciones" class="form-control" rows="2" 
                                      placeholder="Ingrese observaciones adicionales..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'caja:procesar_venta_buscar' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-terroso btn-lg" id="btnProcesar">
                        <i class="fas fa-check me-2"></i>Procesar Venta
                    </button>
                    <div id="loadingIndicator" style="display: none; margin-top: 10px;">
                        <div class="spinner-border text-terroso" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <span class="ms-2">Procesando venta...</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript MÍNIMO - Solo para cálculos de totales
const totalVenta = {{ ticket.total|unlocalize }};
let contadorFormasPago = 1;

// DEBUGGING: Listener de submit
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formProcesar');
    const btn = document.getElementById('btnProcesar');
    
    console.log('[DEBUG] Formulario:', form);
    console.log('[DEBUG] Boton:', btn);
    console.log('[DEBUG] Boton type:', btn.type);
    console.log('[DEBUG] Boton disabled:', btn.disabled);
    
    // Verificar que el botón existe antes de agregar listener
    if (!btn) {
        console.error('[ERROR] Botón btnProcesar no encontrado!');
        return;
    }
    
    if (!form) {
        console.error('[ERROR] Formulario formProcesar no encontrado!');
        return;
    }
    
    console.log('[OK] Formulario y botón encontrados correctamente');
    
    // Función para actualizar required según tipo de documento
    function actualizarRequiredDespacho() {
        const tipoDoc = document.querySelector('input[name="tipo_documento"]:checked');
        const vehiculoSelect = document.getElementById('vehiculo_id');
        const choferSelect = document.getElementById('chofer_id');
        const vehiculoLabel = document.getElementById('vehiculo-required');
        const choferLabel = document.getElementById('chofer-required');
        
        // Actualizar visualización destacada de tipo de documento
        document.querySelectorAll('.tipo-doc-option').forEach(option => {
            option.classList.remove('selected');
        });
        if (tipoDoc) {
            const selectedOption = tipoDoc.closest('.tipo-doc-option');
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }
        
        if (vehiculoSelect && choferSelect) {
            // Solo required para facturas, opcional para guías y boletas
            if (tipoDoc && tipoDoc.value === 'factura') {
                vehiculoSelect.required = true;
                choferSelect.required = true;
                if (vehiculoLabel) vehiculoLabel.style.display = 'inline';
                if (choferLabel) choferLabel.style.display = 'inline';
            } else {
                vehiculoSelect.required = false;
                choferSelect.required = false;
                if (vehiculoLabel) vehiculoLabel.style.display = 'none';
                if (choferLabel) choferLabel.style.display = 'none';
            }
        }
    }
    
    // Ejecutar al cargar
    actualizarRequiredDespacho();
    
    // Actualizar cuando cambie el tipo de documento
    document.querySelectorAll('input[name="tipo_documento"]').forEach(radio => {
        radio.addEventListener('change', actualizarRequiredDespacho);
    });
    
    // Cargar chofer automáticamente cuando se selecciona un vehículo
    const vehiculoSelect = document.getElementById('vehiculo_id');
    const choferSelect = document.getElementById('chofer_id');
    
    if (vehiculoSelect && choferSelect) {
        vehiculoSelect.addEventListener('change', function() {
            const vehiculoId = this.value;
            if (vehiculoId) {
                // Hacer llamada AJAX para obtener el chofer del vehículo
                fetch(`/pedidos/ajax/vehiculo/${vehiculoId}/chofer/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.chofer_id) {
                            // Establecer el chofer solo si el campo está vacío o si el usuario no ha seleccionado uno manualmente
                            if (!choferSelect.value || choferSelect.value === '') {
                                choferSelect.value = data.chofer_id;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar chofer del vehículo:', error);
                    });
            }
        });
    }
    
    // Registrar listener del submit ANTES de cualquier otra cosa
    console.log('[DEBUG] Registrando listener de submit...');
    
    form.addEventListener('submit', function(e) {
        console.log('[SUBMIT] ========== SUBMIT DISPARADO ==========');
        console.log('[SUBMIT] Event:', e);
        console.log('[SUBMIT] Form action:', this.action);
        console.log('[SUBMIT] Form method:', this.method);
        console.log('[SUBMIT] Default prevented:', e.defaultPrevented);
        
        // Validar que haya un tipo de documento
        // CRÍTICO: Como ahora el tipo viene del vale (solo lectura), usar el campo oculto o el tipo_documento_planeado
        let tipoDoc = document.querySelector('input[name="tipo_documento"]:checked');
        let tipoDocValue = null;
        
        if (tipoDoc) {
            // Modo antiguo: radio button seleccionado
            tipoDocValue = tipoDoc.value;
            console.log('[DEBUG] Tipo documento seleccionado (radio):', tipoDocValue);
        } else {
            // Modo nuevo: campo oculto (solo lectura)
            tipoDoc = document.getElementById('tipo_documento_hidden') || document.querySelector('input[name="tipo_documento"][type="hidden"]');
            if (tipoDoc && tipoDoc.value) {
                tipoDocValue = tipoDoc.value;
                console.log('[DEBUG] Usando campo oculto tipo_documento:', tipoDocValue);
            } else {
                // Fallback: usar el tipo_documento_planeado del ticket
                tipoDocValue = '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
                console.log('[DEBUG] Usando tipo_documento_planeado del ticket (fallback):', tipoDocValue);
            }
        }
        
        // Validar que tengamos un tipo válido
        if (!tipoDocValue || tipoDocValue === '') {
            console.log('[ERROR] No hay tipo de documento definido');
            e.preventDefault();
            alert('Error: No se pudo determinar el tipo de documento del vale. Por favor, contacte al administrador.');
            return false;
        }
        
        console.log('[DEBUG] Tipo documento final:', tipoDocValue);
        console.log('[DEBUG] mostrar_formas_pago:', {% if mostrar_formas_pago %}true{% else %}false{% endif %});
        
        // Validar formas de pago SOLO si están habilitadas y NO es guía
        {% if mostrar_formas_pago %}
        if (tipoDocValue !== 'guia') {
            const montos = document.querySelectorAll('.monto-pago');
            console.log('[DEBUG] Montos encontrados:', montos.length);
            let totalPagado = 0;
            montos.forEach(input => {
                const valor = parseFloat(input.value) || 0;
                totalPagado += valor;
                console.log('[DEBUG] Monto:', valor);
            });
            
            console.log('[DEBUG] Total venta:', totalVenta);
            console.log('[DEBUG] Total pagado:', totalPagado);
            
            if (totalPagado < totalVenta) {
                console.log('[ERROR] Total pagado insuficiente');
                e.preventDefault();
                alert(`Falta pago. Total: $${Math.round(totalVenta).toLocaleString('es-CL')}, Pagado: $${Math.round(totalPagado).toLocaleString('es-CL')}`);
                return false;
            }
        }
        {% else %}
        // Modo ticket/vale facturable - No se validan formas de pago
        console.log('[INFO] Modo ticket/vale facturable - No se validan formas de pago');
        {% endif %}
        
        console.log('[OK] Validaciones OK - Enviando formulario...');
        
        // Mostrar indicador de carga
        const loadingIndicator = document.getElementById('loadingIndicator');
        const btnProcesar = document.getElementById('btnProcesar');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }
        if (btnProcesar) {
            btnProcesar.disabled = true;
            btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
        }
        
        // NO prevenir el envío - permitir que el formulario se envíe normalmente
        // El formulario se enviará automáticamente después de pasar las validaciones
        console.log('[OK] Validaciones completadas - El formulario se enviará normalmente');
        console.log('[DEBUG] Formulario action:', this.action || 'current URL');
        console.log('[DEBUG] Formulario method:', this.method);
        console.log('[DEBUG] NO se está previniendo el envío - El formulario debería enviarse ahora');
        
        // Asegurar que NO se previene el envío
        // NO llamar e.preventDefault() ni return false
        // El formulario se enviará automáticamente
        // NO retornar false - permitir que el submit continúe
    });
    
    console.log('[OK] Listener de submit registrado');
    
    // Agregar listener directo al botón como respaldo
    btn.addEventListener('click', function(e) {
        console.log('[CLICK] Botón clickeado directamente');
        
        // Validar tipo de documento antes de enviar
        // CRÍTICO: Como ahora el tipo viene del vale (solo lectura), usar el campo oculto o el tipo_documento_planeado
        let tipoDoc = document.querySelector('input[name="tipo_documento"]:checked');
        let tipoDocValue = null;
        
        if (tipoDoc) {
            // Modo antiguo: radio button seleccionado
            tipoDocValue = tipoDoc.value;
            console.log('[CLICK] Tipo documento seleccionado (radio):', tipoDocValue);
        } else {
            // Modo nuevo: campo oculto (solo lectura)
            tipoDoc = document.getElementById('tipo_documento_hidden') || document.querySelector('input[name="tipo_documento"][type="hidden"]');
            if (tipoDoc && tipoDoc.value) {
                tipoDocValue = tipoDoc.value;
                console.log('[CLICK] Usando campo oculto tipo_documento:', tipoDocValue);
            } else {
                // Fallback: usar el tipo_documento_planeado del ticket
                tipoDocValue = '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
                console.log('[CLICK] Usando tipo_documento_planeado del ticket (fallback):', tipoDocValue);
            }
        }
        
        // Validar que tengamos un tipo válido
        if (!tipoDocValue || tipoDocValue === '') {
            e.preventDefault();
            alert('Error: No se pudo determinar el tipo de documento del vale. Por favor, contacte al administrador.');
            return false;
        }
        
        // Si el botón es type="submit", el formulario se enviará automáticamente
        // Solo necesitamos asegurarnos de que las validaciones pasen
        console.log('[CLICK] Tipo documento válido:', tipoDocValue, '- El formulario se enviará');
    });
    
    console.log('[OK] Botón configurado como type="submit" - El formulario se enviará automáticamente al hacer clic');
});

// Actualizar resumen de pagos (solo si existe el contenedor)
function actualizarResumen() {
    {% if mostrar_formas_pago %}
    const montos = document.querySelectorAll('.monto-pago');
    let totalPagado = 0;
    
    montos.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        totalPagado += valor;
    });
    
    const diferencia = totalVenta - totalPagado;
    
    const totalPagadoEl = document.getElementById('totalPagado');
    const diferenciaEl = document.getElementById('diferencia');
    
    if (totalPagadoEl) {
        totalPagadoEl.textContent = '$' + Math.round(totalPagado).toLocaleString('es-CL');
    }
    if (diferenciaEl) {
        diferenciaEl.textContent = '$' + Math.round(diferencia).toLocaleString('es-CL');
        diferenciaEl.style.color = diferencia <= 0 ? '#28a745' : '#dc3545';
    }
    {% else %}
    // No hay formas de pago - no actualizar resumen
    console.log('[INFO] No hay formas de pago - No se actualiza resumen');
    {% endif %}
}

// Agregar forma de pago (solo si existe el botón)
{% if mostrar_formas_pago %}
const btnAgregarPago = document.getElementById('btnAgregarPago');
if (btnAgregarPago) {
    btnAgregarPago.addEventListener('click', function() {
        contadorFormasPago++;
        const container = document.getElementById('formas-pago-container');
        const nuevaFila = document.createElement('div');
        nuevaFila.className = 'forma-pago-item';
        nuevaFila.innerHTML = `
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label mb-1">Forma de Pago</label>
                    <select name="forma_pago_${contadorFormasPago}" class="form-select form-select-sm">
                        {% for fp in form.fields.forma_pago.queryset %}
                        <option value="{{ fp.id }}" {% if fp.codigo == 'EF' or fp.nombre|upper == 'EFECTIVO' %}selected{% endif %}>{{ fp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label mb-1">Monto</label>
                    <input type="number" name="monto_pago_${contadorFormasPago}" class="form-control form-control-sm monto-pago" 
                           step="1" min="0" value="0">
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-sm btn-danger remove-pago">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(nuevaFila);
        
        // Event listener para eliminar
        nuevaFila.querySelector('.remove-pago').addEventListener('click', function() {
            nuevaFila.remove();
            actualizarResumen();
        });
        
        // Event listener para actualizar totales
        nuevaFila.querySelector('.monto-pago').addEventListener('input', actualizarResumen);
        
        actualizarResumen();
    });
}
{% endif %}

// Listeners iniciales (solo si hay formas de pago)
{% if mostrar_formas_pago %}
document.querySelectorAll('.monto-pago').forEach(input => {
    input.addEventListener('input', actualizarResumen);
});
{% endif %}

// Mostrar/ocultar formas de pago según tipo de documento (solo si están habilitadas)
{% if mostrar_formas_pago %}
// CRÍTICO: Como ahora el tipo de documento viene del vale (solo lectura),
// debemos verificar el tipo_documento_planeado del ticket
const tipoDocPlaneado = '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
const card = document.getElementById('formasPagoCard');

if (card) {
    // Las guías NO tienen formas de pago
    if (tipoDocPlaneado === 'guia') {
        card.style.display = 'none';
        console.log('[INFO] Guía de despacho - Ocultando formas de pago');
    } else {
        // Facturas y boletas SÍ tienen formas de pago
        card.style.display = 'block';
        console.log('[INFO] Tipo documento:', tipoDocPlaneado, '- Mostrando formas de pago');
    }
}

// Si hay radio buttons (modo antiguo), mantener compatibilidad
document.querySelectorAll('input[name="tipo_documento"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const card = document.getElementById('formasPagoCard');
        if (card) {
            if (this.value === 'guia') {
                card.style.display = 'none';
            } else {
                card.style.display = 'block';
            }
        }
    });
});

// Inicializar
actualizarResumen();
{% else %}
// Modo ticket/vale facturable sin tipo definido - No mostrar formas de pago
console.log('[INFO] Modo ticket/vale facturable - Formas de pago deshabilitadas');
{% endif %}
</script>

<!-- Modal de Confirmación de Despacho -->
{% include 'facturacion_electronica/modal_confirmacion_despacho.html' %}

{% endblock %}

