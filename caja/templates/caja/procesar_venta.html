{% extends 'base.html' %}
{% load static %}
{% load format_filters %}
{% load l10n %}

{% block title %}Procesar Venta - {{ ticket.numero_venta }}{% endblock %}

{% block extra_css %}
<style>
    /* VARIABLES ESTILO PIEDRA - PROCESAR VENTA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
    }

    body {
        background-color: var(--stone-bg) !important;
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: white;
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(139, 115, 85, 0.08);
        overflow: hidden;
        margin-top: 1.5rem;
        margin-bottom: 2rem;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-icon-box {
        width: 48px; height: 48px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.25rem;
    }

    .header-text h1 {
        color: var(--stone-text); font-size: 1.35rem; margin: 0; letter-spacing: -0.5px; line-height: 1.1;
    }
    .header-text p {
        color: #795548; font-size: 0.85rem; margin: 0; font-weight: 500; opacity: 0.9;
    }

    .btn-back { background: rgba(255,255,255,0.6); border: 1px solid #D4C4A8; color: var(--stone-secondary); transition: all 0.2s; }
    .btn-back:hover { background: white; color: var(--stone-primary); }

    /* BOTONES ACCION */
    .btn-action-primary {
         background: var(--stone-primary); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 10px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center;
    }
    .btn-action-primary:hover { background: var(--stone-secondary); color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2); }

    .btn-action-secondary {
         background: #f8f9fa; border: 1px solid #dee2e6; color: #495057; padding: 0.6rem 1.5rem; border-radius: 10px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center;
    }
    .btn-action-secondary:hover { background: #e9ecef; }
    
    /* CARDS INFO */
    .stone-card-info {
        background: white; border: 1px solid #E8DCC8; border-radius: 12px; padding: 0; margin-bottom: 1.5rem; overflow: hidden; height: 100%;
    }
    .stone-card-header {
        background: #F4F2EE; border-bottom: 1px solid #E8DCC8; padding: 0.75rem 1.25rem; font-weight: 600; color: var(--stone-text); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center;
    }
    .stone-card-body { padding: 1.25rem; }

    /* RESUMEN BOX PREMIUM */
    .resumen-box-premium {
        background: #F4F2EE; border: 1px solid var(--stone-light); border-radius: 12px; padding: 1.25rem;
    }
    .resumen-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #795548; }
    .resumen-row strong { color: var(--stone-text); }
    .resumen-total { border-top: 2px solid var(--stone-light); padding-top: 0.75rem; margin-top: 0.75rem; }
    .resumen-total .total-label { font-size: 1rem; font-weight: 700; color: var(--stone-secondary); }
    .resumen-total .total-value { font-size: 1.25rem; font-weight: 800; color: var(--stone-secondary); }

    /* FORMAS DE PAGO ITEMS */
    .forma-pago-item-stone {
        background: #FAFAF8; border: 1px solid #E8DCC8; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem;
    }

    /* FORM STYLES */
    .form-control-stone {
        border: 1px solid #D4C4A8; border-radius: 8px; padding: 0.6rem 0.75rem; font-size: 0.9rem; background-color: #fff; transition: all 0.2s;
    }
    .form-control-stone:focus {
        border-color: var(--stone-primary); box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1); outline: none;
    }
    .form-label-stone {
        font-size: 0.8rem; font-weight: 700; color: #795548; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;
    }

    /* Ocultar top-bar original */
    .top-bar { display: none !important; }
    .main-content { margin-top: 0 !important; }

    /* TICKET ITEMS LIST */
    .ticket-item-row {
        padding: 0.5rem 0; border-bottom: 1px solid #F5F1E8; display: flex; justify-content: space-between; align-items: flex-start;
    }
    .ticket-item-name { font-size: 0.85rem; font-weight: 600; color: var(--stone-text); line-height: 1.2; }
    .ticket-item-subtext { font-size: 0.75rem; color: #8d6e63; }
    .ticket-item-total { font-weight: 700; color: var(--stone-secondary); font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="single-card-container">
        
        <!-- HEADER -->
        <div class="stone-header-premium">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-box">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <div class="header-text">
                    <h1>Procesar <span class="fw-bold">Cobro</span></h1>
                    <p>Ticket #{{ ticket.numero_venta }} | {{ ticket.cliente.nombre|default:"Consumidor Final" }}</p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'caja:procesar_venta_buscar' %}" class="btn btn-back btn-sm fw-bold px-3 py-2">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>
            </div>
        </div>

        <div class="card-body p-4">
            
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show border-0 rounded-3 shadow-sm" role="alert">
                    <i class="fas fa-info-circle me-2"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="row g-4">
                
                <!-- COLUMNA IZQUIERDA: RESUMEN TICKET -->
                <div class="col-md-4">
                    <div class="stone-card-info">
                        <div class="stone-card-header">
                            <span><i class="fas fa-receipt me-2"></i>Detalle del Ticket</span>
                        </div>
                        <div class="stone-card-body">
                            <!-- Datos Entidad -->
                            <div class="mb-4">
                                <span class="form-label-stone d-block">Cliente</span>
                                <div class="fw-bold text-dark">{{ ticket.cliente.nombre|default:"PÚBLICO GENERAL" }}</div>
                                {% if ticket.cliente.rut %}<div class="small text-muted">RUT: {{ ticket.cliente.rut }}</div>{% endif %}
                            </div>

                            {% if ticket.vendedor %}
                            <div class="mb-4">
                                <span class="form-label-stone d-block">Vendedor</span>
                                <div class="fw-bold text-dark">{{ ticket.vendedor.nombre }}</div>
                            </div>
                            {% endif %}

                            <!-- Items List -->
                            <span class="form-label-stone d-block mb-2">Artículos</span>
                            <div class="mb-4" style="max-height: 300px; overflow-y: auto; border: 1px solid #F5F1E8; border-radius: 8px; padding: 0 0.75rem;">
                                {% for detalle in ticket.ventadetalle_set.all %}
                                <div class="ticket-item-row {% if forloop.last %}border-0{% endif %}">
                                    <div>
                                        <div class="ticket-item-name">{{ detalle.articulo.nombre }}</div>
                                        <div class="ticket-item-subtext">{{ detalle.cantidad }} x ${{ detalle.precio_unitario|floatformat:0|format_precio }}</div>
                                    </div>
                                    <div class="ticket-item-total">${{ detalle.precio_total|floatformat:0|format_precio }}</div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Totales -->
                            <div class="resumen-box-premium">
                                <div class="resumen-row">
                                    <span>Subtotal:</span>
                                    <strong>${{ ticket.subtotal|floatformat:0|format_precio }}</strong>
                                </div>
                                {% if ticket.descuento > 0 %}
                                <div class="resumen-row">
                                    <span>Descuento:</span>
                                    <strong class="text-danger">-${{ ticket.descuento|floatformat:0|format_precio }}</strong>
                                </div>
                                {% endif %}
                                <div class="resumen-row">
                                    <span>Neto:</span>
                                    <strong>${{ ticket.neto|floatformat:0|format_precio }}</strong>
                                </div>
                                <div class="resumen-row">
                                    <span>IVA (19%):</span>
                                    <strong>${{ ticket.iva|floatformat:0|format_precio }}</strong>
                                </div>
                                <div class="resumen-total d-flex justify-content-between align-items-center">
                                    <span class="total-label text-uppercase">Total</span>
                                    <span class="total-value">${{ ticket.total|floatformat:0|format_precio }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: PROCESAMIENTO -->
                <div class="col-md-8">
                    <form method="post" id="formProcesar" action="{% url 'caja:procesar_venta' ticket.id %}" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        <input type="hidden" name="origen" value="caja">

                        <!-- TIPO DE DOCUMENTO -->
                        <div class="stone-card-info">
                            <div class="stone-card-header">
                                <span><i class="fas fa-file-invoice me-2"></i>Comprobante Electrónico</span>
                            </div>
                            <div class="stone-card-body">
                                <input type="hidden" name="tipo_documento" id="tipo_documento_hidden" value="{{ ticket.tipo_documento_planeado|default:'boleta' }}">
                                
                                <div class="p-3 border rounded-3 bg-light d-flex align-items-center gap-4">
                                    {% if ticket.tipo_documento_planeado == 'factura' %}
                                        <div class="header-icon-box" style="width: 60px; height: 60px; background: #E6FFFA; color: #2C7A7B;">
                                            <i class="fas fa-file-invoice fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 text-dark fw-bold">Factura de Venta</h5>
                                            <p class="mb-0 small text-muted">Documento tributario seleccionado desde el punto de venta.</p>
                                        </div>
                                    {% elif ticket.tipo_documento_planeado == 'guia' %}
                                        <div class="header-icon-box" style="width: 60px; height: 60px; background: #FFFFF0; color: #D69E2E;">
                                            <i class="fas fa-truck fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 text-dark fw-bold">Guía de Despacho</h5>
                                            <p class="mb-0 small text-muted">Acompaña el traslado de mercadería sin pago inmediato.</p>
                                        </div>
                                    {% elif ticket.tipo_documento_planeado == 'vale' %}
                                        <div class="header-icon-box" style="width: 60px; height: 60px; background: #E2E8F0; color: #4A5568;">
                                            <i class="fas fa-file-contract fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 text-dark fw-bold">Vale Interno</h5>
                                            <p class="mb-0 small text-muted">Documento interno de venta. No genera documento tributario.</p>
                                        </div>
                                    {% else %}
                                        <div class="header-icon-box" style="width: 60px; height: 60px; background: #EBF8FF; color: #2B6CB0;">
                                            <i class="fas fa-receipt fa-2x"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 text-dark fw-bold">Boleta Electrónica</h5>
                                            <p class="mb-0 small text-muted">Comprobante estándar para consumidores finales.</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                {% if disponibilidad_folios %}
                                <div class="mt-3 p-2 px-3 bg-white border rounded-pill d-inline-flex align-items-center small">
                                    <i class="fas fa-hashtag me-2 text-stone"></i>
                                    <span class="text-muted me-2">Folios Disponibles:</span>
                                    {% if ticket.tipo_documento_planeado == 'factura' %}
                                        <span class="fw-bold text-dark">{{ disponibilidad_folios.factura.folios_disponibles }}</span>
                                    {% elif ticket.tipo_documento_planeado == 'guia' %}
                                        <span class="fw-bold text-dark">{{ disponibilidad_folios.guia.folios_disponibles }}</span>
                                    {% elif ticket.tipo_documento_planeado == 'vale' %}
                                        <span class="fw-bold text-dark">INTERNO</span>
                                    {% else %}
                                        <span class="fw-bold text-dark">{{ disponibilidad_folios.boleta.folios_disponibles }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- VENDEDOR Y DESPACHO -->
                        <div class="stone-card-info">
                            <div class="stone-card-header">
                                <span><i class="fas fa-user-tie me-2"></i>Información Adicional</span>
                            </div>
                            <div class="stone-card-body">
                                <div class="row g-3">
                                    <div class="col-md-{% if empresa.usa_sistema_despacho %}4{% else %}12{% endif %}">
                                        <span class="form-label-stone d-block">Vendedor</span>
                                        <select name="vendedor_id" id="vendedor_id" class="form-select form-control-stone" {% if not ticket.vendedor %}required{% endif %}>
                                            {% if ticket.vendedor %}
                                            <option value="{{ ticket.vendedor.id }}" selected>{{ ticket.vendedor.nombre }} - {{ ticket.vendedor.codigo }}</option>
                                            {% else %}
                                            <option value="">-- Seleccionar --</option>
                                            {% endif %}
                                            {% for vendedor in vendedores %}
                                            {% if not ticket.vendedor or vendedor.id != ticket.vendedor.id %}
                                            <option value="{{ vendedor.id }}">{{ vendedor.nombre }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    {% if empresa.usa_sistema_despacho %}
                                    <div class="col-md-4">
                                        <span class="form-label-stone d-block">Móvil/Vehículo <span id="vehiculo-required">*</span></span>
                                        <select name="vehiculo_id" id="vehiculo_id" class="form-select form-control-stone">
                                            <option value="">-- Seleccionar --</option>
                                            {% for v in vehiculos %}<option value="{{ v.id }}" {% if ticket.vehiculo.id == v.id %}selected{% endif %}>[{{ v.patente }}] {{ v.descripcion }}</option>{% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="form-label-stone d-block">Chofer <span id="chofer-required">*</span></span>
                                        <select name="chofer_id" id="chofer_id" class="form-select form-control-stone">
                                            <option value="">-- Seleccionar --</option>
                                            {% for c in choferes %}<option value="{{ c.id }}" {% if ticket.chofer.id == c.id %}selected{% endif %}>{{ c.nombre }}</option>{% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- FORMAS DE PAGO -->
                        {% if mostrar_formas_pago %}
                        <div class="stone-card-info" id="formasPagoCard">
                            <div class="stone-card-header">
                                <span><i class="fas fa-credit-card me-2"></i>Formas de Pago</span>
                            </div>
                            <div class="stone-card-body">
                                <div id="formas-pago-container">
                                    <div class="forma-pago-item-stone">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-6">
                                                <span class="form-label-stone d-block">Método de Pago</span>
                                                <select name="forma_pago_1" class="form-select form-control-stone">
                                                    {% for fp in form.fields.forma_pago.queryset %}
                                                    <option value="{{ fp.id }}" {% if fp.codigo == 'EF' or fp.nombre|upper == 'EFECTIVO' %}selected{% endif %}>{{ fp.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-5">
                                                <span class="form-label-stone d-block">Monto</span>
                                                <input type="number" name="monto_pago_1" class="form-control form-control-stone monto-pago" step="1" min="0" value="{{ ticket.total|unlocalize }}">
                                            </div>
                                            <div class="col-md-1 text-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-pago border-0" style="visibility: hidden;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-sm btn-action-secondary py-2 mt-2" id="btnAgregarPago">
                                    <i class="fas fa-plus me-2"></i>Agregar Método
                                </button>

                                <div class="mt-4 p-3 rounded-3" style="background: #F4F2EE; border: 1px solid var(--stone-light);">
                                    <div class="d-flex justify-content-between mb-2 small text-muted text-uppercase fw-bold">
                                        <span>Total Cobro:</span>
                                        <strong id="totalAPagar" class="text-dark">${{ ticket.total|floatformat:0|format_precio }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2 small text-muted text-uppercase fw-bold">
                                        <span>Total Ingresado:</span>
                                        <strong id="totalPagado" class="text-success">$0</strong>
                                    </div>
                                    <div class="d-flex justify-content-between pt-2 border-top">
                                        <span class="fw-bold text-dark">DIFERENCIA:</span>
                                        <span id="diferencia" class="fw-bold fs-5">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- OBSERVACIONES -->
                        <div class="stone-card-info">
                            <div class="stone-card-body">
                                <span class="form-label-stone d-block mb-1">Observaciones</span>
                                <textarea name="observaciones" id="observaciones" class="form-control form-control-stone" rows="2" placeholder="Notas internas para este cobro..."></textarea>
                            </div>
                        </div>

                        <!-- ACCIONES FINALES -->
                        <div class="d-flex gap-3 justify-content-end mt-4">
                            <a href="{% url 'caja:procesar_venta_buscar' %}" class="btn btn-action-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-action-primary px-5" id="btnProcesar">
                                <i class="fas fa-check-circle me-2"></i>FINALIZAR COBRO
                            </button>
                        </div>
                        
                        <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-stone spinner-border-sm" role="status"></div>
                            <span class="ms-2 small text-muted">Procesando firma electrónica y cobro...</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript MÍNIMO - Solo para cálculos de totales
const totalVenta = parseFloat("{{ ticket.total|unlocalize|default:'0' }}".replace(',', '.'));
let contadorFormasPago = 1;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formProcesar');
    const btn = document.getElementById('btnProcesar');
    
    // Función para actualizar required según tipo de documento
    function actualizarRequiredDespacho() {
        const tipoDocHidden = document.getElementById('tipo_documento_hidden');
        const tipoDocValue = tipoDocHidden ? tipoDocHidden.value : '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
        
        const vehiculoSelect = document.getElementById('vehiculo_id');
        const choferSelect = document.getElementById('chofer_id');
        const vehiculoLabel = document.getElementById('vehiculo-required');
        const choferLabel = document.getElementById('chofer-required');
        
        if (vehiculoSelect && choferSelect) {
            // Solo required para facturas, opcional para guías y boletas
            if (tipoDocValue === 'factura') {
                vehiculoSelect.required = true;
                choferSelect.required = true;
                if (vehiculoLabel) vehiculoLabel.style.display = 'inline';
                if (choferLabel) choferLabel.style.display = 'inline';
            } else {
                vehiculoSelect.required = false;
                choferSelect.required = false;
                if (vehiculoLabel) vehiculoLabel.style.display = 'none';
                if (choferLabel) choferLabel.style.display = 'none';
            }
        }
    }
    
    actualizarRequiredDespacho();
    
    // Cargar chofer automáticamente cuando se selecciona un vehículo
    const vehiculoSelect = document.getElementById('vehiculo_id');
    const choferSelect = document.getElementById('chofer_id');
    
    if (vehiculoSelect && choferSelect) {
        vehiculoSelect.addEventListener('change', function() {
            const vehiculoId = this.value;
            if (vehiculoId) {
                fetch(`/pedidos/ajax/vehiculo/${vehiculoId}/chofer/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.chofer_id) {
                            if (!choferSelect.value || choferSelect.value === '') {
                                choferSelect.value = data.chofer_id;
                            }
                        }
                    })
                    .catch(error => console.error('Error al cargar chofer:', error));
            }
        });
    }
    
    if (form) {
        form.addEventListener('submit', function(e) {
            const tipoDocHidden = document.getElementById('tipo_documento_hidden');
            const tipoDocValue = tipoDocHidden ? tipoDocHidden.value : '{{ ticket.tipo_documento_planeado|default:"boleta" }}';
            
            {% if mostrar_formas_pago %}
            if (tipoDocValue !== 'guia') {
                const montos = document.querySelectorAll('.monto-pago');
                let totalPagado = 0;
                montos.forEach(input => {
                    totalPagado += parseFloat(input.value) || 0;
                });
                
                if (totalPagado < totalVenta - 0.1) {
                    e.preventDefault();
                    alert(`Falta pago. Total: $${Math.round(totalVenta).toLocaleString('es-CL')}, Pagado: $${Math.round(totalPagado).toLocaleString('es-CL')}`);
                    return false;
                }
            }
            {% endif %}
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            const btnProcesar = document.getElementById('btnProcesar');
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (btnProcesar) {
                btnProcesar.disabled = true;
                btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>PROCESANDO...';
            }
        });
    }
});

function actualizarResumen() {
    {% if mostrar_formas_pago %}
    const montos = document.querySelectorAll('.monto-pago');
    let totalPagado = 0;
    montos.forEach(input => {
        totalPagado += parseFloat(input.value) || 0;
    });
    
    const diferencia = totalVenta - totalPagado;
    const totalPagadoEl = document.getElementById('totalPagado');
    const diferenciaEl = document.getElementById('diferencia');
    
    if (totalPagadoEl) totalPagadoEl.textContent = '$' + Math.round(totalPagado).toLocaleString('es-CL');
    if (diferenciaEl) {
        diferenciaEl.textContent = '$' + Math.round(diferencia).toLocaleString('es-CL');
        diferenciaEl.style.color = diferencia <= 0.1 ? '#28a745' : '#dc3545';
        if (diferencia <= 0.1) diferenciaEl.textContent = 'PAGADO';
    }
    {% endif %}
}

{% if mostrar_formas_pago %}
const btnAgregarPago = document.getElementById('btnAgregarPago');
if (btnAgregarPago) {
    btnAgregarPago.addEventListener('click', function() {
        contadorFormasPago++;
        const container = document.getElementById('formas-pago-container');
        const nuevaFila = document.createElement('div');
        nuevaFila.className = 'forma-pago-item-stone';
        nuevaFila.innerHTML = `
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <span class="form-label-stone d-block">Método de Pago</span>
                    <select name="forma_pago_${contadorFormasPago}" class="form-select form-control-stone">
                        {% for fp in form.fields.forma_pago.queryset %}
                        <option value="{{ fp.id }}" {% if fp.codigo == 'EF' or fp.nombre|upper == 'EFECTIVO' %}selected{% endif %}>{{ fp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <span class="form-label-stone d-block">Monto</span>
                    <input type="number" name="monto_pago_${contadorFormasPago}" class="form-control form-control-stone monto-pago" step="1" min="0" value="0">
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-pago border-0">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(nuevaFila);
        nuevaFila.querySelector('.remove-pago').addEventListener('click', () => { nuevaFila.remove(); actualizarResumen(); });
        nuevaFila.querySelector('.monto-pago').addEventListener('input', actualizarResumen);
        actualizarResumen();
    });
}
document.querySelectorAll('.monto-pago').forEach(input => input.addEventListener('input', actualizarResumen));
actualizarResumen();
{% endif %}

{% if es_pos_vale %}
setTimeout(() => { window.location.href = '{% url "ventas:pos_view" %}'; }, 2000);
{% endif %}
</script>

<!-- Modal de Confirmación de Despacho -->
{% include 'facturacion_electronica/modal_confirmacion_despacho.html' %}

{% endblock %}

