{% extends "base.html" %}
{% load static %}
{% load articulo_filters %}

{% block title %}Detalle de Caja - {{ apertura.caja.nombre }} - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    /* VARIABLES ESTILO PIEDRA */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
        --stone-card-bg: #FFFFFF;
    }

    body {
        background-color: var(--stone-bg) !important;
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: var(--stone-card-bg);
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(139, 115, 85, 0.08);
        overflow: hidden;
        margin-top: 1.5rem;
        margin-bottom: 2rem;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-icon-box {
        width: 48px; height: 48px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.25rem;
    }

    .header-text h1 {
        color: var(--stone-text); font-size: 1.35rem; margin: 0; letter-spacing: -0.5px; line-height: 1.1;
    }
    .header-text p {
        color: #795548; font-size: 0.85rem; margin: 0; font-weight: 500; opacity: 0.9;
    }

    /* BOTONES */
    .btn-action-primary { 
        background: var(--stone-primary); color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; 
        display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none;
    }
    .btn-action-primary:hover { background: var(--stone-secondary); color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2); }
    
    .btn-action-danger { 
        background: #e53935; color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; 
        display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none;
    }
    .btn-action-danger:hover { background: #c62828; color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(229, 57, 53, 0.2); }

    .btn-back { background: rgba(255,255,255,0.6); border: 1px solid #D4C4A8; color: var(--stone-secondary); transition: all 0.2s; border-radius: 8px; font-weight: 600; padding: 0.4rem 1rem; text-decoration: none;}
    .btn-back:hover { background: white; color: var(--stone-primary); }

    /* INFO CARDS & STATS */
    .stone-card-info {
        background: white; border: 1px solid #E8DCC8; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden;
    }
    .stone-card-header {
        background: #FDFCFB; border-bottom: 1px solid #E8DCC8; padding: 0.8rem 1.2rem;
        font-weight: 600; color: var(--stone-text); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center;
    }
    .stone-card-body { padding: 1.2rem; }

    .stat-grid-item {
        background: #FAFAF8; border: 1px solid #E8DCC8; border-radius: 10px; padding: 12px; text-align: center; transition: all 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center;
    }
    .stat-grid-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(139, 115, 85, 0.1); background: white; }
    .stat-grid-icon { font-size: 1.5rem; color: var(--stone-primary); margin-bottom: 6px; }
    .stat-grid-label { font-size: 0.7rem; color: #8D6E63; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .stat-grid-value { font-size: 1.1rem; color: var(--stone-text); font-weight: 700; margin: 0; }

    .total-highlight {
        background: var(--stone-primary); color: white; border-radius: 10px; padding: 1rem; text-align: center; margin-top: 1rem;
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.25);
    }

    /* TABLA PIEDRA DETALLE */
    .table-responsive { border-radius: 0 0 8px 8px; }
    .table-piedra { width: 100%; border-collapse: separate; border-spacing: 0; }
    .table-piedra thead th {
        background: #FDFCFB; border-bottom: 2px solid #E8DCC8; color: #8B7355; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 10px 12px;
    }
    .table-piedra tbody tr { transition: all 0.2s; }
    .table-piedra tbody tr:hover { background-color: #F8F6F2; }
    .table-piedra tbody td { 
        padding: 8px 12px; vertical-align: middle; font-size: 0.85rem; color: #4A5568; 
        border-bottom: 1px solid #F0EAE0;
    }

    /* BADGES */
    .badge-stone { padding: 0.35em 0.8em; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.3px; }
    .badge-stone-success { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    .badge-stone-danger { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
    .badge-stone-primary { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; }
    .badge-stone-warning { background: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
    .badge-stone-info { background: #E0F7FA; color: #006064; border: 1px solid #B2EBF2; }

    /* MODAL */
    .modal-content-stone { border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
    .modal-header-stone { background: var(--stone-gradient); padding: 1.25rem; border-bottom: 1px solid #E8DCC8; }
    .modal-header-stone .modal-title { color: var(--stone-text); font-weight: 700; font-size: 1.1rem; }
    
    .form-control-stone, .form-select-stone {
        border-radius: 8px; border: 1px solid #D4C4A8; padding: 0.6rem 0.8rem; font-size: 0.9rem; background-color: #FAFAF8; width: 100%; color: var(--stone-text);
    }
    .form-control-stone:focus, .form-select-stone:focus {
        border-color: var(--stone-primary); box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1); outline: none; background: white;
    }
    .form-label-stone { font-size: 0.85rem; font-weight: 600; color: #6F5B44; margin-bottom: 0.3rem; }

    .top-bar { display: none !important; }
    .main-content { margin-top: 0 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Mensajes -->
    {% if messages %}
        <div class="messages mb-3 mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert" style="border-radius: 12px; border: none; border-left: 5px solid {% if message.tags == 'error' or message.tags == 'danger' %}#dc3545{% elif message.tags == 'warning' %}#ffc107{% elif message.tags == 'success' %}#28a745{% else %}#007bff{% endif %};">
                    <i class="fas {% if message.tags == 'error' or message.tags == 'danger' %}fa-times-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="single-card-container">
        <!-- HEADER -->
        <div class="stone-header-premium">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-box">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div class="header-text">
                    <h1>Detalle de <span class="fw-bold">Apertura</span></h1>
                    <p>{{ apertura.caja.nombre }} - Caja #{{ apertura.caja.numero }}</p>
                </div>
                <div class="ms-3">
                    {% if apertura.estado == 'abierta' %}
                        <span class="badge badge-stone badge-stone-success"><i class="fas fa-unlock me-1"></i> ABIERTA</span>
                    {% else %}
                        <span class="badge badge-stone badge-stone-secondary"><i class="fas fa-lock me-1"></i> CERRADA</span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'caja:apertura_list' %}" class="btn btn-back">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>
                {% if apertura.estado == 'abierta' %}
                <a href="{% url 'caja:apertura_cerrar' apertura.pk %}" class="btn btn-action-danger">
                    <i class="fas fa-lock me-2"></i> Cerrar Caja
                </a>
                {% else %}
                <a href="{% url 'caja:apertura_imprimir' apertura.pk %}" class="btn btn-action-primary" target="_blank">
                    <i class="fas fa-print me-2"></i> Imprimir Informe
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card-body p-4">
            
            <div class="row g-4">
                
                <!-- COLUMNA IZQUIERDA: INFO Y TOTALES -->
                <div class="col-lg-4">
                    
                    <!-- Información del Turno -->
                    <div class="stone-card-info">
                        <div class="stone-card-header">
                            <span><i class="fas fa-user-clock me-2"></i>Datos del Turno</span>
                        </div>
                        <div class="p-0">
                            <table class="table table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td class="px-3 py-2 text-muted border-bottom small">Fecha Apertura</td>
                                        <td class="px-3 py-2 text-end fw-bold border-bottom small">{{ apertura.fecha_apertura|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-3 py-2 text-muted border-bottom small">Usuario</td>
                                        <td class="px-3 py-2 text-end fw-bold border-bottom small">{{ apertura.usuario_apertura.username }}</td>
                                    </tr>
                                    {% if apertura.estado == 'cerrada' %}
                                    <tr>
                                        <td class="px-3 py-2 text-muted border-bottom small">Fecha Cierre</td>
                                        <td class="px-3 py-2 text-end fw-bold border-bottom small">{{ apertura.fecha_cierre|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-3 py-2 text-muted border-bottom small">Usuario Cierre</td>
                                        <td class="px-3 py-2 text-end fw-bold border-bottom small">{{ apertura.usuario_cierre.username }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if apertura.observaciones_apertura %}
                                    <tr>
                                        <td colspan="2" class="px-3 py-2 bg-light small fst-italic text-muted border-bottom">
                                            <i class="fas fa-comment me-1"></i> "{{ apertura.observaciones_apertura }}"
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Resumen Financiero -->
                    <div class="stone-card-info">
                        <div class="stone-card-header">
                            <span><i class="fas fa-wallet me-2"></i>Balance Financiero</span>
                        </div>
                        <div class="stone-card-body pt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="stat-grid-item">
                                        <div class="stat-grid-icon"><i class="fas fa-money-bill-alt"></i></div>
                                        <div class="stat-grid-label">Inicial</div>
                                        <div class="stat-grid-value">${{ apertura.monto_inicial|format_price }}</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-grid-item">
                                        <div class="stat-grid-icon"><i class="fas fa-cash-register"></i></div>
                                        <div class="stat-grid-label">Efec. Ventas</div>
                                        <div class="stat-grid-value">${{ apertura.total_ventas_efectivo|format_price }}</div>
                                    </div>
                                </div>
                                <!-- Otros medios de pago -->
                                <div class="col-4">
                                    <div class="stat-grid-item py-2">
                                        <div class="stat-grid-label" style="font-size: 0.65rem;">Tarjeta</div>
                                        <div class="fw-bold small">${{ apertura.total_ventas_tarjeta|format_price }}</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-grid-item py-2">
                                        <div class="stat-grid-label" style="font-size: 0.65rem;">Transf.</div>
                                        <div class="fw-bold small">${{ apertura.total_ventas_transferencia|format_price }}</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-grid-item py-2">
                                        <div class="stat-grid-label" style="font-size: 0.65rem;">Otros</div>
                                        <div class="fw-bold small">${{ apertura.total_ventas_cheque|add:apertura.total_ventas_credito|format_price }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="total-highlight">
                                <div class="small opacity-75 text-uppercase fw-bold mb-1">Efectivo Final (Teórico)</div>
                                <div class="h3 mb-0 fw-bold">${{ apertura.monto_final|format_price }}</div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- BOTÓN ACCIÓN RÁPIDA -->
                    {% if apertura.estado == 'abierta' %}
                    <div class="d-grid">
                        <button type="button" class="btn btn-action-primary justify-content-center py-3" data-bs-toggle="modal" data-bs-target="#modalMovimiento">
                            <i class="fas fa-plus-circle me-2"></i> Registrar Movimiento Extra
                        </button>
                        <div class="form-text text-center mt-2 small">Ingresos de cambio, retiros parciales, etc.</div>
                    </div>
                    {% endif %}

                </div>

                <!-- COLUMNA DERECHA: TABLAS -->
                <div class="col-lg-8">
                    
                    <!-- MOVIMIENTOS -->
                    <div class="stone-card-info">
                        <div class="stone-card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exchange-alt me-2 text-muted"></i>
                                <span>Movimientos de Caja</span>
                                <span class="badge bg-light text-dark border ms-2">{{ movimientos.count }}</span>
                            </div>
                        </div>
                        
                        {% if movimientos %}
                        <div class="table-responsive">
                            <table class="table-piedra">
                                <thead>
                                    <tr>
                                        <th width="15%">Hora</th>
                                        <th width="15%">Tipo</th>
                                        <th width="45%">Descripción</th>
                                        <th width="10%">Usuario</th>
                                        <th width="15%" class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mov in movimientos %}
                                    <tr>
                                        <td>{{ mov.fecha|date:"H:i" }}</td>
                                        <td>
                                            {% if mov.tipo == 'venta' %}
                                                <span class="badge badge-stone badge-stone-success"><i class="fas fa-shopping-cart me-1"></i> Venta</span>
                                            {% elif mov.tipo == 'retiro' %}
                                                <span class="badge badge-stone badge-stone-danger"><i class="fas fa-arrow-up me-1"></i> Retiro</span>
                                            {% elif mov.tipo == 'ingreso' %}
                                                <span class="badge badge-stone badge-stone-primary"><i class="fas fa-arrow-down me-1"></i> Ingreso</span>
                                            {% else %}
                                                <span class="badge badge-stone badge-stone-warning"><i class="fas fa-undo me-1"></i> Devol.</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="d-inline-block text-truncate" style="max-width: 250px;" title="{{ mov.descripcion }}">
                                                {{ mov.descripcion }}
                                            </span>
                                        </td>
                                        <td><small class="text-muted">{{ mov.usuario.username }}</small></td>
                                        <td class="text-end fw-bold">
                                            {% if mov.tipo == 'retiro' or mov.tipo == 'devolucion' %}
                                                <span class="text-danger">-${{ mov.monto|format_price }}</span>
                                            {% else %}
                                                <span class="text-success">+${{ mov.monto|format_price }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-exchange-alt fa-2x text-muted opacity-25 mb-2"></i>
                            <p class="text-muted small fw-bold">Sin movimientos registrados aún</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PENDIENTES (Solo si abierta) -->
                    {% if apertura.estado == 'abierta' and tickets_pendientes %}
                    <div class="stone-card-info mb-0">
                         <div class="stone-card-header bg-warning bg-opacity-10">
                            <div class="d-flex align-items-center text-dark">
                                <i class="fas fa-clock me-2"></i>
                                <span>Cola de Tickets Pendientes</span>
                                <span class="badge bg-warning text-dark ms-2">{{ tickets_pendientes.count }}</span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table-piedra">
                                <thead>
                                    <tr>
                                        <th>Ticket</th>
                                        <th>Tipo</th>
                                        <th>Cliente</th>
                                        <th>Hora</th>
                                        <th class="text-end">Monto</th>
                                        <th class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticket in tickets_pendientes %}
                                    <tr>
                                        <td class="fw-bold">#{{ ticket.numero_venta }}</td>
                                        <td>
                                            {% if ticket.tipo_documento_planeado == 'factura' %}
                                                <span class="badge badge-stone badge-stone-info">Factura</span>
                                            {% elif ticket.tipo_documento_planeado == 'boleta' %}
                                                <span class="badge badge-stone badge-stone-primary">Boleta</span>
                                            {% elif ticket.tipo_documento_planeado == 'vale' %}
                                                <span class="badge badge-stone badge-stone-secondary">Vale</span>
                                            {% else %}
                                                <span class="badge badge-stone badge-stone-warning">Otro</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ ticket.cliente.nombre|truncatechars:20 }}</td>
                                        <td>{{ ticket.fecha_creacion|date:"H:i" }}</td>
                                        <td class="text-end fw-bold">${{ ticket.total|format_price }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'caja:procesar_venta' ticket.pk %}?next={% url 'caja:apertura_detail' apertura.pk %}" class="btn btn-sm btn-action-primary py-1 px-2" style="font-size: 0.75rem;">
                                                Procesar <i class="fas fa-chevron-right ms-1"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Movimiento -->
<div class="modal fade" id="modalMovimiento" tabindex="-1" aria-labelledby="modalMovimientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-stone">
            <div class="modal-header modal-header-stone">
                <h5 class="modal-title" id="modalMovimientoLabel">
                    <i class="fas fa-exchange-alt me-2"></i>Registrar Movimiento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'caja:movimiento_create' apertura.pk %}">
                {% csrf_token %}
                <div class="modal-body p-4 bg-light bg-opacity-10">
                    
                    <div class="mb-3">
                        <label class="form-label-stone">Tipo de Movimiento</label>
                        <select name="tipo" class="form-select-stone" required>
                            <option value="">Seleccione...</option>
                            <option value="ingreso">Ingreso de Dinero (Carga)</option>
                            <option value="retiro">Retiro de Dinero (Gasto/Depósito)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-stone">Monto</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0" style="border-color: #D4C4A8; color: #8B7355;">$</span>
                            <input type="number" name="monto" class="form-control-stone border-start-0 ps-0" step="1" min="0" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-stone">Descripción</label>
                        <textarea name="descripcion" class="form-control-stone" rows="3" required minlength="5" placeholder="Motivo del movimiento..."></textarea>
                    </div>

                </div>
                <div class="modal-footer border-top-0 p-3 pt-0 bg-light bg-opacity-10">
                    <button type="button" class="btn btn-back" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-action-primary">
                        <i class="fas fa-save me-2"></i>Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
