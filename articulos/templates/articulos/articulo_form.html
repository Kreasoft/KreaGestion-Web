{% extends "base.html" %}

{% block body_class %}hide-top-bar{% endblock %}
{% load widget_tweaks %}
{% load humanize %}
{% load articulo_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- Mensajes de Django -->
{% if messages %}
    <div class="container-fluid mt-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<style>
/* Estilos Piedra Premium Formulario */
.articulo-card {
    border-radius: 20px;
    overflow: hidden;
    border: 1px solid var(--color-piedra-borde) !important;
    box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
}

.articulo-header {
    background: var(--gradient-piedra);
    border-bottom: 3px solid var(--color-piedra-borde);
    padding: 20px 30px;
}

.nav-tabs-piedra {
    border-bottom: 1px solid var(--color-piedra-borde);
    background:rgba(215, 204, 200, 0.1);
    padding: 0 20px;
    display: flex;
    gap: 5px;
}

.nav-tabs-piedra .nav-link {
    border: none;
    color: #8B7355;
    font-weight: 500;
    padding: 12px 20px;
    font-size: 0.85rem;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    background: transparent;
}

.nav-tabs-piedra .nav-link:hover {
    color: #5D4037;
    background: rgba(139, 115, 85, 0.05);
}

.nav-tabs-piedra .nav-link.active {
    color: #5D4037;
    background: transparent;
    border-bottom: 3px solid #8B7355;
    font-weight: 700;
}

/* Form Styling */
.form-section-title {
    font-family: 'Poppins', sans-serif;
    color: #6F5B44;
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-label-premium {
    font-size: 0.75rem;
    font-weight: 700;
    color: #5D4037;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.input-group-premium {
    border: 1px solid #E8DCC8;
    border-radius: 8px;
    background: white;
    transition: all 0.2s ease;
    overflow: hidden;
}

.input-group-premium:focus-within {
    border-color: #8B7355;
    box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
}

.input-group-text-premium {
    background: #FDFCFB;
    border: none;
    border-right: 1px solid #F5F1E8;
    color: #8B7355;
    padding: 8px 12px;
}

.form-control-premium, .form-select-premium {
    border: none !important;
    padding: 8px 12px;
    font-size: 0.9rem;
    background: transparent !important;
}

.form-control-premium:focus, .form-select-premium:focus {
    box-shadow: none !important;
}

/* Tab Handling for Validation */
.tab-pane {
    display: block !important;
    opacity: 0;
    visibility: hidden;
    position: absolute;
    top: -9999px;
    left: -9999px;
}

.tab-pane.active {
    opacity: 1;
    visibility: visible;
    position: static;
}

/* UI Feedback */
.is-invalid-premium {
    border-color: #E53E3E !important;
}

.invalid-feedback-premium {
    font-size: 0.7rem;
    color: #E53E3E;
    margin-top: 4px;
    font-weight: 500;
}
</style>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card articulo-card">
                <!-- Header -->
                <div class="articulo-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-box-open me-3" style="font-size: 2.5rem; color: var(--color-piedra-texto); opacity: 0.8;"></i>
                                <div>
                                    <h2 class="mb-0 fw-light" style="font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); letter-spacing: -1px; font-size: 1.8rem;">
                                        {% if form.instance.pk %}Editar <span class="fw-bold">Artículo</span>{% else %}Nuevo <span class="fw-bold">Artículo</span>{% endif %}
                                    </h2>
                                    <div style="font-size: 0.85rem; font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); opacity: 0.8;">
                                        Complete los campos para gestionar el catálogo de productos.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'articulos:articulo_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.4); border: 1px solid rgba(93, 64, 55, 0.2); color: var(--color-piedra-texto); padding: 5px 15px; font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0" style="background: #FAFAF8;">
                    <form method="post" enctype="multipart/form-data" id="articuloForm">
                        {% csrf_token %}
                        <!-- Pestañas Premium -->
                        <ul class="nav nav-tabs-piedra" id="articuloTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="basica-tab" data-bs-toggle="tab" data-bs-target="#basica" type="button" role="tab" aria-selected="true">
                                    DATOS GENERALES
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="descripcion-tab" data-bs-toggle="tab" data-bs-target="#descripcion" type="button" role="tab" aria-selected="false">
                                    DESCRIPCIÓN Y LOGO
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab" aria-selected="false">
                                    INVENTARIO Y TIPO
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="oferta-tab" data-bs-toggle="tab" data-bs-target="#oferta" type="button" role="tab" aria-selected="false">
                                    POLÍTICAS DE OFERTA
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="articuloTabsContent">
                            <!-- Pestaña 1: Información Básica -->
                            <div class="tab-pane fade show active" id="basica" role="tabpanel" aria-labelledby="basica-tab">
                                <div class="p-4">
                                    <h5 class="form-section-title">
                                        <i class="fas fa-id-card"></i> Identificación del Producto
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.categoria.id_for_label }}" class="form-label-premium">
                                                    {{ form.categoria.label }} <span class="text-danger">*</span>
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-tags"></i>
                                                    </div>
                                                    {{ form.categoria|add_class:"form-select-premium" }}
                                                </div>
                                                {% if form.categoria.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.categoria.errors.0 }}</div>
                                                {% endif %}
                                            </div>
        
                                            <div class="mb-3">
                                                <label for="{{ form.codigo.id_for_label }}" class="form-label-premium">
                                                    {{ form.codigo.label }} <span class="text-danger">*</span>
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-barcode"></i>
                                                    </div>
                                                    {{ form.codigo|add_class:"form-control-premium"|attr:"placeholder:Ej: ART001"|attr:"oninput:validarCodigo(this)" }}
                                                </div>
                                                <div class="form-text" style="font-size: 0.7rem;">Código único para identificar el artículo</div>
                                                {% if form.codigo.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.codigo.errors.0 }}</div>
                                                {% endif %}
                                                <div id="codigo-feedback" class="invalid-feedback-premium"></div>
                                            </div>
                                        </div>
    
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.nombre.id_for_label }}" class="form-label-premium">
                                                    {{ form.nombre.label }} <span class="text-danger">*</span>
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-box"></i>
                                                    </div>
                                                    {{ form.nombre|add_class:"form-control-premium"|attr:"placeholder:Nombre comercial del producto"|attr:"oninput:validarNombre(this)" }}
                                                </div>
                                                {% if form.nombre.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.nombre.errors.0 }}</div>
                                                {% endif %}
                                                <div id="nombre-feedback" class="invalid-feedback-premium"></div>
                                            </div>
        
                                            <div class="mb-3">
                                                <label for="{{ form.codigo_barras.id_for_label }}" class="form-label-premium">
                                                    {{ form.codigo_barras.label }} (Opcional)
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-qrcode"></i>
                                                    </div>
                                                    {{ form.codigo_barras|add_class:"form-control-premium"|attr:"placeholder:Escanee o ingrese código EAN" }}
                                                </div>
                                                {% if form.codigo_barras.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.codigo_barras.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <h5 class="form-section-title mt-4">
                                        <i class="fas fa-balance-scale"></i> Mediciones y Logística
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.unidad_medida.id_for_label }}" class="form-label-premium">
                                                    {{ form.unidad_medida.label }} <span class="text-danger">*</span>
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-ruler"></i>
                                                    </div>
                                                    {{ form.unidad_medida|add_class:"form-select-premium" }}
                                                </div>
                                                {% if form.unidad_medida.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.unidad_medida.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
    
                                        <div class="col-md-6 d-flex align-items-center">
                                            <div class="form-check p-3 rounded-3" style="background: rgba(139, 115, 85, 0.05); width: 100%;">
                                                {{ form.activo|add_class:"form-check-input ms-0" }}
                                                <label for="{{ form.activo.id_for_label }}" class="form-check-label ms-2 fw-bold" style="color: #5D4037; font-size: 0.85rem;">
                                                    PRODUCTO HABILITADO PARA OPERACIONES
                                            </div>
                                        </div>
                                    </div>

                                    <h5 class="form-section-title mt-4">
                                        <i class="fas fa-calculator"></i> Sistema de Cálculo de Precios
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ form.precio_costo.id_for_label }}" class="form-label-premium">
                                                    PRECIO COSTO (COMPRA)
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium" style="background: #E3F2FD;">
                                                        <i class="fas fa-shopping-cart" style="color: #1976d2;"></i>
                                                    </div>
                                                    {{ form.precio_costo|add_class:"form-control-premium"|attr:"placeholder:0.00"|attr:"oninput:calcularPrecios()" }}
                                                </div>
                                                {% if form.precio_costo.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.precio_costo.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
    
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="{{ form.precio_venta.id_for_label }}" class="form-label-premium">
                                                    PRECIO NETO (VENTA)
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium" style="background: #F3E5F5;">
                                                        <i class="fas fa-cash-register" style="color: #7b1fa2;"></i>
                                                    </div>
                                                    {{ form.precio_venta|add_class:"form-control-premium"|attr:"placeholder:0.00"|attr:"oninput:calcularPrecios()" }}
                                                </div>
                                                {% if form.precio_venta.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.precio_venta.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
    
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label for="{{ form.impuesto_especifico.id_for_label }}" class="form-label-premium">
                                                    IMP. ESPECÍFICO
                                                <div class="input-group-premium d-flex align-items-center">
                                                    {{ form.impuesto_especifico|add_class:"form-control-premium"|attr:"placeholder:0.00"|attr:"oninput:calcularPrecios()" }}
                                                </div>
                                                {% if form.impuesto_especifico.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.impuesto_especifico.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
    
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label for="{{ form.margen_porcentaje.id_for_label }}" class="form-label-premium">
                                                    MARGEN %
                                                <div class="input-group-premium d-flex align-items-center">
                                                    {{ form.margen_porcentaje|add_class:"form-control-premium"|attr:"placeholder:0.00" }}
                                                    <div class="input-group-text-premium" style="border-right: none; border-left: 1px solid #F5F1E8;">
                                                        <i class="fas fa-percent"></i>
                                                    </div>
                                                </div>
                                                {% if form.margen_porcentaje.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.margen_porcentaje.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <!-- Precio Final -->
                                        <div class="col-md-4">
                                        <div class="mb-3">
                                                <label for="{{ form.precio_final.id_for_label }}" class="form-label-premium">PRECIO FINAL (CON IVA+IMP)</label>
                                            <div class="input-group-premium d-flex align-items-center" style="background: #FDFCFB; border-color: #D4C4A8; border-width: 2px;">
                                                    <div class="input-group-text-premium" style="background: var(--gradient-piedra); border: none;">
                                                        <i class="fas fa-hand-holding-usd" style="color: var(--color-piedra-texto);"></i>
                                                    </div>
                                                    {{ form.precio_final|add_class:"form-control-premium fw-bold"|attr:"oninput:calcularPrecios()"|attr:"style:font-size: 1.1rem; color: #5D4037;" }}
                                                </div>
                                                <div class="form-text" style="font-size: 0.7rem;">Este es el precio final de venta al público.</div>
                                                {% if form.precio_final.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.precio_final.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Desglose de Cálculos Premium -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="p-3 rounded-4" style="background: white; border: 1px solid #E8DCC8;">
                                                <h6 class="form-section-title mb-3" style="font-size: 0.8rem; opacity: 0.8;">
                                                    <i class="fas fa-layer-group"></i> Resumen de Componentes de Precio
                                                </h6>
                                                <div class="row g-2">
                                                    <div class="col-6 col-md-3">
                                                        <div class="p-2 rounded-3 text-center" style="background:rgba(139, 115, 85, 0.03); border: 1px solid #F5F1E8;">
                                                            <div class="fw-bold" style="color: #8B7355; font-size: 1.1rem;" id="precio_neto_display">$0</div>
                                                            <small class="text-uppercase" style="font-size: 0.6rem; letter-spacing: 1px; color: #A08C75;">Precio Neto</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="p-2 rounded-3 text-center" style="background:rgba(139, 115, 85, 0.03); border: 1px solid #F5F1E8;">
                                                            <div class="fw-bold" style="color: #8B7355; font-size: 1.1rem;" id="iva_display">$0</div>
                                                            <small class="text-uppercase" style="font-size: 0.6rem; letter-spacing: 1px; color: #A08C75;">IVA (19%)</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="p-2 rounded-3 text-center" style="background:rgba(139, 115, 85, 0.03); border: 1px solid #F5F1E8;">
                                                            <div class="fw-bold" style="color: #8B7355; font-size: 1.1rem;" id="impuesto_especifico_display">$0</div>
                                                            <small class="text-uppercase" style="font-size: 0.6rem; letter-spacing: 1px; color: #A08C75;">Imp. Específico</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="p-2 rounded-3 text-center" style="background: var(--gradient-piedra); border: 1px solid var(--color-piedra-borde);">
                                                            <div class="fw-bold" style="color: var(--color-piedra-texto); font-size: 1.1rem;" id="precio_final_display">$0</div>
                                                            <small class="text-uppercase" style="font-size: 0.6rem; letter-spacing: 1px; color: var(--color-piedra-texto); opacity: 0.7;">Precio de Venta Sugerido</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña 2: Descripción y Logo Premium -->
                            <div class="tab-pane fade" id="descripcion" role="tabpanel" aria-labelledby="descripcion-tab">
                                <div class="p-4">
                                    <h5 class="form-section-title">
                                        <i class="fas fa-magic"></i> Presentación del Producto
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-7">
                                            <div class="mb-3">
                                                <label for="{{ form.descripcion.id_for_label }}" class="form-label-premium">
                                                    {{ form.descripcion.label }}
                                                <div class="input-group-premium d-flex" style="height: auto;">
                                                    <div class="input-group-text-premium" style="align-items: flex-start; padding-top: 15px;">
                                                        <i class="fas fa-align-left"></i>
                                                    </div>
                                                    {{ form.descripcion|add_class:"form-control-premium"|attr:"placeholder:Redacte una descripción comercial para el catálogo..."|attr:"rows:12" }}
                                                </div>
                                                {% if form.descripcion.errors %}
                                                    <div class="invalid-feedback-premium d-block">{{ form.descripcion.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
    
                                        <div class="col-md-5">
                                            <div class="mb-4">
                                                <label for="{{ form.logo.id_for_label }}" class="form-label-premium">
                                                    {{ form.logo.label }}
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-cloud-upload-alt"></i>
                                                    </div>
                                                    {{ form.logo|add_class:"form-control-premium"|attr:"accept:image/*"|attr:"onchange:previewLogo(this)" }}
                                                </div>
                                            </div>
        
                                            <!-- Preview del logo -->
                                            <div id="logo-preview-container" class="text-center p-4 rounded-4" style="display: none; background: white; border: 2px dashed #E8DCC8;">
                                                <img id="logo-preview" class="img-fluid rounded-3 mb-3" style="max-height: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" src="" alt="Preview">
                                                <div class="d-grid">
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLogoPreview()">
                                                        <i class="fas fa-trash-alt me-2"></i>Remover Imagen
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Mostrar logo actual si existe -->
                                            {% if form.instance.logo %}
                                                <div id="current-logo-container" class="text-center p-4 rounded-4" style="background: white; border: 1px solid #E8DCC8;">
                                                    <img src="{{ form.instance.logo.url }}" class="img-fluid rounded-3 mb-3" style="max-height: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" alt="Actual">
                                                    <div class="badge bg-light text-muted border py-2 px-3 fw-normal" style="font-size: 0.75rem;">Imagen actual del producto</div>
                                                </div>
                                            {% endif %}

                                            <div class="alert mt-3" style="background: rgba(139, 115, 85, 0.05); border: 1px solid #E8DCC8; border-radius: 12px;">
                                                <div class="d-flex">
                                                    <i class="fas fa-info-circle text-muted mt-1 me-2"></i>
                                                    <small class="text-muted" style="font-size: 0.75rem; line-height: 1.4;">
                                                        Se recomienda utilizar imágenes cuadradas (1:1) de al menos 500x500px para una mejor visualización en el catálogo.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Pestaña 3: Oferta Premium -->
                            <div class="tab-pane fade" id="oferta" role="tabpanel" aria-labelledby="oferta-tab">
                                <div class="p-4">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="rounded-pill px-4 py-2" style="background: var(--gradient-piedra); color: var(--color-piedra-texto); font-weight: 700; font-size: 0.75rem; letter-spacing: 1px;">
                                            POLÍTICAS COMERCIALES Y CAMPAÑAS
                                        </div>
                                        <div class="ms-auto">
                                            {% if form.instance.pk %}
                                                <span class="badge rounded-pill px-3 py-2" style="background: #FFFBF0; color: #8B7355; border: 1px solid #D4C4A8; font-weight: 600;">
                                                    PRECIO LISTA ACTUAL: ${{ form.instance.precio_final|floatformat:0|intcomma }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="row g-4">
                                        <div class="col-md-4">
                                            <div class="p-4 rounded-4 h-100" style="background: white; border: 1px solid #E8DCC8;">
                                                <div class="form-check p-3 rounded-3 mb-4" style="background: rgba(139, 115, 85, 0.05); border: 1px solid #E8DCC8;">
                                                    {{ form.en_oferta|add_class:"form-check-input ms-0" }}
                                                    <label class="form-check-label ms-2 fw-bold" for="{{ form.en_oferta.id_for_label }}" style="color: #5D4037;">
                                                        ACTIVAR CAMPAÑA DE OFERTA
                                                </div>

                                                <div class="mb-4">
                                                    <label class="form-label-premium">PRECIO DE OFERTA</label>
                                                    <div class="input-group-premium d-flex align-items-center" style="background: #F0FFF4; border-color: #C6F6D5;">
                                                        <div class="input-group-text-premium" style="background: transparent;">
                                                            <i class="fas fa-tag text-success"></i>
                                                        </div>
                                                        {{ form.precio_oferta|add_class:"form-control-premium text-end fw-bold text-success"|attr:"placeholder:0" }}
                                                    </div>
                                                </div>

                                                <div class="mb-0">
                                                    <label class="form-label-premium">% DE DESCUENTO APLICADO</label>
                                                    <div class="input-group-premium d-flex align-items-center">
                                                        <div class="input-group-text-premium">
                                                            <i class="fas fa-percentage"></i>
                                                        </div>
                                                        {{ form.porcentaje_descuento_oferta|add_class:"form-control-premium text-end"|attr:"placeholder:0" }}
                                                    </div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">Ingrese el porcentaje para calcular el precio automáticamente.</small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="p-4 rounded-4 h-100" style="background: white; border: 1px solid #E8DCC8;">
                                                <h6 class="form-section-title mb-4">
                                                    <i class="fas fa-business-time"></i> Vigencia de Campaña
                                                </h6>
            
                                                <div class="mb-4">
                                                    <label class="form-label-premium">INICIO DE LA OFERTA</label>
                                                    <div class="input-group-premium d-flex align-items-center">
                                                        <div class="input-group-text-premium">
                                                            <i class="fas fa-clock"></i>
                                                        </div>
                                                        {{ form.fecha_inicio_oferta|add_class:"form-control-premium"|attr:"type:date" }}
                                                    </div>
                                                </div>

                                                <div class="mb-0">
                                                    <label class="form-label-premium">TÉRMINO DE LA OFERTA</label>
                                                    <div class="input-group-premium d-flex align-items-center">
                                                        <div class="input-group-text-premium">
                                                            <i class="fas fa-calendar-times"></i>
                                                        </div>
                                                        {{ form.fecha_fin_oferta|add_class:"form-control-premium"|attr:"type:date" }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="p-4 rounded-4 h-100" style="background: white; border: 1px solid #E8DCC8;">
                                                <h6 class="form-section-title mb-4">
                                                    <i class="fas fa-bullhorn"></i> Detalle Comercial
                                                </h6>
                                                <label class="form-label-premium">NOTAS O LEYENDAS DE OFERTA</label>
                                                <div class="input-group-premium" style="height: auto;">
                                                    {{ form.descripcion_oferta|add_class:"form-control-premium"|attr:"rows:5"|attr:"placeholder:Ej: Oferta válida hasta agotar stock..." }}
                                                </div>
                                                <div class="mt-4 p-2 rounded-3 text-center" style="background: #FFFBF0; border: 1px solid #F5F1E8;">
                                                    <small class="text-muted" style="font-size: 0.75rem;">
                                                        <i class="fas fa-info-circle me-1"></i> Al activarse, los clientes verán un distintivo de oferta en el punto de venta.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña 4: Stock y Tipo Premium -->
                            <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                                <div class="p-4">
                                    <h5 class="form-section-title">
                                        <i class="fas fa-warehouse"></i> Parámetros de Inventario
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <div class="form-check p-3 rounded-3" style="background: rgba(139, 115, 85, 0.05); border: 1px solid #E8DCC8;">
                                                    {{ form.control_stock|add_class:"form-check-input ms-0" }}
                                                    <label for="{{ form.control_stock.id_for_label }}" class="form-check-label ms-2 fw-bold" style="color: #5D4037;">
                                                        HABILITAR CONTROL DE STOCK
                                                </div>
                                                <div class="form-text ms-1" style="font-size: 0.7rem;">Si se deshabilita, el sistema permitirá ventas infinitas sin registrar movimientos de bodega.</div>
                                            </div>
    
                                            <div class="row g-3 mb-4">
                                                <div class="col-6">
                                                    <label for="{{ form.stock_minimo.id_for_label }}" class="form-label-premium">STOCK MÍNIMO (CRÍTICO)</label>
                                                    <div class="input-group-premium d-flex align-items-center">
                                                        <div class="input-group-text-premium" style="background: #FFF5F5;">
                                                            <i class="fas fa-arrow-down text-danger"></i>
                                                        </div>
                                                        {{ form.stock_minimo|add_class:"form-control-premium" }}
                                                    </div>
                                                </div>
    
                                                <div class="col-6">
                                                    <label for="{{ form.stock_maximo.id_for_label }}" class="form-label-premium">STOCK MÁXIMO (IDEAL)</label>
                                                    <div class="input-group-premium d-flex align-items-center">
                                                        <div class="input-group-text-premium" style="background: #F0FFF4;">
                                                            <i class="fas fa-arrow-up text-success"></i>
                                                        </div>
                                                        {{ form.stock_maximo|add_class:"form-control-premium" }}
                                                    </div>
                                                </div>
                                            </div>
        
                                            <div class="mb-3">
                                                <label for="{{ form.tipo_articulo.id_for_label }}" class="form-label-premium">CALIFICACIÓN TÉCNICA DEL ARTÍCULO</label>
                                                <div class="input-group-premium d-flex align-items-center">
                                                    <div class="input-group-text-premium">
                                                        <i class="fas fa-cogs"></i>
                                                    </div>
                                                    {{ form.tipo_articulo|add_class:"form-select-premium" }}
                                                </div>
                                                <div class="form-text" style="font-size: 0.7rem;">Determine si este registro se comporta como producto final, materia prima o servicio.</div>
                                                {% if form.tipo_articulo.errors %}
                                                    <div class="text-danger">{{ form.tipo_articulo.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                            <div class="p-4 rounded-4 h-100 d-flex flex-column justify-content-center" style="background: white; border: 1px solid #E8DCC8; border-left: 5px solid #8B7355;">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="rounded-circle p-3 me-3" style="background: #FDFCFB; border: 1px solid #F5F1E8;">
                                                        <i class="fas fa-info-circle text-muted" style="font-size: 1.5rem;"></i>
                                                    </div>
                                                    <h6 class="mb-0 fw-bold" style="color: #5D4037;">Gestión de Bodega Inteligente</h6>
                                                </div>
                                                <p class="text-muted" style="font-size: 0.85rem; line-height: 1.6;">
                                                    Al establecer niveles de <span class="fw-bold">Stock Mínimo</span>, el sistema podrá notificarle automáticamente cuando el inventario sea bajo, permitiendo una reposición oportuna.
                                                </p>
                                                <p class="text-muted" style="font-size: 0.85rem; border-top: 1px solid #F5F1E8; padding-top: 15px;">
                                                    <i class="fas fa-shield-alt me-1 text-success"></i> El control de stock se sincroniza en tiempo real con todas sus sucursales.
                                                </p>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Botones de Acción Premium -->
                        <div class="p-4 text-center mt-2" style="background: #FDFCFB; border-top: 1px solid #F5F1E8;">
                            <div class="d-flex justify-content-center gap-3">
                                <a href="{% url 'articulos:articulo_list' %}" class="btn" style="background: white; border: 1px solid #D4C4A8; color: #8B7355; font-weight: 600; padding: 10px 40px; border-radius: 12px; transition: all 0.3s ease;">
                                    <i class="fas fa-times me-2"></i> DESCARTAR CAMBIOS
                                </a>
                                <button type="submit" class="btn" style="background: var(--gradient-piedra); border: 1px solid var(--color-piedra-borde); color: var(--color-piedra-texto); font-weight: 700; padding: 10px 60px; border-radius: 12px; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.2); transition: all 0.3s ease;">
                                    <i class="fas fa-save me-2"></i> GUARDAR PRODUCTO
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para preview del logo
function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewContainer = document.getElementById('logo-preview-container');
            const preview = document.getElementById('logo-preview');
            const currentLogoContainer = document.getElementById('current-logo-container');
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
            if (currentLogoContainer) {
                currentLogoContainer.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Función para quitar preview del logo
function removeLogoPreview() {
    const previewContainer = document.getElementById('logo-preview-container');
    const logoInput = document.querySelector('input[type="file"]');
    previewContainer.style.display = 'none';
    logoInput.value = '';
}

    // Función para formatear precios
    function formatearPrecio(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            value = parseInt(value).toLocaleString('es-CL');
            input.value = value;
        }
    }

    // Variable global para almacenar el porcentaje de impuesto específico
    let impuestoEspecificoPorcentaje = 0;
    // Función para obtener impuesto específico de la categoría
    function obtenerImpuestoEspecificoCategoria() {
        const categoriaSelect = document.getElementById('id_categoria');
        const categoriaId = categoriaSelect.value;
        if (!categoriaId) {
            impuestoEspecificoPorcentaje = 0;
            const impuestoField = document.getElementById('id_impuesto_especifico');
            if (impuestoField) {
                impuestoField.value = '0.00';
            }
            calcularPrecios();
            return;
        }
        // Obtener el impuesto específico de la categoría desde el servidor
        fetch(`/articulos/categoria/${categoriaId}/impuesto-especifico/`)
            .then(response => response.json())
            .then(data => {
                if (data.impuesto_especifico_porcentaje) {
                    impuestoEspecificoPorcentaje = parseFloat(data.impuesto_especifico_porcentaje);
                    console.log('Impuesto específico aplicado:', impuestoEspecificoPorcentaje + '%');
                    calcularPrecios();
                } else {
                    impuestoEspecificoPorcentaje = 0;
                    const impuestoField = document.getElementById('id_impuesto_especifico');
                    if (impuestoField) {
                        impuestoField.value = '0.00';
                    }
                    calcularPrecios();
                }
            })
            .catch(error => {
                console.error('Error al obtener impuesto específico:', error);
                impuestoEspecificoPorcentaje = 0;
                calcularPrecios();
            });
    }

    // Función para calcular precios automáticamente (CÁLCULO CIRCULAR)
    function calcularPrecios() {
        console.log('=== INICIO calcularPrecios ===');
        console.log('impuestoEspecificoPorcentaje:', impuestoEspecificoPorcentaje);
        // Función para convertir formato chileno a número
        function parseChileanNumber(value) {
            if (!value) return 0;
            // Quitar separadores de miles (puntos) pero mantener coma decimal
            let cleanValue = value.toString().replace(/\./g, '');
            // Convertir coma decimal a punto
            cleanValue = cleanValue.replace(',', '.');
            return parseFloat(cleanValue) || 0;
        }
        const precioCosto = parseChileanNumber(document.getElementById('id_precio_costo').value);
        const precioNeto = parseChileanNumber(document.getElementById('id_precio_venta').value);
        const precioFinal = parseChileanNumber(document.getElementById('id_precio_final').value);
        console.log('Valores iniciales - Costo:', precioCosto, 'Neto:', precioNeto, 'Final:', precioFinal);
        // Calcular el valor monetario del impuesto específico basado en el precio neto
        const impuestoEspecificoValor = precioNeto * (impuestoEspecificoPorcentaje / 100);
        console.log('Impuesto específico calculado:', impuestoEspecificoValor);
        let iva, margenCalculado, nuevoPrecioNeto, nuevoPrecioFinal;
        // CÁLCULO CIRCULAR: Si se modifica Precio Final, calcular hacia atrás
        if (precioFinal > 0) {
            console.log('Calculando desde Precio Final hacia atrás');
            // Calcular Precio Neto desde Precio Final
            // Precio Final = Precio Neto + IVA + Impuesto Específico
            // Precio Final = Precio Neto + (Precio Neto * 0.19) + (Precio Neto * impuestoEspecificoPorcentaje/100)
            // Precio Final = Precio Neto * (1 + 0.19 + impuestoEspecificoPorcentaje/100)
            // Precio Neto = Precio Final / (1 + 0.19 + impuestoEspecificoPorcentaje/100)
            const factorTotal = 1 + 0.19 + (impuestoEspecificoPorcentaje / 100);
            nuevoPrecioNeto = precioFinal / factorTotal;
            iva = nuevoPrecioNeto * 0.19;
            console.log('Factor total:', factorTotal, 'Nuevo precio neto:', nuevoPrecioNeto, 'IVA:', iva);
            // Actualizar Precio Neto si es diferente
            if (Math.abs(precioNeto - nuevoPrecioNeto) > 0.01) {
                document.getElementById('id_precio_venta').value = nuevoPrecioNeto.toFixed(2).replace('.', ',');
                console.log('Actualizado precio neto a:', nuevoPrecioNeto.toFixed(2).replace('.', ','));
            }
        }
        // Si se modifica Precio Neto, calcular hacia adelante
        else if (precioNeto > 0) {
            console.log('Calculando desde Precio Neto hacia adelante');
            iva = precioNeto * 0.19;
            const impuestoEspecificoCalculado = precioNeto * (impuestoEspecificoPorcentaje / 100);
            nuevoPrecioFinal = precioNeto + iva + impuestoEspecificoCalculado;
            console.log('IVA:', iva, 'Impuesto específico:', impuestoEspecificoCalculado, 'Nuevo precio final:', nuevoPrecioFinal);
            // Actualizar Precio Final si es diferente
            if (Math.abs(precioFinal - nuevoPrecioFinal) > 0.01) {
                document.getElementById('id_precio_final').value = nuevoPrecioFinal.toFixed(2).replace('.', ',');
                console.log('Actualizado precio final a:', nuevoPrecioFinal.toFixed(2).replace('.', ','));
            }
        }
        // Calcular margen si hay precio de costo y precio final
        const precioFinalActual = parseFloat(document.getElementById('id_precio_final').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        if (precioCosto > 0 && precioFinalActual > 0) {
            margenCalculado = ((precioFinalActual - precioCosto) / precioCosto) * 100;
            document.getElementById('id_margen_porcentaje').value = margenCalculado.toFixed(2).replace('.', ',');
            console.log('Margen calculado:', margenCalculado);
        }
        // Actualizar el campo de impuesto específico con el valor monetario calculado
        const impuestoField = document.getElementById('id_impuesto_especifico');
        if (impuestoField) {
            impuestoField.value = impuestoEspecificoValor.toFixed(2).replace('.', ',');
            console.log('Actualizado campo impuesto específico a:', impuestoEspecificoValor.toFixed(2).replace('.', ','));
        }
        // Actualizar displays con valores finales
        const precioNetoDisplay = parseFloat(document.getElementById('id_precio_venta').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        const precioFinalDisplay = parseFloat(document.getElementById('id_precio_final').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        const ivaDisplay = precioNetoDisplay * 0.19;
        const impuestoEspecificoDisplay = precioNetoDisplay * (impuestoEspecificoPorcentaje / 100);
        console.log('Displays - Neto:', precioNetoDisplay, 'Final:', precioFinalDisplay, 'IVA:', ivaDisplay, 'Imp. Esp:', impuestoEspecificoDisplay);
        // Formatear números correctamente (sin decimales para valores finales)
        function formatearNumero(num) {
            return '$' + Math.round(num).toLocaleString('es-CL');
        }
        function formatearNumeroConDecimales(num) {
            return '$' + num.toFixed(2).replace('.', ',');
        }
        document.getElementById('precio_neto_display').textContent = formatearNumeroConDecimales(precioNetoDisplay);
        document.getElementById('iva_display').textContent = formatearNumeroConDecimales(ivaDisplay);
        document.getElementById('impuesto_especifico_display').textContent = formatearNumeroConDecimales(impuestoEspecificoDisplay);
        document.getElementById('precio_final_display').textContent = formatearNumero(precioFinalDisplay);
        console.log('=== FIN calcularPrecios ===');
    }

    // Función para buscar artículo por código de barras
    function buscarArticuloPorCodigoBarras(codigo) {
        fetch(`/articulos/buscar-por-codigo-barras/?codigo=${encodeURIComponent(codigo)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.articulo) {
                    console.log('Artículo encontrado:', data.articulo);
                    // Llenar los campos con los datos del artículo encontrado
                    document.getElementById('id_nombre').value = data.articulo.nombre;
                    document.getElementById('id_descripcion').value = data.articulo.descripcion || '';
                    document.getElementById('id_precio_costo').value = data.articulo.precio_costo || '0';
                    document.getElementById('id_precio_venta').value = data.articulo.precio_venta || '0';
                    document.getElementById('id_precio_final').value = data.articulo.precio_final || '0';
                    document.getElementById('id_margen_porcentaje').value = data.articulo.margen_porcentaje || '0';
                    // Seleccionar la categoría
                    const categoriaSelect = document.getElementById('id_categoria');
                    if (categoriaSelect && data.articulo.categoria_id) {
                        categoriaSelect.value = data.articulo.categoria_id;
                        // Obtener impuesto específico de la categoría
                        obtenerImpuestoEspecificoCategoria();
                    }
                    // Seleccionar unidad de medida
                    const unidadSelect = document.getElementById('id_unidad_medida');
                    if (unidadSelect && data.articulo.unidad_medida_id) {
                        unidadSelect.value = data.articulo.unidad_medida_id;
                    }
                    // Recalcular precios
                    calcularPrecios();
                    // Mostrar mensaje de éxito
                    Swal.fire({
                        icon: 'success',
                        title: 'Artículo Encontrado',
                        text: `Se cargaron los datos del artículo: ${data.articulo.nombre}`,
                        timer: 2000
                    });
                } else {
                    console.log('No se encontró artículo con código:', codigo);
                }
            })
            .catch(error => {
                console.error('Error al buscar artículo:', error);
            });
    }

    // Calcular precios al cargar la página y cuando cambien los valores
document.addEventListener('DOMContentLoaded', function() {
        const categoriaSelect = document.getElementById('id_categoria');
        calcularPrecios();
        // === Fechas por defecto Oferta ===
        const fi=document.getElementById('id_fecha_inicio_oferta');
        const ff=document.getElementById('id_fecha_fin_oferta');
        if(fi && !fi.value){
            const hoy=new Date();
            fi.value=hoy.toISOString().slice(0,10);
            if(ff && !ff.value){
                const fin=new Date(hoy);
                fin.setDate(fin.getDate()+7);
                ff.value=fin.toISOString().slice(0,10);
            }
        }
        // Agregar event listeners para recalcular automáticamente
        document.getElementById('id_precio_costo').addEventListener('input', calcularPrecios);
        document.getElementById('id_precio_venta').addEventListener('input', calcularPrecios);
        document.getElementById('id_precio_final').addEventListener('input', calcularPrecios);
        document.getElementById('id_margen_porcentaje').addEventListener('input', calcularPrecios);
        // Event listener para impuesto específico si existe
        const impuestoEspecificoField = document.getElementById('id_impuesto_especifico');
        if (impuestoEspecificoField) {
            impuestoEspecificoField.addEventListener('input', calcularPrecios);
        }
        // Event listener para categoría - obtener impuesto específico automáticamente
        if (categoriaSelect) {
            // Obtener impuesto específico al cargar la página (para edición)
            if (categoriaSelect.value) {
                console.log('Cargando impuesto específico para categoría:', categoriaSelect.value);
                obtenerImpuestoEspecificoCategoria();
            }
            categoriaSelect.addEventListener('change', function() {
                console.log('Categoría cambiada a:', this.value);
                obtenerImpuestoEspecificoCategoria();
            });
        }
        // Event listener para código de barras - buscar artículo existente
        const codigoBarrasField = document.getElementById('id_codigo_barras');
        if (codigoBarrasField) {
            codigoBarrasField.addEventListener('input', function() {
                const codigo = this.value.trim();
                if (codigo.length >= 8) { // Códigos de barras típicos tienen al menos 8 dígitos
                    console.log('Buscando artículo con código de barras:', codigo);
                    buscarArticuloPorCodigoBarras(codigo);
                }
            });
        }
});

// Funciones de validación en tiempo real
window.validarCodigo = function(input) {
    const codigo = input.value.trim();
    const feedback = document.getElementById('codigo-feedback');
    if (codigo.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        feedback.textContent = 'El código debe tener al menos 3 caracteres';
        return false;
    } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.textContent = '';
        return true;
    }
};

window.validarNombre = function(input) {
    const nombre = input.value.trim();
    const feedback = document.getElementById('nombre-feedback');
    if (nombre.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        feedback.textContent = 'El nombre debe tener al menos 3 caracteres';
        return false;
    } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.textContent = '';
        return true;
    }
};

// Validación del formulario antes del envío
document.getElementById('articuloForm').addEventListener('submit', function(e) {
    const codigoInput = document.getElementById('{{ form.codigo.id_for_label }}');
    const nombreInput = document.getElementById('{{ form.nombre.id_for_label }}');
    const categoriaInput = document.getElementById('{{ form.categoria.id_for_label }}');
    const unidadMedidaInput = document.getElementById('{{ form.unidad_medida.id_for_label }}');
    let esValido = true;
    if (!validarCodigo(codigoInput)) {
        esValido = false;
    }
    if (!validarNombre(nombreInput)) {
        esValido = false;
    }
    if (!categoriaInput.value) {
        categoriaInput.classList.add('is-invalid');
        esValido = false;
    } else {
        categoriaInput.classList.remove('is-invalid');
    }
    if (!unidadMedidaInput.value) {
        unidadMedidaInput.classList.add('is-invalid');
        esValido = false;
    } else {
        unidadMedidaInput.classList.remove('is-invalid');
    }
    if (!esValido) {
        e.preventDefault();
        Swal.fire({
            icon: 'error',
            title: 'Campos Incompletos',
            text: 'Por favor, complete todos los campos obligatorios correctamente.',
            confirmButtonColor: '#8B7355',
            confirmButtonText: 'Entendido'
        });
    }
});
</script>
{% endblock %}