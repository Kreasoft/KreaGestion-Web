{% extends "base.html" %}

{% block body_class %}hide-top-bar{% endblock %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- Mensajes de Django -->
{% if messages %}
    <div class="container-fluid mt-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<style>
/* Estilos para campos inválidos en pestañas */
.tab-pane .is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.tab-pane .form-select.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Asegurar que los campos en pestañas inactivas sean visibles para validación */
.tab-pane {
    display: block !important;
    opacity: 0;
    visibility: hidden;
    position: absolute;
    top: -9999px;
    left: -9999px;
}

.tab-pane.active {
    opacity: 1;
    visibility: visible;
    position: static;
}

/* Estilos para preview de imagen */
.logo-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 10px;
}

.logo-preview-container {
    text-align: center;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, #9CAF88 0%, #B5C99A 100%); border: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-box fa-2x text-white me-3"></i>
                            <div>
                                <h5 class="mb-0 text-white">
                                    {% if form.instance.pk %}Editar Artículo{% else %}Crear Nuevo Artículo{% endif %}
                                </h5>
                                <small class="text-white-50">Gestiona la información completa del artículo</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'articulos:articulo_list' %}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <form method="post" enctype="multipart/form-data" id="articuloForm">
                        {% csrf_token %}
                        
                        <!-- Pestañas -->
                        <ul class="nav nav-tabs" id="articuloTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basica-tab" data-bs-toggle="tab" data-bs-target="#basica" type="button" role="tab" aria-controls="basica" aria-selected="true">
                                    <i class="fas fa-info-circle me-2"></i>Información Básica
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="descripcion-tab" data-bs-toggle="tab" data-bs-target="#descripcion" type="button" role="tab" aria-controls="descripcion" aria-selected="false">
                                    <i class="fas fa-align-left me-2"></i>Descripción y Logo
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab" aria-controls="stock" aria-selected="false">
                                    <i class="fas fa-warehouse me-2"></i>Stock y Tipo
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="articuloTabsContent">
                            <!-- Pestaña 1: Información Básica -->
                            <div class="tab-pane fade show active" id="basica" role="tabpanel" aria-labelledby="basica-tab">
                                <div class="p-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.categoria.id_for_label }}" class="form-label">
                                                {{ form.categoria.label }}
                                                    <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-tags" style="color: #6c757d;"></i>
                                                </div>
                                                {{ form.categoria|add_class:"form-select"|attr:"style:border-left: none;" }}
                                            </div>
                                            {% if form.categoria.errors %}
                                                <div class="text-danger">{{ form.categoria.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.codigo.id_for_label }}" class="form-label">
                                                {{ form.codigo.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                    <i class="fas fa-barcode" style="color: #6c757d;"></i>
                                                </div>
                                                {{ form.codigo|add_class:"form-control"|attr:"placeholder:Ej: ART001"|attr:"oninput:validarCodigo(this)"|attr:"style:border-left: none;" }}
                                            </div>
                                            <div class="form-text">Código único para identificar el artículo</div>
                                            {% if form.codigo.errors %}
                                                <div class="text-danger">{{ form.codigo.errors.0 }}</div>
                                            {% endif %}
                                            <div id="codigo-feedback" class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                                {{ form.nombre.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-box" style="color: #6c757d;"></i>
                                                </div>
                                                {{ form.nombre|add_class:"form-control"|attr:"placeholder:Nombre del artículo"|attr:"oninput:validarNombre(this)"|attr:"style:border-left: none;" }}
                                            </div>
                                            {% if form.nombre.errors %}
                                                <div class="text-danger">{{ form.nombre.errors.0 }}</div>
                                            {% endif %}
                                            <div id="nombre-feedback" class="invalid-feedback"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                                <label for="{{ form.codigo_barras.id_for_label }}" class="form-label">
                                                    {{ form.codigo_barras.label }}
                                            </label>
                                            <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-qrcode" style="color: #6c757d;"></i>
                                                    </div>
                                                    {{ form.codigo_barras|add_class:"form-control"|attr:"placeholder:Ingrese código de barras (opcional)"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Código de barras para escaneo (opcional)</div>
                                                {% if form.codigo_barras.errors %}
                                                    <div class="text-danger">{{ form.codigo_barras.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.unidad_medida.id_for_label }}" class="form-label">
                                                    {{ form.unidad_medida.label }}
                                                    <span class="text-danger">*</span>
                                                </label>
                                                <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-ruler" style="color: #6c757d;"></i>
                                                    </div>
                                                    {{ form.unidad_medida|add_class:"form-select"|attr:"style:border-left: none;" }}
                                                </div>
                                                {% if form.unidad_medida.errors %}
                                                    <div class="text-danger">{{ form.unidad_medida.errors.0 }}</div>
                                            {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    {{ form.activo|add_class:"form-check-input" }}
                                                    <label for="{{ form.activo.id_for_label }}" class="form-check-label">
                                                        {{ form.activo.label }}
                                                    </label>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                                
                                    <!-- Sistema de Cálculo de Precios -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6 class="text-muted mb-3">
                                                <i class="fas fa-calculator me-2"></i>Sistema de Cálculo de Precios
                                        </h6>
                                    </div>
                                        
                                        <!-- Precio Costo -->
                                        <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="{{ form.precio_costo.id_for_label }}" class="form-label">
                                                    <i class="fas fa-dollar-sign me-1"></i>{{ form.precio_costo.label }}
                                            </label>
                                            <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #e3f2fd; border-color: #2196f3;">
                                                        <i class="fas fa-shopping-cart" style="color: #1976d2;"></i>
                                                    </div>
                                                    {{ form.precio_costo|add_class:"form-control"|attr:"placeholder:0.00"|attr:"oninput:calcularPrecios()"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Precio de compra del artículo</div>
                                            {% if form.precio_costo.errors %}
                                                <div class="text-danger">{{ form.precio_costo.errors.0 }}</div>
                                            {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Precio Neto -->
                                        <div class="col-md-4">
                                        <div class="mb-3">
                                                <label for="{{ form.precio_venta.id_for_label }}" class="form-label">
                                                    <i class="fas fa-tag me-1"></i>Precio Neto
                                            </label>
                                            <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #f3e5f5; border-color: #9c27b0;">
                                                        <i class="fas fa-cash-register" style="color: #7b1fa2;"></i>
                                                    </div>
                                                    {{ form.precio_venta|add_class:"form-control"|attr:"placeholder:0.00"|attr:"oninput:calcularPrecios()"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Precio neto sin impuestos</div>
                                                {% if form.precio_venta.errors %}
                                                    <div class="text-danger">{{ form.precio_venta.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Impuesto Específico -->
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-receipt me-1"></i>Impuesto Específico
                                                </label>
                                                <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #fff3cd; border-color: #ffc107;">
                                                        <i class="fas fa-file-invoice-dollar" style="color: #856404;"></i>
                                                    </div>
                                                    <input type="text" id="id_impuesto_especifico" class="form-control" placeholder="0.00" oninput="calcularPrecios()" style="border-left: none;">
                                                </div>
                                                <div class="form-text">Impuesto específico (opcional)</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Porcentaje de Utilidad (Calculado) -->
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label for="{{ form.margen_porcentaje.id_for_label }}" class="form-label">
                                                    <i class="fas fa-percentage me-1"></i>{{ form.margen_porcentaje.label }}
                                                </label>
                                                <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #e8f5e8; border-color: #4caf50;">
                                                        <i class="fas fa-chart-line" style="color: #388e3c;"></i>
                                                    </div>
                                                    {{ form.margen_porcentaje|add_class:"form-control"|attr:"placeholder:30.00"|attr:"style:border-left: none;" }}
                                                    <div class="input-group-text" style="background-color: #e8f5e8; border-color: #4caf50;">
                                                        <i class="fas fa-percent" style="color: #388e3c;"></i>
                                                    </div>
                                                </div>
                                                <div class="form-text">Calculado automáticamente</div>
                                            {% if form.margen_porcentaje.errors %}
                                                <div class="text-danger">{{ form.margen_porcentaje.errors.0 }}</div>
                                            {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Precio Final -->
                                        <div class="col-md-4">
                                        <div class="mb-3">
                                                <label for="{{ form.precio_final.id_for_label }}" class="form-label">
                                                    <i class="fas fa-calculator me-1"></i>Precio Final
                                            </label>
                                            <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #d1ecf1; border-color: #17a2b8;">
                                                        <i class="fas fa-money-bill-wave" style="color: #0c5460;"></i>
                                                    </div>
                                                    {{ form.precio_final|add_class:"form-control"|attr:"oninput:calcularPrecios()"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Precio final con todos los impuestos (calculado)</div>
                                                {% if form.precio_final.errors %}
                                                    <div class="text-danger">{{ form.precio_final.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Desglose de Cálculos -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card border-0" style="background-color: #f8f9fa;">
                                                <div class="card-body p-3">
                                                    <h6 class="text-muted mb-3">
                                                        <i class="fas fa-list-alt me-2"></i>Desglose de Cálculos
                                                    </h6>
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <div class="fw-bold text-primary" id="precio_neto_display">$0</div>
                                                                <small class="text-muted">Precio Neto</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <div class="fw-bold text-info" id="iva_display">$0</div>
                                                                <small class="text-muted">IVA (19%)</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <div class="fw-bold text-warning" id="impuesto_especifico_display">$0</div>
                                                                <small class="text-muted">Impuesto Específico</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <div class="fw-bold text-success fs-5" id="precio_final_display">$0</div>
                                                                <small class="text-muted">Precio Final</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña 2: Descripción y Logo -->
                            <div class="tab-pane fade" id="descripcion" role="tabpanel" aria-labelledby="descripcion-tab">
                                <div class="p-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                        <div class="mb-3">
                                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                                    {{ form.descripcion.label }}
                                            </label>
                                            <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da; align-items: flex-start; padding-top: 12px;">
                                                        <i class="fas fa-align-left" style="color: #6c757d;"></i>
                                                    </div>
                                                    {{ form.descripcion|add_class:"form-control"|attr:"placeholder:Descripción detallada del artículo"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Descripción detallada del artículo (opcional)</div>
                                                {% if form.descripcion.errors %}
                                                    <div class="text-danger">{{ form.descripcion.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                        <div class="mb-3">
                                                <label for="{{ form.logo.id_for_label }}" class="form-label">
                                                    {{ form.logo.label }}
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-image" style="color: #6c757d;"></i>
                                                    </div>
                                                    {{ form.logo|add_class:"form-control"|attr:"accept:image/*"|attr:"onchange:previewLogo(this)"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Logo o imagen del artículo (opcional)</div>
                                                {% if form.logo.errors %}
                                                    <div class="text-danger">{{ form.logo.errors.0 }}</div>
                                                {% endif %}
                                        </div>
                                        
                                            <!-- Preview del logo -->
                                            <div id="logo-preview-container" class="logo-preview-container" style="display: none;">
                                                <img id="logo-preview" class="logo-preview" src="" alt="Preview del logo">
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLogoPreview()">
                                                        <i class="fas fa-times me-1"></i>Quitar
                                                    </button>
                                    </div>
                                </div>
                                
                                            <!-- Mostrar logo actual si existe -->
                                            {% if form.instance.logo %}
                                                <div id="current-logo-container" class="logo-preview-container">
                                                    <img src="{{ form.instance.logo.url }}" class="logo-preview" alt="Logo actual">
                                                    <div class="mt-2">
                                                        <small class="text-muted">Logo actual</small>
                                    </div>
                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <!-- Pestaña 4: Stock y Tipo -->
                            <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                                <div class="p-4">
                                    <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ form.control_stock|add_class:"form-check-input" }}
                                                <label for="{{ form.control_stock.id_for_label }}" class="form-check-label">
                                                    {{ form.control_stock.label }}
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.stock_minimo.id_for_label }}" class="form-label">
                                                {{ form.stock_minimo.label }}
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                    <i class="fas fa-arrow-down" style="color: #6c757d;"></i>
                                                </div>
                                                {{ form.stock_minimo|add_class:"form-control"|attr:"style:border-left: none;" }}
                                            </div>
                                            {% if form.stock_minimo.errors %}
                                                <div class="text-danger">{{ form.stock_minimo.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.stock_maximo.id_for_label }}" class="form-label">
                                                {{ form.stock_maximo.label }}
                                            </label>
                                            <div class="input-group">
                                                <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                    <i class="fas fa-arrow-up" style="color: #6c757d;"></i>
                                                </div>
                                                {{ form.stock_maximo|add_class:"form-control"|attr:"style:border-left: none;" }}
                                            </div>
                                            {% if form.stock_maximo.errors %}
                                                <div class="text-danger">{{ form.stock_maximo.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                            
                                            <div class="mb-3">
                                                <label for="{{ form.tipo_articulo.id_for_label }}" class="form-label">
                                                    {{ form.tipo_articulo.label }}
                                                </label>
                                                <div class="input-group">
                                                    <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                        <i class="fas fa-tags" style="color: #6c757d;"></i>
                                                    </div>
                                                    {{ form.tipo_articulo|add_class:"form-control"|attr:"style:border-left: none;" }}
                                                </div>
                                                <div class="form-text">Define si es un producto de venta, insumo o ambos</div>
                                                {% if form.tipo_articulo.errors %}
                                                    <div class="text-danger">{{ form.tipo_articulo.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="alert alert-warning">
                                            <h6><i class="fas fa-info-circle"></i> Información sobre Stock</h6>
                                            <p>El control de stock permite gestionar el inventario del artículo. Cuando esté habilitado, el sistema controlará las cantidades disponibles.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                <a href="{% url 'articulos:articulo_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancelar
                                    </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Guardar Artículo
                                    </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para preview del logo
function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewContainer = document.getElementById('logo-preview-container');
            const preview = document.getElementById('logo-preview');
            const currentLogoContainer = document.getElementById('current-logo-container');
            
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
            
            if (currentLogoContainer) {
                currentLogoContainer.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Función para quitar preview del logo
function removeLogoPreview() {
    const previewContainer = document.getElementById('logo-preview-container');
    const logoInput = document.querySelector('input[type="file"]');
    
    previewContainer.style.display = 'none';
    logoInput.value = '';
}

    // Función para formatear precios
    function formatearPrecio(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            value = parseInt(value).toLocaleString('es-CL');
            input.value = value;
        }
    }

    // Función para calcular precios automáticamente (CÁLCULO CIRCULAR)
    function calcularPrecios() {
        // Función para convertir formato chileno a número
        function parseChileanNumber(value) {
            if (!value) return 0;
            // Quitar separadores de miles (puntos) pero mantener coma decimal
            let cleanValue = value.toString().replace(/\./g, '');
            // Convertir coma decimal a punto
            cleanValue = cleanValue.replace(',', '.');
            return parseFloat(cleanValue) || 0;
        }
        
        const precioCosto = parseChileanNumber(document.getElementById('id_precio_costo').value);
        const precioNeto = parseChileanNumber(document.getElementById('id_precio_venta').value);
        const precioFinal = parseChileanNumber(document.getElementById('id_precio_final').value);
        const impuestoEspecifico = parseChileanNumber(document.getElementById('id_impuesto_especifico')?.value || 0);
        
        let iva, margenCalculado, nuevoPrecioNeto, nuevoPrecioFinal;
        
        // CÁLCULO CIRCULAR: Si se modifica Precio Final, calcular hacia atrás
        if (precioFinal > 0) {
            // Calcular Precio Neto desde Precio Final
            // Precio Final = Precio Neto + IVA + Impuesto Específico
            // Precio Final = Precio Neto + (Precio Neto * 0.19) + Impuesto Específico
            // Precio Final = Precio Neto * (1 + 0.19) + Impuesto Específico
            // Precio Final = Precio Neto * 1.19 + Impuesto Específico
            // Precio Neto = (Precio Final - Impuesto Específico) / 1.19
            
            nuevoPrecioNeto = (precioFinal - impuestoEspecifico) / 1.19;
            iva = nuevoPrecioNeto * 0.19;
            
            // Actualizar Precio Neto si es diferente
            if (Math.abs(precioNeto - nuevoPrecioNeto) > 0.01) {
                document.getElementById('id_precio_venta').value = nuevoPrecioNeto.toFixed(2);
            }
        }
        // Si se modifica Precio Neto, calcular hacia adelante
        else if (precioNeto > 0) {
            iva = precioNeto * 0.19;
            nuevoPrecioFinal = precioNeto + iva + impuestoEspecifico;
            
            // Actualizar Precio Final si es diferente
            if (Math.abs(precioFinal - nuevoPrecioFinal) > 0.01) {
                document.getElementById('id_precio_final').value = nuevoPrecioFinal.toFixed(2);
            }
        }
        
        // Calcular margen si hay precio de costo y precio neto
        const precioNetoActual = parseFloat(document.getElementById('id_precio_venta').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        if (precioCosto > 0 && precioNetoActual > 0) {
            margenCalculado = ((precioNetoActual - precioCosto) / precioCosto) * 100;
            document.getElementById('id_margen_porcentaje').value = margenCalculado.toFixed(2);
        }
        
        // Actualizar displays con valores finales
        const precioNetoDisplay = parseFloat(document.getElementById('id_precio_venta').value) || 0;
        const precioFinalDisplay = parseFloat(document.getElementById('id_precio_final').value) || 0;
        const ivaDisplay = precioNetoDisplay * 0.19;
        
        // Formatear números correctamente
        function formatearNumero(num) {
            return '$' + num.toFixed(2).replace('.', ',');
        }
        
        document.getElementById('precio_neto_display').textContent = formatearNumero(precioNetoDisplay);
        document.getElementById('iva_display').textContent = formatearNumero(ivaDisplay);
        document.getElementById('impuesto_especifico_display').textContent = formatearNumero(impuestoEspecifico);
        document.getElementById('precio_final_display').textContent = '$' + Math.round(precioFinalDisplay).toLocaleString('es-CL');
    }

    // Calcular precios al cargar la página y cuando cambien los valores
document.addEventListener('DOMContentLoaded', function() {
        calcularPrecios();
        
        // Agregar event listeners para recalcular automáticamente
        document.getElementById('id_precio_costo').addEventListener('input', calcularPrecios);
        document.getElementById('id_precio_venta').addEventListener('input', calcularPrecios);
        document.getElementById('id_precio_final').addEventListener('input', calcularPrecios);
        document.getElementById('id_margen_porcentaje').addEventListener('input', calcularPrecios);
        
        // Event listener para impuesto específico si existe
        const impuestoEspecificoField = document.getElementById('id_impuesto_especifico');
        if (impuestoEspecificoField) {
            impuestoEspecificoField.addEventListener('input', calcularPrecios);
        }
});

// Funciones de validación en tiempo real
window.validarCodigo = function(input) {
    const codigo = input.value.trim();
    const feedback = document.getElementById('codigo-feedback');
    
    if (codigo.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        feedback.textContent = 'El código debe tener al menos 3 caracteres';
        return false;
    } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.textContent = '';
        return true;
    }
};

window.validarNombre = function(input) {
    const nombre = input.value.trim();
    const feedback = document.getElementById('nombre-feedback');
    
    if (nombre.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        feedback.textContent = 'El nombre debe tener al menos 3 caracteres';
        return false;
    } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.textContent = '';
        return true;
    }
};

// Validación del formulario antes del envío
document.getElementById('articuloForm').addEventListener('submit', function(e) {
    const codigoInput = document.getElementById('{{ form.codigo.id_for_label }}');
    const nombreInput = document.getElementById('{{ form.nombre.id_for_label }}');
    const categoriaInput = document.getElementById('{{ form.categoria.id_for_label }}');
    const unidadMedidaInput = document.getElementById('{{ form.unidad_medida.id_for_label }}');
    
    let esValido = true;
    
    if (!validarCodigo(codigoInput)) {
        esValido = false;
    }
    
    if (!validarNombre(nombreInput)) {
        esValido = false;
    }
    
    if (!categoriaInput.value) {
        categoriaInput.classList.add('is-invalid');
        esValido = false;
    } else {
        categoriaInput.classList.remove('is-invalid');
    }
    
    if (!unidadMedidaInput.value) {
        unidadMedidaInput.classList.add('is-invalid');
        esValido = false;
    } else {
        unidadMedidaInput.classList.remove('is-invalid');
    }
    
    if (!esValido) {
        e.preventDefault();
        alert('Por favor, complete todos los campos obligatorios correctamente.');
    }
});
</script>
{% endblock %}