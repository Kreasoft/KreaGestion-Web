{% extends "base.html" %}
{% load static %}
{% load l10n %}

{% block title %}Gestionar Precios - {{ lista.nombre }}{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
    }

    /* Ocultar top-bar si existe y ajustar layout */
    .top-bar { display: none !important; }
    .main-content { margin-top: 0 !important; padding-top: 2rem !important; }

    /* Estilo Piedra - Variables Locales */
    :root {
        --color-piedra-texto: #5D4037;
        --color-piedra-boton: #8D6E63;
        --color-piedra-borde: #d7ccc8;
        --gradient-piedra: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --shadow-piedra: 0 4px 15px rgba(93, 64, 55, 0.15);
    }

    .card-header-piedra {
        background: var(--gradient-piedra);
        border-bottom: 2px solid var(--color-piedra-borde);
        padding: 1.5rem 2rem;
    }

    .btn-piedra {
        background: var(--gradient-piedra);
        border: 1px solid var(--color-piedra-borde);
        color: var(--color-piedra-texto) !important;
        font-weight: 600;
        padding: 0.5rem 1.2rem;
        border-radius: 10px;
        box-shadow: var(--shadow-piedra);
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }

    .btn-piedra:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(93, 64, 55, 0.25);
        filter: brightness(0.95);
    }

    .control-box-piedra {
        background: white;
        border: 1px solid var(--color-piedra-borde);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(93, 64, 55, 0.05);
    }

    /* Tabla Ultra-Compacta (32px) */
    .table-piedra-gestion thead th {
        background: rgba(215, 204, 200, 0.2);
        color: var(--color-piedra-texto);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--color-piedra-borde);
        padding: 0.4rem 0.8rem;
        height: 32px;
        vertical-align: middle;
    }

    .table-piedra-gestion tbody tr {
        height: 32px !important;
        transition: background-color 0.2s;
    }

    .table-piedra-gestion tbody tr:hover {
        background-color: rgba(141, 110, 99, 0.05) !important;
    }

    .table-piedra-gestion tbody td {
        padding: 0 0.8rem !important;
        vertical-align: middle;
        color: #444;
        height: 32px !important;
        font-size: 0.8rem;
        border-bottom: 1px solid rgba(215, 204, 200, 0.3);
    }

    .precio-input-premium {
        width: 100%;
        max-width: 110px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid var(--color-piedra-borde);
        padding: 0 0.5rem;
        font-size: 0.8rem;
        text-align: right;
        font-weight: 600;
        color: var(--color-piedra-texto);
        transition: all 0.2s;
    }

    .precio-input-premium:focus {
        border-color: var(--color-piedra-boton);
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1);
        outline: none;
    }

    .precio-input-premium[readonly] {
        background-color: rgba(141, 110, 99, 0.03);
        color: #888;
    }

    .descuento-pill {
        width: 50px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid #BBDEFB;
        background: #E3F2FD;
        color: #1976D2;
        font-size: 0.75rem;
        text-align: center;
        font-weight: 700;
    }

    .btn-guardar-flotante {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        border-radius: 50px;
        padding: 0.8rem 2rem;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.3);
        background: var(--color-piedra-texto);
        color: white !important;
        border: none;
        font-weight: 700;
        transition: all 0.3s;
    }

    .btn-guardar-flotante:hover {
        transform: scale(1.05) translateY(-5px);
        filter: brightness(1.2);
    }

    .section-title-premium {
        font-size: 0.75rem;
        font-weight: 800;
        color: var(--color-piedra-boton);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .section-title-premium::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--color-piedra-borde);
        margin-left: 10px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-11">
            <div class="card shadow-sm border-0" style="border-radius: 20px; overflow: hidden; border: 1px solid var(--color-piedra-borde) !important;">
                <!-- Header Premium -->
                <div class="card-header-piedra">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="p-3 bg-white bg-opacity-50 rounded-circle me-3 shadow-sm">
                                <i class="fas fa-calculator fa-lg" style="color: var(--color-piedra-texto);"></i>
                            </div>
                            <div>
                                <h4 class="mb-0 fw-bold" style="color: var(--color-piedra-texto); font-family: 'Poppins', sans-serif;">
                                    Gestión Masiva de Precios
                                </h4>
                                <p class="mb-0 small opacity-75" style="color: var(--color-piedra-texto);">
                                    Lista: <span class="fw-bold">{{ lista.nombre }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-piedra" onclick="copiarPreciosVenta()">
                                <i class="fas fa-magic me-2"></i> Copiar Base
                            </button>
                            <a href="{% url 'articulos:lista_precio_detail' lista.pk %}" class="btn btn-piedra">
                                <i class="fas fa-arrow-left me-2"></i> Volver
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <!-- Herramienta de Descuento -->
                    <div class="row g-4 mb-4">
                        <div class="col-lg-7">
                            <div class="control-box-piedra h-100 m-0">
                                <div class="section-title-premium">
                                    <i class="fas fa-percentage me-2"></i> Aplicación Masiva de Descuento
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-5">
                                        <label class="small fw-bold text-muted mb-2">BASE DE CÁLCULO</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check m-0">
                                                <input class="form-check-input" type="radio" name="baseCalculo" id="base_neto" value="neto" checked>
                                                <label class="form-check-label small" for="base_neto">Neto</label>
                                            </div>
                                            <div class="form-check m-0">
                                                <input class="form-check-input" type="radio" name="baseCalculo" id="base_iva" value="iva">
                                                <label class="form-check-label small" for="base_iva">IVA Incl.</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold text-muted mb-2">DESC. (%)</label>
                                        <input type="number" id="descuentoPorcentaje" class="form-control form-control-sm" placeholder="10.00" step="0.01">
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-success btn-sm w-100 fw-bold" onclick="aplicarDescuentoMasivoServidor()" style="height: 31px; border-radius: 8px;">
                                            <i class="fas fa-play me-2"></i> PROCESAR TODO
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-0 extra-small text-muted mt-3">
                                    <i class="fas fa-info-circle me-1"></i> Se aplicará el descuento a todos los artículos que coincidan con el filtro de categoría actual.
                                </p>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <div class="control-box-piedra h-100 m-0">
                                <div class="section-title-premium">
                                    <i class="fas fa-filter me-2"></i> Búsqueda y Filtrado
                                </div>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                            <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Código o nombre del artículo...">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <select id="categoriaFilter" class="form-select form-select-sm">
                                            <option value="">-- Todas las Categorías --</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Edición -->
                    <form method="post" id="preciosForm" onsubmit="return prepararFormulario()">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-guardar-flotante">
                            <i class="fas fa-save me-2"></i> GUARDAR CAMBIOS
                        </button>

                        <div class="table-responsive rounded-3" style="border: 1px solid var(--color-piedra-borde);">
                            <table class="table table-piedra-gestion mb-0" id="articulosTable">
                                <thead>
                                    <tr>
                                        <th width="10%">CÓDIGO</th>
                                        <th width="32%">ARTÍCULO</th>
                                        <th width="12%" class="text-end">NETO BASE</th>
                                        <th width="12%" class="text-end">IVA BASE</th>
                                        <th width="8%" class="text-center">% DESC</th>
                                        <th width="13%" class="text-end">NETO LISTA</th>
                                        <th width="13%" class="text-end">IVA LISTA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for articulo in articulos %}
                                    <tr class="articulo-row" 
                                        data-nombre="{{ articulo.nombre|lower }}" 
                                        data-codigo="{{ articulo.codigo|lower }}" 
                                        data-categoria="{{ articulo.categoria.id }}"
                                        data-precio-neto="{{ articulo.precio_venta|unlocalize }}"
                                        data-precio-iva="{{ articulo.precio_final|unlocalize }}">
                                        <td><span class="fw-bold opacity-75">{{ articulo.codigo }}</span></td>
                                        <td><span class="text-truncate d-inline-block" style="max-width: 300px;">{{ articulo.nombre }}</span></td>
                                        <td class="text-end text-muted small">$ {{ articulo.precio_venta|floatformat:0 }}</td>
                                        <td class="text-end text-muted small">$ {{ articulo.precio_final|floatformat:0 }}</td>
                                        <td class="text-center">
                                            <input type="number" class="descuento-pill descuento-input" 
                                                   step="0.01" min="0" max="100" placeholder="0"
                                                   onchange="calcularPrecioConDescuento(this)">
                                        </td>
                                        <td class="text-end">
                                            <input type="number" name="precio_{{ articulo.id }}" 
                                                   class="precio-input-premium precio-neto-lista" 
                                                   step="1" min="0"
                                                   {% if articulo.precio_en_lista %}value="{{ articulo.precio_en_lista|unlocalize }}"{% endif %}
                                                   onchange="calcularPrecioIVADesdeNeto(this)">
                                        </td>
                                        <td class="text-end">
                                            <input type="number" class="precio-input-premium precio-iva-lista" 
                                                   step="1" min="0" readonly>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            <i class="fas fa-box-open fa-3x opacity-25 mb-3"></i>
                                            <p class="text-muted">No se encontraron artículos activos vinculables.</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Filtrar artículos
function filtrarArticulos() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoriaId = document.getElementById('categoriaFilter').value;
    const rows = document.querySelectorAll('.articulo-row');
    
    rows.forEach(row => {
        const nombre = row.dataset.nombre;
        const codigo = row.dataset.codigo;
        const categoria = row.dataset.categoria;
        
        const matchSearch = nombre.includes(searchTerm) || codigo.includes(searchTerm);
        const matchCategoria = !categoriaId || categoria === categoriaId;
        
        row.style.display = (matchSearch && matchCategoria) ? '' : 'none';
    });
}

document.getElementById('searchInput').addEventListener('keyup', filtrarArticulos);
document.getElementById('categoriaFilter').addEventListener('change', filtrarArticulos);

// Copiar precios de venta a la lista
function copiarPreciosVenta() {
    Swal.fire({
        title: '¿Copiar Precios Base?',
        text: 'Los precios de venta originales se copiarán a esta lista.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#8D6E63',
        confirmButtonText: 'Sí, copiar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            const rows = document.querySelectorAll('.articulo-row');
            let contador = 0;
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const precioNeto = parseFloat(row.dataset.precioNeto) || 0;
                    const inputNetoLista = row.querySelector('.precio-neto-lista');
                    if (precioNeto && inputNetoLista) {
                        inputNetoLista.value = Math.round(precioNeto);
                        calcularPrecioIVADesdeNeto(inputNetoLista);
                        contador++;
                    }
                }
            });
            Swal.fire({ title: '¡Listo!', text: `${contador} precios copiados`, icon: 'success', timer: 1500, showConfirmButton: false });
        }
    });
}

// Calcular precio con IVA desde precio neto
function calcularPrecioIVADesdeNeto(input) {
    const row = input.closest('tr');
    const precioNeto = parseFloat(input.value) || 0;
    const precioIVA = Math.round(precioNeto * 1.19);
    const inputIVA = row.querySelector('.precio-iva-lista');
    if (inputIVA) inputIVA.value = precioIVA > 0 ? precioIVA : '';
    calcularPorcentajeDescuento(row);
}

// Calcular % de descuento inverso
function calcularPorcentajeDescuento(row) {
    const precioNetoOriginal = parseFloat(row.dataset.precioNeto) || 0;
    const inputNetoLista = row.querySelector('.precio-neto-lista');
    const precioNetoLista = parseFloat(inputNetoLista.value) || 0;
    const inputDescuento = row.querySelector('.descuento-input');
    
    if (precioNetoOriginal > 0 && precioNetoLista > 0 && inputDescuento) {
        if (precioNetoLista < precioNetoOriginal) {
            const desc = ((precioNetoOriginal - precioNetoLista) / precioNetoOriginal) * 100;
            inputDescuento.value = desc.toFixed(2);
        } else {
            inputDescuento.value = '';
        }
    }
}

// Calcular precio con descuento manual
function calcularPrecioConDescuento(input) {
    const row = input.closest('tr');
    const desc = parseFloat(input.value) || 0;
    const baseCalculo = document.querySelector('input[name="baseCalculo"]:checked').value;
    
    const pNetoBase = parseFloat(row.dataset.precioNeto) || 0;
    const pIvaBase = parseFloat(row.dataset.precioIva) || 0;
    
    let nuevoNeto;
    if (baseCalculo === 'neto') {
        nuevoNeto = Math.round(pNetoBase * (1 - desc / 100));
    } else {
        const nuevoIva = Math.round(pIvaBase * (1 - desc / 100));
        nuevoNeto = Math.round(nuevoIva / 1.19);
    }
    
    const inputNeto = row.querySelector('.precio-neto-lista');
    if (inputNeto) {
        inputNeto.value = nuevoNeto;
        calcularPrecioIVADesdeNeto(inputNeto);
    }
}

// Descuento masivo servidor
function aplicarDescuentoMasivoServidor() {
    const desc = parseFloat(document.getElementById('descuentoPorcentaje').value);
    if (!desc || desc <= 0) {
        Swal.fire({ title: 'Error', text: 'Ingrese un porcentaje válido', icon: 'error' });
        return;
    }
    
    const base = document.querySelector('input[name="baseCalculo"]:checked').value;
    const catId = document.getElementById('categoriaFilter').value;
    
    Swal.fire({
        title: '¿Confirmar Proceso?',
        html: `Se aplicará <b>${desc}%</b> sobre el <b>${base.toUpperCase()}</b> a todos los artículos seleccionados.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, aplicar todo',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            
            const fields = {
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'aplicar_descuento_masivo': '1',
                'descuento_porcentaje': desc,
                'base_calculo': base,
                'categoria_filtro': catId
            };
            
            for (let [name, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function prepararFormulario() {
    const inputs = document.querySelectorAll('.precio-neto-lista');
    let hayCambios = false;
    inputs.forEach(i => { if (i.value) hayCambios = true; });
    
    if (!hayCambios) {
        Swal.fire({ title: 'Atención', text: 'No hay precios ingresados para guardar.', icon: 'info' });
        return false;
    }
    return true;
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.precio-neto-lista').forEach(i => {
        if (i.value) calcularPrecioIVADesdeNeto(i);
    });
});
</script>
{% endblock %}
