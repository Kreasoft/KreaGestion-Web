{% extends "base.html" %}

{% block body_class %}hide-top-bar{% endblock %}
{% load widget_tweaks %}
{% load articulo_filters %}
{% load query_tags %}

{% block title %}Lista de Artículos - GestionCloud{% endblock %}

{% block extra_head %}
<style>
    body {
        background: #FAFAF8 !important;
        min-height: 100vh;
    }
    .alert-custom {
        border-left: 4px solid #8B7355;
    }
    .alert-custom.alert-error, .alert-custom.alert-danger { border-left-color: #dc3545; }
    .alert-custom.alert-warning { border-left-color: #ffc107; }
    .alert-custom.alert-success { border-left-color: #28a745; }

    /* Stats Cards Soft UI */
    .card-stats-soft-ui {
        border-radius: 12px; 
        position: relative; 
        overflow: hidden; 
        min-height: 100px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Sombra suave */
    }
    
    .card-stats-soft-ui:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .stat-icon-bg {
        position: absolute; 
        right: -10px; 
        top: 0; 
        bottom: 0; 
        display: flex; 
        align-items: center; 
        font-size: 100px; 
        opacity: 0.1; 
        pointer-events: none; 
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 15px; background: #FAFAF8; min-height: 100vh;">
    <!-- Mensajes del sistema -->
    {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-custom alert-dismissible fade show shadow-sm" role="alert">
                        <i class="fas {% if message.tags == 'error' or message.tags == 'danger' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <div class="row">
        <div class="col-12">
            <div class="card" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);">
                <!-- Header con Estilo Piedra Premium -->
                <div class="card-header" style="background: var(--gradient-piedra); border-bottom: 3px solid var(--color-piedra-borde); padding: 15px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-box me-3" style="font-size: 2.2rem; color: var(--color-piedra-texto); opacity: 0.8;"></i>
                            <div>
                                <h2 class="mb-0 fw-light" style="font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); letter-spacing: -1px; font-size: 1.8rem;">
                                    Gestión de <span class="fw-bold">Artículos</span>
                                </h2>
                                <div style="font-size: 0.85rem; font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); opacity: 0.8; margin-top: 2px;">
                                    Catálogo completo de productos, servicios e inventario.
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'articulos:categoria_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.2); border: 1px solid rgba(245, 241, 232, 0.3); color: white; font-size: 0.75rem;">
                                <i class="fas fa-tags me-1"></i> Categorías
                            </a>
                            <a href="{% url 'articulos:unidad_medida_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.2); border: 1px solid rgba(245, 241, 232, 0.3); color: white; font-size: 0.75rem;">
                                <i class="fas fa-ruler me-1"></i> Unidades
                            </a>
                            <a href="{% url 'articulos:articulo_create' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.9); border: 1px solid #D4C4A8; color: #6F5B44; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-plus me-1"></i> Nuevo Artículo
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card-body" style="background: #FAFAF8; padding: 15px;">
                    <!-- Estadísticas Soft UI -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card card-stats-soft-ui" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none;">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; color: #1565c0;">Total Artículos</div>
                                    <h3 class="mb-0 fw-bold" style="color: #0d47a1;">{{ total_articulos }}</h3>
                                </div>
                                <div class="stat-icon-bg" style="color: #1976d2;">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-stats-soft-ui" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: none;">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; color: #e65100;">Artículos Activos</div>
                                    <h3 class="mb-0 fw-bold" style="color: #bf360c;">{{ articulos_activos }}</h3>
                                </div>
                                <div class="stat-icon-bg" style="color: #ff9800;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-stats-soft-ui" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: none;">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; color: #2e7d32;">Con Stock</div>
                                    <h3 class="mb-0 fw-bold" style="color: #1b5e20;">{{ articulos_con_stock }}</h3>
                                </div>
                                <div class="stat-icon-bg" style="color: #388e3c;">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-stats-soft-ui" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: none;">
                                <div class="card-body p-3" style="position: relative; z-index: 2;">
                                    <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; color: #6a1b9a;">Categorías</div>
                                    <h3 class="mb-0 fw-bold" style="color: #4a148c;">{{ categorias|length }}</h3>
                                </div>
                                <div class="stat-icon-bg" style="color: #7b1fa2;">
                                    <i class="fas fa-tags"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros Compactos Estilo Piedra -->
                    <div class="p-3" style="background: #FAFAF8; border-bottom: 1px solid #E8DCC8;">
                        <form method="get" id="filterForm">
                            <input type="hidden" name="sort" value="{{ sort|default:'' }}">
                            <input type="hidden" name="direction" value="{{ direction|default:'' }}">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="background: white; border-right: none; color: #8B7355; border-color: #D4C4A8;"><i class="fas fa-search"></i></span>
                                        <input type="text" name="search" class="form-control form-control-sm" placeholder="Buscar por nombre o código..." value="{{ search|default:'' }}" style="border-left: none; border-color: #D4C4A8;">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select name="categoria" class="form-select form-select-sm" onchange="this.form.submit()" style="border-color: #D4C4A8; font-size: 0.75rem;">
                                        <option value="">Todas las categorías</option>
                                        {% for cat in categorias %}
                                            <option value="{{ cat.id }}" {% if categoria_id|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select name="activo" class="form-select form-select-sm" onchange="this.form.submit()" style="border-color: #D4C4A8; font-size: 0.75rem;">
                                        <option value="">Todos los estados</option>
                                        <option value="1" {% if activo == '1' %}selected{% endif %}>Activos</option>
                                        <option value="0" {% if activo == '0' %}selected{% endif %}>Inactivos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select name="tipo_articulo" class="form-select form-select-sm" onchange="this.form.submit()" style="border-color: #D4C4A8; font-size: 0.75rem;">
                                        <option value="">Todos los tipos</option>
                                        <option value="producto_venta" {% if tipo_articulo == 'producto_venta' %}selected{% endif %}>Venta</option>
                                        <option value="insumo" {% if tipo_articulo == 'insumo' %}selected{% endif %}>Insumo</option>
                                        <option value="produccion" {% if tipo_articulo == 'produccion' %}selected{% endif %}>Producción</option>
                                        <option value="ambos" {% if tipo_articulo == 'ambos' %}selected{% endif %}>Ambos</option>
                                    </select>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="d-flex gap-1 justify-content-end">
                                        <button type="submit" class="btn btn-sm" style="background: #8B7355; color: white; font-size: 0.75rem; border: none; padding: 4px 15px;">
                                            <i class="fas fa-filter me-1"></i> Filtrar
                                        </button>
                                        <a href="{% url 'articulos:articulo_list' %}" class="btn btn-sm btn-outline-secondary" style="border-color: #D4C4A8; color: #8B7355; font-size: 0.75rem; padding: 4px 15px;">
                                            <i class="fas fa-times me-1"></i> Limpiar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tabla Estilo Piedra -->
                    <div class="table-responsive">
                        <table class="table-piedra mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">
                                        <a href="?{% url_replace_sort 'nombre' %}" style="text-decoration: none; color: inherit;">
                                            ARTÍCULO / DESCRIPCIÓN {% get_sort_icon 'nombre' %}
                                        </a>
                                    </th>
                                    <th style="width: 12%;">
                                        <a href="?{% url_replace_sort 'categoria' %}" style="text-decoration: none; color: inherit;">
                                            CATEGORÍA {% get_sort_icon 'categoria' %}
                                        </a>
                                    </th>
                                    <th style="width: 10%; text-align: center;">
                                        <a href="?{% url_replace_sort 'tipo' %}" style="text-decoration: none; color: inherit;">
                                            TIPO {% get_sort_icon 'tipo' %}
                                        </a>
                                    </th>
                                    <th style="width: 12%; text-align: center;">
                                        <a href="?{% url_replace_sort 'codigo' %}" style="text-decoration: none; color: inherit;">
                                            CÓD. BARRAS {% get_sort_icon 'codigo' %}
                                        </a>
                                    </th>
                                    <th style="width: 10%; text-align: right;">P. COSTO</th>
                                    <th style="width: 10%; text-align: right;">P. NETO</th>
                                    <th style="width: 10%; text-align: right;">
                                        <a href="?{% url_replace_sort 'precio' %}" style="text-decoration: none; color: inherit;">
                                            P. FINAL {% get_sort_icon 'precio' %}
                                        </a>
                                    </th>
                                    <th style="width: 5%; text-align: center;">
                                        <a href="?{% url_replace_sort 'stock' %}" style="text-decoration: none; color: inherit;">
                                            STOCK {% get_sort_icon 'stock' %}
                                        </a>
                                    </th>
                                    <th style="width: 6%; text-align: center;">ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for articulo in page_obj %}
                                <tr>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold" style="color: #6F5B44; font-size: 0.85rem;">{{ articulo.codigo }}</span>
                                            <span class="text-dark" style="font-size: 0.8rem;">{{ articulo.nombre }}{% if articulo.en_oferta %} <span class="badge bg-danger ms-1" style="font-size:0.55rem; padding: 2px 5px;">OFERTA</span>{% endif %}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge" style="background: rgba(139, 115, 85, 0.1); color: #8B7355; border: 1px solid rgba(139, 115, 85, 0.2); font-size: 0.65rem;">
                                            {{ articulo.categoria.nombre }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if articulo.tipo_articulo == 'producto_venta' %}
                                            <span class="badge bg-success-subtle text-success border border-success-subtle" style="font-size: 0.65rem;">Venta</span>
                                        {% elif articulo.tipo_articulo == 'insumo' %}
                                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle" style="font-size: 0.65rem;">Insumo</span>
                                        {% else %}
                                            <span class="badge bg-info-subtle text-info border border-info-subtle" style="font-size: 0.65rem;">{{ articulo.get_tipo_articulo_display|default:articulo.tipo_articulo }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center text-muted small">
                                        {{ articulo.codigo_barras|default:"-" }}
                                    </td>
                                    <td class="text-end text-muted small">
                                        ${{ articulo.precio_costo|format_price }}
                                    </td>
                                    <td class="text-end text-muted small">
                                        ${{ articulo.precio_venta|format_price }}
                                    </td>
                                    <td class="text-end fw-bold" style="color: #6F5B44;">
                                        ${{ articulo.precio_final|format_price }}
                                    </td>
                                    <td class="text-center">
                                        {% if articulo.control_stock %}
                                            {% if articulo.stock_total and articulo.stock_total > 0 %}
                                                <span class="badge bg-success" style="font-size: 0.7rem; min-width: 30px;">{{ articulo.stock_total|floatformat:0 }}</span>
                                            {% else %}
                                                <span class="badge bg-danger" style="font-size: 0.65rem;">AGOTADO</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex justify-content-center gap-1">
                                            <a href="{% url 'articulos:articulo_detail' articulo.pk %}" class="btn-action-piedra" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'articulos:articulo_update' articulo.pk %}" class="btn-action-piedra" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'articulos:articulo_delete' articulo.pk %}" class="btn-action-piedra text-danger" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <i class="fas fa-box-open fa-3x mb-3 opacity-25" style="color: #8B7355;"></i>
                                        <h6 class="fw-bold" style="color: #8B7355;">No se encontraron artículos</h6>
                                        <p class="text-muted small">Intenta ajustar los filtros de búsqueda</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                {% if page_obj.has_other_pages %}
                <div class="card-footer bg-white border-top-0 py-3">
                    <nav>
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if categoria_id %}&categoria={{ categoria_id }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}{% if tipo_articulo %}&tipo_articulo={{ tipo_articulo }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if direction %}&direction={{ direction }}{% endif %}" style="color: #8B7355; border-color: #E8DCC8;"><i class="fas fa-chevron-left"></i></a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link" style="background: #8B7355; border-color: #8B7355;">{{ page_obj.number }}</span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if categoria_id %}&categoria={{ categoria_id }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}{% if tipo_articulo %}&tipo_articulo={{ tipo_articulo }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if direction %}&direction={{ direction }}{% endif %}" style="color: #8B7355; border-color: #E8DCC8;"><i class="fas fa-chevron-right"></i></a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para la tabla Estilo Piedra */
.table-piedra {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Poppins', sans-serif;
}

.table-piedra thead th {
    background: #FDFCFB;
    border-bottom: 2px solid #E8DCC8;
    color: #8B7355;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 1px;
    padding: 12px 15px;
}

.table-piedra tbody tr {
    height: 32px;
    transition: all 0.2s ease;
}

.table-piedra tbody tr:nth-of-type(odd) {
    background-color: rgba(245, 241, 232, 0.3);
}

.table-piedra tbody tr:nth-of-type(even) {
    background-color: white;
}

.table-piedra tbody tr:hover {
    background-color: #F5F1E8 !important;
}

.table-piedra tbody td {
    padding: 4px 15px;
    border-bottom: 1px solid #F5F1E8;
    vertical-align: middle;
    font-size: 0.85rem;
    color: #4A5568;
}

.btn-action-piedra {
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid #D4C4A8;
    border-radius: 6px;
    color: #8B7355;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-action-piedra:hover {
    background: #8B7355;
    color: white !important;
    transform: scale(1.1);
}

.badge-success-subtle { background: #E8F5E9; color: #2E7D32; border-color: #C8E6C9; }
.badge-warning-subtle { background: #FFF8E1; color: #F57F17; border-color: #FFECB3; }
.badge-info-subtle { background: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
</style>
{% endblock %}
