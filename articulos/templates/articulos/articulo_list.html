{% extends "base.html" %}

{% block body_class %}hide-top-bar{% endblock %}
{% load widget_tweaks %}
{% load articulo_filters %}

{% block title %}Lista de Artículos - GestionCloud{% endblock %}

{% block extra_head %}
<style>
    body {
        background: #FAFAF8 !important;
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 15px; background: #FAFAF8; min-height: 100vh;">
    <!-- Mensajes del sistema -->
    {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert" style="border-left: 4px solid {% if message.tags == 'error' or message.tags == 'danger' %}#dc3545{% elif message.tags == 'warning' %}#ffc107{% elif message.tags == 'success' %}#28a745{% else %}#8B7355{% endif %};">
                        <i class="fas {% if message.tags == 'error' or message.tags == 'danger' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <div class="row">
        <div class="col-12">
            <div class="card" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border-bottom: 3px solid #D4C4A8; padding: 15px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-box me-3" style="font-size: 1.8rem; color: #F5F1E8;"></i>
                            <div>
                                <h5 class="mb-1" style="font-size: 1.3rem; font-weight: 600; color: white;">
                                    Gestión de Artículos
                                </h5>
                                <small style="font-size: 0.75rem; color: #F5F1E8;">
                                    Administra el catálogo de productos y controla el stock
                                </small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'articulos:categoria_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.2); border: 1px solid rgba(245, 241, 232, 0.3); color: white; font-size: 0.75rem;">
                                <i class="fas fa-tags me-1"></i> Categorías
                            </a>
                            <a href="{% url 'articulos:unidad_medida_list' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.2); border: 1px solid rgba(245, 241, 232, 0.3); color: white; font-size: 0.75rem;">
                                <i class="fas fa-ruler me-1"></i> Unidades
                            </a>
                            <a href="{% url 'articulos:articulo_create' %}" class="btn btn-sm" style="background: rgba(245, 241, 232, 0.9); border: 1px solid #D4C4A8; color: #6F5B44; font-weight: 600; font-size: 0.75rem;">
                                <i class="fas fa-plus me-1"></i> Nuevo Artículo
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card-body" style="background: #FAFAF8; padding: 15px;">
                    <!-- Estadísticas -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <div class="card h-100" style="border: 1px solid #E8DCC8; border-radius: 8px; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%);">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div style="font-size: 0.7rem; color: #6F5B44; font-weight: 600;">Total Artículos</div>
                                            <div style="font-size: 1.3rem; color: #8B7355; font-weight: 700;">{{ total_articulos }}</div>
                                        </div>
                                        <i class="fas fa-box" style="font-size: 1.5rem; color: rgba(139, 115, 85, 0.3);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100" style="border: 1px solid #E8DCC8; border-radius: 8px; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%);">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div style="font-size: 0.7rem; color: #6F5B44; font-weight: 600;">Activos</div>
                                            <div style="font-size: 1.3rem; color: #8B7355; font-weight: 700;">{{ articulos_activos }}</div>
                                        </div>
                                        <i class="fas fa-check-circle" style="font-size: 1.5rem; color: rgba(40, 167, 69, 0.5);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100" style="border: 1px solid #E8DCC8; border-radius: 8px; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%);">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div style="font-size: 0.7rem; color: #6F5B44; font-weight: 600;">Categorías</div>
                                            <div style="font-size: 1.3rem; color: #8B7355; font-weight: 700;">{{ categorias|length }}</div>
                                        </div>
                                        <i class="fas fa-tags" style="font-size: 1.5rem; color: rgba(139, 115, 85, 0.3);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100" style="border: 1px solid #E8DCC8; border-radius: 8px; background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%);">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div style="font-size: 0.7rem; color: #6F5B44; font-weight: 600;">Con Stock</div>
                                            <div style="font-size: 1.3rem; color: #8B7355; font-weight: 700;">{{ articulos_con_stock }}</div>
                                        </div>
                                        <i class="fas fa-warehouse" style="font-size: 1.5rem; color: rgba(139, 115, 85, 0.3);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-3" style="border: 1px solid #E8DCC8; border-radius: 8px;">
                        <div class="card-body p-2">
                            <form method="get" id="filterForm">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" name="search" class="form-control form-control-sm" 
                                               placeholder="Buscar por código, nombre..." 
                                               value="{{ search }}" style="border: 1px solid #D4C4A8;">
                                    </div>
                                    <div class="col-md-3">
                                        <select name="categoria" class="form-select form-select-sm" onchange="this.form.submit()" style="border: 1px solid #D4C4A8;">
                                            <option value="">Todas las categorías</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}" 
                                                        {% if categoria.id|stringformat:"s" == categoria_id %}selected{% endif %}>
                                                    {{ categoria.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select name="tipo_articulo" class="form-select form-select-sm" onchange="this.form.submit()" style="border: 1px solid #D4C4A8;">
                                            <option value="">Todos los tipos</option>
                                            <option value="producto_venta" {% if tipo_articulo == 'producto_venta' %}selected{% endif %}>Venta</option>
                                            <option value="insumo" {% if tipo_articulo == 'insumo' %}selected{% endif %}>Insumo</option>
                                            <option value="produccion" {% if tipo_articulo == 'produccion' %}selected{% endif %}>Producción</option>
                                            <option value="ambos" {% if tipo_articulo == 'ambos' %}selected{% endif %}>Ambos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex gap-1">
                                            <button type="submit" class="btn btn-sm" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; font-size: 0.75rem;">
                                                <i class="fas fa-filter me-1"></i> Filtrar
                                            </button>
                                            <a href="{% url 'articulos:articulo_list' %}" class="btn btn-sm btn-outline-secondary" style="border-color: #D4C4A8; color: #6c757d; font-size: 0.75rem;">
                                                <i class="fas fa-times me-1"></i> Limpiar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-compact">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Artículo</th>
                                    <th style="width: 10%;">Categoría</th>
                                    <th style="width: 8%; text-align: center;">Tipo</th>
                                    <th style="width: 10%; text-align: center;">Cód. Barras</th>
                                    <th style="width: 10%; text-align: right;">P. Costo</th>
                                    <th style="width: 10%; text-align: right;">P. Venta</th>
                                    <th style="width: 10%; text-align: right;">P. Final</th>
                                    <th style="width: 7%; text-align: center;">Stock</th>
                                    <th style="width: 5%; text-align: center;">Estado</th>
                                    <th style="width: 5%; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for articulo in page_obj %}
                                <tr style="border-bottom: 1px solid #F5F1E8;">
                                    <td style="font-size: 0.75rem;">
                                        <div class="fw-bold" style="color: #8B7355;">{{ articulo.codigo }}</div>
                                        <div class="fw-semibold">{{ articulo.nombre }}{% if articulo.en_oferta %} <span class="badge bg-danger ms-1" style="font-size:0.6rem;">Oferta</span>{% endif %}</div>
                                        {% if articulo.descripcion %}
                                            <small class="text-muted">{{ articulo.descripcion|truncatechars:30 }}</small>
                                        {% endif %}
                                    </td>
                                    <td style="font-size: 0.7rem;">
                                        <span class="badge" style="background: #17a2b8; font-size: 0.65rem;">
                                            {{ articulo.categoria.nombre }}
                                        </span>
                                    </td>
                                    <td style="font-size: 0.7rem; text-align: center;">
                                        {% if articulo.tipo_articulo == 'producto_venta' %}
                                            <span class="badge bg-success" style="font-size: 0.65rem;">Venta</span>
                                        {% elif articulo.tipo_articulo == 'insumo' %}
                                            <span class="badge bg-warning" style="font-size: 0.65rem;">Insumo</span>
                                        {% elif articulo.tipo_articulo == 'produccion' %}
                                            <span class="badge" style="background: #8B7355; font-size: 0.65rem;">Producción</span>
                                        {% elif articulo.tipo_articulo == 'ambos' %}
                                            <span class="badge bg-primary" style="font-size: 0.65rem;">Ambos</span>
                                        {% endif %}
                                    </td>
                                    <td style="font-size: 0.7rem; text-align: center; color: #6c757d;">
                                        {{ articulo.codigo_barras|default:"-" }}
                                    </td>
                                    <td style="font-size: 0.75rem; text-align: right; color: #28a745;">
                                        ${{ articulo.precio_costo|format_price }}
                                    </td>
                                    <td style="font-size: 0.75rem; text-align: right; color: #17a2b8;">
                                        ${{ articulo.precio_venta|format_price }}
                                    </td>
                                    <td style="font-size: 0.8rem; text-align: right; font-weight: 600; color: #6F5B44;">
                                        ${{ articulo.precio_final|format_price }}
                                    </td>
                                    <td style="font-size: 0.7rem; text-align: center;">
                                        {% if articulo.control_stock %}
                                            {% if articulo.stock_total and articulo.stock_total > 0 %}
                                                <span class="badge bg-success" style="font-size: 0.65rem;">{{ articulo.stock_total|floatformat:0 }}</span>
                                            {% else %}
                                                <span class="badge bg-danger" style="font-size: 0.65rem;">Sin Stock</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.65rem;">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td style="font-size: 0.7rem; text-align: center;">
                                        {% if articulo.activo %}
                                            <span class="badge bg-success" style="font-size: 0.65rem;">Activo</span>
                                        {% else %}
                                            <span class="badge bg-danger" style="font-size: 0.65rem;">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td style="text-align: center;">
                                            <a href="{% url 'articulos:articulo_detail' articulo.pk %}" class="btn btn-sm btn-outline-secondary" title="Ver" style="padding:2px 6px; font-size:0.7rem; border-color:#D4C4A8;">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'articulos:articulo_update' articulo.pk %}" class="btn btn-sm btn-outline-secondary" title="Editar" style="padding:2px 6px; font-size:0.7rem; border-color:#D4C4A8;">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'articulos:articulo_delete' articulo.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar" style="padding:2px 6px; font-size:0.7rem; border-color:#D4C4A8;">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-5">
                                        <i class="fas fa-box fa-3x mb-3" style="color: #D4C4A8;"></i>
                                        <h6 style="color: #8B7355;">No hay artículos registrados</h6>
                                        <p style="color: #6c757d; font-size: 0.85rem;">Comienza creando tu primer artículo</p>
                                        <a href="{% url 'articulos:articulo_create' %}" class="btn btn-sm" style="background: #8B7355; color: white;">
                                            <i class="fas fa-plus me-2"></i>Crear Artículo
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    <nav class="mt-3">
                        <ul class="pagination pagination-sm justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if categoria_id %}&categoria={{ categoria_id }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}" style="color: #8B7355; border-color: #D4C4A8;">Anterior</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link" style="background: #8B7355; border-color: #8B7355;">
                                    {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if categoria_id %}&categoria={{ categoria_id }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}" style="color: #8B7355; border-color: #D4C4A8;">Siguiente</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table-compact {
    font-size: 0.75rem;
    line-height: 1.1;
}

.table-compact thead th {
    padding: 8px 6px;
    font-weight: 600;
    background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
    color: white;
    border: none;
    font-size: 0.75rem;
    text-align: left;
    white-space: nowrap;
    line-height: 1.1;
}

.table-compact tbody td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 4px 6px;
    vertical-align: middle;
    line-height: 1.2;
    border: none;
    height: 34px;
}

.table-compact tbody tr {
    height: 34px;
}

.table-compact tbody tr:hover {
    background-color: #F5F1E8;
    transition: background-color 0.2s ease;
}
</style>
{% endblock %}
