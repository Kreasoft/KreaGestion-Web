{% extends "base.html" %}

{% block body_class %}hide-top-bar{% endblock %}

{% block title %}Categorías de Artículos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <!-- Header de la Tarjeta -->
                <div class="card-header" style="background: linear-gradient(135deg, #6C757D 0%, #868E96 100%); border: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tags fa-2x text-white me-3"></i>
                            <div>
                                <h5 class="mb-0 text-white">
                                    Categorías de Artículos
                                </h5>
                                <small class="text-white-50">Gestiona las categorías de tu inventario</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="abrirModalCrear()" style="background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%); border: none; color: white; box-shadow: 0 2px 8px rgba(107, 142, 35, 0.3);">
                                <i class="fas fa-plus me-2"></i> Nueva Categoría
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Estadísticas dentro de la tarjeta -->
                <div class="card-body" style="padding: 1.5rem;">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%); border: none; box-shadow: 0 2px 8px rgba(46, 139, 87, 0.2);">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Total Categorías</h6>
                                            <h4 class="mb-0" style="color: white; font-weight: 700; font-size: 1.5rem;">{{ total_categorias }}</h4>
                                        </div>
                                        <i class="fas fa-tags fa-lg" style="color: rgba(255, 255, 255, 0.6);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); border: none; box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Activas</h6>
                                            <h4 class="mb-0" style="color: white; font-weight: 700; font-size: 1.5rem;">{{ categorias_activas }}</h4>
                                        </div>
                                        <i class="fas fa-check-circle fa-lg" style="color: rgba(255, 255, 255, 0.6);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #DAA520 0%, #FFD700 100%); border: none; box-shadow: 0 2px 8px rgba(218, 165, 32, 0.2);">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Con IVA</h6>
                                            <h4 class="mb-0" style="color: white; font-weight: 700; font-size: 1.5rem;">{{ categorias_con_iva }}</h4>
                                        </div>
                                        <i class="fas fa-percentage fa-lg" style="color: rgba(255, 255, 255, 0.6);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #CD853F 0%, #DEB887 100%); border: none; box-shadow: 0 2px 8px rgba(205, 133, 63, 0.2);">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1" style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Exentas</h6>
                                            <h4 class="mb-0" style="color: white; font-weight: 700; font-size: 1.5rem;">{{ categorias_exentas }}</h4>
                                        </div>
                                        <i class="fas fa-ban fa-lg" style="color: rgba(255, 255, 255, 0.6);"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 py-1 px-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                            <label class="form-check-label" for="selectAll">
                                                <strong>Nombre</strong>
                                            </label>
                                        </div>
                                    </th>
                                    <th class="border-0 py-1 px-2"><strong>Descripción</strong></th>
                                    <th class="border-0 py-1 px-2"><strong>IVA</strong></th>
                                    <th class="border-0 py-1 px-2"><strong>Impuesto Específico</strong></th>
                                    <th class="border-0 py-1 px-2"><strong>Estado</strong></th>
                                    <th class="border-0 py-1 px-2"><strong>Fecha Creación</strong></th>
                                    <th class="border-0 py-1 px-2 text-center"><strong>Acciones</strong></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for categoria in categorias %}
                                <tr class="border-bottom">
                                    <td class="py-1 px-2">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check me-2">
                                                <input class="form-check-input" type="checkbox" value="{{ categoria.id }}">
                                            </div>
                                            <div>
                                                <span class="fw-medium text-dark">{{ categoria.nombre }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-1 px-2">
                                        {% if categoria.descripcion %}
                                            <span class="text-muted small">{{ categoria.descripcion|truncatechars:40 }}</span>
                                        {% else %}
                                            <span class="text-muted small">Sin descripción</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-1 px-2">
                                        {% if categoria.exenta_iva %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-ban me-1"></i>Sin IVA
                                            </span>
                                        {% else %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-percentage me-1"></i>IVA 19%
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-1 px-2">
                                        {% if categoria.impuesto_especifico %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-tag me-1"></i>{{ categoria.impuesto_especifico.nombre }} ({{ categoria.impuesto_especifico.porcentaje }}%)
                                            </span>
                                        {% else %}
                                            <span class="text-muted small">Ninguno</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-1 px-2">
                                        {% if categoria.activa %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Activa
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Inactiva
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-1 px-2">
                                        <span class="text-muted small">{{ categoria.fecha_creacion|date:"d/m/Y" }}</span>
                                    </td>
                                    <td class="py-1 px-2 text-center">
                                        <div class="btn-group" role="group">
                                            <button type="button" 
                                                    class="btn btn-sm" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#categoriaModal"
                                                    data-bs-toggle="tooltip" 
                                                    title="Editar"
                                                    onclick="abrirModalEditar({{ categoria.pk }}, '{{ categoria.nombre }}', '{{ categoria.descripcion }}', {{ categoria.exenta_iva|yesno:"true,false" }}, {{ categoria.impuesto_especifico.id|default:"null" }}, {{ categoria.activa|yesno:"true,false" }})"
                                                    style="border: none; background: none; padding: 4px 8px;">
                                                <i class="fas fa-edit" style="color: #B8860B; font-size: 16px;"></i>
                                            </button>
                                            <a href="{% url 'articulos:categoria_delete' categoria.pk %}" 
                                               class="btn btn-sm" 
                                               data-bs-toggle="tooltip" 
                                               title="Eliminar"
                                               style="border: none; background: none; padding: 4px 8px;">
                                                <i class="fas fa-trash" style="color: #DC143C; font-size: 16px;"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-tags fa-3x mb-3 text-gray-300"></i>
                                            <h5 class="text-gray-600">No hay categorías</h5>
                                            <p class="mb-4">Comienza creando tu primera categoría para organizar tus artículos.</p>
                                            <a href="{% url 'articulos:categoria_create' %}" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Crear Primera Categoría
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Categorías -->
<div class="modal fade" id="categoriaModal" tabindex="-1" aria-labelledby="categoriaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #D4AF37 0%, #F4E4BC 100%); color: #8B4513;">
                <h5 class="modal-title" id="categoriaModalLabel">
                    <i class="fas fa-tags me-2" style="color: #B8860B;"></i>
                    <span id="modalTitulo">Nueva Categoría</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="categoriaForm" method="post" onsubmit="enviarFormulario(event)">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_nombre" class="form-label" style="color: #495057; font-weight: bold;">
                            Nombre
                        </label>
                        <div class="input-group">
                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                <i class="fas fa-tag" style="color: #6c757d;"></i>
                            </div>
                            <input type="text" class="form-control" id="id_nombre" name="nombre" required 
                                   placeholder="Ingrese el nombre de la categoría" style="color: #6c757d; border-left: none;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_descripcion" class="form-label" style="color: #495057; font-weight: bold;">
                            Descripción
                        </label>
                        <div class="input-group">
                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da; align-items: flex-start; padding-top: 12px;">
                                <i class="fas fa-align-left" style="color: #6c757d;"></i>
                            </div>
                            <textarea class="form-control" id="id_descripcion" name="descripcion" rows="3" 
                                      placeholder="Ingrese una descripción (opcional)" style="color: #6c757d; border-left: none;"></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="id_exenta_iva" name="exenta_iva">
                            <label class="form-check-label" for="id_exenta_iva" style="color: #495057; font-weight: bold;">
                                <i class="fas fa-percentage me-1" style="color: #6B8E23;"></i>Exenta de IVA
                            </label>
                            <div class="form-text" style="color: #6c757d;">Si está marcado, los artículos de esta categoría no tendrán IVA (19%)</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_impuesto_especifico" class="form-label" style="color: #495057; font-weight: bold;">
                            Impuesto Específico
                        </label>
                        <div class="input-group">
                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                <i class="fas fa-receipt" style="color: #6c757d;"></i>
                            </div>
                            <select class="form-select" id="id_impuesto_especifico" name="impuesto_especifico" style="border-left: none;">
                                <option value="">Seleccione un impuesto específico (opcional)</option>
                                {% for impuesto in impuestos_especificos %}
                                    <option value="{{ impuesto.id }}">{{ impuesto.nombre }} ({{ impuesto.porcentaje }}%)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-text" style="color: #6c757d;">Seleccione un impuesto específico si aplica para esta categoría</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="id_activa" name="activa" checked>
                            <label class="form-check-label" for="id_activa" style="color: #495057; font-weight: bold;">
                                <i class="fas fa-check-circle me-1" style="color: #6B8E23;"></i>Activa
                            </label>
                            <div class="form-text" style="color: #6c757d;">La categoría estará disponible para usar</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #4A90A4 0%, #6BB6C7 100%); border: none; color: white;">
                        <i class="fas fa-save me-1"></i>
                        <span id="modalBoton">Crear Categoría</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidad para seleccionar/deseleccionar todos
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Modal cleanup when hidden
    const categoriaModal = document.getElementById('categoriaModal');
    if (categoriaModal) {
        categoriaModal.addEventListener('hidden.bs.modal', function() {
            // Reset form
            document.getElementById('categoriaForm').reset();
            document.getElementById('id_activa').checked = true;
            
            // Reset modal title and button
            document.getElementById('modalTitulo').textContent = 'Nueva Categoría';
            document.getElementById('modalBoton').textContent = 'Crear Categoría';
            document.getElementById('categoriaForm').action = '{% url "articulos:categoria_create" %}';
            
            // Remove any backdrop issues
            document.body.classList.remove('modal-open');
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        });
    }
});

// Funciones para el modal
function abrirModalCrear() {
    document.getElementById('modalTitulo').textContent = 'Nueva Categoría';
    document.getElementById('modalBoton').textContent = 'Crear Categoría';
    document.getElementById('categoriaForm').action = '{% url "articulos:categoria_create" %}';
    
    // Limpiar formulario
    document.getElementById('categoriaForm').reset();
    document.getElementById('id_activa').checked = true;
}

function abrirModalEditar(id, nombre, descripcion, exentaIva, impuestoEspecifico, activa) {
    document.getElementById('modalTitulo').textContent = 'Editar Categoría';
    document.getElementById('modalBoton').textContent = 'Actualizar Categoría';
    document.getElementById('categoriaForm').action = '{% url "articulos:categoria_update" 0 %}'.replace('0', id);
    
    // Llenar formulario
    document.getElementById('id_nombre').value = nombre;
    document.getElementById('id_descripcion').value = descripcion;
    document.getElementById('id_exenta_iva').checked = exentaIva;
    document.getElementById('id_impuesto_especifico').value = impuestoEspecifico || '';
    document.getElementById('id_activa').checked = activa;
    
    // Asegurar que el modal se abra
    var modal = new bootstrap.Modal(document.getElementById('categoriaModal'));
    modal.show();
}

function enviarFormulario(event) {
    event.preventDefault();
    
    const form = document.getElementById('categoriaForm');
    const formData = new FormData(form);
    const url = form.action;
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoriaModal'));
            modal.hide();
            
            // Recargar la página para mostrar los cambios
            location.reload();
        } else {
            // Mostrar errores si los hay
            return response.text().then(html => {
                // Crear un elemento temporal para parsear el HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Buscar errores de formulario
                const errors = tempDiv.querySelectorAll('.errorlist');
                if (errors.length > 0) {
                    alert('Por favor corrija los errores en el formulario.');
                } else {
                    alert('Error al procesar el formulario. Intente nuevamente.');
                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión. Intente nuevamente.');
    });
}
</script>
{% endblock %}
