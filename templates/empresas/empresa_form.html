{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block body_class %}hide-top-bar{% endblock %}

{% block content %}
<div class="container py-4">
	<div class="row justify-content-center">
		<div class="col-md-10">
			<div class="card shadow">
				<div class="card-header bg-primary text-white">
					<h4 class="m-0">
						<i class="fas fa-building me-2"></i>
						{% if empresa %}
							Editar Empresa: {{ empresa.nombre }}
						{% else %}
							Nueva Empresa
						{% endif %}
					</h4>
				</div>
				<div class="card-body">
					{% if form.errors %}
						<div class="alert alert-danger">
							<strong>Por favor corrija los siguientes errores:</strong>
							<ul class="mb-0">
								{% for field, errors in form.errors.items %}
									{% for error in errors %}
										<li>{{ field|title }}: {{ error }}</li>
									{% endfor %}
								{% endfor %}
							</ul>
						</div>
					{% endif %}
					
					{% crispy form %}
					
					<!-- Vista previa del logo -->
					{% if empresa and empresa.logo %}
					<div class="mt-3">
						<label class="form-label">Logo actual:</label>
						<div class="text-center">
							<img src="{{ empresa.logo.url }}" alt="Logo actual" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
						</div>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Vista previa del logo
document.getElementById('id_logo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('logo-preview');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
});

// Formateo automático del RUT
document.getElementById('id_rut').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9kK]/g, '');
    
    if (value.length > 1) {
        // Separar número y dígito verificador
        let numero = value.slice(0, -1);
        let dv = value.slice(-1).toUpperCase();
        
        // Formatear número con puntos
        let numeroFormateado = '';
        for (let i = 0; i < numero.length; i++) {
            if (i > 0 && (numero.length - i) % 3 === 0) {
                numeroFormateado += '.';
            }
            numeroFormateado += numero[i];
        }
        
        // Combinar número formateado con dígito verificador
        value = numeroFormateado + '-' + dv;
    }
    
    e.target.value = value;
});
</script>
{% endblock %}

					<form method="post" enctype="multipart/form-data">
						{% csrf_token %}
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label class="form-label">Nombre de la Empresa *</label>
								<input type="text" name="nombre" class="form-control" value="{{ empresa.nombre|default:'' }}" required>
							</div>
							<div class="col-md-6 mb-3">
								<label class="form-label">RUT *</label>
								<input type="text" name="rut" class="form-control" value="{{ empresa.rut|default:'' }}" required>
							</div>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Razón Social *</label>
							<input type="text" name="razon_social" class="form-control" value="{{ empresa.razon_social|default:'' }}" required>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Giro Comercial *</label>
							<input type="text" name="giro" class="form-control" value="{{ empresa.giro|default:'' }}" required>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Dirección *</label>
							<textarea name="direccion" class="form-control" rows="2" required>{{ empresa.direccion|default:'' }}</textarea>
						</div>
						
						<div class="row">
							<div class="col-md-4 mb-3">
								<label class="form-label">Comuna *</label>
								<input type="text" name="comuna" class="form-control" value="{{ empresa.comuna|default:'' }}" required>
							</div>
							<div class="col-md-4 mb-3">
								<label class="form-label">Ciudad *</label>
								<input type="text" name="ciudad" class="form-control" value="{{ empresa.ciudad|default:'' }}" required>
							</div>
							<div class="col-md-4 mb-3">
								<label class="form-label">Región *</label>
								<input type="text" name="region" class="form-control" value="{{ empresa.region|default:'' }}" required>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label class="form-label">Teléfono *</label>
								<input type="tel" name="telefono" class="form-control" value="{{ empresa.telefono|default:'' }}" required>
							</div>
							<div class="col-md-6 mb-3">
								<label class="form-label">Email *</label>
								<input type="email" name="email" class="form-control" value="{{ empresa.email|default:'' }}" required>
							</div>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Sitio Web</label>
							<input type="url" name="sitio_web" class="form-control" value="{{ empresa.sitio_web|default:'' }}">
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label class="form-label">Régimen Tributario *</label>
								<select name="regimen_tributario" class="form-select" required>
									<option value="">Seleccione...</option>
									<option value="19" {% if empresa.regimen_tributario == '19' %}selected{% endif %}>19% IVA</option>
									<option value="exento" {% if empresa.regimen_tributario == 'exento' %}selected{% endif %}>Exento de IVA</option>
									<option value="otro" {% if empresa.regimen_tributario == 'otro' %}selected{% endif %}>Otro</option>
								</select>
							</div>
							<div class="col-md-6 mb-3">
								<label class="form-label">Estado *</label>
								<select name="estado" class="form-select" required>
									<option value="">Seleccione...</option>
									<option value="activa" {% if empresa.estado == 'activa' %}selected{% endif %}>Activa</option>
									<option value="inactiva" {% if empresa.estado == 'inactiva' %}selected{% endif %}>Inactiva</option>
									<option value="suspendida" {% if empresa.estado == 'suspendida' %}selected{% endif %}>Suspendida</option>
								</select>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label class="form-label">Color Primario</label>
								<input type="color" name="color_primario" class="form-control form-control-color" value="{{ empresa.color_primario|default:'#2C3E50' }}">
							</div>
							<div class="col-md-6 mb-3">
								<label class="form-label">Color Secundario</label>
								<input type="color" name="color_secundario" class="form-control form-control-color" value="{{ empresa.color_secundario|default:'#E74C3C' }}">
							</div>
						</div>
						
						<div class="mb-3">
							<label class="form-label">Logo</label>
							<input type="file" name="logo" class="form-control" accept="image/*">
							{% if empresa.logo %}
							<small class="form-text text-muted">Logo actual: {{ empresa.logo.name }}</small>
							{% endif %}
						</div>
						
						<div class="d-flex justify-content-between">
							<a href="{% if empresa %}{% url 'empresas:empresa_detail' empresa.id %}{% else %}{% url 'empresas:empresa_list' %}{% endif %}" class="btn btn-outline-dark">
								Cancelar
							</a>
							<button type="submit" class="btn btn-dark">
								{% if empresa %}Actualizar{% else %}Crear{% endif %} Empresa
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
