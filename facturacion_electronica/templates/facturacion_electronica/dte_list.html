{% extends 'base.html' %}
{% load static %}
{% load format_filters %}

{% block title %}Libro de Ventas Electrónico - {{ request.empresa.nombre }}{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para la tabla Estilo Piedra y Variables */
    :root {
        --color-piedra-primario: #8B7355;
        --color-piedra-secundario: #6F5B44;
        --color-piedra-claro: #E8DCC8;
        --color-piedra-fondo: #FAFAF8;
        /* Gradiente CLARO original del sistema */
        --gradient-piedra: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --color-piedra-texto: #5D4037;
        --color-piedra-borde: #D4C4A8;
    }

    body {
        background: #FAFAF8 !important;
        min-height: 100vh;
    }

    .card-piedra {
        border: 2px solid #E8DCC8; 
        border-radius: 15px; 
        overflow: hidden; 
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.15);
    }

    .table-piedra {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Poppins', sans-serif;
    }

    .table-piedra thead th {
        background: #FDFCFB;
        border-bottom: 2px solid #E8DCC8;
        color: #8B7355;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 1px;
        padding: 12px 15px;
    }

    .table-piedra tbody tr {
        height: 32px;
        transition: all 0.2s ease;
    }

    /* Efecto Zebra */
    .table-piedra tbody tr:nth-of-type(odd) {
        background-color: rgba(245, 241, 232, 0.3);
    }

    .table-piedra tbody tr:nth-of-type(even) {
        background-color: white;
    }

    .table-piedra tbody tr:hover {
        background-color: #F5F1E8 !important;
    }

    .table-piedra tbody td {
        padding: 5px 15px;
        border-bottom: 1px solid #F5F1E8;
        vertical-align: middle;
        font-size: 0.85rem;
        color: #4A5568;
    }

    .btn-action-piedra {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 1px solid #D4C4A8;
        border-radius: 6px;
        color: #8B7355;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-action-piedra:hover {
        background: #8B7355;
        color: white !important;
        transform: scale(1.1);
    }

    .badge-premium {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 15px; background: #FAFAF8; min-height: 100vh;">
    <div class="card card-piedra">
        <!-- Header con Estilo Piedra Premium (Color Claro) -->
        <div class="card-header" style="background: var(--gradient-piedra); border-bottom: 3px solid var(--color-piedra-borde); padding: 15px 20px;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-book me-3" style="font-size: 2.2rem; color: var(--color-piedra-texto); opacity: 0.8;"></i>
                        <div>
                            <h2 class="mb-0 fw-light" style="font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); letter-spacing: -1px; font-size: 1.8rem;">
                                Libro de <span class="fw-bold">Ventas</span>
                            </h2>
                            <div style="font-size: 0.85rem; font-family: 'Poppins', sans-serif; color: var(--color-piedra-texto); opacity: 0.8; margin-top: 2px;">
                                Registro de documentos emitidos (Grupo E)
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-sm me-2" 
                            style="background: rgba(255, 255, 255, 0.6); border: 1px solid #D4C4A8; color: #6F5B44; font-weight: 600; font-size: 0.75rem;"
                            onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                    <button class="btn btn-sm" 
                            style="background: #8B7355; border: 1px solid #8B7355; color: white; font-weight: 600; font-size: 0.75rem;"
                            onclick="exportarExcel()">
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card-body" style="background: #FAFAF8; border-bottom: 2px solid #E8DCC8; padding: 15px;">
            <form method="get" action="{% url 'facturacion_electronica:dte_list' %}" class="row g-2">
                <div class="col-md-2">
                    <label class="form-label fw-bold" style="font-size: 0.75rem; color: #6F5B44;">
                        <i class="fas fa-calendar me-1"></i>Desde
                    </label>
                    <input type="date" name="fecha_desde" class="form-control form-control-sm" value="{{ fecha_desde }}" style="border: 1px solid #D4C4A8;">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold" style="font-size: 0.75rem; color: #6F5B44;">
                        <i class="fas fa-calendar me-1"></i>Hasta
                    </label>
                    <input type="date" name="fecha_hasta" class="form-control form-control-sm" value="{{ fecha_hasta }}" style="border: 1px solid #D4C4A8;">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold" style="font-size: 0.75rem; color: #6F5B44;">
                        <i class="fas fa-file-invoice me-1"></i>Tipo DTE
                    </label>
                    <select name="tipo_dte" class="form-select form-select-sm" style="border: 1px solid #D4C4A8;">
                        <option value="">Todos</option>
                        {% for key, value in tipos_dte.items %}
                        <option value="{{ key }}" {% if tipo_dte == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold" style="font-size: 0.75rem; color: #6F5B44;">
                        <i class="fas fa-user me-1"></i>Cliente
                    </label>
                    <select name="cliente" class="form-select form-select-sm" style="border: 1px solid #D4C4A8;">
                        <option value="">Todos</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre|truncatechars:20 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold" style="font-size: 0.75rem; color: #6F5B44;">
                        <i class="fas fa-check-circle me-1"></i>Estado SII
                    </label>
                    <select name="estado" class="form-select form-select-sm" style="border: 1px solid #D4C4A8;">
                        {% for key, value in estados_sii %}
                        <option value="{{ key }}" {% if estado == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; border: none; font-weight: 600; font-size: 0.75rem;">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{% url 'facturacion_electronica:dte_list' %}" class="btn btn-sm btn-outline-secondary" style="font-size: 0.75rem;">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
            </form>
        </div>

        <!-- Estadísticas -->
        <div class="card-body" style="background: #FAFAF8; padding: 15px;">
            <!-- Stats Principales -->
            <!-- Stats Principales -->
            <div class="row g-3 mb-3 justify-content-center">
                <div class="col-md-3">
                    <div class="card card-stats-pastel-terracota card-stats-pastel-text shadow-sm border-0" style="border-radius: 12px; position: relative; overflow: hidden; min-height: 100px;">
                        <div class="card-body p-3" style="position: relative; z-index: 2;">
                            <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; opacity: 0.8;">Total Documentos</div>
                            <h3 class="mb-0 fw-bold" style="color: #2D3748;">{{ stats.total_documentos|default:0 }}</h3>
                        </div>
                        <div style="position: absolute; right: -5px; top: 0; bottom: 0; display: flex; align-items: center; font-size: 110px; opacity: 0.1; color: #e39d7e; pointer-events: none; z-index: 1;">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-stats-pastel-azul card-stats-pastel-text shadow-sm border-0" style="border-radius: 12px; position: relative; overflow: hidden; min-height: 100px;">
                        <div class="card-body p-3" style="position: relative; z-index: 2;">
                            <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; opacity: 0.8;">Total Neto</div>
                            <h3 class="mb-0 fw-bold" style="color: #2D3748;">${{ stats.total_neto|format_miles }}</h3>
                        </div>
                        <div style="position: absolute; right: -5px; top: 0; bottom: 0; display: flex; align-items: center; font-size: 110px; opacity: 0.1; color: #1e3c72; pointer-events: none; z-index: 1;">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-stats-pastel-rosa card-stats-pastel-text shadow-sm border-0" style="border-radius: 12px; position: relative; overflow: hidden; min-height: 100px;">
                        <div class="card-body p-3" style="position: relative; z-index: 2;">
                            <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; opacity: 0.8;">Total IVA</div>
                            <h3 class="mb-0 fw-bold" style="color: #2D3748;">${{ stats.total_iva|format_miles }}</h3>
                        </div>
                        <div style="position: absolute; right: -5px; top: 0; bottom: 0; display: flex; align-items: center; font-size: 110px; opacity: 0.1; color: #d63384; pointer-events: none; z-index: 1;">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-stats-pastel-azul card-stats-pastel-text shadow-sm border-0" style="border-radius: 12px; position: relative; overflow: hidden; min-height: 100px;">
                        <div class="card-body p-3" style="position: relative; z-index: 2;">
                            <div class="card-title text-uppercase mb-1" style="font-size: 0.65rem; letter-spacing: 1px; font-weight: 700; opacity: 0.8;">Total General</div>
                            <h3 class="mb-0 fw-bold" style="color: #2D3748;">${{ stats.total_general|format_miles }}</h3>
                        </div>
                        <div style="position: absolute; right: -5px; top: 0; bottom: 0; display: flex; align-items: center; font-size: 110px; opacity: 0.1; color: #1e3c72; pointer-events: none; z-index: 1;">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats por Tipo -->
            {% if stats_por_tipo %}
            <div class="row g-2 justify-content-center">
                {% for stat in stats_por_tipo %}
                <div class="col-md-2 col-6">
                    <div class="card shadow-sm" style="border: 1px solid #E8DCC8; border-radius: 8px; background: white; text-align: center; padding: 10px;">
                        <div style="font-size: 0.6rem; color: #6F5B44; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">
                            {% if stat.tipo_dte == '33' %}FACTURA
                            {% elif stat.tipo_dte == '34' %}FACT. EXENTA
                            {% elif stat.tipo_dte == '39' %}BOLETA
                            {% elif stat.tipo_dte == '41' %}BOL. EXENTA
                            {% elif stat.tipo_dte == '52' %}GUÍA
                            {% elif stat.tipo_dte == '56' %}NOTA DÉBITO
                            {% elif stat.tipo_dte == '61' %}NOTA CRÉDITO
                            {% else %}{{ stat.tipo_dte|upper }}{% endif %}
                        </div>
                        <div style="font-size: 1rem; font-weight: 700; color: #8B7355; line-height: 1.2;">{{ stat.cantidad }}</div>
                        <div style="font-size: 0.65rem; color: #A67C52;">${{ stat.total|format_miles }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Tabla -->
        <div class="card-body p-0">
            <div class="table-responsive" style="background: white; border-radius: 0 0 15px 15px;">
                <table class="table-piedra mb-0">
                    <thead>
                        <tr>
                            <th style="width: 5%;">Tipo</th>
                            <th style="width: 8%;">Folio</th>
                            <th style="width: 8%;">Fecha</th>
                            <th style="width: 25%;">Cliente</th>
                            <th style="width: 8%;">RUT</th>
                            <th class="text-end" style="width: 10%;">Neto</th>
                            <th class="text-end" style="width: 10%;">IVA</th>
                            <th class="text-end" style="width: 10%;">Total</th>
                            <th class="text-center" style="width: 8%;">Estado SII</th>
                            <th class="text-center" style="width: 10%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dte in dtes %}
                        <tr>
                            <td>
                                {% if dte.tipo_dte == '33' %}
                                <span class="badge badge-premium" style="background: rgba(72, 187, 120, 0.15); color: #2F855A;" title="Factura Electrónica">FE</span>
                                {% elif dte.tipo_dte == '34' %}
                                <span class="badge badge-premium" style="background: rgba(72, 187, 120, 0.15); color: #2F855A;" title="Factura Exenta">FEX</span>
                                {% elif dte.tipo_dte == '39' %}
                                <span class="badge badge-premium" style="background: linear-gradient(135deg, #B8956A 0%, #A67C52 100%); color: white;" title="Boleta Electrónica">BE</span>
                                {% elif dte.tipo_dte == '41' %}
                                <span class="badge badge-premium" style="background: linear-gradient(135deg, #B8956A 0%, #A67C52 100%); color: white;" title="Boleta Exenta">BEX</span>
                                {% elif dte.tipo_dte == '52' %}
                                <span class="badge badge-premium" style="background: linear-gradient(135deg, #A0826D 0%, #8B6F5C 100%); color: white;" title="Guía de Despacho">GD</span>
                                {% elif dte.tipo_dte == '56' %}
                                <span class="badge badge-premium" style="background: rgba(229, 62, 62, 0.15); color: #C53030;" title="Nota de Débito">ND</span>
                                {% elif dte.tipo_dte == '61' %}
                                <span class="badge badge-premium" style="background: rgba(236, 201, 75, 0.2); color: #744210;" title="Nota de Crédito">NC</span>
                                {% else %}
                                <span class="badge badge-premium" style="background: #E2E8F0; color: #4A5568;">{{ dte.get_tipo_dte_display }}</span>
                                {% endif %}
                            </td>
                            <td><span class="fw-bold" style="color: #6F5B44;">{{ dte.folio }}</span></td>
                            <td class="small opacity-75">{{ dte.fecha_emision|date:"d/m/Y" }}</td>
                            <td>{{ dte.razon_social_receptor|truncatechars:35 }}</td>
                            <td class="small opacity-75">{{ dte.rut_receptor }}</td>
                            <td class="text-end" style="color: #6F5B44;">${{ dte.monto_neto|format_miles }}</td>
                            <td class="text-end" style="color: #A67C52;">${{ dte.monto_iva|format_miles }}</td>
                            <td class="text-end fw-bold" style="color: #8B7355;">${{ dte.monto_total|format_miles }}</td>
                            <td class="text-center">
                                {% if dte.estado_sii == 'aceptado' %}
                                <span class="badge bg-success" style="font-size: 0.65rem;">Aceptado</span>
                                {% elif dte.estado_sii == 'enviado' %}
                                <span class="badge bg-info" style="font-size: 0.65rem;">Enviado</span>
                                {% elif dte.estado_sii == 'rechazado' %}
                                <span class="badge bg-danger" style="font-size: 0.65rem;">Rechazado</span>
                                {% elif dte.estado_sii == 'pendiente' %}
                                <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">Pendiente</span>
                                {% elif dte.estado_sii == 'anulado' %}
                                <span class="badge bg-secondary" style="font-size: 0.65rem;">Anulado</span>
                                {% else %}
                                <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ dte.get_estado_sii_display|default:"-" }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    {# Ver documento #}
                                    {% if dte.tipo_dte == '52' and dte.transferencias.first %}
                                    <a href="{% url 'inventario:transferencia_imprimir_guia' dte.transferencias.first.pk %}"
                                        class="btn-action-piedra" target="_blank" title="Ver guía">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    {% elif dte.tipo_dte == '61' and dte.notacredito_id %}
                                    <a href="{% url 'facturacion_electronica:ver_notacredito_electronica' dte.notacredito_id %}"
                                        class="btn-action-piedra" target="_blank" title="Ver Nota de Crédito">
                                        <i class="fas fa-file-contract"></i>
                                    </a>
                                    {% else %}
                                    <a href="{% url 'facturacion_electronica:ver_factura_electronica' dte.pk %}"
                                        class="btn-action-piedra" target="_blank" title="Ver DTE">
                                        <i class="fas fa-file-invoice"></i>
                                    </a>
                                    {% endif %}

                                    {# Enviar al SII #}
                                    {% if dte.estado_sii != 'aceptado' and dte.estado_sii != 'rechazado' and dte.estado_sii != 'anulado' %}
                                    <a href="{% url 'facturacion_electronica:enviar_dte' dte.pk %}"
                                        class="btn-action-piedra" title="Enviar al SII" style="color: #D69E2E; border-color: #F6E05E;">
                                        <i class="fas fa-paper-plane"></i>
                                    </a>
                                    {% endif %}

                                    {# Regenerar XML (Boletas y Guías sin XML o con error) #}
                                    {% if dte.tipo_dte == '39' or dte.tipo_dte == '52' %}
                                    {% if dte.estado_sii != 'aceptado' and dte.estado_sii != 'rechazado' and dte.estado_sii != 'anulado' %}
                                    <a href="{% url 'facturacion_electronica:regenerar_xml_dte' dte.pk %}"
                                        class="btn-action-piedra" title="Regenerar XML (si está vacío o con error)">
                                        <i class="fas fa-sync-alt"></i>
                                    </a>
                                    {% endif %}
                                    {% endif %}

                                     {# Imprimir #}
                                     <a href="{% url 'facturacion_electronica:ver_factura_electronica' dte.pk %}?auto=1"
                                        class="btn-action-piedra" target="_blank" title="Imprimir DTE">
                                         <i class="fas fa-print"></i>
                                     </a>
                                 </div>
                             </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="py-4">
                                    <i class="fas fa-inbox fa-3x mb-3" style="color: #D4A574; opacity: 0.5;"></i>
                                    <p style="color: #8B7355; font-size: 1rem; font-weight: 500;">No se encontraron documentos</p>
                                    <p style="color: #A0AEC0; font-size: 0.85rem;">Intenta ajustar los filtros de búsqueda</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function exportarExcel() {
        Swal.fire({
            title: 'Exportar a Excel',
            text: 'Esta funcionalidad está en desarrollo. Pronto podrás descargar el reporte completo.',
            icon: 'info',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#8B7355',
            background: '#fff',
            customClass: {
                popup: 'rounded-4 shadow-lg border-0'
            }
        });
    }
</script>
{% endblock %}