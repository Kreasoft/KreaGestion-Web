{% extends 'base.html' %}

{% block title %}Detalle DTE - {{ dte.folio }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-file-alt"></i> Detalle del DTE
                {% if dte.tipo_dte == '33' %}<span class="badge bg-success">FAC</span>
                {% elif dte.tipo_dte == '39' %}<span class="badge bg-primary">BOL</span>
                {% elif dte.tipo_dte == '52' %}<span class="badge bg-info">GUI</span>
                {% elif dte.tipo_dte == '61' %}<span class="badge bg-warning text-dark">NCR</span>
                {% elif dte.tipo_dte == '56' %}<span class="badge bg-danger">NDB</span>
                {% endif %}
            </h2>
            <p class="text-muted">{{ dte.get_tipo_documento_display }} - Folio: {{ dte.folio }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'facturacion_electronica:dte_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5>Información del Documento</h5>
            <table class="table">
                <tr>
                    <th style="width: 30%;">Tipo de Documento:</th>
                    <td>{{ dte.get_tipo_documento_display }}</td>
                </tr>
                <tr>
                    <th>Folio:</th>
                    <td><strong>{{ dte.folio }}</strong></td>
                </tr>
                <tr>
                    <th>Fecha Emisión:</th>
                    <td>{{ dte.fecha_emision|date:"d/m/Y" }}</td>
                </tr>
                <tr>
                    <th>Cliente:</th>
                    <td>{{ dte.razon_social_receptor }} ({{ dte.rut_receptor }})</td>
                </tr>
                <tr>
                    <th>Monto Neto:</th>
                    <td>${{ dte.monto_neto|floatformat:0 }}</td>
                </tr>
                <tr>
                    <th>Monto IVA:</th>
                    <td>${{ dte.monto_iva|floatformat:0 }}</td>
                </tr>
                <tr>
                    <th>Monto Total:</th>
                    <td><strong>${{ dte.monto_total|floatformat:0 }}</strong></td>
                </tr>
                <tr>
                    <th>Estado SII:</th>
                    <td>
                        {% if dte.estado_sii == 'aceptado' %}
                        <span class="badge bg-success">Aceptado</span>
                        {% elif dte.estado_sii == 'rechazado' %}
                        <span class="badge bg-danger">Rechazado</span>
                        {% elif dte.estado_sii == 'pendiente' %}
                        <span class="badge bg-warning">Pendiente</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ dte.estado_sii }}</span>
                        {% endif %}
                    </td>
                </tr>
            </table>

            {% if dte.venta %}
            <hr>
            <h5>Venta Asociada</h5>
            <p>
                <a href="{% url 'ventas:venta_html' dte.venta.pk %}" class="btn btn-sm btn-info">
                    Ver Venta #{{ dte.venta.numero_venta }}
                </a>
            </p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Obtener parámetros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const autoPrint = urlParams.get('auto');
    const autoClose = urlParams.get('autoclose');
    const autoCloseDelay = parseInt(urlParams.get('autoclose_delay')) || 3000;
    const returnUrl = urlParams.get('return_url');

    console.log('[DTE AUTO] Parámetros detectados:', {
        autoPrint: autoPrint,
        autoClose: autoClose,
        autoCloseDelay: autoCloseDelay,
        returnUrl: returnUrl
    });

    // Función para volver a la URL de retorno o cerrar ventana
    function volverAlOrigen() {
        // Si es una ventana popup (abierta con window.open), cerrarla
        if (window.opener) {
            console.log('[DTE AUTO] Es un popup - Cerrando ventana...');
            window.close();
        } else if (returnUrl) {
            // Si es la ventana principal, redirigir
            console.log('[DTE AUTO] Volviendo a:', returnUrl);
            window.location.href = returnUrl;
        } else {
            console.log('[DTE AUTO] No hay URL de retorno, volviendo atrás');
            window.history.back();
        }
    }

    // Si auto=1, imprimir automáticamente al cargar
    if (autoPrint === '1') {
        console.log('[DTE AUTO] Imprimiendo automáticamente...');

        // Esperar un momento para que la página cargue completamente
        setTimeout(function () {
            window.print();
            console.log('[DTE AUTO] Impresión Iniciada');

            // Si autoclose=1, cerrar después de imprimir
            if (autoClose === '1') {
                console.log('[DTE AUTO] Programando cierre automático en', autoCloseDelay, 'ms');

                // Mostrar contador regresivo
                let countDown = Math.floor(autoCloseDelay / 1000);
                const interval = setInterval(() => {
                    countDown--;
                    if (countDown <= 0) {
                        clearInterval(interval);
                    }
                    console.log('[DTE AUTO] Volviendo en', countDown, 'segundos...');
                }, 1000);

                // Volver después del delay
                setTimeout(volverAlOrigen, autoCloseDelay);
            }
        }, 1000);
    }

    // Detectar cuando se cierra el diálogo de impresión
    window.onafterprint = function () {
        console.log('[DTE AUTO] Diálogo de impresión cerrado');

        // Si está configurado autoclose, ya se programó el cierre
        // Este es solo un log para debugging
        if (autoClose === '1') {
            console.log('[DTE AUTO] Esperando', autoCloseDelay, 'ms antes de volver...');
        }
    };

    // Detectar si el usuario cancela la impresión (opcional)
    let beforePrintFired = false;
    window.onbeforeprint = function () {
        beforePrintFired = true;
        console.log('[DTE AUTO] Iniciando impresión...');
    };
</script>
{% endblock %}