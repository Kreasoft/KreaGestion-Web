{% extends "base.html" %}
{% load static %}
{% load format_filters %}
{% load humanize %}

{% block title %}Cuenta Corriente - {{ proveedor.nombre }} - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    /* VARIABLES ESTILO PIEDRA PREMIUM */
    :root {
        --stone-primary: #8B7355;
        --stone-secondary: #6F5B44;
        --stone-light: #E8DCC8;
        --stone-bg: #FAFAF8;
        --stone-gradient: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
        --stone-text: #5D4037;
        --stone-card-bg: #FFFFFF;
        --stone-success: #43A047;
        --stone-danger: #e53935;
        --stone-warning: #FB8C00;
        --stone-info: #039BE5;
    }

    body {
        background-color: var(--stone-bg) !important;
        color: var(--stone-text);
        font-family: 'Poppins', sans-serif;
    }

    /* CARD PRINCIPAL */
    .single-card-container {
        background: var(--stone-card-bg);
        border: 1px solid var(--stone-light);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(139, 115, 85, 0.1);
        overflow: hidden;
        margin-top: 1.5rem;
        margin-bottom: 2rem;
    }

    /* HEADER PREMIUM */
    .stone-header-premium {
        background: var(--stone-gradient);
        padding: 1.25rem 2rem;
        border-bottom: 1px solid var(--stone-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .header-icon-box {
        width: 52px; height: 52px; 
        background: rgba(255, 255, 255, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 14px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(139, 115, 85, 0.15);
        color: var(--stone-secondary);
        font-size: 1.5rem;
    }

    .header-text h1 { color: var(--stone-text); font-size: 1.5rem; margin: 0; letter-spacing: -0.5px; line-height: 1.1; font-weight: 300; }
    .header-text p { color: #795548; font-size: 0.9rem; margin: 0; font-weight: 500; opacity: 0.9; }

    /* ESTADISTICAS */
    .stone-stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stone-stat-card {
        background: #FFFFFF;
        border: 1px solid var(--stone-light);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stone-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.1);
    }
    .stat-content { display: flex; flex-direction: column; }
    .stat-label { font-size: 0.75rem; color: #8D6E63; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.25rem; font-weight: 700; color: var(--stone-text); }
    .stat-icon { font-size: 1.5rem; opacity: 0.2; color: var(--stone-primary); }

    /* INFO CARD */
    .stone-info-card {
        background: linear-gradient(to right, #FAF9F6, #FFFFFF);
        border: 1px solid var(--stone-light);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .info-title { font-size: 0.9rem; font-weight: 700; color: var(--stone-secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #E8DCC8; padding-bottom: 0.5rem; }
    .info-item { margin-bottom: 0.5rem; font-size: 0.9rem; }
    .info-label { font-weight: 600; color: #5D4037; }
    .info-val { color: #795548; }

    /* BOTONES */
    .btn-action-primary { 
        background: var(--stone-primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; 
        display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; cursor: pointer;
    }
    .btn-action-primary:hover { background: var(--stone-secondary); color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2); }
    
    .btn-action-secondary { 
        background: white; color: var(--stone-primary); border: 1px solid var(--stone-primary); padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; 
        display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; cursor: pointer;
    }
    .btn-action-secondary:hover { background: #fdfbf7; transform: translateY(-1px); }

    /* TABLA PIEDRA PREMIUM */
    .table-responsive { border-radius: 12px; overflow: hidden; border: 1px solid #E8DCC8; }
    .table-piedra { width: 100%; border-collapse: separate; border-spacing: 0; }
    .table-piedra thead th {
        background: #FDFCFB; border-bottom: 2px solid #E8DCC8; color: #8B7355; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 12px 15px; text-align: left;
    }
    .table-piedra tbody tr { transition: all 0.2s; }
    .table-piedra tbody tr:hover { background-color: #F8F6F2; }
    .table-piedra tbody td { 
        padding: 10px 15px; vertical-align: middle; font-size: 0.85rem; color: #4A5568; border-bottom: 1px solid #F0EAE0;
    }
    .table-piedra tbody tr:last-child td { border-bottom: none; }

    /* ICONOS */
    .btn-icon {
        width: 30px; height: 30px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; border: none; background: transparent; transition: all 0.2s;
    }
    .btn-icon-pay { color: #2E7D32; } .btn-icon-pay:hover { background: #E8F5E9; }
    .btn-icon-list { color: #F57F17; } .btn-icon-list:hover { background: #FFFDE7; }

    /* BADGES */
    .badge-stone { padding: 0.35em 0.8em; border-radius: 6px; font-weight: 600; font-size: 0.7rem; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-stone-success { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    .badge-stone-warning { background: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
    .badge-stone-danger { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
    .badge-stone-info { background: #E1F5FE; color: #0277BD; border: 1px solid #B3E5FC; }
    .badge-stone-secondary { background: #ECEFF1; color: #546E7A; border: 1px solid #CFD8DC; }

    /* FORM & MODAL UTILS */
    .form-control-stone, .form-select-stone {
        border-radius: 8px; border: 1px solid #D4C4A8; padding: 0.5rem 0.8rem; font-size: 0.9rem; background-color: #FAFAF8; width: 100%; color: var(--stone-text); transition: all 0.2s;
    }
    .modal-content-stone { border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
    .modal-header-stone { background: var(--stone-gradient); padding: 1.25rem; border-bottom: 1px solid #E8DCC8; }
    .modal-header-stone .modal-title { color: var(--stone-text); font-weight: 700; font-size: 1.1rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="single-card-container">
        
        <!-- HEADER PREMIUM -->
        <div class="stone-header-premium">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'tesoreria:cuenta_corriente_proveedor_list' %}" class="btn-action-secondary" title="Volver">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="header-icon-box">
                    <i class="fas fa-user-tag"></i>
                </div>
                <div class="header-text">
                    <h1>{{ proveedor.nombre }}</h1>
                    <p>Detalle de Cuenta Corriente Proveedor</p>
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn-action-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>

        <div class="card-body p-4">

            <!-- INFO PROVIDER & SUMMARY -->
            <div class="row">
                <div class="col-md-8">
                    <div class="stone-info-card h-100">
                        <div class="info-title"><i class="fas fa-building"></i> Información del Proveedor</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-item"><span class="info-label">RUT:</span> <span class="info-val">{{ proveedor.get_rut_formateado|default:proveedor.rut }}</span></div>
                                <div class="info-item"><span class="info-label">Teléfono:</span> <span class="info-val">{{ proveedor.telefono|default:"-" }}</span></div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item"><span class="info-label">Email:</span> <span class="info-val">{{ proveedor.email|default:"-" }}</span></div>
                                <div class="info-item"><span class="info-label">Dirección:</span> <span class="info-val">{{ proveedor.direccion|default:"-" }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                     <!-- ESTADISTICAS MINI -->
                     <div class="stone-stat-card mb-2">
                        <div class="stat-content">
                            <span class="stat-label">Pendiente</span>
                            <span class="stat-value text-danger format-number" data-value="{{ stats.total_pendiente|default:0 }}">$</span>
                        </div>
                        <i class="fas fa-clock stat-icon text-danger"></i>
                    </div>
                    <div class="stone-stat-card">
                        <div class="stat-content">
                            <span class="stat-label">Vencido</span>
                            <span class="stat-value text-danger format-number" data-value="{{ stats.total_vencido|default:0 }}">$</span>
                        </div>
                        <i class="fas fa-exclamation-triangle stat-icon text-danger"></i>
                    </div>
                </div>
            </div>

            <!-- ESTADISTICAS GRID -->
            <div class="stone-stats-container mt-3">
                <div class="stone-stat-card">
                    <div class="stat-content">
                        <span class="stat-label">Total Documentos</span>
                        <span class="stat-value">{{ stats.total_documentos|default:0|format_miles }}</span>
                    </div>
                    <i class="fas fa-file-invoice stat-icon"></i>
                </div>
                <div class="stone-stat-card">
                    <div class="stat-content">
                        <span class="stat-label">Pago Parcial</span>
                        <span class="stat-value text-info format-number" data-value="{{ stats.total_parcial|default:0 }}">$</span>
                    </div>
                    <i class="fas fa-coins stat-icon text-info"></i>
                </div>
                <!-- Add more stats if needed -->
            </div>

            <!-- TABLA -->
            <div class="table-responsive mt-4">
                <table class="table-piedra">
                    <thead>
                        <tr>
                            <th width="10%">N° Doc</th>
                            <th width="10%">Tipo</th>
                            <th width="12%">Emisión</th>
                            <th width="12%">Vencimiento</th>
                            <th width="12%" class="text-end">Total</th>
                            <th width="12%" class="text-end">Pagado</th>
                            <th width="12%" class="text-end">Saldo</th>
                            <th width="10%" class="text-center">Estado</th>
                            <th width="10%" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for documento in documentos %}
                        <tr>
                            <td><span class="fw-bold text-dark">{{ documento.numero_documento }}</span></td>
                            <td><span class="badge badge-stone badge-stone-secondary">{{ documento.get_tipo_documento_display }}</span></td>
                            <td>{{ documento.fecha_emision|date:"d/m/Y" }}</td>
                            <td class="{% if documento.fecha_vencimiento and documento.fecha_vencimiento < today and documento.saldo_pendiente > 0 %}text-danger fw-bold{% endif %}">
                                {{ documento.fecha_vencimiento|date:"d/m/Y"|default:"-" }}
                            </td>
                            <td class="text-end fw-bold format-number" data-value="{{ documento.total_documento|floatformat:0 }}">$</td>
                            <td class="text-end fw-bold text-success format-number" data-value="{{ documento.monto_pagado|default:0|floatformat:0 }}">$</td>
                            <td class="text-end fw-bold text-danger format-number" data-value="{{ documento.saldo_pendiente|floatformat:0 }}">$</td>
                            <td class="text-center">
                                {% if documento.estado_pago == 'pagada' %}
                                    <span class="badge badge-stone badge-stone-success">Pagada</span>
                                {% elif documento.estado_pago == 'vencida' %}
                                    <span class="badge badge-stone badge-stone-danger">Vencida</span>
                                {% elif documento.estado_pago == 'parcial' %}
                                    <span class="badge badge-stone badge-stone-warning">Parcial</span>
                                {% else %}
                                    <span class="badge badge-stone badge-stone-info">Pendiente</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    {% if documento.saldo_pendiente > 0 %}
                                    <button class="btn-icon btn-icon-pay" 
                                            onclick="registrarPago({{ documento.id }}, '{{ documento.numero_documento }}', {{ documento.saldo_pendiente|stringformat:'f' }})"
                                            title="Registrar Pago">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn-icon btn-icon-list" 
                                            onclick="verPagos({{ documento.id }})"
                                            title="Ver Historial">
                                        <i class="fas fa-history"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <i class="fas fa-file-invoice fa-3x mb-3" style="color: #E8DCC8;"></i>
                                <h6 class="text-muted fw-bold">No hay documentos registrados</h6>
                                <p class="text-muted small">Este proveedor no tiene movimientos en cuenta corriente.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// FORMATTER UTILS
function formatearNumero(numero) {
    const num = Math.round(parseFloat(numero) || 0);
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.format-number').forEach(element => {
        const value = element.dataset.value;
        if (value) {
            const cleanValue = value.toString().replace(/[^\d.-]/g, '');
            element.textContent = '$' + formatearNumero(cleanValue);
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// LOGICA DE PAGOS (Replicada de Account List pero adaptada a Detail)
let formasPagoGlobal = [];
let formasPagoSeleccionadas = [];

function registrarPago(documentoId, numeroDocumento, saldoPendiente) {
    formasPagoSeleccionadas = [];
    fetch('/tesoreria/obtener-formas-pago/')
        .then(res => res.json())
        .then(data => {
            formasPagoGlobal = data.formas_pago || [];
            mostrarModalPago(documentoId, numeroDocumento, saldoPendiente);
        });
}

function mostrarModalPago(documentoId, numeroDocumento, saldoPendiente) {
    const saldoFormateado = formatearNumero(saldoPendiente);
    
    Swal.fire({
        title: `<h5 style="color:#6F5B44">Registrar Pago Doc. ${numeroDocumento}</h5>`,
        html: `
            <div class="text-start">
                <div class="alert alert-warning mb-3"><strong>Saldo Pendiente:</strong> $${saldoFormateado}</div>
                <div id="formasPagoContainer" class="mb-2"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="agregarFormaPago()">+ Agregar Forma Pago</button>
                <div class="mb-2 fw-bold">Total a Pagar: <span id="totalPagar" class="text-success">$0</span></div>
                <textarea id="observacionesPago" class="form-control-stone" placeholder="Observaciones"></textarea>
                <input type="hidden" id="documentoIdPago" value="${documentoId}">
                <input type="hidden" id="saldoPendientePago" value="${saldoPendiente}">
            </div>
        `,
        width: 600,
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        confirmButtonColor: '#8B7355',
        didOpen: () => agregarFormaPago(),
        preConfirm: () => validarYEnviarPago()
    });
}

function agregarFormaPago() {
    const container = document.getElementById('formasPagoContainer');
    const div = document.createElement('div');
    div.className = 'row g-2 mb-2 align-items-center forma-pago-item';
    
    div.innerHTML = `
        <div class="col-6">
            <select class="form-select-stone forma-pago-select">
                <option value="">Forma de Pago...</option>
                ${formasPagoGlobal.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('')}
            </select>
        </div>
        <div class="col-4">
            <input type="number" class="form-control-stone monto-pago" placeholder="Monto" onchange="calcularTotal()">
        </div>
        <div class="col-2"><button class="btn btn-sm btn-outline-danger" onclick="this.closest('.row').remove(); calcularTotal()">X</button></div>
    `;
    container.appendChild(div);
    formasPagoSeleccionadas.push({});
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.monto-pago').forEach(input => total += parseFloat(input.value) || 0);
    document.getElementById('totalPagar').innerText = `$${formatearNumero(total)}`;
}

function validarYEnviarPago() {
    const docId = document.getElementById('documentoIdPago').value;
    const saldo = parseFloat(document.getElementById('saldoPendientePago').value);
    const obs = document.getElementById('observacionesPago').value;
    
    const formas = [];
    let total = 0;
    document.querySelectorAll('.forma-pago-item').forEach(item => {
        const fid = item.querySelector('.forma-pago-select').value;
        const mont = parseFloat(item.querySelector('.monto-pago').value) || 0;
        if (fid && mont > 0) {
            formas.push({forma_pago_id: fid, monto: mont});
            total += mont;
        }
    });

    if(formas.length === 0) return Swal.showValidationMessage('Agregue un pago');
    if(total > saldo) return Swal.showValidationMessage('Excede saldo pendiente');

    return fetch('/tesoreria/registrar-pago/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
        body: JSON.stringify({documento_id: docId, formas_pago: formas, observaciones: obs})
    })
    .then(r => r.json())
    .then(d => {
        if(!d.success) throw new Error(d.message);
        return d;
    })
    .catch(e => Swal.showValidationMessage(e.message));
}

function verPagos(docId) {
    fetch(`/tesoreria/historial-pagos/${docId}/`)
    .then(r => r.json())
    .then(d => {
        let html = '<table class="table table-sm text-start"><thead><tr><th>Fecha</th><th>Monto</th><th>Tipo</th></tr></thead><tbody>';
        d.pagos.forEach(p => html += `<tr><td>${p.fecha}</td><td>$${formatearNumero(p.monto)}</td><td>${p.forma_pago}</td></tr>`);
        html += '</tbody></table>';
        Swal.fire({title: 'Historial Pagos', html: html, confirmButtonColor: '#8B7355'});
    });
}
</script>
{% endblock %}
