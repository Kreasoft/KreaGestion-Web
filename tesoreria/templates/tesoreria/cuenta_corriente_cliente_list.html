{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Cuenta Corriente Clientes - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_head %}
<style>
    /* Fondo terroso suave como en libro de ventas */
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid" style="margin-top: 20px;">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden;">

                <!-- HEADER PRINCIPAL -->
                <div class="card-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border: none; border-bottom: 2px solid #D4C4A8; padding: 10px 15px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-tie fa-lg me-2" style="color: #6F5B44;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 1.1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #6F5B44;">
                                    Cuenta Corriente Clientes
                                </h5>
                                <small style="font-size: 0.75rem; font-family: 'Poppins', sans-serif; color: #8B7355;">
                                    Gesti√≥n de cuentas corrientes y saldos de clientes
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm me-2" style="background: rgba(111, 91, 68, 0.15); border: 1px solid rgba(111, 91, 68, 0.25); color: #6F5B44; padding: 4px 8px; font-size: 0.7rem;" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                            </button>
                            <button type="button" class="btn btn-sm me-2" style="background: rgba(139, 115, 85, 0.15); border: 1px solid rgba(139, 115, 85, 0.25); color: #8B7355; padding: 4px 8px; font-size: 0.7rem;" onclick="Swal.fire({icon: 'info', title: 'Pr√≥ximamente', text: 'Gesti√≥n de documentos de clientes en desarrollo', confirmButtonColor: '#8B7355'})">
                                <i class="fas fa-list me-1"></i> Ver Todos
                            </button>
                            <button type="button" class="btn btn-sm" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 4px 8px; font-size: 0.7rem;" data-bs-toggle="modal" data-bs-target="#modalDocumentoCliente">
                                <i class="fas fa-plus me-1"></i> Nuevo Documento
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 12px; background: #FAFAF8;">

                    <!-- ESTAD√çSTICAS PRINCIPALES -->
                    <div class="row mb-2">
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-1 p-2 position-relative">
                                <div class="stat-value" style="font-size: 1.1rem;">{{ stats.total_documentos|default:0 }}</div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Facturas</div>
                                <i class="fas fa-file-invoice stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-2 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_pendiente|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Pendiente</div>
                                <i class="fas fa-clock stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-3 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_pagado|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Pagado</div>
                                <i class="fas fa-check-circle stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-4 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_parcial|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Pago Parcial</div>
                                <i class="fas fa-coins stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FILTROS -->
                    <div class="filter-section">
                        <form method="get">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold" style="font-size: 0.7rem; color: #6F5B44;">
                                        <i class="fas fa-search me-1"></i>Buscar Cliente
                                    </label>
                                    <input type="text" name="search" class="form-control form-control-sm"
                                           placeholder="üîç Buscar por nombre, RUT..." value="{{ request.GET.search }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold" style="font-size: 0.7rem; color: #6F5B44;">
                                        <i class="fas fa-filter me-1"></i>Estado
                                    </label>
                                    <select name="estado" class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="con_deuda" {% if request.GET.estado == "con_deuda" %}selected{% endif %}>Con Deuda</option>
                                        <option value="al_dia" {% if request.GET.estado == "al_dia" %}selected{% endif %}>Al D√≠a</option>
                                        <option value="vencido" {% if request.GET.estado == "vencido" %}selected{% endif %}>Vencido</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold" style="font-size: 0.7rem; color: #6F5B44;">
                                        <i class="fas fa-calendar me-1"></i>Per√≠odo
                                    </label>
                                    <select name="periodo" class="form-select form-select-sm">
                                        <option value="">Todo</option>
                                        <option value="mes_actual" {% if request.GET.periodo == "mes_actual" %}selected{% endif %}>Mes Actual</option>
                                        <option value="mes_anterior" {% if request.GET.periodo == "mes_anterior" %}selected{% endif %}>Mes Anterior</option>
                                        <option value="trimestre" {% if request.GET.periodo == "trimestre" %}selected{% endif %}>√öltimo Trimestre</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex gap-2">
                                    <button type="submit" class="btn btn-filter flex-grow-1">
                                        <i class="fas fa-filter me-1"></i>Filtrar
                                    </button>
                                    <a href="{% url 'tesoreria:cuenta_corriente_cliente_list' %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-times"></i>
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Lista de Cuentas Corrientes -->
                    <div class="table-responsive" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <table class="table table-hover table-compact mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 4%;">#</th>
                                    <th style="width: 10%;">N¬∞ Factura</th>
                                    <th style="width: 18%;">Cliente</th>
                                    <th style="width: 10%;">Fecha</th>
                                    <th style="width: 12%;">Monto Total</th>
                                    <th style="width: 12%;">Total Pagado</th>
                                    <th style="width: 12%;">Saldo Pendiente</th>
                                    <th style="width: 10%;">Estado</th>
                                    <th class="text-center" style="width: 12%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for movimiento in page_obj %}
                                <tr style="border-bottom: 1px solid #F5F1E8;">
                                    <td style="font-size: 0.7rem;" class="text-muted">{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</td>
                                    <td style="font-size: 0.7rem;">
                                        <strong>{{ movimiento.venta.numero_venta|default:"-" }}</strong>
                                    </td>
                                    <td style="font-size: 0.7rem;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user text-muted me-2"></i>
                                            <div>
                                                <strong>{{ movimiento.cuenta_corriente.cliente.nombre }}</strong><br>
                                                <small class="text-muted">{{ movimiento.cuenta_corriente.cliente.rut }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="font-size: 0.7rem;">{{ movimiento.fecha_movimiento|date:"d/m/Y H:i" }}</td>
                                    <td style="font-size: 0.7rem; font-weight: 600; color: #6F5B44;" class="format-number" data-value="{{ movimiento.monto_display }}">$</td>
                                    <td style="font-size: 0.7rem; font-weight: 600; color: #28a745;" class="format-number" data-value="{{ movimiento.total_pagado }}">$</td>
                                    <td style="font-size: 0.7rem; font-weight: 700; color: #dc3545;" class="format-number" data-value="{{ movimiento.saldo_pendiente_factura }}">$</td>
                                    <td style="font-size: 0.7rem;">
                                        {% if movimiento.estado_pago == 'pagado' %}
                                            <span class="badge bg-success" style="font-size: 0.6rem;">Pagado</span>
                                        {% elif movimiento.estado_pago == 'parcial' %}
                                            <span class="badge bg-warning" style="font-size: 0.6rem;">Parcial</span>
                                        {% elif movimiento.estado_pago == 'pendiente' %}
                                            <span class="badge bg-danger" style="font-size: 0.6rem;">Pendiente</span>
                                        {% else %}
                                            <span class="badge bg-info" style="font-size: 0.6rem;">{{ movimiento.estado_pago|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            {% if movimiento.venta %}
                                            <a href="/ventas/vales/{{ movimiento.venta.id }}/html/" target="_blank"
                                               class="btn btn-sm btn-action btn-outline-primary"
                                               title="Ver Factura">
                                                <i class="fas fa-file-invoice"></i>
                                            </a>
                                            {% endif %}
                                            
                                            {% if movimiento.total_pagado > 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-action btn-outline-info btn-ver-pagos"
                                                    title="Ver Pagos"
                                                    data-movimiento-id="{{ movimiento.pk }}"
                                                    data-numero-factura="{{ movimiento.venta.numero_venta|default:'Sin n√∫mero' }}">
                                                <i class="fas fa-list-alt"></i>
                                            </button>
                                            {% endif %}
                                            
                                            {% if movimiento.estado_pago != 'pagado' %}
                                            {% load l10n %}
                                            <button type="button"
                                                    class="btn btn-sm btn-action btn-outline-success btn-pago-movimiento"
                                                    title="Registrar Pago"
                                                    data-movimiento-id="{{ movimiento.pk }}"
                                                    data-numero-factura="{{ movimiento.venta.numero_venta|default:'Sin n√∫mero' }}"
                                                    data-saldo-pendiente="{{ movimiento.saldo_pendiente_factura|unlocalize }}">
                                                <i class="fas fa-dollar-sign"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="fas fa-inbox fa-2x mb-2" style="color: #D4A574;"></i>
                                        <p style="color: #8B7355; font-size: 0.8rem;">No hay facturas a cr√©dito registradas</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINACI√ìN -->
                    {% if page_obj.has_other_pages %}
                    <div class="d-flex justify-content-center mt-2">
                        <nav aria-label="Paginaci√≥n">
                            <ul class="pagination pagination-sm mb-0" style="font-size: 0.75rem;">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">¬´</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">‚Äπ</a>
                                </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; font-size: 0.7rem; padding: 4px 8px;">
                                        {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">‚Ä∫</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">¬ª</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Paleta terrosa para tarjetas de estad√≠sticas */
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-card-1 {
        background: linear-gradient(135deg, #D4A574 0%, #C19461 100%);
    }

    .stat-card-2 {
        background: linear-gradient(135deg, #B8956A 0%, #A67C52 100%);
    }

    .stat-card-3 {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
    }

    .stat-card-4 {
        background: linear-gradient(135deg, #A0826D 0%, #8B6F5C 100%);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: rgba(255,255,255,0.9);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .stat-icon {
        font-size: 2rem;
        color: rgba(255,255,255,0.3);
        position: absolute;
        right: 15px;
        bottom: 15px;
    }

    .filter-section {
        background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .table-compact {
        font-size: 0.75rem;
        line-height: 1.1;
    }

    .table-compact thead th {
        padding: 4px 2px;
        font-weight: 600;
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        border: none;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        line-height: 1.1;
    }

    .table-compact tbody td {
        padding: 2px 3px;
        vertical-align: middle;
        line-height: 1.2;
        font-size: 0.7rem;
    }

    .table-compact tbody tr {
        height: 28px;
    }

    .btn-filter {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        color: white;
        padding: 8px 20px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.3);
        color: white;
    }

    .btn-action {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 6px;
    }
</style>

<!-- Modal para Crear Documento Cliente -->
<div class="modal fade" id="modalDocumentoCliente" tabindex="-1" aria-labelledby="modalDocumentoClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border: 2px solid #E8DCC8; border-radius: 15px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-bottom: 2px solid #D4C4A8;">
                <h5 class="modal-title" id="modalDocumentoClienteLabel" style="color: #6F5B44; font-weight: 600;">
                    <i class="fas fa-file-invoice me-2"></i>Nuevo Documento Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background: #FAFAF8; padding: 20px;">
                <form id="formDocumentoCliente">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-user me-1"></i>Cliente *
                            </label>
                            <select name="cliente" id="clienteSelect" class="form-select" required>
                                <option value="">Seleccione un cliente...</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-file me-1"></i>Tipo Documento *
                            </label>
                            <select name="tipo_documento" class="form-select" required>
                                <option value="factura">Factura</option>
                                <option value="boleta">Boleta</option>
                                <option value="nota_credito">Nota de Cr√©dito</option>
                                <option value="nota_debito">Nota de D√©bito</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-hashtag me-1"></i>N¬∞ Documento *
                            </label>
                            <input type="text" name="numero_documento" class="form-control" placeholder="Ej: 12345" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-calendar me-1"></i>Fecha Emisi√≥n *
                            </label>
                            <input type="date" name="fecha_emision" class="form-control" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-calendar-check me-1"></i>Fecha Vencimiento
                            </label>
                            <input type="date" name="fecha_vencimiento" class="form-control">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-dollar-sign me-1"></i>Total *
                            </label>
                            <input type="number" name="total" class="form-control" placeholder="0" step="1" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label fw-bold" style="color: #6F5B44; font-size: 0.9rem;">
                                <i class="fas fa-comment me-1"></i>Observaciones
                            </label>
                            <textarea name="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Cancelar
                        </button>
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white;">
                            <i class="fas fa-save me-1"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event listener para botones de pago de movimientos
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-pago-movimiento')) {
            const btn = e.target.closest('.btn-pago-movimiento');
            const movimientoId = btn.dataset.movimientoId;
            const numeroFactura = btn.dataset.numeroFactura;
            const saldoPendiente = parseInt(btn.dataset.saldoPendiente, 10);
            
            registrarPagoMovimiento(movimientoId, numeroFactura, saldoPendiente);
        }
        
        // Event listener para ver pagos
        if (e.target.closest('.btn-ver-pagos')) {
            const btn = e.target.closest('.btn-ver-pagos');
            const movimientoId = btn.dataset.movimientoId;
            const numeroFactura = btn.dataset.numeroFactura;
            
            verPagosMovimiento(movimientoId, numeroFactura);
        }
    });
    
    // Cargar clientes al abrir el modal
    const modalCliente = document.getElementById('modalDocumentoCliente');
    if (modalCliente) {
        modalCliente.addEventListener('show.bs.modal', function(event) {
            // Si no se est√° editando (se abri√≥ desde el bot√≥n "Nuevo"), resetear
            if (!event.relatedTarget || !event.relatedTarget.dataset.editing) {
                documentoEditandoId = null;
                document.getElementById('modalDocumentoClienteLabel').innerHTML = '<i class="fas fa-file-invoice me-2"></i>Nuevo Documento Cliente';
                // Limpiar formulario
                document.getElementById('formDocumentoCliente').reset();
            }
            cargarClientes();
        });
    }
    
    // Manejar env√≠o del formulario
    const formCliente = document.getElementById('formDocumentoCliente');
    if (formCliente) {
        formCliente.addEventListener('submit', function(e) {
            e.preventDefault();
            guardarDocumentoCliente();
        });
    }
});

function cargarClientes() {
    const select = document.getElementById('clienteSelect');
    select.innerHTML = '<option value="">Cargando...</option>';
    
    fetch('/tesoreria/obtener-clientes/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            select.innerHTML = '<option value="">Seleccione un cliente...</option>';
            
            if (data.clientes && data.clientes.length > 0) {
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = `${cliente.nombre}${cliente.rut ? ' - ' + cliente.rut : ''}`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">No hay clientes disponibles</option>';
            }
        })
        .catch(error => {
            console.error('Error completo:', error);
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'No se pudieron cargar los clientes',
                confirmButtonColor: '#8B7355'
            });
        });
}

function guardarDocumentoCliente() {
    const form = document.getElementById('formDocumentoCliente');
    const formData = new FormData(form);
    
    // Validar que se haya seleccionado un cliente
    if (!formData.get('cliente')) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenci√≥n',
            text: 'Debe seleccionar un cliente',
            confirmButtonColor: '#8B7355'
        });
        return;
    }
    
    // Determinar si es creaci√≥n o edici√≥n
    const isEditing = documentoEditandoId !== null;
    const url = isEditing 
        ? `/tesoreria/editar-documento-cliente/${documentoEditandoId}/`
        : '/tesoreria/crear-documento-cliente/';
    const accion = isEditing ? 'Actualizando' : 'Creando';
    
    // Mostrar loading
    Swal.fire({
        title: 'Guardando...',
        text: `${accion} documento`,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Convertir FormData a JSON
    const data = {
        cliente: formData.get('cliente'),
        tipo_documento: formData.get('tipo_documento'),
        numero_documento: formData.get('numero_documento'),
        fecha_emision: formData.get('fecha_emision'),
        fecha_vencimiento: formData.get('fecha_vencimiento'),
        total: formData.get('total'),
        observaciones: formData.get('observaciones')
    };
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '¬°√âxito!',
                text: data.message,
                confirmButtonColor: '#8B7355',
                timer: 2000
            }).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('modalDocumentoCliente')).hide();
                documentoEditandoId = null; // Reset
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                confirmButtonColor: '#8B7355'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `Error al ${isEditing ? 'actualizar' : 'crear'} el documento`,
            confirmButtonColor: '#8B7355'
        });
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Formatear n√∫meros con punto como separador de miles
function formatearNumero(numero) {
    const num = Math.round(parseFloat(numero) || 0);
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Formatear n√∫meros al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.format-number').forEach(element => {
        const value = element.dataset.value;
        const prefix = element.dataset.prefix || '';
        const currentText = element.textContent.trim();
        
        if (value) {
            const cleanValue = value.toString().replace(/[^\d.-]/g, '');
            const finalPrefix = currentText.startsWith('$') ? '$' : prefix;
            element.textContent = finalPrefix + formatearNumero(cleanValue);
        }
    });
});

let formasPagoGlobalCliente = [];
let formasPagoSeleccionadasCliente = [];

// Registrar pago de cliente
function registrarPagoCliente(btn) {
    const documentoId = btn.dataset.docId;
    const numeroDocumento = btn.dataset.docNumero;
    const saldoRaw = btn.dataset.docSaldo.toString().replace(/[^\d.-]/g, '');
    const saldoPendiente = parseFloat(saldoRaw) || 0;
    
    formasPagoSeleccionadasCliente = [];
    
    // Obtener formas de pago disponibles
    fetch('/tesoreria/obtener-formas-pago/')
        .then(response => response.json())
        .then(data => {
            formasPagoGlobalCliente = data.formas_pago || [];
            mostrarModalPagoCliente(documentoId, numeroDocumento, saldoPendiente);
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar las formas de pago',
                confirmButtonColor: '#8B7355'
            });
        });
}

function mostrarModalPagoCliente(documentoId, numeroDocumento, saldoPendiente) {
    const saldoFormateado = formatearNumero(saldoPendiente);
    
    const html = `
        <div class="text-start">
            <div class="mb-3 p-3" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 8px; border: 2px solid #D4C4A8;">
                <p class="mb-2"><strong style="color: #6F5B44;">Documento:</strong> <span class="fw-bold">${numeroDocumento}</span></p>
                <p class="mb-0"><strong style="color: #6F5B44;">Saldo Pendiente:</strong> <span class="text-danger fw-bold" style="font-size: 1.2rem;">$${saldoFormateado}</span></p>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Formas de Pago:</label>
                <div id="formasPagoContainerCliente">
                    <!-- Aqu√≠ se agregar√°n las formas de pago -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="agregarFormaPagoCliente()">
                    <i class="fas fa-plus me-1"></i> Agregar Forma de Pago
                </button>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Total a Pagar:</label>
                <input type="text" id="totalPagarCliente" class="form-control fw-bold text-success" value="$0" readonly>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Observaciones:</label>
                <textarea id="observacionesPagoCliente" class="form-control" rows="2" placeholder="Observaciones del pago..."></textarea>
            </div>
            
            <input type="hidden" id="documentoIdPagoCliente" value="${documentoId}">
            <input type="hidden" id="saldoPendientePagoCliente" value="${saldoPendiente}">
        </div>
    `;
    
    Swal.fire({
        title: '<span style="color: #6F5B44;"><i class="fas fa-dollar-sign me-2"></i>Registrar Pago</span>',
        html: html,
        width: 700,
        showCancelButton: true,
        confirmButtonColor: '#8B7355',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-save me-1"></i> Registrar Pago',
        cancelButtonText: 'Cancelar',
        customClass: {
            popup: 'modal-pago-terroso',
            title: 'modal-pago-title'
        },
        didOpen: () => {
            // Agregar estilos al modal
            const style = document.createElement('style');
            style.textContent = `
                .modal-pago-terroso {
                    border: 3px solid #D4C4A8 !important;
                }
                .modal-pago-title {
                    background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%) !important;
                    padding: 15px !important;
                    border-radius: 8px 8px 0 0 !important;
                    border-bottom: 2px solid #D4C4A8 !important;
                }
            `;
            document.head.appendChild(style);
            agregarFormaPagoCliente(); // Agregar primera forma de pago por defecto
        },
        preConfirm: () => {
            return validarYEnviarPagoCliente();
        }
    });
}

function agregarFormaPagoCliente() {
    const container = document.getElementById('formasPagoContainerCliente');
    const index = formasPagoSeleccionadasCliente.length;
    
    const formaPagoHtml = `
        <div class="card mb-2 forma-pago-item-cliente" data-index="${index}">
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" style="font-size: 0.8rem;">Forma de Pago</label>
                        <select class="form-select form-select-sm forma-pago-select-cliente" data-index="${index}">
                            <option value="">Seleccione...</option>
                            ${formasPagoGlobalCliente.map(fp => `<option value="${fp.id}">${fp.nombre}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" style="font-size: 0.8rem;">Monto</label>
                        <input type="number" class="form-control form-control-sm monto-pago-cliente" data-index="${index}" 
                               min="1" step="1" placeholder="0" onchange="calcularTotalCliente()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="eliminarFormaPagoCliente(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formaPagoHtml);
    formasPagoSeleccionadasCliente.push({ forma_pago_id: null, monto: 0 });
}

function eliminarFormaPagoCliente(index) {
    const item = document.querySelector(`.forma-pago-item-cliente[data-index="${index}"]`);
    if (item) {
        item.remove();
        formasPagoSeleccionadasCliente[index] = null;
        calcularTotalCliente();
    }
}

function calcularTotalCliente() {
    let total = 0;
    document.querySelectorAll('.monto-pago-cliente').forEach(input => {
        const monto = parseFloat(input.value) || 0;
        total += monto;
    });
    
    document.getElementById('totalPagarCliente').value = `$${formatearNumero(total)}`;
    return total;
}

function validarYEnviarPagoCliente() {
    const documentoId = document.getElementById('documentoIdPagoCliente').value;
    const saldoPendiente = parseFloat(document.getElementById('saldoPendientePagoCliente').value);
    const observaciones = document.getElementById('observacionesPagoCliente').value;
    
    // Recopilar formas de pago
    const formasPago = [];
    let totalPago = 0;
    
    document.querySelectorAll('.forma-pago-item-cliente').forEach(item => {
        const index = item.dataset.index;
        const formaPagoId = item.querySelector('.forma-pago-select-cliente').value;
        const monto = parseFloat(item.querySelector('.monto-pago-cliente').value) || 0;
        
        if (formaPagoId && monto > 0) {
            formasPago.push({
                forma_pago_id: formaPagoId,
                monto: monto
            });
            totalPago += monto;
        }
    });
    
    // Validaciones
    if (formasPago.length === 0) {
        Swal.showValidationMessage('Debe agregar al menos una forma de pago');
        return false;
    }
    
    if (totalPago <= 0) {
        Swal.showValidationMessage('El monto total debe ser mayor a 0');
        return false;
    }
    
    if (totalPago > saldoPendiente) {
        Swal.showValidationMessage(`El monto total ($${formatearNumero(totalPago)}) excede el saldo pendiente ($${formatearNumero(saldoPendiente)})`);
        return false;
    }
    
    // Enviar pago
    Swal.fire({
        title: 'Procesando...',
        text: 'Registrando pago',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/tesoreria/registrar-pago-cliente/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            documento_id: documentoId,
            formas_pago: formasPago,
            observaciones: observaciones
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '¬°Pago Registrado!',
                text: data.message,
                confirmButtonColor: '#8B7355',
                timer: 2000
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'No se pudo registrar el pago',
                confirmButtonColor: '#8B7355'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al procesar el pago',
            confirmButtonColor: '#8B7355'
        });
    });
    
    return false; // Evitar que se cierre el modal autom√°ticamente
}

// Ver pagos de cliente
function verPagosCliente(btn) {
    const documentoId = btn.dataset.docId;
    const numeroDocumento = btn.dataset.docNumero;
    
    Swal.fire({
        title: 'Cargando...',
        text: 'Obteniendo historial de pagos',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch(`/tesoreria/historial-pagos-cliente/${documentoId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.pagos && data.pagos.length > 0) {
                let html = `<div class="text-start"><p><strong>Documento:</strong> ${numeroDocumento}</p>`;
                html += '<table class="table table-sm table-bordered mt-3">';
                html += '<thead><tr><th>Fecha</th><th>Monto</th><th>Forma Pago</th></tr></thead><tbody>';
                
                data.pagos.forEach(pago => {
                    html += `<tr>
                        <td>${pago.fecha}</td>
                        <td>$${formatearNumero(pago.monto)}</td>
                        <td>${pago.forma_pago}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<p class="mt-3"><strong>Total Pagado:</strong> $${formatearNumero(data.total_pagado)}</p></div>`;
                
                Swal.fire({
                    title: 'Historial de Pagos',
                    html: html,
                    width: 600,
                    confirmButtonColor: '#8B7355'
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin Pagos',
                    text: 'No hay pagos registrados para este documento',
                    confirmButtonColor: '#8B7355'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo obtener el historial de pagos',
                confirmButtonColor: '#8B7355'
            });
        });
}

// ========== FUNCIONES PARA PAGOS DE MOVIMIENTOS DE CUENTA CORRIENTE ==========

let formasPagoMovimiento = [];
let formasPagoGlobalMovimiento = [];

// Registrar pago de movimiento de cuenta corriente
function registrarPagoMovimiento(movimientoId, numeroFactura, montoTotal) {
    formasPagoMovimiento = [];
    
    // Obtener formas de pago disponibles
    fetch('/tesoreria/obtener-formas-pago/')
        .then(response => response.json())
        .then(data => {
            formasPagoGlobalMovimiento = data.formas_pago || [];
            mostrarModalPagoMovimiento(movimientoId, numeroFactura, montoTotal);
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar las formas de pago',
                confirmButtonColor: '#8B7355'
            });
        });
}

function mostrarModalPagoMovimiento(movimientoId, numeroFactura, montoTotal) {
    // Asegurar que sea un n√∫mero v√°lido
    const montoNumerico = parseFloat(montoTotal) || 0;
    const montoFormateado = formatearNumero(montoNumerico);
    
    const html = `
        <div class="text-start">
            <div class="mb-3 p-3" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 8px; border: 2px solid #D4C4A8;">
                <p class="mb-2"><strong style="color: #6F5B44;">Factura:</strong> <span class="fw-bold">${numeroFactura}</span></p>
                <p class="mb-0"><strong style="color: #6F5B44;">Monto Total:</strong> <span class="text-danger fw-bold" style="font-size: 1.2rem;">$${montoFormateado}</span></p>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Formas de Pago:</label>
                <div id="formasPagoContainerMovimiento">
                    <!-- Aqu√≠ se agregar√°n las formas de pago -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="agregarFormaPagoMovimiento()">
                    <i class="fas fa-plus me-1"></i> Agregar Forma de Pago
                </button>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Total a Pagar:</label>
                <input type="text" id="totalPagarMovimiento" class="form-control fw-bold text-success" value="$0" readonly>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Observaciones:</label>
                <textarea id="observacionesPagoMovimiento" class="form-control" rows="2" placeholder="Observaciones del pago..."></textarea>
            </div>
            
            <input type="hidden" id="movimientoIdPago" value="${movimientoId}">
            <input type="hidden" id="montoTotalPago" value="${montoTotal}">
        </div>
    `;
    
    Swal.fire({
        title: '<span style="color: #6F5B44;"><i class="fas fa-dollar-sign me-2"></i>Registrar Pago de Factura</span>',
        html: html,
        width: 700,
        showCancelButton: true,
        confirmButtonColor: '#8B7355',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-save me-1"></i> Registrar Pago',
        cancelButtonText: 'Cancelar',
        customClass: {
            popup: 'modal-pago-terroso',
            title: 'modal-pago-title'
        },
        didOpen: () => {
            agregarFormaPagoMovimiento(); // Agregar primera forma de pago por defecto
        },
        preConfirm: () => {
            return validarYEnviarPagoMovimiento();
        }
    });
}

function agregarFormaPagoMovimiento() {
    const container = document.getElementById('formasPagoContainerMovimiento');
    const index = formasPagoMovimiento.length;
    
    const formaPagoHtml = `
        <div class="card mb-2 forma-pago-item-movimiento" data-index="${index}">
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" style="font-size: 0.8rem;">Forma de Pago</label>
                        <select class="form-select form-select-sm forma-pago-select-movimiento" data-index="${index}">
                            <option value="">Seleccione...</option>
                            ${formasPagoGlobalMovimiento.map(fp => `<option value="${fp.id}">${fp.nombre}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" style="font-size: 0.8rem;">Monto</label>
                        <input type="number" class="form-control form-control-sm monto-pago-movimiento" data-index="${index}" 
                               min="1" step="1" placeholder="0" onchange="calcularTotalMovimiento()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="eliminarFormaPagoMovimiento(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formaPagoHtml);
    formasPagoMovimiento.push({ forma_pago_id: null, monto: 0 });
}

function eliminarFormaPagoMovimiento(index) {
    const item = document.querySelector(`.forma-pago-item-movimiento[data-index="${index}"]`);
    if (item) {
        item.remove();
        formasPagoMovimiento[index] = null;
        calcularTotalMovimiento();
    }
}

function calcularTotalMovimiento() {
    let total = 0;
    document.querySelectorAll('.monto-pago-movimiento').forEach(input => {
        const monto = parseFloat(input.value) || 0;
        total += monto;
    });
    
    document.getElementById('totalPagarMovimiento').value = `$${formatearNumero(total)}`;
    return total;
}

function validarYEnviarPagoMovimiento() {
    const movimientoId = document.getElementById('movimientoIdPago').value;
    const montoTotal = parseFloat(document.getElementById('montoTotalPago').value);
    const observaciones = document.getElementById('observacionesPagoMovimiento').value;
    
    // Recopilar formas de pago
    const formasPago = [];
    let totalPago = 0;
    
    document.querySelectorAll('.forma-pago-item-movimiento').forEach(item => {
        const index = item.dataset.index;
        const formaPagoId = item.querySelector('.forma-pago-select-movimiento').value;
        const monto = parseFloat(item.querySelector('.monto-pago-movimiento').value) || 0;
        
        if (formaPagoId && monto > 0) {
            formasPago.push({
                forma_pago_id: formaPagoId,
                monto: monto
            });
            totalPago += monto;
        }
    });
    
    // Validaciones
    if (formasPago.length === 0) {
        Swal.showValidationMessage('Debe agregar al menos una forma de pago');
        return false;
    }
    
    if (totalPago <= 0) {
        Swal.showValidationMessage('El monto total debe ser mayor a 0');
        return false;
    }
    
    if (totalPago > montoTotal) {
        Swal.showValidationMessage(`El monto total ($${formatearNumero(totalPago)}) excede el monto de la factura ($${formatearNumero(montoTotal)})`);
        return false;
    }
    
    // Enviar pago
    Swal.fire({
        title: 'Procesando...',
        text: 'Registrando pago',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/tesoreria/registrar-pago-movimiento/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            movimiento_id: movimientoId,
            formas_pago: formasPago,
            observaciones: observaciones
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '¬°Pago Registrado!',
                text: data.message,
                confirmButtonColor: '#8B7355',
                timer: 2000
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'No se pudo registrar el pago',
                confirmButtonColor: '#8B7355'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al procesar el pago',
            confirmButtonColor: '#8B7355'
        });
    });
    
    return false; // Evitar que se cierre el modal autom√°ticamente
}

// Ver historial de pagos de un movimiento
function verPagosMovimiento(movimientoId, numeroFactura) {
    Swal.fire({
        title: 'Cargando...',
        text: 'Obteniendo historial de pagos',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch(`/tesoreria/historial-pagos-movimiento/${movimientoId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.pagos && data.pagos.length > 0) {
                let html = `
                    <div class="text-start">
                        <div class="mb-3 p-3" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 8px;">
                            <p class="mb-0"><strong style="color: #6F5B44;">Factura:</strong> ${numeroFactura}</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead style="background: #F5F1E8;">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Forma Pago</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.pagos.forEach(pago => {
                    html += `
                        <tr>
                            <td>${pago.fecha}</td>
                            <td class="fw-bold text-success">$${formatearNumero(pago.monto)}</td>
                            <td><span class="badge" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);">${pago.forma_pago || 'No especificado'}</span></td>
                            <td>${pago.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                                <tfoot style="background: #F5F1E8;">
                                    <tr>
                                        <th>Total Pagado:</th>
                                        <th class="text-success" colspan="3">$${formatearNumero(data.total_pagado)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                
                Swal.fire({
                    title: '<span style="color: #6F5B44;"><i class="fas fa-list-alt me-2"></i>Historial de Pagos</span>',
                    html: html,
                    width: 700,
                    confirmButtonColor: '#8B7355',
                    confirmButtonText: 'Cerrar'
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin Pagos',
                    text: 'No hay pagos registrados para esta factura',
                    confirmButtonColor: '#8B7355'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo obtener el historial de pagos',
                confirmButtonColor: '#8B7355'
            });
        });
}

// ========== FIN FUNCIONES PARA PAGOS DE MOVIMIENTOS ==========

let documentoEditandoId = null;

// Editar documento de cliente
function editarDocumentoCliente(documentoId) {
    documentoEditandoId = documentoId;
    
    // Mostrar loading
    Swal.fire({
        title: 'Cargando...',
        text: 'Obteniendo datos del documento',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Obtener datos del documento
    fetch(`/tesoreria/obtener-documento-cliente/${documentoId}/`)
        .then(response => response.json())
        .then(data => {
            Swal.close();
            
            if (data.success) {
                const doc = data.documento;
                
                // Cambiar t√≠tulo del modal
                const modalLabel = document.getElementById('modalDocumentoClienteLabel');
                modalLabel.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Documento';
                
                // Cargar clientes y luego llenar el formulario
                cargarClientesYLlenarFormulario(doc);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalDocumentoCliente'));
                modal.show();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'No se pudo cargar el documento',
                    confirmButtonColor: '#8B7355'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo cargar el documento',
                confirmButtonColor: '#8B7355'
            });
        });
}

function cargarClientesYLlenarFormulario(documento) {
    const select = document.getElementById('clienteSelect');
    select.innerHTML = '<option value="">Cargando...</option>';
    
    fetch('/tesoreria/obtener-clientes/')
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Seleccione un cliente...</option>';
            data.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nombre}${cliente.rut ? ' - ' + cliente.rut : ''}`;
                if (cliente.id === documento.cliente_id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Llenar los dem√°s campos
            document.querySelector('[name="tipo_documento"]').value = documento.tipo_documento;
            document.querySelector('[name="numero_documento"]').value = documento.numero_documento;
            document.querySelector('[name="fecha_emision"]').value = documento.fecha_emision;
            document.querySelector('[name="fecha_vencimiento"]').value = documento.fecha_vencimiento;
            document.querySelector('[name="total"]').value = documento.total;
            document.querySelector('[name="observaciones"]').value = documento.observaciones;
        })
        .catch(error => {
            console.error('Error:', error);
            select.innerHTML = '<option value="">Error al cargar clientes</option>';
        });
}

// Eliminar documento de cliente
function eliminarDocumentoCliente(documentoId, numeroDocumento) {
    Swal.fire({
        title: '¬øEliminar documento?',
        html: `¬øEst√° seguro de eliminar el documento <strong>${numeroDocumento}</strong>?<br>Esta acci√≥n no se puede deshacer.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/tesoreria/eliminar-documento-cliente/${documentoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Eliminado!',
                        text: data.message,
                        confirmButtonColor: '#8B7355',
                        timer: 2000
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#8B7355'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al eliminar el documento',
                    confirmButtonColor: '#8B7355'
                });
            });
        }
    });
}
</script>

{% endblock %}







