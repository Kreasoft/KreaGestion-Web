{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Cuenta Corriente Proveedores - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_head %}
<style>
    /* Fondo terroso suave como en libro de ventas */
    body {
        background: linear-gradient(135deg, #FAFAF8 0%, #F5F1E8 100%) !important;
        min-height: 100vh;
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid" style="margin-top: 20px;">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: 2px solid #E8DCC8; border-radius: 15px; overflow: hidden;">

                <!-- HEADER PRINCIPAL -->
                <div class="card-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border: none; border-bottom: 2px solid #D4C4A8; padding: 10px 15px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-truck fa-lg me-2" style="color: #6F5B44;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 1.1rem; font-family: 'Poppins', sans-serif; font-weight: 600; color: #6F5B44;">
                                    Cuenta Corriente Proveedores
                                </h5>
                                <small style="font-size: 0.75rem; font-family: 'Poppins', sans-serif; color: #8B7355;">
                                    Documentos de compra en cuenta corriente
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <a href="{% url 'tesoreria:exportar_cuenta_corriente_proveedor_excel' %}{% if request.GET.search %}?search={{ request.GET.search }}{% endif %}{% if request.GET.estado_pago %}{% if request.GET.search %}&{% else %}?{% endif %}estado_pago={{ request.GET.estado_pago }}{% endif %}" 
                               class="btn btn-sm me-2" 
                               style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white; padding: 4px 8px; font-size: 0.7rem; transition: all 0.3s ease;"
                               title="Exportar a Excel">
                                <i class="fas fa-file-excel me-1"></i> Exportar Excel
                            </a>
                            <button class="btn btn-sm me-2" style="background: rgba(111, 91, 68, 0.15); border: 1px solid rgba(111, 91, 68, 0.25); color: #6F5B44; padding: 4px 8px; font-size: 0.7rem;" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                            </button>
                            <a href="{% url 'tesoreria:documento_pendiente_proveedor_list' %}" class="btn btn-sm me-2" style="background: rgba(139, 115, 85, 0.15); border: 1px solid rgba(139, 115, 85, 0.25); color: #8B7355; padding: 4px 8px; font-size: 0.7rem;">
                                <i class="fas fa-list me-1"></i> Ver Todos
                            </a>
                            <button type="button" class="btn btn-sm" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; color: white; padding: 4px 8px; font-size: 0.7rem;" data-bs-toggle="modal" data-bs-target="#modalDocumento">
                                <i class="fas fa-plus me-1"></i> Nuevo Documento
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 12px; background: #FAFAF8;">

                    <!-- ESTADÃSTICAS PRINCIPALES -->
                    <div class="row mb-2">
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-1 p-2 position-relative">
                                <div class="stat-value" style="font-size: 1.1rem;">{{ stats.total_documentos|default:0 }}</div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Documentos</div>
                                <i class="fas fa-file-invoice stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-2 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_pendiente|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Pendiente</div>
                                <i class="fas fa-clock stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-3 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_vencido|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Total Vencido</div>
                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-3 mb-1">
                            <div class="stat-card stat-card-4 p-2 position-relative">
                                <div class="stat-value format-number" style="font-size: 1rem;" data-value="{{ stats.total_parcial|default:0 }}" data-prefix="$"></div>
                                <div class="stat-label" style="font-size: 0.7rem;">Pago Parcial</div>
                                <i class="fas fa-coins stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FILTROS -->
                    <div class="filter-section">
                        <form method="get">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" style="font-size: 0.7rem; color: #6F5B44;">
                                        <i class="fas fa-search me-1"></i>Buscar
                                    </label>
                                    <input type="text" name="search" class="form-control form-control-sm"
                                           placeholder="ðŸ” Buscar por NÂ° documento, proveedor, RUT..." value="{{ search }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold" style="font-size: 0.7rem; color: #6F5B44;">
                                        <i class="fas fa-filter me-1"></i>Estado de Pago
                                    </label>
                                    <select name="estado_pago" class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="credito" {% if estado_pago == "credito" %}selected{% endif %}>Pendiente</option>
                                        <option value="parcial" {% if estado_pago == "parcial" %}selected{% endif %}>Pago Parcial</option>
                                        <option value="vencida" {% if estado_pago == "vencida" %}selected{% endif %}>Vencido</option>
                                        <option value="pagado" {% if estado_pago == "pagado" %}selected{% endif %}>Pagado</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex gap-2">
                                    <button type="submit" class="btn btn-filter flex-grow-1">
                                        <i class="fas fa-filter me-1"></i>Filtrar
                                    </button>
                                    <a href="{% url 'tesoreria:cuenta_corriente_proveedor_list' %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-times"></i>
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Lista de Documentos -->
                    <div class="table-responsive" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <table class="table table-hover table-compact mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 4%;">#</th>
                                    <th style="width: 10%;">NÂ° Documento</th>
                                    <th style="width: 18%;">Proveedor</th>
                                    <th style="width: 8%;">Fecha</th>
                                    <th style="width: 10%;">Total</th>
                                    <th style="width: 10%;">Pagado</th>
                                    <th style="width: 10%;">Saldo</th>
                                    <th style="width: 8%;">Estado</th>
                                    <th class="text-center" style="width: 12%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for documento in page_obj %}
                                <tr style="border-bottom: 1px solid #F5F1E8;">
                                    <td style="font-size: 0.7rem;" class="text-muted">{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</td>
                                    <td style="font-size: 0.7rem;">
                                        <strong>{{ documento.numero_documento }}</strong>
                                    </td>
                                    <td style="font-size: 0.7rem;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-truck text-muted me-2"></i>
                                            {{ documento.proveedor.nombre }}
                                        </div>
                                    </td>
                                    <td style="font-size: 0.7rem;">{{ documento.fecha_emision|date:"d/m/Y"|default:"-" }}</td>
                                    <td style="font-size: 0.7rem; font-weight: 600;" class="format-number" data-value="{{ documento.total_documento|floatformat:0|default:0 }}">$</td>
                                    <td style="font-size: 0.7rem; font-weight: 600; color: #28a745;" class="format-number" data-value="{{ documento.monto_pagado|floatformat:0|default:0 }}">$</td>
                                    <td style="font-size: 0.7rem; font-weight: 700; color: #6F5B44;" class="format-number" data-value="{{ documento.saldo_pendiente|floatformat:0|default:0 }}">$</td>
                                    <td style="font-size: 0.7rem;">
                                        {% if documento.saldo_pendiente <= 0 %}
                                            <span class="badge bg-success" style="font-size: 0.6rem;">Pagado</span>
                                        {% elif documento.monto_pagado > 0 and documento.saldo_pendiente > 0 %}
                                            <span class="badge bg-warning" style="font-size: 0.6rem;">Parcial</span>
                                        {% elif documento.fecha_vencimiento and documento.fecha_vencimiento < today and documento.saldo_pendiente > 0 %}
                                            <span class="badge bg-danger" style="font-size: 0.6rem;">Vencido</span>
                                        {% else %}
                                            <span class="badge bg-info" style="font-size: 0.6rem;">Pendiente</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            {% if documento.saldo_pendiente > 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-action btn-outline-success"
                                                    title="Registrar Pago"
                                                    data-doc-id="{{ documento.pk }}"
                                                    data-doc-numero="{{ documento.numero_documento }}"
                                                    data-doc-saldo="{{ documento.saldo_pendiente|floatformat:0 }}"
                                                    onclick="registrarPago(this)">
                                                <i class="fas fa-dollar-sign"></i>
                                            </button>
                                            {% endif %}
                                            {% if documento.monto_pagado > 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-action btn-outline-info"
                                                    title="Ver Pagos"
                                                    data-doc-id="{{ documento.pk }}"
                                                    data-doc-numero="{{ documento.numero_documento }}"
                                                    onclick="verPagos(this)">
                                                <i class="fas fa-list-alt"></i>
                                            </button>
                                            {% endif %}
                                            {% if documento.proveedor %}
                                            <a href="{% url 'tesoreria:cuenta_corriente_proveedor_detail' documento.proveedor.pk %}"
                                               class="btn btn-sm btn-action btn-outline-primary"
                                               title="Ver detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-2">
                                        <i class="fas fa-inbox fa-2x mb-2" style="color: #D4A574;"></i>
                                        <p style="color: #8B7355; font-size: 0.8rem;">No hay documentos en cuenta corriente</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINACIÃ“N -->
                    {% if page_obj.has_other_pages %}
                    <div class="d-flex justify-content-center mt-2">
                        <nav aria-label="PaginaciÃ³n">
                            <ul class="pagination pagination-sm mb-0" style="font-size: 0.75rem;">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">Â«</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">â€¹</a>
                                </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border: none; font-size: 0.7rem; padding: 4px 8px;">
                                        {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">â€º</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" style="padding: 4px 8px; font-size: 0.7rem;">Â»</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Paleta terrosa para tarjetas de estadÃ­sticas */
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-card-1 {
        background: linear-gradient(135deg, #D4A574 0%, #C19461 100%);
    }

    .stat-card-2 {
        background: linear-gradient(135deg, #B8956A 0%, #A67C52 100%);
    }

    .stat-card-3 {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
    }

    .stat-card-4 {
        background: linear-gradient(135deg, #A0826D 0%, #8B6F5C 100%);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: rgba(255,255,255,0.9);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .stat-icon {
        font-size: 2rem;
        color: rgba(255,255,255,0.3);
        position: absolute;
        right: 15px;
        bottom: 15px;
    }

    .filter-section {
        background: linear-gradient(135deg, #FAF8F3 0%, #F5F1E8 100%);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .table-compact {
        font-size: 0.75rem;
        line-height: 1.1;
    }

    .table-compact thead th {
        padding: 4px 2px;
        font-weight: 600;
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        border: none;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        line-height: 1.1;
    }

    .table-compact tbody td {
        padding: 2px 3px;
        vertical-align: middle;
        line-height: 1.2;
        font-size: 0.7rem;
    }

    .table-compact tbody tr {
        height: 28px;
    }

    .btn-filter {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        color: white;
        padding: 8px 20px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(139, 115, 85, 0.3);
        color: white;
    }

    .btn-action {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 6px;
    }
</style>

<!-- Modal para Crear Documento -->
<div class="modal fade" id="modalDocumento" tabindex="-1" aria-labelledby="modalDocumentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border: 2px solid #E8DCC8; border-radius: 15px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-bottom: 2px solid #D4C4A8;">
                <h5 class="modal-title" id="modalDocumentoLabel" style="color: #6F5B44; font-weight: 600;">
                    <i class="fas fa-file-invoice me-2"></i>Nuevo Documento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDocumentoBody" style="background: #FAFAF8;">
                <!-- AquÃ­ se cargarÃ¡ el formulario -->
            </div>
        </div>
    </div>
</div>

<script>
// FunciÃ³n para formatear nÃºmeros con punto como separador de miles
function formatearNumero(numero) {
    // Convertir a nÃºmero y redondear
    const num = Math.round(parseFloat(numero) || 0);
    // Convertir a string y agregar separador de miles
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

document.addEventListener('DOMContentLoaded', function() {
    // Formatear todos los nÃºmeros en la pÃ¡gina
    document.querySelectorAll('.format-number').forEach(element => {
        const value = element.dataset.value;
        const prefix = element.dataset.prefix || '';
        const currentText = element.textContent.trim();
        
        if (value) {
            // Limpiar el valor de cualquier formato previo
            const cleanValue = value.toString().replace(/[^\d.-]/g, '');
            // Si ya tiene un prefijo (como $), mantenerlo
            const finalPrefix = currentText.startsWith('$') ? '$' : prefix;
            element.textContent = finalPrefix + formatearNumero(cleanValue);
        }
    });
    
    const modalCrear = document.getElementById('modalDocumento');
    if (modalCrear) {
        modalCrear.addEventListener('show.bs.modal', function() {
            document.getElementById('modalDocumentoLabel').innerHTML = '<i class="fas fa-file-invoice me-2"></i>Nuevo Documento';
            document.getElementById('modalDocumentoBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"></div><p class="mt-2">Cargando...</p></div>';
            
            fetch('{% url "tesoreria:documento_pendiente_proveedor_create" %}')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modalDocumentoBody').innerHTML = html;
                setupFormHandler();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('modalDocumentoBody').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        });
    }
});

function setupFormHandler() {
    const form = document.querySelector('#modalDocumentoBody form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const url = this.action;
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalDocumento')).hide();
                    Swal.fire({
                        icon: 'success',
                        title: 'Â¡Ã‰xito!',
                        text: data.message,
                        confirmButtonColor: '#8B7355',
                        timer: 2000
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#8B7355'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al procesar la solicitud',
                    confirmButtonColor: '#8B7355'
                });
            });
        });
    }
}

let formasPagoGlobal = [];
let formasPagoSeleccionadas = [];

function registrarPago(btn) {
    const documentoId = btn.dataset.docId;
    const numeroDocumento = btn.dataset.docNumero;
    // Limpiar el valor del saldo (eliminar puntos, comas, espacios)
    const saldoRaw = btn.dataset.docSaldo.toString().replace(/[^\d.-]/g, '');
    const saldoPendiente = parseFloat(saldoRaw) || 0;
    
    console.log('Saldo raw:', btn.dataset.docSaldo, 'Saldo limpio:', saldoRaw, 'Saldo parseado:', saldoPendiente);
    
    formasPagoSeleccionadas = [];
    
    // Obtener formas de pago disponibles
    fetch('/tesoreria/obtener-formas-pago/')
        .then(response => response.json())
        .then(data => {
            formasPagoGlobal = data.formas_pago || [];
            mostrarModalPago(documentoId, numeroDocumento, saldoPendiente);
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar las formas de pago',
                confirmButtonColor: '#8B7355'
            });
        });
}

function mostrarModalPago(documentoId, numeroDocumento, saldoPendiente) {
    const saldoFormateado = formatearNumero(saldoPendiente);
    
    const html = `
        <div class="text-start">
            <div class="mb-3 p-3" style="background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%); border-radius: 8px; border: 2px solid #D4C4A8;">
                <p class="mb-2"><strong style="color: #6F5B44;">Documento:</strong> <span class="fw-bold">${numeroDocumento}</span></p>
                <p class="mb-0"><strong style="color: #6F5B44;">Saldo Pendiente:</strong> <span class="text-danger fw-bold" style="font-size: 1.2rem;">$${saldoFormateado}</span></p>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Formas de Pago:</label>
                <div id="formasPagoContainer">
                    <!-- AquÃ­ se agregarÃ¡n las formas de pago -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="agregarFormaPago()">
                    <i class="fas fa-plus me-1"></i> Agregar Forma de Pago
                </button>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Total a Pagar:</label>
                <input type="text" id="totalPagar" class="form-control fw-bold text-success" value="$0" readonly>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Observaciones:</label>
                <textarea id="observacionesPago" class="form-control" rows="2" placeholder="Observaciones del pago..."></textarea>
            </div>
            
            <input type="hidden" id="documentoIdPago" value="${documentoId}">
            <input type="hidden" id="saldoPendientePago" value="${saldoPendiente}">
        </div>
    `;
    
    Swal.fire({
        title: '<span style="color: #6F5B44;"><i class="fas fa-dollar-sign me-2"></i>Registrar Pago</span>',
        html: html,
        width: 700,
        showCancelButton: true,
        confirmButtonColor: '#8B7355',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-save me-1"></i> Registrar Pago',
        cancelButtonText: 'Cancelar',
        customClass: {
            popup: 'modal-pago-terroso',
            title: 'modal-pago-title'
        },
        didOpen: () => {
            // Agregar estilos al modal
            const style = document.createElement('style');
            style.textContent = `
                .modal-pago-terroso {
                    border: 3px solid #D4C4A8 !important;
                }
                .modal-pago-title {
                    background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC8 100%) !important;
                    padding: 15px !important;
                    border-radius: 8px 8px 0 0 !important;
                    border-bottom: 2px solid #D4C4A8 !important;
                }
            `;
            document.head.appendChild(style);
            agregarFormaPago(); // Agregar primera forma de pago por defecto
        },
        preConfirm: () => {
            return validarYEnviarPago();
        }
    });
}

function agregarFormaPago() {
    const container = document.getElementById('formasPagoContainer');
    const index = formasPagoSeleccionadas.length;
    
    const formaPagoHtml = `
        <div class="card mb-2 forma-pago-item" data-index="${index}">
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" style="font-size: 0.8rem;">Forma de Pago</label>
                        <select class="form-select form-select-sm forma-pago-select" data-index="${index}">
                            <option value="">Seleccione...</option>
                            ${formasPagoGlobal.map(fp => `<option value="${fp.id}">${fp.nombre}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" style="font-size: 0.8rem;">Monto</label>
                        <input type="number" class="form-control form-control-sm monto-pago" data-index="${index}" 
                               min="1" step="1" placeholder="0" onchange="calcularTotal()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="eliminarFormaPago(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formaPagoHtml);
    formasPagoSeleccionadas.push({ forma_pago_id: null, monto: 0 });
}

function eliminarFormaPago(index) {
    const item = document.querySelector(`.forma-pago-item[data-index="${index}"]`);
    if (item) {
        item.remove();
        formasPagoSeleccionadas[index] = null;
        calcularTotal();
    }
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.monto-pago').forEach(input => {
        const monto = parseFloat(input.value) || 0;
        total += monto;
    });
    
    document.getElementById('totalPagar').value = `$${formatearNumero(total)}`;
    return total;
}

function validarYEnviarPago() {
    const documentoId = document.getElementById('documentoIdPago').value;
    const saldoPendiente = parseFloat(document.getElementById('saldoPendientePago').value);
    const observaciones = document.getElementById('observacionesPago').value;
    
    // Recopilar formas de pago
    const formasPago = [];
    let totalPago = 0;
    
    document.querySelectorAll('.forma-pago-item').forEach(item => {
        const index = item.dataset.index;
        const formaPagoId = item.querySelector('.forma-pago-select').value;
        const monto = parseFloat(item.querySelector('.monto-pago').value) || 0;
        
        if (formaPagoId && monto > 0) {
            formasPago.push({
                forma_pago_id: formaPagoId,
                monto: monto
            });
            totalPago += monto;
        }
    });
    
    // Validaciones
    if (formasPago.length === 0) {
        Swal.showValidationMessage('Debe agregar al menos una forma de pago');
        return false;
    }
    
    if (totalPago <= 0) {
        Swal.showValidationMessage('El monto total debe ser mayor a 0');
        return false;
    }
    
    if (totalPago > saldoPendiente) {
        Swal.showValidationMessage(`El monto total ($${formatearNumero(totalPago)}) excede el saldo pendiente ($${formatearNumero(saldoPendiente)})`);
        return false;
    }
    
    // Enviar pago
    Swal.fire({
        title: 'Procesando...',
        text: 'Registrando pago',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/tesoreria/registrar-pago/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            documento_id: documentoId,
            formas_pago: formasPago,
            observaciones: observaciones
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Â¡Pago Registrado!',
                text: data.message,
                confirmButtonColor: '#8B7355',
                timer: 2000
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'No se pudo registrar el pago',
                confirmButtonColor: '#8B7355'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al procesar el pago',
            confirmButtonColor: '#8B7355'
        });
    });
    
    return false; // Evitar que se cierre el modal automÃ¡ticamente
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function verPagos(btn) {
    const documentoId = btn.dataset.docId;
    const numeroDocumento = btn.dataset.docNumero;
    
    // Mostrar loading
    Swal.fire({
        title: 'Cargando...',
        text: 'Obteniendo historial de pagos',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Obtener historial de pagos
    fetch(`/tesoreria/historial-pagos/${documentoId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.pagos && data.pagos.length > 0) {
                let html = `<div class="text-start"><p><strong>Documento:</strong> ${numeroDocumento}</p>`;
                html += '<table class="table table-sm table-bordered mt-3">';
                html += '<thead><tr><th>Fecha</th><th>Monto</th><th>Forma Pago</th></tr></thead><tbody>';
                
                data.pagos.forEach(pago => {
                    html += `<tr>
                        <td>${pago.fecha}</td>
                        <td>$${formatearNumero(pago.monto)}</td>
                        <td>${pago.forma_pago}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<p class="mt-3"><strong>Total Pagado:</strong> $${formatearNumero(data.total_pagado)}</p></div>`;
                
                Swal.fire({
                    title: 'Historial de Pagos',
                    html: html,
                    width: 600,
                    confirmButtonColor: '#8B7355'
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin Pagos',
                    text: 'No hay pagos registrados para este documento',
                    confirmButtonColor: '#8B7355'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo obtener el historial de pagos',
                confirmButtonColor: '#8B7355'
            });
        });
}
</script>

{% endblock %}
