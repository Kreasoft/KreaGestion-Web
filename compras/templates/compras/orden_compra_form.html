{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if orden %}
        Editar Orden de Compra - GestionCloud
    {% else %}
        Crear Orden de Compra - GestionCloud
    {% endif %}
{% endblock %}

{% block body_class %}hide-top-bar{% if orden %} edit-mode{% endif %}{% endblock %}

{% block extra_css %}
<style>
    /* TODO EN UNA SOLA TARJETA - ULTRA COMPACTO */
    .single-card-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto 1rem;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.75rem;
        margin-bottom: 0.2rem;
    }

    .form-control, .form-select {
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
        height: auto;
        border-radius: 3px;
    }

    .form-control-sm {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }

    .input-group-text {
        font-size: 0.75rem;
        padding: 0.3rem 0.5rem;
        background-color: #f1f3f5;
    }

    /* Línea divisoria sutil */
    .divider-line {
        height: 1px;
        background: linear-gradient(to right, transparent, #dee2e6, transparent);
        margin: 1rem 0;
    }

    /* Lista de items ultra compacta - SIN BORDES */
    .items-list-compact {
        margin-top: 0.5rem;
    }

    .items-list-header {
        background: #e9ecef;
        padding: 0.3rem 0.5rem;
        border-radius: 3px 3px 0 0;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #495057;
    }

    .item-line {
        padding: 0.25rem 0.5rem;
        border-bottom: 1px solid #f8f9fa;
    }

    .item-line:hover {
        background-color: #f8f9fa;
    }

    .item-line:last-child {
        border-bottom: none;
    }

    /* Botones compactos */
    .btn-sm-compact {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }

    .btn-add-compact {
        background: #28a745;
        color: white;
        border: none;
    }

    .btn-add-compact:hover {
        background: #218838;
        color: white;
    }

    .btn-del-compact {
        background: transparent;
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .btn-del-compact:hover {
        background: #dc3545;
        color: white;
    }

    /* Totales inline */
    .totals-inline {
        background: #f8f9fa;
        border-radius: 5px;
        padding: 0.5rem 0.75rem;
        margin-top: 0.75rem;
    }

    .total-line {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        padding: 0.15rem 0;
    }

    .total-line.final {
        border-top: 2px solid #dee2e6;
        padding-top: 0.4rem;
        margin-top: 0.3rem;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: #17a2b8;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 5px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: #117a8b;
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 5px;
        font-weight: 600;
    }

    .btn-secondary:hover {
        background: #545b62;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Header simplificado -->
    <div class="d-flex justify-content-between align-items-center mb-3 p-3" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); border-radius: 8px; color: white;">
        <div>
            <h4 class="mb-0 fw-bold">
                {% if orden %}Editar Orden de Compra{% else %}Crear Orden de Compra{% endif %}
                <span style="background: red; color: white; padding: 2px 8px; font-size: 0.7rem; border-radius: 3px; margin-left: 10px;">VERSIÓN ACTUALIZADA</span>
            </h4>
            <small>{% if orden %}Orden {{ orden.numero_orden }}{% else %}Nueva orden{% endif %}</small>
        </div>
        <a href="{% url 'compras:orden_compra_list' %}" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Volver
        </a>
    </div>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- UNA SOLA TARJETA CON TODO EL CONTENIDO -->
    <div class="single-card-container">
        <form method="post" enctype="multipart/form-data" id="ordenForm">
            {% csrf_token %}

            <!-- Campos ocultos -->
            <input type="hidden" name="subtotal" id="subtotal-hidden" value="{% if orden %}{{ orden.subtotal|default:0 }}{% else %}0{% endif %}">
            <input type="hidden" name="descuentos_totales" id="descuentos-hidden" value="{% if orden %}{{ orden.descuentos_totales|default:0 }}{% else %}0{% endif %}">
            <input type="hidden" name="impuestos_totales" id="impuestos-hidden" value="{% if orden %}{{ orden.impuestos_totales|default:0 }}{% else %}0{% endif %}">
            <input type="hidden" name="total_orden" id="total-hidden" value="{% if orden %}{{ orden.total_orden|default:0 }}{% else %}0{% endif %}">

            <!-- Información de la orden - Primera línea -->
            <div class="row g-2 mb-2">
                <div class="col-md-2">
                    <label class="form-label">N° Orden *</label>
                    <input type="text" name="{{ form.numero_orden.name }}" class="form-control form-control-sm" value="{% if form.numero_orden.value %}{{ form.numero_orden.value }}{% endif %}" readonly style="background-color: #e9ecef;">
                </div>
                <div class="col-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="form-label mb-0">Proveedor *</label>
                        <a href="{% url 'proveedores:proveedor_create' %}?next={{ request.path|urlencode }}" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 2px 8px; font-size: 0.7rem;">
                            <i class="fas fa-plus me-1"></i>Nuevo
                        </a>
                    </div>
                    <select name="{{ form.proveedor.name }}" id="id_proveedor" class="form-select form-select-sm" required>
                        <option value="">Seleccionar proveedor...</option>
                        {% for proveedor in form.fields.proveedor.queryset %}
                            <option value="{{ proveedor.id }}" {% if form.proveedor.value == proveedor.id %}selected{% endif %}>
                                {{ proveedor.nombre }} {% if proveedor.rut %}- {{ proveedor.rut }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted" style="font-size: 0.65rem;">
                        <i class="fas fa-info-circle me-1"></i>Después de crear, recargue la página
                    </small>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Orden *</label>
                    <input type="date" name="{{ form.fecha_orden.name }}" class="form-control form-control-sm" value="{% if form.fecha_orden.value %}{{ form.fecha_orden.value|date:'Y-m-d' }}{% else %}{{ 'now'|date:'Y-m-d' }}{% endif %}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Estado</label>
                    {{ form.estado_orden }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Prioridad *</label>
                    {{ form.prioridad }}
                </div>
            </div>

            <!-- Segunda línea -->
            <div class="row g-2 mb-2">
                <div class="col-md-3">
                    <label class="form-label">Fecha Entrega *</label>
                    <input type="date" name="{{ form.fecha_entrega_esperada.name }}" class="form-control form-control-sm" value="{% if form.fecha_entrega_esperada.value %}{{ form.fecha_entrega_esperada.value|date:'Y-m-d' }}{% endif %}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Bodega *</label>
                    {{ form.bodega }}
                </div>
                <div class="col-md-6">
                    <label class="form-label">Observaciones</label>
                    <input type="text" name="{{ form.observaciones.name }}" class="form-control form-control-sm" placeholder="Notas adicionales..." value="{% if form.observaciones.value %}{{ form.observaciones.value }}{% endif %}">
                </div>
            </div>

            <!-- Divisor sutil -->
            <div class="divider-line"></div>

            <!-- Items de la orden - ULTRA COMPACTO -->
            <div class="items-list-compact">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0" style="font-weight: 600; color: #495057; font-size: 0.9rem;">
                        <i class="fas fa-list me-2"></i>Artículos Solicitados
                    </h6>
                    <div class="d-flex gap-2">
                        <a href="{% url 'articulos:articulo_create' %}" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 3px 10px; font-size: 0.7rem;">
                            <i class="fas fa-box me-1"></i>Nuevo Artículo
                        </a>
                        <button type="button" class="btn btn-sm-compact btn-add-compact" id="addItemBtn">
                            <i class="fas fa-plus me-1"></i>Agregar Línea
                        </button>
                    </div>
                </div>

                {{ formset.management_form }}

                <!-- Header de columnas -->
                <div class="items-list-header">
                    <div class="row align-items-center g-1">
                        <div class="col-md-4">Artículo</div>
                        <div class="col-md-1 text-center">Cant.</div>
                        <div class="col-md-2 text-end">Precio Unit.</div>
                        <div class="col-md-1 text-center">Desc.%</div>
                        <div class="col-md-2 text-end">Subtotal</div>
                        <div class="col-md-2 text-center">Acción</div>
                    </div>
                </div>

                <!-- Items -->
                <div id="items-container">
                    {% for item_form in formset %}
                    <div class="item-line" data-form-index="{{ forloop.counter0 }}">
                        <div class="row align-items-center g-1">
                            <div class="col-md-4">
                                <select name="{{ item_form.articulo.html_name }}" class="form-select form-select-sm articulo-select" data-index="{{ forloop.counter0 }}">
                                    <option value="">Seleccionar artículo</option>
                                    {% for articulo in articulos_empresa %}
                                        <option value="{{ articulo.id }}"
                                                data-codigo="{{ articulo.codigo }}"
                                                data-nombre="{{ articulo.nombre }}"
                                                {% if item_form.articulo.value == articulo.id or item_form.instance.articulo_id == articulo.id %}selected{% endif %}>
                                            {{ articulo.codigo }} - {{ articulo.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-1">
                                {{ item_form.cantidad_solicitada }}
                            </div>
                            <div class="col-md-2">
                                {{ item_form.precio_unitario }}
                            </div>
                            <div class="col-md-1">
                                {{ item_form.descuento_porcentaje }}
                            </div>
                            <div class="col-md-2">
                                {% if item_form.instance.pk %}
                                    <input type="text" class="form-control form-control-sm text-end item-total" style="background-color: #f8f9fa; font-weight: 600;" readonly value="${{ item_form.instance.total_item|floatformat:0|default:0 }}">
                                {% else %}
                                    <input type="text" class="form-control form-control-sm text-end item-total" style="background-color: #f8f9fa; font-weight: 600;" readonly value="$0">
                                {% endif %}
                            </div>
                            <div class="col-md-2 text-center">
                                {% for hidden in item_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <button type="button" class="btn btn-sm-compact btn-del-compact delete-item-btn" data-form-index="{{ forloop.counter0 }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Totales inline -->
            <div class="totals-inline">
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <div class="total-line">
                            <span>Subtotal:</span>
                            <span id="subtotal-total">{% if orden %}${{ orden.subtotal|floatformat:0|default:0 }}{% else %}$0{% endif %}</span>
                        </div>
                        <div class="total-line">
                            <span>Descuentos:</span>
                            <span id="descuentos-total">{% if orden %}${{ orden.descuentos_totales|floatformat:0|default:0 }}{% else %}$0{% endif %}</span>
                        </div>
                        <div class="total-line">
                            <span>IVA (19%):</span>
                            <span id="iva-total">{% if orden %}${{ orden.impuestos_totales|floatformat:0|default:0 }}{% else %}$0{% endif %}</span>
                        </div>
                        <div class="total-line final">
                            <span>TOTAL:</span>
                            <span id="total-orden">{% if orden %}${{ orden.total_orden|floatformat:0|default:0 }}{% else %}$0{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="d-flex justify-content-end gap-2 mt-3">
                <a href="{% url 'compras:orden_compra_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>
                    {% if orden %}Actualizar{% else %}Crear{% endif %} Orden
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Variables globales
let formCount = {{ formset.total_form_count }};
const maxForms = 1000;

// Función para agregar nuevo item
window.addItemForm = function() {
    if (formCount < maxForms) {
        const emptyFormHtml = `
            <div class="item-line" data-form-index="${formCount}">
                <div class="row align-items-center g-1">
                    <div class="col-md-4">
                        <select name="items-${formCount}-articulo" class="form-select form-select-sm articulo-select">
                            <option value="">Seleccionar artículo</option>
                            {% for articulo in articulos_empresa %}
                                <option value="{{ articulo.id }}">{{ articulo.codigo }} - {{ articulo.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <input type="number" name="items-${formCount}-cantidad_solicitada" class="form-control form-control-sm text-center" min="1" value="1">
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="items-${formCount}-precio_unitario" class="form-control form-control-sm text-end" min="0" step="1" value="0">
                    </div>
                    <div class="col-md-1">
                        <input type="number" name="items-${formCount}-descuento_porcentaje" class="form-control form-control-sm text-center" min="0" max="100" value="0">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control form-control-sm text-end item-total" style="background-color: #f8f9fa; font-weight: 600;" readonly value="$0">
                    </div>
                    <div class="col-md-2 text-center">
                        <button type="button" class="btn btn-sm-compact btn-del-compact delete-item-btn" data-form-index="${formCount}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('items-container').insertAdjacentHTML('beforeend', emptyFormHtml);
        formCount++;
        document.getElementById('id_items-TOTAL_FORMS').value = formCount;

        // Agregar event listeners
        const newItem = document.querySelector(`[data-form-index="${formCount - 1}"]`);
        newItem.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculateTotals);
        });
    }
};

// Función para eliminar items
window.eliminarItem = function(button) {
    const itemLine = button.closest('.item-line');
    const formIndex = button.getAttribute('data-form-index');

    if (itemLine) {
        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = `items-${formIndex}-DELETE`;
        deleteInput.value = 'on';
        itemLine.appendChild(deleteInput);
        itemLine.style.display = 'none';
        calculateTotals();
    }
};

// Función para calcular totales
window.calculateTotals = function() {
    let subtotal = 0;
    let descuentosTotales = 0;

    document.querySelectorAll('.item-line:not([style*="display: none"])').forEach(function(line) {
        const cantidadInput = line.querySelector('input[name*="-cantidad_solicitada"]');
        const precioInput = line.querySelector('input[name*="-precio_unitario"]');
        const descuentoInput = line.querySelector('input[name*="-descuento_porcentaje"]');

        // Obtener valores, asegurándose de convertir a número
        const cantidad = parseFloat(cantidadInput?.value) || 0;
        const precioUnitario = parseFloat(precioInput?.value) || 0;
        const descuentoPorcentaje = parseFloat(descuentoInput?.value) || 0;
        
        // Calcular subtotal del item
        const subtotalItem = cantidad * precioUnitario;
        
        // Calcular descuento
        const descuentoMonto = Math.round(subtotalItem * (descuentoPorcentaje / 100));
        const subtotalConDescuento = subtotalItem - descuentoMonto;
        
        // Calcular IVA (19%)
        const ivaItem = Math.round(subtotalConDescuento * 0.19);
        const totalItem = subtotalConDescuento + ivaItem;

        const totalField = line.querySelector('.item-total');
        if (totalField) {
            totalField.value = totalItem > 0 ? '$' + totalItem.toLocaleString('es-CL') : '$0';
        }

        subtotal += subtotalItem;
        descuentosTotales += descuentoMonto;
    });

    // Calcular IVA sobre el subtotal menos descuentos
    const subtotalNeto = subtotal - descuentosTotales;
    const ivaOrden = Math.round(subtotalNeto * 0.19);
    const totalOrden = subtotalNeto + ivaOrden;

    document.getElementById('subtotal-total').textContent = '$' + subtotal.toLocaleString('es-CL');
    document.getElementById('descuentos-total').textContent = '$' + descuentosTotales.toLocaleString('es-CL');
    document.getElementById('iva-total').textContent = '$' + ivaOrden.toLocaleString('es-CL');
    document.getElementById('total-orden').textContent = '$' + totalOrden.toLocaleString('es-CL');

    document.getElementById('subtotal-hidden').value = subtotal;
    document.getElementById('descuentos-hidden').value = descuentosTotales;
    document.getElementById('impuestos-hidden').value = ivaOrden;
    document.getElementById('total-hidden').value = totalOrden;
};

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Botón agregar
    document.getElementById('addItemBtn').addEventListener('click', function(e) {
        e.preventDefault();
        addItemForm();
    });

    // Eliminar items
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-item-btn')) {
            eliminarItem(e.target.closest('.delete-item-btn'));
        }
    });

    // Recalcular totales cuando cambian cantidad o precio
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('cantidad_solicitada') || e.target.name.includes('precio_unitario'))) {
            calculateTotals();
        }
    });
    
    // También recalcular cuando cambia el descuento
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('descuento_porcentaje')) {
            calculateTotals();
        }
    });

    // Calcular totales iniciales al cargar la página con datos existentes
    // Siempre recalcular para asegurar que los totales estén correctos
    setTimeout(function() {
        console.log('=== CALCULANDO TOTALES INICIALES ===');
        // Verificar si hay items con valores
        let tieneItems = false;
        document.querySelectorAll('.item-line:not([style*="display: none"])').forEach(function(line, index) {
            const cantidadInput = line.querySelector('input[name*="-cantidad_solicitada"]');
            const precioInput = line.querySelector('input[name*="-precio_unitario"]');
            
            if (cantidadInput && precioInput) {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precio = parseFloat(precioInput.value) || 0;
                console.log(`Item ${index}: cantidad=${cantidad}, precio=${precio}`);
                
                if (cantidad > 0 && precio > 0) {
                    tieneItems = true;
                }
            }
        });
        
        // Si hay items con valores, recalcular totales
        if (tieneItems) {
            console.log('Recalculando totales iniciales...');
            calculateTotals();
        } else {
            console.log('No hay items con valores, no se recalcula');
        }
    }, 500);

    // Validación formulario
    document.getElementById('ordenForm').addEventListener('submit', function(e) {
        const visibleItems = document.querySelectorAll('.item-line:not([style*="display: none"])');
        if (visibleItems.length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Advertencia',
                text: 'Debe agregar al menos un artículo a la orden.',
                confirmButtonText: 'Entendido'
            });
            return;
        }
    });

    // Mensajes
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" %}error{% else %}info{% endif %}',
                title: '{% if message.tags == "success" %}¡Éxito!{% elif message.tags == "error" %}Error{% else %}Información{% endif %}',
                text: '{{ message }}',
                {% if message.tags == "success" %}timer: 3000, showConfirmButton: false{% else %}confirmButtonText: 'Entendido'{% endif %}
            });
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
