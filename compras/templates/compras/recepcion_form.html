{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }} - GestionCloud{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #e3e6f0;
    }
    
    .section-header {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .item-row {
        background: #f8f9fc;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e3e6f0;
        transition: all 0.3s ease;
    }
    
    .item-row:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    }
    
    .btn-secondary {
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%);
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #ced4da;
        padding: 0.75rem;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #17a2b8;
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
    }
    
    .orden-info {
        background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
        border: 1px solid #bbdefb;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-check-input:checked {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: none; border-radius: 15px; overflow: hidden;">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); border: none; padding: 15px 20px; font-family: 'Poppins', sans-serif;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-truck-loading fa-2x text-white me-3"></i>
                            <div>
                                <h5 class="mb-0 text-white" style="font-size: 1.4rem; font-family: 'Poppins', sans-serif; font-weight: 600;">
                                    {{ titulo }}
                                </h5>
                                <small class="text-white-50" style="font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Registra la recepción de mercancías</small>
                            </div>
                        </div>
                        <a href="{% url 'compras:orden_compra_detail' orden.pk %}" class="btn" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none; color: white; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3); font-family: 'Poppins', sans-serif;">
                            <i class="fas fa-arrow-left me-2"></i> Volver
                        </a>
                    </div>
                </div>
                
                <div class="card-body" style="padding: 20px;">
                    <!-- Información de la Orden -->
                    <div class="orden-info">
                        <div class="row">
                            <div class="col-md-3">
                                <strong style="color: #495057; font-family: 'Poppins', sans-serif;">Orden:</strong><br>
                                <span style="color: #2c3e50; font-family: 'Poppins', sans-serif; font-weight: 500;">{{ orden.numero_orden }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong style="color: #495057; font-family: 'Poppins', sans-serif;">Proveedor:</strong><br>
                                <span style="color: #2c3e50; font-family: 'Poppins', sans-serif; font-weight: 500;">{{ orden.proveedor }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong style="color: #495057; font-family: 'Poppins', sans-serif;">Fecha Orden:</strong><br>
                                <span style="color: #2c3e50; font-family: 'Poppins', sans-serif; font-weight: 500;">{{ orden.fecha_orden|date:"d/m/Y" }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong style="color: #495057; font-family: 'Poppins', sans-serif;">Total:</strong><br>
                                <span style="color: #2c3e50; font-family: 'Poppins', sans-serif; font-weight: 500;">${{ orden.total_orden|floatformat:0 }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <form method="post" id="recepcionForm">
                        {% csrf_token %}
                        
                        <!-- Información de la Recepción -->
                        <div class="form-section">
                            <div class="section-header">
                                <h5><i class="fas fa-info-circle me-2"></i>Información de la Recepción</h5>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-family: 'Poppins', sans-serif;">Número de Recepción</label>
                                    {{ form.numero_recepcion }}
                                    {% if form.numero_recepcion.errors %}
                                        <div class="text-danger mt-1">{{ form.numero_recepcion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-family: 'Poppins', sans-serif;">Fecha de Recepción *</label>
                                    {{ form.fecha_recepcion }}
                                    {% if form.fecha_recepcion.errors %}
                                        <div class="text-danger mt-1">{{ form.fecha_recepcion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-family: 'Poppins', sans-serif;">Transportista</label>
                                    {{ form.transportista }}
                                    {% if form.transportista.errors %}
                                        <div class="text-danger mt-1">{{ form.transportista.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" style="font-weight: 500; color: #495057; font-family: 'Poppins', sans-serif;">Número de Guía</label>
                                    {{ form.numero_guia }}
                                    {% if form.numero_guia.errors %}
                                        <div class="text-danger mt-1">{{ form.numero_guia.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label" style="font-weight: 500; color: #495057; font-family: 'Poppins', sans-serif;">Observaciones</label>
                                {{ form.observaciones }}
                                {% if form.observaciones.errors %}
                                    <div class="text-danger mt-1">{{ form.observaciones.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Items Recibidos -->
                        <div class="form-section">
                            <div class="section-header">
                                <h5><i class="fas fa-list me-2"></i>Items Recibidos</h5>
                            </div>
                            
                            {{ formset.management_form }}
                            <div id="items-container">
                                {% for form in formset %}
                                <div class="item-row" data-index="{{ forloop.counter0 }}">
                                    <div class="row align-items-end">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Item de Orden</label>
                                            <select name="items-{{ forloop.counter0 }}-item_orden" class="form-select" id="id_items-{{ forloop.counter0 }}-item_orden" required>
                                                <option value="">Seleccionar item...</option>
                                                {% for item in items_orden %}
                                                <option value="{{ item.pk }}">{{ item.articulo.nombre }} - Pendiente: {{ item.get_cantidad_pendiente }}</option>
                                                {% endfor %}
                                            </select>
                                            {% if form.item_orden.errors %}
                                                <div class="text-danger">{{ form.item_orden.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label class="form-label">Cantidad Recibida *</label>
                                            {{ form.cantidad_recibida }}
                                            {% if form.cantidad_recibida.errors %}
                                                <div class="text-danger">{{ form.cantidad_recibida.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label class="form-label">Calidad Aceptable</label>
                                            <div class="form-check">
                                                {{ form.calidad_aceptable }}
                                                <label class="form-check-label" for="{{ form.calidad_aceptable.id_for_label }}">
                                                    Aceptable
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Observaciones Calidad</label>
                                            {{ form.observaciones_calidad }}
                                            {% if form.observaciones_calidad.errors %}
                                                <div class="text-danger">{{ form.observaciones_calidad.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if form.id %}
                                        {{ form.id }}
                                    {% endif %}
                                    {% if form.DELETE %}
                                        {{ form.DELETE }}
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-success" id="add-item">
                                    <i class="fas fa-plus me-2"></i>Agregar Item
                                </button>
                            </div>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary me-3">
                                <i class="fas fa-save me-2"></i>Guardar Recepción
                            </button>
                            <a href="{% url 'compras:orden_compra_detail' orden.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemIndex = {{ formset.total_form_count }};
    
    // Función para agregar nuevo item
    document.getElementById('add-item').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const itemHtml = `
            <div class="item-row" data-index="${itemIndex}">
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Item de Orden</label>
                        <select name="items-${itemIndex}-item_orden" class="form-select" id="id_items-${itemIndex}-item_orden" required>
                            <option value="">Seleccionar item...</option>
                            {% for item in items_orden %}
                            <option value="{{ item.pk }}">{{ item.articulo.nombre }} - Pendiente: {{ item.get_cantidad_pendiente }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Cantidad Recibida *</label>
                        <input type="number" name="items-${itemIndex}-cantidad_recibida" class="form-control" step="0.01" min="0.01" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Calidad Aceptable</label>
                        <div class="form-check">
                            <input type="checkbox" name="items-${itemIndex}-calidad_aceptable" class="form-check-input" id="id_items-${itemIndex}-calidad_aceptable" checked>
                            <label class="form-check-label" for="id_items-${itemIndex}-calidad_aceptable">
                                Aceptable
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Observaciones Calidad</label>
                        <textarea name="items-${itemIndex}-observaciones_calidad" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <input type="hidden" name="items-${itemIndex}-id" value="">
                <input type="hidden" name="items-${itemIndex}-DELETE" value="false">
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHtml);
        
        // Actualizar el contador de forms
        const totalFormsInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
        totalFormsInput.value = itemIndex + 1;
        
        itemIndex++;
    });
    
    // Función para eliminar item
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-item')) {
            const itemRow = e.target.closest('.item-row');
            const deleteInput = itemRow.querySelector('input[name$="-DELETE"]');
            
            if (deleteInput && deleteInput.value !== '') {
                // Es un item existente, marcarlo para eliminación
                deleteInput.value = 'true';
                itemRow.style.display = 'none';
            } else {
                // Es un item nuevo, eliminarlo completamente
                itemRow.remove();
                actualizarIndices();
            }
        }
    });
    
    // Función para actualizar índices después de eliminar
    function actualizarIndices() {
        const items = document.querySelectorAll('.item-row');
        let newIndex = 0;
        
        items.forEach(function(item) {
            if (item.style.display !== 'none') {
                const inputs = item.querySelectorAll('input, select, textarea');
                inputs.forEach(function(input) {
                    const name = input.name;
                    if (name) {
                        input.name = name.replace(/items-\d+-/, `items-${newIndex}-`);
                        input.id = input.id.replace(/id_items-\d+_/, `id_items-${newIndex}_`);
                    }
                });
                
                const labels = item.querySelectorAll('label[for]');
                labels.forEach(function(label) {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        label.setAttribute('for', forAttr.replace(/id_items-\d+_/, `id_items-${newIndex}_`));
                    }
                });
                
                item.setAttribute('data-index', newIndex);
                newIndex++;
            }
        });
        
        // Actualizar el contador de forms
        const totalFormsInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
        totalFormsInput.value = newIndex;
        itemIndex = newIndex;
    }
});
</script>
{% endblock %}