{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-lg" style="border: none; border-radius: 15px; overflow: hidden;">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; padding: 15px 20px; font-family: 'Poppins', sans-serif;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-plus me-3" style="font-size: 1.8rem; color: #F4E4BC;"></i>
                                <div>
                                    <h4 class="mb-1" style="font-weight: 600; font-size: 1.4rem; font-family: 'Poppins', sans-serif;">{{ title }}</h4>
                                    <small style="font-size: 0.9rem; opacity: 0.9; font-family: 'Poppins', sans-serif;">Gestiona la informaci√≥n completa del cliente</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'clientes:cliente_list' %}" class="btn btn-light btn-sm" style="font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Formulario con pesta√±as -->
                <div class="card-body p-0">
                    <!-- √Årea de mensajes -->
                    {% if messages %}
                    <div class="alert-container" style="padding: 15px; margin: 0;">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 10px;">
                            <strong>
                                {% if message.tags == 'success' %}
                                    <i class="fas fa-check-circle me-2"></i>¬°√âxito!
                                {% elif message.tags == 'error' %}
                                    <i class="fas fa-exclamation-circle me-2"></i>Error:
                                {% elif message.tags == 'warning' %}
                                    <i class="fas fa-exclamation-triangle me-2"></i>Advertencia:
                                {% else %}
                                    <i class="fas fa-info-circle me-2"></i>Informaci√≥n:
                                {% endif %}
                            </strong>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post" id="clienteForm">
                        {% csrf_token %}
                        
                        <!-- Pesta√±as -->
                        <ul class="nav nav-tabs" id="clienteTabs" role="tablist" style="border-bottom: 2px solid #e9ecef; margin: 0; font-family: 'Poppins', sans-serif;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="datos-basicos-tab" data-bs-toggle="tab" data-bs-target="#datos-basicos" type="button" role="tab" 
                                        style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                    <i class="fas fa-user me-2"></i>Datos B√°sicos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="datos-comerciales-tab" data-bs-toggle="tab" data-bs-target="#datos-comerciales" type="button" role="tab"
                                        style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                    <i class="fas fa-chart-line me-2"></i>Datos Comerciales
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contactos-tab" data-bs-toggle="tab" data-bs-target="#contactos" type="button" role="tab"
                                        style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                    <i class="fas fa-address-book me-2"></i>Contactos
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las pesta√±as -->
                        <div class="tab-content" id="clienteTabsContent" style="padding: 20px; font-family: 'Poppins', sans-serif;">
                            <!-- Pesta√±a 1: Datos B√°sicos -->
                            <div class="tab-pane fade show active" id="datos-basicos" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <label for="{{ form.rut.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-id-card me-2" style="color: #8B7355;"></i>RUT *
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-id-card" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.rut }}
                                            <div class="input-group-text" id="rut-status" style="background-color: #f8f9fa; border-left: none;">
                                                <i class="fas fa-question-circle" id="rut-icon" style="color: #6c757d;"></i>
                                            </div>
                                        </div>
                                        <div id="rut-help" class="form-text" style="color: #6c757d;">Ingrese RUT con o sin puntos: 12.345.678-9 o 12345678-9</div>
                                        <div id="rut-error" class="text-danger mt-1" style="display: none;"></div>
                                        {% if form.rut.errors %}
                                            <div class="text-danger mt-1">{{ form.rut.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <label for="{{ form.nombre.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-user me-2" style="color: #8B7355;"></i>Nombre del Cliente *
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-user" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.nombre }}
                                        </div>
                                        {% if form.nombre.errors %}
                                            <div class="text-danger mt-1">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <label for="{{ form.tipo_cliente.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-tag me-2" style="color: #8B7355;"></i>Tipo de Cliente
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-tag" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.tipo_cliente }}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <label for="{{ form.giro.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-briefcase me-2" style="color: #8B7355;"></i>Giro Comercial
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-briefcase" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.giro }}
                                        </div>
                                    </div>
                                    
                                    <div class="col-12 mb-4">
                                        <label for="{{ form.direccion.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-map-marker-alt me-2" style="color: #8B7355;"></i>Direcci√≥n
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da; align-items: flex-start; padding-top: 12px;">
                                                <i class="fas fa-map-marker-alt" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.direccion }}
                                        </div>
                                        {% if form.direccion.errors %}
                                            <div class="text-danger mt-1">{{ form.direccion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.comuna.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-map me-2" style="color: #8B7355;"></i>Comuna
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-map" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.comuna }}
                                        </div>
                                        {% if form.comuna.errors %}
                                            <div class="text-danger mt-1">{{ form.comuna.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.ciudad.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-city me-2" style="color: #8B7355;"></i>Ciudad
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-city" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.ciudad }}
                                        </div>
                                        {% if form.ciudad.errors %}
                                            <div class="text-danger mt-1">{{ form.ciudad.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.region.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-globe me-2" style="color: #8B7355;"></i>Regi√≥n
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-globe" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.region }}
                                        </div>
                                        {% if form.region.errors %}
                                            <div class="text-danger mt-1">{{ form.region.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.telefono.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-phone me-2" style="color: #8B7355;"></i>Tel√©fono
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-phone" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.telefono }}
                                        </div>
                                        {% if form.telefono.errors %}
                                            <div class="text-danger mt-1">{{ form.telefono.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.email.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-envelope me-2" style="color: #8B7355;"></i>Email
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-envelope" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.email }}
                                        </div>
                                        {% if form.email.errors %}
                                            <div class="text-danger mt-1">{{ form.email.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.sitio_web.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-globe me-2" style="color: #8B7355;"></i>Sitio Web
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-globe" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.sitio_web }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pesta√±a 2: Datos Comerciales -->
                            <div class="tab-pane fade" id="datos-comerciales" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.limite_credito.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-credit-card me-2" style="color: #8B7355;"></i>L√≠mite de Cr√©dito
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-credit-card" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.limite_credito }}
                                        </div>
                                        {% if form.limite_credito.errors %}
                                            <div class="text-danger mt-1">{{ form.limite_credito.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.plazo_pago.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-calendar me-2" style="color: #8B7355;"></i>Plazo de Pago (d√≠as)
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-calendar" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.plazo_pago }}
                                        </div>
                                        {% if form.plazo_pago.errors %}
                                            <div class="text-danger mt-1">{{ form.plazo_pago.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-4">
                                        <label for="{{ form.descuento_porcentaje.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-percentage me-2" style="color: #8B7355;"></i>Descuento por Defecto (%)
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-percentage" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.descuento_porcentaje }}
                                        </div>
                                        {% if form.descuento_porcentaje.errors %}
                                            <div class="text-danger mt-1">{{ form.descuento_porcentaje.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <label for="{{ form.estado.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-toggle-on me-2" style="color: #8B7355;"></i>Estado
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da;">
                                                <i class="fas fa-toggle-on" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.estado }}
                                        </div>
                                    </div>
                                    
                                    <div class="col-12 mb-4">
                                        <label for="{{ form.observaciones.id_for_label }}" class="form-label" style="color: #495057; font-weight: bold;">
                                            <i class="fas fa-sticky-note me-2" style="color: #8B7355;"></i>Observaciones
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-text" style="background-color: #f8f9fa; border-right: 2px solid #dee2e6; border-color: #ced4da; align-items: flex-start; padding-top: 12px;">
                                                <i class="fas fa-sticky-note" style="color: #6c757d;"></i>
                                            </div>
                                            {{ form.observaciones }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pesta√±a 3: Contactos -->
                            <div class="tab-pane fade" id="contactos" role="tabpanel">
                                {% if cliente.id %}
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0" style="color: #2c3e50; font-weight: 600; font-family: 'Poppins', sans-serif;">
                                        <i class="fas fa-address-book me-2" style="color: #8B7355;"></i>Contactos
                                    </h5>
                                    <a href="{% url 'clientes:contacto_create' cliente.id %}" class="btn" style="background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%); color: white; border: none; font-family: 'Poppins', sans-serif;">
                                        <i class="fas fa-plus me-2"></i>Agregar Contacto
                                    </a>
                                </div>
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted" style="font-family: 'Poppins', sans-serif;">Guarde el cliente primero</h5>
                                    <p class="text-muted" style="font-family: 'Poppins', sans-serif;">Para agregar contactos, primero debe guardar la informaci√≥n b√°sica del cliente.</p>
                                </div>
                                {% endif %}
                                
                                {% if contactos %}
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead style="background: #f8f9fa;">
                                                <tr>
                                                    <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Nombre</th>
                                                    <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Cargo</th>
                                                    <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Tel√©fono</th>
                                                    <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Email</th>
                                                    <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif; width: 120px;">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for contacto in contactos %}
                                                <tr>
                                                    <td class="py-2 px-3">
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-user me-2" style="color: #8B7355;"></i>
                                                            <span class="fw-bold" style="color: #2c3e50; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                                {{ contacto.nombre }}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td class="py-2 px-3">
                                                        <span style="color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                            {{ contacto.cargo|default:"No especificado" }}
                                                        </span>
                                                    </td>
                                                    <td class="py-2 px-3">
                                                        <span style="color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                            {{ contacto.telefono|default:"No especificado" }}
                                                        </span>
                                                    </td>
                                                    <td class="py-2 px-3">
                                                        {% if contacto.email %}
                                                            <a href="mailto:{{ contacto.email }}" style="color: #8B7355; text-decoration: none; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                                {{ contacto.email }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #6c757d; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">No especificado</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="py-2 px-3">
                                                        <div class="d-flex gap-1">
                                                            <a href="{% url 'clientes:contacto_update' cliente.id contacto.id %}" 
                                                               class="btn btn-sm" 
                                                               style="padding: 2px 6px; color: #D4AF37; background: none; border: none;"
                                                               title="Editar contacto">
                                                                <i class="fas fa-edit" style="font-size: 14px;"></i>
                                                            </a>
                                                            <a href="{% url 'clientes:contacto_delete' cliente.id contacto.id %}" 
                                                               class="btn btn-sm" 
                                                               style="padding: 2px 6px; color: #dc3545; background: none; border: none;"
                                                               title="Eliminar contacto"
                                                               onclick="return confirm('¬øEst√°s seguro de que deseas eliminar este contacto?')">
                                                                <i class="fas fa-trash" style="font-size: 14px;"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    {% if cliente.id %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-address-book fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted" style="font-family: 'Poppins', sans-serif;">No hay contactos registrados</h5>
                                        <p class="text-muted" style="font-family: 'Poppins', sans-serif;">Este cliente no tiene contactos asociados.</p>
                                        <a href="{% url 'clientes:contacto_create' cliente.id %}" class="btn" style="background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%); color: white; border: none; font-family: 'Poppins', sans-serif;">
                                            <i class="fas fa-plus me-2"></i>Agregar Primer Contacto
                                        </a>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="card-footer" style="background: #f8f9fa; border-top: 1px solid #e9ecef; padding: 20px 30px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="{% url 'clientes:cliente_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="submit" id="btnSubmit" class="btn" style="background: linear-gradient(135deg, #4A90A4 0%, #6BB6C7 100%); border: none; color: white; padding: 10px 30px; border-radius: 25px; font-weight: 600;">
                                        <span id="btnText">
                                            <i class="fas fa-save me-2"></i>{{ submit_text }}
                                        </span>
                                        <span id="btnSpinner" style="display: none;">
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            Guardando...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%) !important;
    color: white !important;
    border-bottom: 2px solid #6B8E23 !important;
}

.nav-tabs .nav-link:hover {
    background-color: #f8f9fa !important;
    color: #6B8E23 !important;
}

.form-control, .form-select {
    border-left: none !important;
}

.input-group-text {
    border-right: 2px solid #dee2e6 !important;
}

.contacto-form {
    transition: all 0.3s ease;
}

.contacto-form:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== SCRIPT DE CLIENTE CARGADO ===');
    
    // Validaci√≥n de formulario con pesta√±as
    const form = document.getElementById('clienteForm');
    const tabs = document.querySelectorAll('#clienteTabs button[data-bs-toggle="tab"]');
    const rutInput = document.getElementById('id_rut') || document.getElementById('rut-input'); // Intentar ambos IDs
    const rutIcon = document.getElementById('rut-icon');
    const rutError = document.getElementById('rut-error');
    const rutHelp = document.getElementById('rut-help');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    console.log('Elementos encontrados:');
    console.log('- form:', form);
    console.log('- rutInput:', rutInput);
    console.log('- btnSubmit:', btnSubmit);
    console.log('- btnText:', btnText);
    console.log('- btnSpinner:', btnSpinner);
    
    // Validaci√≥n en tiempo real del RUT
    if (rutInput) {
        rutInput.addEventListener('input', function() {
            const rut = this.value.trim();
            
            if (rut.length === 0) {
                rutIcon.className = 'fas fa-question-circle';
                rutIcon.style.color = '#6c757d';
                rutError.style.display = 'none';
                rutHelp.style.display = 'block';
                this.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            // Limpiar RUT
            const rutLimpio = rut.replace(/[^0-9Kk]/g, '');
            
            if (rutLimpio.length < 8 || rutLimpio.length > 9) {
                rutIcon.className = 'fas fa-times-circle';
                rutIcon.style.color = '#dc3545';
                rutError.textContent = 'El RUT debe tener entre 8 y 9 d√≠gitos';
                rutError.style.display = 'block';
                rutHelp.style.display = 'none';
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                return;
            }
            
            // Validar d√≠gito verificador
            if (validarDigitoVerificador(rutLimpio)) {
                rutIcon.className = 'fas fa-check-circle';
                rutIcon.style.color = '#28a745';
                rutError.style.display = 'none';
                rutHelp.style.display = 'none';
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
                
                // Formatear RUT autom√°ticamente
                const rutFormateado = formatearRUT(rutLimpio);
                if (rutFormateado !== rut) {
                    this.value = rutFormateado;
                }
            } else {
                rutIcon.className = 'fas fa-times-circle';
                rutIcon.style.color = '#dc3545';
                rutError.textContent = 'El d√≠gito verificador del RUT es inv√°lido';
                rutError.style.display = 'block';
                rutHelp.style.display = 'none';
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            }
        });
        
        // Formatear RUT mientras se escribe
        rutInput.addEventListener('input', function() {
            let rut = this.value;
            
            // Permitir solo n√∫meros, K, k, puntos y gui√≥n
            rut = rut.replace(/[^0-9Kk.-]/g, '');
            
            // Si el usuario est√° escribiendo, formatear autom√°ticamente
            if (rut.length > 1) {
                // Limpiar puntos y guiones para contar d√≠gitos
                const rutLimpio = rut.replace(/[.-]/g, '');
                
                if (rutLimpio.length >= 2) {
                    // Separar n√∫mero y d√≠gito verificador
                    const numero = rutLimpio.slice(0, -1);
                    const dv = rutLimpio.slice(-1).toUpperCase();
                    
                    // Formatear con puntos y gui√≥n
                    let rutFormateado = '';
                    if (numero.length === 7) {
                        rutFormateado = `${numero[0]}.${numero.slice(1, 4)}.${numero.slice(4, 7)}-${dv}`;
                    } else if (numero.length === 8) {
                        rutFormateado = `${numero.slice(0, 2)}.${numero.slice(2, 5)}.${numero.slice(5, 8)}-${dv}`;
                    } else if (numero.length < 7) {
                        // Si a√∫n no tiene suficientes d√≠gitos, solo agregar gui√≥n
                        rutFormateado = `${numero}-${dv}`;
                    }
                    
                    if (rutFormateado && rutFormateado !== this.value) {
                        this.value = rutFormateado;
                    }
                }
            }
        });
        
        // Permitir que el usuario escriba el gui√≥n manualmente
        rutInput.addEventListener('keydown', function(e) {
            // Permitir teclas de control (backspace, delete, arrows, etc.)
            if (e.key.length === 1 || ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) {
                return;
            }
            
            // Permitir gui√≥n solo en posici√≥n correcta
            if (e.key === '-') {
                const cursorPos = this.selectionStart;
                const rut = this.value.replace(/[.-]/g, '');
                
                // Solo permitir gui√≥n si hay al menos 7 d√≠gitos y est√° en la posici√≥n correcta
                if (rut.length >= 7 && cursorPos >= rut.length) {
                    return;
                } else {
                    e.preventDefault();
                }
            }
        });
    }
    
    // Funci√≥n para validar d√≠gito verificador
    function validarDigitoVerificador(rutLimpio) {
        const numero = rutLimpio.slice(0, -1);
        const dv = rutLimpio.slice(-1).toUpperCase();
        
        let suma = 0;
        let multiplicador = 2;
        
        for (let i = numero.length - 1; i >= 0; i--) {
            suma += parseInt(numero[i]) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }
        
        const resto = suma % 11;
        let dvCalculado = 11 - resto;
        
        if (dvCalculado === 11) {
            dvCalculado = '0';
        } else if (dvCalculado === 10) {
            dvCalculado = 'K';
        } else {
            dvCalculado = dvCalculado.toString();
        }
        
        return dv === dvCalculado;
    }
    
    // Funci√≥n para formatear RUT
    function formatearRUT(rutLimpio) {
        const numero = rutLimpio.slice(0, -1);
        const dv = rutLimpio.slice(-1).toUpperCase();
        
        if (numero.length === 7) {
            return `${numero[0]}.${numero.slice(1, 4)}.${numero.slice(4, 7)}-${dv}`;
        } else if (numero.length === 8) {
            return `${numero.slice(0, 2)}.${numero.slice(2, 5)}.${numero.slice(5, 8)}-${dv}`;
        }
        
        return rutLimpio;
    }
    
    if (!form) {
        console.error('‚úó ERROR: No se encontr√≥ el formulario con ID "clienteForm"');
        return;
    }
    
    console.log('‚úì Registrando evento submit en el formulario');
    
    // Verificar si hay otros formularios
    const allForms = document.querySelectorAll('form');
    console.log('Total de formularios en la p√°gina:', allForms.length);
    
    // Listener global para detectar CUALQUIER clic
    document.addEventListener('click', function(e) {
        if (e.target.id === 'btnSubmit' || e.target.closest('#btnSubmit')) {
            console.log('üî¥ CLIC DETECTADO EN BOT√ìN ACTUALIZAR (listener global)');
            console.log('Target:', e.target);
            console.log('CurrentTarget:', e.currentTarget);
        }
    }, true);
    
    // Agregar listener al bot√≥n tambi√©n con capture
    if (btnSubmit) {
        btnSubmit.addEventListener('click', function(e) {
            console.log('=== BOT√ìN ACTUALIZAR CLICKEADO ===');
            console.log('Tipo de bot√≥n:', this.type);
            console.log('Formulario padre:', this.closest('form'));
        }, true); // Usar capture
    }
    
    // Usar capture para interceptar el submit antes que otros listeners
    form.addEventListener('submit', function(e) {
        console.log('=== FORMULARIO ENVIADO (CAPTURE) ===');
        console.log('Event:', e);
        console.log('Target:', e.target);
        
        // Mostrar spinner
        if (btnSubmit && btnText && btnSpinner) {
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            btnSubmit.disabled = true;
        }
        
        // Validar campos requeridos en la primera pesta√±a
        const requiredFields = ['rut', 'nombre', 'direccion', 'comuna', 'ciudad', 'region', 'telefono'];
        let firstInvalidField = null;
        
        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
                field.classList.add('is-invalid');
                console.log('Campo inv√°lido:', fieldName);
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
        
        if (firstInvalidField) {
            e.preventDefault();
            console.log('‚úó Validaci√≥n fallida - Campos requeridos faltantes');
            
            // Restaurar bot√≥n
            if (btnSubmit && btnText && btnSpinner) {
                btnText.style.display = 'inline-block';
                btnSpinner.style.display = 'none';
                btnSubmit.disabled = false;
            }
            
            // Activar la primera pesta√±a
            const firstTab = document.querySelector('#datos-basicos-tab');
            const firstTabPane = document.querySelector('#datos-basicos');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
            
            firstTab.classList.add('active');
            firstTabPane.classList.add('show', 'active');
            
            // Scroll al campo inv√°lido
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidField.focus();
            
            alert('Por favor complete todos los campos requeridos en la pesta√±a "Datos B√°sicos".');
        } else {
            console.log('‚úì Validaci√≥n exitosa - Enviando formulario al servidor');
            
            // Timeout de seguridad: si despu√©s de 10 segundos no hay respuesta, rehabilitar el bot√≥n
            setTimeout(function() {
                if (btnSubmit && btnSubmit.disabled) {
                    console.warn('‚ö†Ô∏è TIMEOUT: El formulario no recibi√≥ respuesta del servidor');
                    console.warn('Rehabilitando bot√≥n para permitir reintento');
                    
                    if (btnText && btnSpinner) {
                        btnText.style.display = 'inline-block';
                        btnSpinner.style.display = 'none';
                    }
                    btnSubmit.disabled = false;
                    
                    // Mostrar alerta
                    alert('El servidor est√° tardando en responder. Por favor, verifica tu conexi√≥n e intenta nuevamente.\n\nSi el problema persiste, contacta al administrador.');
                }
            }, 10000); // 10 segundos
        }
    });
    
    // Limpiar validaci√≥n al cambiar pesta√±as
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.form-control').forEach(field => {
                field.classList.remove('is-invalid');
            });
        });
    });
});
</script>
{% endblock %}
