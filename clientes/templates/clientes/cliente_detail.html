{% extends "base.html" %}
{% load static %}

{% block title %}Detalle del Cliente{% endblock %}

{% block body_class %}hide-top-bar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg" style="border: none; border-radius: 15px; overflow: hidden;">
                <!-- Header -->
                <div class="card-header" style="background: linear-gradient(135deg, #8B7355 0%, #6F5B44 100%); color: white; padding: 15px 20px; font-family: 'Poppins', sans-serif;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user me-3" style="font-size: 1.8rem; color: #F4E4BC;"></i>
                                <div>
                                    <h4 class="mb-1" style="font-weight: 600; font-size: 1.4rem; font-family: 'Poppins', sans-serif;">{{ cliente.nombre }}</h4>
                                    <small style="font-size: 0.9rem; opacity: 0.9; font-family: 'Poppins', sans-serif;">{{ cliente.get_rut_formateado }} - {{ cliente.get_tipo_cliente_display }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'clientes:cliente_list' %}" class="btn btn-light btn-sm me-2" style="font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>
                            <a href="{% url 'clientes:cliente_update' cliente.pk %}" class="btn btn-warning btn-sm" style="font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-edit me-2"></i>Editar
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Contenido con pestañas -->
                <div class="card-body p-0">
                    <!-- Pestañas -->
                    <ul class="nav nav-tabs" id="clienteDetailTabs" role="tablist" style="border-bottom: 2px solid #e9ecef; margin: 0; font-family: 'Poppins', sans-serif;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-general-tab" data-bs-toggle="tab" data-bs-target="#info-general" type="button" role="tab"
                                    style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-info-circle me-2"></i>Información General
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="datos-comerciales-tab" data-bs-toggle="tab" data-bs-target="#datos-comerciales" type="button" role="tab"
                                    style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-chart-line me-2"></i>Datos Comerciales
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contactos-tab" data-bs-toggle="tab" data-bs-target="#contactos" type="button" role="tab"
                                    style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-address-book me-2"></i>Contactos ({{ contactos.count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cuenta-corriente-tab" data-bs-toggle="tab" data-bs-target="#cuenta-corriente" type="button" role="tab"
                                    style="border: none; border-radius: 0; padding: 12px 20px; font-weight: 500; color: #495057; background: transparent; font-family: 'Poppins', sans-serif;">
                                <i class="fas fa-credit-card me-2"></i>Cuenta Corriente
                            </button>
                        </li>
                    </ul>

                    <!-- Contenido de las pestañas -->
                    <div class="tab-content" id="clienteDetailTabsContent" style="padding: 20px; font-family: 'Poppins', sans-serif;">
                        <!-- Pestaña 1: Información General -->
                        <div class="tab-pane fade show active" id="info-general" role="tabpanel">
                            <div class="row g-4">
                                <!-- Card: Datos del Cliente -->
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <div class="info-card-header">
                                            <i class="fas fa-user-circle"></i>
                                            <h5>Datos del Cliente</h5>
                                        </div>
                                        <div class="info-card-body">
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-hashtag"></i>
                                                    <span>Código</span>
                                                </div>
                                                <div class="info-value">{{ cliente.codigo }}</div>
                                            </div>
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-user"></i>
                                                    <span>Nombre</span>
                                                </div>
                                                <div class="info-value fw-bold">{{ cliente.nombre }}</div>
                                            </div>
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-tag"></i>
                                                    <span>Tipo</span>
                                                </div>
                                                <div class="info-value">
                                                    <span class="badge-custom badge-info">
                                                        <i class="fas fa-building me-1"></i>
                                                        {{ cliente.get_tipo_cliente_display }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-id-card"></i>
                                                    <span>RUT</span>
                                                </div>
                                                <div class="info-value">{{ cliente.get_rut_formateado }}</div>
                                            </div>
                                            
                                            {% if cliente.giro %}
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-briefcase"></i>
                                                    <span>Giro</span>
                                                </div>
                                                <div class="info-value">{{ cliente.giro }}</div>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-toggle-on"></i>
                                                    <span>Estado</span>
                                                </div>
                                                <div class="info-value">
                                                    <span class="badge-custom badge-success">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        {{ cliente.get_estado_display }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Card: Información de Contacto -->
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <div class="info-card-header">
                                            <i class="fas fa-address-card"></i>
                                            <h5>Información de Contacto</h5>
                                        </div>
                                        <div class="info-card-body">
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                    <span>Dirección</span>
                                                </div>
                                                <div class="info-value">{{ cliente.get_direccion_completa }}</div>
                                            </div>
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-phone"></i>
                                                    <span>Teléfono</span>
                                                </div>
                                                <div class="info-value">
                                                    <a href="tel:{{ cliente.telefono }}" class="contact-link">
                                                        {{ cliente.telefono }}
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            {% if cliente.email %}
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>Email</span>
                                                </div>
                                                <div class="info-value">
                                                    <a href="mailto:{{ cliente.email }}" class="contact-link">
                                                        {{ cliente.email }}
                                                    </a>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if cliente.sitio_web %}
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-globe"></i>
                                                    <span>Sitio Web</span>
                                                </div>
                                                <div class="info-value">
                                                    <a href="{{ cliente.get_sitio_web_formateado }}" target="_blank" class="contact-link">
                                                        {{ cliente.sitio_web }}
                                                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.75rem;"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-calendar-plus"></i>
                                                    <span>Fecha de Alta</span>
                                                </div>
                                                <div class="info-value">{{ cliente.fecha_alta|date:"d/m/Y" }}</div>
                                            </div>
                                            
                                            {% if cliente.observaciones %}
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <i class="fas fa-sticky-note"></i>
                                                    <span>Observaciones</span>
                                                </div>
                                                <div class="info-value">{{ cliente.observaciones }}</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pestaña 2: Datos Comerciales -->
                        <div class="tab-pane fade" id="datos-comerciales" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-radius: 10px;">
                                        <div class="card-header" style="background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                                            <h6 class="mb-0" style="color: #495057; font-weight: 600;">
                                                <i class="fas fa-credit-card me-2" style="color: #8B7355;"></i>Límites y Crédito
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Límite de Crédito:</strong></div>
                                                <div class="col-sm-6">
                                                    <span class="h5" style="color: #2c3e50; font-weight: 700;">${{ cliente.limite_credito|floatformat:0 }}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Saldo Actual:</strong></div>
                                                <div class="col-sm-6">
                                                    <span class="h5" style="color: #dc3545; font-weight: 700;">${{ cliente.get_saldo_actual|floatformat:0 }}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Límite Disponible:</strong></div>
                                                <div class="col-sm-6">
                                                    <span class="h5" style="color: #28a745; font-weight: 700;">${{ cliente.get_limite_disponible|floatformat:0 }}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Puede Vender a Crédito:</strong></div>
                                                <div class="col-sm-6">
                                                    {% if cliente.puede_vender_credito %}
                                                        <span class="badge bg-success">Sí</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">No</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100" style="border-radius: 10px;">
                                        <div class="card-header" style="background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                                            <h6 class="mb-0" style="color: #495057; font-weight: 600;">
                                                <i class="fas fa-chart-line me-2" style="color: #8B7355;"></i>Condiciones Comerciales
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Plazo de Pago:</strong></div>
                                                <div class="col-sm-6">
                                                    <span class="h5" style="color: #2c3e50; font-weight: 700;">{{ cliente.plazo_pago }} días</span>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-sm-6"><strong>Descuento por Defecto:</strong></div>
                                                <div class="col-sm-6">
                                                    <span class="h5" style="color: #2c3e50; font-weight: 700;">{{ cliente.descuento_porcentaje }}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pestaña 3: Contactos -->
                        <div class="tab-pane fade" id="contactos" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0" style="color: #2c3e50; font-weight: 600; font-family: 'Poppins', sans-serif;">
                                    <i class="fas fa-address-book me-2" style="color: #8B7355;"></i>Contactos
                                </h5>
                                <a href="{% url 'clientes:contacto_create' cliente.id %}" class="btn" style="background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%); color: white; border: none; font-family: 'Poppins', sans-serif;">
                                    <i class="fas fa-plus me-2"></i>Agregar Contacto (Nuevo)
                                </a>
                            </div>
                            
                            {% if contactos %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead style="background: #f8f9fa;">
                                            <tr>
                                                <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Nombre</th>
                                                <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Cargo</th>
                                                <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Teléfono</th>
                                                <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">Email</th>
                                                <th style="font-weight: 600; color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif; width: 120px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contacto in contactos %}
                                            <tr>
                                                <td class="py-2 px-3">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user me-2" style="color: #8B7355;"></i>
                                                        <span class="fw-bold" style="color: #2c3e50; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                            {{ contacto.nombre }}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td class="py-2 px-3">
                                                    <span style="color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                        {{ contacto.cargo|default:"No especificado" }}
                                                    </span>
                                                </td>
                                                <td class="py-2 px-3">
                                                    <span style="color: #495057; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                        {{ contacto.telefono|default:"No especificado" }}
                                                    </span>
                                                </td>
                                                <td class="py-2 px-3">
                                                    {% if contacto.email %}
                                                        <a href="mailto:{{ contacto.email }}" style="color: #8B7355; text-decoration: none; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">
                                                            {{ contacto.email }}
                                                        </a>
                                                    {% else %}
                                                        <span style="color: #6c757d; font-size: 0.9rem; font-family: 'Poppins', sans-serif;">No especificado</span>
                                                    {% endif %}
                                                </td>
                                                <td class="py-2 px-3">
                                                    <div class="d-flex gap-1">
                                                        <a href="{% url 'clientes:contacto_update' cliente.id contacto.id %}" 
                                                           class="btn btn-sm" 
                                                           style="padding: 2px 6px; color: #D4AF37; background: none; border: none;"
                                                           title="Editar contacto">
                                                            <i class="fas fa-edit" style="font-size: 14px;"></i>
                                                        </a>
                                                        <a href="{% url 'clientes:contacto_delete' cliente.id contacto.id %}" 
                                                           class="btn btn-sm" 
                                                           style="padding: 2px 6px; color: #dc3545; background: none; border: none;"
                                                           title="Eliminar contacto"
                                                           onclick="return confirm('¿Estás seguro de que deseas eliminar este contacto?')">
                                                            <i class="fas fa-trash" style="font-size: 14px;"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-address-book fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted" style="font-family: 'Poppins', sans-serif;">No hay contactos registrados</h5>
                                    <p class="text-muted" style="font-family: 'Poppins', sans-serif;">Este cliente no tiene contactos asociados.</p>
                                    <a href="{% url 'clientes:contacto_create' cliente.id %}" class="btn" style="background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%); color: white; border: none; font-family: 'Poppins', sans-serif;">
                                        <i class="fas fa-plus me-2"></i>Agregar Primer Contacto
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Pestaña 4: Cuenta Corriente -->
                        <div class="tab-pane fade" id="cuenta-corriente" role="tabpanel">
                            {% if movimientos %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead style="background: #f8f9fa;">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                                <th>Monto</th>
                                                <th>Saldo Anterior</th>
                                                <th>Saldo Nuevo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for movimiento in movimientos %}
                                                <tr>
                                                    <td>{{ movimiento.fecha|date:"d/m/Y" }}</td>
                                                    <td>
                                                        <span class="badge bg-{{ movimiento.get_tipo_movimiento_display_color }}">
                                                            {{ movimiento.get_tipo_movimiento_display }}
                                                        </span>
                                                    </td>
                                                    <td>{{ movimiento.descripcion }}</td>
                                                    <td class="text-end">${{ movimiento.monto|floatformat:0 }}</td>
                                                    <td class="text-end">${{ movimiento.saldo_anterior|floatformat:0 }}</td>
                                                    <td class="text-end fw-bold">${{ movimiento.saldo_nuevo|floatformat:0 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay movimientos registrados</h5>
                                    <p class="text-muted">Este cliente no tiene movimientos en su cuenta corriente.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #6B8E23 0%, #8FBC8F 100%) !important;
    color: white !important;
    border-bottom: 2px solid #8B7355 !important;
}

.nav-tabs .nav-link:hover {
    background-color: #f8f9fa !important;
    color: #6B8E23 !important;
}

/* Cards de Información */
.info-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    height: 100%;
}

.info-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.info-card-header {
    background: linear-gradient(135deg, #F5F0EB 0%, #E8DED5 100%);
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #D4C4A8;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.info-card-header i {
    font-size: 1.5rem;
    color: #8B7355;
}

.info-card-header h5 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #6F5B44;
    font-family: 'Poppins', sans-serif;
}

.info-card-body {
    padding: 1.5rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.875rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9rem;
    min-width: 140px;
}

.info-label i {
    color: #8B7355;
    width: 18px;
    text-align: center;
}

.info-value {
    color: #2c3e50;
    font-size: 0.95rem;
    text-align: right;
    flex: 1;
}

.badge-custom {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
}

.badge-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1976d2;
}

.badge-success {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    color: #2e7d32;
}

.contact-link {
    color: #8B7355;
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 500;
}

.contact-link:hover {
    color: #6F5B44;
    text-decoration: underline;
}
</style>
{% endblock %}
